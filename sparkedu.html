<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkEdu - Pengurusan Kurikulum Pendidikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Gaya asas dan animasi */
        body { font-family: 'Arial', sans-serif; background-color: #f8f9fa; } 
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Gaya untuk konten utama */
        #kurikulum-content { font-family: 'Arial', sans-serif; background-color: #f7f9fb; } 
        .scroll-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .data-table {
            min-width: 1200px; 
            width: 100%;
        }
        .data-cell {
            vertical-align: top;
            padding: 8px 12px;
            text-align: left;
            font-size: 0.875rem; 
        }
        .score-cell {
            text-align: center;
            width: 70px;
        }
        .score-input, .text-input {
            width: 100%;
            text-align: center;
            padding: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: 'Arial', sans-serif; 
        }
        .score-input:focus, .text-input:focus {
            border-color: #3b82f6; 
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* Custom styles for list rendering (PEMBETULAN LIST STYLE) */
        ol.list-decimal.p-0.m-0 {
            padding-left: 20px !important; 
            margin-left: 0 !important;
        }
        ol.list-decimal.p-0.m-0 li {
            list-style-position: outside;
            margin-left: 0; 
            padding-left: 0;
        }
        /* Style for editable list items and headers */
        .editable-text, .editable-header {
            cursor: pointer;
            min-height: 20px;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 4px;
            width: 100%; 
        }
        .editable-text:hover {
            background-color: #f0f4ff; 
        }
        .editable-header:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Gaya Khusus untuk senarai Tindakan/Follow Up */
        .list-item-content {
             word-wrap: break-word;
             word-break: break-word;
             font-size: 0.875rem; 
        }
        .follow-up-icon-container {
            flex-shrink: 0; 
            padding-top: 2px; 
        }
        .list-item-flex-container {
            flex-grow: 1;
            min-width: 0; 
        }
        .delete-btn {
            padding: 2px 6px;
            margin-left: 8px;
            font-size: 0.75rem; 
            background-color: #fecaca; 
            color: #b91c1c; 
            border-radius: 4px;
            transition: background-color 0.15s;
            flex-shrink: 0; 
        }
        .delete-btn:hover {
            background-color: #fca5a5; 
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div><h1 class="text-2xl font-bold text-indigo-600">SparkEdu</h1><p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p></div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 </div>
        </div>
    </header>
    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="ic-validation-section" class="max-w-lg mx-auto p-8 bg-white shadow-lg rounded-xl mt-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Pengesahan Akses</h2>
            <p class="text-gray-600 mb-6">Sila masukkan No. Kad Pengenalan anda untuk mengakses panel Pengurusan Kurikulum.</p>
            
            <div>
                <label for="applicant-ic" class="block text-sm font-medium text-gray-700 mb-2">No. IC (12 Digit)</label>
                <div class="relative">
                    <input type="text" id="applicant-ic" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12)" required placeholder="e.g., 900101131234" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button onclick="validateIC()" class="mt-4 w-full btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Sahkan & Akses
                </button>
                <p id="ic-error-message" class="text-red-600 text-sm mt-3 hidden text-center"></p>
            </div>
        </div>
        
        <div id="kurikulum-content" class="p-4 md:p-8 hidden">
             <div id="permission-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg shadow-md" role="alert">
                <p class="font-bold">Amaran Keizinan Firebase!</p>
                <p class="text-sm">Gagal memuatkan atau menyimpan template/header secara kekal. Aplikasi kini menggunakan data lalai (fallback). Sila hubungi pentadbir untuk melonggarkan Peraturan Keselamatan Firestore bagi koleksi `public/data/*`.</p>
            </div>
            <div id="template-controls" class="mb-4 flex justify-between items-center">
                 <button id="add-row-btn" onclick="addNewAspectRow()" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tambah Baris Aspek Baharu
                </button>
                
                <button id="save-template-btn" onclick="saveCurrentDataAsTemplate()" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Simpan Template Asas
                </button>
            </div>
            
            <div class="max-w-7xl mx-auto">
                <header class="mb-6 pb-4 border-b border-blue-200">
                    <h1 class="text-3xl font-extrabold text-blue-800" id="main-title">Standard 3.1: Pengurusan Kurikulum (2025)</h1>
                    <p id="auth-status" class="text-sm text-gray-600 mt-1">Status Pengguna: Memuatkan...</p>
                    <p id="mode-status" class="text-xs text-red-500 mt-1 font-medium">MOD EDITOR: Anda boleh klik dan edit teks dalam jadual ini, termasuk tajuk lajur!</p>
                </header>

                <div id="loading-spinner" class="text-center p-8 text-blue-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Memuatkan data...</p>
                </div>

                <div class="scroll-container bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="data-table border-collapse" id="kurikulum-table">
                        <thead class="bg-blue-600 text-white sticky top-0" id="table-header">
                            </thead>
                        <tbody id="table-body">
                            </tbody>
                        <tfoot id="table-footer">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Dibangunkan oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500">Versi 2.7 (Template Editor with UI Feedback) - Kurikulum</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, runTransaction, arrayUnion, arrayRemove, setLogLevel, updateDoc, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase (MENGGUNAKAN KONFIGURASI SEDAIA ADA)
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        const appId = firebaseConfig.projectId; 

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentDataCache = []; // Cache untuk menyimpan data semasa dari Firestore
        let headerTexts = {}; // Objek untuk menyimpan semua teks header
        let isPermissionError = false; // Status baru untuk ralat keizinan

        // Path Collections
        const TEMPLATE_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_template`; 
        const DATA_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_data`; 
        const PARTICIPANTS_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_participants`;
        const HEADER_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_headers`; // Koleksi baru untuk header
        
        let currentApplicant = null;

        // Data Lalai untuk Header (Digunakan jika tiada dalam Firestore)
        const defaultHeaderTexts = {
            aspek: 'Aspek',
            description: 'Keterangan',
            score_2022: '2022',
            score_2023: '2023',
            score_2024_tov: '2024 (TOV)',
            score_2025_etr: '2025 (ETR)',
            tindakan: 'Tindakan',
            follow_up: 'Follow Up / Pendokumentasian'
        };

        // Fungsi pembantu untuk memetakan senarai string ke objek array untuk konsistensi
        const mapList = (list) => {
            return list.map(item => ({
                id: Math.random().toString(36).substring(2),
                text: item.trim(),
                links: []
            }));
        };

        // Data Awal (Fallback jika tiada template atau data)
        const initialData = [
            {
                id: '311', aspek: "3.1.1: KETETAPAN PELAKSANAAN KURIKULUM", description: "3.1.1.1 Pelaksanaan kurikulum diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 100.00, score_2024_tov: 93.75, score_2025_etr: 94.00,
                tindakan_list: mapList(["Mematuhi arahan yang berkuatkuasa", "Menyeluruh - penubuhan panitia MP, peruntukan kewangan, pentaksiran, penjaminan kualiti (4P), latihan/ tugasan, pembelajaran digital, PdPR/remote learning, sumber pendidikan dan jadual waktu", "Mengikut keperluan sekolah", "Secara spesifik dan jelas"]),
                follow_up_list: mapList(["Perancangan Strategik Kurikulum/Pelan Operasi/PInTaS Kualiti Guru (Standard 4)", "OPPM Kurikulum", "Profil Akademik Sekolah", "Buku Pengurusan Sekolah", "Minit Mesyuarat Pengurusan Kurikulum", "Jadual Waktu Persekolahan", "Takwim Peperiksaan dan Pentaksiran", "Papan Kenyataan Unit Kurikulum", "Laporan Dialog Prestasi Kurikulum", "Telegram Ketua Panitia"])
            },
            {
                id: '3121', aspek: "3.1.2: PENGURUSAN MATA PELAJARAN", description: "3.1.2.1 Pelaksanaan mata pelajaran diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 93.15, score_2024_tov: 92.98, score_2025_etr: 93.00,
                tindakan_list: mapList(["Menyelaras penyediaan RPT dan RPH", "Menyelaras pentaksiran", "Menyelaras tugasan murid", "Menganalisis data dan maklumat pentaksiran", "Berdasarkan keperluan pelaksanaan kurikulum", "Secara menyeluruh meliputi semua tahun/ tingkatan"]),
                follow_up_list: mapList(["Minit Mesyuarat Panitia", "Dokumen Standard Kurikulum Prestasi", "Jadual Peperiksaan / Pentaksiran", "Analisis Pentaksiran dan Penilaian", "Laporan Dialog Prestasi Panitia /maklumbalas Pera", "Borang Semakan Tugasan Murid", "Standard Kecukupan Latihan"])
            },
            {
                id: '3122', aspek: "3.1.2.2 Program peningkatan kualiti pengajaran guru diurus secara terancang", description: "Program ini fokus kepada peningkatan kualiti guru.",
                score_2022: 0.00, score_2023: 88.25, score_2024_tov: 92.04, score_2025_etr: 93.00,
                tindakan_list: mapList(["Merancang dan melaksanakan program pembangunan profesionalisme yang berkaitan dengan mata pelajaran", "Berfokus kepada keperluan guru/ panitia", "Mengambil kira perkembangan pendidikan semasa dari semasa ke semasa"]),
                follow_up_list: mapList(["Buku Pengurusan Sekolah", "Minit Mesyuarat Panitia", "Takwim CPD Mata Pelajaran", "OPPM Panitia", "OPR Program Panitia", "Laporan PLC Panitia / SPLKPM"])
            },
            {
                id: '3123', aspek: "3.1.2.3 Program peningkatan pencapaian murid diurus secara profesional dan terancang", description: "Program ini fokus kepada peningkatan pencapaian murid.",
                score_2022: 0.00, score_2023: 87.75, score_2024_tov: 90.62, score_2025_etr: 91.00,
                tindakan_list: mapList(["Merancang dan melaksanakan program yang menjurus ke arah peningkatan ilmu dan kemahiran", "Berfokus kepada keperluan murid", "Mengambil kira tahap keupayaan dan potensi murid", "Melibatkan murid di semua tahun/ tingkatan dari semasa ke semasa"]),
                follow_up_list: mapList(["Minit Mesyuarat Panitia", "Kertas Kerja Program Kecemerlangan Murid", "OPR Program Kecemerlangan Murid", "Laporan / Analisis PBD Pertengahan Tahun", "Dialog Prestasi Panitia", "Laporan program intervensi"])
            },
            {
                id: '3124', aspek: "3.1.2.4. Bantuan geran perkapita mata pelajaran dimanfaatkan secara sistematik dan terancang", description: "Perbelanjaan PCG diurus secara cekap.",
                score_2022: 0.00, score_2023: 93.50, score_2024_tov: 93.46, score_2025_etr: 94.00,
                tindakan_list: mapList(["Merancang dan melaksanakan perbelanjaan", "Memanfaatkan sumber pendidikan", "Merekod penerimaan dan penggunaan sumber pendidikan", "Mengikut prosedur yang ditetapkan", "Mengikut keperluan", "Secara menyeluruh dari semasa ke semasa"]),
                follow_up_list: mapList(["Minit Mesyuarat Panitia", "Anggaran Perbelanjaan Panitia", "Laporan Kewangan Panitia", "Rekod Pinjaman & Penggunaan Peralatan"])
            },
            {
                id: '313', aspek: "3.1.3: PENGURUSAN MASA INSTRUKSIONAL", description: "3.1.3.1 Masa pelaksanaan PdP diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 100.00, score_2024_tov: 100.00, score_2025_etr: 100.00,
                tindakan_list: mapList(["Menyediakan JW induk, JW kelas, JW guru, JW guru ganti dan JW penggunaan bilik khas", "Melaksanakan PdP seperti yang dijadualkan", "Menyusun semula JW", "Menyelaras program sekolah", "Mematuhi arahan yang berkuatkuasa", "Mengikut ketetapan kurikulum", "Mengikut kesesuaian"]),
                follow_up_list: mapList(["Minit mesyuarat kurikulum", "Jadual Waktu PdPc - Induk / Kelas / Guru / Bilik Khas", "Rekod Jadual Guru Ganti", "Rekod Penggunaan Bilik Khas", "Laporan Learning Walk", "Takwim Pengurusan Sekolah/OPPM"])
            },
            {
                id: '314', aspek: "3.1.4: PENGURUSAN PENILAIAN MURID", description: "3.1.4.1 Peperiksaan dan pentaksiran diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 95.00, score_2024_tov: 95.00, score_2025_etr: 100.00,
                tindakan_list: mapList(["Merancang, menyelaras dan melaksanakan peperiksaan dan pentaksiran", "Menganalisis data dan maklumat peperiksaan dan pentaksiran", "Mengambil tindakan susulan/ intervensi", "Mengikut arahan yang berkuatkuasa", "Mengikut keperluan", "Secara menyeluruh meliputi semua mata pelajaran dan murid dari semasa ke semasa"]),
                follow_up_list: mapList(["Minit Mesyuarat Pengurusan Kurikulum", "Takwim/Jadual Peperiksaan dan Pentaksiran Sekolah", "Analisis Data Peperiksaan dan Pentaksiran Sekolah", "Dialog Prestasi", "Laporan Penjaminan Kualiti PBD", "Program Intervensi"])
            }
        ];

        // --- FIREBASE SETUP AND AUTHENTICATION ---
        try {
            setLogLevel('Debug'); // Diaktifkan untuk melihat log ralat pengesahan
            
            // Menggunakan pembolehubah global __initial_auth_token secara langsung
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication process
            const signIn = async () => {
                if (initialAuthToken) {
                    try {
                        // CUBA log masuk dengan token tersuai (jika gagal, ia akan beralih ke catch)
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Pengesahan Token Berjaya.");
                        return; // Berjaya, keluar dari fungsi
                    } catch (tokenError) {
                        // Jika Token GAGAL (cth. auth/custom-token-mismatch), beralih ke log masuk tanpa nama
                        console.warn("Ralat token tersuai dikesan. Beralih ke log masuk tanpa nama: ", tokenError.message);
                        // JANGAN 'return', teruskan ke signInAnonymously()
                    }
                }
                
                // Jika tiada token, atau token gagal, cuba log masuk tanpa nama
                await signInAnonymously(auth);
                console.log("Pengesahan Tanpa Nama Berjaya.");
            };
            
            // Trigger sign in if not already signed in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Sembunyikan spinner dan tunjukkan form IC
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('ic-validation-section').classList.remove('hidden');
                    document.getElementById('auth-status').textContent = `Status Pengguna: ID Sesi Aktif (${userId.substring(0, 8)}...)`;
                    
                    // Muatkan header dan data selepas pengesahan
                    await loadHeaders();
                    initializeDataAndListener();
                } else if (!auth.currentUser) {
                    // Cuba log masuk jika auth state belum stabil
                    await signIn();
                }
            });

        } catch (error) {
            console.error("Ralat ketika memulakan Firebase atau Pengesahan:", error);
            document.getElementById('auth-status').textContent = 'Ralat Pengesahan Firebase. Sila semak konsol.';
            document.getElementById('loading-spinner').classList.add('hidden');
        }
        
        // --- IC VALIDATION LOGIC ---
        async function validateIC() {
            if (!isAuthReady) {
                console.error("Sistem sedang memuatkan. Sila tunggu sebentar.");
                return;
            }
            
            const icInput = document.getElementById('applicant-ic');
            const ic = icInput.value.replace(/[^0-9]/g, '');
            const errorEl = document.getElementById('ic-error-message');
            const submitButton = document.querySelector('#ic-validation-section button');
            
            errorEl.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyemak...';

            if (ic.length !== 12) {
                errorEl.textContent = "Sila masukkan 12 digit No. IC yang sah.";
                errorEl.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
                return;
            }
            
            try {
                const participantsRef = collection(db, PARTICIPANTS_COLLECTION_PATH);
                const q = query(participantsRef, where("ic", "==", ic));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    currentApplicant = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    
                    const stationName = currentApplicant.station || "SMK Miri (Tiada Stesen)";
                    document.getElementById('main-title').textContent = `Standard 3.1: Pengurusan Kurikulum ${stationName} (2025)`;
                    
                    // Success: Hide IC section, show content, initialize data listener
                    document.getElementById('ic-validation-section').classList.add('hidden');
                    document.getElementById('kurikulum-content').classList.remove('hidden');
                    document.getElementById('auth-status').textContent += ` | Disahkan: ${currentApplicant.name}`;
                    
                    // Panggilan ini telah dipindahkan ke onAuthStateChanged, jadi ia sepatutnya sudah dimuatkan.
                    // initializeDataAndListener(); 
                    
                } else {
                    errorEl.textContent = "No. IC tidak dijumpai dalam rekod SPARK. Sila hubungi pentadbir.";
                    errorEl.classList.remove('hidden');
                }
                
            } catch(error) {
                console.error("Error validating IC:", error);
                errorEl.textContent = "Gagal menghubungi pangkalan data. Semak Firebase Rules.";
                errorEl.classList.remove('hidden');
            }

            submitButton.disabled = false;
            submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
        }

        // --- HEADER MANAGEMENT ---

        // Muatkan tajuk header dari Firestore
        async function loadHeaders() {
            try {
                const headerRef = doc(db, HEADER_COLLECTION_PATH, 'template_headers');
                const docSnap = await getDoc(headerRef);
                
                if (docSnap.exists()) {
                    headerTexts = docSnap.data().texts;
                    console.log("Headers dimuatkan dari Firestore.");
                } else {
                    headerTexts = defaultHeaderTexts;
                    console.log("Menggunakan Headers lalai.");
                    // CUBATRY: Cuma cuba setDoc, jika gagal (disebabkan permission), ia akan ditangkap oleh catch di bawah
                    await setDoc(headerRef, { texts: defaultHeaderTexts });
                }
                isPermissionError = false;
            } catch (e) {
                // FALLBACK: Jika ralat permission/getDoc/setDoc, hanya log dan guna data lalai.
                console.error("Ralat memuatkan atau menyimpan headers (mungkin keizinan). Menggunakan data lalai:", e.message);
                headerTexts = defaultHeaderTexts;
                isPermissionError = true; // Tetapkan status ralat
                document.getElementById('permission-error-banner').classList.remove('hidden');
            }
        }
        
        // Simpan perubahan header
        async function saveHeader(key, value) {
            try {
                headerTexts[key] = value;
                const headerRef = doc(db, HEADER_COLLECTION_PATH, 'template_headers');
                await updateDoc(headerRef, { [`texts.${key}`]: value });
                console.log(`Header ${key} berjaya dikemaskini.`);
                
                // Re-render table header
                renderTableHeader(); 
            } catch (e) {
                console.error("Ralat menyimpan header (mungkin keizinan):", e.message);
                alert(`Gagal menyimpan tajuk lajur. Sila semak keizinan Firebase. ${e.message}`);
                throw new Error("Save Header failed"); // Buang ralat untuk ditangkap oleh saveEditedHeader
            }
        }

        // Render table header (Lebar lajur diubah suai untuk memberi ruang kepada Tindakan/Follow Up)
        function renderTableHeader() {
            const thead = document.getElementById('table-header');
            const headers = [
                // Lebar Dikurangkan
                { key: 'aspek', class: 'w-1/8' }, // 12.5%
                { key: 'description', class: 'w-1/6' }, // 16.6%
                // Lebar Skor Dikekalkan
                { key: 'score_2022', class: 'score-cell' },
                { key: 'score_2023', class: 'score-cell' },
                { key: 'score_2024_tov', class: 'score-cell' },
                { key: 'score_2025_etr', class: 'score-cell' },
                // Lebar Ditambah
                { key: 'tindakan', class: 'w-1/4' }, // 25%
                { key: 'follow_up', class: 'w-1/4' } // 25%
            ];

            thead.innerHTML = `
                <tr class="bg-blue-600 text-white sticky top-0">
                    ${headers.map(h => `
                        <th class="p-3 border-r border-blue-500 ${h.class}">
                            <span class="editable-header" 
                                  onclick="showHeaderEditInput('${h.key}', this)">
                                ${headerTexts[h.key] || defaultHeaderTexts[h.key]}
                            </span>
                        </th>
                    `).join('')}
                </tr>
            `;
        }

        // Tunjukkan borang edit untuk Header
        function showHeaderEditInput(key, targetElement) {
            removeInlineForm(); 

            if (isPermissionError) {
                alert("Tidak dapat mengedit tajuk lajur secara kekal kerana ralat keizinan Firebase. Sila betulkan Peraturan Keselamatan dahulu.");
                return;
            }

            const initialValue = headerTexts[key] || defaultHeaderTexts[key];
            const containerId = `inline-header-form-container-${key}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-text-form absolute z-10 p-2 bg-yellow-50 border border-yellow-300 rounded-lg shadow-lg" 
                     style="top: ${targetElement.offsetTop + targetElement.offsetHeight}px; left: ${targetElement.offsetLeft}px;">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Edit Tajuk Lajur:</label>
                    <input type="text" id="edit-header-inline" value="${initialValue}" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 p-2 border text-sm">
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-xs py-1 px-2 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-header-btn-inline" 
                                onclick="saveEditedHeader('${key}')" 
                                class="btn bg-yellow-600 text-white text-xs py-1 px-2 rounded-lg hover:bg-yellow-700">Simpan</button>
                    </div>
                </div>
            `;
            
            // Masukkan form di luar thead, tetapi posisikan relatif kepada header yang diklik
            document.body.insertAdjacentHTML('beforeend', formHtml);
            
            const input = document.getElementById('edit-header-inline');
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);

            // Sembunyikan header yang asal
            document.querySelector('#table-header').classList.add('opacity-0');
        }

        // Simpan header yang diedit
        async function saveEditedHeader(key) {
            if (isPermissionError) {
                alert("Gagal menyimpan tajuk lajur kerana ralat keizinan Firebase. Perubahan tidak dapat dikekalkan.");
                return;
            }

            const container = document.getElementById(`inline-header-form-container-${key}`);
            
            // **FIX 1: Semak jika kontena wujud (silent exit)**
            if (!container) {
                // console.error("Ralat (saveEditedHeader): Kontena borang edit header tidak dijumpai."); // COMMENTED OUT
                return;
            }

            const input = container.querySelector('input');
            const newText = input.value.trim();

            if (!newText) {
                alert("Tajuk lajur tidak boleh kosong.");
                return;
            }

            const saveBtn = container.querySelector('#save-header-btn-inline');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            try {
                await saveHeader(key, newText);
            } catch (e) {
                // Ralat ditangkap dari saveHeader. Aktifkan semula butang.
                saveBtn.disabled = false;
                saveBtn.textContent = 'Simpan'; // Set semula teks kepada Simpan
                return;
            }
            
            removeInlineForm();
            document.querySelector('#table-header').classList.remove('opacity-0');
        }

        // --- TAMBAH BARIS ASPEK BARU (FUNGSI BARU) ---
        async function addNewAspectRow() {
            if (isPermissionError) {
                alert("Tidak dapat menambah baris baharu kerana ralat keizinan Firebase. Sila semak Peraturan Keselamatan dahulu.");
                return;
            }

            const newId = Date.now().toString(); // ID unik berdasarkan timestamp
            const newDocId = `manual_${newId.substring(newId.length - 6)}`; // ID ringkas untuk pengenalan

            const defaultData = {
                id: newDocId,
                aspek: `3.1.X: ASPEK BARU`,
                description: `3.1.X.X Keterangan aspek baharu. Klik untuk edit.`,
                score_2022: 0.00,
                score_2023: 0.00,
                score_2024_tov: 0.00,
                score_2025_etr: 0.00,
                tindakan_list: mapList(["Tindakan 1 (Klik untuk edit)"]),
                follow_up_list: mapList(["Pendokumentasian 1 (Klik untuk edit)"])
            };
            
            const addBtn = document.getElementById('add-row-btn');
            const originalText = addBtn.innerHTML;
            
            addBtn.disabled = true;
            addBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menambah...';

            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, defaultData.id);
                await setDoc(docRef, defaultData);
                console.log("Baris aspek baru berjaya ditambah dengan ID:", defaultData.id);
            } catch (e) {
                console.error("Ralat menambah baris aspek:", e);
                alert(`Gagal menambah baris aspek. Sila semak keizinan Firebase. ${e.message}`);
            }

            addBtn.disabled = false;
            addBtn.innerHTML = originalText;
        }

        // --- TEMPLATE & DATA MANAGEMENT ---
        
        // Fungsi untuk mendapatkan data template jika wujud
        async function getTemplateData() {
            try {
                const q = query(collection(db, TEMPLATE_COLLECTION_PATH));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    // Ambil semua dokumen dari template dan kembalikan sebagai array
                    const templateData = [];
                    snapshot.forEach(doc => {
                        templateData.push({ id: doc.id, ...doc.data() });
                    });
                    templateData.sort((a, b) => a.id.localeCompare(b.id)); 
                    return templateData;
                }
            } catch (e) {
                 // FALLBACK: Jika ralat permission/getDocs, hanya log
                console.error("Ralat memuatkan template (mungkin keizinan). Menggunakan data awal statik:", e.message);
                isPermissionError = true; // Tetapkan status ralat
                document.getElementById('permission-error-banner').classList.remove('hidden');
            }
            return null; // Tiada template dijumpai
        }
        
        // Fungsi untuk mendapatkan semua data semasa dari Firestore (sama ada data sebenar atau template)
        async function getCurrentFirestoreData(collectionPath) {
             try {
                const q = query(collection(db, collectionPath));
                const snapshot = await getDocs(q);
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                data.sort((a, b) => a.id.localeCompare(b.id)); 
                isPermissionError = false;
                return data;
            } catch (e) {
                // FALLBACK: Jika ralat permission/getDocs, return array kosong
                console.error(`Ralat memuatkan data dari ${collectionPath} (mungkin keizinan). Return data kosong:`, e.message);
                isPermissionError = true; // Tetapkan status ralat
                document.getElementById('permission-error-banner').classList.remove('hidden');
                return [];
            }
        }

        // Fungsi untuk mengemas kini skor ke Firestore
        async function updateScore(docId, fieldName, value) {
            const numericValue = parseFloat(value);
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 100) {
                console.error("Nilai skor tidak sah.");
                return;
            }
            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, docId);
                await updateDoc(docRef, { [fieldName]: numericValue });
                console.log(`Skor ${fieldName} untuk dokumen ${docId} berjaya dikemaskini.`);
            } catch (e) {
                console.error(`Ralat mengemaskini skor ${fieldName} untuk ${docId} (mungkin keizinan):`, e.message);
                alert(`Gagal kemaskini skor. Sila semak keizinan Firebase. ${e.message}`);
            }
        }
        
        // Fungsi baru untuk mengemas kini Aspek/Description/Teks Senarai
        async function updateText(docId, fieldName, value, itemId = null) {
            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, docId);
                
                if (!itemId) {
                    // Update field langsung (Aspek atau Description)
                    await updateDoc(docRef, { [fieldName]: value });
                } else {
                    // Update item dalam list (Tindakan atau Follow Up)
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(docRef);
                        if (!docSnap.exists()) { throw "Dokumen tidak wujud!"; }

                        const data = docSnap.data();
                        const list = data[fieldName];
                        const itemIndex = list.findIndex(item => item.id === itemId);

                        if (itemIndex > -1) {
                            list[itemIndex].text = value;
                            transaction.update(docRef, { [fieldName]: list });
                        } else {
                            throw "Item ID tidak dijumpai dalam senarai.";
                        }
                    });
                }
                console.log(`Teks ${fieldName} berjaya dikemaskini.`);
            } catch (e) {
                console.error(`Ralat mengemaskini teks ${fieldName} untuk ${docId} (mungkin keizinan):`, e.message);
                alert(`Gagal menyimpan teks. Sila semak keizinan Firebase. ${e.message}`);
                throw new Error("Update Text failed"); // Buang ralat untuk ditangkap oleh saveEditedText/saveNewItem
            }
        }

        // FUNGSI BARU: Memadam Item Senarai
        async function deleteListItem(docId, fieldName, itemId) {
             if (isPermissionError) {
                alert("Gagal memadam item kerana ralat keizinan Firebase. Perubahan tidak dapat dikekalkan.");
                return;
            }

            if (!confirm("Adakah anda pasti mahu memadam item ini? Tindakan ini tidak boleh diundur.")) {
                return;
            }

            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, docId);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) { throw "Dokumen tidak wujud!"; }

                    const data = docSnap.data();
                    const list = data[fieldName];
                    const itemIndex = list.findIndex(item => item.id === itemId);

                    if (itemIndex > -1) {
                        // Buang item dari senarai
                        list.splice(itemIndex, 1);
                        transaction.update(docRef, { [fieldName]: list });
                    } else { throw "Item ID tidak dijumpai dalam senarai."; }
                });

                console.log("Item senarai berjaya dipadam!");
            } catch (e) {
                console.error("Ralat memadam item senarai:", e);
                alert(`Gagal memadam item. Sila semak keizinan Firebase. ${e.message}`);
            }
        }
        
        // Fungsi utama untuk menyimpan data semasa (yang telah di-cache) sebagai template
        async function saveCurrentDataAsTemplate() {
            const saveBtn = document.getElementById('save-template-btn');
            const originalText = saveBtn.textContent;
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            
            if (isPermissionError) {
                 alert("Gagal menyimpan Template Asas! Ralat keizinan Firebase dikesan. Perubahan anda tidak dapat dikekalkan untuk kegunaan masa hadapan.");
                 saveBtn.disabled = false;
                 saveBtn.textContent = originalText;
                 return;
            }

            if (currentDataCache.length === 0) {
                alert("Tiada data untuk disimpan sebagai template. Sila muatkan data dahulu.");
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            try {
                console.log("Menyimpan template baru ke Firestore...");
                // Simpan Headers dahulu
                const headerRef = doc(db, HEADER_COLLECTION_PATH, 'template_headers');
                await setDoc(headerRef, { texts: headerTexts });

                // Simpan data jadual
                const batchPromises = currentDataCache.map(data => {
                    // Ambil hanya bidang yang relevan untuk template (semua kecuali skor, kerana skor adalah input pengguna)
                    const { id, aspek, description, tindakan_list, follow_up_list } = data;
                    const docRef = doc(db, TEMPLATE_COLLECTION_PATH, id);
                    return setDoc(docRef, { id, aspek, description, tindakan_list, follow_up_list });
                });
                
                await Promise.all(batchPromises);
                alert("Template Asas Kurikulum berjaya disimpan! Data pengguna baru kini akan menggunakan template ini.");
                console.log("Template Asas berjaya disimpan.");
            } catch (e) {
                console.error("Ralat menyimpan template (mungkin keizinan):", e.message);
                alert(`Gagal menyimpan template. Sila semak keizinan Firebase. ${e.message}`);
                // Tetapkan status ralat jika gagal menyimpan
                isPermissionError = true;
                document.getElementById('permission-error-banner').classList.remove('hidden');
            }

            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }


        // Fungsi untuk 'menyemai' (seed) data: Mula-mula cuba template, jika tiada guna initialData
        async function seedDataIfNeeded() {
            console.log("Memeriksa data sedia ada...");
            const currentData = await getCurrentFirestoreData(DATA_COLLECTION_PATH);

            if (currentData.length === 0) {
                // Tiada data sedia ada. Cuba muatkan dari template.
                let dataToSeed = await getTemplateData();
                
                if (dataToSeed && dataToSeed.length > 0) {
                    console.log("Memuatkan template yang disimpan untuk seed data pengguna.");
                } else {
                    // Tiada template? Guna data awal (initialData) sebagai fallback
                    console.log("Tiada template ditemui. Menggunakan data awal statik (fallback).");
                    dataToSeed = initialData;
                }
                
                // Masukkan data ke dalam collection DATA_COLLECTION_PATH
                try {
                    const batchPromises = dataToSeed.map(data => {
                        const docRef = doc(db, DATA_COLLECTION_PATH, data.id);
                        // Tambahkan skor lalai 0.00 untuk data yang di-seed
                        return setDoc(docRef, {
                            ...data,
                            score_2022: 0.00, 
                            score_2023: 0.00, 
                            score_2024_tov: 0.00, 
                            score_2025_etr: 0.00,
                        });
                    });
                    await Promise.all(batchPromises);
                    console.log("Data awal berjaya di-seed.");
                } catch (e) {
                    console.error("Ralat menyemai data awal (mungkin keizinan):", e.message);
                    isPermissionError = true;
                    document.getElementById('permission-error-banner').classList.remove('hidden');
                }
            } else {
                 console.log(`Data sedia ada ditemui (${currentData.length} entri). Tidak perlu seed.`);
            }
        }

        async function initializeDataAndListener() {
            document.querySelector('#kurikulum-content #loading-spinner').classList.remove('hidden'); 

            await seedDataIfNeeded();

            // Sediakan pendengar masa nyata (onSnapshot)
            const q = query(collection(db, DATA_COLLECTION_PATH));
            // TAMBAH TRY/CATCH DALAM onSnapshot JIKA IA MENYEBABKAN KESALAHAN KEIZINAN
            try {
                onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    
                    data.sort((a, b) => a.id.localeCompare(b.id)); 
                    currentDataCache = data; // Kemas kini cache data
                    
                    renderTable(data);
                    document.querySelector('#kurikulum-content #loading-spinner').classList.add('hidden');
                }, (error) => {
                    console.error("Ralat onSnapshot (mungkin keizinan):", error.message);
                    document.querySelector('#kurikulum-content #loading-spinner').innerHTML = `<p class="text-red-600">Ralat memuatkan data secara langsung. Sila semak keizinan Firebase.</p>`;
                    isPermissionError = true;
                    document.getElementById('permission-error-banner').classList.remove('hidden');
                });
            } catch (e) {
                 console.error("Ralat onSnapshot utama (mungkin keizinan):", e.message);
            }
        }

        // --- INLINE EDITING LOGIC ---

        function removeInlineForm() {
            // ... (Fungsi sedia ada untuk membuang borang kecil)
            const existingForms = document.querySelectorAll('.inline-edit-form, .inline-text-form');
            existingForms.forEach(form => {
                const button = form.previousElementSibling;
                 if (button && button.tagName === 'BUTTON') {
                    button.disabled = false;
                    button.classList.remove('hidden');
                }
                form.remove();
            });
            // Re-enable all list editable text and table header opacity
            document.querySelectorAll('.editable-text').forEach(el => el.classList.remove('hidden'));
            const tableHeader = document.querySelector('#table-header');
            if (tableHeader) tableHeader.classList.remove('opacity-0');

            // Buang semua form header dari body
            document.querySelectorAll('.inline-header-form-container').forEach(form => form.remove());
        }
        
        // ------------------------------------
        // 1. Inisialisasi Borang Edit Teks Umum (Aspek, Description, List Text)
        // ------------------------------------

        function showTextEditInput(docId, fieldName, initialValue, targetElement, itemId = null) {
            removeInlineForm(); // Tutup borang sedia ada

            if (isPermissionError) {
                alert("Tidak dapat mengedit teks secara kekal kerana ralat keizinan Firebase. Sila betulkan Peraturan Keselamatan dahulu.");
                return;
            }

            // PEMBETULAN LOGIK DI SINI:
            const isList = !!itemId; 
            const itemIdString = itemId || 'null'; 
            const isListString = isList ? 'true' : 'false';

            const containerId = `inline-text-form-container-${docId}-${fieldName}-${itemIdString}`;
            const isAspekOrDescription = fieldName === 'aspek' || fieldName === 'description';
            
            const formHtml = `
                <div id="${containerId}" class="inline-text-form mt-1 p-2 bg-yellow-50 border border-yellow-300 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Edit Teks:</label>
                    <textarea id="edit-text-inline" rows="${isAspekOrDescription ? 2 : 3}" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 p-2 border text-sm resize-none">${initialValue}</textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-text-btn-inline" 
                                onclick="saveEditedText('${docId}', '${fieldName}', '${itemIdString}', '${isListString}')" 
                                class="btn bg-yellow-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-yellow-700">Simpan Teks</button>
                    </div>
                </div>
            `;
            
            targetElement.insertAdjacentHTML('beforebegin', formHtml);
            targetElement.classList.add('hidden'); // Sembunyikan teks asal
            
            const textarea = document.getElementById('edit-text-inline');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length); // Pindah kursor ke hujung
        }
        
        async function saveEditedText(docId, fieldName, itemId, isListStr) {
            if (isPermissionError) {
                alert("Gagal menyimpan teks kerana ralat keizinan Firebase. Perubahan tidak dapat dikekalkan.");
                return;
            }

            // Kita gunakan docId dan fieldName yang betul untuk mencari kontena
            const container = document.getElementById(`inline-text-form-container-${docId}-${fieldName}-${itemId || 'direct'}`);
            
            // **FIXED: Semak jika kontena wujud (silent exit)**
            if (!container) {
                // console.error("Ralat (saveEditedText): Kontena borang edit teks tidak dijumpai."); // MENGELAKKAN RAHMAT KONSOLE
                return;
            }

            const textarea = container.querySelector('textarea');
            const text = textarea.value.trim();

            if (!text) {
                alert("Sila masukkan teks.");
                return;
            }

            const saveBtn = container.querySelector('#save-text-btn-inline');
            const originalText = saveBtn.textContent;
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            
            // PEMBETULAN LOGIK DI SINI:
            const itemIdValue = itemId === 'null' ? null : itemId;
            const isList = isListStr === 'true'; // Bandingkan dengan string 'true'

            try {
                // updateText sedia ada sudah mempunyai logik yang seragam.
                await updateText(docId, fieldName, text, itemIdValue);
                
                // Kemas kini data cache secara manual untuk prestasi pantas (sebelum onSnapshot)
                const docIndex = currentDataCache.findIndex(d => d.id === docId);
                if (docIndex > -1) {
                    if (isList) {
                        const list = currentDataCache[docIndex][fieldName];
                        const itemIndex = list.findIndex(item => item.id === itemIdValue);
                        if (itemIndex > -1) {
                            list[itemIndex].text = text;
                        }
                    } else {
                        // Jika bukan list (Aspek/Keterangan)
                        currentDataCache[docIndex][fieldName] = text;
                    }
                    renderTable(currentDataCache); // Render semula dari cache
                }

                removeInlineForm(); 
            } catch (e) {
                // Ralat ditangkap dari updateText. Aktifkan semula butang.
                console.error("Ralat menyimpan teks:", e);
                alert("Gagal menyimpan teks. Sila semak konsol.");
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }


        // ------------------------------------
        // 2. Tambah Item (Tindakan / Follow Up)
        // ------------------------------------

        async function saveNewItem(docId, fieldName) {
            if (isPermissionError) {
                alert("Gagal menambah item kerana ralat keizinan Firebase. Perubahan tidak dapat dikekalkan.");
                return;
            }

            // ... (Fungsi sedia ada)
            const container = document.getElementById(`inline-form-container-${docId}-${fieldName}`);
            
            // **FIXED: Semak jika kontena wujud (silent exit)**
            if (!container) {
                // console.error("Ralat (saveNewItem): Kontena borang item baru tidak dijumpai."); // MENGELAKKAN RAHMAT KONSOLE
                return;
            }

            const textarea = container.querySelector('textarea');
            const text = textarea.value.trim();

            if (!text) {
                alert("Sila masukkan teks untuk item baru.");
                return;
            }

            const saveBtn = container.querySelector('#save-item-btn-inline');
            const originalText = saveBtn.textContent;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const newItem = {
                id: Math.random().toString(36).substring(2),
                text: text,
                links: []
            };

            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, docId);
                await updateDoc(docRef, {
                    [fieldName]: arrayUnion(newItem)
                });
                console.log("Item baru berjaya ditambah!");
                removeInlineForm(); 
            } catch (e) {
                console.error("Ralat menambah item baru:", e);
                alert("Gagal menambah item. Sila semak konsol.");
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showNewItemInput(docId, fieldName, buttonEl) {
            removeInlineForm(); 

            if (isPermissionError) {
                alert("Tidak dapat menambah item secara kekal kerana ralat keizinan Firebase. Sila betulkan Peraturan Keselamatan dahulu.");
                return;
            }

            const isTindakan = fieldName === 'tindakan_list';
            const placeholder = isTindakan ? 'Masukkan item tindakan baru...' : 'Masukkan item follow up / pendokumentasian baru...';
            
            const containerId = `inline-form-container-${docId}-${fieldName}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-edit-form mt-2 p-3 bg-gray-50 border border-blue-200 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">${isTindakan ? 'Tambah Tindakan' : 'Tambah Follow Up'}:</label>
                    <textarea id="item-text-inline" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm resize-none" placeholder="${placeholder}"></textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-item-btn-inline" onclick="saveNewItem('${docId}', '${fieldName}')" class="btn bg-blue-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-blue-700">Simpan Item</button>
                    </div>
                </div>
            `;
            
            buttonEl.insertAdjacentHTML('beforebegin', formHtml);
            buttonEl.classList.add('hidden'); 
            buttonEl.disabled = true;
            document.getElementById('item-text-inline').focus();
        }

        // ------------------------------------
        // 3. Tambah Pautan (Link)
        // ------------------------------------
        
        async function saveNewLink(docId, fieldName, itemId) {
            if (isPermissionError) {
                alert("Gagal menambah pautan kerana ralat keizinan Firebase. Perubahan tidak dapat dikekalkan.");
                return;
            }

            // ... (Fungsi sedia ada)
            const container = document.getElementById(`inline-link-form-container-${itemId}`);
            
            // **FIXED: Semak jika kontena wujud (silent exit)**
            if (!container) {
                // console.error("Ralat (saveNewLink): Kontena borang pautan baru tidak dijumpai."); // MENGELAKKAN RAHMAT KONSOLE
                return;
            }

            const linkNameInput = container.querySelector('#link-name-inline');
            const linkUrlInput = container.querySelector('#link-url-inline');
            
            const linkName = linkNameInput.value.trim();
            const linkUrl = linkUrlInput.value.trim();

            if (!linkName || !linkUrl || !linkUrl.startsWith('http')) {
                alert("Sila masukkan Nama Pautan dan URL yang sah (bermula dengan http/https).");
                return;
            }
            
            const saveBtn = container.querySelector('#save-link-btn-inline');
            const originalText = saveBtn.textContent;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const newLink = { name: linkName, url: linkUrl };

            try {
                const docRef = doc(db, DATA_COLLECTION_PATH, docId);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) { throw "Dokumen tidak wujud!"; }

                    const data = docSnap.data();
                    const list = data[fieldName];
                    const itemIndex = list.findIndex(item => item.id === itemId);

                    if (itemIndex > -1) {
                        if (!list[itemIndex].links) { list[itemIndex].links = []; }
                        list[itemIndex].links.push(newLink);
                        transaction.update(docRef, { [fieldName]: list });
                    } else { throw "Item ID tidak dijumpai dalam senarai."; }
                });

                console.log("Pautan baru berjaya ditambah!");
                removeInlineForm(); 
            } catch (e) {
                console.error("Ralat menambah pautan baru:", e);
                alert("Gagal menambah pautan. Sila semak konsol.");
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        function showNewLinkInput(docId, fieldName, itemId, buttonEl) {
            removeInlineForm(); 
            
            if (isPermissionError) {
                alert("Tidak dapat menambah pautan secara kekal kerana ralat keizinan Firebase. Sila betulkan Peraturan Keselamatan dahulu.");
                return;
            }

            const containerId = `inline-link-form-container-${itemId}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-edit-form mt-2 p-3 bg-green-50 border border-green-300 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Nama Pautan:</label>
                    <input type="text" id="link-name-inline" class="w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm mb-2" placeholder="Nama Pautan">
                    <label class="block text-xs font-medium text-gray-700 mb-1">URL Pautan:</label>
                    <input type="url" id="link-url-inline" class="w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="https://..." value="https://">
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-link-btn-inline" onclick="saveNewLink('${docId}', '${fieldName}', '${itemId}')" class="btn bg-green-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-green-700">Simpan Pautan</button>
                    </div>
                </div>
            `;
            
            buttonEl.insertAdjacentHTML('beforebegin', formHtml);
            buttonEl.classList.add('hidden'); 
            buttonEl.disabled = true;
            document.getElementById('link-name-inline').focus();
        }


        // --- RENDERING FUNCTIONS (DIUBAH SUAI: renderList) ---

        function renderList(list, docId, fieldName) {
            const isTindakan = fieldName === 'tindakan_list';
            const ListTag = isTindakan ? 'ol' : 'ul'; 

            const listItemsHtml = list.map((item, index) => {
                const itemTextHtml = `
                    <span class="editable-text list-item-content text-sm" 
                          onclick="showTextEditInput('${docId}', '${fieldName}', this.textContent.trim(), this, '${item.id}')">
                        ${item.text}
                    </span>
                `;
                
                let contentHtml = '';

                if (isTindakan) {
                    // Senarai Bernombor (Tindakan): Menggunakan text-sm
                    contentHtml = `
                        <div class="flex items-start justify-between">
                            <div class="list-item-flex-container">
                                <p class="text-sm text-gray-800 font-medium">${itemTextHtml}</p>
                            </div>
                            <button class="delete-btn flex-shrink-0" onclick="deleteListItem('${docId}', '${fieldName}', '${item.id}')">
                                X Hapus
                            </button>
                        </div>
                    `;
                } else {
                    // Senarai Tak Bernombor (Follow Up): Menggunakan text-sm dan ikon arrow
                    contentHtml = `
                        <div class="flex items-start justify-between">
                             <div class="flex items-start list-item-flex-container">
                                <span class="text-blue-600 font-bold pr-1 follow-up-icon-container"></span>
                                <p class="text-sm text-gray-800 font-medium flex-grow min-w-0">${itemTextHtml}</p>
                            </div>
                            <button class="delete-btn flex-shrink-0" onclick="deleteListItem('${docId}', '${fieldName}', '${item.id}')">
                                X Hapus
                            </button>
                        </div>
                    `;
                }
                
                // Common interactive elements and links structure
                const interactionHtml = `
                    ${item.links && item.links.length > 0 ? `
                        <div class="mt-1 flex flex-wrap gap-1 text-xs">
                            ${item.links.map(link => `
                                <a href="${link.url}" target="_blank" class="flex items-center text-blue-600 hover:text-blue-800 transition duration-150">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                                    ${link.name}
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition"
                            onclick="showNewLinkInput('${docId}', '${fieldName}', '${item.id}', this)">
                        + Tambah Pautan
                    </button>
                `;

                // Kelas yang diubah suai untuk kepadatan
                const liClasses = `mb-1 p-2 border border-gray-100 rounded-lg bg-gray-50 break-words`;

                return `<li class="${liClasses}">
                    ${contentHtml}
                    ${interactionHtml}
                </li>`;

            }).join('');

            // PENTING: Untuk Tindakan, gunakan list-decimal p-0 m-0 bersama CSS fix di <style>
            const listStyle = isTindakan ? 'list-decimal p-0 m-0' : 'list-none p-0 m-0';
            
            return `
                <${ListTag} class="mt-1 ${listStyle}">
                    ${listItemsHtml}
                </${ListTag}>
            `;
        }

        // Render keseluruhan jadual
        function renderTable(data) {
            renderTableHeader(); // Sentiasa render header yang dikemas kini

            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            
            // 1. Render Body
            tbody.innerHTML = data.map(row => `
                <tr class="border-b hover:bg-gray-50 transition duration-100">
                    <td class="data-cell border-r border-gray-200 w-1/8">
                        <p class="font-semibold text-gray-900 editable-text text-sm" 
                           onclick="showTextEditInput('${row.id}', 'aspek', this.textContent.trim(), this, null)">
                            ${row.aspek}
                        </p>
                    </td>
                    <td class="data-cell border-r border-gray-200 w-1/6">
                        <p class="text-sm text-gray-600 mt-1 editable-text text-sm" 
                           onclick="showTextEditInput('${row.id}', 'description', this.textContent.trim(), this, null)">
                            ${row.description}
                        </p>
                    </td>
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2022', row.score_2022 || 0)}
                    </td>
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2023', row.score_2023 || 0)}
                    </td>
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2024_tov', row.score_2024_tov || 0)}
                    </td>
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2025_etr', row.score_2025_etr || 0)}
                    </td>
                    
                    <td class="data-cell border-r border-gray-200 w-1/4">
                        ${renderList(row.tindakan_list, row.id, 'tindakan_list')}
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="showNewItemInput('${row.id}', 'tindakan_list', this)">
                            + Tambah Tindakan
                        </button>
                    </td>

                    <td class="data-cell w-1/4">
                        ${renderList(row.follow_up_list, row.id, 'follow_up_list')}
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="showNewItemInput('${row.id}', 'follow_up_list', this)">
                            + Tambah Follow Up
                        </button>
                    </td>
                </tr>
            `).join('');

            // 2. Render Footer (Peratus Skor)
            const count = data.length;
            if (count > 0) {
                const total_2022 = data.reduce((sum, row) => sum + (row.score_2022 || 0), 0);
                const total_2023 = data.reduce((sum, row) => sum + (row.score_2023 || 0), 0);
                const total_2024 = data.reduce((sum, row) => sum + (row.score_2024_tov || 0), 0);
                const total_2025 = data.reduce((sum, row) => sum + (row.score_2025_etr || 0), 0);
                
                const avg_2022 = (total_2022 / count).toFixed(2);
                const avg_2023 = (total_2023 / count).toFixed(2);
                const avg_2024 = (total_2024 / count).toFixed(2);
                const avg_2025 = (total_2025 / count).toFixed(2);
                
                tfoot.innerHTML = `
                    <tr class="bg-blue-100 text-blue-900 font-extrabold border-t-4 border-blue-600">
                        <td class="data-cell p-3 text-sm" colspan="2">PERATUS SKOR KESELURUHAN</td>
                        <td class="score-cell p-3 font-mono text-sm">${avg_2022}</td>
                        <td class="score-cell p-3 font-mono text-sm">${avg_2023}</td>
                        <td class="score-cell p-3 font-mono text-sm">${avg_2024}</td>
                        <td class="score-cell p-3 font-mono text-sm">${avg_2025}</td>
                        <td class="data-cell border-r border-blue-300 p-3" colspan="2"></td>
                    </tr>
                `;
            } else {
                 tfoot.innerHTML = '';
            }
        }
        
        // Fungsi untuk menjana input skor
        function generateScoreInput(docId, fieldName, score) {
            const displayScore = score.toFixed(2);
            const isETR = fieldName === 'score_2025_etr';
            
            const colorClass = 'text-gray-700'; 
            const boldnessClass = isETR ? 'font-bold' : ''; 
            
            return `
                <input type="number" 
                       step="0.01" 
                       min="0" 
                       max="100"
                       value="${displayScore}" 
                       class="score-input ${colorClass} font-mono text-sm ${boldnessClass}"
                       onchange="updateScore('${docId}', '${fieldName}', this.value)"
                       onblur="this.value = parseFloat(this.value).toFixed(2)"
                />
            `;
        }


        // PENTING: Mendedahkan fungsi ke window untuk diakses oleh onclick di HTML
        Object.assign(window, {
            validateIC,
            updateScore,
            updateText,
            showNewItemInput,
            saveNewItem,
            showNewLinkInput,
            saveNewLink,
            removeInlineForm,
            showTextEditInput,
            saveEditedText,
            saveCurrentDataAsTemplate,
            showHeaderEditInput,
            saveEditedHeader,
            deleteListItem,
            addNewAspectRow
        });
    </script>
</body>
</html>
