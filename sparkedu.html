<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkEdu - Pengurusan Kurikulum Pendidikan</title>
    <!-- Muatkan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muatkan Font Poppins (dari semak.html) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Muatkan Font Inter (dari pengurusan.html untuk konten utama) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Gaya dari semak.html untuk Header/Footer */
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Gaya dari pengurusan.html untuk Konten Utama */
        #kurikulum-content { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .data-table {
            min-width: 1200px;
            width: 100%;
        }
        .data-cell {
            vertical-align: top;
            padding: 8px 12px;
            text-align: left;
        }
        .score-cell {
            text-align: center;
            width: 70px;
        }
        .score-input {
            width: 100%;
            text-align: center;
            padding: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
        }
        .score-input:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        /* Custom styles for list rendering */
        .list-decimal.ml-4 > li {
            list-style: decimal;
        }
        .list-decimal.ml-4 > li:not(.ml-6) {
            margin-left: 1.5rem; /* For the number spacing */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- ================================== -->
    <!-- START: HEADER dari semak.html (DIUBAH) -->
    <!-- ================================== -->
    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <!-- Tukar SPARK ke SparkEdu -->
                <div><h1 class="text-2xl font-bold text-indigo-600">SparkEdu</h1><p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p></div>
            </div>
            <!-- Buang butang Halaman Utama dan Lihat Senarai Program -->
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 <!-- Butang dibuang -->
            </div>
        </div>
    </header>
    <!-- ================================== -->
    <!-- END: HEADER dari semak.html -->
    <!-- ================================== -->

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <!-- NEW: IC Validation Section (Default: Visible) -->
        <div id="ic-validation-section" class="max-w-lg mx-auto p-8 bg-white shadow-lg rounded-xl mt-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Pengesahan Akses</h2>
            <p class="text-gray-600 mb-6">Sila masukkan No. Kad Pengenalan anda untuk mengakses panel Pengurusan Kurikulum.</p>
            
            <div>
                <label for="applicant-ic" class="block text-sm font-medium text-gray-700 mb-2">No. IC (12 Digit)</label>
                <div class="relative">
                    <input type="text" id="applicant-ic" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12)" required placeholder="e.g., 900101131234" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button onclick="validateIC()" class="mt-4 w-full btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Sahkan & Akses
                </button>
                <p id="ic-error-message" class="text-red-600 text-sm mt-3 hidden text-center"></p>
            </div>
        </div>
        
        <div id="kurikulum-content" class="p-4 md:p-8 hidden">
            <!-- ================================== -->
            <!-- START: KANDUNGAN dari pengurusan.html -->
            <!-- ================================== -->
            <div class="max-w-7xl mx-auto">
                <header class="mb-6 pb-4 border-b border-blue-200">
                    <!-- ID BARU UNTUK TAJUK UTAMA -->
                    <h1 class="text-3xl font-extrabold text-blue-800" id="main-title">Standard 3.1: Pengurusan Kurikulum (2025)</h1>
                    <p id="auth-status" class="text-sm text-gray-600 mt-1">Status Pengguna: Memuatkan...</p>
                </header>

                <div id="loading-spinner" class="text-center p-8 text-blue-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Memuatkan data...</p>
                </div>

                <div class="scroll-container bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="data-table border-collapse" id="kurikulum-table">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="p-3 border-r border-blue-500 w-1/4">Aspek & Keterangan</th>
                                <th class="p-3 score-cell border-r border-blue-500">2022</th>
                                <th class="p-3 score-cell border-r border-blue-500">2023</th>
                                <th class="p-3 score-cell border-r border-blue-500">2024 (TOV)</th>
                                <th class="p-3 score-cell border-r border-blue-500">2025 (ETR)</th>
                                <th class="p-3 border-r border-blue-500 w-1/4">Tindakan</th>
                                <th class="p-3 w-1/4">Follow Up / Pendokumentasian</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                        <!-- Footer untuk Peratus Skor -->
                        <tfoot id="table-footer">
                            <!-- Data purata akan dimasukkan di sini -->
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- MODAL UNTUK TAMBAH ITEM/PAUTAN BARU (disertakan dari pengurusan.html) -->
            <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden z-50 transition-opacity duration-300"></div>

            <div id="action-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-700 mb-4" id="modal-title">Tambah Item Baru</h3>
                        <div id="new-item-form">
                            <label for="item-text" class="block text-sm font-medium text-gray-700">Perkara (Tindakan/Follow Up):</label>
                            <textarea id="item-text" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                            <button id="save-item-btn" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Simpan Item</button>
                        </div>
                        <div id="new-link-form" class="hidden">
                            <label for="link-name" class="block text-sm font-medium text-gray-700">Nama Pautan:</label>
                            <input type="text" id="link-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border mb-3">
                            <label for="link-url" class="block text-sm font-medium text-gray-700">URL Pautan (Mesti bermula dengan http/https):</label>
                            <input type="url" id="link-url" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <button id="save-link-btn" class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">Simpan Pautan</button>
                        </div>
                        <button onclick="closeModal()" class="mt-4 w-full px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">Tutup</button>
                    </div>
                </div>
            </div>
            <!-- ================================== -->
            <!-- END: KANDUNGAN dari pengurusan.html -->
            <!-- ================================== -->
        </div>
    </main>

    <!-- ================================== -->
    <!-- START: FOOTER dari semak.html -->
    <!-- ================================== -->
    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Dibangunkan oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500">Versi 2.4 (2025) - Kurikulum</p>
    </footer>
    <!-- ================================== -->
    <!-- END: FOOTER dari semak.html -->
    <!-- ================================== -->


    <!-- Skrip Firebase dan Logik Aplikasi (disalin sepenuhnya dari pengurusan.html) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, runTransaction, arrayUnion, setLogLevel, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Menggunakan nilai statik dari semak.html untuk konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; 

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Path Collection
        const COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_data`;
        const PARTICIPANTS_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_participants`;
        let currentApplicant = null; // Global untuk simpan data pemohon

        // Fungsi pembantu untuk memetakan senarai string ke objek array untuk konsistensi
        const mapList = (list) => {
            return list.map(item => ({
                id: Math.random().toString(36).substring(2),
                text: item.trim(),
                links: []
            }));
        };

        // Data Awal dari dokumen Standard_3.1 Kurikulum PPD Miri.docx (100% Fidelity)
        const initialData = [
            {
                id: '311',
                aspek: "3.1.1: KETETAPAN PELAKSANAAN KURIKULUM",
                description: "3.1.1.1 Pelaksanaan kurikulum diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 100.00, score_2024_tov: 93.75, score_2025_etr: 94.00,
                // Tindakan (Numbered points 1-4 + main point)
                tindakan_list: mapList([
                    "Mematuhi arahan yang berkuatkuasa",
                    "Menyeluruh - penubuhan panitia MP, peruntukan kewangan, pentaksiran, penjaminan kualiti (4P), latihan/ tugasan, pembelajaran digital, PdPR/remote learning, sumber pendidikan dan jadual waktu",
                    "Mengikut keperluan sekolah",
                    "Secara spesifik dan jelas"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Perancangan Strategik Kurikulum/Pelan Operasi/PInTaS Kualiti Guru (Standard 4)",
                    "OPPM Kurikulum",
                    "Profil Akademik Sekolah",
                    "Buku Pengurusan Sekolah",
                    "Minit Mesyuarat Pengurusan Kurikulum",
                    "Jadual Waktu Persekolahan",
                    "Takwim Peperiksaan dan Pentaksiran",
                    "Papan Kenyataan Unit Kurikulum",
                    "Laporan Dialog Prestasi Kurikulum",
                    "Telegram Ketua Panitia"
                ])
            },
            {
                id: '3121',
                aspek: "3.1.2: PENGURUSAN MATA PELAJARAN",
                description: "3.1.2.1 Pelaksanaan mata pelajaran diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 93.15, score_2024_tov: 92.98, score_2025_etr: 93.00,
                // Tindakan (Numbered points 1-6)
                tindakan_list: mapList([
                    "Menyelaras penyediaan RPT dan RPH",
                    "Menyelaras pentaksiran",
                    "Menyelaras tugasan murid",
                    "Menganalisis data dan maklumat pentaksiran",
                    "Berdasarkan keperluan pelaksanaan kurikulum",
                    "Secara menyeluruh meliputi semua tahun/ tingkatan"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Minit Mesyuarat Panitia",
                    "Dokumen Standard Kurikulum Prestasi",
                    "Jadual Peperiksaan / Pentaksiran",
                    "Analisis Pentaksiran dan Penilaian",
                    "Laporan Dialog Prestasi Panitia /maklumbalas Pera",
                    "Borang Semakan Tugasan Murid",
                    "Standard Kecukupan Latihan"
                ])
            },
            {
                id: '3122',
                aspek: "3.1.2.2 Program peningkatan kualiti pengajaran guru diurus secara terancang",
                description: "",
                score_2022: 0.00, score_2023: 88.25, score_2024_tov: 92.04, score_2025_etr: 93.00,
                // Tindakan (Numbered points 1-3)
                tindakan_list: mapList([
                    "Merancang dan melaksanakan program pembangunan profesionalisme yang berkaitan dengan mata pelajaran",
                    "Berfokus kepada keperluan guru/ panitia",
                    "Mengambil kira perkembangan pendidikan semasa dari semasa ke semasa"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Buku Pengurusan Sekolah",
                    "Minit Mesyuarat Panitia",
                    "Takwim CPD Mata Pelajaran",
                    "OPPM Panitia",
                    "OPR Program Panitia",
                    "Laporan PLC Panitia / SPLKPM"
                ])
            },
            {
                id: '3123',
                aspek: "3.1.2.3 Program peningkatan pencapaian murid diurus secara profesional dan terancang",
                description: "",
                score_2022: 0.00, score_2023: 87.75, score_2024_tov: 90.62, score_2025_etr: 91.00,
                // Tindakan (Numbered points 1-4)
                tindakan_list: mapList([
                    "Merancang dan melaksanakan program yang menjurus ke arah peningkatan ilmu dan kemahiran",
                    "Berfokus kepada keperluan murid",
                    "Mengambil kira tahap keupayaan dan potensi murid",
                    "Melibatkan murid di semua tahun/ tingkatan dari semasa ke semasa"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Minit Mesyuarat Panitia",
                    "Kertas Kerja Program Kecemerlangan Murid",
                    "OPR Program Kecemerlangan Murid",
                    "Laporan / Analisis PBD Pertengahan Tahun",
                    "Dialog Prestasi Panitia",
                    "Laporan program intervensi"
                ])
            },
            {
                id: '3124',
                aspek: "3.1.2.4. Bantuan geran perkapita mata pelajaran dimanfaatkan secara sistematik dan terancang",
                description: "",
                score_2022: 0.00, score_2023: 93.50, score_2024_tov: 93.46, score_2025_etr: 94.00,
                // Tindakan (Numbered points 1-6)
                tindakan_list: mapList([
                    "Merancang dan melaksanakan perbelanjaan",
                    "Memanfaatkan sumber pendidikan",
                    "Merekod penerimaan dan penggunaan sumber pendidikan",
                    "Mengikut prosedur yang ditetapkan",
                    "Mengikut keperluan",
                    "Secara menyeluruh dari semasa ke semasa"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Minit Mesyuarat Panitia",
                    "Anggaran Perbelanjaan Panitia",
                    "Laporan Kewangan Panitia",
                    "Rekod Pinjaman & Penggunaan Peralatan"
                ])
            },
            {
                id: '313',
                aspek: "3.1.3: PENGURUSAN MASA INSTRUKSIONAL",
                description: "3.1.3.1 Masa pelaksanaan PdP diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 100.00, score_2024_tov: 100.00, score_2025_etr: 100.00,
                // Tindakan (Numbered points 1-7)
                tindakan_list: mapList([
                    "Menyediakan JW induk, JW kelas, JW guru, JW guru ganti dan JW penggunaan bilik khas",
                    "Melaksanakan PdP seperti yang dijadualkan",
                    "Menyusun semula JW",
                    "Menyelaras program sekolah",
                    "Mematuhi arahan yang berkuatkuasa",
                    "Mengikut ketetapan kurikulum",
                    "Mengikut kesesuaian"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Minit mesyuarat kurikulum",
                    "Jadual Waktu PdPc - Induk / Kelas / Guru / Bilik Khas",
                    "Rekod Jadual Guru Ganti",
                    "Rekod Penggunaan Bilik Khas",
                    "Laporan Learning Walk",
                    "Takwim Pengurusan Sekolah/OPPM"
                ])
            },
            {
                id: '314',
                aspek: "3.1.4: PENGURUSAN PENILAIAN MURID",
                description: "3.1.4.1 Peperiksaan dan pentaksiran diurus secara sistematik dan terancang",
                score_2022: 0.00, score_2023: 95.00, score_2024_tov: 95.00, score_2025_etr: 100.00,
                // Tindakan (Numbered points 1-6)
                tindakan_list: mapList([
                    "Merancang, menyelaras dan melaksanakan peperiksaan dan pentaksiran",
                    "Menganalisis data dan maklumat peperiksaan dan pentaksiran",
                    "Mengambil tindakan susulan/ intervensi",
                    "Mengikut arahan yang berkuatkuasa",
                    "Mengikut keperluan",
                    "Secara menyeluruh meliputi semua mata pelajaran dan murid dari semasa ke semasa"
                ]),
                // Follow Up (Arrow points)
                follow_up_list: mapList([
                    "Minit Mesyuarat Pengurusan Kurikulum",
                    "Takwim/Jadual Peperiksaan dan Pentaksiran Sekolah",
                    "Analisis Data Peperiksaan dan Pentaksiran Sekolah",
                    "Dialog Prestasi",
                    "Laporan Penjaminan Kualiti PBD",
                    "Program Intervensi"
                ])
            }
        ];

        // --- FIREBASE SETUP AND AUTHENTICATION ---
        try {
            // setLogLevel('debug'); // Uncomment for debugging
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication process
            const signIn = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            // Trigger sign in if not already signed in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Hide loading spinner and show IC input form
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('ic-validation-section').classList.remove('hidden');
                    document.getElementById('auth-status').textContent = `Status Pengguna: ID Sesi Aktif (${userId})`;
                } else if (!auth.currentUser) {
                    await signIn();
                }
            });

        } catch (error) {
            console.error("Ralat ketika memulakan Firebase atau Pengesahan:", error);
            document.getElementById('auth-status').textContent = 'Ralat Pengesahan Firebase. Sila semak konsol.';
            document.getElementById('loading-spinner').classList.add('hidden');
        }
        
        // --- IC VALIDATION LOGIC ---
        async function validateIC() {
            if (!isAuthReady) {
                // Gunakan console.error dan custom UI jika ini adalah aplikasi sebenar
                console.error("Sistem sedang memuatkan. Sila tunggu sebentar.");
                return;
            }
            
            const icInput = document.getElementById('applicant-ic');
            const ic = icInput.value.replace(/[^0-9]/g, '');
            const errorEl = document.getElementById('ic-error-message');
            const submitButton = document.querySelector('#ic-validation-section button');
            
            errorEl.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyemak...';

            if (ic.length !== 12) {
                errorEl.textContent = "Sila masukkan 12 digit No. IC yang sah.";
                errorEl.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
                return;
            }
            
            try {
                const participantsRef = collection(db, PARTICIPANTS_COLLECTION_PATH);
                const q = query(participantsRef, where("ic", "==", ic));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    currentApplicant = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    
                    // START: UPDATE LOGIK BERDASARKAN PERMINTAAN PENGGUNA
                    const stationName = currentApplicant.station || "SMK Miri (Tiada Stesen)";
                    const titleElement = document.getElementById('main-title');
                    titleElement.textContent = `Standard 3.1: Pengurusan Kurikulum ${stationName} (2025)`;
                    // END: UPDATE LOGIK BERDASARKAN PERMINTAAN PENGGUNA
                    
                    // Success: Hide IC section, show content, initialize data listener
                    document.getElementById('ic-validation-section').classList.add('hidden');
                    document.getElementById('kurikulum-content').classList.remove('hidden');
                    document.getElementById('auth-status').textContent += ` | Disahkan: ${currentApplicant.name}`;
                    
                    // Start the main data loading
                    initializeDataAndListener(); 
                    
                } else {
                    errorEl.textContent = "No. IC tidak dijumpai dalam rekod SPARK. Sila hubungi pentadbir.";
                    errorEl.classList.remove('hidden');
                }
                
            } catch(error) {
                console.error("Error validating IC:", error);
                errorEl.textContent = "Gagal menghubungi pangkalan data. Semak Firebase Rules.";
                errorEl.classList.remove('hidden');
            }

            submitButton.disabled = false;
            submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
        }

        // --- DATA MANAGEMENT ---
        
        // Fungsi untuk mengemaskini skor ke Firestore
        async function updateScore(docId, fieldName, value) {
            // Penukaran nilai input kepada nombor perpuluhan
            const numericValue = parseFloat(value);
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 100) {
                console.error("Nilai skor tidak sah.");
                return;
            }

            try {
                const docRef = doc(db, COLLECTION_PATH, docId);
                await updateDoc(docRef, {
                    [fieldName]: numericValue
                });
                console.log(`Skor ${fieldName} untuk dokumen ${docId} berjaya dikemaskini.`);
            } catch (e) {
                console.error(`Ralat mengemaskini skor ${fieldName} untuk ${docId}:`, e);
                // Gantikan alert dengan UI custom jika ini adalah aplikasi sebenar
                alert(`Gagal kemaskini skor. Sila semak konsol.`); 
            }
        }

        async function seedInitialData() {
            console.log("Memuatkan data awal ke Firestore...");
            const batchPromises = initialData.map(data => {
                const docRef = doc(db, COLLECTION_PATH, data.id);
                const dataToSet = {
                    ...data,
                    // Pastikan ID untuk list items dijana semula
                    tindakan_list: data.tindakan_list.map(item => ({...item, id: Math.random().toString(36).substring(2)})),
                    follow_up_list: data.follow_up_list.map(item => ({...item, id: Math.random().toString(36).substring(2)}))
                };
                return setDoc(docRef, dataToSet);
            });
            await Promise.all(batchPromises);
            console.log("Data awal berjaya dimuatkan.");
        }

        async function initializeDataAndListener() {
            // Show the specific content loading spinner
            document.querySelector('#kurikulum-content #loading-spinner').classList.remove('hidden'); 

            try {
                // Dapatkan semua dokumen dalam koleksi untuk menyemak kuantiti
                const qAll = query(collection(db, COLLECTION_PATH));
                const snapshotAll = await getDocs(qAll);

                // Jika bilangan dokumen tidak sepadan, atau tiada dokumen, jalankan seeding semula.
                if (snapshotAll.docs.length !== initialData.length) {
                    console.warn(`Data tidak lengkap (${snapshotAll.docs.length}/${initialData.length}). Menjalankan seeding semula.`);
                    await seedInitialData();
                }

                // Sediakan pendengar masa nyata (onSnapshot)
                const q = query(collection(db, COLLECTION_PATH));
                onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Pengisihan mengikut ID adalah penting
                    data.sort((a, b) => a.id.localeCompare(b.id)); 
                    
                    renderTable(data);
                    document.querySelector('#kurikulum-content #loading-spinner').classList.add('hidden');
                }, (error) => {
                    console.error("Ralat onSnapshot:", error);
                    document.querySelector('#kurikulum-content #loading-spinner').innerHTML = `<p class="text-red-600">Ralat memuatkan data secara langsung. Sila semak konsol.</p>`;
                });

            } catch (e) {
                console.error("Ralat dalam data init/listener:", e);
                document.querySelector('#kurikulum-content #loading-spinner').innerHTML = `<p class="text-red-600">Ralat memuatkan data. Sila semak sambungan.</p>`;
            }
        }

        // --- RENDERING FUNCTIONS (DIKEMASKINI UNTUK LIST STYLE 100% FIDELITY) ---

        function renderList(list, docId, fieldName) {
            const isTindakan = fieldName === 'tindakan_list';
            const ListTag = isTindakan ? 'ol' : 'ul'; 

            const listItemsHtml = list.map((item, index) => {
                let contentHtml = '';

                if (isTindakan) {
                    // For Tindakan, use the list item number (which will be automatically generated by <ol>)
                    contentHtml = `<p class="text-sm text-gray-800 font-medium">${item.text}</p>`;
                } else {
                    // For Follow Up, use the custom arrow bullet (➤)
                    contentHtml = `<p class="text-sm text-gray-800 font-medium"><span class="text-blue-600 font-bold pr-2">➤</span>${item.text}</p>`;
                }
                
                // Common interactive elements and links structure
                const interactionHtml = `
                    ${item.links && item.links.length > 0 ? `
                        <div class="mt-1 flex flex-wrap gap-2 text-xs">
                            ${item.links.map(link => `
                                <a href="${link.url}" target="_blank" class="flex items-center text-blue-600 hover:text-blue-800 transition duration-150">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                                    ${link.name}
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition"
                            onclick="openLinkModal('${docId}', '${fieldName}', '${item.id}')">
                        + Tambah Pautan
                    </button>
                `;

                // Set classes for the <li> element: ml-6 for <ol> to accommodate numbering
                const liClasses = `mb-2 p-2 border border-gray-100 rounded-lg bg-gray-50 break-words ${isTindakan ? 'ml-6' : ''}`;

                return `<li class="${liClasses}">
                    ${contentHtml}
                    ${interactionHtml}
                </li>`;

            }).join('');

            // Apply custom CSS for numbered list (Tindakan)
            const listStyle = isTindakan ? 'list-decimal ml-4' : 'list-none';
            
            return `
                <${ListTag} class="p-0 m-0 ${listStyle}">
                    ${listItemsHtml}
                </${ListTag}>
            `;
        }
        
        // Fungsi untuk menjana input skor - DIUBAH DI SINI
        function generateScoreInput(docId, fieldName, score) {
            const displayScore = score.toFixed(2); // Pastikan 2 titik perpuluhan dipaparkan
            const isETR = fieldName === 'score_2025_etr';
            
            // Standardize color to text-gray-700 (sama seperti 2022)
            const colorClass = 'text-gray-700'; 
            
            // ETR kekal bold, yang lain tidak
            const boldnessClass = isETR ? 'font-bold' : ''; 
            
            return `
                <input type="number" 
                       step="0.01" 
                       min="0" 
                       max="100"
                       value="${displayScore}" 
                       class="score-input ${colorClass} font-mono text-sm ${boldnessClass}"
                       onchange="updateScore('${docId}', '${fieldName}', this.value)"
                       onblur="this.value = parseFloat(this.value).toFixed(2)"
                />
            `;
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            
            // 1. Render Body
            tbody.innerHTML = data.map(row => `
                <tr class="border-b hover:bg-gray-50 transition duration-100">
                    <td class="data-cell border-r border-gray-200">
                        <p class="font-semibold text-gray-900">${row.aspek}</p>
                        <p class="text-sm text-gray-600 mt-1">${row.description}</p>
                    </td>
                    <!-- Skor 2022 -->
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2022', row.score_2022 || 0)}
                    </td>
                    <!-- Skor 2023 -->
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2023', row.score_2023 || 0)}
                    </td>
                    <!-- Skor 2024 (TOV) -->
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2024_tov', row.score_2024_tov || 0)}
                    </td>
                    <!-- Skor 2025 (ETR) -->
                    <td class="data-cell score-cell border-r border-gray-200">
                        ${generateScoreInput(row.id, 'score_2025_etr', row.score_2025_etr || 0)}
                    </td>
                    
                    <!-- Tindakan Column -->
                    <td class="data-cell border-r border-gray-200">
                        ${renderList(row.tindakan_list, row.id, 'tindakan_list')}
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="openItemModal('${row.id}', 'tindakan_list')">
                            + Tambah Tindakan
                        </button>
                    </td>

                    <!-- Follow Up Column -->
                    <td class="data-cell">
                        ${renderList(row.follow_up_list, row.id, 'follow_up_list')}
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="openItemModal('${row.id}', 'follow_up_list')">
                            + Tambah Follow Up
                        </button>
                    </td>
                </tr>
            `).join('');

            // 2. Render Footer (Peratus Skor)
            
            const count = data.length;
            if (count > 0) {
                // Kira Purata Skor untuk setiap tahun
                const total_2022 = data.reduce((sum, row) => sum + (row.score_2022 || 0), 0);
                const total_2023 = data.reduce((sum, row) => sum + (row.score_2023 || 0), 0);
                const total_2024 = data.reduce((sum, row) => sum + (row.score_2024_tov || 0), 0);
                const total_2025 = data.reduce((sum, row) => sum + (row.score_2025_etr || 0), 0);
                
                const avg_2022 = (total_2022 / count).toFixed(2);
                const avg_2023 = (total_2023 / count).toFixed(2);
                const avg_2024 = (total_2024 / count).toFixed(2);
                const avg_2025 = (total_2025 / count).toFixed(2);
                
                tfoot.innerHTML = `
                    <tr class="bg-blue-100 text-blue-900 font-extrabold border-t-4 border-blue-600">
                        <td class="data-cell p-3">PERATUS SKOR KESELURUHAN</td>
                        <td class="score-cell p-3 font-mono">${avg_2022}</td>
                        <td class="score-cell p-3 font-mono">${avg_2023}</td>
                        <td class="score-cell p-3 font-mono">${avg_2024}</td>
                        <td class="score-cell p-3 font-mono">${avg_2025}</td>
                        <td class="data-cell border-r border-blue-300 p-3" colspan="2"></td>
                    </tr>
                `;
            } else {
                 tfoot.innerHTML = '';
            }
        }


        // --- MODAL & ACTION HANDLERS (TIDAK BERUBAH) ---

        let currentDocId = null;
        let currentField = null; 
        let currentItemId = null; 

        window.openItemModal = (docId, fieldName) => {
            currentDocId = docId;
            currentField = fieldName;
            currentItemId = null; 

            document.getElementById('modal-title').textContent = fieldName === 'tindakan_list' ? 'Tambah Item Tindakan Baru' : 'Tambah Item Follow Up/Pendokumentasian Baru';
            document.getElementById('new-item-form').classList.remove('hidden');
            document.getElementById('new-link-form').classList.add('hidden');
            document.getElementById('item-text').value = '';

            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('action-modal').classList.remove('hidden');
        };

        window.openLinkModal = (docId, fieldName, itemId) => {
            currentDocId = docId;
            currentField = fieldName;
            currentItemId = itemId;

            document.getElementById('modal-title').textContent = 'Tambah Pautan (Link)';
            document.getElementById('new-item-form').classList.add('hidden');
            document.getElementById('new-link-form').classList.remove('hidden');
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = 'https://';

            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('action-modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('action-modal').classList.add('hidden');
            currentDocId = null;
            currentField = null;
            currentItemId = null;
        };

        document.getElementById('modal-backdrop').addEventListener('click', closeModal);

        // Handler for adding a new list item (Tindakan/Follow Up)
        document.getElementById('save-item-btn').addEventListener('click', async () => {
            if (!currentDocId || !currentField) return;

            const text = document.getElementById('item-text').value.trim();
            if (!text) {
                console.error("Sila masukkan teks untuk item baru.");
                return;
            }

            const newItem = {
                id: Math.random().toString(36).substring(2),
                text: text,
                links: []
            };

            try {
                const docRef = doc(db, COLLECTION_PATH, currentDocId);
                await updateDoc(docRef, {
                    [currentField]: arrayUnion(newItem)
                });
                console.log("Item baru berjaya ditambah!");
                closeModal();
            } catch (e) {
                console.error("Ralat menambah item baru:", e);
                console.error("Gagal menambah item. Sila semak konsol.");
            }
        });

        // Handler for adding a new link to an existing item
        document.getElementById('save-link-btn').addEventListener('click', async () => {
            if (!currentDocId || !currentField || !currentItemId) return;

            const linkName = document.getElementById('link-name').value.trim();
            const linkUrl = document.getElementById('link-url').value.trim();

            if (!linkName || !linkUrl || !linkUrl.startsWith('http')) {
                console.error("Nama atau URL pautan tidak sah.");
                return;
            }

            const newLink = { name: linkName, url: linkUrl };

            try {
                const docRef = doc(db, COLLECTION_PATH, currentDocId);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) {
                        throw "Dokumen tidak wujud!";
                    }

                    const data = docSnap.data();
                    const list = data[currentField];
                    const itemIndex = list.findIndex(item => item.id === currentItemId);

                    if (itemIndex > -1) {
                        if (!list[itemIndex].links) {
                            list[itemIndex].links = [];
                        }
                        list[itemIndex].links.push(newLink);

                        transaction.update(docRef, { [currentField]: list });
                        console.log("Pautan baru berjaya ditambah!");
                    } else {
                        throw "Item ID tidak dijumpai dalam senarai.";
                    }
                });

                closeModal();
            } catch (e) {
                console.error("Ralat menambah pautan baru:", e);
                console.error("Gagal menambah pautan. Sila semak konsol.");
            }
        });
        
        // PENTING: Mendedahkan fungsi ke window untuk diakses oleh onclick di HTML
        Object.assign(window, {
            openItemModal,
            openLinkModal,
            closeModal,
            validateIC,
            updateScore // Tambah fungsi updateScore
        });
    </script>
</body>
</html>
