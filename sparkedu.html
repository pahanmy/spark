<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK - Pengurusan Kurikulum Pendidikan</title>
    <!-- Muatkan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muatkan Font Poppins (dari semak.html) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Muatkan Font Inter (dari pengurusan.html untuk konten utama) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Gaya dari semak.html untuk Header/Footer */
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Gaya dari pengurusan.html untuk Konten Utama */
        #kurikulum-content { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .data-table {
            min-width: 1200px;
            width: 100%;
        }
        .data-cell {
            vertical-align: top;
            padding: 8px 12px;
            text-align: left;
        }
        .score-cell {
            text-align: center;
            width: 70px;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- ================================== -->
    <!-- START: HEADER dari semak.html -->
    <!-- ================================== -->
    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div><h1 class="text-2xl font-bold text-indigo-600">SPARK</h1><p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p></div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 <button onclick="window.location.href='index.html'" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>Halaman Utama</button>
                 <button onclick="window.location.href='senarai.html'" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>Lihat Senarai Program</button>
            </div>
        </div>
    </header>
    <!-- ================================== -->
    <!-- END: HEADER dari semak.html -->
    <!-- ================================== -->

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <!-- NEW: IC Validation Section (Default: Visible) -->
        <div id="ic-validation-section" class="max-w-lg mx-auto p-8 bg-white shadow-lg rounded-xl mt-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Pengesahan Akses</h2>
            <p class="text-gray-600 mb-6">Sila masukkan No. Kad Pengenalan anda untuk mengakses panel Pengurusan Kurikulum.</p>
            
            <div>
                <label for="applicant-ic" class="block text-sm font-medium text-gray-700 mb-2">No. IC (12 Digit)</label>
                <div class="relative">
                    <input type="text" id="applicant-ic" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12)" required placeholder="e.g., 900101131234" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button onclick="validateIC()" class="mt-4 w-full btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Sahkan & Akses
                </button>
                <p id="ic-error-message" class="text-red-600 text-sm mt-3 hidden text-center"></p>
            </div>
        </div>
        
        <div id="kurikulum-content" class="p-4 md:p-8 hidden">
            <!-- ================================== -->
            <!-- START: KANDUNGAN dari pengurusan.html -->
            <!-- ================================== -->
            <div class="max-w-7xl mx-auto">
                <header class="mb-6 pb-4 border-b border-blue-200">
                    <!-- ID BARU UNTUK TAJUK UTAMA -->
                    <h1 class="text-3xl font-extrabold text-blue-800" id="main-title">Standard 3.1: Pengurusan Kurikulum (2025)</h1>
                    <p id="auth-status" class="text-sm text-gray-600 mt-1">Status Pengguna: Memuatkan...</p>
                </header>

                <div id="loading-spinner" class="text-center p-8 text-blue-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Memuatkan data...</p>
                </div>

                <div class="scroll-container bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="data-table border-collapse" id="kurikulum-table">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="p-3 border-r border-blue-500 w-1/4">Aspek & Keterangan</th>
                                <th class="p-3 score-cell border-r border-blue-500">2023</th>
                                <th class="p-3 score-cell border-r border-blue-500">2024 (TOV)</th>
                                <th class="p-3 score-cell border-r border-blue-500">2025 (ETR)</th>
                                <th class="p-3 border-r border-blue-500 w-1/4">Tindakan</th>
                                <th class="p-3 w-1/4">Follow Up / Pendokumentasian</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- MODAL UNTUK TAMBAH ITEM/PAUTAN BARU (disertakan dari pengurusan.html) -->
            <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden z-50 transition-opacity duration-300"></div>

            <div id="action-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-700 mb-4" id="modal-title">Tambah Item Baru</h3>
                        <div id="new-item-form">
                            <label for="item-text" class="block text-sm font-medium text-gray-700">Perkara (Tindakan/Follow Up):</label>
                            <textarea id="item-text" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                            <button id="save-item-btn" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Simpan Item</button>
                        </div>
                        <div id="new-link-form" class="hidden">
                            <label for="link-name" class="block text-sm font-medium text-gray-700">Nama Pautan:</label>
                            <input type="text" id="link-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border mb-3">
                            <label for="link-url" class="block text-sm font-medium text-gray-700">URL Pautan (Mesti bermula dengan http/https):</label>
                            <input type="url" id="link-url" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <button id="save-link-btn" class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">Simpan Pautan</button>
                        </div>
                        <button onclick="closeModal()" class="mt-4 w-full px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">Tutup</button>
                    </div>
                </div>
            </div>
            <!-- ================================== -->
            <!-- END: KANDUNGAN dari pengurusan.html -->
            <!-- ================================== -->
        </div>
    </main>

    <!-- ================================== -->
    <!-- START: FOOTER dari semak.html -->
    <!-- ================================== -->
    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Dibangunkan oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500">Versi 2.4 (2025) - Kurikulum</p>
    </footer>
    <!-- ================================== -->
    <!-- END: FOOTER dari semak.html -->
    <!-- ================================== -->


    <!-- Skrip Firebase dan Logik Aplikasi (disalin sepenuhnya dari pengurusan.html) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, runTransaction, arrayUnion, setLogLevel, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Menggunakan nilai statik dari semak.html untuk konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; 

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Path Collection
        const COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_data`;
        const PARTICIPANTS_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_participants`;
        let currentApplicant = null; // Global untuk simpan data pemohon

        // Data Awal untuk Seeding (Sama seperti pengurusan.html)
        const initialData = [
            {
                id: '311',
                aspek: "3.1.1: KETETAPAN PELAKSANAAN KURIKULUM",
                description: "3.1.1.1 Pelaksanaan kurikulum diurus secara sistematik dan terancang",
                score_2023: 100.00, score_2024_tov: 93.75, score_2025_etr: 94.00,
                tindakan_list: [{ id: Math.random().toString(36).substring(2), text: "Mematuhi arahan yang berkuatkuasa", links: [] }],
                follow_up_list: [
                    { id: Math.random().toString(36).substring(2), text: "Menyeluruh - penubuhan panitia MP, peruntukan kewangan, pentaksiran, penjaminan kualiti (4P), latihan/ tugasan, pembelajaran digital, PdPR/ remote learning, sumber pendidikan dan jadual waktu. Mengikut keperluan sekolah. Secara spesifik dan jelas.", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Perancangan Strategik Kurikulum/Pelan Operasi/PInTaS Kualiti Guru (Standard 4), OPPM Kurikulum, Profil Akademik Sekolah, Buku Pengurusan Sekolah, Minit Mesyuarat Pengurusan Kurikulum, Jadual Waktu Persekolahan, Takwim Peperiksaan dan Pentaksiran, Papan Kenyataan Unit Kurikulum, Laporan Dialog Prestasi Kurikulum, Telegram Ketua Panitia.", links: [] }
                ]
            },
            {
                id: '3121',
                aspek: "3.1.2: PENGURUSAN MATA PELAJARAN",
                description: "3.1.2.1 Pelaksanaan mata pelajaran diurus secara sistematik dan terancang",
                score_2023: 93.15, score_2024_tov: 92.98, score_2025_etr: 93.00,
                tindakan_list: [
                    { id: Math.random().toString(36).substring(2), text: "Menyelaras penyediaan RPT dan RPH", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Menyelaras pentaksiran", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Menyelaras tugasan murid", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Menganalisis data dan maklumat pentaksiran", links: [] }
                ],
                follow_up_list: [
                    { id: Math.random().toString(36).substring(2), text: "Berdasarkan keperluan pelaksanaan kurikulum. Secara menyeluruh meliputi semua tahun/ tingkatan.", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Minit Mesyuarat Panitia, Dokumen Standard Kurikulum Prestasi, Jadual Peperiksaan / Pentaksiran, Analisis Pentaksiran dan Penilaian, Laporan Dialog Prestasi Panitia / maklumbalasPera, Borang Semakan Tugasan Murid, Standard Kecukupan Latihan.", links: [] }
                ]
            },
            {
                id: '3122',
                aspek: "3.1.2.2 Program peningkatan kualiti pengajaran guru diurus secara terancang",
                description: "",
                score_2023: 88.25, score_2024_tov: 92.04, score_2025_etr: 93.00,
                tindakan_list: [
                    { id: Math.random().toString(36).substring(2), text: "Merancang dan melaksanakan program pembangunan profesionalisme yang berkaitan dengan mata pelajaran", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Berfokus kepada keperluan guru/ panitia", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Mengambil kira perkembangan pendidikan semasa dari semasa ke semasa", links: [] }
                ],
                follow_up_list: [
                    { id: Math.random().toString(36).substring(2), text: "Buku Pengurusan Sekolah, Minit Mesyuarat Panitia, Takwim CPD Mata Pelajaran, OPPM Panitia, OPR Program Panitia, Laporan PLC Panitia / SPLKPM.", links: [] }
                ]
            },
            {
                id: '314',
                aspek: "3.1.4: PENGURUSAN PENILAIAN MURID",
                description: "3.1.4.1 Peperiksaan dan pentaksiran diurus secara sistematik dan terancang",
                score_2023: 95.00, score_2024_tov: 95.00, score_2025_etr: 100.00,
                tindakan_list: [
                    { id: Math.random().toString(36).substring(2), text: "Merancang, menyelaras dan melaksanakan peperiksaan dan pentaksiran", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Menganalisis data dan maklumat peperiksaan dan pentaksiran", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Mengambil tindakan susulan/ intervensi", links: [] },
                    { id: Math.random().toString(36).substring(2), text: "Mengikut arahan yang berkuatkuasa, Mengikut keperluan, Secara menyeluruh meliputi semua mata pelajaran dan murid dari semasa ke semasa", links: [] }
                ],
                follow_up_list: [
                    { id: Math.random().toString(36).substring(2), text: "Minit Mesyuarat Pengurusan Kurikulum, Takwim / Jadual Peperiksaan dan Pentaksiran Sekolah, Analisis Data Peperiksaan dan Pentaksiran Sekolah, Dialog Prestasi, Laporan Penjaminan Kualiti PBD, Program Intervensi.", links: [] }
                ]
            }
        ];

        // --- FIREBASE SETUP AND AUTHENTICATION ---
        try {
            // setLogLevel('debug'); // Uncomment for debugging
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication process
            const signIn = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            // Trigger sign in if not already signed in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Hide loading spinner and show IC input form
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('ic-validation-section').classList.remove('hidden');
                    document.getElementById('auth-status').textContent = `Status Pengguna: ID Sesi Aktif (${userId})`;
                } else if (!auth.currentUser) {
                    await signIn();
                }
            });

        } catch (error) {
            console.error("Ralat ketika memulakan Firebase atau Pengesahan:", error);
            document.getElementById('auth-status').textContent = 'Ralat Pengesahan Firebase. Sila semak konsol.';
            document.getElementById('loading-spinner').classList.add('hidden');
        }
        
        // --- IC VALIDATION LOGIC ---
        async function validateIC() {
            if (!isAuthReady) {
                // Gunakan console.error dan custom UI jika ini adalah aplikasi sebenar
                console.error("Sistem sedang memuatkan. Sila tunggu sebentar.");
                return;
            }
            
            const icInput = document.getElementById('applicant-ic');
            const ic = icInput.value.replace(/[^0-9]/g, '');
            const errorEl = document.getElementById('ic-error-message');
            const submitButton = document.querySelector('#ic-validation-section button');
            
            errorEl.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyemak...';

            if (ic.length !== 12) {
                errorEl.textContent = "Sila masukkan 12 digit No. IC yang sah.";
                errorEl.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
                return;
            }
            
            try {
                const participantsRef = collection(db, PARTICIPANTS_COLLECTION_PATH);
                const q = query(participantsRef, where("ic", "==", ic));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    currentApplicant = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    
                    // START: UPDATE LOGIK BERDASARKAN PERMINTAAN PENGGUNA
                    const stationName = currentApplicant.station || "SMK Miri (Tiada Stesen)";
                    const titleElement = document.getElementById('main-title');
                    titleElement.textContent = `Standard 3.1: Pengurusan Kurikulum ${stationName} (2025)`;
                    // END: UPDATE LOGIK BERDASARKAN PERMINTAAN PENGGUNA
                    
                    // Success: Hide IC section, show content, initialize data listener
                    document.getElementById('ic-validation-section').classList.add('hidden');
                    document.getElementById('kurikulum-content').classList.remove('hidden');
                    document.getElementById('auth-status').textContent += ` | Disahkan: ${currentApplicant.name}`;
                    
                    // Start the main data loading
                    initializeDataAndListener(); 
                    
                } else {
                    errorEl.textContent = "No. IC tidak dijumpai dalam rekod SPARK. Sila hubungi pentadbir.";
                    errorEl.classList.remove('hidden');
                }
                
            } catch(error) {
                console.error("Error validating IC:", error);
                errorEl.textContent = "Gagal menghubungi pangkalan data. Semak Firebase Rules.";
                errorEl.classList.remove('hidden');
            }

            submitButton.disabled = false;
            submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> Sahkan & Akses';
        }

        // --- DATA MANAGEMENT ---

        async function seedInitialData() {
            console.log("Memuatkan data awal ke Firestore...");
            const batchPromises = initialData.map(data => {
                const docRef = doc(db, COLLECTION_PATH, data.id);
                const dataToSet = {
                    ...data,
                    tindakan_list: data.tindakan_list.map(item => ({...item, id: item.id || Math.random().toString(36).substring(2)})),
                    follow_up_list: data.follow_up_list.map(item => ({...item, id: item.id || Math.random().toString(36).substring(2)}))
                };
                return setDoc(docRef, dataToSet);
            });
            await Promise.all(batchPromises);
            console.log("Data awal berjaya dimuatkan.");
        }

        async function initializeDataAndListener() {
            // Show the specific content loading spinner
            document.querySelector('#kurikulum-content #loading-spinner').classList.remove('hidden'); 

            try {
                // Cuba untuk mendapatkan satu dokumen untuk semak kewujudan koleksi
                const docRef = doc(db, COLLECTION_PATH, initialData[0].id);
                const docSnap = await runTransaction(db, async (transaction) => {
                    return transaction.get(docRef);
                });

                if (!docSnap.exists()) {
                    await seedInitialData();
                }

                // Sediakan pendengar masa nyata (onSnapshot)
                const q = query(collection(db, COLLECTION_PATH));
                onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    data.sort((a, b) => a.id.localeCompare(b.id)); // Susun ikut ID
                    renderTable(data);
                    document.querySelector('#kurikulum-content #loading-spinner').classList.add('hidden');
                }, (error) => {
                    console.error("Ralat onSnapshot:", error);
                    document.querySelector('#kurikulum-content #loading-spinner').innerHTML = `<p class="text-red-600">Ralat memuatkan data secara langsung. Sila semak konsol.</p>`;
                });

            } catch (e) {
                console.error("Ralat dalam data init/listener:", e);
                document.querySelector('#kurikulum-content #loading-spinner').innerHTML = `<p class="text-red-600">Ralat memuatkan data. Sila semak sambungan.</p>`;
            }
        }

        // --- RENDERING FUNCTIONS (TIDAK BERUBAH) ---

        function renderList(list, docId, fieldName) {
            return list.map((item, index) => `
                <li class="mb-2 p-2 border border-gray-100 rounded-lg bg-gray-50 break-words">
                    <p class="text-sm text-gray-800 font-medium">${item.text}</p>
                    ${item.links && item.links.length > 0 ? `
                        <div class="mt-1 flex flex-wrap gap-2 text-xs">
                            ${item.links.map(link => `
                                <a href="${link.url}" target="_blank" class="flex items-center text-blue-600 hover:text-blue-800 transition duration-150">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                                    ${link.name}
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition"
                            onclick="openLinkModal('${docId}', '${fieldName}', '${item.id}')">
                        + Tambah Pautan
                    </button>
                </li>
            `).join('');
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.map(row => `
                <tr class="border-b hover:bg-gray-50 transition duration-100">
                    <td class="data-cell border-r border-gray-200">
                        <p class="font-semibold text-gray-900">${row.aspek}</p>
                        <p class="text-sm text-gray-600 mt-1">${row.description}</p>
                    </td>
                    <td class="data-cell score-cell border-r border-gray-200 text-sm font-mono text-gray-700">${row.score_2023.toFixed(2)}</td>
                    <td class="data-cell score-cell border-r border-gray-200 text-sm font-mono text-gray-700">${row.score_2024_tov.toFixed(2)}</td>
                    <td class="data-cell score-cell border-r border-gray-200 text-lg font-bold ${row.score_2025_etr >= 95 ? 'text-green-600' : 'text-orange-500'}">${row.score_2025_etr.toFixed(2)}</td>
                    
                    <!-- Tindakan Column -->
                    <td class="data-cell border-r border-gray-200">
                        <ul class="list-none p-0 m-0">
                            ${renderList(row.tindakan_list, row.id, 'tindakan_list')}
                        </ul>
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="openItemModal('${row.id}', 'tindakan_list')">
                            + Tambah Tindakan
                        </button>
                    </td>

                    <!-- Follow Up Column -->
                    <td class="data-cell">
                        <ul class="list-none p-0 m-0">
                            ${renderList(row.follow_up_list, row.id, 'follow_up_list')}
                        </ul>
                        <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                onclick="openItemModal('${row.id}', 'follow_up_list')">
                            + Tambah Follow Up
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // --- MODAL & ACTION HANDLERS (TIDAK BERUBAH) ---

        let currentDocId = null;
        let currentField = null; 
        let currentItemId = null; 

        window.openItemModal = (docId, fieldName) => {
            currentDocId = docId;
            currentField = fieldName;
            currentItemId = null; 

            document.getElementById('modal-title').textContent = fieldName === 'tindakan_list' ? 'Tambah Item Tindakan Baru' : 'Tambah Item Follow Up/Pendokumentasian Baru';
            document.getElementById('new-item-form').classList.remove('hidden');
            document.getElementById('new-link-form').classList.add('hidden');
            document.getElementById('item-text').value = '';

            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('action-modal').classList.remove('hidden');
        };

        window.openLinkModal = (docId, fieldName, itemId) => {
            currentDocId = docId;
            currentField = fieldName;
            currentItemId = itemId;

            document.getElementById('modal-title').textContent = 'Tambah Pautan (Link)';
            document.getElementById('new-item-form').classList.add('hidden');
            document.getElementById('new-link-form').classList.remove('hidden');
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = 'https://';

            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('action-modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('action-modal').classList.add('hidden');
            currentDocId = null;
            currentField = null;
            currentItemId = null;
        };

        document.getElementById('modal-backdrop').addEventListener('click', closeModal);

        // Handler for adding a new list item (Tindakan/Follow Up)
        document.getElementById('save-item-btn').addEventListener('click', async () => {
            if (!currentDocId || !currentField) return;

            const text = document.getElementById('item-text').value.trim();
            if (!text) {
                console.error("Sila masukkan teks untuk item baru.");
                return;
            }

            const newItem = {
                id: Math.random().toString(36).substring(2),
                text: text,
                links: []
            };

            try {
                const docRef = doc(db, COLLECTION_PATH, currentDocId);
                await updateDoc(docRef, {
                    [currentField]: arrayUnion(newItem)
                });
                console.log("Item baru berjaya ditambah!");
                closeModal();
            } catch (e) {
                console.error("Ralat menambah item baru:", e);
                console.error("Gagal menambah item. Sila semak konsol.");
            }
        });

        // Handler for adding a new link to an existing item
        document.getElementById('save-link-btn').addEventListener('click', async () => {
            if (!currentDocId || !currentField || !currentItemId) return;

            const linkName = document.getElementById('link-name').value.trim();
            const linkUrl = document.getElementById('link-url').value.trim();

            if (!linkName || !linkUrl || !linkUrl.startsWith('http')) {
                console.error("Nama atau URL pautan tidak sah.");
                return;
            }

            const newLink = { name: linkName, url: linkUrl };

            try {
                const docRef = doc(db, COLLECTION_PATH, currentDocId);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) {
                        throw "Dokumen tidak wujud!";
                    }

                    const data = docSnap.data();
                    const list = data[currentField];
                    const itemIndex = list.findIndex(item => item.id === currentItemId);

                    if (itemIndex > -1) {
                        if (!list[itemIndex].links) {
                            list[itemIndex].links = [];
                        }
                        list[itemIndex].links.push(newLink);

                        transaction.update(docRef, { [currentField]: list });
                        console.log("Pautan baru berjaya ditambah!");
                    } else {
                        throw "Item ID tidak dijumpai dalam senarai.";
                    }
                });

                closeModal();
            } catch (e) {
                console.error("Ralat menambah pautan baru:", e);
                console.error("Gagal menambah pautan. Sila semak konsol.");
            }
        });
        
        // PENTING: Mendedahkan fungsi ke window untuk diakses oleh onclick di HTML
        Object.assign(window, {
            openItemModal,
            openLinkModal,
            closeModal,
            validateIC
        });
    </script>
</body>
</html>
