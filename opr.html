<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penjana OPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        
        /* A4 Paper Setting */
        .a4-paper {
            width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto;
            background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: Arial, Helvetica, sans-serif; color: black; position: relative;
        }
        
        /* Table Styles */
        .opr-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .opr-table td, .opr-table th { border: 1px solid black; padding: 4px 6px; vertical-align: top; }
        .opr-header { background-color: #f0fdf4; font-weight: bold; text-transform: uppercase; width: 25%; }
        
        /* Image Upload Box */
        .img-upload-box {
            background-color: #ffffff; border: 2px dashed #cbd5e1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; position: relative; height: 100px;
            transition: all 0.3s ease;
        }
        .img-upload-box:hover { border-color: #4f46e5; background-color: #eef2ff; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Print Settings */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-sm border-b border-gray-200 z-40 no-print flex-shrink-0">
        <div class="max-w-screen-2xl mx-auto py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 uppercase tracking-wide">SPARK OPR</h1>
                    <p class="text-xs text-gray-500">Penjana Laporan Satu Halaman</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-indigo-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Kembali
                </button>
                
                <button onclick="downloadPDFOnly()" id="btn-download-only" class="bg-white border-2 border-gray-200 text-gray-600 hover:border-gray-400 text-xs font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 uppercase transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Download Sahaja
                </button>

                <button onclick="saveAndDownload()" id="btn-save" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    Simpan & PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar">
            
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-2">
                    <button onclick="showTab('form')" class="text-indigo-600 border-indigo-500 whitespace-nowrap py-2 px-3 border-b-2 font-bold text-xs uppercase flex items-center gap-1" id="tab-btn-form">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Isi Borang
                    </button>
                    <button onclick="showTab('history')" class="text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-3 border-b-2 border-transparent font-medium text-xs uppercase flex items-center gap-1" id="tab-btn-history">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Sejarah
                    </button>
                    <button onclick="showTab('settings')" class="text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-3 border-b-2 border-transparent font-medium text-xs uppercase flex items-center gap-1" id="tab-btn-settings">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Tetapan
                    </button>
                </nav>
            </div>

            <div id="tab-content-form" class="block">
                
                <div class="mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100 shadow-sm">
                    <label class="block text-[10px] font-bold text-indigo-800 uppercase mb-1 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg> Import Data Program
                    </label>
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-xs border-2 border-indigo-200 rounded-lg uppercase bg-white py-2 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all">
                        <option value="">-- Pilih Program --</option>
                    </select>
                </div>

                <form oninput="updatePreview()" class="space-y-5">
                    <input type="hidden" id="report-id"> 
                    
                    <div class="bg-white p-1 rounded-lg">
                        <label class="text-xs font-bold text-gray-700 uppercase mb-1 flex items-center gap-1 ml-1">
                            <svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Tajuk Program
                        </label>
                        <input type="text" id="in-tajuk" class="w-full text-sm border-2 border-indigo-100 rounded-lg p-3 uppercase shadow-sm focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white transition-all" value="LAPORAN PROGRAM">
                        
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 flex items-center gap-1 ml-1">Mula</label>
                                <input type="date" id="in-tarikh-mula" class="w-full text-xs border-2 border-indigo-100 rounded-lg p-2 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 flex items-center gap-1 ml-1">Tamat</label>
                                <input type="date" id="in-tarikh-tamat" class="w-full text-xs border-2 border-indigo-100 rounded-lg p-2 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="text-xs font-bold text-gray-700 uppercase mb-1 flex items-center gap-1 ml-1">
                                <svg class="w-4 h-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Lokasi
                            </label>
                            <input type="text" id="in-tempat" class="w-full text-sm border-2 border-indigo-100 rounded-lg p-3 uppercase shadow-sm focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white transition-all">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-blue-700 uppercase mb-1 flex items-center gap-1 ml-1">
                            <svg class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Fokus / Objektif
                        </label>
                        <textarea id="in-objektif" rows="3" class="w-full text-sm border-2 border-blue-200 rounded-lg p-3 shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white transition-all"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-green-700 uppercase mb-1 flex items-center gap-1 ml-1">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" /></svg> Kekuatan
                            </label>
                            <textarea id="in-dapatan" rows="4" class="w-full text-sm border-2 border-green-300 rounded-lg p-2 shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-green-50"></textarea>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-red-700 uppercase mb-1 flex items-center gap-1 ml-1">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> Isu / Tindakan
                            </label>
                            <textarea id="in-isu" rows="4" class="w-full text-sm border-2 border-red-300 rounded-lg p-2 shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-red-50"></textarea>
                        </div>
                    </div>

                    <div class="border-t border-dashed pt-4">
                        <label class="text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1 ml-1">
                            <svg class="w-4 h-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Laporan Gambar
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="file" id="file-1" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-1')">
                            <input type="file" id="file-2" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-2')">
                            <input type="hidden" id="url-img-1"><input type="hidden" id="url-img-2">

                            <div class="img-upload-box rounded-lg shadow-sm bg-white hover:bg-purple-50 hover:border-purple-300" onclick="document.getElementById('file-1').click()">
                                <span class="text-[10px] text-gray-500 font-bold uppercase">Gambar 1</span>
                            </div>
                            <div class="img-upload-box rounded-lg shadow-sm bg-white hover:bg-purple-50 hover:border-purple-300" onclick="document.getElementById('file-2').click()">
                                <span class="text-[10px] text-gray-500 font-bold uppercase">Gambar 2</span>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-dashed pt-4">
                        <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1 ml-1">
                            <svg class="w-4 h-4 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg> Disediakan Oleh
                        </label>
                        <input type="text" id="in-nama" class="w-full text-sm border-2 border-gray-300 rounded-lg p-2.5 uppercase font-bold mb-2 shadow-sm bg-white focus:border-gray-500" placeholder="NAMA PEGAWAI">
                        <input type="text" id="in-jawatan" class="w-full text-sm border-2 border-gray-300 rounded-lg p-2.5 uppercase shadow-sm bg-white focus:border-gray-500" placeholder="JAWATAN">
                    </div>
                </form>
            </div>

            <div id="tab-content-history" class="hidden">
                <h3 class="text-xs font-bold text-gray-700 uppercase mb-3 border-b pb-2">Senarai Rekod Terdahulu</h3>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full text-xs text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th scope="col" class="px-3 py-3">Tarikh</th>
                                <th scope="col" class="px-3 py-3">Tajuk</th>
                                <th scope="col" class="px-3 py-3 text-center">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-100">
                            <tr><td colspan="3" class="px-3 py-4 text-center">Memuatkan...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-content-settings" class="hidden space-y-4">
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Saiz Tulisan (Default: 8pt)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustFontSize(-1)" class="w-8 h-8 bg-gray-100 border border-gray-300 rounded shadow hover:bg-gray-200 font-bold">-</button>
                        <span id="font-size-display" class="text-sm font-bold text-indigo-600">8pt</span>
                        <button onclick="adjustFontSize(1)" class="w-8 h-8 bg-gray-100 border border-gray-300 rounded shadow hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Logo Header</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full text-xs" onchange="changeLogo(this)">
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Nama Organisasi</label>
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-2 border-gray-200 rounded-lg p-2 uppercase mb-2" value="PEJABAT PENDIDIKAN DAERAH MIRI">
                    <input type="text" id="in-sub-org" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-200 rounded-lg p-2 mt-2 uppercase" value="KEMENTERIAN PENDIDIKAN MALAYSIA">
                </div>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-200 overflow-auto flex justify-center p-8">
            <div class="a4-paper transform scale-100 origin-top" id="print-area">
                
                <div class="absolute top-4 right-4 flex flex-col items-end z-20">
                    <p class="text-[8px] italic text-gray-400 mb-1">Dijana oleh SPARK</p>
                    <img id="qr-code-img" src="" class="w-12 h-12" alt="QR Index">
                </div>

                <div class="flex items-center border-b-2 border-black pb-4 mb-4 gap-4">
                    <img id="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-20 w-auto" alt="Logo">
                    <div class="pr-16">
                        <h2 id="out-org-name" class="text-lg font-bold uppercase">PEJABAT PENDIDIKAN DAERAH MIRI</h2>
                        <p id="out-sub-org" class="text-sm uppercase">KEMENTERIAN PENDIDIKAN MALAYSIA</p>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <h1 id="out-tajuk" class="text-lg font-bold uppercase border border-black py-2 px-4 inline-block bg-gray-50 min-w-[50%]">LAPORAN PROGRAM</h1>
                </div>

                <table class="opr-table" id="main-table" style="font-size: 8pt;">
                    <tr>
                        <th class="opr-header">
                            <div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> TARIKH</div>
                        </th>
                        <td id="out-tarikh" class="w-1/4 uppercase"></td>
                        <th class="opr-header">
                            <div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> LOKASI</div>
                        </th>
                        <td id="out-tempat" class="uppercase"></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">
                            <div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg> FOKUS / OBJEKTIF</div>
                        </th>
                        <td colspan="3" class="align-top"><div id="out-objektif" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">
                            <div class="flex items-center gap-1"><svg class="w-3 h-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> KEKUATAN</div>
                        </th>
                        <td colspan="3" class="align-top bg-green-50/30"><div id="out-dapatan" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">
                            <div class="flex items-center gap-1"><svg class="w-3 h-3 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> ISU / TINDAKAN</div>
                        </th>
                        <td colspan="3" class="align-top bg-red-50/30"><div id="out-isu" class="whitespace-pre-wrap text-red-900"></div></td>
                    </tr>
                </table>

                <div class="mt-4 border border-black p-1">
                    <h3 class="text-[8pt] font-bold uppercase bg-gray-100 p-1 border-b border-black text-center mb-2">LAPORAN BERGAMBAR</h3>
                    <div class="grid grid-cols-2 gap-2 h-[100mm]">
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-1" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 1</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-2" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 2</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <div class="text-center w-1/3 flex flex-col items-center">
                        <p class="text-[8pt] italic mb-10 self-start w-full text-left">Disediakan Oleh:</p>
                        <div class="border-b border-black w-full mb-1"></div>
                        <p id="out-nama" class="font-bold uppercase leading-tight text-[9pt]">NAMA PEGAWAI</p>
                        <p id="out-jawatan" class="text-[8pt] uppercase mt-0.5">JAWATAN</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        let currentUserIc = "";
        let allMyPrograms = [];
        let allMyReports = [];
        let currentFontSize = 8; 

        // QR CODE LOGIC
        const currentUrl = window.location.origin + window.location.pathname.replace('opr.html', 'index.html');
        document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(currentUrl)}`;

        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
            if (currentUserIc) {
                loadUserAndPrograms();
                loadSavedReports();
            }
        });

        // --- TAB & UI ---
        window.showTab = function(tabName) {
            document.getElementById('tab-content-form').classList.add('hidden');
            document.getElementById('tab-content-history').classList.add('hidden');
            document.getElementById('tab-content-settings').classList.add('hidden');
            document.getElementById('tab-content-' + tabName).classList.remove('hidden');
            
            // Reset Styles
            ['form', 'history', 'settings'].forEach(t => {
                const btn = document.getElementById('tab-btn-' + t);
                if(t === tabName) {
                    btn.className = "text-indigo-600 border-indigo-500 whitespace-nowrap py-2 px-3 border-b-2 font-bold text-xs uppercase flex items-center gap-1";
                } else {
                    btn.className = "text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-3 border-b-2 border-transparent font-medium text-xs uppercase flex items-center gap-1";
                }
            });
        }

        window.adjustFontSize = function(change) {
            currentFontSize += change;
            if (currentFontSize < 6) currentFontSize = 6;
            if (currentFontSize > 14) currentFontSize = 14;
            document.getElementById('font-size-display').textContent = currentFontSize + 'pt';
            document.getElementById('main-table').style.fontSize = currentFontSize + 'pt';
            document.getElementById('out-tajuk').style.fontSize = (currentFontSize + 4) + 'pt';
            
            const ths = document.querySelectorAll('.opr-table th');
            ths.forEach(th => th.style.fontSize = currentFontSize + 'pt');
            const tds = document.querySelectorAll('.opr-table td');
            tds.forEach(td => td.style.fontSize = currentFontSize + 'pt');
        }

        window.updateHeader = function() {
            document.getElementById('out-org-name').textContent = document.getElementById('in-org-name').value;
            document.getElementById('out-sub-org').textContent = document.getElementById('in-sub-org').value;
        }

        window.changeLogo = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('header-logo').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- CORE FUNCTIONS ---
        window.downloadPDFOnly = function() {
            const btn = document.getElementById('btn-download-only');
            const oriText = btn.innerHTML;
            btn.innerHTML = "Menjana...";
            btn.disabled = true;
            generatePDF(false).then(() => {
                btn.innerHTML = oriText;
                btn.disabled = false;
            });
        }

        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save');
            const oriText = btn.innerHTML;
            btn.innerHTML = "Memproses...";
            btn.disabled = true;

            try {
                const img1Url = await uploadIfNew('file-1', 'url-img-1');
                const img2Url = await uploadIfNew('file-2', 'url-img-2');

                const dataToSave = {
                    ic: currentUserIc,
                    tajuk: document.getElementById('in-tajuk').value,
                    tarikhMula: document.getElementById('in-tarikh-mula').value,
                    tarikhTamat: document.getElementById('in-tarikh-tamat').value,
                    tempat: document.getElementById('in-tempat').value,
                    objektif: document.getElementById('in-objektif').value,
                    dapatan: document.getElementById('in-dapatan').value,
                    isu: document.getElementById('in-isu').value,
                    nama: document.getElementById('in-nama').value,
                    jawatan: document.getElementById('in-jawatan').value,
                    img1: img1Url,
                    img2: img2Url,
                    updatedAt: new Date()
                };

                const reportId = document.getElementById('report-id').value;
                if(reportId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_opr_records`, reportId), dataToSave);
                } else {
                    dataToSave.createdAt = new Date();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_opr_records`), dataToSave);
                }

                await generatePDF(true);
                loadSavedReports();

            } catch (error) {
                console.error(error);
                alert("Ralat: " + error.message);
            } finally {
                btn.innerHTML = oriText;
                btn.disabled = false;
            }
        }

        async function generatePDF(isSaved) {
            const element = document.getElementById('print-area');
            const tajuk = document.getElementById('in-tajuk').value.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15);
            const fileName = `OPR_${tajuk}.pdf`;
            
            const opt = {
                margin: 0, filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            await html2pdf().set(opt).from(element).save();
            if(isSaved) alert("Disimpan & Dimuat turun!");
        }

        async function uploadIfNew(fileInputId, hiddenUrlId) {
            const fileInput = document.getElementById(fileInputId);
            const currentUrl = document.getElementById(hiddenUrlId).value;
            if (!fileInput.files || fileInput.files.length === 0) return currentUrl;

            const formData = new FormData();
            formData.append("image", fileInput.files[0]);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) return result.data.url;
            else throw new Error("Gagal upload gambar");
        }

        // --- DATA LOADERS ---
        async function loadUserAndPrograms() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uData = userSnap.docs[0].data();
                document.getElementById('in-nama').value = uData.name.toUpperCase();
                let jawatan = uData.jawatan || uData.unit || "";
                document.getElementById('in-jawatan').value = jawatan.toUpperCase();
                updatePreview();
            }

            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q1 = query(progRef, where("createdBy", "==", currentUserIc));
            const q2 = query(progRef, where("penyelaras_ic", "==", currentUserIc));
            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const select = document.getElementById('program-select');
            snap1.forEach(doc => appendOption(select, doc));
            snap2.forEach(doc => appendOption(select, doc));
        }

        function appendOption(select, doc) {
            const data = { id: doc.id, ...doc.data() };
            // Avoid duplicates
            if(Array.from(select.options).some(o => o.value === data.id)) return;
            const opt = document.createElement('option');
            opt.value = data.id;
            opt.textContent = data.name.toUpperCase();
            select.appendChild(opt);
            allMyPrograms.push(data);
        }

        async function loadSavedReports() {
            const reportRef = collection(db, `artifacts/${appId}/public/data/spark_opr_records`);
            const q = query(reportRef, where("ic", "==", currentUserIc));
            const snaps = await getDocs(q);
            
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            
            allMyReports = [];
            if(snaps.empty) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center italic text-gray-400">Tiada rekod disimpan.</td></tr>';
            }

            snaps.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                allMyReports.push(data);
                
                let dateStr = "-";
                if(data.tarikhMula) {
                    const d = new Date(data.tarikhMula);
                    dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                }

                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-indigo-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-3 py-3 font-medium text-gray-900 whitespace-nowrap">${dateStr}</td>
                    <td class="px-3 py-3 truncate max-w-[120px] text-gray-600" title="${data.tajuk}">${data.tajuk}</td>
                    <td class="px-3 py-3 text-center">
                        <button onclick="loadHistory('${data.id}')" class="text-white bg-indigo-500 hover:bg-indigo-600 px-2 py-1 rounded text-[10px] font-bold uppercase shadow-sm">Buka</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.loadHistory = function(id) {
            const report = allMyReports.find(r => r.id === id);
            if(!report) return;
            document.getElementById('report-id').value = report.id;
            document.getElementById('in-tajuk').value = report.tajuk;
            document.getElementById('in-tarikh-mula').value = report.tarikhMula;
            document.getElementById('in-tarikh-tamat').value = report.tarikhTamat || "";
            document.getElementById('in-tempat').value = report.tempat;
            document.getElementById('in-objektif').value = report.objektif;
            document.getElementById('in-dapatan').value = report.dapatan;
            document.getElementById('in-isu').value = report.isu;
            document.getElementById('in-nama').value = report.nama;
            document.getElementById('in-jawatan').value = report.jawatan;
            if(report.img1) setImgFromUrl('img-1', report.img1, 'url-img-1', 1);
            if(report.img2) setImgFromUrl('img-2', report.img2, 'url-img-2', 2);
            updatePreview();
            showTab('form'); 
        }

        window.handleImageSelect = function(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    img.nextElementSibling.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setImgFromUrl(imgId, url, hiddenInputId, index) {
            const img = document.getElementById(imgId);
            img.src = url;
            img.classList.remove('hidden');
            img.nextElementSibling.classList.add('hidden');
            document.getElementById(hiddenInputId).value = url;
        }

        window.importProgramData = function(progId) {
            if(!progId) return;
            const prog = allMyPrograms.find(p => p.id === progId);
            if(prog) {
                document.getElementById('report-id').value = "";
                document.getElementById('in-tajuk').value = prog.name.toUpperCase();
                document.getElementById('in-tempat').value = prog.location.toUpperCase();
                if(prog.startDate) document.getElementById('in-tarikh-mula').value = prog.startDate;
                if(prog.endDate) document.getElementById('in-tarikh-tamat').value = prog.endDate;
                if(prog.description) document.getElementById('in-objektif').value = prog.description;
                updatePreview();
            }
        }

        window.updatePreview = function() {
            const mappings = {
                'in-tajuk': 'out-tajuk', 'in-tempat': 'out-tempat', 'in-objektif': 'out-objektif',
                'in-dapatan': 'out-dapatan', 'in-isu': 'out-isu', 'in-nama': 'out-nama', 'in-jawatan': 'out-jawatan'
            };
            for (const [inputId, outputId] of Object.entries(mappings)) {
                document.getElementById(outputId).textContent = document.getElementById(inputId).value;
            }
            
            document.getElementById('out-tajuk').style.fontSize = (currentFontSize + 4) + 'pt';

            const dateStart = document.getElementById('in-tarikh-mula').value;
            const dateEnd = document.getElementById('in-tarikh-tamat').value;
            let dateDisplay = "";

            if(dateStart) {
                const d1 = new Date(dateStart);
                const day1 = d1.getDate();
                const month1 = d1.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                const year1 = d1.getFullYear();

                if(dateEnd && dateEnd !== dateStart) {
                    const d2 = new Date(dateEnd);
                    const day2 = d2.getDate();
                    const month2 = d2.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                    const year2 = d2.getFullYear();
                    if(year1 === year2 && month1 === month2) dateDisplay = `${day1} - ${day2} ${month1} ${year1}`;
                    else if (year1 === year2) dateDisplay = `${day1} ${month1} - ${day2} ${month2} ${year1}`;
                    else dateDisplay = `${day1} ${month1} ${year1} - ${day2} ${month2} ${year2}`;
                } else {
                    dateDisplay = `${day1} ${month1} ${year1}`;
                }
            }
            document.getElementById('out-tarikh').textContent = dateDisplay;
        }

        updatePreview();
    </script>
</body>
</html>
