<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penjana OPR Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        
        /* --- A4 PAPER SETTINGS (Compact Header) --- */
        .a4-paper {
            width: 210mm; min-height: 297mm; 
            padding-left: 15mm; padding-right: 15mm; padding-bottom: 15mm; padding-top: 10mm; /* Top padding dikurangkan */
            margin: 0 auto;
            background: white; box-shadow: 0 0 25px rgba(0,0,0,0.15);
            font-family: Arial, Helvetica, sans-serif; color: black; position: relative;
        }
        
        /* TABLE STYLES */
        .opr-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .opr-table td, .opr-table th { border: 1px solid black; padding: 4px 6px; vertical-align: top; }
        .opr-header { background-color: #f0fdf4; font-weight: bold; text-transform: uppercase; width: 25%; }
        
        /* UPLOAD BOX */
        .img-upload-box {
            background-color: #f8fafc; border: 2px dashed #cbd5e1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; position: relative; height: 100px;
            transition: all 0.3s ease;
        }
        .img-upload-box:hover { border-color: #6366f1; background-color: #e0e7ff; }

        /* CUSTOM SCROLLBAR */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        /* --- TECH HEADER STYLES --- */
        .tech-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-bottom: 1px solid #334155;
        }
        .tech-badge-pro {
            background: linear-gradient(90deg, #fbbf24 0%, #d97706 100%);
            color: #451a03; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        .tech-badge-basic {
            background: #334155; color: #94a3b8; border: 1px solid #475569;
        }

        /* PRINT SETTINGS */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; page-break-after: always; padding-top: 10mm !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <header class="tech-header shadow-md z-50 no-print flex-shrink-0 text-white">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            
            <div class="flex items-center gap-4">
                <div class="bg-indigo-500/20 p-2 rounded-xl border border-indigo-500/30 backdrop-blur-sm">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-indigo-400"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wider uppercase flex items-center gap-2">
                        SPARK OPR
                        <span id="account-badge" class="text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-widest tech-badge-basic">Loading...</span>
                    </h1>
                    <p class="text-[10px] text-gray-400">Sistem Penjanaan Laporan Pintar</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="window.location.href='user.html'" class="text-gray-400 hover:text-white text-xs font-medium px-3 flex items-center gap-1 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    KEMBALI
                </button>
                
                <div class="h-6 w-px bg-gray-700 mx-1"></div>

                <button onclick="downloadPDFOnly()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-bold py-2 px-4 rounded-lg shadow border border-slate-600 flex items-center gap-2 uppercase transition-all">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Download
                </button>

                <button onclick="saveAndDownload()" id="btn-save" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 px-5 rounded-lg shadow-lg shadow-indigo-900/50 border border-indigo-500 flex items-center gap-2 uppercase transition-all transform hover:scale-105">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    Simpan & PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar relative">
            
            <div id="pro-lock-overlay" class="hidden absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm">
                <div class="text-center p-6 bg-white rounded-xl shadow-2xl border border-gray-100">
                    <span class="text-3xl mb-2 block">ðŸ”’</span>
                    <h3 class="font-bold text-gray-800">Ciri SPARK PRO</h3>
                    <p class="text-xs text-gray-500 mt-1">Sila naik taraf akaun anda.</p>
                </div>
            </div>

            <div class="flex gap-3 mb-5">
                <div class="w-1/2">
                    <label class="block text-[9px] font-bold text-gray-400 uppercase mb-1">Rekod Terdahulu</label>
                    <select id="history-select" onchange="loadHistory(this.value)" class="w-full text-xs border border-gray-300 rounded bg-gray-50 focus:ring-1 focus:ring-indigo-500 h-8">
                        <option value="">-- Pilih --</option>
                    </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-[9px] font-bold text-gray-400 uppercase mb-1">Import Data</label>
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-xs border border-blue-300 rounded bg-blue-50 focus:ring-1 focus:ring-blue-500 h-8">
                        <option value="">-- Pilih Program --</option>
                    </select>
                </div>
            </div>

            <div class="flex p-1 bg-gray-100 rounded-lg mb-5">
                <button onclick="showTab('form')" id="tab-btn-form" class="flex-1 py-1.5 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-indigo-600 transition-all">Isi Borang</button>
                <button onclick="showTab('history')" id="tab-btn-history" class="flex-1 py-1.5 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Sejarah</button>
                <button onclick="showTab('settings')" id="tab-btn-settings" class="flex-1 py-1.5 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Tetapan</button>
            </div>

            <div id="tab-content-form" class="block space-y-5">
                
                <div class="bg-white p-1">
                    <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                        <span class="w-1.5 h-4 bg-indigo-500 rounded-full"></span> Tajuk Program
                    </label>
                    <input type="text" id="in-tajuk" class="w-full text-sm border-2 border-gray-200 rounded-lg p-2.5 uppercase focus:border-indigo-500 focus:ring-0 transition-colors" value="LAPORAN PROGRAM">
                    
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Tarikh Mula</label>
                            <input type="date" id="in-tarikh-mula" class="w-full text-xs border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Tarikh Tamat</label>
                            <input type="date" id="in-tarikh-tamat" class="w-full text-xs border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-red-500 rounded-full"></span> Lokasi
                        </label>
                        <input type="text" id="in-tempat" class="w-full text-sm border-2 border-gray-200 rounded-lg p-2.5 uppercase focus:border-red-500 transition-colors">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                        <span class="w-1.5 h-4 bg-blue-500 rounded-full"></span> Fokus / Objektif
                    </label>
                    <textarea id="in-objektif" rows="3" class="w-full text-sm border-2 border-blue-100 rounded-lg p-3 focus:border-blue-500 focus:bg-white bg-blue-50/30 transition-colors"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-green-500 rounded-full"></span> Kekuatan
                        </label>
                        <textarea id="in-dapatan" rows="4" class="w-full text-sm border-2 border-green-100 rounded-lg p-2 focus:border-green-500 bg-green-50/30"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-orange-500 rounded-full"></span> Isu / Tindakan
                        </label>
                        <textarea id="in-isu" rows="4" class="w-full text-sm border-2 border-orange-100 rounded-lg p-2 focus:border-orange-500 bg-orange-50/30"></textarea>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Laporan Gambar</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="file" id="file-1" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-1')">
                        <input type="file" id="file-2" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-2')">
                        <input type="hidden" id="url-img-1"><input type="hidden" id="url-img-2">

                        <div class="img-upload-box rounded-lg" onclick="document.getElementById('file-1').click()">
                            <svg class="w-5 h-5 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span class="text-[9px] font-bold text-gray-400 uppercase">Gambar 1</span>
                        </div>
                        <div class="img-upload-box rounded-lg" onclick="document.getElementById('file-2').click()">
                            <svg class="w-5 h-5 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span class="text-[9px] font-bold text-gray-400 uppercase">Gambar 2</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Disediakan Oleh</label>
                    <input type="text" id="in-nama" class="w-full text-sm border border-gray-300 rounded p-2 uppercase font-bold mb-2 bg-white" placeholder="NAMA PEGAWAI">
                    <input type="text" id="in-jawatan" class="w-full text-xs border border-gray-300 rounded p-2 uppercase bg-white" placeholder="JAWATAN">
                </div>
                <input type="hidden" id="report-id">
            </div>

            <div id="tab-content-history" class="hidden">
                <div class="overflow-hidden rounded-lg border border-gray-200">
                    <table class="min-w-full text-xs text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr><th class="px-3 py-3">Tarikh</th><th class="px-3 py-3">Tajuk</th><th class="px-3 py-3 text-center">Aksi</th></tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-100">
                            <tr><td colspan="3" class="px-3 py-4 text-center">Tiada rekod.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-content-settings" class="hidden space-y-4">
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Saiz Tulisan (Kandungan)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustFontSize(-1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="font-size-display" class="text-sm font-bold text-indigo-600">8pt</span>
                        <button onclick="adjustFontSize(1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-indigo-700 uppercase mb-2 flex justify-between">
                        Saiz Tajuk Header
                        <span class="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded">PRO</span>
                    </label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustHeaderSize(-1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="header-size-display" class="text-sm font-bold text-indigo-600">18pt</span>
                        <button onclick="adjustHeaderSize(1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Logo & Nama</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full text-xs mb-3 text-gray-500" onchange="changeLogo(this)">
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-2 border-gray-100 rounded p-2 uppercase mb-2" value="PEJABAT PENDIDIKAN DAERAH MIRI">
                    <input type="text" id="in-sub-org" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 uppercase" value="KEMENTERIAN PENDIDIKAN MALAYSIA">
                </div>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-100 overflow-auto flex justify-center p-8">
            <div class="a4-paper transform scale-100 origin-top" id="print-area">
                
                <div class="absolute top-4 right-4 flex flex-col items-end z-20">
                    <p class="text-[8px] italic text-gray-400 mb-1">Dijana oleh SPARK</p>
                    <img id="qr-code-img" src="" class="w-12 h-12" alt="QR Index">
                </div>

                <div class="flex items-center border-b-2 border-black pb-3 mb-3 gap-4">
                    <img id="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-20 w-auto" alt="Logo">
                    <div class="pr-20">
                        <h2 id="out-org-name" class="font-bold uppercase leading-tight" style="font-size: 18pt;">PEJABAT PENDIDIKAN DAERAH MIRI</h2>
                        <p id="out-sub-org" class="text-sm uppercase mt-1">KEMENTERIAN PENDIDIKAN MALAYSIA</p>
                    </div>
                </div>

                <div class="text-center mb-3">
                    <h1 id="out-tajuk" class="font-bold uppercase border border-black py-1.5 px-4 inline-block bg-gray-50 min-w-[50%]" style="font-size: 12pt;">LAPORAN PROGRAM</h1>
                </div>

                <table class="opr-table" id="main-table" style="font-size: 8pt;">
                    <tr>
                        <th class="opr-header"><div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> TARIKH</div></th>
                        <td id="out-tarikh" class="w-1/4 uppercase"></td>
                        <th class="opr-header"><div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> LOKASI</div></th>
                        <td id="out-tempat" class="uppercase"></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top"><div class="flex items-center gap-1"><svg class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg> FOKUS</div></th>
                        <td colspan="3" class="align-top"><div id="out-objektif" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top"><div class="flex items-center gap-1"><svg class="w-3 h-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> KEKUATAN</div></th>
                        <td colspan="3" class="align-top bg-green-50/30"><div id="out-dapatan" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top"><div class="flex items-center gap-1"><svg class="w-3 h-3 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg> ISU/TINDAKAN</div></th>
                        <td colspan="3" class="align-top bg-red-50/30"><div id="out-isu" class="whitespace-pre-wrap text-red-900"></div></td>
                    </tr>
                </table>

                <div class="mt-3 border border-black p-1">
                    <h3 class="text-[8pt] font-bold uppercase bg-gray-100 p-1 border-b border-black text-center mb-1">LAPORAN BERGAMBAR</h3>
                    <div class="grid grid-cols-2 gap-2 h-[100mm]">
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-1" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 1</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-2" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 2</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <div class="text-center w-1/3 flex flex-col items-center">
                        <p class="text-[8pt] italic mb-10 self-start w-full text-left">Disediakan Oleh:</p>
                        <div class="border-b border-black w-full mb-1"></div>
                        <p id="out-nama" class="font-bold uppercase leading-tight text-[9pt]">NAMA PEGAWAI</p>
                        <p id="out-jawatan" class="text-[8pt] uppercase mt-0.5">JAWATAN</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        let currentUserIc = "";
        let isSparkPro = false; // Status Akaun
        let currentFontSize = 8; 
        let currentHeaderSize = 18; // Default Header Size

        // Set QR Code
        const currentUrl = window.location.origin + window.location.pathname.replace('opr.html', 'index.html');
        document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(currentUrl)}`;

        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
            if (currentUserIc) {
                loadUserAndPrograms();
                loadSavedReports();
            }
        });

        // --- UI & TABS ---
        window.showTab = function(tabName) {
            document.querySelectorAll('[id^="tab-content-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-content-' + tabName).classList.remove('hidden');
            
            document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
                btn.className = "flex-1 py-1.5 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all";
            });
            document.getElementById('tab-btn-' + tabName).className = "flex-1 py-1.5 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-indigo-600 transition-all";
        }

        // --- FONT SIZE ADJUSTMENTS ---
        window.adjustFontSize = function(change) {
            currentFontSize += change;
            if (currentFontSize < 6) currentFontSize = 6;
            if (currentFontSize > 14) currentFontSize = 14;
            document.getElementById('font-size-display').textContent = currentFontSize + 'pt';
            document.getElementById('main-table').style.fontSize = currentFontSize + 'pt';
            document.getElementById('out-tajuk').style.fontSize = (currentFontSize + 4) + 'pt';
            const ths = document.querySelectorAll('.opr-table th');
            ths.forEach(th => th.style.fontSize = currentFontSize + 'pt');
            const tds = document.querySelectorAll('.opr-table td');
            tds.forEach(td => td.style.fontSize = currentFontSize + 'pt');
        }

        // NEW: ADJUST HEADER SIZE ONLY
        window.adjustHeaderSize = function(change) {
            if(!isSparkPro) {
                alert("Ciri ini untuk akaun SPARK PRO sahaja.");
                return;
            }
            currentHeaderSize += change;
            if (currentHeaderSize < 10) currentHeaderSize = 10;
            if (currentHeaderSize > 30) currentHeaderSize = 30;
            
            document.getElementById('header-size-display').textContent = currentHeaderSize + 'pt';
            document.getElementById('out-org-name').style.fontSize = currentHeaderSize + 'pt';
        }

        window.updateHeader = function() {
            document.getElementById('out-org-name').textContent = document.getElementById('in-org-name').value;
            document.getElementById('out-sub-org').textContent = document.getElementById('in-sub-org').value;
        }

        window.changeLogo = function(input) {
            if(!isSparkPro) {
                alert("Menukar logo adalah ciri SPARK PRO.");
                input.value = ""; // Reset
                return;
            }
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('header-logo').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- CORE FUNCTIONS ---
        window.downloadPDFOnly = function() {
            const btn = document.getElementById('btn-download-only');
            const oriText = btn.innerHTML;
            btn.innerHTML = "Menjana...";
            btn.disabled = true;
            generatePDF(false).then(() => {
                btn.innerHTML = oriText;
                btn.disabled = false;
            });
        }

        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save');
            const oriText = btn.innerHTML;
            btn.innerHTML = "Memproses...";
            btn.disabled = true;

            try {
                const img1Url = await uploadIfNew('file-1', 'url-img-1');
                const img2Url = await uploadIfNew('file-2', 'url-img-2');

                const dataToSave = {
                    ic: currentUserIc,
                    tajuk: document.getElementById('in-tajuk').value,
                    tarikhMula: document.getElementById('in-tarikh-mula').value,
                    tarikhTamat: document.getElementById('in-tarikh-tamat').value,
                    tempat: document.getElementById('in-tempat').value,
                    objektif: document.getElementById('in-objektif').value,
                    dapatan: document.getElementById('in-dapatan').value,
                    isu: document.getElementById('in-isu').value,
                    nama: document.getElementById('in-nama').value,
                    jawatan: document.getElementById('in-jawatan').value,
                    img1: img1Url, img2: img2Url, updatedAt: new Date()
                };

                const reportId = document.getElementById('report-id').value;
                if(reportId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_opr_records`, reportId), dataToSave);
                } else {
                    dataToSave.createdAt = new Date();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_opr_records`), dataToSave);
                }

                await generatePDF(true);
                // Refresh list without full reload
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_opr_records`), where("ic", "==", currentUserIc));
                const snaps = await getDocs(q);
                const select = document.getElementById('history-select');
                select.innerHTML = '<option value="">-- Pilih --</option>';
                snaps.forEach(doc => {
                    const d = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = d.tajuk.substring(0, 30);
                    select.appendChild(opt);
                });

            } catch (error) {
                console.error(error);
                alert("Ralat: " + error.message);
            } finally {
                btn.innerHTML = oriText;
                btn.disabled = false;
            }
        }

        async function generatePDF(isSaved) {
            const element = document.getElementById('print-area');
            const tajuk = document.getElementById('in-tajuk').value.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15);
            const fileName = `OPR_${tajuk}.pdf`;
            const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            await html2pdf().set(opt).from(element).save();
            if(isSaved) alert("Disimpan & Dimuat turun!");
        }

        async function uploadIfNew(fileInputId, hiddenUrlId) {
            const fileInput = document.getElementById(fileInputId);
            const currentUrl = document.getElementById(hiddenUrlId).value;
            if (!fileInput.files || fileInput.files.length === 0) return currentUrl;
            const formData = new FormData();
            formData.append("image", fileInput.files[0]);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) return result.data.url;
            else throw new Error("Gagal upload gambar");
        }

        // --- DATA LOADERS ---
        async function loadUserAndPrograms() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uData = userSnap.docs[0].data();
                document.getElementById('in-nama').value = uData.name.toUpperCase();
                let jawatan = uData.jawatan || uData.unit || "";
                document.getElementById('in-jawatan').value = jawatan.toUpperCase();
                
                // CHECK PRO STATUS
                isSparkPro = uData.isPro === true;
                const badge = document.getElementById('account-badge');
                if (isSparkPro) {
                    badge.textContent = "AKAUN PRO";
                    badge.className = "text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-widest tech-badge-pro";
                } else {
                    badge.textContent = "AKAUN BIASA";
                    badge.className = "text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-widest tech-badge-basic";
                }
                
                updatePreview();
            }

            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q1 = query(progRef, where("createdBy", "==", currentUserIc));
            const q2 = query(progRef, where("penyelaras_ic", "==", currentUserIc));
            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const select = document.getElementById('program-select');
            const appendOption = (doc) => {
                const data = { id: doc.id, ...doc.data() };
                if(Array.from(select.options).some(o => o.value === data.id)) return;
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.textContent = data.name.toUpperCase();
                select.appendChild(opt);
                allMyPrograms.push(data);
            };
            snap1.forEach(appendOption);
            snap2.forEach(appendOption);
        }

        async function loadSavedReports() {
            const reportRef = collection(db, `artifacts/${appId}/public/data/spark_opr_records`);
            const q = query(reportRef, where("ic", "==", currentUserIc));
            const snaps = await getDocs(q);
            const tbody = document.getElementById('history-table-body');
            const select = document.getElementById('history-select');
            
            tbody.innerHTML = '';
            select.innerHTML = '<option value="">-- Pilih --</option>';
            allMyReports = [];

            if(snaps.empty) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center text-xs text-gray-400">Tiada rekod.</td></tr>';
            }

            snaps.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                allMyReports.push(data);
                
                // Populate Dropdown
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.textContent = data.tajuk.substring(0, 30);
                select.appendChild(opt);

                // Populate Table
                let dateStr = "-";
                if(data.tarikhMula) {
                    const d = new Date(data.tarikhMula);
                    dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                }
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${dateStr}</td>
                    <td class="px-3 py-2 truncate max-w-[100px]">${data.tajuk}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="loadHistory('${data.id}')" class="text-indigo-600 font-bold hover:underline">Buka</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.loadHistory = function(id) {
            const report = allMyReports.find(r => r.id === id);
            if(!report) return;
            document.getElementById('report-id').value = report.id;
            document.getElementById('in-tajuk').value = report.tajuk;
            document.getElementById('in-tarikh-mula').value = report.tarikhMula;
            document.getElementById('in-tarikh-tamat').value = report.tarikhTamat || "";
            document.getElementById('in-tempat').value = report.tempat;
            document.getElementById('in-objektif').value = report.objektif;
            document.getElementById('in-dapatan').value = report.dapatan;
            document.getElementById('in-isu').value = report.isu;
            document.getElementById('in-nama').value = report.nama;
            document.getElementById('in-jawatan').value = report.jawatan;
            if(report.img1) setImgFromUrl('img-1', report.img1, 'url-img-1', 1);
            if(report.img2) setImgFromUrl('img-2', report.img2, 'url-img-2', 2);
            updatePreview();
            showTab('form');
        }

        window.handleImageSelect = function(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    img.nextElementSibling.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setImgFromUrl(imgId, url, hiddenInputId, index) {
            const img = document.getElementById(imgId);
            img.src = url;
            img.classList.remove('hidden');
            img.nextElementSibling.classList.add('hidden');
            document.getElementById(hiddenInputId).value = url;
        }

        window.importProgramData = function(progId) {
            if(!progId) return;
            const prog = allMyPrograms.find(p => p.id === progId);
            if(prog) {
                document.getElementById('report-id').value = "";
                document.getElementById('in-tajuk').value = prog.name.toUpperCase();
                document.getElementById('in-tempat').value = prog.location.toUpperCase();
                if(prog.startDate) document.getElementById('in-tarikh-mula').value = prog.startDate;
                if(prog.endDate) document.getElementById('in-tarikh-tamat').value = prog.endDate;
                if(prog.description) document.getElementById('in-objektif').value = prog.description;
                updatePreview();
            }
        }

        window.updatePreview = function() {
            const mappings = {
                'in-tajuk': 'out-tajuk', 'in-tempat': 'out-tempat', 'in-objektif': 'out-objektif',
                'in-dapatan': 'out-dapatan', 'in-isu': 'out-isu', 'in-nama': 'out-nama', 'in-jawatan': 'out-jawatan'
            };
            for (const [inputId, outputId] of Object.entries(mappings)) {
                document.getElementById(outputId).textContent = document.getElementById(inputId).value;
            }
            
            document.getElementById('out-tajuk').style.fontSize = (currentFontSize + 4) + 'pt';

            const dateStart = document.getElementById('in-tarikh-mula').value;
            const dateEnd = document.getElementById('in-tarikh-tamat').value;
            let dateDisplay = "";

            if(dateStart) {
                const d1 = new Date(dateStart);
                const day1 = d1.getDate();
                const month1 = d1.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                const year1 = d1.getFullYear();

                if(dateEnd && dateEnd !== dateStart) {
                    const d2 = new Date(dateEnd);
                    const day2 = d2.getDate();
                    const month2 = d2.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                    const year2 = d2.getFullYear();
                    if(year1 === year2 && month1 === month2) dateDisplay = `${day1} - ${day2} ${month1} ${year1}`;
                    else if (year1 === year2) dateDisplay = `${day1} ${month1} - ${day2} ${month2} ${year1}`;
                    else dateDisplay = `${day1} ${month1} ${year1} - ${day2} ${month2} ${year2}`;
                } else {
                    dateDisplay = `${day1} ${month1} ${year1}`;
                }
            }
            document.getElementById('out-tarikh').textContent = dateDisplay;
        }

        updatePreview();
    </script>
</body>
</html>
