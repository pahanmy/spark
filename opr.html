<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penjana OPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        
        /* A4 Paper Setting - FONT ARIAL */
        .a4-paper {
            width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto;
            background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: Arial, Helvetica, sans-serif; color: black; position: relative;
        }
        
        /* Table Styles */
        .opr-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .opr-table td, .opr-table th { border: 1px solid black; padding: 6px 8px; vertical-align: top; }
        .opr-header { background-color: #e5e7eb; font-weight: bold; text-transform: uppercase; width: 25%; }
        
        /* Image Upload Box */
        .img-upload-box {
            background-color: #f9fafb; border: 2px dashed #d1d5db; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; position: relative; height: 100px;
        }
        .img-upload-box:hover { border-color: #4f46e5; background-color: #eef2ff; }

        /* Print Settings */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-sm border-b border-gray-200 z-40 no-print flex-shrink-0">
        <div class="max-w-screen-2xl mx-auto py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 uppercase tracking-wide">SPARK OPR</h1>
                    <p class="text-xs text-gray-500">Penjana Laporan Satu Halaman</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-indigo-600 text-sm font-semibold px-3">Kembali</button>
                <button onclick="saveAndDownload()" id="btn-save" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded shadow flex items-center gap-2 uppercase">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    Simpan & Download PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-6 no-print z-10">
            
            <div class="flex gap-2 mb-6">
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Sejarah Laporan</label>
                    <select id="history-select" onchange="loadHistory(this.value)" class="w-full text-xs border-gray-300 rounded uppercase bg-white">
                        <option value="">-- Rekod --</option>
                    </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Import Program</label>
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-xs border-blue-300 rounded uppercase bg-white">
                        <option value="">-- Pilih --</option>
                    </select>
                </div>
            </div>

            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-4">
                    <button onclick="showTab('form')" class="text-indigo-600 border-indigo-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs uppercase" id="tab-btn-form">Isi Borang</button>
                    <button onclick="showTab('settings')" class="text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-xs uppercase" id="tab-btn-settings">Tetapan Format</button>
                </nav>
            </div>

            <form id="tab-content-form" oninput="updatePreview()" class="space-y-4 block">
                <input type="hidden" id="report-id"> 
                
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tajuk Program</label>
                    <input type="text" id="in-tajuk" class="w-full text-sm border-gray-300 rounded p-2 uppercase" value="LAPORAN PROGRAM">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tarikh Mula</label>
                            <input type="date" id="in-tarikh-mula" class="w-full text-sm border-gray-300 rounded p-1">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tarikh Tamat (Jika Ada)</label>
                            <input type="date" id="in-tarikh-tamat" class="w-full text-sm border-gray-300 rounded p-1">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label>
                        <input type="text" id="in-tempat" class="w-full text-sm border-gray-300 rounded p-2 uppercase">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fokus / Objektif</label>
                    <textarea id="in-objektif" rows="3" class="w-full text-sm border-gray-300 rounded p-2"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold text-green-600 uppercase mb-1">Kekuatan</label>
                        <textarea id="in-dapatan" rows="3" class="w-full text-sm border-gray-300 rounded p-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-600 uppercase mb-1">Isu / Tindakan</label>
                        <textarea id="in-isu" rows="3" class="w-full text-sm border-gray-300 rounded p-2"></textarea>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gambar</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="file" id="file-1" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-1')">
                        <input type="file" id="file-2" class="hidden" accept="image/*" onchange="handleImageSelect(this, 'img-2')">
                        <input type="hidden" id="url-img-1"><input type="hidden" id="url-img-2">

                        <div class="img-upload-box rounded" onclick="document.getElementById('file-1').click()">
                            <span class="text-[10px] text-gray-500">Gambar 1</span>
                        </div>
                        <div class="img-upload-box rounded" onclick="document.getElementById('file-2').click()">
                            <span class="text-[10px] text-gray-500">Gambar 2</span>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Disediakan Oleh</label>
                    <input type="text" id="in-nama" class="w-full text-sm border-gray-300 rounded p-2 uppercase font-bold mb-2">
                    <input type="text" id="in-jawatan" class="w-full text-sm border-gray-300 rounded p-2 uppercase" placeholder="JAWATAN">
                </div>
            </form>

            <div id="tab-content-settings" class="hidden space-y-4">
                
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Saiz Tulisan (Font)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustFontSize(-1)" class="w-8 h-8 bg-white border border-gray-300 rounded hover:bg-gray-100 font-bold">-</button>
                        <span id="font-size-display" class="text-sm font-bold">11pt</span>
                        <button onclick="adjustFontSize(1)" class="w-8 h-8 bg-white border border-gray-300 rounded hover:bg-gray-100 font-bold">+</button>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Tukar Logo Header</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full text-xs" onchange="changeLogo(this)">
                    <p class="text-[10px] text-gray-400 mt-1">*Sila guna logo latar belakang putih/telus.</p>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Nama Organisasi (Header)</label>
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-gray-300 rounded p-2 uppercase" value="PEJABAT PENDIDIKAN DAERAH MIRI">
                    <input type="text" id="in-sub-org" oninput="updateHeader()" class="w-full text-xs border-gray-300 rounded p-2 mt-2 uppercase" value="KEMENTERIAN PENDIDIKAN MALAYSIA">
                </div>

            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-200 overflow-auto flex justify-center p-8">
            <div class="a4-paper transform scale-100 origin-top" id="print-area">
                
                <div class="flex items-center border-b-2 border-black pb-4 mb-4 gap-4">
                    <img id="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-20 w-auto" alt="Logo">
                    <div>
                        <h2 id="out-org-name" class="text-lg font-bold uppercase">PEJABAT PENDIDIKAN DAERAH MIRI</h2>
                        <p id="out-sub-org" class="text-sm uppercase">KEMENTERIAN PENDIDIKAN MALAYSIA</p>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <h1 id="out-tajuk" class="text-lg font-bold uppercase border border-black py-2 px-4 inline-block bg-gray-50 min-w-[50%]">LAPORAN PROGRAM</h1>
                </div>

                <table class="opr-table" id="main-table" style="font-size: 11pt;">
                    <tr>
                        <th class="opr-header">TARIKH</th>
                        <td id="out-tarikh" class="w-1/4 uppercase"></td>
                        <th class="opr-header">LOKASI</th>
                        <td id="out-tempat" class="uppercase"></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">OBJEKTIF / FOKUS</th>
                        <td colspan="3" class="align-top"><div id="out-objektif" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">KEKUATAN / DAPATAN</th>
                        <td colspan="3" class="align-top bg-green-50/30"><div id="out-dapatan" class="whitespace-pre-wrap"></div></td>
                    </tr>
                    <tr>
                        <th class="opr-header align-top">ISU / TINDAKAN</th>
                        <td colspan="3" class="align-top bg-red-50/30"><div id="out-isu" class="whitespace-pre-wrap text-red-900"></div></td>
                    </tr>
                </table>

                <div class="mt-4 border border-black p-1">
                    <h3 class="text-xs font-bold uppercase bg-gray-100 p-1 border-b border-black text-center mb-2">LAPORAN BERGAMBAR</h3>
                    <div class="grid grid-cols-2 gap-2 h-[100mm]">
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-1" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 1</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden relative bg-gray-50">
                            <img id="img-2" src="" class="absolute inset-0 w-full h-full object-cover hidden" crossorigin="anonymous">
                            <span class="text-gray-400 text-xs text-center p-4">Gambar 2</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <div class="text-center w-1/3">
                        <p class="text-sm italic mb-8">Disediakan Oleh:</p>
                        <p id="out-nama" class="font-bold uppercase border-b border-black pb-1 mb-1">NAMA PEGAWAI</p>
                        <p id="out-jawatan" class="text-xs uppercase">JAWATAN</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // API KEY IMGBB
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        let currentUserIc = "";
        let allMyPrograms = [];
        let allMyReports = [];
        let currentFontSize = 11;

        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');

            if (currentUserIc) {
                loadUserAndPrograms();
                loadSavedReports();
            }
        });

        // --- TAB SYSTEM ---
        window.showTab = function(tabName) {
            document.getElementById('tab-content-form').classList.add('hidden');
            document.getElementById('tab-content-settings').classList.add('hidden');
            document.getElementById('tab-content-' + tabName).classList.remove('hidden');
            
            const btnForm = document.getElementById('tab-btn-form');
            const btnSet = document.getElementById('tab-btn-settings');
            
            if(tabName === 'form') {
                btnForm.className = "text-indigo-600 border-indigo-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs uppercase";
                btnSet.className = "text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-xs uppercase";
            } else {
                btnSet.className = "text-indigo-600 border-indigo-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs uppercase";
                btnForm.className = "text-gray-500 hover:text-gray-700 whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-xs uppercase";
            }
        }

        // --- TETAPAN FORMAT ---
        window.adjustFontSize = function(change) {
            currentFontSize += change;
            if (currentFontSize < 8) currentFontSize = 8;
            if (currentFontSize > 16) currentFontSize = 16;
            
            document.getElementById('font-size-display').textContent = currentFontSize + 'pt';
            document.getElementById('main-table').style.fontSize = currentFontSize + 'pt';
            
            // Adjust header row slightly smaller than content
            const ths = document.querySelectorAll('.opr-table th');
            ths.forEach(th => th.style.fontSize = (currentFontSize) + 'pt');
            
            const tds = document.querySelectorAll('.opr-table td');
            tds.forEach(td => td.style.fontSize = currentFontSize + 'pt');
        }

        window.updateHeader = function() {
            document.getElementById('out-org-name').textContent = document.getElementById('in-org-name').value;
            document.getElementById('out-sub-org').textContent = document.getElementById('in-sub-org').value;
        }

        window.changeLogo = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('header-logo').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- FIREBASE LOGIC ---
        async function loadUserAndPrograms() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uData = userSnap.docs[0].data();
                document.getElementById('in-nama').value = uData.name.toUpperCase();
                let jawatan = "PEGAWAI PPD"; 
                if(uData.station) jawatan = "GURU BESAR / PENGETUA";
                document.getElementById('in-jawatan').value = jawatan;
                updatePreview();
            }

            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q1 = query(progRef, where("createdBy", "==", currentUserIc));
            const q2 = query(progRef, where("penyelaras_ic", "==", currentUserIc));
            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const programMap = new Map();
            snap1.forEach(doc => programMap.set(doc.id, { id: doc.id, ...doc.data() }));
            snap2.forEach(doc => programMap.set(doc.id, { id: doc.id, ...doc.data() }));
            
            const select = document.getElementById('program-select');
            programMap.forEach(prog => {
                const opt = document.createElement('option');
                opt.value = prog.id;
                opt.textContent = prog.name.toUpperCase();
                select.appendChild(opt);
                allMyPrograms.push(prog);
            });
        }

        async function loadSavedReports() {
            const reportRef = collection(db, `artifacts/${appId}/public/data/spark_opr_records`);
            const q = query(reportRef, where("ic", "==", currentUserIc));
            const snaps = await getDocs(q);
            
            const select = document.getElementById('history-select');
            select.innerHTML = '<option value="">-- Rekod --</option>';
            
            allMyReports = [];
            snaps.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                allMyReports.push(data);
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.textContent = data.tajuk.substring(0, 30);
                select.appendChild(opt);
            });
        }

        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save');
            const oriText = btn.innerHTML;
            btn.innerHTML = "Memproses...";
            btn.disabled = true;

            try {
                const img1Url = await uploadIfNew('file-1', 'url-img-1');
                const img2Url = await uploadIfNew('file-2', 'url-img-2');

                const dataToSave = {
                    ic: currentUserIc,
                    tajuk: document.getElementById('in-tajuk').value,
                    tarikhMula: document.getElementById('in-tarikh-mula').value,
                    tarikhTamat: document.getElementById('in-tarikh-tamat').value,
                    tempat: document.getElementById('in-tempat').value,
                    objektif: document.getElementById('in-objektif').value,
                    dapatan: document.getElementById('in-dapatan').value,
                    isu: document.getElementById('in-isu').value,
                    nama: document.getElementById('in-nama').value,
                    jawatan: document.getElementById('in-jawatan').value,
                    img1: img1Url,
                    img2: img2Url,
                    updatedAt: new Date()
                };

                const reportId = document.getElementById('report-id').value;
                if(reportId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_opr_records`, reportId), dataToSave);
                } else {
                    dataToSave.createdAt = new Date();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_opr_records`), dataToSave);
                }

                btn.innerHTML = "Menjana PDF...";
                const element = document.getElementById('print-area');
                const fileName = `OPR_${dataToSave.tajuk.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15)}.pdf`;
                
                const opt = {
                    margin: 0, filename: fileName,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(element).save();
                alert("Berjaya disimpan & dimuat turun!");
                loadSavedReports();

            } catch (error) {
                console.error(error);
                alert("Ralat: " + error.message);
            } finally {
                btn.innerHTML = oriText;
                btn.disabled = false;
            }
        }

        async function uploadIfNew(fileInputId, hiddenUrlId) {
            const fileInput = document.getElementById(fileInputId);
            const currentUrl = document.getElementById(hiddenUrlId).value;
            if (!fileInput.files || fileInput.files.length === 0) return currentUrl;

            const formData = new FormData();
            formData.append("image", fileInput.files[0]);
            
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await response.json();
            
            if (result.success) return result.data.url;
            else throw new Error("Gagal upload gambar");
        }

        window.handleImageSelect = function(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    img.nextElementSibling.classList.add('hidden');
                    const triggerIndex = imgId.split('-')[1];
                    const box = document.querySelectorAll('.img-upload-box')[triggerIndex-1];
                    box.style.backgroundImage = `url('${e.target.result}')`;
                    box.style.backgroundSize = 'cover';
                    box.style.backgroundPosition = 'center';
                    box.querySelector('span').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.loadHistory = function(id) {
            const report = allMyReports.find(r => r.id === id);
            if(!report) return;
            document.getElementById('report-id').value = report.id;
            document.getElementById('in-tajuk').value = report.tajuk;
            document.getElementById('in-tarikh-mula').value = report.tarikhMula;
            document.getElementById('in-tarikh-tamat').value = report.tarikhTamat || "";
            document.getElementById('in-tempat').value = report.tempat;
            document.getElementById('in-objektif').value = report.objektif;
            document.getElementById('in-dapatan').value = report.dapatan;
            document.getElementById('in-isu').value = report.isu;
            document.getElementById('in-nama').value = report.nama;
            document.getElementById('in-jawatan').value = report.jawatan;
            if(report.img1) setImgFromUrl('img-1', report.img1, 'url-img-1', 1);
            if(report.img2) setImgFromUrl('img-2', report.img2, 'url-img-2', 2);
            updatePreview();
        }

        function setImgFromUrl(imgId, url, hiddenInputId, index) {
            const img = document.getElementById(imgId);
            img.src = url;
            img.classList.remove('hidden');
            img.nextElementSibling.classList.add('hidden');
            document.getElementById(hiddenInputId).value = url;
            const box = document.querySelectorAll('.img-upload-box')[index-1];
            box.style.backgroundImage = `url('${url}')`;
            box.style.backgroundSize = 'cover';
            box.style.backgroundPosition = 'center';
            box.querySelector('span').classList.add('hidden');
        }

        window.importProgramData = function(progId) {
            if(!progId) return;
            const prog = allMyPrograms.find(p => p.id === progId);
            if(prog) {
                document.getElementById('report-id').value = "";
                document.getElementById('in-tajuk').value = prog.name.toUpperCase();
                document.getElementById('in-tempat').value = prog.location.toUpperCase();
                if(prog.startDate) document.getElementById('in-tarikh-mula').value = prog.startDate;
                if(prog.endDate) document.getElementById('in-tarikh-tamat').value = prog.endDate;
                if(prog.description) document.getElementById('in-objektif').value = prog.description;
                updatePreview();
            }
        }

        window.updatePreview = function() {
            const mappings = {
                'in-tajuk': 'out-tajuk', 'in-tempat': 'out-tempat', 'in-objektif': 'out-objektif',
                'in-dapatan': 'out-dapatan', 'in-isu': 'out-isu', 'in-nama': 'out-nama', 'in-jawatan': 'out-jawatan'
            };
            for (const [inputId, outputId] of Object.entries(mappings)) {
                document.getElementById(outputId).textContent = document.getElementById(inputId).value;
            }
            
            // DATE LOGIC (Multiple Days)
            const dateStart = document.getElementById('in-tarikh-mula').value;
            const dateEnd = document.getElementById('in-tarikh-tamat').value;
            let dateDisplay = "";

            if(dateStart) {
                const d1 = new Date(dateStart);
                const day1 = d1.getDate();
                const month1 = d1.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                const year1 = d1.getFullYear();

                if(dateEnd && dateEnd !== dateStart) {
                    const d2 = new Date(dateEnd);
                    const day2 = d2.getDate();
                    const month2 = d2.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                    const year2 = d2.getFullYear();
                    
                    if(year1 === year2 && month1 === month2) {
                        dateDisplay = `${day1} - ${day2} ${month1} ${year1}`;
                    } else if (year1 === year2) {
                        dateDisplay = `${day1} ${month1} - ${day2} ${month2} ${year1}`;
                    } else {
                        dateDisplay = `${day1} ${month1} ${year1} - ${day2} ${month2} ${year2}`;
                    }
                } else {
                    dateDisplay = `${day1} ${month1} ${year1}`;
                }
            }
            document.getElementById('out-tarikh').textContent = dateDisplay;
        }

        updatePreview();
    </script>
</body>
</html>
