<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penjana OPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Times+New+Roman&display=swap" rel="stylesheet">
    
    <style>
        /* CSS untuk Paparan Skrin */
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        
        /* CSS Khas untuk Format A4 & Cetakan */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', Times, serif; /* Font Rasmi Laporan */
            color: black;
            position: relative;
        }

        .opr-table { width: 100%; border-collapse: collapse; }
        .opr-table td, .opr-table th { border: 1px solid black; padding: 8px; vertical-align: top; }
        .opr-header { background-color: #e5e7eb; font-weight: bold; text-transform: uppercase; }

        /* Sembunyikan elemen UI bila Print */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .a4-paper { 
                box-shadow: none; 
                margin: 0; 
                width: 100%; 
                height: auto; 
                page-break-after: always;
            }
            @page { size: A4; margin: 0; }
        }

        /* Image Placeholder Style */
        .img-upload-box {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: all 0.2s;
        }
        .img-upload-box:hover { border-color: #4f46e5; background-color: #eef2ff; }
        .img-preview { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40 no-print">
        <div class="max-w-screen-2xl mx-auto py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-indigo-600">SPARK OPR</h1>
                    <p class="text-xs text-gray-500">Penjana Laporan Satu Halaman</p>
                </div>
            </div>
            <button onclick="window.history.back()" class="text-gray-500 hover:text-indigo-600 text-sm font-semibold flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Kembali
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col lg:flex-row gap-6 p-4 max-w-[1600px] mx-auto w-full">
        
        <div class="w-full lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-fit no-print overflow-y-auto max-h-[90vh]">
            
            <div class="mb-6 border-b pb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Pilih Program Sedia Ada</label>
                <div class="flex gap-2">
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                        <option value="">-- Manual / Kosong --</option>
                    </select>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">*Hanya program yang anda cipta/selaras akan muncul.</p>
            </div>

            <form id="opr-form" oninput="updatePreview()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tajuk Program</label>
                        <input type="text" id="input-title" class="w-full text-sm border-gray-300 rounded uppercase p-2" placeholder="PROGRAM..." value="MESYUARAT PENGURUSAN">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh</label>
                            <input type="date" id="input-date" class="w-full text-sm border-gray-300 rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tempat</label>
                            <input type="text" id="input-place" class="w-full text-sm border-gray-300 rounded uppercase p-2" placeholder="BILIK GERAKAN...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Anjuran / Unit</label>
                        <input type="text" id="input-organizer" class="w-full text-sm border-gray-300 rounded uppercase p-2" placeholder="UNIT ICT...">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Objektif (Satu per baris)</label>
                        <textarea id="input-objective" rows="3" class="w-full text-sm border-gray-300 rounded p-2" placeholder="1. Menyelaras tugas...&#10;2. Membentang laporan..."></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Impak / Rumusan (Satu per baris)</label>
                        <textarea id="input-impact" rows="3" class="w-full text-sm border-gray-300 rounded p-2" placeholder="1. 30 orang peserta hadir...&#10;2. Keputusan dicapai..."></textarea>
                    </div>
                </div>

                <div class="mt-6 border-t pt-4">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-3">Laporan Bergambar (Klik Kotak)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="file" id="file-1" class="hidden" accept="image/*" onchange="previewImage(this, 'img-1')">
                        <input type="file" id="file-2" class="hidden" accept="image/*" onchange="previewImage(this, 'img-2')">
                        <input type="file" id="file-3" class="hidden" accept="image/*" onchange="previewImage(this, 'img-3')">
                        <input type="file" id="file-4" class="hidden" accept="image/*" onchange="previewImage(this, 'img-4')">

                        <div class="img-upload-box h-24 rounded" onclick="document.getElementById('file-1').click()">
                            <span class="text-xs text-gray-400">Gambar 1</span>
                        </div>
                        <div class="img-upload-box h-24 rounded" onclick="document.getElementById('file-2').click()">
                            <span class="text-xs text-gray-400">Gambar 2</span>
                        </div>
                        <div class="img-upload-box h-24 rounded" onclick="document.getElementById('file-3').click()">
                            <span class="text-xs text-gray-400">Gambar 3</span>
                        </div>
                        <div class="img-upload-box h-24 rounded" onclick="document.getElementById('file-4').click()">
                            <span class="text-xs text-gray-400">Gambar 4</span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t">
                     <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Disediakan Oleh (Nama & Jawatan)</label>
                     <input type="text" id="input-prepared" class="w-full text-sm border-gray-300 rounded uppercase p-2 font-bold" value="">
                     <input type="text" id="input-jawatan" class="w-full text-xs border-gray-300 rounded uppercase p-2 mt-1" placeholder="JAWATAN (CTH: PENYELARAS PROGRAM)">
                </div>

                <div class="mt-8 sticky bottom-0 bg-white pt-2">
                    <button type="button" onclick="window.print()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex justify-center items-center gap-2 uppercase transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                        Cetak / Simpan PDF
                    </button>
                    <p class="text-[10px] text-center text-gray-400 mt-2">Pastikan tetapan printer: "Background Graphics" dihidupkan.</p>
                </div>
            </form>
        </div>

        <div class="w-full lg:w-2/3 flex justify-center bg-gray-200 p-4 lg:p-8 rounded-xl overflow-auto">
            
            <div class="a4-paper" id="print-area">
                
                <div class="flex items-center justify-between border-b-2 border-black pb-4 mb-4">
                    <div class="flex items-center gap-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-20 w-auto" alt="Jata Negara">
                        <div>
                            <h2 class="text-lg font-bold uppercase leading-tight">PEJABAT PENDIDIKAN DAERAH MIRI</h2>
                            <p class="text-sm">LAPORAN BERGAMBAR / ONE PAGE REPORT (OPR)</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <h1 id="view-title" class="text-xl font-bold uppercase border-2 border-black py-2 px-4 inline-block bg-gray-100">
                        TAJUK PROGRAM
                    </h1>
                </div>

                <table class="opr-table mb-6 text-sm">
                    <tr>
                        <th class="w-1/4 opr-header text-left">TARIKH</th>
                        <td id="view-date" class="w-1/4 uppercase"></td>
                        <th class="w-1/4 opr-header text-left">TEMPAT</th>
                        <td id="view-place" class="w-1/4 uppercase"></td>
                    </tr>
                    <tr>
                        <th class="opr-header text-left">ANJURAN</th>
                        <td colspan="3" id="view-organizer" class="uppercase"></td>
                    </tr>
                    <tr>
                        <th class="opr-header text-left align-top">OBJEKTIF</th>
                        <td colspan="3" class="align-top">
                            <ul id="view-objective" class="list-disc pl-5 m-0 space-y-1"></ul>
                        </td>
                    </tr>
                    <tr>
                        <th class="opr-header text-left align-top">IMPAK / RUMUSAN</th>
                        <td colspan="3" class="align-top">
                            <ul id="view-impact" class="list-disc pl-5 m-0 space-y-1"></ul>
                        </td>
                    </tr>
                </table>

                <div class="mb-6">
                    <h3 class="font-bold border-b border-black mb-2 text-sm uppercase">LAPORAN BERGAMBAR</h3>
                    <div class="grid grid-cols-2 gap-2 h-[120mm]">
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 relative">
                            <img id="img-1" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <span class="text-gray-300 text-xs text-center p-2 placeholder-text">Gambar 1</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 relative">
                            <img id="img-2" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <span class="text-gray-300 text-xs text-center p-2 placeholder-text">Gambar 2</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 relative">
                            <img id="img-3" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <span class="text-gray-300 text-xs text-center p-2 placeholder-text">Gambar 3</span>
                        </div>
                        <div class="border border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 relative">
                            <img id="img-4" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <span class="text-gray-300 text-xs text-center p-2 placeholder-text">Gambar 4</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <div class="text-center w-1/3">
                        <p class="text-sm mb-8">Disediakan Oleh:</p>
                        <p id="view-prepared" class="font-bold uppercase border-b border-black pb-1 mb-1">NAMA PEGAWAI</p>
                        <p id="view-jawatan" class="text-xs uppercase">JAWATAN</p>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let currentUserIc = "";
        let allMyPrograms = [];

        // Auth Check & Load Data
        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');

            if (!currentUserIc) {
                alert("Sila log masuk dari Halaman Utama.");
                window.location.href = 'index.html';
                return;
            }

            // Load User Details (Untuk Nama Disediakan Oleh)
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", currentUserIc));
            const userSnap = await getDocs(qUser);
            
            if (!userSnap.empty) {
                const uData = userSnap.docs[0].data();
                document.getElementById('input-prepared').value = uData.name.toUpperCase();
                document.getElementById('input-organizer').value = (uData.unit || uData.sector || "").toUpperCase();
                updatePreview();
            }

            // Load Programs for Dropdown
            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            // Query 1: Created By Me
            const q1 = query(progRef, where("createdBy", "==", currentUserIc));
            // Query 2: I am Admin/Penyelaras
            const q2 = query(progRef, where("penyelaras_ic", "==", currentUserIc));
            
            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const programMap = new Map();
            snap1.forEach(doc => programMap.set(doc.id, { id: doc.id, ...doc.data() }));
            snap2.forEach(doc => programMap.set(doc.id, { id: doc.id, ...doc.data() }));

            const select = document.getElementById('program-select');
            programMap.forEach(prog => {
                const opt = document.createElement('option');
                opt.value = prog.id;
                opt.textContent = prog.name.toUpperCase();
                select.appendChild(opt);
                allMyPrograms.push(prog);
            });
        });

        // Global functions untuk HTML events
        window.importProgramData = function(progId) {
            if(!progId) return;
            const prog = allMyPrograms.find(p => p.id === progId);
            if(prog) {
                document.getElementById('input-title').value = prog.name.toUpperCase();
                document.getElementById('input-place').value = prog.location.toUpperCase();
                // Tarikh format YYYY-MM-DD
                if(prog.startDate) {
                    document.getElementById('input-date').value = prog.startDate;
                }
                
                // Cuba format objektif jika ada dalam description atau array
                if(prog.description) {
                     document.getElementById('input-objective').value = prog.description;
                }

                updatePreview();
            }
        }

        window.updatePreview = function() {
            // Bind Input Values to Preview Elements
            document.getElementById('view-title').textContent = document.getElementById('input-title').value || "TAJUK PROGRAM";
            
            const dateVal = document.getElementById('input-date').value;
            if(dateVal) {
                 const d = new Date(dateVal);
                 document.getElementById('view-date').textContent = d.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
            } else {
                document.getElementById('view-date').textContent = "";
            }

            document.getElementById('view-place').textContent = document.getElementById('input-place').value;
            document.getElementById('view-organizer').textContent = document.getElementById('input-organizer').value;
            
            document.getElementById('view-prepared').textContent = document.getElementById('input-prepared').value;
            document.getElementById('view-jawatan').textContent = document.getElementById('input-jawatan').value;

            // List Processing (Objektif & Impak)
            const objText = document.getElementById('input-objective').value;
            const impactText = document.getElementById('input-impact').value;
            
            renderList(objText, 'view-objective');
            renderList(impactText, 'view-impact');
        }

        function renderList(text, elementId) {
            const ul = document.getElementById(elementId);
            ul.innerHTML = "";
            if(text) {
                const lines = text.split('\n');
                lines.forEach(line => {
                    if(line.trim()) {
                        const li = document.createElement('li');
                        li.textContent = line.trim().replace(/^[0-9\-\.\)]+\s*/, ''); // Buang numbering manual user
                        ul.appendChild(li);
                    }
                });
            }
        }

        window.previewImage = function(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    // Hide placeholder text sibling
                    img.nextElementSibling.classList.add('hidden');
                    
                    // Update trigger box also for UX
                    const triggerIndex = imgId.split('-')[1]; // 1,2,3,4
                    const box = document.querySelectorAll('.img-upload-box')[triggerIndex-1];
                    box.style.backgroundImage = `url('${e.target.result}')`;
                    box.style.backgroundSize = 'cover';
                    box.style.backgroundPosition = 'center';
                    box.querySelector('span').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Initialize preview on load
        updatePreview();
    </script>
</body>
</html>
