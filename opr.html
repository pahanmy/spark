<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Penjana OPR Pro (Final Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        
        /* WRAPPER BARU UNTUK PDF - TIADA MARGIN/PADDING */
        #pdf-wrapper {
            width: 210mm;
            margin: 0;
            padding: 0;
            background: white; 
        }

        /* A4 Paper Settings */
        .a4-paper {
            width: 210mm; min-height: 297mm; height: 297mm; 
            padding-left: 15mm; padding-right: 15mm; padding-bottom: 10mm; padding-top: 10mm;
            margin: 0 auto; 
            margin-bottom: 0px; 
            background: white; box-shadow: 0 0 25px rgba(0,0,0,0.1);
            font-family: Arial, Helvetica, sans-serif; color: black; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* Jarakkan kertas HANYA di skrin biasa */
        @media screen {
            #pdf-wrapper .a4-paper { margin-bottom: 20px; }
        }

        /* --- TAMBAH INI DI DALAM <style> --- */

/* Style untuk butang naik/turun */
.sort-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    cursor: pointer;
    margin: 0 2px;
}
.sort-btn:hover { background: #e5e7eb; color: #4f46e5; }

/* Pastikan kolom butang HILANG bila print/PDF */
@media print {
    .no-print-col { display: none !important; }
}
        /* Background Overlay */
        .paper-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            z-index: 0; pointer-events: none; opacity: 0.1;
        }
        .paper-content { position: relative; z-index: 10; flex-grow: 1; display: flex; flex-direction: column; }
        
        /* Table Styles */
        .opr-table { width: 100%; border-collapse: collapse; margin-bottom: 0.8rem; background: rgba(255,255,255,0.85); }
        .opr-table td, .opr-table th { border: 1px solid black; padding: 4px 6px; vertical-align: top; }
        .opr-header { background-color: rgba(240, 253, 244, 0.95); font-weight: bold; text-transform: uppercase; width: 25%; }
        
        /* --- STYLE JADUAL KEHADIRAN --- */
        .att-table { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; margin-bottom: 10px; }
        .att-table th { background-color: #f3f4f6; border: 1px solid #000; padding: 8px 8px; text-transform: uppercase; font-weight: bold; color: #000; }
        .att-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; color: #000; }
        .att-table tr:nth-child(even) { background-color: #fafafa; }

        /* Upload Box */
        .img-upload-box {
            background-color: #f8fafc; border: 2px dashed #cbd5e1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: grab; position: relative; height: 100px;
            transition: all 0.3s ease;
        }
        .img-upload-box:hover { border-color: #4f46e5; background-color: #e0e7ff; }
        .img-upload-box:active { cursor: grabbing; }
        .img-upload-box.dragging { opacity: 0.5; border-color: #f59e0b; }
        .img-upload-box.drag-over { background-color: #fef3c7; border-color: #d97706; transform: scale(1.02); }

        /* FIX GAMBAR PDF - 16:9 Aspect Ratio */
        .report-img-container {
            width: 100%; 
            aspect-ratio: 16 / 9; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative; 
            background-color: transparent; 
            border: 1px solid #cbd5e1; 
        }
        .report-img-container img {
            width: 100%; height: 100%;
            object-fit: cover; 
            display: block;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Modal */
        .modal-backdrop { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .cropper-container { max-height: 60vh; background: #000; overflow: hidden; }
        .cropper-container img { max-width: 100%; display: block; }

        /* Signature Canvas */
        canvas#signature-pad { touch-action: none; } 

        /* --- PRINT SETTINGS --- */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            #pdf-wrapper { width: 100%; margin: 0; padding: 0; }
            
            .a4-paper { 
                box-shadow: none; margin: 0 !important; width: 100%; min-height: 297mm; height: auto !important; 
                page-break-after: always !important; page-break-inside: avoid;
                padding-top: 10mm !important; background-color: white !important;
            }
            .force-break { page-break-before: always !important; margin-top: 0 !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-md">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-indigo-700 uppercase tracking-wide flex items-center gap-2">
                        SPARK OPR
                        <span id="account-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">Memuatkan...</span>
                    </h1>
                    <p class="text-xs text-gray-500">Penjana Laporan & Kehadiran (AI Powered)</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-indigo-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Kembali
                </button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button onclick="downloadPDFOnly()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-xs font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 uppercase transition-all">
                    Download Sahaja
                </button>
                <button onclick="saveAndDownload()" id="btn-save" class="bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white text-xs font-bold py-2 px-5 rounded-lg shadow-md flex items-center gap-2 uppercase transition-transform hover:scale-105">
                    Simpan & PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar">
            
            <div class="flex gap-3 mb-5">
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Sejarah</label>
                    <select id="history-select" onchange="loadHistory(this.value)" class="w-full text-xs border border-gray-300 rounded bg-white focus:ring-1 focus:ring-indigo-500 h-9">
                        <option value="">-- Pilih Rekod --</option>
                    </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Import Program</label>
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-xs border border-blue-300 rounded bg-blue-50 focus:ring-1 focus:ring-blue-500 h-9">
                        <option value="">-- Pilih Program --</option>
                    </select>
                </div>
            </div>

            <div class="flex p-1 bg-gray-100 rounded-lg mb-5 border border-gray-200">
                <button onclick="showTab('form')" id="tab-btn-form" class="flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-indigo-600 transition-all">Isi Borang</button>
                <button onclick="showTab('history')" id="tab-btn-history" class="flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Sejarah</button>
                <button onclick="showTab('settings')" id="tab-btn-settings" class="flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Tetapan</button>
            </div>

            <div id="tab-content-form" class="block space-y-5">
                <input type="hidden" id="report-id">
                <input type="hidden" id="opr-serial-hidden"> 
                
                <div class="bg-white p-1">
                    <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                        <span class="w-1.5 h-4 bg-indigo-500 rounded-full"></span> Tajuk Program
                    </label>
                    <input type="text" id="in-tajuk" oninput="updatePreview()" class="w-full text-sm border-2 border-indigo-100 rounded-lg p-2.5 uppercase focus:border-indigo-500 focus:ring-0 transition-colors shadow-sm" value="LAPORAN PROGRAM">
                    
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Tarikh Mula</label>
                            <input type="date" id="in-tarikh-mula" oninput="updatePreview()" class="w-full text-xs border-2 border-indigo-100 rounded-lg p-2 focus:border-indigo-500 bg-white shadow-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Tarikh Tamat</label>
                            <input type="date" id="in-tarikh-tamat" oninput="updatePreview()" class="w-full text-xs border-2 border-indigo-100 rounded-lg p-2 focus:border-indigo-500 bg-white shadow-sm">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-red-500 rounded-full"></span> Lokasi
                        </label>
                        <input type="text" id="in-tempat" oninput="updatePreview()" class="w-full text-sm border-2 border-indigo-100 rounded-lg p-2.5 uppercase focus:border-red-500 transition-colors shadow-sm bg-white">
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-600 uppercase flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-blue-500 rounded-full"></span> Fokus / Objektif
                        </label>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="askAI('objektif')" class="text-[9px] bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-2 py-0.5 rounded shadow hover:opacity-90 flex items-center gap-1 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                Bantu Saya ✨
                            </button>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="chk-objektif" class="w-3 h-3 text-blue-600 rounded" onchange="updatePreview()">
                                <span class="ml-1 text-[9px] font-bold text-gray-500 uppercase">Bullet</span>
                            </label>
                        </div>
                    </div>
                    <textarea id="in-objektif" oninput="updatePreview()" rows="3" class="w-full text-sm border-2 border-blue-100 rounded-lg p-3 focus:border-blue-500 bg-white shadow-sm transition-colors" placeholder="AI boleh bantu tuliskan..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-gray-600 uppercase flex items-center gap-1">
                                <span class="w-1.5 h-4 bg-green-500 rounded-full"></span> IMPAK
                            </label>
                            <div class="flex items-center gap-1">
                                <button type="button" onclick="askAI('kekuatan')" class="text-[8px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded hover:bg-yellow-200 border border-yellow-200 font-bold flex items-center gap-1">
                                    AI PRO <svg class="w-2 h-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <input type="checkbox" id="chk-dapatan" class="w-3 h-3 text-green-600 rounded" onchange="updatePreview()" title="Mod Senarai">
                            </div>
                        </div>
                        <textarea id="in-dapatan" oninput="updatePreview()" rows="4" class="w-full text-sm border-2 border-green-100 rounded-lg p-2 focus:border-green-500 bg-green-50/20 shadow-sm" placeholder="Taip manual atau guna AI (Pro)..."></textarea>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-gray-600 uppercase flex items-center gap-1">
                                <span class="w-1.5 h-4 bg-orange-500 rounded-full"></span> Isu / Tindakan
                            </label>
                            <div class="flex items-center gap-1">
                                <button type="button" onclick="askAI('isu')" class="text-[8px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded hover:bg-yellow-200 border border-yellow-200 font-bold flex items-center gap-1">
                                    AI PRO <svg class="w-2 h-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <input type="checkbox" id="chk-isu" class="w-3 h-3 text-orange-600 rounded" onchange="updatePreview()" title="Mod Senarai">
                            </div>
                        </div>
                        <textarea id="in-isu" oninput="updatePreview()" rows="4" class="w-full text-sm border-2 border-orange-100 rounded-lg p-2 focus:border-orange-500 bg-orange-50/20 shadow-sm" placeholder="Taip manual atau guna AI (Pro)..."></textarea>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-600 uppercase flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-gray-500 rounded-full"></span> Catatan
                        </label>
                        <label class="flex items-center cursor-pointer bg-gray-100 px-2 py-1 rounded border border-gray-200 hover:bg-gray-200">
                            <input type="checkbox" id="chk-catatan" class="w-3 h-3 text-gray-600 rounded" onchange="updatePreview()">
                            <span class="ml-1 text-[9px] font-bold text-gray-500 uppercase">Sertakan Catatan</span>
                        </label>
                    </div>
                    <textarea id="in-catatan" oninput="updatePreview()" rows="2" class="hidden w-full text-sm border-2 border-gray-300 rounded-lg p-2 focus:border-gray-500 bg-gray-50 shadow-sm mb-3" placeholder="Tulis catatan tambahan di sini..."></textarea>
                </div>

                <div class="bg-indigo-50 p-2 rounded border border-indigo-200">
                    <div class="mt-2 flex items-center justify-between bg-white p-2 rounded border border-gray-200 shadow-sm">
    <span class="text-[10px] font-bold text-gray-500 uppercase">Mod Susunan:</span>
    <label class="flex items-center cursor-pointer">
        <input type="checkbox" id="chk-manual-sort" class="w-3 h-3 text-orange-500 rounded" onchange="renderAttendanceTable()">
        <span class="ml-1 text-[9px] font-bold text-orange-600 uppercase">Susun Manual (Ada Butang)</span>
    </label>
</div>
                    <div class="flex justify-between items-center">
                         <label class="text-xs font-bold text-indigo-700 uppercase flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-indigo-500 rounded-full"></span> Lampiran Kehadiran
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="chk-attendance" class="w-3 h-3 text-indigo-600 rounded" onchange="updatePreview()">
                            <span class="ml-1 text-[9px] font-bold text-gray-500 uppercase">Sertakan Senarai</span>
                        </label>
                    </div>
                    <p id="att-count-label" class="text-[9px] text-indigo-500 mt-1 italic">0 peserta dikesan.</p>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-600 uppercase flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-purple-500 rounded-full"></span> Pautan Dokumentasi
                        </label>
                        <label class="flex items-center cursor-pointer bg-purple-50 px-2 py-1 rounded border border-purple-200 hover:bg-purple-100">
                            <input type="checkbox" id="chk-link-dokumen" class="w-3 h-3 text-purple-600 rounded" onchange="updatePreview()">
                            <span class="ml-1 text-[9px] font-bold text-purple-700 uppercase">Sertakan QR</span>
                        </label>
                    </div>
                    <input type="url" id="in-link-dokumen" oninput="updatePreview()" class="hidden w-full text-xs border-2 border-purple-200 rounded-lg p-2 focus:border-purple-500 bg-white shadow-sm mb-3" placeholder="Tampal Pautan (Google Drive/Photos) di sini...">
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-600 uppercase">Laporan Gambar</label>
                        <button onclick="toggleImageCount()" id="btn-toggle-img" class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition-colors font-bold uppercase">
                            + Tambah Gambar (4)
                        </button>
                    </div>

                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="chk-show-caption" class="w-3 h-3 text-indigo-600 rounded" onchange="updatePreview()" checked>
                        <span class="ml-1 text-[10px] font-bold text-gray-500 uppercase">Paparkan Kapsyen</span>
                    </div>
                    
                    <input type="file" id="temp-file-input" class="hidden" accept="image/*" onchange="openCropModal(this)">

                    <div class="grid grid-cols-2 gap-3" id="input-image-grid">
                        <div>
                            <div class="img-upload-box rounded-lg shadow-sm bg-white" id="box-0" onclick="triggerUpload(0)" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" data-index="0">
                                <img id="thumb-0" src="" class="hidden w-full h-full object-cover rounded-lg">
                                <span id="label-0" class="text-[9px] font-bold text-gray-400 uppercase">Gambar 1</span>
                            </div>
                            <input type="text" id="in-cap-0" placeholder="Kapsyen Gambar 1" oninput="updatePreview()" class="w-full text-[10px] border border-gray-300 rounded mt-1 p-1.5 focus:border-indigo-500 focus:outline-none text-center bg-white">
                        </div>
                        <div>
                            <div class="img-upload-box rounded-lg shadow-sm bg-white" id="box-1" onclick="triggerUpload(1)" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" data-index="1">
                                <img id="thumb-1" src="" class="hidden w-full h-full object-cover rounded-lg">
                                <span id="label-1" class="text-[9px] font-bold text-gray-400 uppercase">Gambar 2</span>
                            </div>
                            <input type="text" id="in-cap-1" placeholder="Kapsyen Gambar 2" oninput="updatePreview()" class="w-full text-[10px] border border-gray-300 rounded mt-1 p-1.5 focus:border-indigo-500 focus:outline-none text-center bg-white">
                        </div>
                        <div id="container-2" class="hidden">
                            <div class="img-upload-box rounded-lg shadow-sm bg-white" id="box-2" onclick="triggerUpload(2)" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" data-index="2">
                                <img id="thumb-2" src="" class="hidden w-full h-full object-cover rounded-lg">
                                <span id="label-2" class="text-[9px] font-bold text-gray-400 uppercase">Gambar 3</span>
                            </div>
                            <input type="text" id="in-cap-2" placeholder="Kapsyen Gambar 3" oninput="updatePreview()" class="w-full text-[10px] border border-gray-300 rounded mt-1 p-1.5 focus:border-indigo-500 focus:outline-none text-center bg-white">
                        </div>
                        <div id="container-3" class="hidden">
                            <div class="img-upload-box rounded-lg shadow-sm bg-white" id="box-3" onclick="triggerUpload(3)" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" data-index="3">
                                <img id="thumb-3" src="" class="hidden w-full h-full object-cover rounded-lg">
                                <span id="label-3" class="text-[9px] font-bold text-gray-400 uppercase">Gambar 4</span>
                            </div>
                            <input type="text" id="in-cap-3" placeholder="Kapsyen Gambar 4" oninput="updatePreview()" class="w-full text-[10px] border border-gray-300 rounded mt-1 p-1.5 focus:border-indigo-500 focus:outline-none text-center bg-white">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Disediakan Oleh</label>
                    <input type="text" id="in-nama" oninput="updatePreview()" class="w-full text-sm border border-gray-300 rounded p-2 uppercase font-bold mb-2 bg-white" placeholder="NAMA PEGAWAI">
                    <input type="text" id="in-jawatan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 uppercase bg-white" placeholder="JAWATAN">
                    
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="chk-signature" class="w-3 h-3 text-indigo-600 rounded" onchange="toggleSignature()">
                                <span class="ml-1 text-[10px] font-bold text-gray-500 uppercase">Sertakan Tandatangan</span>
                            </div>
                            <button id="btn-delete-default-sig" onclick="deleteDefaultSignature()" class="hidden text-[9px] text-red-500 hover:text-red-700 underline font-semibold">Padam Rekod Tetap</button>
                        </div>
                        
                        <div id="sig-input-container" class="hidden space-y-3">
                             <div class="border border-gray-300 rounded-lg bg-white overflow-hidden">
                                <div class="bg-gray-100 px-3 py-1 border-b border-gray-200 flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">Lukis Tandatangan</span>
                                    <button onclick="clearSignature()" class="text-[9px] text-red-600 hover:text-red-800 font-bold uppercase">Padam</button>
                                </div>
                                <div class="relative w-full h-32 bg-white cursor-crosshair">
                                    <canvas id="signature-pad" class="w-full h-full block"></canvas>
                                    <div id="sig-instruction" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-300 text-[10px] font-bold uppercase">
                                        Lukis di sini
                                    </div>
                                </div>
                             </div>

                             <div class="relative flex py-1 items-center">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="flex-shrink-0 mx-2 text-[9px] text-gray-400 uppercase">Atau Muat Naik</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>

                             <div>
                                <input type="file" id="sig-upload" accept="image/*" class="w-full text-[10px] text-gray-500" onchange="handleSigUpload(this)">
                             </div>

                             <div class="bg-blue-50 border border-blue-100 p-2 rounded flex items-center">
                                <input type="checkbox" id="chk-save-default-sig" class="w-3 h-3 text-blue-600 rounded">
                                <span class="ml-2 text-[9px] font-bold text-blue-700 uppercase">Simpan sebagai Tandatangan Tetap (Rekod Seterusnya)</span>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-content-history" class="hidden">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-xs font-bold text-gray-700 uppercase">Rekod Laporan</h3>
                    <div class="bg-indigo-50 border border-indigo-100 px-3 py-1 rounded-lg">
                        <span class="text-[10px] text-gray-500 uppercase font-bold">Jumlah Dijana:</span>
                        <span id="history-count" class="text-sm font-bold text-indigo-600 ml-1">0</span>
                    </div>
                </div>

                <div id="limit-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded-r-md shadow-sm">
                    <p class="text-xs text-yellow-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        <strong>Perhatian:</strong> Akaun Biasa terhad kepada 5 rekod terkini.
                    </p>
                </div>

                <div class="overflow-hidden rounded-lg border border-gray-200 shadow-sm bg-white">
                    <table class="min-w-full text-xs text-left text-gray-600">
                        <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-3 py-3 font-bold tracking-wider">Tarikh</th>
                                <th class="px-3 py-3 font-bold tracking-wider">Tajuk Program</th>
                                <th class="px-3 py-3 font-bold text-center tracking-wider w-24">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-100">
                            <tr><td colspan="3" class="px-3 py-8 text-center text-gray-400 italic">Sedang memuatkan data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-content-settings" class="hidden space-y-4">
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-3">Latar Belakang (Watermark)</label>
                    <input type="file" id="bg-upload" accept="image/*" class="w-full text-xs mb-3 text-gray-500" onchange="changeBackground(this)">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Kelegapan (Opacity)</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">0%</span>
                        <input type="range" id="bg-opacity" min="0" max="1" step="0.05" value="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="adjustBgOpacity(this.value)">
                        <span class="text-xs text-gray-500">100%</span>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Saiz Kandungan (Laporan Utama)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustFontSize(-1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="font-size-display" class="text-sm font-bold text-indigo-600">8pt</span>
                        <button onclick="adjustFontSize(1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Jarak Baris (Line Spacing)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustLineHeight(-0.1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="line-height-display" class="text-sm font-bold text-indigo-600">1.2</span>
                        <button onclick="adjustLineHeight(0.1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-teal-700 uppercase mb-2">Tetapan Jadual Kehadiran</label>
                    
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Baris Per Halaman (Default: 15)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="rows-per-page-input" value="15" min="5" max="50" 
                                   onchange="updateRowsPerPage(this.value)" 
                                   class="w-full text-sm border border-gray-300 rounded p-1.5 focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </div>

                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Saiz Font Jadual</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustAttFontSize(-1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="att-font-size-display" class="text-sm font-bold text-teal-600">9pt</span>
                        <button onclick="adjustAttFontSize(1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-indigo-700 uppercase mb-2 flex justify-between">Saiz Tajuk Header <span class="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded">PRO</span></label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustHeaderSize(-1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">-</button>
                        <span id="header-size-display" class="text-sm font-bold text-indigo-600">14pt</span>
                        <button onclick="adjustHeaderSize(1)" class="w-8 h-8 bg-gray-100 rounded hover:bg-gray-200 font-bold">+</button>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Logo & Nama Organisasi</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full text-xs mb-3 text-gray-500" onchange="changeLogo(this)">
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-2 border-gray-100 rounded p-2 uppercase mb-2" value="KEMENTERIAN PENDIDIKAN MALAYSIA">
                    <input type="text" id="in-sub-org" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 uppercase" value="PEJABAT PENDIDIKAN DAERAH MIRI">
                </div>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-100 overflow-auto flex justify-center p-8">
            <div id="pdf-wrapper">
                
                <div class="a4-paper transform scale-100 origin-top" id="main-report">
                    <div id="paper-bg" class="paper-background"></div>

                    <div class="paper-content">
                        
                        <div class="flex items-center justify-between border-b-2 border-black pb-3 mb-3">
                            <div class="flex items-center gap-4">
                                <img id="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-20 w-auto object-contain" alt="Logo">
                                <div>
                                    <h2 id="out-org-name" class="font-bold uppercase leading-tight" style="font-size: 14pt;">KEMENTERIAN PENDIDIKAN MALAYSIA</h2>
                                    <p id="out-sub-org" class="text-sm uppercase mt-1">PEJABAT PENDIDIKAN DAERAH MIRI</p>
                                </div>
                            </div>

                            <div class="flex flex-col items-end pl-4">
                                 <svg id="barcode"></svg>
                            </div>
                        </div>

                        <div class="text-center mb-3">
                            <h1 id="out-tajuk" class="font-bold uppercase inline-block bg-white/90" style="font-size: 12pt;">LAPORAN PROGRAM</h1>
                        </div>

                        <table class="opr-table" id="main-table" style="font-size: 8pt;">
                            <tr>
                                <th class="opr-header">
                                    <div class="flex items-center gap-1">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg> 
                                        TARIKH
                                    </div>
                                </th>
                                <td id="out-tarikh" class="w-1/4 uppercase"></td>
                                
                                <th class="opr-header">
                                    <div class="flex items-center gap-1">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg> 
                                        LOKASI
                                    </div>
                                </th>
                                <td id="out-tempat" class="uppercase"></td>
                            </tr>
                            <tr>
                                <th class="opr-header align-top">
                                    <div class="flex items-center gap-1">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <circle cx="12" cy="12" r="6"></circle>
                                            <circle cx="12" cy="12" r="2"></circle>
                                        </svg> 
                                        FOKUS
                                    </div>
                                </th>
                                <td colspan="3" class="align-top"><div id="out-objektif" class="whitespace-pre-wrap"></div></td>
                            </tr>
                            <tr>
                                <th class="opr-header align-top">
                                    <div class="flex items-center gap-1">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                                            <polyline points="16 7 22 7 22 13"></polyline>
                                        </svg> 
                                        IMPAK
                                    </div>
                                </th>
                                <td colspan="3" class="align-top bg-green-50/50"><div id="out-dapatan" class="whitespace-pre-wrap"></div></td>
                            </tr>
                            <tr>
                                <th class="opr-header align-top">
                                    <div class="flex items-center gap-1">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg> 
                                        ISU/TINDAKAN
                                    </div>
                                </th>
                                <td colspan="3" class="align-top bg-red-50/50"><div id="out-isu" class="whitespace-pre-wrap text-red-900"></div></td>
                            </tr>
                        </table>

                        <div id="row-catatan" class="hidden mb-3 border border-black p-2 bg-white/80 relative">
                             <h3 class="text-[8pt] font-bold uppercase border-b border-gray-300 mb-1 inline-block pr-4">Catatan</h3>
                             <div id="out-catatan" class="text-[8pt] whitespace-pre-wrap"></div>
                        </div>

                        <div class="mt-3 border border-black p-1 bg-white/80">
                            <h3 class="text-[8pt] font-bold uppercase bg-gray-100 p-1 border-b border-black text-center mb-1">LAPORAN BERGAMBAR</h3>
                            <div id="preview-image-grid" class="grid grid-cols-2 gap-2"> 
                                <div class="report-img-container" id="prev-box-0">
                                    <img id="prev-img-0" src="" class="hidden">
                                    <span id="prev-cap-0" class="absolute bottom-0 w-full bg-white/90 text-black font-bold border-t border-gray-200 text-[8pt] text-center py-1 hidden">Gambar 1</span>
                                </div>
                                <div class="report-img-container" id="prev-box-1">
                                    <img id="prev-img-1" src="" class="hidden">
                                    <span id="prev-cap-1" class="absolute bottom-0 w-full bg-white/90 text-black font-bold border-t border-gray-200 text-[8pt] text-center py-1 hidden">Gambar 2</span>
                                </div>
                                <div class="report-img-container hidden" id="prev-box-2">
                                    <img id="prev-img-2" src="" class="hidden">
                                    <span id="prev-cap-2" class="absolute bottom-0 w-full bg-white/90 text-black font-bold border-t border-gray-200 text-[8pt] text-center py-1 hidden">Gambar 3</span>
                                </div>
                                <div class="report-img-container hidden" id="prev-box-3">
                                    <img id="prev-img-3" src="" class="hidden">
                                    <span id="prev-cap-3" class="absolute bottom-0 w-full bg-white/90 text-black font-bold border-t border-gray-200 text-[8pt] text-center py-1 hidden">Gambar 4</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-end mt-auto mb-2"> <div id="out-link-container" class="hidden flex flex-col items-start pl-2">
                                 <div class="flex items-center gap-1 text-[8pt] font-bold text-gray-600 uppercase mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="#4b5563"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg>
                                    Dokumentasi Program : rujuk sini
                                 </div>
                                 <img id="out-qr-dokumen" src="" class="w-16 h-16 border border-gray-300 p-1 bg-white">
                            </div>

                            <div class="text-center w-1/3 flex flex-col items-center ml-auto">
                                <p class="text-[8pt] italic mb-1 self-start w-full text-left">Disediakan Oleh:</p>
                                
                                <div class="h-16 w-full flex items-end justify-center mb-1">
                                     <img id="out-sig-img" class="h-full w-auto object-contain hidden" src="">
                                </div>

                                <div class="border-b border-black w-full mb-1"></div>
                                <p id="out-nama" class="font-bold uppercase leading-tight text-[9pt]">NAMA PEGAWAI</p>
                                <p id="out-jawatan" class="text-[8pt] uppercase mt-0.5">JAWATAN</p>
                            </div>
                        </div>

                        <div class="border-t border-gray-300 pt-1 flex justify-between items-center text-[7px] text-gray-400 uppercase tracking-wider">
                            <span class="flex items-center gap-1">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="#818cf8"><path d="M4 4H8V8H4V4Z"></path><path d="M4 16H8V20H4V16Z"></path><path d="M16 4H20V8H16V4Z"></path><path d="M10 4H14V6H10V4Z"></path><path d="M10 8H12V10H10V8Z"></path><path d="M12 12H14V14H12V12Z"></path></svg>
                                Dijana oleh SPARK
                            </span>
                            <span>Tarikh Cetakan: <span id="print-date"></span></span>
                        </div>
                    </div>
                </div>

                <div class="a4-paper transform scale-100 origin-top hidden" id="attendance-page">
                    <div class="paper-content">
                        <div class="border-b-2 border-black pb-2 mb-4">
                            <h2 class="font-bold uppercase text-lg text-black">LAMPIRAN: SENARAI KEHADIRAN</h2>
                            <div class="flex justify-between items-end">
                                <p class="text-sm uppercase text-gray-700 w-3/4 att-subtitle-el">PROGRAM: </p>
                                <p class="text-xs text-gray-500 italic text-right">Dijana pada: <span class="att-print-date-el"></span></p>
                            </div>
                        </div>
                        
                        <div class="overflow-hidden flex-grow">
                            <table class="att-table">
                                <thead>
                                    <tr>
                                        <th class="w-10 text-center">BIL.</th>
                                        <th>NAMA PESERTA</th>
                                        <th class="w-1/5">JAWATAN</th>
                                        <th class="w-1/4">STESEN / SEKOLAH</th>
                                        <th class="w-24 text-center">STATUS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 flex justify-end att-footer-count" style="visibility: hidden;">
                            <div class="border border-black p-2 px-4 bg-gray-50 text-right">
                                <span class="text-xs font-bold uppercase mr-2">Jumlah Kehadiran:</span>
                                <span class="att-total-count-el text-sm font-bold text-black">0</span>
                            </div>
                        </div>

                        <div class="mt-auto pt-4 border-t border-gray-300 text-[8pt] text-gray-400 text-center uppercase italic">
                            Dokumen ini dijana secara komputer. Tandatangan tidak diperlukan.
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="crop-modal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-4">
            <h3 class="text-sm font-bold uppercase mb-2">Potong Gambar (16:9)</h3>
            <div class="cropper-container mb-3 h-64 bg-gray-900 rounded">
                <img id="image-to-crop" src="">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeCropModal()" class="px-4 py-2 bg-gray-200 text-xs font-bold rounded uppercase">Batal</button>
                <button onclick="applyCrop()" class="px-4 py-2 bg-indigo-600 text-white text-xs font-bold rounded uppercase">Potong & Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        window.currentUserIc = "";
        window.currentUserDocId = ""; 
        window.allMyPrograms = [];
        window.allMyReports = [];
        window.attendanceData = []; 
        window.currentFontSize = 8; 
        window.currentHeaderSize = 14;
        window.currentLineHeight = 1.2;
        window.currentAttFontSize = 9; 
        window.currentRowsPerPage = 15; 


        // --- FUNGSI GERAKKAN BARIS (MANUAL SORT) ---
        // PENTING: Wajib ada "window." di depan supaya butang HTML boleh baca
        window.moveItem = function(index, direction) {
            // Pastikan data wujud
            if (!window.attendanceData) return;

            const list = window.attendanceData;
            const newIndex = index + direction;

            // Elak error jika dah paling atas atau paling bawah
            if (newIndex < 0 || newIndex >= list.length) return;

            // Tukar tempat (Swap data dalam array)
            const temp = list[index];
            list[index] = list[newIndex];
            list[newIndex] = temp;

            // Render semula jadual dengan susunan baru
            // Pastikan renderAttendanceTable juga ada "window."
            if (typeof window.renderAttendanceTable === "function") {
                window.renderAttendanceTable();
            } else {
                console.error("Ralat: renderAttendanceTable tidak dijumpai.");
            }
        }

        window.isSparkPro = false;
        
        window.imageMode = 2;
        window.imageFiles = [null, null, null, null];
        window.imageUrls = ["", "", "", ""];
        window.bgFile = null;
        window.bgUrl = "";
        window.bgOpacity = 0.1;
        
        window.logoFile = null;
        window.logoUrl = "";

        // SIGNATURE VARIABLES
        window.sigFile = null;
        window.sigUrl = "";
        window.defaultSigUrl = ""; 
        
        window.activeCropIndex = null;
        window.cropper = null;

        // CANVAS VARIABLES
        let isDrawing = false;
        let sigCanvas, sigCtx;
        let isSignatureDrawn = false; 

        // RENDER DEFAULT BARCODE PLACEHOLDER
        function renderBarcode(text) {
            JsBarcode("#barcode", text, {
                format: "CODE128",
                width: 1,
                height: 15, // Small height
                displayValue: true,
                fontSize: 8, // Small font
                margin: 0,
                textMargin: 1
            });
        }
        renderBarcode("SPARK-OPR"); // Initial

        // --- AI FUNCTION (DIKEMASKINI: GROQ / LLAMA 3) ---
        window.askAI = async function(type) {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            const GROQ_API_KEY = "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"; 

            btn.innerHTML = `⏳...`;
            btn.disabled = true;

            const title = document.getElementById('in-tajuk').value;
            const place = document.getElementById('in-tempat').value;
            
            if(!title || title === "LAPORAN PROGRAM") {
                alert("Sila masukkan Tajuk Program dahulu.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            // CHECK PRO STATUS FOR RESTRICTED FEATURES
            if ((type === 'kekuatan' || type === 'isu') && !window.isSparkPro) {
                alert("Maaf, fungsi AI untuk Kekuatan dan Isu/Tindakan adalah eksklusif untuk pengguna SPARK PRO.\n\nSila langgan akaun Pro untuk akses penuh.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            let systemPrompt = "Anda adalah pembantu admin sekolah yang pakar membuat laporan rasmi Kementerian Pendidikan Malaysia (KPM). Jawab dalam Bahasa Melayu baku dan profesional. Terus kepada poin tanpa pendahuluan atau penutup. Jangan gunakan markdown bold (**).";
            
            let userPrompt = "";
            let targetId = "";
            let isList = false;

            if (type === 'objektif') {
                targetId = 'in-objektif';
                isList = true;
                userPrompt = `Senaraikan 3 objektif ringkas dan profesional untuk program: "${title}" bertempat di "${place}". Format: Bullet point standard (-).`;
            } else if (type === 'kekuatan') {
                targetId = 'in-dapatan';
                isList = true;
                userPrompt = `Senaraikan 3 impak/kekuatan kejayaan bagi program "${title}". Fokus kepada kelancaran dan kerjasama. Format: Bullet point standard (-).`;
            } else if (type === 'isu') {
                targetId = 'in-isu';
                isList = true;
                userPrompt = `Senaraikan 2 isu berbangkit biasa (contoh: teknikal/masa) dan cadangan penambahbaikan untuk program "${title}". Format: "Isu - Cadangan".`;
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        model: "llama-3.3-70b-versatile", 
                        temperature: 0.6,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Ralat sambungan Groq.");
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    let text = data.choices[0].message.content;
                    text = text.replace(/\*\*/g, '').replace(/^[\*•] /gm, '- ').replace(/^Here are/i, '').trim(); 
                    
                    const inputField = document.getElementById(targetId);
                    if(inputField) {
                        inputField.value = text;
                        if(isList) {
                            if(type === 'objektif') document.getElementById('chk-objektif').checked = true;
                            if(type === 'kekuatan') document.getElementById('chk-dapatan').checked = true;
                            if(type === 'isu') document.getElementById('chk-isu').checked = true;
                        }
                        updatePreview(); 
                    }
                } else {
                    alert("AI tidak memberikan jawapan. Sila cuba lagi.");
                }

            } catch (error) {
                console.error("AI Error:", error);
                alert(`Gagal: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        window.setDefaultDates = function() {
            const today = new Date().toISOString().split('T')[0];
            const startIn = document.getElementById('in-tarikh-mula');
            const endIn = document.getElementById('in-tarikh-tamat');
            if(!startIn.value) startIn.value = today;
            if(!endIn.value) endIn.value = today;
            
            const now = new Date();
            document.getElementById('print-date').textContent = now.toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute:'2-digit' });
            
            updatePreview();
        }

        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            window.currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
            if (window.currentUserIc) {
                await loadUserAndPrograms();
                loadSavedReports();
                setDefaultDates(); 
                initSignaturePad(); 
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- BARCODE SERIAL GENERATOR ---
        function generateSerial() {
            const now = new Date();
            const dateStr = now.getFullYear().toString().substr(-2) + 
                            (now.getMonth()+1).toString().padStart(2, '0') + 
                            now.getDate().toString().padStart(2, '0');
            const random = Math.floor(1000 + Math.random() * 9000); 
            return `OPR-${dateStr}-${random}`;
        }

        // --- CANVAS SIGNATURE LOGIC (FIXED) ---
        function initSignaturePad() {
            sigCanvas = document.getElementById('signature-pad');
            
            // FIX: Check if exist
            if (!sigCanvas) return;

            sigCtx = sigCanvas.getContext('2d');
            
            function resizeCanvas() {
                if(sigCanvas) {
                    const rect = sigCanvas.getBoundingClientRect();
                    sigCanvas.width = rect.width;
                    sigCanvas.height = rect.height;
                }
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            sigCanvas.addEventListener('mousedown', startDrawing);
            sigCanvas.addEventListener('mouseup', stopDrawing);
            sigCanvas.addEventListener('mousemove', draw);
            sigCanvas.addEventListener('mouseleave', stopDrawing);

            sigCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            sigCanvas.addEventListener('touchend', (e) => { e.preventDefault(); stopDrawing(); });
            sigCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        }

        function startDrawing(e) {
            isDrawing = true;
            isSignatureDrawn = true;
            document.getElementById('sig-instruction').classList.add('hidden');
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            sigCtx.beginPath();
            updateSignaturePreviewFromCanvas();
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = sigCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            sigCtx.lineWidth = 2;
            sigCtx.lineCap = 'round';
            sigCtx.strokeStyle = '#000';
            sigCtx.lineTo(x, y);
            sigCtx.stroke();
            sigCtx.beginPath();
            sigCtx.moveTo(x, y);
        }

        window.clearSignature = function() {
            sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
            isSignatureDrawn = false;
            document.getElementById('sig-instruction').classList.remove('hidden');
            document.getElementById('out-sig-img').src = "";
            document.getElementById('out-sig-img').classList.add('hidden');
            window.sigFile = null; 
            window.sigUrl = ""; 
        }

        function updateSignaturePreviewFromCanvas() {
            if(!isSignatureDrawn) return;
            const dataUrl = sigCanvas.toDataURL("image/png");
            const prev = document.getElementById('out-sig-img');
            prev.src = dataUrl;
            if(document.getElementById('chk-signature').checked) {
                prev.classList.remove('hidden');
            }
            document.getElementById('sig-upload').value = ""; 
            window.sigFile = null; 
        }

        // --- CROPPER LOGIC (HIGH QUALITY) ---
        window.triggerUpload = function(index) {
            window.activeCropIndex = index;
            document.getElementById('temp-file-input').value = "";
            document.getElementById('temp-file-input').click();
        }

        window.openCropModal = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageElement = document.getElementById('image-to-crop');
                    imageElement.src = e.target.result;
                    document.getElementById('crop-modal').classList.remove('hidden');
                    if (window.cropper) window.cropper.destroy();
                    // --- FORCE LANDSCAPE RATIO 16:9 ---
                    window.cropper = new Cropper(imageElement, { 
                        aspectRatio: 16/9, 
                        viewMode: 1, 
                        autoCropArea: 1,
                        dragMode: 'move'
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.closeCropModal = function() {
            document.getElementById('crop-modal').classList.add('hidden');
            if (window.cropper) { window.cropper.destroy(); window.cropper = null; }
        }

        window.applyCrop = function() {
            if (!window.cropper) return;
            // --- RESIZE TO 1280x720 (HD) ---
            window.cropper.getCroppedCanvas({ width: 1280, height: 720 }).toBlob((blob) => {
                const idx = window.activeCropIndex;
                const file = new File([blob], "cropped.jpg", { type: "image/jpeg" });
                window.imageFiles[idx] = file;
                window.imageUrls[idx] = URL.createObjectURL(blob);
                refreshImages();
                closeCropModal();
            }, 'image/jpeg', 0.90); // 90% Quality
        }

        window.refreshImages = function() {
            for (let i = 0; i < 4; i++) {
                const url = window.imageUrls[i];
                const thumb = document.getElementById(`thumb-${i}`);
                const label = document.getElementById(`label-${i}`);
                const prevImg = document.getElementById(`prev-img-${i}`);

                if (url) {
                    thumb.src = url; thumb.classList.remove('hidden'); label.classList.add('hidden');
                    prevImg.src = url; prevImg.classList.remove('hidden'); 
                } else {
                    thumb.src = ""; thumb.classList.add('hidden'); label.classList.remove('hidden');
                    prevImg.src = ""; prevImg.classList.add('hidden');
                }
            }
            updatePreview();
        }

        // --- BACKGROUND, LOGO & SIGNATURE ---
        window.changeBackground = function(input) {
            if (input.files && input.files[0]) {
                window.bgFile = input.files[0]; 
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.querySelectorAll('.paper-background').forEach(bg => bg.style.backgroundImage = `url('${e.target.result}')`);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.changeLogo = function(input) {
            if(!window.isSparkPro) { alert("Menukar logo adalah ciri SPARK PRO."); input.value = ""; return; }
            if (input.files && input.files[0]) {
                window.logoFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('header-logo').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.toggleSignature = function() {
            const isChecked = document.getElementById('chk-signature').checked;
            const container = document.getElementById('sig-input-container');
            const outSigImg = document.getElementById('out-sig-img');

            if(isChecked) {
                container.classList.remove('hidden');
                
                // --- FIX: Safety Check for Canvas ---
                setTimeout(() => {
                    const canvasEl = document.getElementById('signature-pad');
                    if (canvasEl) {
                        const rect = canvasEl.getBoundingClientRect();
                        if(canvasEl.width !== rect.width) {
                             canvasEl.width = rect.width; 
                             canvasEl.height = rect.height;
                             // Update global var if needed
                             sigCanvas = canvasEl;
                             sigCtx = canvasEl.getContext('2d');
                        }
                    }
                }, 100);

                if(window.sigUrl || window.sigFile || isSignatureDrawn) {
                    outSigImg.classList.remove('hidden');
                }
            } else {
                container.classList.add('hidden');
                outSigImg.classList.add('hidden');
            }
        }

        window.handleSigUpload = function(input) {
            if (input.files && input.files[0]) {
                window.sigFile = input.files[0];
                clearSignature();
                const reader = new FileReader();
                reader.onload = function(e) {
                    const prev = document.getElementById('out-sig-img');
                    prev.src = e.target.result;
                    if(document.getElementById('chk-signature').checked) {
                        prev.classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.deleteDefaultSignature = async function() {
            if(!confirm("Padam tandatangan simpanan tetap? Anda perlu melukis semula untuk rekod akan datang.")) return;
            try {
                if(window.currentUserDocId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, window.currentUserDocId), {
                        defaultSignatureUrl: ""
                    });
                    window.defaultSigUrl = "";
                    document.getElementById('btn-delete-default-sig').classList.add('hidden');
                    alert("Tandatangan tetap berjaya dipadam.");
                    clearSignature();
                }
            } catch(e) {
                alert("Ralat memadam: " + e.message);
            }
        }

        window.adjustBgOpacity = function(val) {
            window.bgOpacity = val;
            document.querySelectorAll('.paper-background').forEach(bg => bg.style.opacity = val);
        }

        // --- UI & DRAG DROP ---
        let draggedIndex = null;
        window.handleDragStart = function(e) { draggedIndex = parseInt(e.target.getAttribute('data-index')); e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        window.handleDragOver = function(e) { e.preventDefault(); const targetBox = e.target.closest('.img-upload-box'); if (targetBox && targetBox.getAttribute('data-index') != draggedIndex) targetBox.classList.add('drag-over'); }
        window.handleDrop = function(e) {
            e.preventDefault();
            const targetBox = e.target.closest('.img-upload-box');
            document.querySelectorAll('.img-upload-box').forEach(b => b.classList.remove('dragging', 'drag-over'));
            if (targetBox) {
                const targetIndex = parseInt(targetBox.getAttribute('data-index'));
                if (draggedIndex !== null && targetIndex !== draggedIndex) {
                    const tempFile = window.imageFiles[draggedIndex]; window.imageFiles[draggedIndex] = window.imageFiles[targetIndex]; window.imageFiles[targetIndex] = tempFile;
                    const tempUrl = window.imageUrls[draggedIndex]; window.imageUrls[draggedIndex] = window.imageUrls[targetIndex]; window.imageUrls[targetIndex] = tempUrl;
                    const capIn1 = document.getElementById(`in-cap-${draggedIndex}`);
                    const capIn2 = document.getElementById(`in-cap-${targetIndex}`);
                    const tempCap = capIn1.value; capIn1.value = capIn2.value; capIn2.value = tempCap;
                    refreshImages();
                }
            }
            draggedIndex = null;
        }

        // --- CORE FUNCTIONS ---
        window.toggleImageCount = function() {
            window.imageMode = (window.imageMode === 2) ? 4 : 2;
            const btn = document.getElementById('btn-toggle-img');
            const gridPreview = document.getElementById('preview-image-grid');
            if (window.imageMode === 4) {
                btn.textContent = "- Kurang Gambar (2)";
                document.getElementById('container-2').classList.remove('hidden'); document.getElementById('container-3').classList.remove('hidden');
                document.getElementById('prev-box-2').classList.remove('hidden'); document.getElementById('prev-box-3').classList.remove('hidden');
                gridPreview.classList.remove('grid-cols-2'); gridPreview.classList.add('grid-cols-2', 'grid-rows-2'); 
                // REMOVED FIXED HEIGHT TO ALLOW ASPECT RATIO
            } else {
                btn.textContent = "+ Tambah Gambar (4)";
                document.getElementById('container-2').classList.add('hidden'); document.getElementById('container-3').classList.add('hidden');
                document.getElementById('prev-box-2').classList.add('hidden'); document.getElementById('prev-box-3').classList.add('hidden');
                gridPreview.classList.remove('grid-rows-2'); 
            }
        }

        window.updatePreview = function() {
            const fields = [ {id: 'in-tajuk', out: 'out-tajuk'}, {id: 'in-tempat', out: 'out-tempat'}, {id: 'in-nama', out: 'out-nama'}, {id: 'in-jawatan', out: 'out-jawatan'} ];
            fields.forEach(f => document.getElementById(f.out).textContent = document.getElementById(f.id).value);
            
            updateTextField('in-objektif', 'out-objektif', 'chk-objektif');
            updateTextField('in-dapatan', 'out-dapatan', 'chk-dapatan');
            updateTextField('in-isu', 'out-isu', 'chk-isu');

            const showCatatan = document.getElementById('chk-catatan').checked;
            const catatanInput = document.getElementById('in-catatan');
            const catatanRow = document.getElementById('row-catatan');
            const catatanOut = document.getElementById('out-catatan');

            if(showCatatan) {
                catatanInput.classList.remove('hidden');
                catatanRow.classList.remove('hidden');
                catatanOut.innerText = catatanInput.value;
            } else {
                catatanInput.classList.add('hidden');
                catatanRow.classList.add('hidden');
                catatanOut.innerText = "";
            }

            // Attendance check
            const showAtt = document.getElementById('chk-attendance').checked;
            if (showAtt) {
                document.getElementById('attendance-page').classList.remove('hidden');
                document.querySelectorAll('.generated-att-page').forEach(el => el.classList.remove('hidden'));
                const tajuk = "PROGRAM: " + document.getElementById('in-tajuk').value;
                document.querySelectorAll('.att-subtitle-el').forEach(el => el.textContent = tajuk);
            } else {
                document.getElementById('attendance-page').classList.add('hidden');
                document.querySelectorAll('.generated-att-page').forEach(el => el.classList.add('hidden'));
            }

            const dateStart = document.getElementById('in-tarikh-mula').value;
            const dateEnd = document.getElementById('in-tarikh-tamat').value;
            let dateDisplay = "";
            if(dateStart) {
                const d1 = new Date(dateStart); const day1 = d1.getDate(); const month1 = d1.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase(); const year1 = d1.getFullYear();
                if(dateEnd && dateEnd !== dateStart) {
                    const d2 = new Date(dateEnd); const day2 = d2.getDate(); const month2 = d2.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase(); const year2 = d2.getFullYear();
                    if(year1 === year2 && month1 === month2) dateDisplay = `${day1} - ${day2} ${month1} ${year1}`;
                    else if (year1 === year2) dateDisplay = `${day1} ${month1} - ${day2} ${month2} ${year1}`;
                    else dateDisplay = `${day1} ${month1} ${year1} - ${day2} ${month2} ${year2}`;
                } else { dateDisplay = `${day1} ${month1} ${year1}`; }
            }
            document.getElementById('out-tarikh').textContent = dateDisplay;
            document.getElementById('out-tajuk').style.fontSize = (window.currentFontSize + 4) + 'pt';

            const showCaption = document.getElementById('chk-show-caption').checked;
            for(let i=0; i<4; i++) {
                const prevCap = document.getElementById(`prev-cap-${i}`);
                const userCap = document.getElementById(`in-cap-${i}`).value;
                if(window.imageUrls[i] && showCaption) {
                    prevCap.classList.remove('hidden');
                    prevCap.textContent = userCap ? userCap : `Gambar ${i + 1}`;
                } else {
                    prevCap.classList.add('hidden');
                }
            }

            // LINK DOKUMENTASI LOGIC
            const showLink = document.getElementById('chk-link-dokumen').checked;
            const linkUrl = document.getElementById('in-link-dokumen').value;
            const linkInput = document.getElementById('in-link-dokumen');
            const linkOutContainer = document.getElementById('out-link-container');
            const qrImg = document.getElementById('out-qr-dokumen');

            if (showLink) {
                linkInput.classList.remove('hidden');
                if (linkUrl) {
                    linkOutContainer.classList.remove('hidden');
                    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(linkUrl)}`;
                } else {
                    linkOutContainer.classList.add('hidden');
                }
            } else {
                linkInput.classList.add('hidden');
                linkOutContainer.classList.add('hidden');
            }
        }

        function updateTextField(inputId, outputId, checkId) {
            const input = document.getElementById(inputId);
            const output = document.getElementById(outputId);
            const checkbox = document.getElementById(checkId);
            
            if(!input || !output) return;
            const text = input.value;
            const isListMode = checkbox ? checkbox.checked : false;

            if(isListMode) {
                const items = text.split('\n');
                let listHtml = '<ul class="list-disc pl-4 space-y-0.5 text-left">';
                let hasContent = false;
                items.forEach(item => {
                    const cleanItem = item.trim().replace(/^[-*•]\s*/, ''); 
                    if(cleanItem) { listHtml += `<li>${cleanItem}</li>`; hasContent = true; }
                });
                listHtml += '</ul>';
                output.innerHTML = hasContent ? listHtml : '';
            } else {
                output.innerText = text;
            }
        }

        window.downloadPDFOnly = function() {
            document.body.style.cursor = "wait";
            generatePDF(false).then(() => { document.body.style.cursor = "default"; });
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = "Proses..."; btn.disabled = true;
            try {
                // GENERATE SERIAL IF EMPTY
                let currentSerial = document.getElementById('opr-serial-hidden').value;
                if(!currentSerial) {
                    currentSerial = generateSerial();
                    document.getElementById('opr-serial-hidden').value = currentSerial;
                    renderBarcode(currentSerial);
                }

                const uploadedUrls = [];
                for(let i=0; i<4; i++) {
                    let finalUrl = window.imageUrls[i] || "";
                    if(window.imageFiles[i]) finalUrl = await uploadToImgBB(window.imageFiles[i]);
                    uploadedUrls.push(finalUrl);
                }

                let finalBgUrl = window.bgUrl || "";
                if(window.bgFile) finalBgUrl = await uploadToImgBB(window.bgFile);

                let finalLogoUrl = window.logoUrl || "";
                if(window.logoFile) finalLogoUrl = await uploadToImgBB(window.logoFile);

                let finalSigUrl = window.sigUrl || "";
                if (isSignatureDrawn) {
                    const dataUrl = sigCanvas.toDataURL("image/png");
                    const blob = dataURLtoBlob(dataUrl);
                    finalSigUrl = await uploadToImgBB(blob);
                } else if(window.sigFile) {
                    finalSigUrl = await uploadToImgBB(window.sigFile);
                }

                if (document.getElementById('chk-save-default-sig').checked && finalSigUrl && window.currentUserDocId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, window.currentUserDocId), {
                        defaultSignatureUrl: finalSigUrl
                    });
                    window.defaultSigUrl = finalSigUrl; 
                    document.getElementById('btn-delete-default-sig').classList.remove('hidden');
                }

                const caps = [
                    document.getElementById('in-cap-0').value,
                    document.getElementById('in-cap-1').value,
                    document.getElementById('in-cap-2').value,
                    document.getElementById('in-cap-3').value
                ];

                const dataToSave = {
                    ic: window.currentUserIc, tajuk: document.getElementById('in-tajuk').value,
                    tarikhMula: document.getElementById('in-tarikh-mula').value, tarikhTamat: document.getElementById('in-tarikh-tamat').value,
                    tempat: document.getElementById('in-tempat').value, objektif: document.getElementById('in-objektif').value,
                    dapatan: document.getElementById('in-dapatan').value, isu: document.getElementById('in-isu').value,
                    nama: document.getElementById('in-nama').value, jawatan: document.getElementById('in-jawatan').value,
                    img1: uploadedUrls[0], img2: uploadedUrls[1], img3: uploadedUrls[2], img4: uploadedUrls[3],
                    captions: caps, 
                    catatan: document.getElementById('in-catatan').value, 
                    showCatatan: document.getElementById('chk-catatan').checked,
                    
                    // New Fields
                    linkDokumen: document.getElementById('in-link-dokumen').value,
                    showLinkDokumen: document.getElementById('chk-link-dokumen').checked,
                    serialNumber: currentSerial,
                    attendanceList: window.attendanceData || [], // SIMPAN DATA KEHADIRAN

                    backgroundUrl: finalBgUrl, backgroundOpacity: window.bgOpacity,
                    logoUrl: finalLogoUrl,
                    signatureUrl: finalSigUrl,
                    showSignature: document.getElementById('chk-signature').checked,
                    orgName: document.getElementById('in-org-name').value,
                    subOrgName: document.getElementById('in-sub-org').value,
                    imageMode: window.imageMode, 
                    showCaption: document.getElementById('chk-show-caption').checked,
                    updatedAt: new Date()
                };

                const reportId = document.getElementById('report-id').value;
                if(reportId) await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_opr_records`, reportId), dataToSave);
                else { dataToSave.createdAt = new Date(); await addDoc(collection(db, `artifacts/${appId}/public/data/spark_opr_records`), dataToSave); }
                
                await generatePDF(true);
                loadSavedReports();
            } catch (error) { console.error(error); alert("Ralat: " + error.message); } finally { btn.innerHTML = "Simpan & PDF"; btn.disabled = false; }
        }

        async function generatePDF(isSaved) {
            const element = document.getElementById('pdf-wrapper');
            const tajuk = document.getElementById('in-tajuk').value.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15);
            const fileName = `OPR_${tajuk}.pdf`;
            
            window.scrollTo(0,0); // Reset scroll to avoid glitch

            const opt = { 
                margin: 0, 
                filename: fileName, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    scrollY: 0, 
                    letterRendering: true
                }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } 
            };
            await html2pdf().set(opt).from(element).save();
            
            if(isSaved) alert("Berjaya disimpan dan dimuat turun!");
        }

        async function uploadToImgBB(file) {
            const formData = new FormData(); formData.append("image", file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) return result.data.url; else throw new Error("Gagal upload gambar");
        }

        // --- LOADERS & TABS (VERSI SELAMAT) ---
        window.showTab = function(tabName) {
            // Senarai semua ID tab yang mungkin ada
            const tabs = ['form', 'history', 'settings'];

            // 1. Sembunyikan semua content (dengan pemeriksaan keselamatan)
            tabs.forEach(t => {
                const content = document.getElementById('tab-content-' + t);
                const btn = document.getElementById('tab-btn-' + t);
                
                if (content) content.classList.add('hidden');
                
                if (btn) {
                    // Reset style butang jadi kelabu
                    btn.className = "flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all";
                }
            });

            // 2. Tunjukkan content yang dipilih
            const selectedContent = document.getElementById('tab-content-' + tabName);
            const selectedBtn = document.getElementById('tab-btn-' + tabName);

            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            } else {
                console.error("Ralat: Elemen 'tab-content-" + tabName + "' tidak dijumpai dalam HTML.");
                return; // Berhenti jika content tiada
            }

            if (selectedBtn) {
                // Warnakan butang aktif jadi biru/putih
                selectedBtn.className = "flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-indigo-600 transition-all";
            }

            // 3. Fix canvas saiz jika buka tab form
            if(tabName === 'form' && typeof sigCanvas !== 'undefined' && sigCanvas) {
                setTimeout(() => {
                    const container = document.getElementById('sig-input-container');
                    if (container && !container.classList.contains('hidden')) {
                        const rect = sigCanvas.getBoundingClientRect();
                        sigCanvas.width = rect.width;
                        sigCanvas.height = rect.height;
                    }
                }, 200);
            }
        }

        // NEW: LINE SPACING ADJUSTMENT
        window.adjustLineHeight = function(change) {
            window.currentLineHeight += change;
            if (window.currentLineHeight < 1.0) window.currentLineHeight = 1.0;
            if (window.currentLineHeight > 2.5) window.currentLineHeight = 2.5;
            
            // Limit decimal places
            window.currentLineHeight = Math.round(window.currentLineHeight * 10) / 10;
            
            document.getElementById('line-height-display').textContent = window.currentLineHeight;
            
            // Apply to table cells
            document.querySelectorAll('.opr-table td, .opr-table th').forEach(el => {
                el.style.lineHeight = window.currentLineHeight;
            });
            
            // Apply to specific content divs (crucial for long text)
            document.querySelectorAll('#out-objektif, #out-dapatan, #out-isu').forEach(el => {
                el.style.lineHeight = window.currentLineHeight;
            });
        }

        window.adjustFontSize = function(change) {
            window.currentFontSize += change;
            if (window.currentFontSize < 6) window.currentFontSize = 6; if (window.currentFontSize > 14) window.currentFontSize = 14;
            document.getElementById('font-size-display').textContent = window.currentFontSize + 'pt';
            document.getElementById('main-table').style.fontSize = window.currentFontSize + 'pt';
            document.getElementById('out-tajuk').style.fontSize = (window.currentFontSize + 4) + 'pt';
            document.querySelectorAll('.opr-table th').forEach(th => th.style.fontSize = window.currentFontSize + 'pt');
            document.querySelectorAll('.opr-table td').forEach(td => td.style.fontSize = window.currentFontSize + 'pt');
        }

        // --- NEW: FUNCTION TO ADJUST ATTENDANCE FONT SIZE ---
        window.adjustAttFontSize = function(change) {
            window.currentAttFontSize += change;
            if (window.currentAttFontSize < 6) window.currentAttFontSize = 6; 
            if (window.currentAttFontSize > 12) window.currentAttFontSize = 12;
            
            document.getElementById('att-font-size-display').textContent = window.currentAttFontSize + 'pt';


// --- FUNGSI BARU: GERAKKAN NAMA (MANUAL) ---
window.moveItem = function(index, direction) {
    const list = window.attendanceData;
    const newIndex = index + direction;

    // Elak error jika dah paling atas/bawah
    if (newIndex < 0 || newIndex >= list.length) return;

    // Tukar kedudukan (Swap)
    const temp = list[index];
    list[index] = list[newIndex];
    list[newIndex] = temp;

    // Render semula
    renderAttendanceTable();
}
            
            renderAttendanceTable(); // Re-render to apply changes
        }

        // --- NEW: FUNCTION TO UPDATE ROWS PER PAGE ---
        window.updateRowsPerPage = function(val) {
            let rows = parseInt(val);
            if (rows < 5) rows = 5;
            if (rows > 50) rows = 50;
            
            window.currentRowsPerPage = rows;
            renderAttendanceTable(); // Re-render
        }

        window.adjustHeaderSize = function(change) {
            if(!window.isSparkPro) { alert("Ciri ini untuk akaun SPARK PRO sahaja."); return; }
            window.currentHeaderSize += change;
            if (window.currentHeaderSize < 10) window.currentHeaderSize = 10; if (window.currentHeaderSize > 30) window.currentHeaderSize = 30;
            document.getElementById('header-size-display').textContent = window.currentHeaderSize + 'pt';
            document.getElementById('out-org-name').style.fontSize = window.currentHeaderSize + 'pt';
        }

        window.updateHeader = function() {
            document.getElementById('out-org-name').textContent = document.getElementById('in-org-name').value;
            document.getElementById('out-sub-org').textContent = document.getElementById('in-sub-org').value;
        }

        async function loadUserAndPrograms() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", window.currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uDoc = userSnap.docs[0];
                window.currentUserDocId = uDoc.id; // Store Doc ID for updates
                const uData = uDoc.data();
                
                document.getElementById('in-nama').value = uData.name.toUpperCase();
                document.getElementById('in-jawatan').value = (uData.jawatan || uData.unit || "").toUpperCase();
                window.isSparkPro = uData.isPro === true;
                
                const badge = document.getElementById('account-badge');
                if (window.isSparkPro) { badge.textContent = "AKAUN PRO"; badge.className = "text-[10px] bg-yellow-100 text-yellow-800 border border-yellow-300 px-2 py-0.5 rounded font-bold uppercase tracking-wider"; }
                else { badge.textContent = "AKAUN BIASA"; badge.className = "text-[10px] bg-gray-100 text-gray-500 border border-gray-200 px-2 py-0.5 rounded font-bold uppercase tracking-wider"; }
                
                if (uData.defaultSignatureUrl) {
                    window.defaultSigUrl = uData.defaultSignatureUrl;
                    document.getElementById('btn-delete-default-sig').classList.remove('hidden');
                    
                    if (!document.getElementById('report-id').value) {
                         window.sigUrl = window.defaultSigUrl;
                         document.getElementById('out-sig-img').src = window.sigUrl;
                         document.getElementById('chk-signature').checked = true;
                         toggleSignature();
                    }
                }

                updatePreview();
            }
            
            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q1 = query(progRef, where("createdBy", "==", window.currentUserIc));
            const q2 = query(progRef, where("penyelaras_ic", "==", window.currentUserIc));
            try {
                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                const select = document.getElementById('program-select');
                window.allMyPrograms = []; 
                const appendOption = (doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    if(window.allMyPrograms.some(p => p.id === data.id)) return;
                    const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.name.toUpperCase();
                    select.appendChild(opt); window.allMyPrograms.push(data);
                };
                snap1.forEach(appendOption); snap2.forEach(appendOption);
            } catch (err) { console.error(err); }
        }

        // --- FIXED: loadSavedReports WITH SAFETY CHECK ---
        async function loadSavedReports() {
            // 1. Pastikan pengguna wujud
            if (!window.currentUserIc) return;

            const reportRef = collection(db, `artifacts/${appId}/public/data/spark_opr_records`);
            const q = query(reportRef, where("ic", "==", window.currentUserIc), orderBy("createdAt", "desc"));
            
            try {
                const snaps = await getDocs(q);
                
                // 2. Cari elemen HTML
                const tbody = document.getElementById('history-table-body');
                const select = document.getElementById('history-select');
                const limitMsg = document.getElementById('limit-warning');
                const countDisplay = document.getElementById('history-count'); 

                // 3. FIX PENTING: Jika elemen tiada, BERHENTI (Jangan buat apa-apa)
                if (!tbody || !select) {
                    console.warn("Elemen jadual sejarah belum bersedia.");
                    return; 
                }

                tbody.innerHTML = ''; 
                select.innerHTML = '<option value="">-- Pilih Rekod --</option>';
                
                window.allMyReports = [];
                let docs = [];
                snaps.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));

                // Update jumlah jika elemen wujud
                if(countDisplay) countDisplay.textContent = docs.length;

                if (!window.isSparkPro && docs.length > 5 && limitMsg) { 
                    docs = docs.slice(0, 5); 
                    limitMsg.classList.remove('hidden'); 
                } else if (limitMsg) { 
                    limitMsg.classList.add('hidden'); 
                }

                if(docs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center italic text-gray-400">Tiada rekod dijumpai.</td></tr>';
                    return;
                }

                docs.forEach(data => {
                    window.allMyReports.push(data);
                    
                    const opt = document.createElement('option'); 
                    opt.value = data.id; 
                    opt.textContent = data.tajuk ? data.tajuk.substring(0, 30) : "Tiada Tajuk";
                    select.appendChild(opt);

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors group";
                    
                    let dateStr = "-";
                    if(data.tarikhMula) dateStr = new Date(data.tarikhMula).toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: '2-digit'});

                    tr.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap font-medium text-gray-900">${dateStr}</td>
                        <td class="px-3 py-3 truncate max-w-[140px]" title="${data.tajuk}">${data.tajuk}</td>
                        <td class="px-3 py-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="loadHistory('${data.id}')" class="p-1.5 text-indigo-600 hover:bg-indigo-100 rounded-md transition-colors" title="Buka & Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                </button>
                                <button onclick="downloadFromHistory('${data.id}')" class="p-1.5 text-teal-600 hover:bg-teal-100 rounded-md transition-colors" title="Muat Turun PDF">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                </button>
                                <button onclick="deleteHistory('${data.id}')" class="p-1.5 text-red-500 hover:bg-red-100 rounded-md transition-colors" title="Padam Rekod">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch (err) { console.error("Ralat loadSavedReports:", err); }
        }

        window.loadHistory = function(id) {
            const report = window.allMyReports.find(r => r.id === id);
            if(!report) return;
            document.getElementById('report-id').value = report.id;
            document.getElementById('in-tajuk').value = report.tajuk;
            document.getElementById('in-tarikh-mula').value = report.tarikhMula;
            document.getElementById('in-tarikh-tamat').value = report.tarikhTamat || "";
            document.getElementById('in-tempat').value = report.tempat;
            document.getElementById('in-objektif').value = report.objektif;
            document.getElementById('in-dapatan').value = report.dapatan;
            document.getElementById('in-isu').value = report.isu;
            document.getElementById('in-nama').value = report.nama;
            document.getElementById('in-jawatan').value = report.jawatan;
            window.imageUrls = [report.img1||"", report.img2||"", report.img3||"", report.img4||""];
            window.imageFiles = [null, null, null, null];
            
            // Load Attendance Data if available
            if(report.attendanceList && Array.isArray(report.attendanceList)) {
                window.attendanceData = report.attendanceList;
                document.getElementById('att-count-label').textContent = `${window.attendanceData.length} peserta direkod.`;
                document.getElementById('chk-attendance').checked = true;
            } else {
                window.attendanceData = [];
                document.getElementById('att-count-label').textContent = "Tiada data kehadiran tersimpan.";
                document.getElementById('chk-attendance').checked = false;
            }
            renderAttendanceTable();

            // Restore Settings
            window.bgUrl = report.backgroundUrl || "";
            window.bgOpacity = report.backgroundOpacity || 0.1;
            if(window.bgUrl) document.querySelectorAll('.paper-background').forEach(bg => bg.style.backgroundImage = `url('${window.bgUrl}')`);
            document.querySelectorAll('.paper-background').forEach(bg => bg.style.opacity = window.bgOpacity);
            document.getElementById('bg-opacity').value = window.bgOpacity;

            window.logoUrl = report.logoUrl || "";
            if(window.logoUrl) document.getElementById('header-logo').src = window.logoUrl;
            
            document.getElementById('in-org-name').value = report.orgName || "KEMENTERIAN PENDIDIKAN MALAYSIA";
            document.getElementById('in-sub-org').value = report.subOrgName || "PEJABAT PENDIDIKAN DAERAH MIRI";
            updateHeader();

            document.getElementById('chk-show-caption').checked = (report.showCaption === false) ? false : true;
            
            if(report.captions && Array.isArray(report.captions)) {
                for(let i=0; i<4; i++) { document.getElementById(`in-cap-${i}`).value = report.captions[i] || ""; }
            }

            document.getElementById('in-catatan').value = report.catatan || "";
            document.getElementById('chk-catatan').checked = report.showCatatan === true;

            // NEW: LINK DOKUMENTASI RESTORE
            document.getElementById('in-link-dokumen').value = report.linkDokumen || "";
            document.getElementById('chk-link-dokumen').checked = report.showLinkDokumen === true;

            // NEW: SERIAL & BARCODE RESTORE
            document.getElementById('opr-serial-hidden').value = report.serialNumber || "";
            renderBarcode(report.serialNumber || "SPARK-OPR");

            window.sigUrl = report.signatureUrl || window.defaultSigUrl || "";
            window.sigFile = null;
            clearSignature(); 
            document.getElementById('chk-signature').checked = report.showSignature === true;
            if(window.sigUrl) {
                document.getElementById('out-sig-img').src = window.sigUrl;
            } else {
                document.getElementById('out-sig-img').src = "";
            }
            toggleSignature();

            if(report.imageMode === 4 && window.imageMode === 2) toggleImageCount();
            if((!report.imageMode || report.imageMode === 2) && window.imageMode === 4) toggleImageCount();
            refreshImages(); updatePreview(); showTab('form');
        }

        window.deleteHistory = async function(id) {
            if(!confirm("Adakah anda pasti mahu memadam rekod ini secara kekal?")) return;
            const btn = event.currentTarget; 
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            btn.disabled = true;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_opr_records`, id));
                await loadSavedReports();
                if(document.getElementById('report-id').value === id) {
                    document.getElementById('report-id').value = "";
                    alert("Rekod yang sedang dibuka telah dipadam.");
                }
            } catch (error) {
                console.error("Gagal memadam:", error);
                alert("Gagal memadam rekod.");
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        window.downloadFromHistory = function(id) {
            loadHistory(id);
            const btn = event.currentTarget;
            const originalInner = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            setTimeout(() => {
                generatePDF(false).then(() => {
                    btn.innerHTML = originalInner;
                });
            }, 1000); 
        }

        // --- FETCH ATTENDANCE DIRECTLY FROM PROGRAM OBJECT ---
        window.importProgramData = function(progId) {
            const prog = window.allMyPrograms.find(p => p.id === progId);
            if(prog) {
                // 1. Isi Maklumat Asas
                document.getElementById('report-id').value = "";
                document.getElementById('opr-serial-hidden').value = ""; 
                renderBarcode("SPARK-OPR"); 
                
                document.getElementById('in-tajuk').value = prog.name ? prog.name.toUpperCase() : "PROGRAM TANPA NAMA";
                document.getElementById('in-tempat').value = prog.location ? prog.location.toUpperCase() : "";
                if(prog.startDate) document.getElementById('in-tarikh-mula').value = prog.startDate;
                if(prog.endDate) document.getElementById('in-tarikh-tamat').value = prog.endDate;
                if(prog.description) document.getElementById('in-objektif').value = prog.description;
                
                // 2. AMBIL DATA KEHADIRAN DARI ARRAY PROGRAM
                const label = document.getElementById('att-count-label');
                
                if (prog.attendance && Array.isArray(prog.attendance) && prog.attendance.length > 0) {
                    window.attendanceData = prog.attendance;
                    label.textContent = `${window.attendanceData.length} peserta dikesan.`;
                    document.getElementById('chk-attendance').checked = true;
                } else {
                    window.attendanceData = [];
                    label.textContent = "Tiada kehadiran dikesan dalam program ini.";
                    document.getElementById('chk-attendance').checked = false;
                }

                // 3. Render Jadual & Preview
                renderAttendanceTable();
                updatePreview();
            }
        }

        // --- FUNGSI SUSUNAN KEKANANAN & RENDER JADUAL (PAGINATION FIXED) ---


// --- FUNGSI RENDER (FIX: BUTANG TIDAK MASUK PDF) ---
        window.renderAttendanceTable = function() {
            const ROWS_PER_PAGE = window.currentRowsPerPage || 15; 
            const wrapper = document.getElementById('pdf-wrapper');
            const chkManual = document.getElementById('chk-manual-sort');
            const isManualMode = chkManual ? chkManual.checked : false;

            // Bersihkan page lama
            document.querySelectorAll('.generated-att-page').forEach(el => el.remove());

            const templatePage = document.getElementById('attendance-page');
            const tbodyTemplate = templatePage.querySelector('tbody');
            
            // --- LOGIK HEADER TAMBAHAN ---
            const headerRow = templatePage.querySelector('thead tr');
            const actionHeaderId = 'th-action-col';
            let actionTh = document.getElementById(actionHeaderId);

            if (isManualMode) {
                if (!actionTh) {
                    actionTh = document.createElement('th');
                    actionTh.id = actionHeaderId;
                    actionTh.className = "w-16 text-center no-print-col bg-orange-50 text-orange-600 border border-orange-200";
                    actionTh.innerText = "UBAH";
                    // FIX UTAMA: Arahan supaya PDF abaikan elemen ini
                    actionTh.setAttribute('data-html2canvas-ignore', 'true'); 
                    headerRow.appendChild(actionTh);
                }
            } else {
                if (actionTh) actionTh.remove();
            }

            tbodyTemplate.innerHTML = ""; 

            if (!window.attendanceData || window.attendanceData.length === 0) {
                tbodyTemplate.innerHTML = "<tr><td colspan='6' class='text-center italic text-gray-500 py-4'>Tiada Data Kehadiran</td></tr>";
                templatePage.querySelector('.att-total-count-el').textContent = "0";
                return;
            }

            // --- LOGIK SORTING ---
            if (!isManualMode) {
                function getRankWeight(jawatan) {
                    const t = (jawatan || "").toUpperCase().trim();
                    if (t.includes("PEGAWAI PENDIDIKAN DAERAH") || (t.includes("PENGARAH") && !t.includes("TIMBALAN"))) return 100;
                    if (t.includes("TIMBALAN")) return 90;
                    if (t.includes("PENGETUA") || t.includes("GURU BESAR")) return 85;
                    if (t.includes("SISC") || t.includes("SIP") || t.includes("PEGAWAI KHAS") || t.includes("PENOLONG PPD")) return 80;
                    if (t.includes("PENTADBIRAN") || t.includes("PK 1") || t.includes("AKADEMIK") || t.includes("KANAN 1")) return 75;
                    if (t.includes("HEM") || t.includes("HAL EHWAL")) return 74;
                    if (t.includes("KOKURIKULUM") || t.includes("KO-Q") || t.includes("PK KO")) return 73;
                    if (t.includes("PETANG") || t.includes("PK PKI") || t.includes("PENDIDIKAN KHAS")) return 72;
                    if (t.includes("PENOLONG KANAN") || t.includes("PK")) return 70;
                    if (t.includes("GURU KANAN") || t.includes("KETUA BIDANG") || t.includes("GKMP")) return 60;
                    if (t.includes("KAUNSELOR") || t.includes("BIMBINGAN")) return 50;
                    if (t.includes("KETUA PANITIA") || t.includes("SU ") || t.includes("SETIAUSAHA")) return 40;
                    if (t.includes("GURU") || t.includes("DG")) return 30;
                    if (t.includes("PEMBANTU") || t.includes("ANGGOTA") || t.includes("AKP") || t.includes("KERANI")) return 20;
                    return 10;
                }

                window.attendanceData.sort((a, b) => {
                    const stationA = (a.station || "").toUpperCase();
                    const stationB = (b.station || "").toUpperCase();
                    const rankA = getRankWeight(a.position);
                    const rankB = getRankWeight(b.position);
                    
                    const isPpdA = (stationA.includes("PPD") || stationA.includes("PEJABAT"));
                    const isPpdB = (stationB.includes("PPD") || stationB.includes("PEJABAT"));

                    if (isPpdA && !isPpdB) return -1;
                    if (!isPpdA && isPpdB) return 1;
                    if (rankA !== rankB) return rankB - rankA;
                    return (a.name || "").localeCompare(b.name || "");
                });
            }

            // --- RENDER HALAMAN ---
            const totalPages = Math.ceil(window.attendanceData.length / ROWS_PER_PAGE);
            const nowStr = new Date().toLocaleDateString('ms-MY', {day: '2-digit', month: '2-digit', year: 'numeric'});

            for (let i = 0; i < totalPages; i++) {
                let pageEl;
                let tbody;

                if (i === 0) {
                    pageEl = templatePage;
                    tbody = tbodyTemplate;
                    pageEl.style.pageBreakBefore = "auto";
                    pageEl.classList.remove('force-break');
                } else {
                    pageEl = templatePage.cloneNode(true);
                    pageEl.id = `attendance-page-${i}`;
                    pageEl.classList.add('generated-att-page');
                    pageEl.classList.add('force-break'); 
                    pageEl.classList.remove('hidden');
                    pageEl.style.pageBreakBefore = "always"; 
                    pageEl.style.breakBefore = "page";
                    wrapper.appendChild(pageEl);
                    tbody = pageEl.querySelector('tbody');
                    tbody.innerHTML = ""; 
                }
                
                const tableEl = pageEl.querySelector('.att-table');
                tableEl.style.fontSize = window.currentAttFontSize + 'pt';

                const tajuk = "PROGRAM: " + document.getElementById('in-tajuk').value;
                pageEl.querySelectorAll('.att-subtitle-el').forEach(el => el.textContent = tajuk);
                pageEl.querySelectorAll('.att-print-date-el').forEach(el => el.textContent = nowStr);

                const startIdx = i * ROWS_PER_PAGE;
                const endIdx = startIdx + ROWS_PER_PAGE;
                const chunk = window.attendanceData.slice(startIdx, endIdx);

                chunk.forEach((p, idx) => {
                    const tr = document.createElement('tr');
                    const globalIdx = startIdx + idx; 
                    const displayNum = globalIdx + 1;
                    
                    const name = p.name ? p.name.toUpperCase() : "PESERTA";
                    const jawatan = p.position ? p.position.toUpperCase() : "-";
                    const stesen = p.station ? p.station.toUpperCase() : "-";
                    const status = p.status ? p.status.toUpperCase() : "HADIR"; 
                    
                    let rowClass = "";
                    if (!isManualMode) {
                         if(jawatan.includes("PENGETUA") || jawatan.includes("GURU BESAR") || jawatan.includes("PEGAWAI")) rowClass = "font-bold bg-gray-100";
                    }

                    let actionBtns = "";
                    if (isManualMode) {
                        // FIX UTAMA: data-html2canvas-ignore="true" ditambah di sini juga
                        actionBtns = `
                            <td class="text-center no-print-col bg-orange-50 border border-orange-200" data-html2canvas-ignore="true">
                                <button onclick="window.moveItem(${globalIdx}, -1)" class="sort-btn" title="Naik">⬆️</button>
                                <button onclick="window.moveItem(${globalIdx}, 1)" class="sort-btn" title="Turun">⬇️</button>
                            </td>
                        `;
                    }

                    tr.innerHTML = `
                        <td class="text-center font-bold ${rowClass}">${displayNum}</td>
                        <td class="font-semibold ${rowClass}">${name}</td>
                        <td class="text-[inherit] ${rowClass}">${jawatan}</td>
                        <td class="text-[inherit] ${rowClass}">${stesen}</td>
                        <td class="text-center text-[inherit] font-bold">${status}</td>
                        ${actionBtns}
                    `;
                    tbody.appendChild(tr);
                });

                const footerDiv = pageEl.querySelector('.att-footer-count');
                if (i === totalPages - 1) {
                    footerDiv.style.visibility = 'visible';
                    pageEl.querySelector('.att-total-count-el').textContent = window.attendanceData.length;
                } else {
                    footerDiv.style.visibility = 'hidden';
                }
            }
        }
        

        // Initialize
        updatePreview();
    </script>
</body>
</html>
