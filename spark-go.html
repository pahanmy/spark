<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK Go â€“ Rekod Pergerakan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#4F46E5', /* Indigo 600 */
                            dark: '#4338ca',    /* Indigo 700 */
                            light: '#eef2ff'    /* Indigo 50 */
                        },
                        accent: {
                            DEFAULT: '#3b82f6', /* Blue 500 */
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .btn-time { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .btn-time:hover { border-color: #4F46E5; color: #4F46E5; background-color: #eef2ff; }
        .btn-time.active { background-color: #4F46E5; color: white; border-color: #4F46E5; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .profile-img-wrapper {
            width: 90px; height: 90px; 
            border-radius: 50%; 
            border: 4px solid rgba(255,255,255,0.4);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-100">
        <div class="max-w-screen-2xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-brand to-accent p-2 rounded-lg shadow-md shadow-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800 tracking-tight">SPARK <span class="text-brand">Go</span></h1>
                    <p class="text-[10px] md:text-xs text-gray-500 font-medium uppercase tracking-wide">Rekod Pergerakan Pegawai</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='index.html'" class="px-4 py-2 rounded-lg text-xs font-bold text-gray-500 hover:text-brand hover:bg-brand-light transition-colors uppercase">
                    Kembali
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-6xl mx-auto border border-gray-100">
            <div class="md:flex min-h-[650px]">
                
                <div class="md:w-2/5 bg-gradient-to-br from-brand to-blue-600 p-8 text-white relative flex flex-col justify-center items-center text-center overflow-hidden">
                    
                    <div class="absolute top-[-50px] right-[-50px] w-64 h-64 bg-white opacity-5 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute bottom-[-50px] left-[-50px] w-48 h-48 bg-blue-300 opacity-10 rounded-full blur-2xl pointer-events-none"></div>

                    <div class="relative z-10 w-full max-w-xs transition-all duration-500" id="left-panel-content">
                        
                        <div id="auth-box">
                            <div class="mb-8">
                                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.2-2.858.575-4.175m4.839 1.132a8.5 8.5 0 01-1.439 2.508M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-bold mb-1">Pengesahan Pegawai</h2>
                                <p class="text-indigo-100 text-sm opacity-80">Masukkan No. IC untuk mula merekod.</p>
                            </div>
                            
                            <div class="relative group">
                                <input type="text" id="applicant-ic" maxlength="12" oninput="validateApplicant()" placeholder="No. Kad Pengenalan" class="block w-full px-4 py-4 text-center text-lg tracking-widest border border-white/30 bg-white/10 rounded-xl text-white placeholder-indigo-200 focus:outline-none focus:bg-white/20 focus:border-white transition-all shadow-lg backdrop-blur-sm group-hover:bg-white/15">
                                <div class="absolute inset-0 rounded-xl ring-2 ring-white/20 pointer-events-none group-hover:ring-white/40 transition-all"></div>
                            </div>
                            <p id="auth-status" class="text-xs mt-4 text-white font-medium h-5 tracking-wide"></p>
                        </div>

                        <div id="user-info-display" class="hidden animate-fade-in-up w-full">
                            
                            <div class="flex justify-center mb-5">
                                <div id="profile-img-container" class="profile-img-wrapper">
                                    </div>
                            </div>

                            <h3 id="user-name" class="font-bold text-xl leading-tight text-white mb-1 drop-shadow-md">NAMA PEGAWAI</h3>
                            <div class="inline-block bg-black/20 backdrop-blur-md px-4 py-1.5 rounded-full mb-8 border border-white/10">
                                <p id="user-station" class="text-xs text-white font-medium uppercase tracking-wide">Jawatan / Unit</p>
                            </div>

                            <div class="glass-panel p-5 rounded-2xl grid grid-cols-2 gap-4 text-center">
                                <div class="border-r border-white/10">
                                    <p class="text-4xl font-bold text-white" id="stat-month">0</p>
                                    <p class="text-[9px] uppercase text-indigo-100 tracking-wider font-bold mt-1">Bulan Ini</p>
                                </div>
                                <div>
                                    <p class="text-4xl font-bold text-white" id="stat-total">0</p>
                                    <p class="text-[9px] uppercase text-indigo-100 tracking-wider font-bold mt-1">Jumlah Total</p>
                                </div>
                            </div>
                            
                            <button onclick="resetForm()" class="mt-8 text-xs text-white/60 hover:text-white flex items-center justify-center gap-1 mx-auto transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                Tukar Pegawai
                            </button>
                        </div>
                    </div>
                </div>

                <div class="md:w-3/5 p-6 md:p-10 bg-white relative overflow-y-auto">
                    
                    <div id="form-overlay" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-[2px] transition-opacity duration-500">
                        <div class="bg-gray-50 p-6 rounded-full mb-4 shadow-sm border border-gray-100 animate-pulse">
                            <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </div>
                        <p class="text-gray-400 font-bold uppercase text-xs tracking-widest">Sila imbas atau masukkan IC</p>
                    </div>

                    <form onsubmit="submitMovement(event)" class="space-y-6">
                        
                        <div class="flex items-center gap-2 mb-2">
                             <h2 class="text-xl font-bold text-gray-800">Butiran Pergerakan</h2>
                             <div class="h-px bg-gray-200 flex-grow ml-4"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fokus Strategik</label>
                                <select id="ppd-focus" required class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand bg-white hover:bg-gray-50 transition-colors">
                                    <option value="">-- Sila Pilih Fokus --</option>
                                    <option value="Kemenjadian Murid">Kemenjadian Murid</option>
                                    <option value="Sekolah Berkualiti">Sekolah Berkualiti</option>
                                    <option value="Guru Berkualiti">Guru Berkualiti</option>
                                    <option value="Sokongan PIBG/Komuniti">Sokongan PIBG/Komuniti</option>
                                    <option value="Infrastruktur & Aset">Infrastruktur & Aset</option>
                                    <option value="Pengurusan Tertinggi">Pengurusan Tertinggi</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenis Lawatan</label>
                                <select id="visit-type" required class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand bg-white hover:bg-gray-50 transition-colors">
                                    <option value="KUNJUNG BANTU">KUNJUNG BANTU</option>
                                    <option value="BIMBINGAN">BIMBINGAN & PEMENTORAN</option>
                                    <option value="PEMANTAUAN">PEMANTAUAN / AUDIT</option>
                                    <option value="LAWATAN RASMI">LAWATAN RASMI / KERJA</option>
                                    <option value="MESYUARAT">MESYUARAT LUAR</option>
                                    <option value="KURSUS">KURSUS / BENGKEL</option>
                                    <option value="LAIN-LAIN">LAIN-LAIN</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi / Destinasi</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                <select id="destination-select" required class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand bg-white">
                                    <option value="">Memuatkan senarai sekolah...</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pegawai Yang Ingin Dijumpai (Opsyenal)</label>
                            <div class="relative">
                                <input type="text" id="search-target" placeholder="Cari nama pegawai/guru di lokasi (Tag)..." class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand bg-white transition-colors">
                                <div id="target-results" class="absolute z-10 w-full bg-white shadow-xl max-h-48 rounded-lg py-1 mt-1 border border-gray-100 overflow-auto hidden custom-scroll"></div>
                            </div>
                            <div id="target-list" class="flex flex-wrap gap-2 mt-2">
                                </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tujuan / Aktiviti Spesifik</label>
                            <textarea id="visit-reason" rows="4" required placeholder="Nyatakan tujuan atau aktiviti yang akan dijalankan dengan lebih spesifik..." class="block w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand shadow-sm resize-none"></textarea>
                        </div>

                        <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 relative">
                             <div class="absolute top-4 right-4 flex items-center">
                                <input id="is-multi-day" type="checkbox" onchange="toggleMultiDay()" class="w-4 h-4 text-brand border-gray-300 rounded focus:ring-brand">
                                <label for="is-multi-day" class="ml-2 text-xs font-bold text-indigo-700 uppercase cursor-pointer select-none">Lebih 1 Hari?</label>
                            </div>

                            <div class="flex flex-col gap-4">
                                <div>
                                    <h3 class="text-xs font-bold text-gray-500 uppercase flex items-center gap-1 mb-2">
                                        <svg class="w-4 h-4 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Masa & Tarikh
                                    </h3>
                                    <div class="flex gap-2 mb-3">
                                        <button type="button" onclick="setTiming('pagi')" class="btn-time px-3 py-1.5 rounded-lg text-[10px] font-bold bg-white uppercase text-gray-500 shadow-sm flex-1">ðŸŒž Pagi (8-1)</button>
                                        <button type="button" onclick="setTiming('petang')" class="btn-time px-3 py-1.5 rounded-lg text-[10px] font-bold bg-white uppercase text-gray-500 shadow-sm flex-1">â›… Petang (2-5)</button>
                                        <button type="button" onclick="setTiming('full')" class="btn-time px-3 py-1.5 rounded-lg text-[10px] font-bold bg-white uppercase text-gray-500 shadow-sm flex-1">ðŸ’¼ Seharian (8-5)</button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                                        <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1">Mula</label>
                                        <div class="flex gap-2">
                                            <input type="date" id="move-date" required class="block w-full border-gray-300 rounded text-xs focus:ring-brand focus:border-brand">
                                            <input type="time" id="start-time" required class="block w-24 border-gray-300 rounded text-xs focus:ring-brand focus:border-brand">
                                        </div>
                                    </div>

                                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                                        <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1" id="end-label">Tamat (Harian)</label>
                                        <div class="flex gap-2">
                                            <input type="date" id="return-date" class="hidden w-full border-gray-300 rounded text-xs focus:ring-brand focus:border-brand">
                                            <input type="time" id="end-time" required class="block w-full border-gray-300 rounded text-xs focus:ring-brand focus:border-brand">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-4 border-gray-100">
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase">Pegawai Turut Serta</label>
                                
                                <div class="flex gap-2">
                                    <select id="group-load-select" onchange="loadGroup(this.value)" class="text-[10px] py-1 pl-2 pr-6 border border-gray-300 rounded bg-white text-gray-600 focus:ring-brand focus:border-brand uppercase cursor-pointer shadow-sm">
                                        <option value="">-- Muat Kumpulan --</option>
                                    </select>
                                    
                                    <button type="button" onclick="saveCurrentGroup()" class="text-[10px] bg-indigo-50 text-brand hover:bg-indigo-100 px-3 py-1 rounded border border-indigo-200 font-bold uppercase flex items-center gap-1 transition shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                                        Simpan
                                    </button>
                                </div>
                            </div>

                            <div class="relative mb-3">
                                <input type="text" id="search-member" placeholder="Cari nama pegawai..." class="block w-full pl-4 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-brand focus:border-brand bg-gray-50 focus:bg-white transition-colors">
                                <div id="search-results" class="absolute z-10 w-full bg-white shadow-xl max-h-48 rounded-lg py-1 mt-1 border border-gray-100 overflow-auto hidden custom-scroll"></div>
                            </div>

                            <div id="members-list" class="flex flex-wrap gap-2 min-h-[50px] p-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 items-start content-start">
                                <p class="text-xs text-gray-400 italic w-full text-center py-2" id="empty-members-msg">Tiada pegawai lain ditambah.</p>
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="btn-submit" class="w-full flex justify-center items-center gap-2 py-3.5 px-4 border border-transparent rounded-xl shadow-lg shadow-indigo-200 text-sm font-bold text-white bg-gradient-to-r from-brand to-accent hover:from-brand-dark hover:to-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand transition-all transform hover:scale-[1.01] uppercase tracking-wide">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                REKOD PERGERAKAN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-100 transition-all">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-indigo-100 mb-6 animate-bounce">
                <svg class="h-10 w-10 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Berjaya!</h3>
            <p class="text-sm text-gray-500 mb-8">Rekod pergerakan telah disimpan. Selamat bertugas!</p>
            <div class="space-y-3">
                 <button onclick="window.location.reload()" class="w-full btn bg-brand text-white font-bold py-3 rounded-xl shadow-lg hover:bg-brand-dark">
                    Rekod Baru
                </button>
                <button onclick="window.location.href='index.html'" class="w-full btn bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200">
                    Ke Halaman Utama
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let currentUser = null;
        let taggedMembers = []; 
        let taggedTargets = []; // New array for target people
        let allUsersCache = [];
        let savedGroups = [];

        onAuthStateChanged(auth, async (user) => {
            if (!user) { try { await signInAnonymously(auth); } catch (e) { console.error(e); } }
            initPage();
        });

        async function initPage() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('move-date').value = today;
            document.getElementById('return-date').value = today;
            document.getElementById('start-time').value = "08:00";
            document.getElementById('end-time').value = "17:00";
            await Promise.all([loadSchools(), preloadUsers()]);
        }

        // --- TIME & DATE LOGIC ---
        window.toggleMultiDay = function() {
            const isMulti = document.getElementById('is-multi-day').checked;
            const returnDateInput = document.getElementById('return-date');
            const endLabel = document.getElementById('end-label');
            const moveDate = document.getElementById('move-date');

            if (isMulti) {
                returnDateInput.classList.remove('hidden');
                returnDateInput.value = moveDate.value;
                returnDateInput.min = moveDate.value;
                endLabel.textContent = "Tarikh & Masa Tamat";
            } else {
                returnDateInput.classList.add('hidden');
                endLabel.textContent = "Tamat (Harian)";
            }
        }

        document.getElementById('move-date').addEventListener('change', function() {
            const returnDateInput = document.getElementById('return-date');
            returnDateInput.min = this.value;
            if(returnDateInput.value < this.value) returnDateInput.value = this.value;
        });

        window.setTiming = function(type) {
            const start = document.getElementById('start-time');
            const end = document.getElementById('end-time');
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            if(type === 'pagi') { start.value = '08:00'; end.value = '13:00'; }
            if(type === 'petang') { start.value = '14:00'; end.value = '17:00'; }
            if(type === 'full') { start.value = '08:00'; end.value = '17:00'; }
            event.target.classList.add('active');
        }

        window.resetForm = function() { location.reload(); }

        // --- 1. VERIFICATION LOGIC ---
        let debounceTimer;
        window.validateApplicant = function() {
            clearTimeout(debounceTimer);
            const input = document.getElementById('applicant-ic');
            const status = document.getElementById('auth-status');
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length < 12) {
                status.textContent = `... ${input.value.length}/12`;
                status.className = "text-xs mt-3 text-indigo-200 font-medium h-5 animate-pulse";
                return;
            }
            status.textContent = "Menyemak...";
            status.className = "text-xs mt-3 text-white font-bold h-5";
            debounceTimer = setTimeout(() => performVerification(input.value), 300);
        }

        async function performVerification(ic) {
            const status = document.getElementById('auth-status');
            const overlay = document.getElementById('form-overlay');
            const display = document.getElementById('user-info-display');
            const authBox = document.getElementById('auth-box');

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    currentUser = { id: snap.docs[0].id, ...data };
                    
                    document.getElementById('user-name').textContent = data.name.toUpperCase();
                    document.getElementById('user-station').textContent = (data.station || data.unit || "N/A").toUpperCase();
                    
                    const imgContainer = document.getElementById('profile-img-container');
                    const adminIC = "890522135381";
                    const isPro = (data.isPro === true) || (ic === adminIC);

                    if (isPro && data.profileImageUrl) {
                        imgContainer.innerHTML = `<img src="${data.profileImageUrl}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
                    } else {
                        const initials = data.name.substring(0,2).toUpperCase();
                        imgContainer.innerHTML = `<span class="text-3xl font-bold text-brand">${initials}</span>`;
                        imgContainer.style.backgroundColor = 'white';
                    }
                    
                    loadUserStats(ic);
                    loadUserGroups(ic);
                    renderMembers();

                    authBox.classList.add('hidden');
                    display.classList.remove('hidden');
                    overlay.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    status.textContent = "Tiada rekod. Sila daftar dahulu.";
                    status.className = "text-xs mt-3 text-red-300 font-bold h-5";
                }
            } catch (e) { console.error(e); status.textContent = "Ralat sambungan."; }
        }

        async function loadUserStats(ic) {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_programs`), where("penyelaras_ic", "==", ic), where("type", "==", "movement"));
                const snap = await getDocs(q);
                let total = snap.size;
                let monthCount = 0;
                const currentMonth = new Date().getMonth();
                snap.forEach(doc => {
                    const d = new Date(doc.data().startDate);
                    if (d.getMonth() === currentMonth) monthCount++;
                });
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-month').textContent = monthCount;
            } catch (e) {}
        }

        // --- 2. DATA LOADING ---
        async function loadSchools() {
            const select = document.getElementById('destination-select');
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_schools`), orderBy("name"));
                const snap = await getDocs(q);
                select.innerHTML = '<option value="">-- Pilih Destinasi --</option>';
                snap.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.data().name;
                    opt.textContent = doc.data().name;
                    select.appendChild(opt);
                });
                select.innerHTML += '<option value="LAIN-LAIN">LAIN-LAIN (NYATAKAN DI TUJUAN)</option>';
            } catch(e) {}
        }

        async function preloadUsers() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), orderBy("name"));
                const snap = await getDocs(q);
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.ic) allUsersCache.push({ name: d.name.toUpperCase(), ic: d.ic, station: d.station || '' });
                });
            } catch (e) {}
        }

        // --- 3. MEMBERS (TEAM) LOGIC ---
        const searchInput = document.getElementById('search-member');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            searchResults.innerHTML = '';
            if (val.length < 3) { searchResults.classList.add('hidden'); return; }

            const matches = allUsersCache.filter(u => u.name.includes(val) && u.ic !== currentUser.ic && !taggedMembers.some(tm => tm.ic === u.ic)).slice(0, 8);
            
            if (matches.length > 0) {
                searchResults.classList.remove('hidden');
                matches.forEach(user => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-indigo-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0";
                    div.innerHTML = `<div class="font-bold text-xs">${user.name}</div><div class="text-[10px] text-gray-400">${user.station}</div>`;
                    div.onclick = () => addMember(user);
                    searchResults.appendChild(div);
                });
            } else { searchResults.classList.add('hidden'); }
        });
        
        document.addEventListener('click', (e) => {
            if(!searchInput.contains(e.target) && !searchResults.contains(e.target)) searchResults.classList.add('hidden');
        });

        function addMember(user) {
            taggedMembers.push(user);
            renderMembers();
            searchInput.value = '';
            searchResults.classList.add('hidden');
        }

        window.removeMember = function(ic) {
            taggedMembers = taggedMembers.filter(m => m.ic !== ic);
            renderMembers();
        }

        function renderMembers() {
            const container = document.getElementById('members-list');
            container.innerHTML = '';
            
            if (currentUser) {
                const selfTag = document.createElement('span');
                selfTag.className = "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold bg-brand text-white shadow-sm border border-brand-dark mb-1 mr-1";
                const dispName = currentUser.name.split(' ').slice(0,3).join(' ');
                selfTag.innerHTML = `<span class="mr-1">ðŸ‘‘</span> ${dispName}`;
                container.appendChild(selfTag);
            }

            taggedMembers.forEach(m => {
                const tag = document.createElement('span');
                tag.className = "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-white border border-gray-300 text-gray-700 shadow-sm mb-1 mr-1";
                const dispName = m.name.split(' ').slice(0,3).join(' ');
                tag.innerHTML = `${dispName} <button type="button" onclick="removeMember('${m.ic}')" class="ml-2 text-gray-400 hover:text-red-500 font-bold focus:outline-none">Ã—</button>`;
                container.appendChild(tag);
            });
        }

        // --- 4. TARGET PERSON LOGIC (NEW) ---
        const searchTarget = document.getElementById('search-target');
        const targetResults = document.getElementById('target-results');

        searchTarget.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            targetResults.innerHTML = '';
            if (val.length < 3) { targetResults.classList.add('hidden'); return; }

            // Can select anyone as target, including self if needed (unlikely)
            const matches = allUsersCache.filter(u => u.name.includes(val) && !taggedTargets.some(tt => tt.ic === u.ic)).slice(0, 8);
            
            if (matches.length > 0) {
                targetResults.classList.remove('hidden');
                matches.forEach(user => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-indigo-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0";
                    div.innerHTML = `<div class="font-bold text-xs">${user.name}</div><div class="text-[10px] text-gray-400">${user.station}</div>`;
                    div.onclick = () => addTarget(user);
                    targetResults.appendChild(div);
                });
            } else { targetResults.classList.add('hidden'); }
        });

        document.addEventListener('click', (e) => {
            if(!searchTarget.contains(e.target) && !targetResults.contains(e.target)) targetResults.classList.add('hidden');
        });

        function addTarget(user) {
            taggedTargets.push(user);
            renderTargets();
            searchTarget.value = '';
            targetResults.classList.add('hidden');
        }

        window.removeTarget = function(ic) {
            taggedTargets = taggedTargets.filter(t => t.ic !== ic);
            renderTargets();
        }

        function renderTargets() {
            const container = document.getElementById('target-list');
            container.innerHTML = '';
            
            taggedTargets.forEach(m => {
                const tag = document.createElement('span');
                // Different color for Targets (Orange/Amber) to distinguish from Team
                tag.className = "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-orange-50 border border-orange-200 text-orange-800 shadow-sm mb-1 mr-1";
                const dispName = m.name.split(' ').slice(0,3).join(' ');
                tag.innerHTML = `<span class="mr-1">ðŸŽ¯</span>${dispName} <button type="button" onclick="removeTarget('${m.ic}')" class="ml-2 text-orange-400 hover:text-red-500 font-bold focus:outline-none">Ã—</button>`;
                container.appendChild(tag);
            });
        }

        // --- GROUP LOGIC ---
        async function loadUserGroups(ic) {
            const select = document.getElementById('group-load-select');
            select.innerHTML = '<option value="">-- Muat Kumpulan --</option>';
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), where("ownerIc", "==", ic));
                const snap = await getDocs(q);
                savedGroups = [];
                snap.forEach(doc => {
                    const g = { id: doc.id, ...doc.data() };
                    savedGroups.push(g);
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    select.appendChild(opt);
                });
            } catch (e) {}
        }

        window.loadGroup = function(groupId) {
            if(!groupId) return;
            const group = savedGroups.find(g => g.id === groupId);
            if(group && group.members) {
                group.members.forEach(newMember => {
                    if(newMember.ic !== currentUser.ic && !taggedMembers.some(existing => existing.ic === newMember.ic)) {
                        taggedMembers.push(newMember);
                    }
                });
                renderMembers();
                document.getElementById('group-load-select').value = "";
            }
        }

        window.saveCurrentGroup = async function() {
            if(taggedMembers.length === 0) {
                alert("Sila tambah pegawai lain untuk disimpan.");
                return;
            }
            const groupName = prompt("Namakan kumpulan ini (Cth: Team Audit):");
            if(!groupName) return;

            try {
                const newGroup = {
                    name: groupName.toUpperCase(),
                    ownerIc: currentUser.ic,
                    members: taggedMembers.map(m => ({ name: m.name, ic: m.ic, station: m.station || '' })),
                    createdAt: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), newGroup);
                savedGroups.push({ id: docRef.id, ...newGroup });
                const select = document.getElementById('group-load-select');
                const opt = document.createElement('option');
                opt.value = docRef.id;
                opt.textContent = newGroup.name;
                select.appendChild(opt);
                alert("Kumpulan disimpan!");
            } catch (e) { alert("Gagal menyimpan."); }
        }

        // --- 5. SUBMIT ---
        window.submitMovement = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            if(!currentUser) return;
            
            btn.disabled = true;
            btn.innerHTML = "Menyimpan Rekod...";
            
            const focus = document.getElementById('ppd-focus').value;
            const type = document.getElementById('visit-type').value;
            const reason = document.getElementById('visit-reason').value.toUpperCase();
            const dest = document.getElementById('destination-select').value;
            
            // Date Logic
            const startDate = document.getElementById('move-date').value;
            const isMulti = document.getElementById('is-multi-day').checked;
            const endDate = isMulti ? document.getElementById('return-date').value : startDate;
            
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;

            const programKey = `GO-${Math.random().toString(36).substring(2,7).toUpperCase()}`;
            
            const attendees = [
                { ic: currentUser.ic, name: currentUser.name, org: currentUser.station || '', status: 'Hadir', timestamp: new Date().toISOString() }
            ];
            taggedMembers.forEach(m => {
                attendees.push({ ic: m.ic, name: m.name, org: m.station || '', status: 'Hadir', timestamp: new Date().toISOString() });
            });

            // Map Targets to store in DB
            const meetWithList = taggedTargets.map(t => ({ name: t.name, ic: t.ic, station: t.station || '' }));

            const record = {
                key: programKey,
                name: `SPARK GO: ${dest}`,
                location: dest,
                description: `[${focus.toUpperCase()}] ${reason}`,
                visitType: type,
                focusArea: focus,
                startDate: startDate, 
                endDate: endDate,
                startTime: start, 
                endTime: end,
                quota: attendees.length,
                penyelaras_ic: currentUser.ic,
                penyelaras_name: currentUser.name,
                attendance: attendees,
                meetWith: meetWithList, // Storing target people here
                status: 'Selesai',
                type: 'movement',
                createdAt: serverTimestamp(),
                method: 'bersemuka',
                bookingNeeded: false, surveyNeeded: false, evaluationNeeded: false, eCertificateNeeded: false
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/spark_programs`), record);
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Ralat menyimpan rekod.");
                btn.disabled = false;
                btn.innerHTML = "REKOD PERGERAKAN";
            }
        }
    </script>
</body>
</html>
