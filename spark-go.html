<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK Go â€“ Rekod Pergerakan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        grab: {
                            DEFAULT: '#00B14F',
                            dark: '#009e47',
                            light: '#e5f7ed'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-time { transition: all 0.2s; border: 1px solid #d1d5db; }
        .btn-time:hover { border-color: #00B14F; color: #00B14F; background-color: #e5f7ed; }
        .btn-time.active { background-color: #00B14F; color: white; border-color: #00B14F; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .profile-img-wrapper {
            width: 80px; height: 80px; 
            border-radius: 50%; 
            border: 4px solid rgba(255,255,255,0.3);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-grab p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800 tracking-tight">SPARK <span class="text-grab">Go</span></h1>
                    <p class="text-[10px] md:text-xs text-gray-500 font-medium uppercase tracking-wide">Rekod Pergerakan Pegawai</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='index.html'" class="px-4 py-2 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-100 border border-transparent hover:border-gray-200 transition-colors uppercase">
                    Utama
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-6xl mx-auto border border-gray-100">
            <div class="md:flex min-h-[600px]">
                
                <div class="md:w-2/5 bg-grab p-8 text-white relative flex flex-col justify-center items-center text-center">
                    <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-bl-full pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-white opacity-10 rounded-tr-full pointer-events-none"></div>

                    <div class="relative z-10 w-full max-w-xs">
                        
                        <div id="auth-box" class="transition-all duration-500">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold mb-1">Log Masuk Pegawai</h2>
                                <p class="text-emerald-100 text-sm">Masukkan No. IC untuk mula merekod.</p>
                            </div>
                            
                            <div class="relative">
                                <input type="text" id="applicant-ic" maxlength="12" oninput="validateApplicant()" placeholder="No. Kad Pengenalan" class="block w-full px-4 py-4 text-center text-lg tracking-widest border-2 border-white/30 bg-white/10 rounded-xl text-white placeholder-white/50 focus:outline-none focus:bg-white/20 focus:border-white transition-all shadow-inner">
                            </div>
                            <p id="auth-status" class="text-xs mt-3 text-white font-medium h-5 animate-pulse"></p>
                        </div>

                        <div id="user-info-display" class="hidden animate-fade-in-up w-full">
                            
                            <div class="flex justify-center mb-4">
                                <div id="profile-img-container" class="profile-img-wrapper shadow-xl">
                                    </div>
                            </div>

                            <h3 id="user-name" class="font-bold text-xl leading-tight text-white mb-1">NAMA PEGAWAI</h3>
                            <p id="user-station" class="text-xs text-emerald-100 uppercase bg-black/10 inline-block px-3 py-1 rounded-full mb-6">Jawatan / Unit</p>

                            <div class="glass-panel p-4 rounded-xl grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <p class="text-3xl font-bold text-white" id="stat-month">0</p>
                                    <p class="text-[9px] uppercase text-emerald-100 tracking-wider font-bold">Bulan Ini</p>
                                </div>
                                <div>
                                    <p class="text-3xl font-bold text-white" id="stat-total">0</p>
                                    <p class="text-[9px] uppercase text-emerald-100 tracking-wider font-bold">Jumlah Total</p>
                                </div>
                            </div>
                            
                            <button onclick="resetForm()" class="mt-8 text-xs text-white/70 hover:text-white underline">Tukar Pegawai</button>
                        </div>
                    </div>
                </div>

                <div class="md:w-3/5 p-6 md:p-10 bg-white relative">
                    
                    <div id="form-overlay" class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm transition-opacity duration-300">
                        <div class="bg-gray-50 p-6 rounded-full mb-4 shadow-sm">
                            <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </div>
                        <p class="text-gray-500 font-bold uppercase text-sm tracking-wide">Sila imbas atau masukkan IC di sebelah kiri</p>
                    </div>

                    <form onsubmit="submitMovement(event)" class="space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fokus Strategik</label>
                                <select id="ppd-focus" required class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-grab focus:border-grab bg-white hover:bg-gray-50 transition-colors">
                                    <option value="">-- Sila Pilih Fokus --</option>
                                    <option value="Kemenjadian Murid">Kemenjadian Murid</option>
                                    <option value="Sekolah Berkualiti">Sekolah Berkualiti</option>
                                    <option value="Guru Berkualiti">Guru Berkualiti</option>
                                    <option value="Sokongan PIBG/Komuniti">Sokongan PIBG/Komuniti</option>
                                    <option value="Infrastruktur & Aset">Infrastruktur & Aset</option>
                                    <option value="Pengurusan Tertinggi">Pengurusan Tertinggi</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenis Lawatan</label>
                                <select id="visit-type" required class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-grab focus:border-grab bg-white hover:bg-gray-50 transition-colors">
                                    <option value="KUNJUNG BANTU">KUNJUNG BANTU</option>
                                    <option value="BIMBINGAN">BIMBINGAN & PEMENTORAN</option>
                                    <option value="PEMANTAUAN">PEMANTAUAN / AUDIT</option>
                                    <option value="LAWATAN RASMI">LAWATAN RASMI / KERJA</option>
                                    <option value="MESYUARAT">MESYUARAT LUAR</option>
                                    <option value="LAIN-LAIN">LAIN-LAIN</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi / Destinasi</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                <select id="destination-select" required class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-grab focus:border-grab bg-white">
                                    <option value="">Memuatkan senarai sekolah...</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tujuan / Aktiviti Spesifik</label>
                            <textarea id="visit-reason" rows="3" required placeholder="Nyatakan tujuan atau aktiviti yang akan dijalankan dengan lebih spesifik..." class="block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-grab focus:border-grab resize-none"></textarea>
                        </div>

                        <div class="bg-grab-light p-5 rounded-xl border border-green-100">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xs font-bold text-gray-500 uppercase flex items-center gap-1">
                                    <svg class="w-4 h-4 text-grab" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    Masa Pergerakan
                                </h3>
                                <div class="flex gap-1">
                                    <button type="button" onclick="setTiming('pagi')" class="btn-time px-2 py-1 rounded text-[10px] font-semibold bg-white uppercase text-gray-600">8.00 - 1.00</button>
                                    <button type="button" onclick="setTiming('petang')" class="btn-time px-2 py-1 rounded text-[10px] font-semibold bg-white uppercase text-gray-600">2.00 - 5.00</button>
                                    <button type="button" onclick="setTiming('full')" class="btn-time px-2 py-1 rounded text-[10px] font-semibold bg-white uppercase text-gray-600">8.00 - 5.00</button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Tarikh</label>
                                    <input type="date" id="move-date" required class="block w-full border-gray-300 rounded-lg text-xs py-2 focus:ring-grab focus:border-grab shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Masa Keluar</label>
                                    <input type="time" id="start-time" required class="block w-full border-gray-300 rounded-lg text-xs py-2 focus:ring-grab focus:border-grab shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Jangkaan Balik</label>
                                    <input type="time" id="end-time" required class="block w-full border-gray-300 rounded-lg text-xs py-2 focus:ring-grab focus:border-grab shadow-sm">
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-4 border-gray-100">
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase">Pegawai Turut Serta</label>
                                
                                <div class="flex gap-2">
                                    <select id="group-load-select" onchange="loadGroup(this.value)" class="text-[10px] py-1 pl-2 pr-6 border border-gray-300 rounded bg-white text-gray-600 focus:ring-grab focus:border-grab uppercase cursor-pointer">
                                        <option value="">-- Muat Kumpulan --</option>
                                    </select>
                                    
                                    <button type="button" onclick="saveCurrentGroup()" class="text-[10px] bg-green-50 text-grab hover:bg-green-100 px-2 py-1 rounded border border-green-200 font-bold uppercase flex items-center gap-1 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                                        Simpan
                                    </button>
                                </div>
                            </div>

                            <div class="relative mb-3">
                                <input type="text" id="search-member" placeholder="Cari nama pegawai untuk ditambah..." class="block w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-grab focus:border-grab bg-gray-50 focus:bg-white transition-colors">
                                <div id="search-results" class="absolute z-10 w-full bg-white shadow-xl max-h-48 rounded-lg py-1 mt-1 border border-gray-100 overflow-auto hidden custom-scroll"></div>
                            </div>

                            <div id="members-list" class="flex flex-wrap gap-2 min-h-[50px] p-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 items-start content-start">
                                <p class="text-xs text-gray-400 italic w-full text-center py-2" id="empty-members-msg">Tiada pegawai lain ditag.</p>
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="btn-submit" class="w-full flex justify-center items-center gap-2 py-3.5 px-4 border border-transparent rounded-xl shadow-lg shadow-green-200 text-sm font-bold text-white bg-grab hover:bg-grab-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-grab transition-all transform hover:scale-[1.01] uppercase tracking-wide">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                REKOD PERGERAKAN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-100 transition-all">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6 animate-bounce">
                <svg class="h-10 w-10 text-grab" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Pergerakan Direkod!</h3>
            <p class="text-sm text-gray-500 mb-8">Data telah disimpan. Semua pegawai yang disenaraikan telah ditandakan sebagai HADIR.</p>
            <div class="space-y-3">
                 <button onclick="window.location.reload()" class="w-full btn bg-grab text-white font-bold py-3 rounded-xl shadow-lg hover:bg-grab-dark">
                    Rekod Baru
                </button>
                <button onclick="window.location.href='index.html'" class="w-full btn bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200">
                    Ke Halaman Utama
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let currentUser = null;
        let taggedMembers = []; 
        let allUsersCache = [];
        let savedGroups = [];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { try { await signInAnonymously(auth); } catch (e) { console.error(e); } }
            initPage();
        });

        async function initPage() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('move-date').value = today;
            // Default time set via setTiming('pagi') logic manually if needed, or leave empty
            document.getElementById('start-time').value = "08:00";
            document.getElementById('end-time').value = "17:00";
            await Promise.all([loadSchools(), preloadUsers()]);
        }

        // --- TIME TEMPLATES ---
        window.setTiming = function(type) {
            const start = document.getElementById('start-time');
            const end = document.getElementById('end-time');
            
            // Reset active classes
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            
            if(type === 'pagi') { 
                start.value = '08:00'; end.value = '13:00'; 
                event.target.classList.add('active');
            }
            if(type === 'petang') { 
                start.value = '14:00'; end.value = '17:00'; 
                event.target.classList.add('active');
            }
            if(type === 'full') { 
                start.value = '08:00'; end.value = '17:00'; 
                event.target.classList.add('active');
            }
        }

        window.resetForm = function() {
            location.reload();
        }

        // --- 1. VERIFICATION LOGIC ---
        let debounceTimer;
        window.validateApplicant = function() {
            clearTimeout(debounceTimer);
            const input = document.getElementById('applicant-ic');
            const status = document.getElementById('auth-status');
            
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length < 12) {
                status.textContent = `Menunggu input... (${input.value.length}/12)`;
                return;
            }
            status.textContent = "Menyemak...";
            debounceTimer = setTimeout(() => performVerification(input.value), 300);
        }

        async function performVerification(ic) {
            const status = document.getElementById('auth-status');
            const overlay = document.getElementById('form-overlay');
            const display = document.getElementById('user-info-display');
            const authBox = document.getElementById('auth-box');

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    currentUser = { id: snap.docs[0].id, ...data };
                    
                    // UI Updates
                    document.getElementById('user-name').textContent = data.name.toUpperCase();
                    document.getElementById('user-station').textContent = (data.station || data.unit || "N/A").toUpperCase();
                    
                    // Profile Image Logic (Pro check)
                    const imgContainer = document.getElementById('profile-img-container');
                    const adminIC = "890522135381";
                    const isPro = (data.isPro === true) || (ic === adminIC);

                    if (isPro && data.profileImageUrl) {
                        imgContainer.innerHTML = `<img src="${data.profileImageUrl}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
                    } else {
                        // Default Initials
                        const initials = data.name.substring(0,2).toUpperCase();
                        imgContainer.innerHTML = `<span class="text-3xl font-bold text-grab">${initials}</span>`;
                        imgContainer.style.backgroundColor = 'white';
                    }
                    
                    loadUserStats(ic);
                    loadUserGroups(ic);
                    renderMembers(); // Re-render members list to show correct Self name

                    // Switch View
                    authBox.classList.add('hidden');
                    display.classList.remove('hidden');
                    overlay.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    status.textContent = "Tiada rekod. Sila daftar dahulu.";
                }
            } catch (e) { console.error(e); status.textContent = "Ralat sambungan."; }
        }

        async function loadUserStats(ic) {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_programs`), where("penyelaras_ic", "==", ic), where("type", "==", "movement"));
                const snap = await getDocs(q);
                let total = snap.size;
                let monthCount = 0;
                const currentMonth = new Date().getMonth();
                snap.forEach(doc => {
                    const d = new Date(doc.data().startDate);
                    if (d.getMonth() === currentMonth) monthCount++;
                });
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-month').textContent = monthCount;
            } catch (e) {}
        }

        // --- 2. DATA LOADING ---
        async function loadSchools() {
            const select = document.getElementById('destination-select');
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_schools`), orderBy("name"));
                const snap = await getDocs(q);
                select.innerHTML = '<option value="">-- Pilih Destinasi --</option>';
                snap.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.data().name;
                    opt.textContent = doc.data().name;
                    select.appendChild(opt);
                });
                select.innerHTML += '<option value="LAIN-LAIN">LAIN-LAIN (NYATAKAN DI TUJUAN)</option>';
            } catch(e) {}
        }

        async function preloadUsers() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), orderBy("name"));
                const snap = await getDocs(q);
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.ic) allUsersCache.push({ name: d.name.toUpperCase(), ic: d.ic, station: d.station || '' });
                });
            } catch (e) {}
        }

        // --- 3. MEMBERS LOGIC ---
        const searchInput = document.getElementById('search-member');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            searchResults.innerHTML = '';
            if (val.length < 3) { searchResults.classList.add('hidden'); return; }

            const matches = allUsersCache.filter(u => u.name.includes(val) && u.ic !== currentUser.ic && !taggedMembers.some(tm => tm.ic === u.ic)).slice(0, 8);
            
            if (matches.length > 0) {
                searchResults.classList.remove('hidden');
                matches.forEach(user => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-green-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0";
                    div.innerHTML = `<div class="font-bold text-xs">${user.name}</div><div class="text-[10px] text-gray-400">${user.station}</div>`;
                    div.onclick = () => addMember(user);
                    searchResults.appendChild(div);
                });
            } else { searchResults.classList.add('hidden'); }
        });
        
        document.addEventListener('click', (e) => {
            if(!searchInput.contains(e.target) && !searchResults.contains(e.target)) searchResults.classList.add('hidden');
        });

        function addMember(user) {
            taggedMembers.push(user);
            renderMembers();
            searchInput.value = '';
            searchResults.classList.add('hidden');
        }

        window.removeMember = function(ic) {
            taggedMembers = taggedMembers.filter(m => m.ic !== ic);
            renderMembers();
        }

        function renderMembers() {
            const container = document.getElementById('members-list');
            const emptyMsg = document.getElementById('empty-members-msg');
            container.innerHTML = '';
            
            // 1. Current User Tag
            if (currentUser) {
                const selfTag = document.createElement('span');
                selfTag.className = "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold bg-grab text-white shadow-sm border border-grab-dark mb-1 mr-1";
                // Get first name or first two words
                const shortName = currentUser.name.split(' ').slice(0,2).join(' ');
                selfTag.innerHTML = `<span class="mr-1">ðŸ‘‘</span> ${shortName}`;
                container.appendChild(selfTag);
            }

            // 2. Other Members
            if (taggedMembers.length > 0) {
                taggedMembers.forEach(m => {
                    const tag = document.createElement('span');
                    tag.className = "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-white border border-gray-300 text-gray-700 shadow-sm mb-1 mr-1";
                    // Short name for tag
                    const shortName = m.name.split(' ').slice(0,2).join(' ');
                    tag.innerHTML = `${shortName} <button type="button" onclick="removeMember('${m.ic}')" class="ml-2 text-gray-400 hover:text-red-500 font-bold focus:outline-none">Ã—</button>`;
                    container.appendChild(tag);
                });
            } else {
                // If only currentUser is there (implied by container logic above), append empty text?
                // Actually we just appended currentUser, so list isn't empty. 
                // We can add a small text if NO TAGGED members.
                // But logic above always adds user.
            }
        }

        // --- GROUP LOGIC ---
        async function loadUserGroups(ic) {
            const select = document.getElementById('group-load-select');
            select.innerHTML = '<option value="">-- Muat Kumpulan --</option>';
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), where("ownerIc", "==", ic));
                const snap = await getDocs(q);
                savedGroups = [];
                snap.forEach(doc => {
                    const g = { id: doc.id, ...doc.data() };
                    savedGroups.push(g);
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    select.appendChild(opt);
                });
            } catch (e) {}
        }

        window.loadGroup = function(groupId) {
            if(!groupId) return;
            const group = savedGroups.find(g => g.id === groupId);
            if(group && group.members) {
                group.members.forEach(newMember => {
                    if(newMember.ic !== currentUser.ic && !taggedMembers.some(existing => existing.ic === newMember.ic)) {
                        taggedMembers.push(newMember);
                    }
                });
                renderMembers();
                document.getElementById('group-load-select').value = "";
            }
        }

        window.saveCurrentGroup = async function() {
            if(taggedMembers.length === 0) {
                alert("Sila tambah pegawai lain untuk disimpan.");
                return;
            }
            const groupName = prompt("Namakan kumpulan ini (Cth: Unit ICT):");
            if(!groupName) return;

            try {
                const newGroup = {
                    name: groupName.toUpperCase(),
                    ownerIc: currentUser.ic,
                    members: taggedMembers.map(m => ({ name: m.name, ic: m.ic, station: m.station || '' })),
                    createdAt: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), newGroup);
                savedGroups.push({ id: docRef.id, ...newGroup });
                const select = document.getElementById('group-load-select');
                const opt = document.createElement('option');
                opt.value = docRef.id;
                opt.textContent = newGroup.name;
                select.appendChild(opt);
                alert("Kumpulan disimpan!");
            } catch (e) { alert("Gagal menyimpan."); }
        }

        // --- 4. SUBMIT ---
        window.submitMovement = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            if(!currentUser) return;
            
            btn.disabled = true;
            btn.innerHTML = "Menyimpan Rekod...";
            
            const focus = document.getElementById('ppd-focus').value;
            const type = document.getElementById('visit-type').value;
            const reason = document.getElementById('visit-reason').value.toUpperCase();
            const dest = document.getElementById('destination-select').value;
            const date = document.getElementById('move-date').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;

            const programKey = `GO-${Math.random().toString(36).substring(2,7).toUpperCase()}`;
            
            const attendees = [
                { ic: currentUser.ic, name: currentUser.name, org: currentUser.station || '', status: 'Hadir', timestamp: new Date().toISOString() }
            ];
            taggedMembers.forEach(m => {
                attendees.push({ ic: m.ic, name: m.name, org: m.station || '', status: 'Hadir', timestamp: new Date().toISOString() });
            });

            const record = {
                key: programKey,
                name: `SPARK GO: ${dest}`,
                location: dest,
                description: `[${focus.toUpperCase()}] ${reason}`,
                visitType: type,
                focusArea: focus,
                startDate: date, endDate: date,
                startTime: start, endTime: end,
                quota: attendees.length,
                penyelaras_ic: currentUser.ic,
                penyelaras_name: currentUser.name,
                attendance: attendees,
                status: 'Selesai',
                type: 'movement',
                createdAt: serverTimestamp(),
                method: 'bersemuka',
                bookingNeeded: false, surveyNeeded: false, evaluationNeeded: false, eCertificateNeeded: false
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/spark_programs`), record);
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Ralat sistem.");
                btn.disabled = false;
                btn.innerHTML = "REKOD PERGERAKAN";
            }
        }
    </script>
</body>
</html>
