<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK Go â€“ Rekod Pergerakan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .input-with-icon { position: relative; }
        .input-with-icon svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .input-with-icon input, .input-with-icon select { padding-left: 2.5rem; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        input:disabled, select:disabled, textarea:disabled, button:disabled {
            background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7;
        }
    </style>
</head>
<body class="bg-green-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-emerald-600 p-2 rounded-lg shadow-lg shadow-emerald-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-emerald-700 tracking-tight">SPARK <span class="text-gray-800">Go</span></h1>
                    <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Rekod Pergerakan & Tugasan Luar</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='index.html'" class="btn bg-gray-100 text-gray-600 hover:bg-gray-200 py-2 px-4 rounded-lg text-sm font-semibold">
                    Halaman Utama
                </button>
                <button onclick="window.location.href='semak.html'" class="btn bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 px-4 rounded-lg text-sm font-semibold">
                    Jana Program
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-8 px-4 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-6xl mx-auto">
            <div class="md:flex min-h-[600px]">
                
                <div class="md:w-2/5 bg-gradient-to-br from-emerald-600 to-teal-800 p-8 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-5"></div>
                    <div class="absolute bottom-0 left-0 -ml-16 -mb-16 w-64 h-64 rounded-full bg-white opacity-5"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="bg-white/20 p-2 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            </div>
                            <h2 class="text-2xl font-bold">Profil Pegawai</h2>
                        </div>

                        <div id="auth-box">
                            <p class="text-emerald-100 mb-2 text-sm">Sahkan No. IC untuk mula merekod.</p>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 5a1 1 0 100-2H4a1 1 0 100 2h12zM4 13a1 1 0 100 2h6a1 1 0 100-2H4z" clip-rule="evenodd" /></svg>
                                <input type="text" id="applicant-ic" maxlength="12" oninput="validateApplicant()" placeholder="No. Kad Pengenalan" class="block w-full px-4 py-3 border border-emerald-400 bg-emerald-800/50 rounded-lg text-white placeholder-emerald-300/70 focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:border-transparent shadow-inner">
                            </div>
                            <p id="auth-status" class="text-xs mt-2 text-emerald-200 h-4"></p>
                        </div>

                        <div id="user-info-display" class="hidden mt-6 animate-fade-in-up">
                            <div class="glass-panel p-5 rounded-xl border border-white/20">
                                <div class="flex items-center gap-4">
                                    <div class="bg-white text-emerald-700 h-12 w-12 rounded-full flex items-center justify-center font-bold text-lg shadow-lg">
                                        <span id="user-initials">AB</span>
                                    </div>
                                    <div>
                                        <h3 id="user-name" class="font-bold text-lg leading-tight text-white">NAMA PEGAWAI</h3>
                                        <p id="user-station" class="text-xs text-emerald-200 uppercase mt-1">Jawatan / Stesyen</p>
                                    </div>
                                </div>
                                
                                <div class="mt-6 pt-4 border-t border-white/10 grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <p class="text-3xl font-bold text-white" id="stat-month">0</p>
                                        <p class="text-[10px] uppercase text-emerald-200 tracking-wider font-semibold">Pergerakan Bulan Ini</p>
                                    </div>
                                    <div>
                                        <p class="text-3xl font-bold text-white" id="stat-total">0</p>
                                        <p class="text-[10px] uppercase text-emerald-200 tracking-wider font-semibold">Jumlah Keseluruhan</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 bg-black/20 rounded-lg p-4">
                                <p class="text-xs text-emerald-200 text-center italic">
                                    "Rekod yang tepat menjamin integriti perkhidmatan."
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:w-3/5 p-8 bg-white relative">
                    <div id="form-overlay" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-[2px]">
                        <svg class="w-12 h-12 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <p class="text-gray-500 font-semibold uppercase">Sila masukkan IC di sebelah kiri</p>
                    </div>

                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-emerald-100 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 01-.809-.983L15 7m0 13V7m0 0L9.553 4.553A1 1 0 019 3.618" /></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Butiran Pergerakan</h2>
                    </div>

                    <form onsubmit="submitMovement(event)" class="space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fokus Strategik / Objektif</label>
                                <select id="ppd-focus" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 bg-gray-50 hover:bg-white transition-colors">
                                    <option value="">-- Pilih Fokus --</option>
                                    <option value="Kemenjadian Murid">Kemenjadian Murid</option>
                                    <option value="Sekolah Berkualiti">Sekolah Berkualiti</option>
                                    <option value="Guru Berkualiti">Guru Berkualiti</option>
                                    <option value="Sokongan PIBG/Komuniti">Sokongan PIBG/Komuniti</option>
                                    <option value="Infrastruktur & Aset">Infrastruktur & Aset</option>
                                    <option value="Pengurusan Tertinggi">Pengurusan Tertinggi</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenis Lawatan</label>
                                <select id="visit-type" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 bg-gray-50 hover:bg-white transition-colors">
                                    <option value="KUNJUNG BANTU">KUNJUNG BANTU</option>
                                    <option value="BIMBINGAN">BIMBINGAN & PEMENTORAN</option>
                                    <option value="PEMANTAUAN">PEMANTAUAN / AUDIT</option>
                                    <option value="LAWATAN RASMI">LAWATAN RASMI / KERJA</option>
                                    <option value="MESYUARAT">MESYUARAT LUAR</option>
                                    <option value="LAIN-LAIN">LAIN-LAIN</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tujuan / Aktiviti Spesifik</label>
                            <input type="text" id="visit-reason" required placeholder="Contoh: Semakan Aset Alih / Dialog Prestasi" class="block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi / Destinasi</label>
                            <div class="input-with-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                <select id="destination-select" required class="block w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                                    <option value="">Memuatkan senarai sekolah...</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Masa Pergerakan
                            </h3>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-semibold mb-1">Tarikh</label>
                                    <input type="date" id="move-date" required class="block w-full border-gray-300 rounded-md text-xs py-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-semibold mb-1">Masa Keluar</label>
                                    <input type="time" id="start-time" required class="block w-full border-gray-300 rounded-md text-xs py-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase font-semibold mb-1">Jangkaan Balik</label>
                                    <input type="time" id="end-time" required class="block w-full border-gray-300 rounded-md text-xs py-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-4 border-gray-100">
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase">Rakan Setugas (Tagging)</label>
                                
                                <div class="flex gap-2">
                                    <select id="group-load-select" onchange="loadGroup(this.value)" class="text-[10px] py-1 pl-2 pr-6 border border-gray-300 rounded bg-white text-gray-600 focus:ring-emerald-500 focus:border-emerald-500 uppercase">
                                        <option value="">-- Muat Kumpulan --</option>
                                    </select>
                                    
                                    <button type="button" onclick="saveCurrentGroup()" class="text-[10px] bg-emerald-100 text-emerald-700 hover:bg-emerald-200 px-2 py-1 rounded border border-emerald-200 font-bold uppercase flex items-center gap-1 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                                        Simpan
                                    </button>
                                </div>
                            </div>

                            <div class="relative mb-3">
                                <input type="text" id="search-member" placeholder="Cari nama pegawai untuk ditambah..." class="block w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 bg-gray-50 focus:bg-white transition-colors">
                                <div id="search-results" class="absolute z-10 w-full bg-white shadow-xl max-h-48 rounded-lg py-1 mt-1 border border-gray-100 overflow-auto hidden custom-scroll"></div>
                            </div>

                            <div id="members-list" class="flex flex-wrap gap-2 min-h-[40px] p-2 rounded-lg bg-gray-50 border border-dashed border-gray-300">
                                <span id="applicant-badge" class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold bg-emerald-600 text-white shadow-sm">
                                    <span class="mr-1">ðŸ‘‘</span> ANDA
                                </span>
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="btn-submit" class="w-full flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-xl shadow-lg shadow-emerald-200 text-sm font-bold text-white bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all transform hover:scale-[1.01]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                REKOD PERGERAKAN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-100 transition-all">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-emerald-100 mb-6 animate-bounce">
                <svg class="h-10 w-10 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Berjaya!</h3>
            <p class="text-sm text-gray-500 mb-8">Pergerakan anda dan rombongan telah direkodkan ke dalam sistem SPARK.</p>
            <div class="space-y-3">
                 <button onclick="window.location.reload()" class="w-full btn bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-700">
                    Rekod Baru
                </button>
                <button onclick="window.location.href='index.html'" class="w-full btn bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200">
                    Ke Halaman Utama
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let currentUser = null;
        let taggedMembers = []; 
        let allUsersCache = [];
        let savedGroups = [];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try { await signInAnonymously(auth); } catch (e) { console.error(e); }
            }
            initPage();
        });

        async function initPage() {
            // Set Default Dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('move-date').value = today;
            document.getElementById('start-time').value = "08:00";
            document.getElementById('end-time').value = "17:00";

            // Load Data
            await Promise.all([loadSchools(), preloadUsers()]);
        }

        // --- 1. VERIFICATION LOGIC ---
        let debounceTimer;
        window.validateApplicant = function() {
            clearTimeout(debounceTimer);
            const input = document.getElementById('applicant-ic');
            const status = document.getElementById('auth-status');
            
            // Clean input
            input.value = input.value.replace(/[^0-9]/g, '');
            
            if (input.value.length < 12) {
                status.textContent = `Menunggu input... (${input.value.length}/12)`;
                return;
            }
            
            status.textContent = "Sedang menyemak pangkalan data...";
            debounceTimer = setTimeout(() => performVerification(input.value), 500);
        }

        async function performVerification(ic) {
            const status = document.getElementById('auth-status');
            const overlay = document.getElementById('form-overlay');
            const display = document.getElementById('user-info-display');

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    currentUser = { id: snap.docs[0].id, ...data };
                    
                    // Update UI Left
                    document.getElementById('user-name').textContent = data.name.toUpperCase();
                    document.getElementById('user-station').textContent = (data.station || data.unit || "N/A").toUpperCase();
                    document.getElementById('user-initials').textContent = data.name.substring(0,2).toUpperCase();
                    
                    // Load Stats
                    loadUserStats(ic);
                    
                    // Load Saved Groups
                    loadUserGroups(ic);

                    // Unlock UI Right
                    status.textContent = "Identiti disahkan âœ“";
                    status.className = "text-xs mt-2 text-white font-bold";
                    display.classList.remove('hidden');
                    overlay.classList.add('hidden'); // Unlock Form
                    document.getElementById('applicant-ic').disabled = true; // Lock input
                } else {
                    status.textContent = "Tiada rekod dijumpai.";
                    status.className = "text-xs mt-2 text-red-300 font-bold";
                }
            } catch (e) {
                console.error(e);
                status.textContent = "Ralat sambungan.";
            }
        }

        async function loadUserStats(ic) {
            // Simple count query for 'movement' type
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_programs`), where("penyelaras_ic", "==", ic), where("type", "==", "movement"));
                const snap = await getDocs(q);
                
                let total = snap.size;
                let monthCount = 0;
                const currentMonth = new Date().getMonth();

                snap.forEach(doc => {
                    const d = new Date(doc.data().startDate);
                    if (d.getMonth() === currentMonth) monthCount++;
                });

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-month').textContent = monthCount;
            } catch (e) { console.log("Stats error", e); }
        }

        // --- 2. DATA LOADING ---
        async function loadSchools() {
            const select = document.getElementById('destination-select');
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_schools`), orderBy("name"));
                const snap = await getDocs(q);
                select.innerHTML = '<option value="">-- Pilih Destinasi --</option>';
                snap.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.data().name;
                    opt.textContent = doc.data().name;
                    select.appendChild(opt);
                });
                select.innerHTML += '<option value="LAIN-LAIN">LAIN-LAIN (NYATAKAN DI TUJUAN)</option>';
            } catch(e) { console.error(e); }
        }

        async function preloadUsers() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), orderBy("name"));
                const snap = await getDocs(q);
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.ic) allUsersCache.push({ name: d.name.toUpperCase(), ic: d.ic, station: d.station || '' });
                });
            } catch (e) {}
        }

        // --- 3. TEAM TAGGING & GROUPS ---
        const searchInput = document.getElementById('search-member');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            searchResults.innerHTML = '';
            if (val.length < 3) { searchResults.classList.add('hidden'); return; }

            const matches = allUsersCache.filter(u => u.name.includes(val) && u.ic !== currentUser.ic && !taggedMembers.some(tm => tm.ic === u.ic)).slice(0, 8);
            
            if (matches.length > 0) {
                searchResults.classList.remove('hidden');
                matches.forEach(user => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-emerald-50 cursor-pointer text-gray-700 border-b border-gray-50 last:border-0";
                    div.innerHTML = `<div class="font-bold text-xs">${user.name}</div><div class="text-[10px] text-gray-400">${user.station}</div>`;
                    div.onclick = () => addMember(user);
                    searchResults.appendChild(div);
                });
            } else { searchResults.classList.add('hidden'); }
        });
        
        // Hide dropdown on click outside
        document.addEventListener('click', (e) => {
            if(!searchInput.contains(e.target) && !searchResults.contains(e.target)) searchResults.classList.add('hidden');
        });

        function addMember(user) {
            taggedMembers.push(user);
            renderMembers();
            searchInput.value = '';
            searchResults.classList.add('hidden');
        }

        window.removeMember = function(ic) {
            taggedMembers = taggedMembers.filter(m => m.ic !== ic);
            renderMembers();
        }

        function renderMembers() {
            const container = document.getElementById('members-list');
            // Keep the "ANDA" badge
            container.innerHTML = `<span id="applicant-badge" class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold bg-emerald-600 text-white shadow-sm"><span class="mr-1">ðŸ‘‘</span> ANDA</span>`;
            
            taggedMembers.forEach(m => {
                const tag = document.createElement('span');
                tag.className = "inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-white border border-gray-200 text-gray-700 shadow-sm";
                tag.innerHTML = `${m.name} <button onclick="removeMember('${m.ic}')" class="ml-1.5 text-gray-400 hover:text-red-500 font-bold">Ã—</button>`;
                container.appendChild(tag);
            });
        }

        // --- GROUP SAVING LOGIC ---
        async function loadUserGroups(ic) {
            const select = document.getElementById('group-load-select');
            select.innerHTML = '<option value="">-- Muat Kumpulan --</option>';
            try {
                // Fetch groups owned by this user
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), where("ownerIc", "==", ic));
                const snap = await getDocs(q);
                
                savedGroups = [];
                snap.forEach(doc => {
                    const g = { id: doc.id, ...doc.data() };
                    savedGroups.push(g);
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    select.appendChild(opt);
                });
            } catch (e) { console.error("Group load error", e); }
        }

        window.loadGroup = function(groupId) {
            if(!groupId) return;
            const group = savedGroups.find(g => g.id === groupId);
            if(group && group.members) {
                // Merge members, avoid duplicates
                group.members.forEach(newMember => {
                    if(newMember.ic !== currentUser.ic && !taggedMembers.some(existing => existing.ic === newMember.ic)) {
                        taggedMembers.push(newMember);
                    }
                });
                renderMembers();
                // Reset select
                document.getElementById('group-load-select').value = "";
            }
        }

        window.saveCurrentGroup = async function() {
            if(taggedMembers.length === 0) {
                alert("Sila tambah sekurang-kurangnya satu ahli untuk disimpan.");
                return;
            }
            const groupName = prompt("Berikan nama untuk kumpulan ini (Contoh: Team ICT):");
            if(!groupName) return;

            try {
                const newGroup = {
                    name: groupName.toUpperCase(),
                    ownerIc: currentUser.ic,
                    members: taggedMembers.map(m => ({ name: m.name, ic: m.ic, station: m.station || '' })),
                    createdAt: serverTimestamp()
                };
                
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), newGroup);
                
                // Add to local list & UI immediately
                savedGroups.push({ id: docRef.id, ...newGroup });
                const select = document.getElementById('group-load-select');
                const opt = document.createElement('option');
                opt.value = docRef.id;
                opt.textContent = newGroup.name;
                select.appendChild(opt);
                
                alert("Kumpulan berjaya disimpan!");
            } catch (e) {
                console.error(e);
                alert("Gagal menyimpan kumpulan.");
            }
        }

        // --- 4. SUBMIT ---
        window.submitMovement = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            
            if(!currentUser) { alert("Sila sahkan IC dahulu."); return; }
            
            btn.disabled = true;
            btn.innerHTML = "Menyimpan Rekod...";
            
            // Gather Data
            const focus = document.getElementById('ppd-focus').value;
            const type = document.getElementById('visit-type').value;
            const reason = document.getElementById('visit-reason').value.toUpperCase();
            const dest = document.getElementById('destination-select').value;
            const date = document.getElementById('move-date').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;

            const fullReason = `[${focus.toUpperCase()}] ${reason}`;
            const programKey = `GO-${Math.random().toString(36).substring(2,7).toUpperCase()}`;
            
            // Build Attendance
            const attendees = [
                { ic: currentUser.ic, name: currentUser.name, org: currentUser.station || '', status: 'Hadir', timestamp: new Date().toISOString() }
            ];
            taggedMembers.forEach(m => {
                attendees.push({ ic: m.ic, name: m.name, org: m.station || '', status: 'Hadir', timestamp: new Date().toISOString() });
            });

            const record = {
                key: programKey,
                name: `SPARK GO: ${dest}`,
                location: dest,
                description: fullReason, // Stores focus + specific reason
                visitType: type,
                focusArea: focus,
                startDate: date, endDate: date,
                startTime: start, endTime: end,
                quota: attendees.length,
                penyelaras_ic: currentUser.ic,
                penyelaras_name: currentUser.name,
                attendance: attendees,
                status: 'Selesai',
                type: 'movement', // Critical for filtering
                createdAt: serverTimestamp(),
                
                // Defaults to satisfy dashboard schema
                method: 'bersemuka',
                bookingNeeded: false, surveyNeeded: false, evaluationNeeded: false, eCertificateNeeded: false
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/spark_programs`), record);
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Ralat menyimpan rekod.");
                btn.disabled = false;
                btn.innerHTML = "REKOD PERGERAKAN";
            }
        }

    </script>
</body>
</html>
