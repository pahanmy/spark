<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Sijil Spark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Styles to hide main content during print and apply certificate design */
        @media print {
            .no-print { display: none !important; }
            body { 
                background-color: white;
                /* Reset font for printing to certificate fonts */
                font-family: 'Montserrat', sans-serif !important;
            }
            @page { size: A4 portrait; margin: 0; }
            
            /* --- Certificate Print Styles (Copied from original sijil.html print function) --- */
            .certificate-container { 
                width: 210mm; 
                height: 297mm; 
                margin: 0; 
                background-color: white; 
                padding: 12mm; 
                box-sizing: border-box; 
                position: relative; 
                display: flex; 
                flex-direction: column; 
                text-align: center; 
                overflow: hidden; 
                page-break-after: always; /* Ensure each certificate is on a new page */
                color: #333;
                box-shadow: none; /* Remove shadow when printing */
            }
            .certificate-container:last-child { page-break-after: avoid; }
            .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
            .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
            .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
            .certificate-content { 
                border: 6px solid; 
                border-image-slice: 1; 
                border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); 
                height: 100%; 
                padding: 10mm; 
                box-sizing: border-box; 
                position: relative; 
                z-index: 2; 
                display: flex; 
                flex-direction: column; 
                background: #ffffff; 
            }
            .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
            .qr-code { width: 65px; height: 65px; }
            .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
            .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
            h1.cert-title { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
            .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
            .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
            .event-title-label { font-size: 16px; color: #555; }
            .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
            .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
            .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
            .signature-section { margin-top: auto; }
            .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
            .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
            .spark-section { margin-top: 15px; }
            .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
            /* --- End Certificate Print Styles --- */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header (Disappear when printing) -->
    <header class="bg-white shadow-md sticky top-0 z-50 no-print">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex items-center">
                <a href="#" class="flex flex-col">
                    <span class="text-2xl font-bold text-indigo-600">SPARK</span>
                    <span class="text-xs text-gray-500 -mt-1">Sijil Spark (Admin)</span>
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Content for Data Entry (Disappear when printing) -->
    <main id="main-content" class="w-full max-w-6xl mx-auto flex-grow p-4 md:p-8 no-print">
        <div class="text-center my-4">
            <h1 class="text-3xl font-bold text-indigo-600">Sijil Spark</h1>
            <p class="text-gray-600 mt-2">Masukkan data program dan senarai peserta untuk menjana sijil secara batch.</p>
        </div>
        
        <div id="data-card" class="card p-8 mb-8 max-w-4xl mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Langkah 1: Maklumat Program</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- CERTIFICATE TYPE INPUT -->
                <div>
                    <label for="certificate-type" class="block text-sm font-medium text-gray-700">Jenis Sijil</label>
                    <select id="certificate-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Sijil Penyertaan">Sijil Penyertaan</option>
                        <option value="Sijil Penghargaan">Sijil Penghargaan</option>
                    </select>
                </div>
                
                <div>
                    <label for="program-name" class="block text-sm font-medium text-gray-700">Nama Program</label>
                    <input type="text" id="program-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kursus Transformasi Digital PPD Miri">
                </div>
                
                <!-- UPDATED: PROGRAM KEY TO SELECT WITH LAIN-LAAIN INPUT -->
                <div>
                    <label for="program-key-select" class="block text-sm font-medium text-gray-700">Kod Program (Identifier)</label>
                    <div id="program-key-group" class="mt-1">
                        <select id="program-key-select" onchange="toggleCustomKeyInput(this.value)" class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="SPr">SPr</option>
                            <option value="SPB">SPB</option>
                            <option value="SPS">SPS</option>
                            <option value="SPBM">SPBM</option>
                            <option value="SP">SP</option>
                            <option value="LAIN">Lain-lain</option>
                        </select>
                        <input type="text" id="custom-program-key" class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 hidden" placeholder="Masukkan Kod Kustom (Cth: KTD25)">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Tarikh Mula</label>
                    <input type="date" id="start-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">Tarikh Tamat</label>
                    <input type="date" id="end-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <h2 class="text-xl font-semibold text-gray-800 mb-4 mt-6">Langkah 2: Data Peserta</h2>
            
            <!-- MANUAL ENTRY SECTION -->
            <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-indigo-700 mb-3">A. Tambah Peserta Secara Manual</h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                    <div class="md:col-span-3">
                        <label for="manual-name" class="block text-xs font-medium text-gray-600">Nama Penuh</label>
                        <input type="text" id="manual-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Contoh: Ali Bin Abu">
                    </div>
                    <div class="md:col-span-2">
                        <label for="manual-ic" class="block text-xs font-medium text-gray-600">Nombor K/P (Tanpa sengkang)</label>
                        <input type="text" id="manual-ic" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Contoh: 900101131234">
                    </div>
                    <div class="md:col-span-1">
                        <button onclick="addParticipantManually()" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 w-full flex items-center justify-center">
                            <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Tambah
                        </button>
                    </div>
                </div>
            </div>

            <!-- BATCH PASTE SECTION -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">B. Tampal Data Secara Pukal (Batch Paste)</h3>
            <p class="text-sm text-gray-600 mb-2">Pastikan format data adalah: **NAMA**<span class="font-bold">\t</span>**NOMBOR K/P** (dipisahkan oleh Tab).</p>
            <p class="text-sm text-red-600 mb-4 font-semibold">⚠️ Nota: Menekan butang 'Semak' di bawah akan **MENGGANTIKAN** senarai sedia ada.</p>
            
            <textarea id="participant-data" rows="8" placeholder="Contoh:
ALI BIN ABU	900101131234
SITI BINTI HASSAN	950505135678" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono"></textarea>
            
            <!-- BUTTON FOR PARSING/PREVIEW -->
            <button id="parse-btn" onclick="parseAndRenderData()" class="btn bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center w-full mt-4 shadow-md shadow-blue-300">
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 011-1h10a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                <span>Semak & Papar Senarai</span>
            </button>
            
            <div id="status-message" class="mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-center font-medium hidden"></div>

        </div>
        
        <!-- CARD FOR PREVIEW LIST -->
        <div id="preview-card" class="card p-6 max-w-4xl mx-auto hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Langkah 3: Pengesahan Peserta (<span id="participant-count">0</span> Nama Sah)</h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Bil.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8/12">Nama Peserta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">No. K/P (4 Akhir)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="participant-list-preview" class="bg-white divide-y divide-gray-200">
                        <!-- Data senarai peserta akan dipaparkan di sini -->
                    </tbody>
                </table>
            </div>

            <button id="generate-btn" onclick="generateCertificates()" class="btn bg-indigo-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center w-full mt-6 shadow-md shadow-indigo-300">
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                <span>Jana & Cetak Semua Sijil</span>
            </button>
            
        </div>

    </main>

    <!-- Print Container (Hidden in normal view, used to hold generated certificates for printing) -->
    <div id="print-container"></div>
    
    <!-- Footer (Disappear when printing) -->
    <footer class="bg-white border-t mt-12 no-print">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600 text-sm"><p>Projek Inovasi oleh Pahan</p><p class="text-xs text-gray-500 mt-1">Versi 3.0 (2025) - Alat Admin</p></div>
    </footer>

    <script>
        // Global state to hold valid participant data
        let currentParticipants = [];

        // Function to handle showing/hiding the custom key input
        function toggleCustomKeyInput(selectedValue) {
            const customInput = document.getElementById('custom-program-key');
            if (selectedValue === 'LAIN') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }

        // Function to format today's date as YYYY-MM-DD
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Initialize default dates on page load
        document.addEventListener('DOMContentLoaded', () => {
            const todayStr = getTodayDateString();
            // Set Start Date to today by default
            document.getElementById('start-date').value = todayStr;
            // Tarikh Tamat (end-date) is intentionally left empty by default (as requested)
            document.getElementById('end-date').value = ''; 
        });

        // Fungsi untuk menguruskan perubahan dalam textarea data peserta
        document.getElementById('participant-data').addEventListener('input', () => {
            // Kita tidak clear list di sini, tetapi kita disable butang generate
            document.getElementById('generate-btn').disabled = true;
        });

        // NEW FUNCTION: Add participant manually
        function addParticipantManually() {
            const nameInput = document.getElementById('manual-name');
            const icInput = document.getElementById('manual-ic');
            
            const rawName = nameInput.value.trim();
            const rawIc = icInput.value.trim();
            
            const name = rawName.toUpperCase();
            const ic = rawIc.replace(/[^0-9]/g, '');

            const statusMessage = document.getElementById('status-message');
            statusMessage.classList.add('hidden'); // Clear previous status
            
            if (!name) {
                statusMessage.textContent = "Sila masukkan Nama Penuh peserta.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }

            if (!ic || ic.length < 12) {
                statusMessage.textContent = "Sila masukkan Nombor K/P yang sah (sekurang-kurangnya 12 digit, tanpa sengkang).";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }

            currentParticipants.push({ name, ic });
            renderParticipantList();

            // Clear inputs after successful addition
            nameInput.value = '';
            icInput.value = '';
            
            // Show list and enable generate button
            document.getElementById('preview-card').classList.remove('hidden');
            document.getElementById('generate-btn').disabled = false;
            
            statusMessage.textContent = `${name} berjaya ditambah ke senarai. Senarai kini mempunyai ${currentParticipants.length} nama.`;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('bg-red-100');
            statusMessage.classList.add('bg-green-100', 'text-green-800');
        }

        // Fungsi untuk mengambil, membersihkan, dan memaparkan data peserta dari textarea (BATCH PASTE)
        function parseAndRenderData() {
            const dataText = document.getElementById('participant-data').value.trim();
            const statusMessage = document.getElementById('status-message');
            const previewCard = document.getElementById('preview-card');
            
            // LAKUKAN PENGESAHAN PROGRAM TERLEBIH DAHULU UNTUK MENDAPATKAN KOD KUSTOM (JIKA ADA)
            const programData = getProgramData();
            
            // Custom Key Validation Check
            if (programData && programData.error) {
                 statusMessage.textContent = programData.error;
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
                 return;
            } else if (!programData) {
                 statusMessage.textContent = "Sila isi semua maklumat Program (Nama dan Tarikh Mula wajib diisi).";
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
                 return;
            }

            // Clear previous state and REPLACE list with batch data
            currentParticipants = [];
            statusMessage.classList.add('hidden');

            const lines = dataText.split('\n').filter(line => line.trim() !== '');
            let invalidLines = 0; 

            for (const line of lines) {
                // Split data by Tab (\t) 
                const parts = line.split('\t').map(p => p.trim());
                
                if (parts.length >= 2) {
                    const name = parts[0].toUpperCase().trim();
                    const ic = parts[1].replace(/[^0-9]/g, ''); // Buang sengkang/ruang dari IC

                    if (name && ic && ic.length >= 12) {
                        currentParticipants.push({ name, ic });
                    } else {
                        console.warn(`[DATA TIDAK SAH] Baris: "${line}". Nama: ${name ? 'OK' : 'TIDAK WUJUD'}, No. K/P: ${ic.length} digit (Perlu >= 12).`);
                        invalidLines++;
                    }
                } else {
                    console.warn(`[FORMAT SALAH] Baris: "${line}". Data tidak dipisahkan oleh Tab. Hanya ${parts.length} bahagian dikesan.`);
                    invalidLines++;
                }
            }
            
            if (currentParticipants.length > 0) {
                renderParticipantList();
                previewCard.classList.remove('hidden');
                document.getElementById('generate-btn').disabled = false;
                
                if (invalidLines > 0) {
                    statusMessage.textContent = `Berjaya memproses ${currentParticipants.length} nama. ${invalidLines} baris data TIDAK SAH diabaikan. Sila semak konsol untuk butiran.`;
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('bg-red-100');
                    statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                } else {
                    statusMessage.textContent = `Berjaya memproses ${currentParticipants.length} nama. Anda boleh teruskan menjana sijil.`;
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('bg-red-100');
                    statusMessage.classList.add('bg-green-100', 'text-green-800');
                }

            } else {
                renderParticipantList();
                previewCard.classList.add('hidden');
                document.getElementById('generate-btn').disabled = true;
                statusMessage.textContent = "Tiada peserta ditemui dalam data pukal. Cuba isi manual atau semak format data.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
            }
        }
        
        // Fungsi untuk memaparkan senarai peserta dalam jadual preview
        function renderParticipantList() {
            const listContainer = document.getElementById('participant-list-preview');
            const countDisplay = document.getElementById('participant-count');
            listContainer.innerHTML = '';
            countDisplay.textContent = currentParticipants.length;

            currentParticipants.forEach((p, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${p.ic.slice(-4)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-center text-sm">
                        <button onclick="removeParticipant(${index})" class="text-red-600 hover:text-red-900 font-semibold text-xs border border-red-300 rounded-lg px-2 py-1 transition duration-150 ease-in-out hover:bg-red-50">Buang</button>
                    </td>
                `;
                listContainer.appendChild(row);
            });
            
            // Only hide preview card if the list is completely empty
            if (currentParticipants.length === 0) {
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
            } else {
                document.getElementById('preview-card').classList.remove('hidden');
                 document.getElementById('generate-btn').disabled = false;
            }
        }
        
        // Fungsi untuk membuang peserta dari senarai
        function removeParticipant(index) {
            // Confirm removal (using a custom box for better UX than alert/confirm)
            // NOTE: Using window.confirm() as a temporary solution as custom modal UI is complex
            if (!confirm(`Anda pasti untuk membuang ${currentParticipants[index].name} dari senarai?`)) {
                return;
            }
            
            currentParticipants.splice(index, 1);
            renderParticipantList();
            
            // Update status message
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = `Nama telah dibuang. Sisa ${currentParticipants.length} nama sedia untuk dicetak.`;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('bg-red-100');
            statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            
            if (currentParticipants.length === 0) {
                 document.getElementById('preview-card').classList.add('hidden');
            }
        }


        // Fungsi untuk mengambil data program dari input form
        function getProgramData() {
            const certificateType = document.getElementById('certificate-type').value.trim();
            const programName = document.getElementById('program-name').value.trim();
            const programKeySelect = document.getElementById('program-key-select').value;
            const startDate = document.getElementById('start-date').value.trim();
            const endDate = document.getElementById('end-date').value.trim();
            
            let programKey;

            // Determine program key value
            if (programKeySelect === 'LAIN') {
                programKey = document.getElementById('custom-program-key').value.trim();
            } else {
                programKey = programKeySelect;
            }
            
            // Validation: Name and Start Date are mandatory
            if (!programName || !startDate) {
                return null;
            }
            
            // Validation: If 'Lain-lain' is selected, custom key MUST be provided
            if (programKeySelect === 'LAIN' && programKey === '') {
                // Return a specific object indicating failure due to missing custom key
                return { error: "Sila masukkan Kod Kustom kerana anda memilih 'Lain-lain'." };
            }

            // Clean up programKey (remove special characters)
            programKey = programKey.replace(/[^a-zA-Z0-9]/g, '') || 'SP'; 

            return { certificateType, programName, programKey, startDate, endDate };
        }

        // Fungsi utama untuk menjana dan mencetak sijil
        async function generateCertificates() {
            const programData = getProgramData();
            // Use the globally maintained and verified list
            const participants = currentParticipants;
            
            const statusMessage = document.getElementById('status-message');
            const generateBtn = document.getElementById('generate-btn');
            
            // Custom Key Validation Check
            if (programData && programData.error) {
                 statusMessage.textContent = programData.error;
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 return;
            }
            
            // Validation: General data missing
            if (!programData) {
                statusMessage.textContent = "Sila isi semua maklumat Program (Nama dan Tarikh Mula wajib diisi).";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }
            
            // Validation: Participants list empty
            if (participants.length === 0) {
                statusMessage.textContent = "Sila semak data peserta dahulu. Senarai peserta adalah kosong.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }
            
            // Set loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Menjana Sijil...</span>';


            try {
                // Construct all certificates HTML
                let allCertificatesHTML = '';
                participants.forEach(participant => {
                    const certHTML = createCertificateHTML(programData, participant);
                    allCertificatesHTML += certHTML;
                });
                
                // Open a new window for printing
                const printWindow = window.open('', '_blank');
                
                // Write the full HTML structure including the necessary print styles
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ms">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Cetak Sijil Pukal - ${programData.certificateType} - ${programData.programName}</title>
                        <style>
                            /* Import certificate fonts (Montserrat and Playfair Display) */
                            @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                            
                            /* Global styles for the print window */
                            body { 
                                font-family: 'Montserrat', sans-serif; 
                                font-weight: 400; 
                                margin: 0; 
                                padding: 0; 
                                background-color: white; 
                                display: flex; 
                                flex-direction: column; 
                                color: #333; 
                            }
                            
                            /* Certificate container styles for A4 portrait and page breaks */
                            .certificate-container { 
                                width: 210mm; 
                                height: 297mm; 
                                background-color: white; 
                                padding: 12mm; 
                                box-sizing: border-box; 
                                position: relative; 
                                display: flex; 
                                flex-direction: column; 
                                text-align: center; 
                                overflow: hidden; 
                                page-break-after: always; 
                            }
                            .certificate-container:last-child { page-break-after: avoid; }
                            
                            /* Corner elements (copied from original) */
                            .certificate-container::before, .certificate-container::after { 
                                content: ''; 
                                position: absolute; 
                                width: 170px; 
                                height: 170px; 
                                background-color: #4B40FF; 
                                opacity: 0.9; 
                                z-index: 1; 
                            }
                            .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                            .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                            
                            /* Inner content border (copied from original) */
                            .certificate-content { 
                                border: 6px solid; 
                                border-image-slice: 1; 
                                border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); 
                                height: 100%; 
                                padding: 10mm; 
                                box-sizing: border-box; 
                                position: relative; 
                                z-index: 2; 
                                display: flex; 
                                flex-direction: column; 
                                background: #ffffff; 
                            }
                            
                            /* All other inner elements styles (copied from original) */
                            .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                            .qr-code { width: 65px; height: 65px; }
                            .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                            .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                            h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                            .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                            .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                            .event-title-label { font-size: 16px; color: #555; }
                            .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                            .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                            .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                            .signature-section { margin-top: auto; }
                            .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                            .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                            .spark-section { margin-top: 15px; }
                            .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                            
                            @media print {
                                @page { size: A4 portrait; margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${allCertificatesHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.onload = function() { 
                    printWindow.focus(); 
                    printWindow.print();
                    // Reset button state
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>Jana & Cetak Semua Sijil</span>';
                };

            } catch (error) {
                console.error("Ralat semasa menjana sijil:", error);
                statusMessage.textContent = "Ralat berlaku semasa menjana sijil. Sila semak konsol untuk butiran lanjut.";
                statusMessage.classList.remove('hidden');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>Jana & Cetak Semua Sijil</span>';
            }
        }

        // Fungsi untuk menjana HTML sijil berdasarkan data (diambil dari sijil.html)
        function createCertificateHTML(programData, participantData) {
            const { certificateType, programName, programKey, startDate, endDate } = programData;
            const participantName = participantData.name.toUpperCase();
            const participantIC = participantData.ic;
            const courseName = programName.toUpperCase();
            
            // --- Logic for Introduction and Action Text based on Type ---
            let introText;
            let actionTextHTML = ''; // Holds the HTML for the line before program name
            
            if (certificateType === 'Sijil Penghargaan') {
                // Phrase for recognition/award
                introText = "Dengan penuh penghargaan kepada";
                // Phrase for contribution/recognition
                actionTextHTML = `<p class="event-title-label">di atas sumbangan beliau dalam</p>`; 
            } else {
                // Default for Sijil Penyertaan (Participation)
                introText = "Dengan ini disahkan bahawa";
                // Phrase for participation/attendance
                actionTextHTML = `<p class="event-title-label">telah mengikuti</p>`;
            }
            // --- End Logic ---

            const startD = new Date(startDate + 'T00:00:00');
            // Cek jika endDate ada dan bukan string kosong
            const isMultiDay = endDate && endDate.trim() !== '';

            let dateString;
            
            if (!isMultiDay || new Date(endDate + 'T00:00:00').getTime() === startD.getTime()) {
                // Tarikh Tamat tidak diisi (atau sama dengan Tarikh Mula) -> Papar tarikh tunggal
                dateString = `pada ${startD.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                // Tarikh Tamat diisi dan berbeza -> Papar julat tarikh
                const endD = new Date(endDate + 'T00:00:00');
                dateString = `pada ${startD.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endD.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const programIdentifier = programKey.replace(/[^a-zA-Z0-9]/g, '') || 'SP'; 
            // Nombor Siri: SPK/KOD_PROGRAM/4_DIGIT_AKHIR_IC
            const serialNumber = `SPK/${programIdentifier}/${participantIC.slice(-4)}`;
            
            // URL Pengesahan (Menggunakan format sijil.html untuk rujukan)
            const validationUrl = `${window.location.origin}/sijil.html?ic=${participantIC}`; 
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;
            const logoUrl = "https://i.imgur.com/FQpwGDo.png"; // Logo PPD Miri (dari fail asal)

            return `
                <div class="certificate-container">
                    <div class="certificate-content">
                        <div class="header-section">
                            <img src="${qrCodeUrl}" onerror="this.onerror=null; this.src='https://placehold.co/65x65/E0E7FF/4338CA?text=QR'" alt="QR Code" class="qr-code">
                            <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                        </div>
                        <img src="${logoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/150x75/E0E7FF/4338CA?text=LOGO+PPD+MIRI'" alt="Logo Pejabat Pendidikan Daerah Miri" class="logo">
                        <h1>${certificateType.toUpperCase()}</h1>
                        <p class="intro-text">${introText}</p>
                        <p class="recipient-name">${participantName}</p>
                        <p class="recipient-ic">${participantIC}</p>
                        ${actionTextHTML}
                        <p class="event-title">${courseName}</p>
                        <p class="event-date">${dateString}</p>
                        <hr class="divider">
                        <div class="signature-section">
                            <!-- Tandatangan kekal sebagai Puan Mariam, seperti dalam fail asal -->
                            <p class="signatory-name">MARIAM HAJI MONEK</p>
                            <p class="signatory-title">PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                        </div>
                        <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                        <div class="spark-section">
                            <p class="spark-title">SPARK</p>
                            <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.addParticipantManually = addParticipantManually; // New manual entry function
        window.parseAndRenderData = parseAndRenderData;
        window.removeParticipant = removeParticipant;
        window.generateCertificates = generateCertificates;
        window.toggleCustomKeyInput = toggleCustomKeyInput;
    </script>
</body>
</html>
