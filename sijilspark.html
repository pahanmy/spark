<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Sijil Spark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Style for radio buttons disguised as labels/buttons */
        .peer:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.5);
        }
        .peer:checked + label:hover {
             background-color: #4338ca; /* indigo-700 */
        }
        .cert-type-label {
            flex: 1 1 auto; /* Allows buttons to share space */
            text-align: center;
        }

        /* Styles to hide main content during print and apply certificate design */
        @media print {
            .no-print { display: none !important; }
            body { 
                background-color: white;
                /* Reset font for printing to certificate fonts */
                font-family: 'Montserrat', sans-serif !important;
            }
            @page { size: A4 portrait; margin: 0; }
            
            /* --- Certificate Print Styles (Copied from original sijil.html print function) --- */
            .certificate-container { 
                width: 210mm; 
                height: 297mm; 
                margin: 0; 
                background-color: white; 
                padding: 12mm; 
                box-sizing: border-box; 
                position: relative; 
                display: flex; 
                flex-direction: column; 
                text-align: center; 
                overflow: hidden; 
                page-break-after: always; /* Ensure each certificate is on a new page */
                color: #333;
                box-shadow: none; /* Remove shadow when printing */
            }
            .certificate-container:last-child { page-break-after: avoid; }
            .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
            .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
            .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
            .certificate-content { 
                border: 6px solid; 
                border-image-slice: 1; 
                border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); 
                height: 100%; 
                padding: 10mm; 
                box-sizing: border-box; 
                position: relative; 
                z-index: 2; 
                display: flex; 
                flex-direction: column; 
                background: #ffffff; 
            }
            .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
            .qr-code { width: 65px; height: 65px; }
            .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
            .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
            h1.cert-title { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
            .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
            .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
            .event-title-label { font-size: 16px; color: #555; }
            .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
            .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
            .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
            .signature-section { margin-top: auto; }
            .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
            .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
            .spark-section { margin-top: 15px; }
            .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
            /* --- End Certificate Print Styles --- */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header (Disappear when printing) -->
    <header class="bg-white shadow-md sticky top-0 z-50 no-print">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex items-center">
                <a href="#" class="flex flex-col">
                    <span class="text-2xl font-bold text-indigo-600">SPARK</span>
                    <span class="text-xs text-gray-500 -mt-1">Sijil Spark (Admin)</span>
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Content for Data Entry (Disappear when printing) -->
    <main id="main-content" class="w-full max-w-6xl mx-auto flex-grow p-4 md:p-8 no-print">
        <div class="text-center my-4">
            <h1 class="text-3xl font-bold text-indigo-600">Sijil Spark</h1>
            <p class="text-gray-600 mt-2">Masukkan data program dan senarai peserta/penerima untuk menjana sijil secara batch.</p>
        </div>
        
        <div id="data-card" class="card p-8 mb-8 max-w-4xl mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Langkah 1: Maklumat Sijil</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- CERTIFICATE TYPE INPUT (UPDATED TO BUTTONS/RADIO) -->
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Sijil</label>
                    <div id="certificate-type-buttons" class="flex flex-wrap md:flex-nowrap gap-2" onchange="updateParticipantInputLabels()">
                        
                        <input type="radio" name="certificate-type-radio" id="cert-penyertaan" value="Sijil Penyertaan" class="hidden peer" checked>
                        <label for="cert-penyertaan" class="cert-type-label flex items-center justify-center text-sm px-3 py-2 border rounded-lg cursor-pointer transition-colors hover:bg-indigo-50 hover:text-indigo-700">Penyertaan (Individu)</label>

                        <input type="radio" name="certificate-type-radio" id="cert-penghargaan" value="Sijil Penghargaan" class="hidden peer">
                        <label for="cert-penghargaan" class="cert-type-label flex items-center justify-center text-sm px-3 py-2 border rounded-lg cursor-pointer transition-colors hover:bg-indigo-50 hover:text-indigo-700">Penghargaan (Individu)</label>

                        <input type="radio" name="certificate-type-radio" id="cert-pencapaian" value="Sijil Pencapaian" class="hidden peer">
                        <label for="cert-pencapaian" class="cert-type-label flex items-center justify-center text-sm px-3 py-2 border rounded-lg cursor-pointer transition-colors hover:bg-indigo-50 hover:text-indigo-700">Pencapaian (Sekolah/Org)</label>
                        
                        <!-- Hidden input to hold selected value for easy JS retrieval -->
                        <input type="hidden" id="certificate-type" value="Sijil Penyertaan">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="program-name" class="block text-sm font-medium text-gray-700">Nama Program / Tajuk Utama Anugerah</label>
                    <input type="text" id="program-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kursus Transformasi Digital PPD Miri">
                </div>
                
                <!-- NEW: AWARD TITLE INPUT (Toggle Visibility) -->
                <div id="award-title-container" class="hidden">
                    <label for="award-title" class="block text-sm font-medium text-gray-700">Tajuk Anugerah (Baris 2) / Sub-Tajuk Program</label>
                    <input type="text" id="award-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: ANUGERAH LONJAKAN CEMERLANG 2025">
                </div>
                
                <!-- Empty div for layout spacing when award title is hidden -->
                <div id="award-title-spacer"></div>


                <!-- UPDATED: PROGRAM KEY TO SELECT WITH LAIN-LAAIN INPUT -->
                <div class="col-span-1">
                    <label for="program-key-select" class="block text-sm font-medium text-gray-700">Kod Program (Identifier)</label>
                    <div id="program-key-group" class="mt-1">
                        <select id="program-key-select" onchange="toggleCustomKeyInput(this.value)" class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="SPr">SPr</option>
                            <option value="SPB">SPB</option>
                            <option value="SPS">SPS</option>
                            <option value="SPBM">SPBM</option>
                            <option value="SP">SP</option>
                            <option value="LAIN">Lain-lain</option>
                        </select>
                        <input type="text" id="custom-program-key" class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 hidden" placeholder="Masukkan Kod Kustom (Cth: KTD25)">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Tarikh Mula</label>
                    <input type="date" id="start-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">Tarikh Tamat</label>
                    <input type="date" id="end-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <!-- SIGNATORY SELECT INPUTS -->
            <h2 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Maklumat Penandatangan Sijil</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="signatory-select" class="block text-sm font-medium text-gray-700">Pilih Penandatangan</label>
                    <div id="signatory-group" class="mt-1">
                        <select id="signatory-select" onchange="updateSignatoryDisplay(this.value)" class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="MARIAM_DEFAULT">MARIAM HAJI MONEK (lalai)</option>
                            <option value="LAIN">LAIN-LAIN</option>
                        </select>
                    </div>
                </div>
                <!-- Display current signatory status -->
                <div class="flex flex-col justify-start pt-1">
                    <p class="text-sm font-medium text-gray-700">Penandatangan Semasa:</p>
                    <div id="current-signatory-display" class="mt-1 p-3 bg-gray-50 rounded-lg text-sm text-gray-800 border border-gray-200 font-semibold">
                        <!-- Initial display will be set by JS on DOMContentLoaded -->
                    </div>
                </div>
            </div>
            <!-- END SIGNATORY SELECT INPUTS -->
            
            <h2 class="text-xl font-semibold text-gray-800 mb-4 mt-6">Langkah 2: Data Penerima</h2>
            
            <!-- MANUAL ENTRY SECTION -->
            <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-indigo-700 mb-3">A. Tambah Penerima Secara Manual</h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                    <div class="md:col-span-3">
                        <label for="manual-name" id="manual-name-label" class="block text-xs font-medium text-gray-600">Nama Penuh Penerima (Individu/Sekolah)</label>
                        <input type="text" id="manual-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Contoh: SMK Merbau atau Ali Bin Abu">
                    </div>
                    <div class="md:col-span-2">
                        <label for="manual-ic" id="manual-ic-label" class="block text-xs font-medium text-gray-600">Nombor K/P (Tanpa sengkang) / ID Rujukan</label>
                        <input type="text" id="manual-ic" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Contoh: 900101131234 atau Rujukan Sekolah">
                    </div>
                    <div class="md:col-span-1">
                        <button onclick="addParticipantManually()" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 w-full flex items-center justify-center">
                            <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Tambah
                        </button>
                    </div>
                </div>
            </div>

            <!-- BATCH PASTE SECTION -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">B. Tampal Data Secara Pukal (Batch Paste)</h3>
            <p id="batch-format-note" class="text-sm text-gray-600 mb-2">Pastikan format data adalah: **NAMA**<span class="font-bold">\t</span>**NO. K/P atau ID Rujukan** (dipisahkan oleh Tab).</p>
            <p class="text-sm text-red-600 mb-4 font-semibold">⚠️ Nota: Menekan butang 'Semak' di bawah akan **MENGGANTIKAN** senarai sedia ada.</p>
            
            <textarea id="participant-data" rows="8" placeholder="Contoh:
SMK MERBAU	RujSMKM2025
ALI BIN ABU	900101131234" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono"></textarea>
            
            <!-- BUTTON FOR PARSING/PREVIEW -->
            <button id="parse-btn" onclick="parseAndRenderData()" class="btn bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center w-full mt-4 shadow-md shadow-blue-300">
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 011-1h10a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                <span>Semak & Papar Senarai</span>
            </button>
            
            <div id="status-message" class="mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-center font-medium hidden"></div>

        </div>
        
        <!-- CARD FOR PREVIEW LIST -->
        <div id="preview-card" class="card p-6 max-w-4xl mx-auto hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Langkah 3: Pengesahan Penerima (<span id="participant-count">0</span> Nama Sah)</h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Bil.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-7/12" id="preview-name-header">Nama Penerima</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12" id="preview-ic-header">No. K/P (4 Akhir) / ID Rujukan</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="participant-list-preview" class="bg-white divide-y divide-gray-200">
                        <!-- Data senarai peserta akan dipaparkan di sini -->
                    </tbody>
                </table>
            </div>

            <button id="generate-btn" onclick="generateCertificates()" class="btn bg-indigo-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center w-full mt-6 shadow-md shadow-indigo-300">
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                <span>Jana & Cetak Semua Sijil</span>
            </button>
            
        </div>

    </main>

    <!-- Print Container (Hidden in normal view, used to hold generated certificates for printing) -->
    <div id="print-container"></div>
    
    <!-- Footer (Disappear when printing) -->
    <footer class="bg-white border-t mt-12 no-print">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600 text-sm"><p>Projek Inovasi oleh Pahan</p><p class="text-xs text-gray-500 mt-1">Versi 3.0 (2025) - Alat Admin</p></div>
    </footer>

    <script>
        // Global state to hold valid participant data
        let currentParticipants = [];
        
        // Data Penandatangan Lalai
        const SIGNATORIES = {
            MARIAM_DEFAULT: {
                name: "MARIAM HAJI MONEK",
                title: "PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI."
            },
            LAIN: {
                // Digunakan apabila pengguna memilih "LAIN-LAIN"
                name: "PEGAWAI PENGESAH",
                title: "JAWATAN PENGESAH"
            }
        };

        // NEW FUNCTION: Update input labels and show/hide award title based on certificate type
        function updateParticipantInputLabels() {
            const selectedRadio = document.querySelector('input[name="certificate-type-radio"]:checked');
            const certType = selectedRadio ? selectedRadio.value : 'Sijil Penyertaan';
            
            // Update hidden input for easy retrieval
            document.getElementById('certificate-type').value = certType;
            
            const isIndividual = (certType === 'Sijil Penyertaan' || certType === 'Sijil Penghargaan');
            const isAchievement = (certType === 'Sijil Pencapaian');

            const manualNameLabel = document.getElementById('manual-name-label');
            const manualIcLabel = document.getElementById('manual-ic-label');
            const manualNameInput = document.getElementById('manual-name');
            const manualIcInput = document.getElementById('manual-ic');
            const batchFormatNote = document.getElementById('batch-format-note');
            const previewIcHeader = document.getElementById('preview-ic-header');
            const awardTitleContainer = document.getElementById('award-title-container');
            const awardTitleSpacer = document.getElementById('award-title-spacer');

            // 1. Toggle Award Title visibility
            if (isAchievement) {
                awardTitleContainer.classList.remove('hidden');
                awardTitleSpacer.classList.add('hidden');
            } else {
                awardTitleContainer.classList.add('hidden');
                awardTitleSpacer.classList.remove('hidden');
            }
            
            // 2. Update Input Labels
            document.getElementById('preview-name-header').textContent = 'Nama Penerima';

            if (isIndividual) {
                manualNameLabel.textContent = 'Nama Penuh Penerima (Individu)';
                manualIcLabel.textContent = 'Nombor K/P (Tanpa sengkang) - WAJIB';
                manualNameInput.placeholder = 'Contoh: Ali Bin Abu';
                manualIcInput.placeholder = 'Contoh: 900101131234';
                batchFormatNote.innerHTML = 'Pastikan format data adalah: **NAMA**<span class="font-bold">\\t</span>**NOMBOR K/P** (dipisahkan oleh Tab).';
                previewIcHeader.textContent = 'No. K/P (4 Akhir)';
            } else if (isAchievement) {
                manualNameLabel.textContent = 'Nama Penuh Penerima (Sekolah/Organisasi)';
                manualIcLabel.textContent = 'ID Rujukan / Kod Sekolah (Pilihan)';
                manualNameInput.placeholder = 'Contoh: SMK Merbau';
                manualIcInput.placeholder = 'Contoh: YBB8101 atau Kosong';
                batchFormatNote.innerHTML = 'Pastikan format data adalah: **NAMA SEKOLAH/ORGANISASI**<span class="font-bold">\\t</span>**ID Rujukan** (dipisahkan oleh Tab).';
                previewIcHeader.textContent = 'ID Rujukan';
            }
        }
        
        function toggleCustomKeyInput(selectedValue) {
            const customInput = document.getElementById('custom-program-key');
            if (selectedValue === 'LAIN') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }
        
        function updateSignatoryDisplay(selectedValue) {
            const displayDiv = document.getElementById('current-signatory-display');
            let signatory;
            
            if (selectedValue === 'LAIN') {
                signatory = SIGNATORIES.LAIN;
            } else {
                signatory = SIGNATORIES.MARIAM_DEFAULT;
            }
            
            // Render the display HTML
            displayDiv.innerHTML = `<span class="text-indigo-600">${signatory.name.toUpperCase()}</span><br>${signatory.title.toUpperCase()}`;
        }
        
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Initialize default dates and signatory on page load
        document.addEventListener('DOMContentLoaded', () => {
            const todayStr = getTodayDateString();
            document.getElementById('start-date').value = todayStr;
            document.getElementById('end-date').value = ''; 
            
            // Set initial states
            updateSignatoryDisplay('MARIAM_DEFAULT');
            // Initial call to set labels based on default radio selection
            updateParticipantInputLabels(); 
        });

        document.getElementById('participant-data').addEventListener('input', () => {
            document.getElementById('generate-btn').disabled = true;
        });

        // NEW FUNCTION: Add participant manually
        function addParticipantManually() {
            const nameInput = document.getElementById('manual-name');
            const icInput = document.getElementById('manual-ic');
            const certType = document.getElementById('certificate-type').value;
            const isIndividual = (certType === 'Sijil Penyertaan' || certType === 'Sijil Penghargaan');
            
            const rawName = nameInput.value.trim();
            const rawIc = icInput.value.trim();
            
            const name = rawName.toUpperCase();
            let ic = rawIc.replace(/[^a-zA-Z0-9]/g, ''); // Allow alphanumeric for general ID

            const statusMessage = document.getElementById('status-message');
            statusMessage.classList.add('hidden'); // Clear previous status
            
            if (!name) {
                statusMessage.textContent = "Sila masukkan Nama Penuh Penerima.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }

            if (isIndividual) {
                // For Penyertaan/Penghargaan (Individual), IC is mandatory and must be 12 digits
                ic = rawIc.replace(/[^0-9]/g, ''); // Strictly numbers for K/P
                if (!ic || ic.length < 12) {
                    statusMessage.textContent = "Sila masukkan Nombor K/P yang sah (sekurang-kurangnya 12 digit, tanpa sengkang).";
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.add('bg-red-100', 'text-red-700');
                    statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                    return;
                }
            }
            // For Pencapaian (School), IC/ID is optional, so no mandatory check here.

            currentParticipants.push({ name, ic });
            renderParticipantList();

            // Clear inputs after successful addition
            nameInput.value = '';
            icInput.value = '';
            
            // Show list and enable generate button
            document.getElementById('preview-card').classList.remove('hidden');
            document.getElementById('generate-btn').disabled = false;
            
            statusMessage.textContent = `${name} berjaya ditambah ke senarai. Senarai kini mempunyai ${currentParticipants.length} nama.`;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('bg-red-100');
            statusMessage.classList.add('bg-green-100', 'text-green-800');
        }

        // Fungsi untuk mengambil, membersihkan, dan memaparkan data peserta dari textarea (BATCH PASTE)
        function parseAndRenderData() {
            const dataText = document.getElementById('participant-data').value.trim();
            const statusMessage = document.getElementById('status-message');
            const previewCard = document.getElementById('preview-card');
            const certType = document.getElementById('certificate-type').value;
            const isIndividual = (certType === 'Sijil Penyertaan' || certType === 'Sijil Penghargaan');
            
            // LAKUKAN PENGESAHAN PROGRAM TERLEBIH DAHULU UNTUK MENDAPATKAN KOD KUSTOM (JIKA ADA)
            const programData = getProgramData();
            
            // Validation Check
            if (programData && programData.error) {
                 statusMessage.textContent = programData.error;
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
                 return;
            } else if (!programData) {
                 statusMessage.textContent = "Sila isi semua maklumat Program (Nama dan Tarikh Mula wajib diisi).";
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
                 return;
            }

            // Clear previous state and REPLACE list with batch data
            currentParticipants = [];
            statusMessage.classList.add('hidden');

            const lines = dataText.split('\n').filter(line => line.trim() !== '');
            let invalidLines = 0; 

            for (const line of lines) {
                // Split data by Tab (\t) 
                const parts = line.split('\t').map(p => p.trim());
                
                if (parts.length >= 2) {
                    const name = parts[0].toUpperCase().trim();
                    let ic = parts[1].replace(/[^a-zA-Z0-9]/g, ''); // Allow alphanumeric for ID
                    
                    if (isIndividual) {
                        // Strict check for IC (Penyertaan/Penghargaan)
                        ic = ic.replace(/[^0-9]/g, ''); // Force numeric
                        if (name && ic && ic.length >= 12) {
                             currentParticipants.push({ name, ic });
                        } else {
                            console.warn(`[DATA TIDAK SAH - Individu] Baris: "${line}". Nama: ${name ? 'OK' : 'TIDAK WUJUD'}, No. K/P: ${ic.length} digit (Perlu >= 12).`);
                            invalidLines++;
                        }
                    } else {
                        // Soft check for Name (Pencapaian - School/Org)
                        // IC/ID is optional here, Name is sufficient.
                        if (name) {
                            currentParticipants.push({ name, ic });
                        } else {
                            console.warn(`[DATA TIDAK SAH - Pencapaian] Baris: "${line}". Nama Penerima MESTI WUJUD.`);
                            invalidLines++;
                        }
                    }
                } else if (parts.length === 1 && certType === 'Sijil Pencapaian') {
                    // Accept single line name only for achievement certificate (assuming no ID is needed)
                    const name = parts[0].toUpperCase().trim();
                    if (name) {
                        currentParticipants.push({ name, ic: '' });
                    } else {
                        invalidLines++;
                    }
                }
                
                else {
                    console.warn(`[FORMAT SALAH] Baris: "${line}". Data tidak dipisahkan oleh Tab/format tidak lengkap.`);
                    invalidLines++;
                }
            }
            
            if (currentParticipants.length > 0) {
                renderParticipantList();
                previewCard.classList.remove('hidden');
                document.getElementById('generate-btn').disabled = false;
                
                if (invalidLines > 0) {
                    statusMessage.textContent = `Berjaya memproses ${currentParticipants.length} nama. ${invalidLines} baris data TIDAK SAH diabaikan. Sila semak konsol untuk butiran.`;
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('bg-red-100');
                    statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                } else {
                    statusMessage.textContent = `Berjaya memproses ${currentParticipants.length} nama. Anda boleh teruskan menjana sijil.`;
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('bg-red-100');
                    statusMessage.classList.add('bg-green-100', 'text-green-800');
                }

            } else {
                renderParticipantList();
                previewCard.classList.add('hidden');
                document.getElementById('generate-btn').disabled = true;
                statusMessage.textContent = "Tiada peserta ditemui dalam data pukal. Cuba isi manual atau semak format data.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
            }
        }
        
        // Fungsi untuk memaparkan senarai peserta dalam jadual preview
        function renderParticipantList() {
            const listContainer = document.getElementById('participant-list-preview');
            const countDisplay = document.getElementById('participant-count');
            const certType = document.getElementById('certificate-type').value;
            const isIndividual = (certType === 'Sijil Penyertaan' || certType === 'Sijil Penghargaan');
            
            listContainer.innerHTML = '';
            countDisplay.textContent = currentParticipants.length;

            currentParticipants.forEach((p, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Display logic for IC/ID
                let icDisplay = p.ic;
                if (isIndividual && p.ic && p.ic.length >= 4) {
                    // For individuals, show 4 last digits
                    icDisplay = '****' + p.ic.slice(-4);
                } else if (!isIndividual && p.ic) {
                    // For schools/org, show the ID/Reference
                    icDisplay = p.ic;
                } else {
                    // Blank if not available
                    icDisplay = '-';
                }

                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${icDisplay}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-center text-sm">
                        <button onclick="removeParticipant(${index})" class="text-red-600 hover:text-red-900 font-semibold text-xs border border-red-300 rounded-lg px-2 py-1 transition duration-150 ease-in-out hover:bg-red-50">Buang</button>
                    </td>
                `;
                listContainer.appendChild(row);
            });
            
            // Only hide preview card if the list is completely empty
            if (currentParticipants.length === 0) {
                 document.getElementById('preview-card').classList.add('hidden');
                 document.getElementById('generate-btn').disabled = true;
            } else {
                document.getElementById('preview-card').classList.remove('hidden');
                 document.getElementById('generate-btn').disabled = false;
            }
        }
        
        // Fungsi untuk membuang peserta dari senarai
        function removeParticipant(index) {
            // Confirm removal (using a custom box for better UX than alert/confirm)
            // NOTE: Using window.confirm() as a temporary solution as custom modal UI is complex
            if (!confirm(`Anda pasti untuk membuang ${currentParticipants[index].name} dari senarai?`)) {
                return;
            }
            
            currentParticipants.splice(index, 1);
            renderParticipantList();
            
            // Update status message
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = `Nama telah dibuang. Sisa ${currentParticipants.length} nama sedia untuk dicetak.`;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('bg-red-100');
            statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            
            if (currentParticipants.length === 0) {
                 document.getElementById('preview-card').classList.add('hidden');
            }
        }


        // Fungsi untuk mengambil data program dari input form
        function getProgramData() {
            const certificateType = document.getElementById('certificate-type').value.trim();
            const programName = document.getElementById('program-name').value.trim();
            const awardTitle = document.getElementById('award-title').value.trim();
            const programKeySelect = document.getElementById('program-key-select').value;
            const startDate = document.getElementById('start-date').value.trim();
            const endDate = document.getElementById('end-date').value.trim();
            
            // Get Signatory Data based on selection
            const signatorySelect = document.getElementById('signatory-select').value;
            let signatoryData;
            
            if (signatorySelect === 'LAIN') {
                signatoryData = SIGNATORIES.LAIN;
            } else {
                signatoryData = SIGNATORIES.MARIAM_DEFAULT;
            }

            const signatoryName = signatoryData.name;
            const signatoryTitle = signatoryData.title;


            let programKey;

            // Determine program key value
            if (programKeySelect === 'LAIN') {
                programKey = document.getElementById('custom-program-key').value.trim();
                
                // Validation: If 'Lain-lain' is selected, custom key MUST be provided
                if (programKey === '') {
                    return { error: "Sila masukkan Kod Kustom kerana anda memilih 'Lain-lain'." };
                }
            } else {
                programKey = programKeySelect;
            }
            
            // Validation: Name and Start Date are mandatory
            if (!programName || !startDate) {
                return null;
            }
            
            // Clean up programKey (remove special characters)
            programKey = programKey.replace(/[^a-zA-Z0-9]/g, '') || 'SP'; 

            return { 
                certificateType, 
                programName, 
                awardTitle, 
                programKey, 
                startDate, 
                endDate,
                signatoryName, 
                signatoryTitle 
            };
        }

        // Fungsi utama untuk menjana dan mencetak sijil
        async function generateCertificates() {
            const programData = getProgramData();
            const participants = currentParticipants;
            
            const statusMessage = document.getElementById('status-message');
            const generateBtn = document.getElementById('generate-btn');
            
            // Validation Check
            if (programData && programData.error) {
                 statusMessage.textContent = programData.error;
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-100', 'text-red-700');
                 statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                 return;
            }
            
            // Validation: General data missing
            if (!programData) {
                statusMessage.textContent = "Sila isi semua maklumat Program (Nama dan Tarikh Mula wajib diisi).";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }
            
            // Validation: Participants list empty
            if (participants.length === 0) {
                statusMessage.textContent = "Sila semak data peserta dahulu. Senarai peserta adalah kosong.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.classList.remove('bg-yellow-100', 'bg-green-100');
                return;
            }
            
            // Set loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Menjana Sijil...</span>';


            try {
                // Construct all certificates HTML
                let allCertificatesHTML = '';
                participants.forEach(participant => {
                    const certHTML = createCertificateHTML(programData, participant);
                    allCertificatesHTML += certHTML;
                });
                
                // Open a new window for printing
                const printWindow = window.open('', '_blank');
                
                // Write the full HTML structure including the necessary print styles
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ms">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Cetak Sijil Pukal - ${programData.certificateType} - ${programData.programName}</title>
                        <style>
                            /* Import certificate fonts (Montserrat and Playfair Display) */
                            @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                            
                            /* Global styles for the print window */
                            body { 
                                font-family: 'Montserrat', sans-serif; 
                                font-weight: 400; 
                                margin: 0; 
                                padding: 0; 
                                background-color: white; 
                                display: flex; 
                                flex-direction: column; 
                                color: #333; 
                            }
                            
                            /* Certificate container styles for A4 portrait and page breaks */
                            .certificate-container { 
                                width: 210mm; 
                                height: 297mm; 
                                background-color: white; 
                                padding: 12mm; 
                                box-sizing: border-box; 
                                position: relative; 
                                display: flex; 
                                flex-direction: column; 
                                text-align: center; 
                                overflow: hidden; 
                                page-break-after: always; 
                            }
                            .certificate-container:last-child { page-break-after: avoid; }
                            
                            /* Corner elements (copied from original) */
                            .certificate-container::before, .certificate-container::after { 
                                content: ''; 
                                position: absolute; 
                                width: 170px; 
                                height: 170px; 
                                background-color: #4B40FF; 
                                opacity: 0.9; 
                                z-index: 1; 
                            }
                            .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                            .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                            
                            /* Inner content border (copied from original) */
                            .certificate-content { 
                                border: 6px solid; 
                                border-image-slice: 1; 
                                border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); 
                                height: 100%; 
                                padding: 10mm; 
                                box-sizing: border-box; 
                                position: relative; 
                                z-index: 2; 
                                display: flex; 
                                flex-direction: column; 
                                background: #ffffff; 
                            }
                            
                            /* All other inner elements styles (copied from original) */
                            .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                            .qr-code { width: 65px; height: 65px; }
                            .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                            .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                            h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                            .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                            .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                            .event-title-label { font-size: 16px; color: #555; }
                            .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                            .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                            .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                            .signature-section { margin-top: auto; }
                            .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                            .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                            .spark-section { margin-top: 15px; }
                            .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                            .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                            
                            @media print {
                                @page { size: A4 portrait; margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${allCertificatesHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.onload = function() { 
                    printWindow.focus(); 
                    printWindow.print();
                    // Reset button state
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>Jana & Cetak Semua Sijil</span>';
                };

            } catch (error) {
                console.error("Ralat semasa menjana sijil:", error);
                statusMessage.textContent = "Ralat berlaku semasa menjana sijil. Sila semak konsol untuk butiran lanjut.";
                statusMessage.classList.remove('hidden');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>Jana & Cetak Semua Sijil</span>';
            }
        }

        // Fungsi untuk menjana HTML sijil berdasarkan data (diambil dari sijil.html)
        function createCertificateHTML(programData, participantData) {
            const { 
                certificateType, 
                programName, 
                awardTitle, 
                programKey, 
                startDate, 
                endDate, 
                signatoryName, 
                signatoryTitle  
            } = programData;
            const participantName = participantData.name.toUpperCase();
            const participantIC = participantData.ic;
            const courseName = programName.toUpperCase();
            const awardTitleUpper = awardTitle.toUpperCase();
            
            // --- Logic for Introduction and Action Text based on Type ---
            let introText;
            let actionTextHTML = ''; 
            let recipientIcHTML = ''; 
            
            if (certificateType === 'Sijil Penghargaan') {
                introText = "Dengan penuh penghargaan kepada";
                actionTextHTML = `<p class="event-title-label">di atas sumbangan beliau dalam</p>`; 
                recipientIcHTML = `<p class="recipient-ic">${participantIC}</p>`; 
            } else if (certificateType === 'Sijil Pencapaian') {
                introText = "DIANUGERAHKAN KEPADA";
                actionTextHTML = `<p class="event-title-label" style="font-style: italic;">atas pengiktirafan bagi</p>`; 
                recipientIcHTML = participantIC ? `<p class="recipient-ic">${participantIC}</p>` : ''; 
            } else {
                // Default for Sijil Penyertaan (Participation)
                introText = "Dengan ini disahkan bahawa";
                actionTextHTML = `<p class="event-title-label">telah mengikuti</p>`;
                recipientIcHTML = `<p class="recipient-ic">${participantIC}</p>`; 
            }
            // --- End Logic ---

            const startD = new Date(startDate + 'T00:00:00');
            const isMultiDay = endDate && endDate.trim() !== '';

            let dateString;
            
            if (!isMultiDay || new Date(endDate + 'T00:00:00').getTime() === startD.getTime()) {
                dateString = `pada ${startD.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                const endD = new Date(endDate + 'T00:00:00');
                dateString = `pada ${startD.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endD.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const programIdentifier = programKey.replace(/[^a-zA-Z0-9]/g, '') || 'SP'; 
            const serialNumber = `SPK/${programIdentifier}/${(participantIC.slice(-4) || 'REF')}`; 
            
            const validationUrl = `${window.location.origin}/sijil.html?ic=${participantIC}`; 
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;
            const logoUrl = "https://i.imgur.com/FQpwGDo.png"; 
            const awardSealUrl = "https://i.imgur.com/9v4J4bO.png"; 

            // Additional text for the achievement title (Baris 2)
            // This is displayed directly under the <h1>
            const awardTitleHTML = (certificateType === 'Sijil Pencapaian' && awardTitle) 
                ? `<p class="text-xl font-bold text-gray-800 tracking-wider mb-2">${awardTitleUpper}</p>` 
                : '';

            return `
                <div class="certificate-container">
                    <div class="certificate-content">
                        <div class="header-section">
                            <img src="${qrCodeUrl}" onerror="this.onerror=null; this.src='https://placehold.co/65x65/E0E7FF/4338CA?text=QR'" alt="QR Code" class="qr-code">
                            <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                        </div>
                        <img src="${logoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/150x75/E0E7FF/4338CA?text=LOGO+PPD+MIRI'" alt="Logo Pejabat Pendidikan Daerah Miri" class="logo">
                        <h1>${certificateType.toUpperCase()}</h1>
                        ${awardTitleHTML} <!-- Insert award title here -->

                        <p class="intro-text">${introText}</p>
                        <p class="recipient-name">${participantName}</p>
                        ${recipientIcHTML}

                        ${(certificateType !== 'Sijil Pencapaian') ? actionTextHTML : ''}
                        
                        <p class="event-title">${courseName}</p>
                        <p class="event-date">${dateString}</p>
                        <hr class="divider">
                        <div class="signature-section">
                            ${(certificateType === 'Sijil Pencapaian') ? 
                                `<img src="${awardSealUrl}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/ffd700/000000?text=SEAL'" alt="Award Seal" class="logo" style="width: 80px; height: 80px; margin: 10px auto;">` 
                                : ''}
                            <p class="signatory-name">${signatoryName.toUpperCase()}</p>
                            <p class="signatory-title">${signatoryTitle.toUpperCase()}</p>
                        </div>
                        <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                        <div class="spark-section">
                            <p class="spark-title">SPARK</p>
                            <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.addParticipantManually = addParticipantManually;
        window.parseAndRenderData = parseAndRenderData;
        window.removeParticipant = removeParticipant;
        window.generateCertificates = generateCertificates;
        window.toggleCustomKeyInput = toggleCustomKeyInput;
        window.updateSignatoryDisplay = updateSignatoryDisplay;
        window.updateParticipantInputLabels = updateParticipantInputLabels;
    </script>
</body>
</html>
