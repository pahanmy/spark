<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK ‚Äì Kalendar Peribadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; transition: background-color 0.5s ease; }
        .card { background-color: rgba(255, 255, 255, 0.95); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); backdrop-filter: blur(4px); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        
        .calendar-day { 
            min-height: 110px; max-height: 110px;
            display: flex; flex-direction: column; position: relative;
            transition: all 0.2s; cursor: pointer;
        }
        .calendar-day:hover { transform: translateY(-2px); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .event-list { overflow-y: auto; flex-grow: 1; z-index: 10; }
        
        /* Colors */
        .calendar-day.has-own { background-color: #ecfdf5; border: 1px solid #a7f3d0; } 
        .calendar-day.has-tagged { background-color: #f3e8ff; border: 1px solid #d8b4fe; } 
        .calendar-day.has-official { background-color: #eef2ff; border: 1px dashed #c7d2fe; opacity: 0.9; } 
        .calendar-day.has-birthdays { background-color: #fff1f2; border: 1px solid #fecdd3; } 
        .calendar-day.selected { border-width: 2px; border-color: #0d9488; background-color: #ccfbf1; transform: scale(1.02); z-index: 20; shadow: lg; }
        .calendar-day.is-today { background-color: #fffbeb; border: 2px solid #f59e0b; }
        
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 50; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        
        .mission-item.completed span { text-decoration: line-through; color: #9ca3af; }
        .mission-item.completed { background-color: #f9fafb; border-color: #e5e7eb; opacity: 0.7; }
        
        .color-picker-wrapper { overflow: hidden; position: relative; }
        .color-picker-wrapper input[type="color"] { position: absolute; left: -100%; top: -100%; width: 300%; height: 300%; cursor: pointer; opacity: 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .quote-container { animation: fadeIn 1s ease-out; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; display: block; }
        
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .quote-edit-icon { opacity: 0; transition: opacity 0.2s; }
        .quote-wrapper:hover .quote-edit-icon { opacity: 1; }
        .quick-link-btn { transition: all 0.2s; }
        .quick-link-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .emoji-bar { -ms-overflow-style: none; scrollbar-width: none; }
        .emoji-bar::-webkit-scrollbar { display: none; }

        /* Toggle Checkbox */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox { right: 20px; transition: all 0.3s; }
        
        /* Participant Search Dropdown */
        #participant-dropdown::-webkit-scrollbar { width: 6px; }
        #participant-dropdown::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body id="main-body" class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-teal-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-teal-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Ruang Aktiviti Peribadi</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="color-picker-wrapper btn bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-sm capitalize cursor-pointer relative overflow-hidden">
                    <input type="color" id="theme-color-input" onchange="changeTheme(this)" title="Pilih warna tema anda">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                    <span class="hidden sm:inline">Tema</span>
                </div>
                <button onclick="window.history.back()" class="btn bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-sm capitalize">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Kembali
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div id="personal-header" class="relative w-full h-48 md:h-64 mb-16 group mx-auto max-w-screen-2xl rounded-2xl shadow-xl select-none">
            <div class="absolute inset-0 rounded-2xl overflow-hidden bg-gray-200">
                <div id="personal-bg-img" class="absolute inset-0 bg-cover bg-center transition-transform duration-0" style="background-image: url('https://i.imgur.com/3utZGua.png');"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent pointer-events-none"></div>
                <div id="drag-instruction" class="absolute inset-0 flex items-center justify-center bg-black/40 text-white font-bold uppercase tracking-widest hidden z-10 pointer-events-none">
                    <span class="bg-black/50 px-4 py-2 rounded-lg border border-white/30 backdrop-blur-md">Drag untuk laraskan</span>
                </div>
            </div>

            <div id="pro-profile-container" class="hidden absolute -bottom-12 left-6 md:left-10 z-30 group-hover:scale-105 transition-transform duration-300">
                <img id="pro-profile-img" src="" class="w-32 h-32 md:w-40 md:h-40 rounded-full border-[6px] border-white shadow-2xl object-cover bg-gray-200">
                <div class="absolute bottom-2 right-2 bg-blue-600 text-white p-1 rounded-full shadow-md border-2 border-white" title="Verified Pro">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                </div>
            </div>

            <div id="user-info-text" class="absolute bottom-4 left-40 md:left-56 z-20 pl-2 transition-opacity">
                <h2 id="display-name" class="text-2xl md:text-4xl font-extrabold text-white shadow-black drop-shadow-md tracking-tight uppercase leading-none">USER</h2>
                <p class="text-xs md:text-sm text-gray-200 font-medium mt-1 shadow-black drop-shadow-sm">Selamat datang ke papan pemuka peribadi anda.</p>
            </div>

            <div class="absolute top-4 right-4 flex flex-col gap-2 z-30">
                <div id="normal-header-controls" class="flex flex-col gap-2 group-hover:opacity-100 opacity-0 translate-y-[-10px] group-hover:translate-y-0 transition-all duration-300">
                    <button onclick="startReposition()" class="bg-black/30 hover:bg-black/50 backdrop-blur-md p-2.5 rounded-xl cursor-pointer text-white border border-white/20 shadow-lg flex items-center justify-end gap-2 w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                        <span class="text-xs font-bold hidden md:inline">Laraskan</span>
                    </button>
                    <label class="bg-black/30 hover:bg-black/50 backdrop-blur-md p-2.5 rounded-xl cursor-pointer text-white border border-white/20 shadow-lg flex items-center justify-end gap-2 w-full">
                        <input type="file" class="hidden" accept="image/*" onchange="uploadPersonalBg(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span class="text-xs font-bold hidden md:inline">Tukar Gambar</span>
                    </label>
                </div>
                <div id="edit-header-controls" class="hidden flex flex-col gap-2">
                    <button onclick="saveReposition()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg border border-white/20">SIMPAN</button>
                    <button onclick="cancelReposition()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg border border-white/20">BATAL</button>
                </div>
            </div>
            <div id="bg-upload-status" class="absolute top-28 right-4 text-xs font-bold text-white hidden bg-black/50 px-2 py-1 rounded z-30"></div>
        </div>

        <div class="mb-2 text-center quote-container px-4">
            <div class="relative max-w-4xl mx-auto quote-wrapper">
                <div class="flex items-center justify-center gap-2">
                    <h1 id="motivational-quote" contenteditable="true" onblur="saveQuote(this)" 
                        class="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-700 via-purple-700 to-pink-700 cursor-text outline-none break-words pb-1 italic leading-tight" 
                        placeholder="Klik untuk tulis kata semangat...">
                    </h1>
                    <div class="quote-edit-icon text-gray-400 cursor-pointer" onclick="document.getElementById('motivational-quote').focus()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8 text-center px-4 relative group/links">
            <div id="quick-links-container" class="flex flex-wrap justify-center gap-3 items-center min-h-[32px]">
                <span class="text-xs text-gray-300 italic">...</span>
            </div>
            <button onclick="openLinkModal()" class="mt-3 text-[10px] text-gray-400 hover:text-teal-600 font-bold uppercase tracking-wider opacity-0 group-hover/links:opacity-100 transition-opacity flex items-center justify-center gap-1 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Urus Pautan
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
                <div class="card p-4 mb-6 flex flex-col md:flex-row items-center gap-4">
                    <div class="flex gap-2 w-full md:w-auto shrink-0">
                        <select id="month-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5 cursor-pointer"></select>
                        <select id="year-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-24 p-2.5 cursor-pointer"></select>
                    </div>
                    <div class="w-full flex-grow">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/></svg></div>
                            <input type="text" id="search-input" class="block w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500" placeholder="Cari aktiviti...">
                        </div>
                    </div>
                    <div class="flex items-center w-full md:w-auto bg-indigo-50 px-3 py-2.5 rounded-lg border border-indigo-100 shrink-0">
                        <span class="mr-3 text-xs font-bold text-indigo-800 uppercase">Paparkan PPD?</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="ppd-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0"/>
                            <label for="ppd-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-6 text-center">
                    <div class="bg-teal-50 border border-teal-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-teal-600 uppercase">Ciptaan Saya</h4><p id="stat-own" class="text-xl font-extrabold text-teal-700">0</p></div>
                    <div class="bg-purple-50 border border-purple-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-purple-600 uppercase">Jemputan</h4><p id="stat-tagged" class="text-xl font-extrabold text-purple-700">0</p></div>
                    <div class="bg-pink-50 border border-pink-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-pink-600 uppercase">Birthday</h4><p id="stat-birthday" class="text-xl font-extrabold text-pink-700">0</p></div>
                    <div class="bg-indigo-50 border border-indigo-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-indigo-500 uppercase">Rasmi</h4><p id="stat-official" class="text-xl font-extrabold text-indigo-700">0</p></div>
                </div>

                <div class="card p-6 relative">
                    <div class="flex justify-between items-center mb-6">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <h2 id="calendar-header" class="text-xl font-extrabold text-gray-800 uppercase tracking-wide"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                    <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center font-bold text-xs text-gray-400 mb-3 uppercase tracking-wider">
                        <div>Ahad</div><div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div>Sabtu</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    <div class="mt-6 flex flex-wrap gap-4 text-[10px] font-bold uppercase justify-center text-gray-500">
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-teal-500"></span> Aktiviti Saya</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-purple-500"></span> Dijemput</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-pink-500"></span> Birthday</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-200 border border-amber-400"></span> Nota Harian</div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="card p-5 border border-purple-200 bg-purple-50 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-purple-100 rounded-full opacity-50"></div>
                    <h3 class="text-xs font-bold text-purple-800 uppercase mb-3 flex items-center gap-2 relative z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Senarai Semak Tugasan
                    </h3>
                    <div class="flex gap-2 mb-3 relative z-10">
                        <input type="text" id="new-mission-input" class="w-full text-xs p-2 rounded border border-purple-300 focus:outline-none focus:border-purple-600 bg-white" placeholder="Taip tugasan...">
                        <button onclick="addMission()" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded shadow-sm transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                    <div id="mission-list-container" class="space-y-2 max-h-[250px] overflow-y-auto custom-scrollbar pr-1 relative z-10">
                        <div class="text-center py-4 text-gray-400 text-[10px] italic">Memuatkan...</div>
                    </div>
                </div>

                <div id="program-list-container" class="h-[500px]">
                    <div class="card p-6 h-full flex flex-col border border-gray-200 shadow-lg">
                        <div class="border-b border-gray-100 pb-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-extrabold text-gray-800 uppercase tracking-tight">Agenda</h3>
                                <span id="selected-date-text" class="text-xs font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded-md uppercase">Hari Ini</span>
                            </div>
                            <button id="btn-add-activity" onclick="handleAddActivity()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg uppercase text-xs shadow-sm flex items-center justify-center gap-2 transition-transform active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Tambah Aktiviti
                            </button>
                        </div>
                        <div id="program-list-content" class="space-y-3 overflow-y-auto flex-grow pr-2 custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-6 mt-8 bg-white/80 backdrop-blur border-t border-gray-200">
        <p class="text-sm text-gray-600 font-medium">Projek Inovasi SPARK oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-bold text-teal-600 hover:underline">Pahan</a></p>
        <p class="text-xs text-gray-400 mt-1">V2.5 | 2026 <span id="footer-user-ic"></span></p>
    </footer>

    <div id="link-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-900 mb-4 uppercase flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                Urus Pautan Pantas
            </h3>
            <div id="link-list-container" class="space-y-2 mb-6"></div>
            <form onsubmit="saveQuickLink(event)" id="add-link-form" class="border-t border-gray-100 pt-4">
                <p class="text-xs font-bold text-gray-500 uppercase mb-2">Tambah Baru (Max 5)</p>
                <div class="space-y-3">
                    <input type="text" id="link-name" class="w-full text-xs p-2 border rounded" placeholder="Nama Pautan (cth: Google)" required maxlength="10">
                    <input type="url" id="link-url" class="w-full text-xs p-2 border rounded" placeholder="URL (https://...)" required>
                    <select id="link-icon" class="w-full text-xs p-2 border rounded bg-white">
                        <option value="link">üîó Ikon Link</option>
                        <option value="google">üîç Google</option>
                        <option value="portal">üèõÔ∏è Portal Rasmi</option>
                        <option value="drive">üìÇ Google Drive</option>
                        <option value="youtube">‚ñ∂Ô∏è Youtube</option>
                        <option value="file">üìÑ Fail/Dokumen</option>
                        <option value="facebook">üì± Facebook</option>
                        <option value="whatsapp">üí¨ Whatsapp</option>
                    </select>
                    <button type="submit" id="btn-add-link" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded text-xs uppercase">Tambah</button>
                </div>
            </form>
            <button onclick="closeModal('link-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
    </div>

    <div id="daily-note-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-amber-100 rounded-lg shadow-2xl w-full max-w-sm p-0 overflow-hidden relative transform rotate-1 transition-transform hover:rotate-0 border-2 border-amber-200">
            <div class="bg-amber-200 px-4 py-2 border-b border-amber-300 flex justify-between items-center">
                <h3 id="note-modal-title" class="font-bold text-amber-800 uppercase text-sm">Nota Harian</h3>
                <button onclick="closeModal('daily-note-modal')" class="text-amber-800 hover:text-amber-900 font-bold">‚úï</button>
            </div>
            <div class="p-4">
                <textarea id="daily-note-content" class="w-full h-40 bg-amber-100 border-none focus:ring-0 text-gray-800 text-sm resize-none font-medium leading-relaxed" placeholder="Catat nota penting hari ini..."></textarea>
                <div class="flex gap-2 py-2 overflow-x-auto emoji-bar mb-2 border-b border-amber-200">
                    <button onclick="insertToNote('üòÄ')" class="text-lg hover:scale-110 transition">üòÄ</button>
                    <button onclick="insertToNote('üòÇ')" class="text-lg hover:scale-110 transition">üòÇ</button>
                    <button onclick="insertToNote('üòä')" class="text-lg hover:scale-110 transition">üòä</button>
                    <button onclick="insertToNote('üòç')" class="text-lg hover:scale-110 transition">üòç</button>
                    <button onclick="insertToNote('ü§î')" class="text-lg hover:scale-110 transition">ü§î</button>
                    <button onclick="insertToNote('üëç')" class="text-lg hover:scale-110 transition">üëç</button>
                    <button onclick="insertToNote('üôè')" class="text-lg hover:scale-110 transition">üôè</button>
                    <button onclick="insertToNote('üî•')" class="text-lg hover:scale-110 transition">üî•</button>
                    <button onclick="insertToNote('üìÖ')" class="text-lg hover:scale-110 transition">üìÖ</button>
                    <button onclick="insertToNote('‚ö†Ô∏è')" class="text-lg hover:scale-110 transition">‚ö†Ô∏è</button>
                    <button onclick="insertToNote('‚≠ê')" class="text-lg hover:scale-110 transition">‚≠ê</button>
                </div>
                <div class="flex gap-2 justify-between items-center">
                    <div class="flex gap-1">
                        <button onclick="insertToNote('‚úÖ ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded" title="Tanda">‚úÖ</button>
                        <button onclick="insertToNote('üìå ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded" title="Pin">üìå</button>
                        <button onclick="insertToNote(' - ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded font-bold" title="Point">List</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteDailyNote()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1.5 px-3 rounded shadow-sm">PADAM</button>
                        <button onclick="saveDailyNote()" id="btn-save-note" class="bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold py-1.5 px-4 rounded shadow-sm">SIMPAN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="planner-modal-form" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative m-4 max-h-[90vh] overflow-y-auto">
            <button onclick="closePlannerModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <h3 id="planner-modal-title" class="text-lg font-bold text-gray-800 mb-1 uppercase">Rancang Aktiviti</h3>
            <p class="text-xs text-gray-500 mb-4">Masukkan butiran aktiviti anda.</p>
            
            <form onsubmit="savePlannerActivity(event)" class="space-y-4">
                
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nama Program / Aktiviti</label>
                    <input type="text" id="plan-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase" required placeholder="Cth: Mesyuarat PIBG">
                </div>
                
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <input id="is-one-day" type="checkbox" checked onchange="toggleDateRange()" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="is-one-day" class="ml-2 block text-xs font-bold text-gray-700 uppercase">Sehari Sahaja?</label>
                    </div>
                    <div class="flex items-center">
                        <input id="is-public-program" type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="is-public-program" class="ml-2 block text-xs font-bold text-indigo-700 uppercase">Paparkan di Takwim Utama?</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh Mula</label>
                        <input type="date" id="plan-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Mula</label>
                        <input type="time" id="plan-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" required>
                    </div>
                </div>

                <div id="single-day-end-time" class="grid grid-cols-2 gap-4">
                    <div></div> <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Tamat</label>
                        <input type="time" id="plan-end-time-single" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                </div>

                <div id="end-date-container" class="grid grid-cols-2 gap-4 hidden bg-gray-50 p-2 rounded border border-gray-200">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh Tamat</label>
                        <input type="date" id="plan-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Tamat</label>
                        <input type="time" id="plan-end-time-multi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Mod Perjumpaan</label>
                        <select id="plan-mode" onchange="toggleMeetingMode()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase">
                            <option value="BERSEMUKA">BERSEMUKA</option>
                            <option value="DALAM TALIAN">DALAM TALIAN</option>
                        </select>
                    </div>
                    <div id="plan-link-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pautan / Link</label>
                        <input type="text" id="plan-link" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" placeholder="https://...">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Lokasi</label>
                    <input type="text" id="plan-location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase" placeholder="Cth: Bilik Gerakan">
                </div>

                <div class="relative p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-700 uppercase">Peserta</label>
                        
                        <button type="button" onclick="saveCurrentGroup()" class="text-[10px] bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded border border-indigo-200 font-bold uppercase flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                            Simpan List Ini
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <select id="group-selector" onchange="loadGroup(this.value)" class="w-full text-xs border-gray-300 rounded focus:ring-teal-500 focus:border-teal-500 uppercase bg-white py-1.5">
                            <option value="">-- PILIH SENARAI SIMPANAN --</option>
                        </select>
                    </div>

                    <div class="relative">
                        <input type="text" id="participant-search-input" placeholder="Cari nama & tekan..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase mb-2 bg-white">
                        <div id="participant-dropdown" class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-40 overflow-y-auto hidden"></div>
                    </div>

                    <div id="selected-participants-container" class="flex flex-wrap gap-2 p-2 bg-white border border-gray-200 rounded-md min-h-[50px]">
                        <span class="text-xs text-gray-400 italic self-center">Tiada peserta dipilih.</span>
                    </div>
                    
                    <div class="text-right mt-1">
                         <button type="button" onclick="clearParticipants()" class="text-[10px] text-red-500 hover:text-red-700 underline uppercase">
                            Kosongkan Semua
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Catatan / Minit / Info</label>
                    <textarea id="plan-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" placeholder="Tampal teks panjang dari Telegram/WhatsApp di sini..."></textarea>
                    
                    <div class="mt-2 p-2 border border-dashed border-gray-300 rounded bg-gray-50">
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1 flex items-left gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Muat Naik Gambar (Pilihan)
                        </label>
                        <input type="file" id="plan-image-file" accept="image/*" onchange="uploadImageToImgBB(this)" class="block w-full text-xs text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                        <input type="hidden" id="plan-image-url">
                        <div id="image-upload-status" class="text-xs text-gray-500 mt-1 italic"></div>
                        <div id="image-preview" class="hidden mt-2">
                             <img src="" alt="Preview" class="max-h-[150px] rounded border border-gray-200">
                             <button type="button" onclick="clearImage()" class="text-[10px] text-red-500 underline mt-1">Padam Gambar</button>
                        </div>
                    </div>
                </div>

                <button type="submit" id="btn-save-plan" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition shadow-md uppercase text-sm mt-2">Simpan Aktiviti</button>
            </form>
        </div>
    </div>
    
    <div id="crop-modal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-sm font-bold text-gray-800 uppercase flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Posisi Gambar
                </h3>
                <button onclick="closeCropModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="p-4 bg-gray-900 flex flex-col items-center justify-center flex-grow">
                <div class="img-container w-full">
                    <img id="image-to-crop" src="" alt="Picture to crop">
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-center uppercase">Gerakkan dan 'Zoom' gambar ke dalam kotak biru</p>
            </div>

            <div class="p-4 border-t border-gray-100 flex gap-3 bg-white">
                <button onclick="closeCropModal()" class="w-1/3 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-bold uppercase text-xs hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button onclick="cropAndUpload()" id="btn-crop-upload" class="w-2/3 py-2.5 rounded-lg bg-indigo-600 text-white font-bold uppercase text-xs hover:bg-indigo-700 shadow-lg flex justify-center items-center gap-2 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    Simpan Gambar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setDoc, updateDoc, addDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // --- GLOBAL VARIABLES ---
        let currentUserIc = "";
        let currentUserSector = ""; 
        let currentUserUnit = ""; 
        let isSparkPro = false;
        
        let attendanceList = [];
        let createdList = [];
        let taskList = [];
        let allProgramsList = [];
        let plannerList = [];
        
        let allUsersData = []; 
        let selectedParticipants = []; 
        let mySavedGroups = []; 
        
        let filteredResults = []; 
        let currentPage = 1;
        let rowsPerPage = 5; 
        
        let participantDocId = null;
        let currentTab = 'planner'; 
        let currentPlannerDate = new Date();
        
        let editingPlannerId = null;
        let cropper = null; 

        // Variable Baru untuk fix Error 'not defined'
        let dailyNotes = []; 
        let allBirthdays = [];
        let selectedDateString = "";

        const sectorUnitData = {
            "SEKTOR PERANCANGAN": ["UNIT PERANCANGAN DAN PENGURUSAN PPD", "UNIT PENGURUSAN MAKLUMAT (ICT)", "UNIT DATA DAN MAKLUMAT"],
            "SEKTOR PEMBELAJARAN": ["UNIT BAHASA", "UNIT SAINS DAN MATEMATIK", "UNIT TVET", "UNIT SAINS SOSIAL & KEMANUSIAAN", "UNIT PENDIDIKAN ISLAM", "UNIT PENDIDIKAN KHAS", "UNIT PEMULIHAN KHAS", "UNIT SUMBER & TEKNOLOGI PENDIDIKAN"],
            "SEKTOR PEMBANGUNAN MURID": ["UNIT HAL EHWAL MURID", "UNIT PEMBANGUNAN BAKAT MURID"],
             "SEKTOR PENGURUSAN SEKOLAH": ["UNIT PENGUPAYAAN KEPIMPINAN SEKOLAH", "UNIT PRASEKOLAH & RENDAH","UNIT MENENGAH & TINGKATAN 6","UNIT SWASTA"],
            "SEKTOR PENTAKSIRAN & PEPERIKSAAN": ["UNIT PENTAKSIRAN & PEPERIKSAAN"],
            "SEKTOR PSIKOLOGI & KAUNSELING": ["UNIT PSIKOLOGI & KAUNSELING"],
            "SEKTOR PENGURUSAN": ["UNIT PENTADBIRAN DAN KUMPULAN SOKONGAN", "UNIT KEWANGAN DAN AKAUN", "UNIT INFRASTRUKTUR DAN PEROLEHAN", "UNIT ICT"]
        };

        // --- AUTH & LOAD DATA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlIc = urlParams.get('ic');
                let storedIc = localStorage.getItem('user_ic');

                if (urlIc) {
                    storedIc = urlIc.trim();
                    localStorage.setItem('user_ic', storedIc);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                if (storedIc) {
                    currentUserIc = storedIc;
                    loadUserData(currentUserIc);
                } else {
                    const input = prompt("Sesi tamat atau tiada data. Sila masukkan No. IC anda:");
                    if (input) {
                        currentUserIc = input.trim().replace(/[^0-9]/g, '');
                        if (currentUserIc) {
                            localStorage.setItem('user_ic', currentUserIc); 
                            loadUserData(currentUserIc);
                        } else {
                            alert("No. IC tidak sah.");
                            window.location.href = 'index.html';
                        }
                    } else {
                        window.location.href = 'index.html';
                    }
                }
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        const normalizeIc = (val) => String(val).replace(/[^0-9]/g, '');

        function formatIc(ic) {
            if (ic && ic.length >= 10) {
                return "******-**-" + ic.slice(-4);
            }
            return ic;
        }


        async function loadUserData(ic) {
            try {
                // Kod Background Header (Kekal)
                const settingsDocRef = doc(db, `artifacts/${appId}/public/data/spark_settings`, 'landing_page');
                getDoc(settingsDocRef).then((snap) => {
                    if(snap.exists()) {
                        const data = snap.data();
                        const header = document.getElementById('dynamic-header-bg');
                        if(header) {
                            if (data.headerBgUrl) header.style.background = `url('${data.headerBgUrl}') center center / cover no-repeat`;
                            else if (data.gradientStart && data.gradientEnd) header.style.background = `linear-gradient(to bottom right, ${data.gradientStart}, ${data.gradientEnd})`;
                        }
                    }
                });

                const cleanUserIc = normalizeIc(ic);
                
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const qUser = query(usersRef, where("ic", "==", cleanUserIc));
                const userSnap = await getDocs(qUser);
                
                let profileImageUrl = null;
                let userData = null; 

                if (!userSnap.empty) {
                    userData = userSnap.docs[0].data(); 
                    participantDocId = userSnap.docs[0].id;
                    currentUserSector = userData.sector || "";
                    currentUserUnit = userData.unit || ""; 
                    profileImageUrl = userData.profileImageUrl || null;
                    const adminIC = "890522135381";
                    isSparkPro = (userData.isPro === true) || (cleanUserIc === adminIC); 
                }
                
                // --- FIX: FETCH NOTES & BIRTHDAYS (DI SINI) ---
                const notesSnap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/spark_daily_notes`), where("ic", "==", cleanUserIc)));
                dailyNotes = notesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                const bdaySnap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/spark_birthdays`), orderBy("dob", "asc")));
                allBirthdays = bdaySnap.docs.map(d => ({ id: d.id, ...d.data() }));
                // ----------------------------------------------
                
                const defaultIcon = document.getElementById('default-profile-icon');
                const userImage = document.getElementById('user-profile-image');
                
                if (profileImageUrl) {
                    userImage.src = profileImageUrl;
                    userImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                } else {
                    userImage.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                }
                
                const sectorUnitEl = document.getElementById('user-sector-unit');
                const sectorTextEl = document.getElementById('sector-text');
                
                if (currentUserSector) {
                    let displayTxt = currentUserSector;
                    if (currentUserUnit && currentUserUnit !== '-') {
                        displayTxt += ` | ${currentUserUnit.replace("UNIT ", "")}`;
                    }
                    sectorTextEl.textContent = displayTxt;
                    sectorUnitEl.classList.remove('hidden');
                } else {
                    sectorUnitEl.classList.add('hidden');
                }

                // Fetch Programs
                const programsRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
                const programsSnapshot = await getDocs(programsRef);

                // Fetch Tasks
                const tasksRef = collection(db, `artifacts/${appId}/public/data/spark_tasks`);
                const tasksSnapshot = await getDocs(tasksRef);
                
                // Fetch Planner
                const plannerRef = collection(db, `artifacts/${appId}/public/data/spark_planner`);
                const qOwn = query(plannerRef, where("ic", "==", cleanUserIc));
                const qTagged = query(plannerRef, where("taggedIcs", "array-contains", cleanUserIc));

                const [ownSnap, taggedSnap] = await Promise.all([getDocs(qOwn), getDocs(qTagged)]);

                const plannerMap = new Map();
                ownSnap.forEach(doc => plannerMap.set(doc.id, { id: doc.id, ...doc.data() }));
                taggedSnap.forEach(doc => plannerMap.set(doc.id, { id: doc.id, ...doc.data() }));
                plannerList = Array.from(plannerMap.values());

                // Fetch All Users for Search
                const usersSnapshot = await getDocs(usersRef);
                allUsersData = [];
                usersSnapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.ic) {
                        allUsersData.push({ 
                            name: d.name.toUpperCase(), 
                            ic: normalizeIc(d.ic) 
                        });
                    }
                });
                
                // Fetch Saved Groups
                const groupsRef = collection(db, `artifacts/${appId}/public/data/spark_user_groups`);
                const qGroups = query(groupsRef, where("ownerIc", "==", cleanUserIc));
                const groupSnap = await getDocs(qGroups);
                mySavedGroups = [];
                groupSnap.forEach(doc => {
                    mySavedGroups.push({ id: doc.id, ...doc.data() });
                });
                updateGroupDropdown();

                attendanceList = [];
                createdList = [];
                taskList = [];
                allProgramsList = [];
                
                let participantData = null;
                
                document.getElementById('edit-profile-btn').href = `edit.html?ic=${cleanUserIc}`;

                programsSnapshot.forEach(programDoc => {
                    const programData = { id: programDoc.id, ...programDoc.data() };
                    const attendanceArray = programData.attendance || [];
                    allProgramsList.push(programData);
                    
                    const pData = attendanceArray.find(p => normalizeIc(p.ic) === cleanUserIc);
                    if (pData) {
                        if (!participantData) participantData = pData;
                        attendanceList.push({ programData, participantData: pData });
                    }

                    const progCreatedBy = programData.createdBy ? normalizeIc(programData.createdBy) : '';
                    const progAdminIc = programData.penyelaras_ic ? normalizeIc(programData.penyelaras_ic) : (programData.admin_ic ? normalizeIc(programData.admin_ic) : '');
                    
                    if (progCreatedBy === cleanUserIc || progAdminIc === cleanUserIc) {
                        createdList.push({ programData, participantData: null });
                    }
                });

                tasksSnapshot.forEach(taskDoc => {
                     const taskData = taskDoc.data();
                     const taskCreator = taskData.createdBy ? normalizeIc(taskData.createdBy) : '';
                     const taskPegawaiIc = taskData.ic_pegawai ? normalizeIc(taskData.ic_pegawai) : '';
                     
                     if (taskCreator === cleanUserIc || taskPegawaiIc === cleanUserIc) {
                         taskList.push({ id: taskDoc.id, ...taskData });
                     }
                });
                
                const finalName = userData ? userData.name : (participantData ? participantData.name : "TIADA REKOD");
                const finalOrg = userData ? (userData.station || userData.org) : (participantData ? (participantData.station || participantData.org) : "-");

                document.getElementById('user-name').textContent = finalName.toUpperCase();
                document.getElementById('user-ic').textContent = formatIc(ic);
                document.getElementById('user-org').textContent = (finalOrg || "-").toUpperCase();

                if (userData || participantData) {
                    checkPhoneNumber(userData || participantData);
                } else {
                    checkPhoneNumber({ ic: ic }); 
                }
                
                const totalPrograms = attendanceList.length + createdList.length + taskList.length;
                updateInfographics(totalPrograms);
                switchTab('planner'); 
                setupParticipantSearch();

            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Gagal memuatkan data. Sila cuba lagi.");
            }
        }



        
        
        // --- UPDATE INFOGRAPHICS & BADGE STATUS ---
        // Dikemaskini untuk mengekalkan posisi 'floating' (separuh luar)

function updateInfographics(total) {
    const target = 100;
    const percentage = Math.min((total / target) * 100, 100);
    const progressBar = document.getElementById('sparkpro-progress-bar');
    progressBar.style.width = `${percentage}%`;
    
    const remaining = Math.max(target - total, 0);
    const remainingEl = document.getElementById('progress-remaining');
    
    const badgeTextLabel = document.getElementById('badge-text-label');
    
    // Style Lencana Merah Apple (Pill Shape)
    const appleBadge = `<span class="ml-1 bg-[#FF3B30] text-white text-[9px] px-2 py-[1px] rounded-full shadow-sm tracking-wide font-medium">PRO</span>`;

    if (isSparkPro || remaining === 0) {
            // Status Teks Bawah Progress Bar
            remainingEl.innerHTML = isSparkPro 
            ? `STATUS: <span class="text-green-600 font-bold">AKTIF</span>` 
            : `TAHNIAH! ANDA LAYAK ${appleBadge}`;
            
            remainingEl.classList.remove('text-gray-500');
            remainingEl.classList.add('text-green-600', 'font-bold');

            // Label Utama dalam Butang (SPARK + Badge Merah)
            badgeTextLabel.innerHTML = `SPARK ${appleBadge}`;
            
    } else {
            // Status Akaun Biasa
            remainingEl.innerHTML = `${remaining} LAGI UNTUK SPARK ${appleBadge}`;
            
            badgeTextLabel.innerHTML = `AKAUN BIASA`;
            badgeTextLabel.className = "flex items-center text-xs font-bold text-gray-500 uppercase tracking-wide";
    }
}
        

        // --- CROPPER LOGIC ---
        window.triggerProfileUpload = function() {
            // Semakan Status Spark Pro
            if (!isSparkPro) {
                alert("üîí AKSES TERHAD\n\nMaaf, fungsi menukar gambar profil adalah eksklusif untuk pengguna Spark Pro sahaja.");
                return;
            }
            
            document.getElementById('profile-upload-input').click();
        }

        window.handleProfileImageUpload = function(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                inputElement.value = "";
                const imageElement = document.getElementById('image-to-crop');
                imageElement.src = e.target.result;
                document.getElementById('crop-modal').classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageElement, {
                    aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 0.9, responsive: true, guides: false, center: true, highlight: false, background: false,
                });
            };
            reader.readAsDataURL(file);
        }

        window.closeCropModal = function() {
            document.getElementById('crop-modal').classList.add('hidden');
            if (cropper) { cropper.destroy(); cropper = null; }
        }

        window.cropAndUpload = async function() {
            if (!cropper) return;
            const btn = document.getElementById('btn-crop-upload');
            const originalText = btn.innerHTML;
            btn.innerHTML = `MEMPROSES...`;
            btn.disabled = true;

            try {
                cropper.getCroppedCanvas({
                    width: 400, height: 400, fillColor: '#ffffff',
                    imageSmoothingEnabled: true, imageSmoothingQuality: 'high',
                }).toBlob(async (blob) => {
                    if (!blob) throw new Error("Gagal memproses gambar.");
                    window.closeCropModal();

                    const loading = document.getElementById('profile-loading');
                    const overlay = document.querySelector('.profile-overlay');
                    loading.classList.remove('hidden');
                    if(overlay) overlay.classList.add('hidden');

                    const formData = new FormData();
                    formData.append('image', blob, 'profile_cropped.jpg');

                    const response = await fetch('https://api.imgbb.com/1/upload?key=a7c600ac733fe14649cacd8e65619c4b', {
                        method: 'POST', body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        const imageUrl = data.data.url;
                        if (participantDocId) {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, participantDocId), { profileImageUrl: imageUrl });
                            const userImage = document.getElementById('user-profile-image');
                            const defaultIcon = document.getElementById('default-profile-icon');
                            userImage.src = imageUrl;
                            userImage.classList.remove('hidden');
                            defaultIcon.classList.add('hidden');
                        }
                    } else { throw new Error("Gagal muat naik ke server."); }

                    loading.classList.add('hidden');
                    if(overlay) overlay.classList.remove('hidden');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 'image/jpeg', 0.90);
            } catch (error) {
                console.error("Error:", error);
                alert("Gagal mengemaskini gambar.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                window.closeCropModal();
            }
        }

        // --- PLANNER & TABS ---
        window.switchTab = function(tabName) {
            currentTab = tabName;
            currentPage = 1;
            
            const tabA = document.getElementById('tab-attendance');
            const tabC = document.getElementById('tab-created');
            const tabTasks = document.getElementById('tab-tasks');
            const tabP = document.getElementById('tab-planner');
            
            const activeClass = "nav-tab active relative";
            const inactiveClass = "nav-tab relative";
            
            tabA.className = inactiveClass;
            tabC.className = inactiveClass;
            tabTasks.className = inactiveClass;
            tabP.className = inactiveClass.replace('relative', 'nav-tab relative');
            
            document.getElementById('view-table').classList.add('hidden');
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-locked-task').classList.add('hidden');

            if (tabName === 'attendance') {
                tabA.className = activeClass;
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "SENARAI KEHADIRAN";
                filteredResults = [...attendanceList];
                filteredResults.sort((a, b) => new Date(b.programData.startDate) - new Date(a.programData.startDate));
                renderTableHeader();
                renderTable();
            } else if (tabName === 'created') {
                tabC.className = activeClass;
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "PROGRAM SAYA (PENYELARAS)";
                filteredResults = [...createdList];
                // Sort by Created Date if available, else Start Date
                filteredResults.sort((a, b) => {
                    const dateA = a.programData.createdAt ? a.programData.createdAt.toDate() : new Date(a.programData.startDate);
                    const dateB = b.programData.createdAt ? b.programData.createdAt.toDate() : new Date(b.programData.startDate);
                    return dateB - dateA;
                });
                renderTableHeader();
                renderTable();
            } else if (tabName === 'tasks') {
                tabTasks.className = activeClass;
                document.getElementById('view-locked-task').classList.remove('hidden');
            } else {
                tabP.className = activeClass;
                document.getElementById('view-planner').classList.remove('hidden');
                renderPlannerList(); 
            }
        }

        // --- UPDATE TABLE HEADER UNTUK 'PROGRAM SAYA' ---
// --- UPDATE TABLE HEADER ---
        function renderTableHeader() {
            const thead = document.getElementById('table-head');
            let html = ``;

            if (currentTab === 'created') {
                // Header untuk Tab Program Saya (Kekal Seperti Asal)
                html = `
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-10">BIL</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">PROGRAM</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">TARIKH/STATUS</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">KEHADIRAN (%)</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32">TINDAKAN</th>
                </tr>`;
            } else {
                // Header Default (Kehadiran) - DIKEMASKINI (DIGABUNGKAN)
                html = `
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-12">BIL</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">BUTIRAN PROGRAM</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32">STATUS</th>
                </tr>`;
            }

            thead.innerHTML = html;
        }

        function renderTable() {
            const tbody = document.getElementById('programs-table-body');
            const noDataMsg = document.getElementById('no-data-message');
            tbody.innerHTML = '';
            
            if (filteredResults.length === 0) {
                noDataMsg.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
                document.getElementById('pagination-controls').classList.remove('hidden');
            }
            
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredResults.slice(startIndex, endIndex);
            
            paginatedData.forEach((item, index) => {
                const row = createTableRow(item, startIndex + index);
                tbody.innerHTML += row;
            });
            updatePaginationInfo();
        }

function createTableRow(result, index) {
            const { programData } = result;
            const name = programData.name ? programData.name.toUpperCase() : 'TIADA NAMA';
            
            // Format Tarikh
            let dateStr = '-';
            if (programData.startDate) {
                dateStr = new Date(programData.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
            }

            if (currentTab === 'created') {
                // --- LOGIC UNTUK TAB 'PROGRAM SAYA' (Kekal seperti asal) ---
                
                // 1. Status Logic
                const today = new Date(); today.setHours(0,0,0,0);
                const isCompleted = new Date(programData.endDate) < today;
                let statusHtml;
                
                if (programData.status === 'Batal') {
                    statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 uppercase">DIBATALKAN</span>`;
                } else if (isCompleted) {
                    statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 uppercase">SELESAI</span>`;
                } else {
                    statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 uppercase">AKTIF</span>`;
                }

                // 2. Attendance % Logic
                const attendanceCount = programData.attendance ? programData.attendance.length : 0;
                const quota = parseInt(programData.quota || 0, 10);
                let attendanceHtml = '<span class="text-gray-400 text-xs">-</span>';
                
                if (quota > 0) {
                    const percentage = attendanceCount > 0 ? Math.round((attendanceCount / quota) * 100) : 0;
                    let colorClass = 'text-gray-700';
                    if (percentage >= 90) colorClass = 'text-green-600';
                    else if (percentage >= 50) colorClass = 'text-yellow-600';
                    else if (percentage > 0) colorClass = 'text-red-600';
                    
                    attendanceHtml = `<span class="font-bold ${colorClass} text-sm">${percentage}%</span><div class="text-[10px] text-gray-400">(${attendanceCount}/${quota})</div>`;
                }

                const link = `program.html?kod=${programData.key}`;
                const safeName = programData.name.replace(/'/g, "\\'");
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-semibold text-gray-900 uppercase">${name}</div>
                            <div class="text-xs text-gray-500 uppercase mt-0.5">${programData.location || 'DALAM TALIAN'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <div class="font-medium text-gray-900 uppercase">${dateStr}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            ${attendanceHtml}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            <div class="flex items-center justify-center gap-2">
                                <a href="${link}" class="inline-flex items-center justify-center p-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-sm text-xs font-bold uppercase gap-1" title="Buka Papan Pemuka">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    Buka
                                </a>
                                <button onclick="deleteProgram('${programData.id}', '${safeName}')" class="inline-flex items-center justify-center p-2 rounded-lg text-red-600 hover:bg-red-50 border border-red-200 transition-colors shadow-sm" title="Padam Program">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>`;

            } else {
                // --- LOGIC UNTUK TAB 'KEHADIRAN' (Default View) - DIKEMASKINI ---
                // Menggabungkan Nama, Tarikh dan Lokasi menjadi satu sel besar
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 align-top">${index + 1}.</td>
                        <td class="px-6 py-4 align-top">
                            <div class="text-sm font-bold text-gray-900 uppercase leading-snug mb-1">${name}</div>
                            
                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-xs text-gray-500 uppercase">
                                <span class="flex items-center gap-1">
                                    <svg class="w-3 h-3 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                    ${dateStr}
                                </span>
                                <span class="hidden sm:inline text-gray-300">|</span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-3 h-3 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    ${programData.location || 'DALAM TALIAN'}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            <span class="px-3 py-1 inline-flex text-[10px] leading-4 font-bold rounded-full bg-green-100 text-green-800 uppercase border border-green-200 shadow-sm items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                HADIR
                            </span>
                        </td>
                    </tr>`;
            }
        }

        // --- FUNGSI PADAM PROGRAM (DENGAN PENGESAHAN) ---
        window.deleteProgram = async function(docId, progName) {
            // Pengesahan sebelum memadam
            if (confirm(`AMARAN: Adakah anda pasti mahu memadam program "${progName}"?\n\nTindakan ini KEKAL dan akan memadam semua rekod kehadiran peserta untuk program ini. Teruskan?`)) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_programs`, docId));
                    
                    // Kemaskini senarai UI tanpa refresh
                    createdList = createdList.filter(item => item.programData.id !== docId);
                    filteredResults = filteredResults.filter(item => item.programData.id !== docId);
                    
                    renderTable();
                    alert("Program berjaya dipadam.");
                } catch (error) {
                    console.error("Gagal memadam:", error);
                    alert("Gagal memadam program. Sila cuba lagi.");
                }
            }
        }

        window.changePlannerMonth = function(offset) {
            currentPlannerDate.setMonth(currentPlannerDate.getMonth() + offset);
            renderPlannerList();
        }

        window.jumpToToday = function() {
            currentPlannerDate = new Date();
            renderPlannerList();
        }

        // --- NEW: RENDER PLANNER WITH NOTES & BIRTHDAYS ---
        window.renderPlannerList = function() {
            const date = currentPlannerDate;
            const month = date.getMonth();
            const year = date.getFullYear();
            const monthNames = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            document.getElementById('planner-month-year').textContent = `${monthNames[month]} ${year}`;
            
            const container = document.getElementById('planner-list-container');
            container.innerHTML = '';

            const plannerEvents = plannerList.filter(p => {
                const pDate = new Date(p.startDate);
                return pDate.getMonth() === month && pDate.getFullYear() === year;
            }).map(item => ({...item, type: 'planner', sortDate: new Date(item.startDate + 'T' + (item.startTime || '00:00'))}));

            const noteEvents = (dailyNotes || []).filter(n => {
                const nDate = new Date(n.date);
                return nDate.getMonth() === month && nDate.getFullYear() === year && n.content.trim() !== "";
            }).map(item => ({
                ...item, 
                type: 'note', 
                startDate: item.date, 
                title: 'NOTA HARIAN', 
                sortDate: new Date(item.date + 'T00:00')
            }));

            const birthdayEvents = (allBirthdays || []).filter(b => {
                if(!b.dob) return false;
                const bMonth = parseInt(b.dob.split('-')[1]) - 1;
                return bMonth === month;
            }).map(item => {
                const bDay = item.dob.split('-')[2];
                const constructedDate = `${year}-${String(month+1).padStart(2,'0')}-${bDay}`;
                return {
                    ...item,
                    type: 'birthday',
                    startDate: constructedDate,
                    title: `HARI JADI: ${item.name.toUpperCase()}`,
                    sortDate: new Date(constructedDate + 'T00:00')
                };
            });

            const combinedEvents = [...plannerEvents, ...noteEvents, ...birthdayEvents];
            combinedEvents.sort((a, b) => a.sortDate - b.sortDate);

            if (combinedEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 flex flex-col items-center justify-center opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="text-gray-500 text-sm italic">Tiada aktiviti, nota, atau sambutan bulan ini.</p>
                    </div>
                `;
            } else {
                const today = new Date();
                today.setHours(0,0,0,0);

                combinedEvents.forEach(ev => {
                    const eventDate = new Date(ev.startDate);
                    eventDate.setHours(0,0,0,0);
                    const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24)); 

                    let borderClass = '', iconType = '', onClickAction = '';
                    let dateBoxContent = `<span class="text-[10px] font-bold text-gray-500 uppercase">${eventDate.toLocaleDateString('ms-MY', {weekday:'short'}).toUpperCase()}</span><span class="text-2xl font-bold text-gray-800">${eventDate.getDate()}</span>`;

                    if (ev.type === 'planner') {
                        if (diffDays === 0) borderClass = 'border-l-4 border-l-green-500 bg-green-50/50';
                        else if (diffDays === 1) borderClass = 'border-l-4 border-l-blue-400 bg-blue-50/50';
                        else borderClass = 'border-l-4 border-l-teal-500 bg-white';
                        
                        iconType = `<h4 class="text-sm font-bold text-gray-800 uppercase truncate">${ev.title}</h4>
                                    <p class="text-xs text-teal-600 font-semibold uppercase">${ev.startTime || 'SEPANJANG HARI'}</p>`;
                        onClickAction = `onclick="showPlannerDetails(plannerList.find(p => p.id === '${ev.id}'))"`;
                    
                    } else if (ev.type === 'note') {
                        borderClass = 'border-l-4 border-l-amber-400 bg-amber-50 hover:bg-amber-100';
                        iconType = `<span class="bg-amber-200 text-amber-800 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase mb-1 inline-block">NOTA</span>
                                    <p class="text-xs text-gray-700 italic font-medium truncate">"${ev.content}"</p>`;
                        onClickAction = `onclick="selectedDateString='${ev.date}'; openDailyNoteModal()"`;
                    
                    } else if (ev.type === 'birthday') {
                        borderClass = 'border-l-4 border-l-pink-400 bg-pink-50 hover:bg-pink-100';
                        iconType = `<span class="bg-pink-200 text-pink-800 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase mb-1 inline-block">BIRTHDAY</span>
                                    <div class="flex items-center gap-1 text-xs font-bold text-pink-700 uppercase truncate">üéÇ ${ev.name}</div>`;
                        onClickAction = `onclick="window.open('birthday.html?name=${encodeURIComponent(ev.name)}&dob=${btoa(ev.dob)}', '_blank')"`;
                    }

                    const item = document.createElement('div');
                    item.className = `flex flex-row p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md cursor-pointer mb-3 ${borderClass}`;
                    item.setAttribute('onclick', onClickAction.replace('onclick="', '').slice(0, -1));
                    
                    item.innerHTML = `
                       <div class="flex flex-col items-center justify-center pr-3 border-r border-gray-200 min-w-[60px] bg-white/50 rounded-l">
                            ${dateBoxContent}
                       </div>
                       <div class="pl-3 flex-grow overflow-hidden flex flex-col justify-center">
                            ${iconType}
                       </div>
                    `;
                    container.appendChild(item);
                });
            }
            
            // Badge Notification
            const badge = document.getElementById('planner-badge');
            const now = new Date(); now.setHours(0,0,0,0);
            if (combinedEvents.some(p => p.sortDate >= now)) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        // --- GLOBAL FUNCTIONS EXPORT ---
        window.changePlannerMonth = (o) => { currentPlannerDate.setMonth(currentPlannerDate.getMonth() + o); renderPlannerList(); };
        window.jumpToToday = () => { currentPlannerDate = new Date(); renderPlannerList(); };
        window.openDailyNoteModal = () => document.getElementById('daily-note-modal').classList.remove('hidden');
        window.saveDailyNote = async () => {
            const content = document.getElementById('daily-note-content').value;
            await setDoc(doc(db, `artifacts/${appId}/public/data/spark_daily_notes`, `${currentUserIc}_${selectedDateString}`), { ic: currentUserIc, date: selectedDateString, content, updatedAt: serverTimestamp() }, { merge: true });
            document.getElementById('daily-note-modal').classList.add('hidden'); loadUserData(currentUserIc); // Reload to refresh list
        };
        window.showPlannerDetails = (ev) => {
             // Basic implementation - expand as needed
             alert(`Program: ${ev.title}\nLokasi: ${ev.location}\nNota: ${ev.notes}`);
        };
        // Add other necessary exports from previous code...
        window.switchTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('view-table').classList.add('hidden');
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-locked-task').classList.add('hidden');
            if (tab === 'planner') {
                document.getElementById('view-planner').classList.remove('hidden');
                renderPlannerList();
            } else if (tab === 'tasks') {
                document.getElementById('view-locked-task').classList.remove('hidden');
            } else {
                document.getElementById('view-table').classList.remove('hidden');
                filterTable();
            }
        };
        
        window.goToSijil = () => window.location.href = `sijil.html?ic=${currentUserIc}`;
        window.goToPersonalCalendar = () => window.location.href = `individukalendar.html?ic=${currentUserIc}`;
        window.goToOPR = () => window.location.href = `opr.html?ic=${currentUserIc}`;
        window.goToMemo = () => window.location.href = `memo.html?ic=${currentUserIc}`;
        window.goToMinitCurai = () => window.location.href = `minitcurai.html?ic=${currentUserIc}`;
        window.logout = () => { localStorage.removeItem('user_ic'); window.location.href = 'index.html'; };

        // Expose other functions as needed
        window.filterTable = filterTable;
        window.changeRowsPerPage = changeRowsPerPage;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.savePhoneNumber = savePhoneNumber;
        window.triggerProfileUpload = triggerProfileUpload;
        window.handleProfileImageUpload = handleProfileImageUpload;
        window.closeCropModal = closeCropModal;
        window.cropAndUpload = cropAndUpload;
        window.toggleQuickMenu = function() {
            const content = document.getElementById('quick-menu-content');
            const arrow = document.getElementById('menu-arrow');
            if (content.classList.contains('hidden')) { content.classList.remove('hidden'); arrow.style.transform = 'rotate(180deg)'; } 
            else { content.classList.add('hidden'); arrow.style.transform = 'rotate(0deg)'; }
        }
        window.saveQuickLink = saveQuickLink;
        window.deleteQuickLink = deleteQuickLink;
        window.openLinkModal = openLinkModal;
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.clickAddButton = clickAddButton;
        window.openPlannerModal = openPlannerModal;
        window.closePlannerModal = closePlannerModal;
        window.savePlannerActivity = savePlannerActivity;
        window.uploadImageToImgBB = uploadImageToImgBB;
        window.clearImage = clearImage;
        window.toggleDateRange = toggleDateRange;
        window.toggleMeetingMode = toggleMeetingMode;
        window.saveSector = saveSector;
        window.populateUnits = populateUnits;
        window.saveNonPPDUser = saveNonPPDUser;
        window.showSectorDropdowns = showSectorDropdowns;
        window.resetSectorModal = resetSectorModal;
        window.saveCurrentGroup = saveCurrentGroup;
        window.loadGroup = loadGroup;
        window.removeParticipant = removeParticipant;
        window.clearParticipants = clearParticipants;
        window.deleteProgram = deleteProgram;
        window.deleteDailyNote = deleteDailyNote;

    </script>
    
    <footer class="text-center py-4 mt-8 border-t border-gray-200 bg-white">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500">Versi 2.0 (Dikemaskini)</p>
    </footer>
</body>
</html>
