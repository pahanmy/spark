<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK ‚Äì Kalendar Peribadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; transition: background-color 0.5s ease; }
        .card { background-color: rgba(255, 255, 255, 0.95); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); backdrop-filter: blur(4px); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        
        .calendar-day { 
            min-height: 110px; max-height: 110px;
            display: flex; flex-direction: column; position: relative;
            transition: all 0.2s; cursor: pointer;
        }
        .calendar-day:hover { transform: translateY(-2px); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .event-list { overflow-y: auto; flex-grow: 1; z-index: 10; }
        
        /* Colors */
        .calendar-day.has-own { background-color: #ecfdf5; border: 1px solid #a7f3d0; } 
        .calendar-day.has-tagged { background-color: #f3e8ff; border: 1px solid #d8b4fe; } 
        .calendar-day.has-official { background-color: #eef2ff; border: 1px dashed #c7d2fe; opacity: 0.9; } 
        .calendar-day.has-birthdays { background-color: #fff1f2; border: 1px solid #fecdd3; } 
        .calendar-day.mixed-events { background-color: #f3f4f6; border: 1px solid #e5e7eb; }
        .calendar-day.selected { border-width: 2px; border-color: #0d9488; background-color: #ccfbf1; transform: scale(1.02); z-index: 20; shadow: lg; }
        .calendar-day.is-today { background-color: #fffbeb; border: 2px solid #f59e0b; }
        
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 50; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        
        .mission-item.completed span { text-decoration: line-through; color: #9ca3af; }
        .mission-item.completed { background-color: #f9fafb; border-color: #e5e7eb; opacity: 0.7; }
        .color-picker-wrapper { overflow: hidden; position: relative; }
        .color-picker-wrapper input[type="color"] { position: absolute; left: -100%; top: -100%; width: 300%; height: 300%; cursor: pointer; opacity: 0; }

        /* Animation for Quote */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .quote-container { animation: fadeIn 1s ease-out; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; display: block; }
        
        /* Dragging Cursor */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* Quote Hover Edit Icon */
        .quote-edit-icon { opacity: 0; transition: opacity 0.2s; }
        .quote-wrapper:hover .quote-edit-icon { opacity: 1; }
        
        /* Quick Links Styles */
        .quick-link-btn { transition: all 0.2s; }
        .quick-link-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* Emoji Bar */
        .emoji-bar { -ms-overflow-style: none; scrollbar-width: none; }
        .emoji-bar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body id="main-body" class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-teal-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-teal-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Ruang Aktiviti Peribadi</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="color-picker-wrapper btn bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-sm capitalize cursor-pointer relative overflow-hidden">
                    <input type="color" id="theme-color-input" onchange="changeTheme(this)" title="Pilih warna tema anda">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                    <span class="hidden sm:inline">Tema</span>
                </div>
                <button onclick="window.history.back()" class="btn bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-sm capitalize">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Kembali
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div id="personal-header" class="relative w-full h-48 md:h-64 mb-16 group mx-auto max-w-screen-2xl rounded-2xl shadow-xl select-none">
            
            <div class="absolute inset-0 rounded-2xl overflow-hidden bg-gray-200">
                <div id="personal-bg-img" class="absolute inset-0 bg-cover bg-center transition-transform duration-0" style="background-image: url('https://i.imgur.com/3utZGua.png');"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent pointer-events-none"></div>
                
                <div id="drag-instruction" class="absolute inset-0 flex items-center justify-center bg-black/40 text-white font-bold uppercase tracking-widest hidden z-10 pointer-events-none">
                    <span class="bg-black/50 px-4 py-2 rounded-lg border border-white/30 backdrop-blur-md">Drag untuk laraskan</span>
                </div>
            </div>

            <div id="pro-profile-container" class="hidden absolute -bottom-12 left-6 md:left-10 z-30 group-hover:scale-105 transition-transform duration-300">
                <img id="pro-profile-img" src="" class="w-32 h-32 md:w-40 md:h-40 rounded-full border-[6px] border-white shadow-2xl object-cover bg-gray-200">
                <div class="absolute bottom-2 right-2 bg-blue-600 text-white p-1 rounded-full shadow-md border-2 border-white" title="Verified Pro">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                </div>
            </div>

            <div id="user-info-text" class="absolute bottom-4 left-40 md:left-56 z-20 pl-2 transition-opacity">
                <h2 id="display-name" class="text-2xl md:text-4xl font-extrabold text-white shadow-black drop-shadow-md tracking-tight uppercase leading-none">USER</h2>
                <p class="text-xs md:text-sm text-gray-200 font-medium mt-1 shadow-black drop-shadow-sm">Selamat datang ke papan pemuka peribadi anda.</p>
            </div>

            <div class="absolute top-4 right-4 flex flex-col gap-2 z-30">
                
                <div id="normal-header-controls" class="flex flex-col gap-2 group-hover:opacity-100 opacity-0 translate-y-[-10px] group-hover:translate-y-0 transition-all duration-300">
                    
                    <button onclick="startReposition()" class="bg-black/30 hover:bg-black/50 backdrop-blur-md p-2.5 rounded-xl cursor-pointer text-white border border-white/20 shadow-lg flex items-center justify-end gap-2 w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                        <span class="text-xs font-bold hidden md:inline">Laraskan</span>
                    </button>

                    <label class="bg-black/30 hover:bg-black/50 backdrop-blur-md p-2.5 rounded-xl cursor-pointer text-white border border-white/20 shadow-lg flex items-center justify-end gap-2 w-full">
                        <input type="file" class="hidden" accept="image/*" onchange="uploadPersonalBg(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span class="text-xs font-bold hidden md:inline">Tukar Gambar</span>
                    </label>
                </div>

                <div id="edit-header-controls" class="hidden flex flex-col gap-2">
                    <button onclick="saveReposition()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg border border-white/20">SIMPAN</button>
                    <button onclick="cancelReposition()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg border border-white/20">BATAL</button>
                </div>

            </div>

            <div id="bg-upload-status" class="absolute top-28 right-4 text-xs font-bold text-white hidden bg-black/50 px-2 py-1 rounded z-30"></div>
        </div>

        <div class="mb-2 text-center quote-container px-4">
            <div class="relative max-w-4xl mx-auto quote-wrapper">
                <div class="flex items-center justify-center gap-2">
                    <h1 id="motivational-quote" contenteditable="true" onblur="saveQuote(this)" 
                        class="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-700 via-purple-700 to-pink-700 cursor-text outline-none break-words pb-1 italic leading-tight" 
                        placeholder="Klik untuk tulis kata semangat...">
                    </h1>
                    <div class="quote-edit-icon text-gray-400 cursor-pointer" onclick="document.getElementById('motivational-quote').focus()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8 text-center px-4 relative group/links">
            <div id="quick-links-container" class="flex flex-wrap justify-center gap-3 items-center min-h-[32px]">
                <span class="text-xs text-gray-300 italic">...</span>
            </div>
            
            <button onclick="openLinkModal()" class="mt-3 text-[10px] text-gray-400 hover:text-teal-600 font-bold uppercase tracking-wider opacity-0 group-hover/links:opacity-100 transition-opacity flex items-center justify-center gap-1 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Urus Pautan
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            
            <div class="lg:col-span-2">
                <div class="card p-4 mb-6 flex flex-col md:flex-row items-center gap-4">
                    <div class="flex gap-2 w-full md:w-auto shrink-0">
                        <select id="month-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5 cursor-pointer"></select>
                        <select id="year-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-24 p-2.5 cursor-pointer"></select>
                    </div>
                    <div class="w-full flex-grow">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/></svg></div>
                            <input type="text" id="search-input" class="block w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500" placeholder="Cari aktiviti...">
                        </div>
                    </div>
                    <div class="flex items-center w-full md:w-auto bg-indigo-50 px-3 py-2.5 rounded-lg border border-indigo-100 shrink-0">
                        <span class="mr-3 text-xs font-bold text-indigo-800 uppercase">Paparkan PPD?</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="ppd-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0"/>
                            <label for="ppd-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-6 text-center">
                    <div class="bg-teal-50 border border-teal-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-teal-600 uppercase">Ciptaan Saya</h4><p id="stat-own" class="text-xl font-extrabold text-teal-700">0</p></div>
                    <div class="bg-purple-50 border border-purple-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-purple-600 uppercase">Jemputan</h4><p id="stat-tagged" class="text-xl font-extrabold text-purple-700">0</p></div>
                    <div class="bg-pink-50 border border-pink-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-pink-600 uppercase">Birthday</h4><p id="stat-birthday" class="text-xl font-extrabold text-pink-700">0</p></div>
                    <div class="bg-indigo-50 border border-indigo-100 p-2 rounded-xl shadow-sm card"><h4 class="text-[9px] font-bold text-indigo-500 uppercase">Rasmi</h4><p id="stat-official" class="text-xl font-extrabold text-indigo-700">0</p></div>
                </div>

                <div class="card p-6 relative">
                    <div class="flex justify-between items-center mb-6">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <h2 id="calendar-header" class="text-xl font-extrabold text-gray-800 uppercase tracking-wide"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                    <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center font-bold text-xs text-gray-400 mb-3 uppercase tracking-wider">
                        <div>Ahad</div><div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div>Sabtu</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    <div class="mt-6 flex flex-wrap gap-4 text-[10px] font-bold uppercase justify-center text-gray-500">
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-teal-500"></span> Aktiviti Saya</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-purple-500"></span> Dijemput</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-pink-500"></span> Birthday</div>
                        <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-200 border border-amber-400"></span> Nota Harian</div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div class="card p-5 border border-purple-200 bg-purple-50 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-purple-100 rounded-full opacity-50"></div>
                    <h3 class="text-xs font-bold text-purple-800 uppercase mb-3 flex items-center gap-2 relative z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Senarai Semak Tugasan
                    </h3>
                    <div class="flex gap-2 mb-3 relative z-10">
                        <input type="text" id="new-mission-input" class="w-full text-xs p-2 rounded border border-purple-300 focus:outline-none focus:border-purple-600 bg-white" placeholder="Taip tugasan...">
                        <button onclick="addMission()" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded shadow-sm transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                    <div id="mission-list-container" class="space-y-2 max-h-[250px] overflow-y-auto custom-scrollbar pr-1 relative z-10">
                        <div class="text-center py-4 text-gray-400 text-[10px] italic">Memuatkan...</div>
                    </div>
                </div>

                <div id="program-list-container" class="h-[500px]">
                    <div class="card p-6 h-full flex flex-col border border-gray-200 shadow-lg">
                        <div class="border-b border-gray-100 pb-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-extrabold text-gray-800 uppercase tracking-tight">Agenda</h3>
                                <span id="selected-date-text" class="text-xs font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded-md uppercase">Hari Ini</span>
                            </div>
                            <button id="btn-add-activity" onclick="handleAddActivity()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg uppercase text-xs shadow-sm flex items-center justify-center gap-2 transition-transform active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                Tambah Aktiviti
                            </button>
                        </div>
                        <div id="program-list-content" class="space-y-3 overflow-y-auto flex-grow pr-2 custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-6 mt-8 bg-white/80 backdrop-blur border-t border-gray-200">
        <p class="text-sm text-gray-600 font-medium">Projek Inovasi SPARK oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-bold text-teal-600 hover:underline">Pahan</a></p>
        <p class="text-xs text-gray-400 mt-1">V2.5 | 2026 <span id="footer-user-ic"></span></p>
    </footer>

    <div id="link-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-900 mb-4 uppercase flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                Urus Pautan Pantas
            </h3>
            
            <div id="link-list-container" class="space-y-2 mb-6"></div>

            <form onsubmit="saveQuickLink(event)" id="add-link-form" class="border-t border-gray-100 pt-4">
                <p class="text-xs font-bold text-gray-500 uppercase mb-2">Tambah Baru (Max 5)</p>
                <div class="space-y-3">
                    <input type="text" id="link-name" class="w-full text-xs p-2 border rounded" placeholder="Nama Pautan (cth: Google)" required maxlength="10">
                    <input type="url" id="link-url" class="w-full text-xs p-2 border rounded" placeholder="URL (https://...)" required>
                    <select id="link-icon" class="w-full text-xs p-2 border rounded bg-white">
                        <option value="link">üîó Ikon Link</option>
                        <option value="google">üîç Google</option>
                        <option value="portal">üèõÔ∏è Portal Rasmi</option>
                        <option value="drive">üìÇ Google Drive</option>
                        <option value="youtube">‚ñ∂Ô∏è Youtube</option>
                        <option value="file">üìÑ Fail/Dokumen</option>
                        <option value="facebook">üì± Facebook</option>
                        <option value="whatsapp">üí¨ Whatsapp</option>
                    </select>
                    <button type="submit" id="btn-add-link" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded text-xs uppercase">Tambah</button>
                </div>
            </form>
            <button onclick="closeModal('link-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
    </div>

    <div id="daily-note-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-amber-100 rounded-lg shadow-2xl w-full max-w-sm p-0 overflow-hidden relative transform rotate-1 transition-transform hover:rotate-0 border-2 border-amber-200">
            <div class="bg-amber-200 px-4 py-2 border-b border-amber-300 flex justify-between items-center">
                <h3 id="note-modal-title" class="font-bold text-amber-800 uppercase text-sm">Nota Harian</h3>
                <button onclick="closeModal('daily-note-modal')" class="text-amber-800 hover:text-amber-900 font-bold">‚úï</button>
            </div>
            <div class="p-4">
                <textarea id="daily-note-content" class="w-full h-40 bg-amber-100 border-none focus:ring-0 text-gray-800 text-sm resize-none font-medium leading-relaxed" placeholder="Catat nota penting hari ini..."></textarea>
                
                <div class="flex gap-2 py-2 overflow-x-auto emoji-bar mb-2 border-b border-amber-200">
                    <button onclick="insertToNote('üòÄ')" class="text-lg hover:scale-110 transition">üòÄ</button>
                    <button onclick="insertToNote('üòÇ')" class="text-lg hover:scale-110 transition">üòÇ</button>
                    <button onclick="insertToNote('üòä')" class="text-lg hover:scale-110 transition">üòä</button>
                    <button onclick="insertToNote('üòç')" class="text-lg hover:scale-110 transition">üòç</button>
                    <button onclick="insertToNote('ü§î')" class="text-lg hover:scale-110 transition">ü§î</button>
                    <button onclick="insertToNote('üëç')" class="text-lg hover:scale-110 transition">üëç</button>
                    <button onclick="insertToNote('üôè')" class="text-lg hover:scale-110 transition">üôè</button>
                    <button onclick="insertToNote('üî•')" class="text-lg hover:scale-110 transition">üî•</button>
                    <button onclick="insertToNote('üìÖ')" class="text-lg hover:scale-110 transition">üìÖ</button>
                    <button onclick="insertToNote('‚ö†Ô∏è')" class="text-lg hover:scale-110 transition">‚ö†Ô∏è</button>
                    <button onclick="insertToNote('‚≠ê')" class="text-lg hover:scale-110 transition">‚≠ê</button>
                </div>

                <div class="flex gap-2 justify-between items-center">
                    <div class="flex gap-1">
                        <button onclick="insertToNote('‚úÖ ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded" title="Tanda">‚úÖ</button>
                        <button onclick="insertToNote('üìå ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded" title="Pin">üìå</button>
                        <button onclick="insertToNote(' - ')" class="text-xs bg-amber-200 hover:bg-amber-300 px-2 py-1 rounded font-bold" title="Point">List</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteDailyNote()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1.5 px-3 rounded shadow-sm">PADAM</button>
                        <button onclick="saveDailyNote()" id="btn-save-note" class="bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold py-1.5 px-4 rounded shadow-sm">SIMPAN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="planner-modal-form" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative m-4 max-h-[90vh] overflow-y-auto">
            <button onclick="closePlannerModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <h3 id="planner-modal-title" class="text-lg font-bold text-gray-800 mb-1 uppercase">Rancang Aktiviti</h3>
            <form onsubmit="savePlannerActivity(event)" class="space-y-4 mt-4">
                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nama Program</label><input type="text" id="plan-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase" required></div>
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center"><input id="is-one-day" type="checkbox" checked onchange="toggleDateRange()" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="is-one-day" class="ml-2 block text-xs font-bold text-gray-700 uppercase">Sehari Sahaja?</label></div>
                    <div class="flex items-center"><input id="is-public-program" type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="is-public-program" class="ml-2 block text-xs font-bold text-indigo-700 uppercase">Paparkan di Takwim Utama?</label></div>
                </div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Mula</label><input type="date" id="plan-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" required></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa</label><input type="time" id="plan-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" required></div></div>
                <div id="single-day-end-time" class="grid grid-cols-2 gap-4"><div></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tamat</label><input type="time" id="plan-end-time-single" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"></div></div>
                <div id="end-date-container" class="grid grid-cols-2 gap-4 hidden bg-gray-50 p-2 rounded border border-gray-200"><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh Tamat</label><input type="date" id="plan-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Tamat</label><input type="time" id="plan-end-time-multi" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"></div></div>
                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Lokasi</label><input type="text" id="plan-location" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm uppercase"></div>
                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Catatan</label><textarea id="plan-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"></textarea><div class="mt-2 p-2 border border-dashed border-gray-300 rounded bg-gray-50"><label class="block text-xs font-bold text-gray-600 uppercase mb-1">Muat Naik Gambar</label><input type="file" id="plan-image-file" accept="image/*" onchange="uploadImageToImgBB(this)" class="block w-full text-xs"><input type="hidden" id="plan-image-url"><div id="image-upload-status" class="text-xs text-gray-500 mt-1 italic"></div></div></div>
                <button type="submit" id="btn-save-plan" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 uppercase text-sm">Simpan Aktiviti</button>
            </form>
        </div>
    </div>

    <div id="sector-setup-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase">Lengkapkan Profil</h3>
            <p class="text-xs text-gray-500 mb-4">Sila pilih Sektor dan Unit anda sebelum menambah aktiviti.</p>
            <form onsubmit="saveSector(event)">
                <div class="mb-4"><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pilih Sektor</label><select id="user-sector-select" onchange="populateUnits(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md text-xs uppercase" required><option value="">-- PILIH SEKTOR --</option><option value="SEKTOR PERANCANGAN">SEKTOR PERANCANGAN</option><option value="SEKTOR PEMBELAJARAN">SEKTOR PEMBELAJARAN</option><option value="SEKTOR PENGURUSAN SEKOLAH">SEKTOR PENGURUSAN SEKOLAH</option><option value="SEKTOR PEMBANGUNAN MURID">SEKTOR PEMBANGUNAN MURID</option><option value="SEKTOR PENTAKSIRAN & PEPERIKSAAN">SEKTOR PENTAKSIRAN & PEPERIKSAAN</option><option value="SEKTOR PSIKOLOGI & KAUNSELING">SEKTOR PSIKOLOGI & KAUNSELING</option><option value="SEKTOR PENGURUSAN">SEKTOR PENGURUSAN</option><option value="BUKAN PPD">BUKAN PPD (SEKOLAH/LUAR)</option></select></div>
                <div id="unit-field-container" class="mb-4 hidden"><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pilih Unit</label><select id="user-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md text-xs uppercase" required><option value="">-- PILIH UNIT --</option></select></div>
                <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 uppercase text-sm">Simpan</button>
            </form>
        </div>
    </div>

    <div id="activity-info-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4 max-h-[90vh] overflow-y-auto relative border-t-4 border-teal-500">
            <button onclick="closeModal('activity-info-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div id="modal-tag-badge" class="mb-3"></div>
            <h3 id="modal-activity-title" class="text-xl font-extrabold text-gray-800 uppercase mb-4 leading-tight"></h3>
            <div class="space-y-4 text-sm text-gray-700">
                <div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Masa</p><p id="modal-activity-time" class="font-bold text-gray-800"></p></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Lokasi</p><p id="modal-activity-location" class="font-bold text-gray-800 truncate"></p></div></div>
                <div class="bg-teal-50 p-3 rounded-lg border border-teal-100"><p class="text-[10px] font-bold text-teal-600 uppercase mb-1">Peserta Terlibat</p><p id="modal-activity-participants" class="uppercase text-xs leading-relaxed font-medium text-teal-900"></p></div>
                <div id="modal-activity-notes-container" class="hidden"><p class="text-xs font-bold text-gray-400 uppercase mb-1">Catatan</p><div class="bg-yellow-50 p-3 rounded border border-yellow-100 text-xs text-gray-700 whitespace-pre-wrap" id="modal-activity-notes"></div></div>
                <div id="modal-activity-image-container" class="hidden mt-2"><p class="text-xs font-bold text-gray-400 uppercase mb-1">Lampiran</p><img id="modal-activity-image" src="" alt="Lampiran" class="w-full rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition-opacity" onclick="window.open(this.src)"></div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end space-x-3">
                 <a id="modal-activity-link" href="#" target="_blank" class="hidden btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg uppercase text-xs flex items-center shadow-md">Buka Pautan</a>
                <button onclick="closeModal('activity-info-modal')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 px-4 rounded-lg uppercase text-xs">Tutup</button>
            </div>
        </div>
    </div>

    <style>
        .toggle-checkbox { right: 20px; transition: all 0.3s; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, where, getDocs, doc, updateDoc, addDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        
        let officialPrograms = [], myActivities = [], allBirthdays = [], dailyNotes = [], userDocId = null;
        let currentDate = new Date(), selectedDateElement = null, isInitialLoad = true;
        let currentUserIc = "", showOfficial = false, selectedDateString = "";
        let currentUserSector = "", currentUserUnit = "";
        let quickLinks = []; // Store links
        
        // Reposition Logic Variables
        let isRepositioning = false;
        let isDragging = false;
        let startY = 0;
        let currentBgPosY = 50; 
        let tempBgPosY = 50; 

        const iconMap = {
            link: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>',
            google: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>',
            portal: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>',
            drive: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.01 1.985C8.791 1.985 5.572 1.985 2.353 1.985 4.102 4.965 5.85 7.945 7.599 10.925 10.428 10.925 13.257 10.925 16.086 10.925 14.337 7.945 12.589 4.965 10.84 1.985 11.23 1.985 11.62 1.985 12.01 1.985zM8.283 12.112C6.535 15.092 4.786 18.072 3.038 21.052 2.308 21.052 1.579 21.052 0.85 21.052 2.598 18.072 4.347 15.092 6.095 12.112 6.824 12.112 7.554 12.112 8.283 12.112zM17.457 12.112C19.206 15.092 20.954 18.072 22.703 21.052 16.098 21.052 9.492 21.052 2.887 21.052 4.636 18.072 6.384 15.092 8.133 12.112 11.241 12.112 14.349 12.112 17.457 12.112zM16.77 9.738C19.289 5.448 21.808 1.157 24.327-3.133L21.319-3.133C18.8 1.157 16.281 5.448 13.762 9.738 14.764 9.738 15.767 9.738 16.77 9.738z"/></svg>',
            youtube: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>',
            file: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>',
            facebook: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
            whatsapp: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>'
        };

        const sectorUnitData = { "SEKTOR PERANCANGAN": ["UNIT PERANCANGAN DAN PENGURUSAN PPD", "UNIT PENGURUSAN MAKLUMAT (ICT)", "UNIT DATA DAN MAKLUMAT"], "SEKTOR PEMBELAJARAN": ["UNIT BAHASA", "UNIT SAINS DAN MATEMATIK", "UNIT TVET", "UNIT SAINS SOSIAL & KEMANUSIAAN", "UNIT PENDIDIKAN ISLAM", "UNIT PENDIDIKAN KHAS", "UNIT PEMULIHAN KHAS", "UNIT SUMBER PENDIDIKAN"], "SEKTOR PEMBANGUNAN MURID": ["UNIT HAL EHWAL MURID", "UNIT PEMBANGUNAN BAKAT MURID"], "SEKTOR PENGURUSAN SEKOLAH": ["UNIT PENGUPAYAAN KEPIMPINAN SEKOLAH", "UNIT PRASEKOLAH & RENDAH","UNIT MENENGAH & TINGKATAN 6","UNIT SWASTA"], "SEKTOR PENTAKSIRAN & PEPERIKSAAN": ["UNIT PENTAKSIRAN & PEPERIKSAAN"], "SEKTOR PSIKOLOGI & KAUNSELING": ["UNIT PSIKOLOGI & KAUNSELING"], "SEKTOR PENGURUSAN": ["UNIT PENTADBIRAN DAN KUMPULAN SOKONGAN", "UNIT KEWANGAN DAN AKAUN", "UNIT INFRASTRUKTUR DAN PEROLEHAN", "UNIT ICT"], "BUKAN PPD": ["-"] };

        const urlParams = new URLSearchParams(window.location.search);
        const urlIc = urlParams.get('ic');
        if (urlIc) currentUserIc = urlIc; else currentUserIc = localStorage.getItem('user_ic');
        if(!currentUserIc) { alert("Sila log masuk semula."); window.location.href = 'index.html'; }

        onAuthStateChanged(auth, async (user) => {
            if (user) main();
            else { try { await signInAnonymously(auth); } catch (error) { console.error("Gagal daftar masuk:", error); } }
        });

        function main() {
            setupEventListeners();
            populateMonthFilter();
            initializeRightPanel();
            loadPersonalData(); 
            listenForOfficialPrograms();
            loadPersonalPlanner(); 
            listenForBirthdays();
            listenForMissions();
            listenForDailyNotes();
            setupDragEvents();
        }

        // --- QUICK LINKS LOGIC ---
        function renderQuickLinks() {
            const container = document.getElementById('quick-links-container');
            container.innerHTML = '';
            
            if (quickLinks && quickLinks.length > 0) {
                quickLinks.forEach(link => {
                    const iconSvg = iconMap[link.icon] || iconMap['link'];
                    const el = document.createElement('a');
                    el.href = link.url;
                    el.target = "_blank";
                    el.className = "quick-link-btn bg-white border border-gray-200 hover:border-teal-400 text-gray-700 hover:text-teal-700 px-3 py-1.5 rounded-full shadow-sm text-[10px] font-bold uppercase flex items-center gap-1.5 no-underline";
                    el.innerHTML = `${iconSvg} <span>${link.name}</span>`;
                    container.appendChild(el);
                });
            } else {
                container.innerHTML = '<span class="text-xs text-gray-300 italic">Tiada pautan pantas.</span>';
            }
        }

        function openLinkModal() {
            const modal = document.getElementById('link-modal');
            const listContainer = document.getElementById('link-list-container');
            const btnAdd = document.getElementById('btn-add-link');
            
            listContainer.innerHTML = '';
            
            if (quickLinks && quickLinks.length > 0) {
                quickLinks.forEach((link, index) => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100";
                    row.innerHTML = `<div class="flex items-center gap-2"><span class="text-gray-500">${iconMap[link.icon]}</span><span class="text-xs font-bold uppercase">${link.name}</span></div><button onclick="deleteQuickLink(${index})" class="text-red-400 hover:text-red-600 font-bold text-xs">PADAM</button>`;
                    listContainer.appendChild(row);
                });
            } else {
                listContainer.innerHTML = '<p class="text-xs text-gray-400 italic text-center">Tiada pautan disimpan.</p>';
            }

            if (quickLinks && quickLinks.length >= 5) {
                btnAdd.disabled = true;
                btnAdd.textContent = "Maksimum Dicapai (5)";
                btnAdd.classList.add('bg-gray-400');
                btnAdd.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            } else {
                btnAdd.disabled = false;
                btnAdd.textContent = "TAMBAH";
                btnAdd.classList.remove('bg-gray-400');
                btnAdd.classList.add('bg-teal-600', 'hover:bg-teal-700');
            }

            modal.classList.remove('hidden');
        }

        async function saveQuickLink(e) {
            e.preventDefault();
            const name = document.getElementById('link-name').value.trim().toUpperCase();
            const url = document.getElementById('link-url').value.trim();
            const icon = document.getElementById('link-icon').value;
            
            if(!name || !url || !userDocId) return;

            let currentLinks = quickLinks || [];
            if(currentLinks.length >= 5) { alert("Maksimum 5 pautan sahaja."); return; }

            const newLinks = [...currentLinks, { name, url, icon }];
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { quickLinks: newLinks });
                document.getElementById('add-link-form').reset();
                quickLinks = newLinks;
                renderQuickLinks();
                openLinkModal(); 
            } catch(e) { console.error(e); alert("Gagal."); }
        }

        async function deleteQuickLink(index) {
            if(!confirm("Padam pautan ini?")) return;
            const newLinks = quickLinks.filter((_, i) => i !== index);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { quickLinks: newLinks });
                quickLinks = newLinks;
                renderQuickLinks();
                openLinkModal();
            } catch(e) { console.error(e); }
        }


        // --- REPOSITION LOGIC ---
        function setupDragEvents() {
            const bgContainer = document.getElementById('personal-bg-img');
            
            // Mouse events
            bgContainer.addEventListener('mousedown', (e) => {
                if (!isRepositioning) return;
                isDragging = true;
                startY = e.clientY;
                bgContainer.classList.add('cursor-grabbing');
                bgContainer.classList.remove('cursor-grab');
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging || !isRepositioning) return;
                e.preventDefault();
                const deltaY = startY - e.clientY;
                let newPos = tempBgPosY + (deltaY * 0.2);
                if(newPos < 0) newPos = 0; if(newPos > 100) newPos = 100;
                document.getElementById('personal-bg-img').style.backgroundPosition = `center ${newPos}%`;
                startY = e.clientY;
                tempBgPosY = newPos;
            });

            window.addEventListener('mouseup', () => {
                if(isDragging) {
                    isDragging = false;
                    bgContainer.classList.remove('cursor-grabbing');
                    bgContainer.classList.add('cursor-grab');
                }
            });

            // Touch events for mobile
            bgContainer.addEventListener('touchstart', (e) => {
                if (!isRepositioning) return;
                isDragging = true;
                startY = e.touches[0].clientY;
            }, {passive: false});

            window.addEventListener('touchmove', (e) => {
                if (!isDragging || !isRepositioning) return;
                e.preventDefault(); 
                const deltaY = startY - e.touches[0].clientY;
                let newPos = tempBgPosY + (deltaY * 0.2);
                if(newPos < 0) newPos = 0; if(newPos > 100) newPos = 100;
                document.getElementById('personal-bg-img').style.backgroundPosition = `center ${newPos}%`;
                startY = e.touches[0].clientY;
                tempBgPosY = newPos;
            }, {passive: false});

            window.addEventListener('touchend', () => isDragging = false);
        }

        function startReposition() {
            isRepositioning = true;
            tempBgPosY = currentBgPosY; 
            document.getElementById('normal-header-controls').classList.add('hidden');
            document.getElementById('edit-header-controls').classList.remove('hidden');
            document.getElementById('user-info-text').classList.add('opacity-30'); 
            document.getElementById('personal-bg-img').classList.add('cursor-grab');
            document.getElementById('drag-instruction').classList.remove('hidden');
        }

        async function saveReposition() {
            if(!userDocId) return;
            currentBgPosY = tempBgPosY; 
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { personalBgPosition: currentBgPosY });
                endReposition();
            } catch(e) { console.error("Error saving pos", e); alert("Gagal simpan."); }
        }

        function cancelReposition() {
            document.getElementById('personal-bg-img').style.backgroundPosition = `center ${currentBgPosY}%`; 
            endReposition();
        }

        function endReposition() {
            isRepositioning = false;
            document.getElementById('normal-header-controls').classList.remove('hidden');
            document.getElementById('edit-header-controls').classList.add('hidden');
            document.getElementById('user-info-text').classList.remove('opacity-30');
            document.getElementById('personal-bg-img').classList.remove('cursor-grab', 'cursor-grabbing');
            document.getElementById('drag-instruction').classList.add('hidden');
        }

        async function loadPersonalData() {
            try {
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const q = query(usersRef, where("ic", "==", currentUserIc));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const data = docSnap.data();
                    userDocId = docSnap.id;
                    currentUserSector = data.sector;
                    currentUserUnit = data.unit;
                    
                    // Load Quick Links
                    quickLinks = data.quickLinks || [];
                    renderQuickLinks();

                    document.getElementById('display-name').textContent = data.name ? data.name.toUpperCase() : 'PENGGUNA';
                    if (data.personalBgUrl) document.getElementById('personal-bg-img').style.backgroundImage = `url('${data.personalBgUrl}')`;
                    if (data.themeColor) document.body.style.backgroundColor = data.themeColor;
                    
                    if (data.personalBgPosition !== undefined) {
                        currentBgPosY = data.personalBgPosition;
                        document.getElementById('personal-bg-img').style.backgroundPosition = `center ${currentBgPosY}%`;
                    } else {
                        currentBgPosY = 50; 
                        document.getElementById('personal-bg-img').style.backgroundPosition = `center 50%`;
                    }

                    if(data.motivationalQuote) document.getElementById('motivational-quote').textContent = data.motivationalQuote;
                    else document.getElementById('motivational-quote').textContent = "Jadikan hari ini lebih baik dari semalam.";

                    const adminIC = "890522135381";
                    if ((data.isPro === true) || (currentUserIc === adminIC)) {
                        if(data.profileImageUrl) {
                            document.getElementById('pro-profile-container').classList.remove('hidden');
                            document.getElementById('pro-profile-img').src = data.profileImageUrl;
                        }
                    }
                }
            } catch (error) { console.error("Error loading profile:", error); }
        }

        async function saveQuote(element) {
            const text = element.innerText.trim();
            if(!userDocId) return;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { motivationalQuote: text });
            } catch (e) { console.error("Gagal simpan quote", e); }
        }

        // --- LOCAL FUNCTIONS ---
        function changeTheme(input) {
            const color = input.value;
            document.body.style.backgroundColor = color;
            if (userDocId) {
                try { updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { themeColor: color }); } 
                catch (e) { console.error(e); }
            }
        }

        function listenForDailyNotes() {
            const q = query(collection(db, `artifacts/${appId}/public/data/spark_daily_notes`), where("ic", "==", currentUserIc));
            onSnapshot(q, (snapshot) => {
                dailyNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshView();
            }, (e) => console.warn("Note error", e));
        }

        function openDailyNoteModal() {
            const modal = document.getElementById('daily-note-modal');
            const textarea = document.getElementById('daily-note-content');
            const displayDate = new Date(selectedDateString).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
            document.getElementById('note-modal-title').textContent = `Nota: ${displayDate}`;
            const existingNote = dailyNotes.find(n => n.date === selectedDateString);
            textarea.value = existingNote ? existingNote.content : '';
            modal.classList.remove('hidden');
        }

        async function saveDailyNote() {
            const content = document.getElementById('daily-note-content').value;
            const btn = document.getElementById('btn-save-note');
            btn.textContent = "..."; btn.disabled = true;
            try {
                const noteId = `${currentUserIc}_${selectedDateString}`;
                await setDoc(doc(db, `artifacts/${appId}/public/data/spark_daily_notes`, noteId), { ic: currentUserIc, date: selectedDateString, content: content, updatedAt: serverTimestamp() }, { merge: true });
                closeModal('daily-note-modal');
            } catch(e) { console.error(e); alert("Gagal simpan."); }
            finally { btn.textContent = "SIMPAN"; btn.disabled = false; }
        }

        // NEW: DELETE FUNCTION
        async function deleteDailyNote() {
            if(!confirm("Adakah anda pasti mahu memadam nota ini?")) return;
            
            const btn = document.getElementById('btn-save-note'); // Just to disable during op
            
            try {
                const noteId = `${currentUserIc}_${selectedDateString}`;
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_daily_notes`, noteId));
                document.getElementById('daily-note-content').value = ""; // Clear text
                closeModal('daily-note-modal');
            } catch(e) {
                console.error("Error deleting note", e);
                // If doc doesn't exist, just clear UI and close
                document.getElementById('daily-note-content').value = "";
                closeModal('daily-note-modal');
            }
        }

        function insertToNote(text) {
            const textarea = document.getElementById('daily-note-content');
            textarea.setRangeText(text, textarea.selectionStart, textarea.selectionEnd, 'end');
            textarea.focus();
        }

        function listenForMissions() {
            const q = query(collection(db, `artifacts/${appId}/public/data/spark_personal_notes`), where("ic", "==", currentUserIc), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('mission-list-container'); container.innerHTML = '';
                if (snapshot.empty) { container.innerHTML = '<div class="text-center py-4 text-gray-400 text-[10px] italic">Tiada tugasan tertunggak.</div>'; return; }
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const div = document.createElement('div');
                    div.className = `mission-item flex items-center justify-between p-2 rounded bg-white border border-purple-200 shadow-sm transition-all ${m.isCompleted ? 'completed' : ''}`;
                    div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden"><input type="checkbox" ${m.isCompleted ? 'checked' : ''} onchange="toggleMission('${doc.id}', this.checked)" class="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500 cursor-pointer"><span class="text-xs text-gray-700 truncate font-medium uppercase">${m.text}</span></div><button onclick="deleteMission('${doc.id}')" class="text-gray-400 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
                    container.appendChild(div);
                });
            }, (error) => { console.warn("Misi error", error); });
        }
        
        async function addMission() { const input = document.getElementById('new-mission-input'); const text = input.value.trim(); if (!text) return; try { await addDoc(collection(db, `artifacts/${appId}/public/data/spark_personal_notes`), { ic: currentUserIc, text: text, isCompleted: false, createdAt: serverTimestamp() }); input.value = ''; } catch (e) { console.error(e); } }
        async function toggleMission(id, s) { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_personal_notes`, id), { isCompleted: s }); } catch (e) { console.error(e); } }
        async function deleteMission(id) { if(confirm("Padam tugasan ini?")) { try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_personal_notes`, id)); } catch(e) { console.error(e); } } }

        async function uploadPersonalBg(input) {
            const file = input.files[0]; if (!file) return;
            const stat = document.getElementById('bg-upload-status'); stat.textContent = "Memuat naik..."; stat.classList.remove('hidden');
            const fd = new FormData(); fd.append('image', file);
            try {
                const res = await fetch('https://api.imgbb.com/1/upload?key=a7c600ac733fe14649cacd8e65619c4b', { method: 'POST', body: fd });
                const d = await res.json();
                if (d.success) {
                    const url = d.data.url; document.getElementById('personal-bg-img').style.backgroundImage = `url('${url}')`;
                    currentBgPosY = 50;
                    document.getElementById('personal-bg-img').style.backgroundPosition = `center 50%`;
                    if (userDocId) { await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { personalBgUrl: url, personalBgPosition: 50 }); stat.textContent = "Disimpan!"; setTimeout(() => stat.classList.add('hidden'), 2000); }
                }
            } catch (e) { stat.textContent = "Gagal."; }
        }

        function openPlannerModal(dateStr) {
            if(!currentUserSector || !currentUserUnit) { document.getElementById('sector-setup-modal').classList.remove('hidden'); return; }
            const modal = document.getElementById('planner-modal-form');
            document.getElementById('plan-title').value = '';
            document.getElementById('plan-location').value = '';
            document.getElementById('plan-notes').value = '';
            document.getElementById('plan-start-date').value = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('plan-end-date').value = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('plan-start-time').value = '08:00';
            document.getElementById('plan-end-time-single').value = '17:00';
            document.getElementById('is-one-day').checked = true;
            toggleDateRange();
            modal.classList.remove('hidden');
        }
        function closePlannerModal() { document.getElementById('planner-modal-form').classList.add('hidden'); }
        
        async function savePlannerActivity(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-plan'); btn.disabled = true; btn.textContent = "Menyimpan...";
            const title = document.getElementById('plan-title').value.toUpperCase();
            const location = document.getElementById('plan-location').value.toUpperCase();
            const notes = document.getElementById('plan-notes').value;
            const isPublic = document.getElementById('is-public-program').checked;
            const imageUrl = document.getElementById('plan-image-url').value;
            const startDate = document.getElementById('plan-start-date').value;
            const startTime = document.getElementById('plan-start-time').value;
            const isOneDay = document.getElementById('is-one-day').checked;
            let endDate = startDate, endTime = document.getElementById('plan-end-time-single').value;
            if (!isOneDay) { endDate = document.getElementById('plan-end-date').value; endTime = document.getElementById('plan-end-time-multi').value; }
            try {
                const planData = { ic: currentUserIc, sector: currentUserSector, unit: currentUserUnit, title, startDate, startTime, endDate, endTime, isOneDay, location, imageUrl, participants: document.getElementById('display-name').textContent, taggedIcs: [], notes, isPublic: isPublic, createdAt: new Date() };
                await addDoc(collection(db, `artifacts/${appId}/public/data/spark_planner`), planData);
                alert("Aktiviti berjaya ditambah!"); closePlannerModal();
            } catch (error) { console.error(error); alert("Gagal menyimpan."); }
            finally { btn.disabled = false; btn.textContent = "SIMPAN AKTIVITI"; }
        }
        
        async function uploadImageToImgBB(input) {
            const file = input.files[0]; if(!file) return;
            const stat = document.getElementById('image-upload-status'); stat.textContent="Uploading...";
            const fd = new FormData(); fd.append('image', file);
            try { const res = await fetch('https://api.imgbb.com/1/upload?key=a7c600ac733fe14649cacd8e65619c4b', {method:'POST',body:fd}); const d = await res.json(); if(d.success) { document.getElementById('plan-image-url').value = d.data.url; stat.textContent="Uploaded!"; } } catch(e) { stat.textContent="Error."; }
        }
        
        function toggleDateRange() {
            const isOneDay = document.getElementById('is-one-day').checked;
            if (isOneDay) { document.getElementById('end-date-container').classList.add('hidden'); document.getElementById('single-day-end-time').classList.remove('hidden'); } 
            else { document.getElementById('end-date-container').classList.remove('hidden'); document.getElementById('single-day-end-time').classList.add('hidden'); }
        }
        
        async function saveSector(e) {
            e.preventDefault();
            const sector = document.getElementById('user-sector-select').value;
            const unit = document.getElementById('user-unit-select').value;
            if(!sector || !unit) return;
            try {
                if(userDocId) await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, userDocId), { sector, unit });
                currentUserSector = sector; currentUserUnit = unit;
                document.getElementById('sector-setup-modal').classList.add('hidden');
                openPlannerModal(selectedDateString);
            } catch(err) { alert("Gagal."); }
        }
        
        function populateUnits(sector) {
            const sel = document.getElementById('user-unit-select'); sel.innerHTML = '<option value="">-- PILIH UNIT --</option>';
            if(sector && sectorUnitData[sector]) {
                sectorUnitData[sector].forEach(u => { const o = document.createElement('option'); o.value=u; o.textContent=u; sel.appendChild(o); });
                document.getElementById('unit-field-container').classList.remove('hidden');
            }
        }

        // --- DATA LOADERS & RENDER ---
        function listenForOfficialPrograms() { const q = query(collection(db, `artifacts/${appId}/public/data/spark_programs`), orderBy("startDate", "asc")); onSnapshot(q, (snap) => { officialPrograms = snap.docs.map(d => ({ id: d.id, type: 'official', ...d.data() })); refreshView(); }, (e) => console.warn("Official prog error", e)); }
        function listenForBirthdays() { const q = query(collection(db, `artifacts/${appId}/public/data/spark_birthdays`), orderBy("dob", "asc")); onSnapshot(q, (snap) => { allBirthdays = snap.docs.map(d => ({ id: d.id, ...d.data() })); refreshView(); }, (e) => console.warn("Birthdays error", e)); }
        function loadPersonalPlanner() {
            const plannerRef = collection(db, `artifacts/${appId}/public/data/spark_planner`);
            const qOwn = query(plannerRef, where("ic", "==", currentUserIc));
            const qTagged = query(plannerRef, where("taggedIcs", "array-contains", currentUserIc));
            let ownData = [], taggedData = [];
            onSnapshot(qOwn, (snap) => { ownData = snap.docs.map(d => ({ id: d.id, type: 'own', ...d.data() })); mergeAndRefresh(); }, (e) => console.warn("Planner Error", e));
            onSnapshot(qTagged, (snap) => { taggedData = snap.docs.map(d => ({ id: d.id, type: 'tagged', ...d.data() })); mergeAndRefresh(); }, (e) => console.warn("Tagged Error", e));
            function mergeAndRefresh() { const map = new Map(); ownData.forEach(item => map.set(item.id, item)); taggedData.forEach(item => map.set(item.id, item)); myActivities = Array.from(map.values()); refreshView(); }
        }
        function refreshView() {
            const year = currentDate.getFullYear(); const month = currentDate.getMonth(); renderCalendar(year, month); updateMonthlyStats(year, month);
            if (isInitialLoad) { 
                const today = new Date(); const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                const todayEl = document.querySelector(`.calendar-day[data-date="${todayStr}"]`);
                if(todayEl) handleDateClick(todayStr, todayEl, false); else initializeRightPanel(); 
                isInitialLoad = false;
            } else if (selectedDateElement) { handleDateClick(selectedDateElement.dataset.date, selectedDateElement, false); }
        }
        
        // MODIFIED RENDER CALENDAR
        function renderCalendar(year, month) {
            const calendarGrid = document.getElementById('calendar-grid'); calendarGrid.innerHTML = '';
            document.getElementById('calendar-header').textContent = `${["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"][month]} ${year}`.toUpperCase();
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div class="border rounded-md bg-gray-50/50"></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day); const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const myEvents = getEventsForDate(myActivities, date); const birthdays = getBirthdaysForDate(date);
                let officials = showOfficial ? getEventsForDate(officialPrograms, date) : [];
                const hasNote = dailyNotes.some(n => n.date === dateString && n.content.trim() !== '');
                const isToday = new Date().toDateString() === date.toDateString();
                let dayClasses = 'calendar-day border rounded-md p-2 transition-all relative'; let eventHtml = ''; let indicatorsHtml = '';
                const hasOwn = myEvents.some(e => e.type === 'own'); const hasTagged = myEvents.some(e => e.type === 'tagged');
                if (hasOwn) dayClasses += ' has-own'; else if (hasTagged) dayClasses += ' has-tagged'; else if (birthdays.length > 0) dayClasses += ' has-birthdays'; else if (officials.length > 0) dayClasses += ' has-official'; else dayClasses += ' bg-white hover:bg-gray-50';
                if (isToday) dayClasses += ' is-today shadow-md';
                if (hasOwn) indicatorsHtml += `<div class="absolute top-1 right-1 bg-teal-500 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-sm ring-1 ring-white">${myEvents.filter(e=>e.type==='own').length}</div>`;
                if (hasTagged) indicatorsHtml += `<div class="absolute top-1 ${hasOwn ? 'right-6' : 'right-1'} bg-purple-500 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-sm ring-1 ring-white">${myEvents.filter(e=>e.type==='tagged').length}</div>`;
                
                if (hasNote) {
                    const note = dailyNotes.find(n => n.date === dateString);
                    const shortNote = note.content.length > 15 ? note.content.substring(0, 15) + '...' : note.content;
                     eventHtml += `<div class="bg-amber-100 text-amber-800 text-[9px] rounded px-1 truncate mb-0.5 border border-amber-200 font-medium">üìù ${shortNote}</div>`;
                }

                eventHtml += myEvents.map(p => `<div class="${p.type === 'own' ? 'bg-teal-100 text-teal-800' : 'bg-purple-100 text-purple-800'} text-[9px] rounded px-1 truncate mb-0.5 font-bold tracking-tight">${p.title.toUpperCase()}</div>`).join('');
                eventHtml += birthdays.map(b => `<div class="bg-pink-100 text-pink-800 text-[9px] rounded px-1 truncate mb-0.5">üéÇ ${b.name.split(' ')[0].toUpperCase()}</div>`).join('');
                eventHtml += officials.map(p => `<div class="bg-indigo-50 text-indigo-400 text-[9px] rounded px-1 truncate mb-0.5 italic border border-indigo-100">${p.name.toUpperCase()}</div>`).join('');
                
                // MODIFIED: Added ondblclick and set onclick to pass false
                calendarGrid.insertAdjacentHTML('beforeend', `<div class="${dayClasses}" data-date="${dateString}" onclick="handleDateClick('${dateString}', this, false)" ondblclick="openDailyNoteModal()">${indicatorsHtml}<div class="font-bold text-gray-700 text-xs mb-1 ml-4">${day}</div><div class="event-list">${eventHtml}</div></div>`);
            }
        }
        
        function handleDateClick(dateStr, element, shouldOpenModal = true) {
            const date = parseDateString(dateStr);
            displayProgramsForDate(date, element);
            if (shouldOpenModal) openDailyNoteModal();
        }

        function handleAddActivity() {
            openPlannerModal(selectedDateString);
        }

        function displayProgramsForDate(date, element) {
            if (selectedDateElement) selectedDateElement.classList.remove('selected'); selectedDateElement = element; selectedDateElement.classList.add('selected');
            selectedDateString = element.dataset.date;
            const content = document.getElementById('program-list-content'); const term = document.getElementById('search-input').value.toLowerCase(); let fullHtml = '';
            document.getElementById('selected-date-text').textContent = date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase();
            
            const noteForDay = dailyNotes.find(n => n.date === selectedDateString);
            if (noteForDay && noteForDay.content) {
                fullHtml += `<div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r-lg shadow-sm mb-4">
                    <h4 class="text-xs font-bold text-amber-700 uppercase mb-1 flex justify-between">
                        <span>Nota Harian</span>
                        <button onclick="openDailyNoteModal()" class="text-[9px] underline text-amber-600 hover:text-amber-800">Edit</button>
                    </h4>
                    <p class="text-xs text-gray-700 whitespace-pre-wrap font-medium">${noteForDay.content}</p>
                </div>`;
            }

            document.getElementById('btn-add-activity').onclick = () => openPlannerModal(selectedDateString);
            const birthdays = getBirthdaysForDate(date);
            if (birthdays.length > 0) fullHtml += `<h4 class="text-xs font-bold text-pink-400 uppercase tracking-wider mb-2">Hari Jadi Staf</h4><div class="space-y-3 mb-6">` + birthdays.map(b => `<div class="bg-pink-50 border border-pink-200 rounded-xl p-3 text-gray-800 flex items-center justify-between shadow-sm"><div class="flex items-center gap-3 overflow-hidden"><span class="text-xl">üéÇ</span><div class="truncate"><p class="font-bold text-xs text-pink-700 truncate uppercase">${b.name}</p></div></div><a href="birthday.html?name=${encodeURIComponent(b.name)}&dob=${btoa(b.dob)}" target="_blank" class="flex-shrink-0 bg-pink-500 hover:bg-pink-600 text-white text-[9px] font-bold py-1.5 px-3 rounded-lg uppercase transition-colors">Ucap</a></div>`).join('') + '</div>';
            const myEvents = getEventsForDate(myActivities, date).filter(p => p.title.toLowerCase().includes(term));
            if (myEvents.length > 0) fullHtml += `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Aktiviti Saya</h4><div class="space-y-3 mb-6">` + myEvents.map(a => `<div class="bg-white border-l-4 ${a.type==='own'?'border-teal-500':'border-purple-500'} shadow-sm rounded-r-lg p-3 group hover:shadow-md transition-shadow"><div class="flex justify-between items-start mb-1"><p class="font-bold text-sm ${a.type==='own'?'text-teal-900':'text-purple-900'} uppercase leading-tight">${a.title.toUpperCase()}</p>${a.type==='own'?'<span class="bg-teal-100 text-teal-700 text-[9px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Saya</span>':'<span class="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Dijemput</span>'}</div><div class="text-xs text-gray-500 mt-1 space-y-0.5"><p class="flex items-center gap-1.5">üìç ${a.location.toUpperCase()}</p><p class="flex items-center gap-1.5">üïí ${a.startTime}</p></div><button onclick="openActivityModal('${encodeURIComponent(JSON.stringify(a))}')" class="mt-2 w-full text-center text-[10px] text-gray-400 font-bold uppercase hover:text-teal-600 transition-colors border-t border-gray-100 pt-1">Lihat Butiran</button></div>`).join('') + '</div>';
            if (showOfficial) { const officials = getEventsForDate(officialPrograms, date).filter(p => p.name.toLowerCase().includes(term)); if (officials.length > 0) fullHtml += `<h4 class="text-xs font-bold text-indigo-300 uppercase tracking-wider mb-2">Program Rasmi PPD</h4><div class="space-y-2 opacity-80">` + officials.map(p => `<div class="bg-indigo-50 border border-indigo-100 rounded-lg p-2 text-gray-600"><p class="font-bold text-xs text-indigo-700 uppercase leading-tight">${p.name.toUpperCase()}</p><div class="text-[10px] mt-1 flex justify-between text-indigo-400"><span>${p.location.toUpperCase()}</span><span>${p.startTime}</span></div></div>`).join('') + '</div>'; }
            if (fullHtml === '') content.innerHTML = `<div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center text-gray-400 h-full flex flex-col justify-center items-center"><p class="text-sm font-semibold">Tiada aktiviti.</p></div>`; else content.innerHTML = fullHtml;
        }
        
        function openActivityModal(dataString) {
            try {
                const data = JSON.parse(decodeURIComponent(dataString));
                const isOwn = data.type === 'own';
                
                const badgeEl = document.getElementById('modal-tag-badge');
                if(isOwn) badgeEl.innerHTML = '<span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded font-bold uppercase border border-teal-200">Aktiviti Saya</span>';
                else badgeEl.innerHTML = '<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded font-bold uppercase border border-purple-200">Dijemput / Di-Tag</span>';

                document.getElementById('modal-activity-title').textContent = data.title;
                document.getElementById('modal-activity-time').textContent = `üïí ${data.startTime} - ${data.endTime || '...'}`;
                document.getElementById('modal-activity-location').textContent = `üìç ${data.location}`;
                document.getElementById('modal-activity-participants').textContent = data.participants || '-';
                
                const noteContainer = document.getElementById('modal-activity-notes-container');
                if (data.notes) {
                    document.getElementById('modal-activity-notes').textContent = data.notes;
                    noteContainer.classList.remove('hidden');
                } else {
                    noteContainer.classList.add('hidden');
                }

                const imgContainer = document.getElementById('modal-activity-image-container');
                const imgEl = document.getElementById('modal-activity-image');
                if(data.imageUrl) {
                    imgEl.src = data.imageUrl;
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }
                
                const linkBtn = document.getElementById('modal-activity-link');
                if(data.link) {
                    linkBtn.href = data.link;
                    linkBtn.classList.remove('hidden');
                } else {
                    linkBtn.classList.add('hidden');
                }

                document.getElementById('activity-info-modal').classList.remove('hidden');
            } catch (e) {
                console.error("Error opening modal", e);
            }
        }

        function parseDateString(s) { const p = s.split('-'); return new Date(p[0], p[1]-1, p[2]); }
        function getEventsForDate(l, d) { const t = new Date(d.getFullYear(), d.getMonth(), d.getDate()); return l.filter(p => { const s = parseDateString(p.startDate); const e = p.endDate ? parseDateString(p.endDate) : s; return t >= s && t <= e; }); }
        function getBirthdaysForDate(d) { return allBirthdays.filter(b => b.dob && parseInt(b.dob.split('-')[1]) === d.getMonth()+1 && parseInt(b.dob.split('-')[2]) === d.getDate()); }
        function updateMonthlyStats(y, m) {
            let o=0, t=0, off=0, b=0; const f = new Date(y, m, 1); const l = new Date(y, m+1, 0);
            myActivities.forEach(p => { const d = parseDateString(p.startDate); if (d >= f && d <= l) { if(p.type === 'own') o++; else t++; } });
            officialPrograms.forEach(p => { if (parseDateString(p.startDate) >= f && parseDateString(p.startDate) <= l) off++; });
            allBirthdays.forEach(x => { if(x.dob && (parseInt(x.dob.split('-')[1])-1) === m) b++; });
            document.getElementById('stat-own').textContent=o; document.getElementById('stat-tagged').textContent=t; document.getElementById('stat-official').textContent=off; document.getElementById('stat-birthday').textContent=b;
        }
        function setupEventListeners() {
            document.getElementById('month-select').addEventListener('change', updateCalendarView);
            document.getElementById('year-select').addEventListener('change', updateCalendarView);
            document.getElementById('search-input').addEventListener('input', () => refreshView());
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
            document.getElementById('ppd-toggle').addEventListener('change', (e) => { showOfficial = e.target.checked; refreshView(); });
        }
        function initializeRightPanel() { document.getElementById('program-list-content').innerHTML = `<div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center text-gray-400 h-full flex flex-col justify-center items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="text-sm font-semibold">Pilih tarikh untuk lihat agenda.</p></div>`; selectedDateString = new Date().toISOString().split('T')[0]; document.getElementById('btn-add-activity').onclick = () => openPlannerModal(selectedDateString); }
        function populateMonthFilter() { const m = document.getElementById('month-select'); m.innerHTML=''; ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"].forEach((month, i) => { const o=document.createElement('option'); o.value=i; o.textContent=month; if(i===currentDate.getMonth()) o.selected=true; m.appendChild(o); }); populateYearFilter(); }
        function populateYearFilter() { const y = document.getElementById('year-select'); y.innerHTML=''; const c = new Date().getFullYear(); for(let i=c-2; i<=c+2; i++) { const o=document.createElement('option'); o.value=i; o.textContent=i; if(i===currentDate.getFullYear()) o.selected=true; y.appendChild(o); } }
        function updateCalendarView() { currentDate = new Date(parseInt(document.getElementById('year-select').value), parseInt(document.getElementById('month-select').value), 1); refreshView(); }
        function changeMonth(o) { currentDate.setMonth(currentDate.getMonth()+o); document.getElementById('month-select').value=currentDate.getMonth(); document.getElementById('year-select').value=currentDate.getFullYear(); if(document.getElementById('year-select').value==="") { populateYearFilter(); document.getElementById('year-select').value=currentDate.getFullYear(); } refreshView(); }

        // --- EXPORT ALL FUNCTIONS TO WINDOW ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openActivityModal = openActivityModal;
        window.uploadPersonalBg = uploadPersonalBg;
        window.addMission = addMission;
        window.deleteMission = deleteMission;
        window.toggleMission = toggleMission;
        window.openPlannerModal = openPlannerModal;
        window.closePlannerModal = closePlannerModal;
        window.savePlannerActivity = savePlannerActivity;
        window.uploadImageToImgBB = uploadImageToImgBB;
        window.toggleDateRange = toggleDateRange;
        window.saveSector = saveSector;
        window.populateUnits = populateUnits;
        window.changeTheme = changeTheme;
        window.openDailyNoteModal = openDailyNoteModal;
        window.saveDailyNote = saveDailyNote;
        window.insertToNote = insertToNote;
        window.handleDateClick = handleDateClick; 
        window.handleAddActivity = handleAddActivity;
        window.saveQuote = saveQuote;
        window.deleteDailyNote = deleteDailyNote;
        
        // Export reposition functions
        window.startReposition = startReposition;
        window.saveReposition = saveReposition;
        window.cancelReposition = cancelReposition;
        
        // Quick Link Exports
        window.openLinkModal = openLinkModal;
        window.saveQuickLink = saveQuickLink;
        window.deleteQuickLink = deleteQuickLink;

    </script>
</body>
</html>
