<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Data: Kajian Keperluan SPARK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; } /* Slate-900 */
        .card {
            background: rgba(30, 41, 59, 0.7); /* Slate-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }
        .text-gradient {
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .stat-value { font-family: 'Outfit', sans-serif; font-weight: 800; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="loading" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <p class="text-blue-400 animate-pulse font-bold tracking-widest uppercase">Menganalisis Data Kajian...</p>
    </div>

    <header class="mb-10 text-center">
        <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.3em] mb-2">Laporan Analisis Keperluan</p>
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">JUSTIFIKASI <span class="text-gradient">SPARK</span></h1>
        <p class="text-slate-400 max-w-2xl mx-auto">Visualisasi data daripada <span id="total-respondents" class="text-white font-bold">0</span> responden mengenai ketidakcekapan sistem sedia ada dan permintaan terhadap solusi digital.</p>
    </header>

    <main class="max-w-7xl mx-auto space-y-8">

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card p-6 text-center border-t-4 border-red-500">
                <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Kesukaran Sistem Lama</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-burden">0%</h3>
                <p class="text-xs text-red-400 mt-1">Merasa Terbeban</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-yellow-500">
                <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Isu Integriti Data</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-manual-issues">0%</h3>
                <p class="text-xs text-yellow-400 mt-1">Melaporkan Ralat/Hilang</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-blue-500">
                <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Anggaran Masa Terbazir</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-hours-wasted">0</h3>
                <p class="text-xs text-blue-400 mt-1">Jam (Data Entry Manual)</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-green-500 bg-green-900/20">
                <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Sokongan SPARK</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-support">0%</h3>
                <p class="text-xs text-green-400 mt-1">Bersetuju Bertukar</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-white uppercase">Analisis "Pain Points"</h3>
                    <span class="bg-red-500/20 text-red-300 text-xs font-bold px-2 py-1 rounded">Masalah Kritikal</span>
                </div>
                <div class="chart-container">
                    <canvas id="issuesChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-4 text-center italic">Responden memilih masalah yang sering dihadapi dengan kaedah manual & Google Form.</p>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-white uppercase">Jurang Kecekapan Masa</h3>
                    <span class="bg-blue-500/20 text-blue-300 text-xs font-bold px-2 py-1 rounded">Setup + Entry</span>
                </div>
                <div class="chart-container">
                    <canvas id="timeComparisonChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-4 text-center italic">Perbandingan masa penyediaan & pemprosesan data (Manual vs SPARK).</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-white uppercase mb-6">Ciri-Ciri Paling Dikehendaki</h3>
                <div class="chart-container">
                    <canvas id="wishlistChart"></canvas>
                </div>
            </div>

            <div class="card p-6 flex flex-col items-center justify-center text-center">
                <h3 class="text-lg font-bold text-white uppercase mb-4">Kesediaan Berubah</h3>
                <div style="height: 200px; width: 200px; position: relative;">
                    <canvas id="supportChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                        <span class="text-3xl font-bold text-white" id="support-percent-center">0%</span>
                        <span class="text-[10px] uppercase text-slate-400">Sokong</span>
                    </div>
                </div>
                <div class="mt-6 text-sm text-slate-300 px-4">
                    <p>"Majoriti responden bersetuju sistem SPARK diperlukan segera untuk menggantikan kaedah lama."</p>
                </div>
            </div>
        </div>

        <div class="card p-8">
            <h3 class="text-lg font-bold text-white uppercase mb-6 border-b border-slate-700 pb-2">Suara Akar Umbi (Cadangan & Komen)</h3>
            <div id="comments-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                </div>
        </div>

    </main>

    <footer class="text-center py-8 text-slate-500 text-xs">
        Data dijana secara masa nyata daripada Pangkalan Data Firebase SPARK.
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Setup Chart.js Defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Helper Functions
        const countOccurrences = (arr) => arr.reduce((acc, curr) => (acc[curr] = (acc[curr] || 0) + 1, acc), {});

        async function initDashboard() {
            try {
                // 1. Fetch Data dari Collection "spark_needs_survey"
                const snapshot = await getDocs(collection(db, "spark_needs_survey"));
                const data = snapshot.docs.map(doc => doc.data());
                
                const total = data.length;
                document.getElementById('total-respondents').textContent = total;

                if (total === 0) {
                    alert("Tiada data kajian ditemui.");
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                // 2. Data Processing Vars
                let manualIssuesCount = {};
                let gformIssuesCount = {};
                let wishlistCount = {};
                let totalSetupTimeIndex = 0; // Simplified scoring for time
                let totalEntryTimeIndex = 0;
                let highBurdenCount = 0; // Scale 4-5
                let yesSupportCount = 0;
                let manualIssuesTotal = 0;

                // Time mapping for scoring (rough estimate in minutes for calc)
                // Q5 Setup: 5-10m(7.5), 10-20m(15), 20-30m(25), 30-60m(45), >1h(60)
                const setupMap = { "5-10m": 7.5, "10-20m": 15, "20-30m": 25, "30-60m": 45, ">1h": 60 };
                // Q6 Data Entry: 0(0), 10-20m(15), >30m(30) - Conservative estimates
                const entryMap = { "0": 0, "10-20m": 15, ">30m": 30 };

                let totalHoursWasted = 0;

                data.forEach(d => {
                    // Count Issues
                    if(d.manualIssues) d.manualIssues.forEach(i => { manualIssuesCount[i] = (manualIssuesCount[i]||0)+1; manualIssuesTotal++; });
                    if(d.gformIssues) d.gformIssues.forEach(i => gformIssuesCount[i] = (gformIssuesCount[i]||0)+1);
                    if(d.wishlist) d.wishlist.forEach(i => wishlistCount[i] = (wishlistCount[i]||0)+1);

                    // Calc Time Wasted
                    const sTime = setupMap[d.setupTime] || 5; 
                    const eTime = entryMap[d.dataEntryTime] || 0;
                    totalHoursWasted += (sTime + eTime);

                    // Burden
                    if(parseInt(d.burdenScale) >= 4) highBurdenCount++;

                    // Support
                    if(d.willingness === 'Ya') yesSupportCount++;
                });

                // 3. Update Hero Stats
                const burdenPercent = Math.round((highBurdenCount / total) * 100);
                const supportPercent = Math.round((yesSupportCount / total) * 100);
                const integrityIssuePercent = Math.round((manualIssuesTotal / (total * 2)) * 100); // Rough estimate normalized

                animateValue("stat-burden", 0, burdenPercent, "%");
                animateValue("stat-support", 0, supportPercent, "%");
                animateValue("stat-manual-issues", 0, integrityIssuePercent > 100 ? 98 : integrityIssuePercent, "%");
                animateValue("stat-hours-wasted", 0, Math.round(totalHoursWasted / 60), ""); // Convert mins to hours

                // 4. Render Charts
                renderIssuesChart(manualIssuesCount, gformIssuesCount);
                renderTimeChart(data); // Pass full data for distribution
                renderWishlistChart(wishlistCount);
                renderSupportChart(yesSupportCount, total - yesSupportCount);
                
                // 5. Render Comments
                renderComments(data);

                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Ralat memuatkan data.</p>`;
            }
        }

        // --- CHART FUNCTIONS ---

        function renderIssuesChart(manual, gform) {
            const ctx = document.getElementById('issuesChart').getContext('2d');
            
            // Combine top 5 issues
            const labels = ["Tulisan Buruk", "Nama Tak Lengkap", "Kerja Berulang", "Peserta Keliru", "Analisis Manual"];
            const data = [
                manual["Tulisan Buruk"] || 0,
                manual["Nama Tak Lengkap"] || 0,
                gform["Kerja Berulang"] || 0,
                gform["Peserta Keliru"] || 0,
                gform["Analisis Manual"] || 0
            ];

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bil. Responden',
                        data: data,
                        backgroundColor: ['#ef4444', '#ef4444', '#f59e0b', '#f59e0b', '#f59e0b'],
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', anchor: 'end', align: 'end' }
                    },
                    scales: {
                        x: { grid: { color: '#334155' } },
                        y: { grid: { display: false }, ticks: { color: 'white' } }
                    }
                }
            });
        }

        function renderTimeChart(data) {
            // Count Frequency of Setup Times
            const setupCounts = { "<20m": 0, "20-60m": 0, ">1h": 0 };
            
            data.forEach(d => {
                if (d.setupTime === "5-10m" || d.setupTime === "10-20m") setupCounts["<20m"]++;
                else if (d.setupTime === ">1h") setupCounts[">1h"]++;
                else setupCounts["20-60m"]++;
            });

            const ctx = document.getElementById('timeComparisonChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cepat (<20m)', 'Sederhana (20-60m)', 'Lama (>1 Jam)'],
                    datasets: [{
                        data: [setupCounts["<20m"], setupCounts["20-60m"], setupCounts[">1h"]],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: 'white' } },
                        datalabels: { color: 'white', formatter: (val, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (val*100 / sum).toFixed(0)+"%";
                            return percentage;
                        }}
                    }
                }
            });
        }

        function renderWishlistChart(counts) {
            const ctx = document.getElementById('wishlistChart').getContext('2d');
            
            const labels = Object.keys(counts);
            const data = Object.values(counts);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Permintaan',
                        data: data,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', anchor: 'end', align: 'end' }
                    },
                    scales: {
                        y: { grid: { color: '#334155' } },
                        x: { grid: { display: false }, ticks: { color: 'white' } }
                    }
                }
            });
        }

        function renderSupportChart(yes, no) {
            const ctx = document.getElementById('supportChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sokong', 'Tidak'],
                    datasets: [{
                        data: [yes, no],
                        backgroundColor: ['#22c55e', '#475569'],
                        borderWidth: 0,
                        cutout: '80%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { display: false } }
                }
            });
            document.getElementById('support-percent-center').textContent = Math.round((yes/(yes+no))*100) + "%";
        }

        function renderComments(data) {
            const container = document.getElementById('comments-container');
            const validComments = data.filter(d => d.comment && d.comment.length > 5).slice(0, 15);
            
            if(validComments.length === 0) {
                container.innerHTML = `<p class="text-slate-500 italic col-span-3 text-center">Tiada ulasan lagi.</p>`;
                return;
            }

            container.innerHTML = validComments.map(d => `
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <p class="text-slate-300 text-xs italic mb-2">"${d.comment}"</p>
                    <p class="text-[10px] text-blue-400 font-bold uppercase">- ${d.name || 'Responden'}, ${d.station || ''}</p>
                </div>
            `).join('');
        }

        function animateValue(id, start, end, suffix) {
            const obj = document.getElementById(id);
            let current = start;
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(2000 / range));
            
            if (range === 0) { obj.innerHTML = end + suffix; return; }

            const timer = setInterval(() => {
                current += increment;
                obj.innerHTML = current + suffix;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        initDashboard();
    </script>
</body>
</html>
