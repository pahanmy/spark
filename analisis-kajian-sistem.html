<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Data: Kajian Keperluan SPARK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; } /* Slate-900 */
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }
        .text-gradient {
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .stat-value { font-family: 'Outfit', sans-serif; font-weight: 800; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="loading" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <p class="text-blue-400 animate-pulse font-bold tracking-widest uppercase text-sm">Menjana Analisis Data...</p>
    </div>

    <header class="mb-10 text-center">
        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mb-2">Laporan Kajian Keperluan</p>
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">JUSTIFIKASI <span class="text-gradient">SPARK</span></h1>
        <p class="text-slate-400 text-sm max-w-2xl mx-auto">Analisis kuantitatif daripada <span id="total-respondents" class="text-white font-bold text-lg">0</span> responden membuktikan keperluan mendesak transformasi digital.</p>
    </header>

    <main class="max-w-7xl mx-auto space-y-8">

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card p-6 text-center border-t-4 border-red-500 hover:bg-slate-800 transition">
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Beban Kerja Kritikal</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-burden">0%</h3>
                <p class="text-[10px] text-red-400 mt-1 uppercase font-bold">Skala 4-5 (Sangat Terbeban)</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-blue-500 hover:bg-slate-800 transition">
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Masa Produktiviti Hilang</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-hours-wasted">0</h3>
                <p class="text-[10px] text-blue-400 mt-1 uppercase font-bold">Jam (Berdasarkan Responden)</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-yellow-500 hover:bg-slate-800 transition">
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Isu Data Manual</p>
                <h3 class="text-4xl stat-value text-white mt-2" id="stat-manual-issues">0%</h3>
                <p class="text-[10px] text-yellow-400 mt-1 uppercase font-bold">Melaporkan Ralat/Hilang</p>
            </div>
            <div class="card p-6 text-center border-t-4 border-green-500 bg-green-900/10 hover:bg-slate-800 transition">
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Kesediaan Berubah</p>
                <h3 class="text-4xl stat-value text-green-400 mt-2" id="stat-support">0%</h3>
                <p class="text-[10px] text-green-600 mt-1 uppercase font-bold">Menyokong Penuh SPARK</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold text-white uppercase tracking-wide">Analisis "Pain Points"</h3>
                    <span class="bg-red-500/20 text-red-300 text-[10px] font-bold px-2 py-1 rounded">Masalah Kritikal</span>
                </div>
                <div class="chart-container">
                    <canvas id="issuesChart"></canvas>
                </div>
                <p class="text-[10px] text-slate-500 mt-4 text-center">Data menunjukkan masalah utama kaedah manual & Google Form.</p>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold text-white uppercase tracking-wide">Taburan Masa Setup</h3>
                    <span class="bg-blue-500/20 text-blue-300 text-[10px] font-bold px-2 py-1 rounded">Ketidakcekapan</span>
                </div>
                <div class="chart-container">
                    <canvas id="timeComparisonChart"></canvas>
                </div>
                <p class="text-[10px] text-slate-500 mt-4 text-center">Peratusan masa yang diambil untuk menyediakan sistem kehadiran manual.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-sm font-bold text-white uppercase mb-6 tracking-wide">Ciri-Ciri Paling Dikehendaki Pengguna</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="wishlistChart"></canvas>
                </div>
            </div>

            <div class="card p-0 overflow-hidden flex flex-col h-full max-h-[400px]">
                <div class="p-5 border-b border-slate-700 bg-slate-800/50">
                    <h3 class="text-sm font-bold text-white uppercase tracking-wide">Suara Akar Umbi</h3>
                </div>
                <div id="comments-container" class="p-5 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                    <p class="text-xs text-slate-500 text-center italic">Memuatkan komen...</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-slate-600 text-[10px] uppercase tracking-widest">
        SPARK Analytics Engine v9.2 â€¢ Data Real-Time Firebase
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Setup Chart.js
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.font.size = 11;
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function initDashboard() {
            try {
                // 1. Fetch Data (Optimized: Get All Once)
                // Kita gunakan query untuk susun ikut masa supaya komen terbaru di atas
                const q = query(collection(db, "spark_needs_survey"), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                const data = snapshot.docs.map(doc => doc.data());
                
                const total = data.length;
                animateValue('total-respondents', 0, total, 1000);

                if (total === 0) {
                    document.getElementById('loading').innerHTML = `<p class="text-yellow-500 font-bold">TIADA DATA KAJIAN DITEMUI</p><p class="text-slate-400 text-xs mt-2">Sila isi borang kajian terlebih dahulu.</p>`;
                    return;
                }

                // 2. Data Processing Variables
                let manualIssuesCount = { "Tulisan Buruk": 0, "Nama Tak Lengkap": 0, "Senarai Hilang": 0, "Data Entry": 0 };
                let gformIssuesCount = { "Kerja Berulang": 0, "Peserta Keliru": 0, "Analisis Manual": 0 };
                let wishlistCount = { "Muat Turun Excel": 0, "OPR": 0, "Takwim": 0, "Sijil": 0, "Semua Di Atas": 0 };
                
                let highBurdenCount = 0; // Scale 4 & 5
                let yesSupportCount = 0;
                let respondentsWithIssues = 0;
                let totalMinsWasted = 0;

                // Time Mapping (Estimate Mins)
                const setupMap = { "5-10m": 7.5, "10-20m": 15, "20-30m": 25, "30-60m": 45, ">1h": 60 };
                const entryMap = { "0": 0, "10-20m": 15, ">30m": 30 };

                data.forEach(d => {
                    // Count Manual Issues
                    if (d.manualIssues && Array.isArray(d.manualIssues)) {
                        d.manualIssues.forEach(i => { if(manualIssuesCount[i] !== undefined) manualIssuesCount[i]++; });
                        if (d.manualIssues.length > 0) respondentsWithIssues++;
                    }
                    
                    // Count GForm Issues
                    if (d.gformIssues && Array.isArray(d.gformIssues)) {
                        d.gformIssues.forEach(i => { if(gformIssuesCount[i] !== undefined) gformIssuesCount[i]++; });
                    }

                    // Wishlist
                    if (d.wishlist && Array.isArray(d.wishlist)) {
                        d.wishlist.forEach(w => { if(wishlistCount[w] !== undefined) wishlistCount[w]++; });
                    }

                    // Stats
                    if (parseInt(d.burdenScale) >= 4) highBurdenCount++;
                    if (d.willingness === 'Ya') yesSupportCount++;

                    // ROI Calculation
                    const sTime = setupMap[d.setupTime] || 5; 
                    const eTime = entryMap[d.dataEntryTime] || 0;
                    totalMinsWasted += (sTime + eTime);
                });

                // 3. Render Hero Stats
                const burdenPct = Math.round((highBurdenCount / total) * 100);
                const supportPct = Math.round((yesSupportCount / total) * 100);
                const issuePct = Math.round((respondentsWithIssues / total) * 100);
                const hoursWasted = Math.round(totalMinsWasted / 60);

                animateValue("stat-burden", 0, burdenPct, 1500, "%");
                animateValue("stat-hours-wasted", 0, hoursWasted, 2000, "");
                animateValue("stat-manual-issues", 0, issuePct, 1500, "%");
                animateValue("stat-support", 0, supportPct, 1500, "%");

                // 4. Render Charts
                renderIssuesChart(manualIssuesCount, gformIssuesCount);
                renderTimeChart(data);
                renderWishlistChart(wishlistCount);
                
                // 5. Render Comments
                renderComments(data);

                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                console.error("Error init dashboard:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Ralat: ${error.message}</p>`;
            }
        }

        // --- CHART FUNCTIONS ---

        function renderIssuesChart(manual, gform) {
            const ctx = document.getElementById('issuesChart').getContext('2d');
            
            // Gabung data
            const labels = [...Object.keys(manual), ...Object.keys(gform)];
            const data = [...Object.values(manual), ...Object.values(gform)];
            
            // Warna: Merah untuk Manual, Kuning untuk GForm
            const bgColors = labels.map((l, i) => i < Object.keys(manual).length ? '#ef4444' : '#f59e0b');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', anchor: 'end', align: 'end', offset: 4 }
                    },
                    scales: {
                        x: { display: false },
                        y: { ticks: { color: '#cbd5e1', font: {size: 10} }, grid: { display: false } }
                    }
                }
            });
        }

        function renderTimeChart(data) {
            // Kita kira taburan masa setup
            let counts = { "<20m": 0, "20-60m": 0, ">1h": 0 };
            data.forEach(d => {
                if (d.setupTime === "5-10m" || d.setupTime === "10-20m") counts["<20m"]++;
                else if (d.setupTime === ">1h") counts[">1h"]++;
                else counts["20-60m"]++;
            });

            const ctx = document.getElementById('timeComparisonChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cepat (<20m)', 'Sederhana', 'Lama (>1 Jam)'],
                    datasets: [{
                        data: [counts["<20m"], counts["20-60m"], counts[">1h"]],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#cbd5e1', boxWidth: 12 } },
                        datalabels: { color: 'white', formatter: (val, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return (val*100 / sum).toFixed(0) + "%";
                        }}
                    }
                }
            });
        }

        function renderWishlistChart(counts) {
            const ctx = document.getElementById('wishlistChart').getContext('2d');
            
            // Sort by popularity
            const sortedEntries = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const data = sortedEntries.map(e => e[1]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#8b5cf6', // Purple
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', anchor: 'end', align: 'top' }
                    },
                    scales: {
                        y: { display: false, beginAtZero: true },
                        x: { ticks: { color: '#cbd5e1', font: {size: 10} }, grid: { display: false } }
                    }
                }
            });
        }

        function renderComments(data) {
            const container = document.getElementById('comments-container');
            // Filter komen yang ada isi dan panjang sikit
            const validComments = data.filter(d => d.comment && d.comment.length > 5);
            
            if (validComments.length === 0) {
                container.innerHTML = `<p class="text-xs text-slate-500 text-center">Tiada komen.</p>`;
                return;
            }

            container.innerHTML = validComments.map(d => `
                <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <p class="text-xs text-slate-300 italic mb-2">"${d.comment}"</p>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] font-bold text-blue-400 uppercase">${d.name || 'Responden'}</span>
                        <span class="text-[9px] text-slate-500">${d.station || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        // Animasi Nombor
        function animateValue(id, start, end, duration, suffix = "") {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start) + suffix;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        initDashboard();
    </script>
</body>
</html>
