<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penjana Memo Dalaman (AI Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        
        #pdf-wrapper { width: 210mm; margin: 0 auto; }

        /* A4 Paper Settings - Specific for Memo */
        .a4-paper {
            width: 210mm; min-height: 297mm; height: 297mm; 
            padding: 20mm 20mm 20mm 20mm; /* Standard margin for letters */
            margin: 0 auto; margin-bottom: 20px;
            background: white; box-shadow: 0 0 25px rgba(0,0,0,0.1);
            font-family: 'Arial', sans-serif; color: black; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* Memo Header Grid */
        .memo-header-grid {
            display: grid;
            grid-template-columns: 100px 1fr 100px 1fr;
            gap: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
            align-items: start;
        }
        
        .memo-label { font-weight: bold; text-transform: uppercase; font-size: 10pt; }
        .memo-val { font-size: 11pt; }

        /* Content Styles */
        .memo-content {
            font-size: 11pt;
            line-height: 1.5;
            text-align: justify;
        }
        
        .memo-content p { margin-bottom: 1rem; }
        .memo-content ul, .memo-content ol { margin-left: 2rem; margin-bottom: 1rem; }

        /* Loading Spinner */
        .loading-spinner {
            border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%;
            width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Signature Canvas */
        canvas#signature-pad { touch-action: none; border: 1px dashed #ccc; } 

        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            #pdf-wrapper { width: 100%; margin: 0; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; height: 297mm; padding-top: 20mm !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-pink-600 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-pink-700 uppercase tracking-wide flex items-center gap-2">
                        SPARK MEMO
                        <span id="account-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">Memuatkan...</span>
                    </h1>
                    <p class="text-xs text-gray-500">Penjana Memo Dalaman (AI Powered)</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.location.href='opr.html'" class="text-gray-500 hover:text-pink-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Ke OPR
                </button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button onclick="downloadPDFOnly()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-xs font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 uppercase transition-all">
                    Download Sahaja
                </button>
                <button onclick="saveAndDownload()" id="btn-save" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white text-xs font-bold py-2 px-5 rounded-lg shadow-md flex items-center gap-2 uppercase transition-transform hover:scale-105">
                    Simpan & PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar">
            
            <div class="flex gap-3 mb-5">
                <div class="w-full">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Sejarah Memo</label>
                    <select id="history-select" onchange="loadHistory(this.value)" class="w-full text-xs border border-gray-300 rounded bg-white focus:ring-1 focus:ring-pink-500 h-9">
                        <option value="">-- Pilih Rekod --</option>
                    </select>
                </div>
            </div>

            <div class="flex p-1 bg-gray-100 rounded-lg mb-5 border border-gray-200">
                <button onclick="showTab('form')" id="tab-btn-form" class="flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-pink-600 transition-all">Isi Memo</button>
                <button onclick="showTab('settings')" id="tab-btn-settings" class="flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Tetapan</button>
            </div>

            <div id="tab-content-form" class="block space-y-4">
                <input type="hidden" id="memo-id">
                <input type="hidden" id="memo-serial-hidden"> 
                
                <div class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <h3 class="text-xs font-bold text-gray-700 uppercase">Maklumat Asas</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Kepada</label>
                            <input type="text" id="in-kepada" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Contoh: Semua Guru">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Daripada</label>
                            <input type="text" id="in-daripada" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Contoh: Pengetua">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                           <label class="text-[10px] font-bold text-gray-500 uppercase">No. Rujukan</label>
                           <input type="text" id="in-rujukan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500 focus:border-pink-500" value="JEA4036/600-1/1 ( )">
                       </div>
                       <div>
                           <label class="text-[10px] font-bold text-gray-500 uppercase">Tarikh</label>
                           <input type="date" id="in-tarikh" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500 focus:border-pink-500">
                       </div>
                   </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-700 uppercase mb-1 block">Perkara / Tajuk Memo</label>
                    <textarea id="in-perkara" oninput="updatePreview()" rows="2" class="w-full text-sm font-bold border-2 border-pink-100 rounded-lg p-2.5 uppercase focus:border-pink-500 focus:ring-0 transition-colors shadow-sm" placeholder="TAJUK MEMO (CONTOH: MESYUARAT GURU KALI PERTAMA)"></textarea>
                </div>

                <div class="relative">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-700 uppercase flex items-center gap-1">
                            <span class="w-1.5 h-4 bg-purple-500 rounded-full"></span> Kandungan
                        </label>
                        <button type="button" onclick="askAIMemo()" class="text-[10px] bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 py-1 rounded shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all font-bold flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            AI: Karang Memo
                        </button>
                    </div>
                    <textarea id="in-kandungan" oninput="updatePreview()" rows="12" class="w-full text-sm border-2 border-gray-200 rounded-lg p-3 focus:border-purple-500 bg-white shadow-sm leading-relaxed" placeholder="Tulis isi memo di sini atau guna AI..."></textarea>
                    <p class="text-[9px] text-gray-400 mt-1 italic text-right">*Gunakan 'Enter' untuk perenggan baru.</p>
                </div>

                <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <label class="text-xs font-bold text-purple-800 uppercase mb-2 block">Pengesahan / Tandatangan</label>
                    <input type="text" id="in-slogan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 mb-2 bg-white italic" value='"BERKHIDMAT UNTUK NEGARA"'>
                    
                    <input type="text" id="in-nama" oninput="updatePreview()" class="w-full text-sm font-bold border border-gray-300 rounded p-2 uppercase mb-2 bg-white" placeholder="NAMA PEGAWAI">
                    <input type="text" id="in-jawatan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 uppercase bg-white" placeholder="JAWATAN">

                    <div class="mt-3 pt-2 border-t border-purple-200">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="chk-signature" class="w-3 h-3" onchange="toggleSignature()">
                            <span class="text-[10px] font-bold uppercase text-purple-700">Sertakan Tandatangan</span>
                        </div>
                        
                        <div id="sig-container" class="hidden">
                            <canvas id="signature-pad" class="w-full h-24 bg-white rounded cursor-crosshair mb-2"></canvas>
                            <div class="flex gap-2">
                                <button onclick="clearSignature()" class="text-[9px] bg-red-100 text-red-600 px-2 py-1 rounded">Padam</button>
                                <button id="btn-restore-sig" onclick="restoreDefaultSig()" class="hidden text-[9px] bg-blue-100 text-blue-600 px-2 py-1 rounded">Guna Saved Sig</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-content-settings" class="hidden space-y-4">
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Logo & Organisasi</label>
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-2 border-gray-100 rounded p-2 uppercase mb-2" value="KEMENTERIAN PENDIDIKAN MALAYSIA">
                    <input type="text" id="in-sub-org" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 uppercase" value="SMK MERBAU, MIRI">
                    <input type="text" id="in-address" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 mt-2" value="Jalan Miri-Bintulu, 98000 Miri, Sarawak">
                </div>
            </div>

        </div>

        <div class="w-full lg:w-2/3 bg-gray-100 overflow-auto flex justify-center p-8">
            <div id="pdf-wrapper">
                
                <div class="a4-paper" id="main-report">
                    
                    <div class="flex items-center gap-4 mb-6">
                        <img id="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-24 w-auto object-contain">
                        <div class="flex-grow">
                            <h2 id="out-org-name" class="font-bold uppercase text-lg leading-tight tracking-wide">KEMENTERIAN PENDIDIKAN MALAYSIA</h2>
                            <p id="out-sub-org" class="font-bold text-sm uppercase">SMK MERBAU, MIRI</p>
                            <p id="out-address" class="text-xs text-gray-600 mt-1">Jalan Miri-Bintulu, 98000 Miri, Sarawak</p>
                        </div>
                        <div class="flex flex-col items-end">
                            <svg id="barcode"></svg>
                        </div>
                    </div>

                    <div class="w-full h-px bg-black mb-1"></div>
                    <div class="w-full h-px bg-black mb-6"></div>

                    <h1 class="text-center font-bold text-2xl uppercase tracking-widest underline mb-8">MEMO DALAMAN</h1>

                    <div class="memo-header-grid">
                        <div class="memo-label">Kepada</div>
                        <div class="memo-val">: <span id="out-kepada" class="uppercase font-bold"></span></div>
                        
                        <div class="memo-label">Daripada</div>
                        <div class="memo-val">: <span id="out-daripada" class="uppercase"></span></div>

                        <div class="memo-label">Rujukan</div>
                        <div class="memo-val">: <span id="out-rujukan"></span></div>

                        <div class="memo-label">Tarikh</div>
                        <div class="memo-val">: <span id="out-tarikh"></span></div>
                    </div>

                    <div class="flex gap-2 mb-6 align-top">
                        <div class="memo-label w-[100px] shrink-0">Perkara</div>
                        <div class="memo-val font-bold uppercase underline leading-tight flex-grow">: <span id="out-perkara"></span></div>
                    </div>

                    <div class="memo-content mb-10 flex-grow">
                        <div id="out-kandungan" class="whitespace-pre-wrap"></div>
                    </div>

                    <div class="mt-auto">
                        <p class="mb-6 font-bold italic" id="out-slogan">"BERKHIDMAT UNTUK NEGARA"</p>
                        <p class="mb-4">Saya yang menjalankan amanah,</p>
                        
                        <div class="h-20 mb-1 flex items-end">
                             <img id="out-sig-img" class="h-full w-auto object-contain hidden" src="">
                        </div>

                        <p class="font-bold uppercase" id="out-nama">( NAMA PEGAWAI )</p>
                        <p class="uppercase text-sm" id="out-jawatan">JAWATAN</p>
                    </div>

                    <div class="mt-8 border-t border-gray-300 pt-1 flex justify-between items-center text-[7px] text-gray-400 uppercase tracking-wider">
                        <span>Dijana oleh SPARK MEMO</span>
                        <span>Tarikh Cetakan: <span id="print-date"></span></span>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI SAMA SEPERTI OPR.HTML ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        window.currentUserIc = "";
        window.currentUserDocId = "";
        window.allMyMemos = [];
        window.sigFile = null;
        window.sigUrl = "";
        window.defaultSigUrl = ""; 
        let isDrawing = false;
        let sigCanvas, sigCtx;

        // --- 1. SETUP & AUTH ---
        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            window.currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
            
            if (window.currentUserIc) {
                await loadUser();
                loadSavedMemos();
                setDefaultDate();
                initSignaturePad();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadUser() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", window.currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uDoc = userSnap.docs[0];
                window.currentUserDocId = uDoc.id;
                const uData = uDoc.data();
                
                // Auto fill name/jawatan
                document.getElementById('in-nama').value = uData.name.toUpperCase();
                document.getElementById('in-jawatan').value = (uData.jawatan || "").toUpperCase();
                
                // Set Badge
                const badge = document.getElementById('account-badge');
                badge.textContent = uData.isPro ? "AKAUN PRO" : "AKAUN BIASA";
                if(uData.isPro) badge.className += " bg-yellow-100 text-yellow-800 border-yellow-300";

                // Default Signature
                if (uData.defaultSignatureUrl) {
                    window.defaultSigUrl = uData.defaultSignatureUrl;
                    document.getElementById('btn-restore-sig').classList.remove('hidden');
                }
                updatePreview();
            }
        }

        function setDefaultDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('in-tarikh').value = dateStr;
            document.getElementById('print-date').textContent = today.toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric', hour:'2-digit', minute:'2-digit' });
            
            // Initial Serial Barcode
            const serial = "MEMO-" + Math.floor(10000 + Math.random() * 90000);
            document.getElementById('memo-serial-hidden').value = serial;
            renderBarcode(serial);
            updatePreview();
        }

        function renderBarcode(text) {
            JsBarcode("#barcode", text, {
                format: "CODE128", width: 1, height: 15, displayValue: false, margin: 0
            });
        }

        // --- 2. AI WRITER FUNCTION ---
        window.askAIMemo = async function() {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            const GROQ_API_KEY = "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"; // Key from OPR

            const tajuk = document.getElementById('in-perkara').value;
            const kepada = document.getElementById('in-kepada').value;
            const daripada = document.getElementById('in-daripada').value;

            if(!tajuk) { alert("Sila isi 'Perkara / Tajuk' dahulu untuk AI menjana kandungan."); return; }

            btn.innerHTML = `<span class="loading-spinner"></span> Menulis...`;
            btn.disabled = true;

            const systemPrompt = "Anda adalah setiausaha kerajaan Malaysia yang pakar menulis memo rasmi, ringkas, dan padat. Gunakan Bahasa Melayu formal (Baku).";
            const userPrompt = `Tulis isi kandungan memo rasmi (tanpa header/tarikh) daripada "${daripada}" kepada "${kepada}" bertajuk "${tajuk}". 
            Format:
            1. Mulakan dengan "Dengan segala hormatnya, perkara di atas adalah dirujuk."
            2. Isi kandungan (2-3 perenggan ringkas).
            3. Penutup (biasanya "Kerjasama tuan/puan amat dihargai.")
            Jangan letak 'Kepada/Daripada' lagi, hanya isi kandungan badan memo sahaja.`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.5,
                        max_tokens: 400
                    })
                });

                const data = await response.json();
                if (data.choices && data.choices[0]) {
                    const text = data.choices[0].message.content.replace(/^"|"$/g, '').trim(); 
                    document.getElementById('in-kandungan').value = text;
                    updatePreview();
                } else {
                    alert("AI tidak memberi respon.");
                }
            } catch (e) {
                alert("Ralat AI: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- 3. UI & PREVIEW ---
        window.updatePreview = function() {
            // Mappings
            document.getElementById('out-kepada').textContent = document.getElementById('in-kepada').value;
            document.getElementById('out-daripada').textContent = document.getElementById('in-daripada').value;
            document.getElementById('out-rujukan').textContent = document.getElementById('in-rujukan').value;
            document.getElementById('out-perkara').textContent = document.getElementById('in-perkara').value;
            document.getElementById('out-nama').textContent = `( ${document.getElementById('in-nama').value} )`;
            document.getElementById('out-jawatan').textContent = document.getElementById('in-jawatan').value;
            document.getElementById('out-slogan').textContent = document.getElementById('in-slogan').value;

            // Date Format
            const dVal = document.getElementById('in-tarikh').value;
            if(dVal) {
                const d = new Date(dVal);
                document.getElementById('out-tarikh').textContent = d.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            }

            // Content Format (preserve newlines)
            document.getElementById('out-kandungan').innerText = document.getElementById('in-kandungan').value;
        }

        window.updateHeader = function() {
            document.getElementById('out-org-name').textContent = document.getElementById('in-org-name').value;
            document.getElementById('out-sub-org').textContent = document.getElementById('in-sub-org').value;
            document.getElementById('out-address').textContent = document.getElementById('in-address').value;
        }

        window.showTab = function(tab) {
            if(tab === 'form') {
                document.getElementById('tab-content-form').classList.remove('hidden');
                document.getElementById('tab-content-settings').classList.add('hidden');
                document.getElementById('tab-btn-form').className = "flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-pink-600 transition-all";
                document.getElementById('tab-btn-settings').className = "flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all";
                resizeCanvas();
            } else {
                document.getElementById('tab-content-form').classList.add('hidden');
                document.getElementById('tab-content-settings').classList.remove('hidden');
                document.getElementById('tab-btn-settings').className = "flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-pink-600 transition-all";
                document.getElementById('tab-btn-form').className = "flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all";
            }
        }

        // --- 4. SIGNATURE ---
        function initSignaturePad() {
            sigCanvas = document.getElementById('signature-pad');
            sigCtx = sigCanvas.getContext('2d');
            
            sigCanvas.addEventListener('mousedown', startDrawing);
            sigCanvas.addEventListener('mouseup', stopDrawing);
            sigCanvas.addEventListener('mousemove', draw);
            sigCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            sigCanvas.addEventListener('touchend', (e) => { e.preventDefault(); stopDrawing(); });
            sigCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        }

        function resizeCanvas() {
            if(sigCanvas) {
                const rect = sigCanvas.getBoundingClientRect();
                sigCanvas.width = rect.width;
                sigCanvas.height = rect.height;
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = sigCanvas.getBoundingClientRect();
            sigCtx.beginPath();
            sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        function draw(e) {
            if(!isDrawing) return;
            const rect = sigCanvas.getBoundingClientRect();
            sigCtx.lineWidth = 2; sigCtx.lineCap = 'round';
            sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            sigCtx.stroke();
        }
        function stopDrawing() { 
            isDrawing = false; 
            updateSigFromCanvas(); 
        }

        window.clearSignature = function() {
            sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
            document.getElementById('out-sig-img').classList.add('hidden');
            window.sigUrl = "";
        }
        
        function updateSigFromCanvas() {
             const dataUrl = sigCanvas.toDataURL("image/png");
             document.getElementById('out-sig-img').src = dataUrl;
             document.getElementById('out-sig-img').classList.remove('hidden');
        }

        window.toggleSignature = function() {
            const chk = document.getElementById('chk-signature').checked;
            const container = document.getElementById('sig-container');
            const outImg = document.getElementById('out-sig-img');
            
            if(chk) {
                container.classList.remove('hidden');
                resizeCanvas();
                if(window.sigUrl || window.defaultSigUrl) outImg.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                outImg.classList.add('hidden');
            }
        }

        window.restoreDefaultSig = function() {
            if(window.defaultSigUrl) {
                window.sigUrl = window.defaultSigUrl;
                document.getElementById('out-sig-img').src = window.sigUrl;
                document.getElementById('out-sig-img').classList.remove('hidden');
                // Could draw it to canvas too if needed, but img src is easier
            }
        }

        // --- 5. SAVE & PDF ---
        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = "Proses..."; btn.disabled = true;

            try {
                // Generate Serial if new
                let serial = document.getElementById('memo-serial-hidden').value;
                if(!serial) {
                     serial = "MEMO-" + Date.now();
                     document.getElementById('memo-serial-hidden').value = serial;
                }

                // Upload Signature if drawn new
                let finalSigUrl = window.sigUrl;
                // Check if canvas has content manually or just rely on global var logic
                // Simple implementation:
                if(document.getElementById('chk-signature').checked && !window.sigUrl) {
                     // Upload canvas
                     const dataUrl = sigCanvas.toDataURL("image/png");
                     const blob = await (await fetch(dataUrl)).blob();
                     const formData = new FormData(); formData.append("image", blob);
                     const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                     const json = await res.json();
                     if(json.success) finalSigUrl = json.data.url;
                }

                const data = {
                    ic: window.currentUserIc,
                    kepada: document.getElementById('in-kepada').value,
                    daripada: document.getElementById('in-daripada').value,
                    rujukan: document.getElementById('in-rujukan').value,
                    tarikh: document.getElementById('in-tarikh').value,
                    perkara: document.getElementById('in-perkara').value,
                    kandungan: document.getElementById('in-kandungan').value,
                    nama: document.getElementById('in-nama').value,
                    jawatan: document.getElementById('in-jawatan').value,
                    slogan: document.getElementById('in-slogan').value,
                    orgName: document.getElementById('in-org-name').value,
                    subOrgName: document.getElementById('in-sub-org').value,
                    address: document.getElementById('in-address').value,
                    signatureUrl: finalSigUrl || "",
                    serial: serial,
                    updatedAt: new Date()
                };

                const memoId = document.getElementById('memo-id').value;
                if(memoId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_memo_records`, memoId), data);
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_memo_records`), data);
                }

                await generatePDF();
                loadSavedMemos(); // Refresh list

            } catch (e) {
                console.error(e);
                alert("Ralat menyimpan: " + e.message);
            } finally {
                btn.innerHTML = "Simpan & PDF"; btn.disabled = false;
            }
        }

        async function generatePDF() {
            const element = document.getElementById('pdf-wrapper');
            const tajuk = document.getElementById('in-perkara').value.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15);
            const opt = { 
                margin: 0, 
                filename: `MEMO_${tajuk}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            await html2pdf().set(opt).from(element).save();
        }

        window.downloadPDFOnly = function() {
            generatePDF();
        }

        // --- 6. HISTORY ---
        async function loadSavedMemos() {
            const ref = collection(db, `artifacts/${appId}/public/data/spark_memo_records`);
            const q = query(ref, where("ic", "==", window.currentUserIc), orderBy("createdAt", "desc"));
            const snaps = await getDocs(q);
            
            window.allMyMemos = [];
            const select = document.getElementById('history-select');
            select.innerHTML = '<option value="">-- Pilih Rekod --</option>';

            snaps.forEach(d => {
                const data = { id: d.id, ...d.data() };
                window.allMyMemos.push(data);
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.textContent = (data.tarikh || "Tiada Tarikh") + " - " + data.perkara.substring(0, 20) + "...";
                select.appendChild(opt);
            });
        }

        window.loadHistory = function(id) {
            const data = window.allMyMemos.find(m => m.id === id);
            if(!data) return;

            document.getElementById('memo-id').value = data.id;
            document.getElementById('memo-serial-hidden').value = data.serial || "";
            renderBarcode(data.serial || "MEMO-REF");

            document.getElementById('in-kepada').value = data.kepada;
            document.getElementById('in-daripada').value = data.daripada;
            document.getElementById('in-rujukan').value = data.rujukan;
            document.getElementById('in-tarikh').value = data.tarikh;
            document.getElementById('in-perkara').value = data.perkara;
            document.getElementById('in-kandungan').value = data.kandungan;
            
            document.getElementById('in-nama').value = data.nama;
            document.getElementById('in-jawatan').value = data.jawatan;
            document.getElementById('in-slogan').value = data.slogan || '"BERKHIDMAT UNTUK NEGARA"';
            
            document.getElementById('in-org-name').value = data.orgName || "KEMENTERIAN PENDIDIKAN MALAYSIA";
            document.getElementById('in-sub-org').value = data.subOrgName || "SMK MERBAU";
            document.getElementById('in-address').value = data.address || "";

            if(data.signatureUrl) {
                window.sigUrl = data.signatureUrl;
                document.getElementById('out-sig-img').src = window.sigUrl;
                document.getElementById('chk-signature').checked = true;
                toggleSignature();
            }

            updatePreview(); updateHeader();
        }

        // Init
        updatePreview();
    </script>
</body>
</html>
