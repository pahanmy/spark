<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Penjana Memo Dalaman (PPD Miri)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #525659; }
        
        /* WRAPPER UTAMA */
        #pdf-wrapper { 
            width: 210mm; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 40px; 
            padding-bottom: 50px;
            transform-origin: top center;
        }

        /* SETTING KERTAS A4 */
        .a4-page {
            width: 210mm; 
            height: 297mm;     
            padding: 15mm 25.4mm 25.4mm 25.4mm; 
            background: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            font-family: 'Arial', sans-serif; 
            color: black; 
            position: relative;
            overflow: visible; 
            display: flex; 
            flex-direction: column;
            font-size: 11pt; 
            box-sizing: border-box;
        }

        /* Header Style PPD */
        .ppd-header { text-align: center; font-family: 'Arial', sans-serif; margin-bottom: 10px; }
        .ppd-header h2 { font-weight: bold; margin: 0; line-height: 1.1; font-size: 14pt; }
        .ppd-header p { margin: 0; line-height: 1.1; text-transform: uppercase; font-size: 10pt; }

        /* Header Sambungan */
        .page-continuation-header {
            text-align: right;
            font-size: 10pt;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
            padding-bottom: 5px;
            font-family: 'Arial', sans-serif;
            color: #555;
        }

        /* Table Meta Data */
        .memo-meta-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-family: 'Arial', sans-serif; }
        .memo-meta-table td { vertical-align: top; padding-bottom: 6px; }
        .meta-label { width: 130px; font-weight: normal; } 
        .meta-sep { width: 20px; text-align: center; }
        .meta-val { font-weight: normal; white-space: pre-wrap; } 

        /* Content Container */
        .memo-content-container { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
        }
        
        .memo-paragraph { 
            line-height: 1.5; 
            text-align: justify; 
            font-family: 'Arial', sans-serif; 
            white-space: pre-wrap; 
        }

        /* KHAS UNTUK BUTIRAN PROGRAM (GRID ALIGNMENT) */
        .memo-detail-row {
            display: grid;
            grid-template-columns: 25mm 5mm auto; /* Label Lebar | Sep | Nilai */
            margin-left: 20mm; /* Indent Dalam Sikit */
            margin-bottom: 0.3em;
            line-height: 1.5;
            font-family: 'Arial', sans-serif;
        }
        .memo-detail-label { font-weight: normal; }
        .memo-detail-sep { text-align: center; }
        /* UBAH DI SINI: font-weight normal (tak bold) */
        .memo-detail-val { font-weight: normal; } 
        
        /* QR Code Box */
        .qr-floating-box {
            position: absolute;
            right: 25.4mm;
            bottom: 25.4mm; 
            width: 28mm; 
            text-align: center;
            border: 1px solid #000;
            padding: 3px;
            background: #fff;
            z-index: 20;
        }
        .qr-floating-box img { width: 100%; height: auto; display: block; margin-bottom: 2px; }
        .qr-floating-box p { font-size: 6pt; font-weight: bold; margin: 0; line-height: 1; text-transform: uppercase; }

        /* Signature Section */
        .signature-section { margin-top: auto; padding-top: 10px; margin-bottom: 10px; }

        /* Canvas */
        canvas#signature-pad { touch-action: none; border: 2px dashed #cbd5e1; border-radius: 0.5rem; background-color: #ffffff; cursor: crosshair; } 

        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            #pdf-wrapper { width: 100%; margin: 0; display: block; gap: 0; transform: none !important; }
            .a4-page { 
                box-shadow: none; 
                margin: 0; 
                page-break-after: always; 
                height: 297mm; 
                overflow: hidden; 
            }
            .a4-page:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-pink-600 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-pink-700 uppercase tracking-wide flex items-center gap-2">
                        SPARK MEMO
                        <span id="account-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">Memuatkan...</span>
                    </h1>
                    <p class="text-xs text-gray-500">Penjana Memo PPD (Format Rasmi)</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-pink-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Kembali
                </button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button onclick="saveAndDownload()" id="btn-save" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white text-xs font-bold py-2 px-5 rounded-lg shadow-md flex items-center gap-2 uppercase transition-transform hover:scale-105">
                    Simpan & PDF
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar">
            
            <div class="flex gap-2 mb-5">
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Sejarah Memo</label>
                    <select id="history-select" onchange="loadHistory(this.value)" class="w-full text-xs border border-gray-300 rounded bg-white focus:ring-1 focus:ring-pink-500 h-9">
                        <option value="">-- Pilih Rekod --</option>
                    </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Import Program</label>
                    <select id="program-select" onchange="importProgramData(this.value)" class="w-full text-xs border border-blue-300 rounded bg-blue-50 focus:ring-1 focus:ring-blue-500 h-9">
                        <option value="">-- Pilih Program --</option>
                    </select>
                </div>
            </div>

            <div class="bg-purple-50 p-2 rounded border border-purple-200 mb-5">
                <label class="block text-[10px] font-bold text-purple-700 uppercase mb-1 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Pilih Template (Dalaman PPD)
                </label>
                <select id="template-select" onchange="applyTemplate(this.value)" class="w-full text-xs border border-purple-300 rounded bg-white focus:ring-1 focus:ring-purple-500 h-9 font-semibold text-purple-900">
                    <option value="">-- Kosong (Manual) --</option>
                    <option value="mesyuarat">Mesyuarat Sektor/Unit</option>
                    <option value="lantikan">Lantikan AJK Dalaman</option>
                    <option value="arahan">Arahan Bertugas PPD</option>
                    <option value="cuti">Peringatan Pentadbiran (Cuti)</option>
                    <option value="program">Jemputan Program PPD</option>
                </select>
            </div>

            <div class="flex p-1 bg-gray-100 rounded-lg mb-5 border border-gray-200">
                <button onclick="showTab('form')" id="tab-btn-form" class="flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-pink-600 transition-all">Isi Memo</button>
                <button onclick="showTab('history')" id="tab-btn-history" class="flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Sejarah</button>
                <button onclick="showTab('settings')" id="tab-btn-settings" class="flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all">Tetapan</button>
            </div>

            <div id="tab-content-form" class="block space-y-4">
                <input type="hidden" id="memo-id">
                <input type="hidden" id="memo-serial-hidden"> 
                
                <div class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <h3 class="text-xs font-bold text-gray-700 uppercase">Maklumat Asas</h3>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Kepada (Enter untuk baris baru)</label>
                        <textarea id="in-kepada" oninput="updatePreview()" rows="3" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500 font-semibold leading-tight" placeholder="Contoh: &#10;Semua Timbalan PPD&#10;Semua Ketua Unit"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Daripada</label>
                            <input type="text" id="in-daripada" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500" placeholder="Contoh: Pegawai PPD">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Tarikh</label>
                            <input type="date" id="in-tarikh" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500">
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-700 uppercase mb-1 block">Perkara / Tajuk Memo</label>
                        <textarea id="in-perkara" oninput="updatePreview()" rows="2" class="w-full text-sm font-bold border-2 border-pink-100 rounded-lg p-2.5 uppercase focus:border-pink-500 shadow-sm" placeholder="TAJUK MEMO (DALAMAN PPD)..."></textarea>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] font-bold text-blue-800 uppercase block">Bantuan AI (Format PPD Miri)</label>
                            <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">Had: 5x/Bulan</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase font-bold">Jenis Memo</label>
                                <select id="in-memo-type" class="w-full text-[10px] border border-blue-300 rounded p-1.5 bg-white text-blue-900 font-bold uppercase">
                                    <option value="biasa">Makluman</option>
                                    <option value="jemputan">Jemputan</option>
                                    <option value="arahan">Arahan</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase font-bold">Panjang Kandungan</label>
                                <select id="in-ai-length" class="w-full text-[10px] border border-blue-300 rounded p-1.5 bg-white text-blue-900 font-bold uppercase">
                                    <option value="short" selected>Ringkas (3 Para)</option>
                                    <option value="medium">Sederhana (4-5 Para)</option>
                                    <option value="long">Terperinci (>5 Para)</option>
                                </select>
                            </div>
                        </div>

                        <textarea id="in-ai-points" rows="2" class="w-full text-xs border border-blue-300 rounded p-2 focus:ring-blue-500 mb-2" placeholder="Poin: Tarikh, Masa, Agenda (AI akan formatkan)"></textarea>
                        <button type="button" onclick="askAIMemo()" class="w-full text-[10px] bg-gradient-to-r from-pink-600 to-purple-600 text-white px-3 py-2 rounded shadow hover:shadow-lg font-bold flex items-center justify-center gap-2">Tulis Semula Guna AI</button>
                    </div>

                    <textarea id="in-kandungan" oninput="updatePreview()" rows="15" class="w-full text-sm border-2 border-gray-200 rounded-lg p-3 focus:border-pink-500 bg-white shadow-sm leading-relaxed" placeholder="Tuan,&#10;&#10;Dengan segala hormatnya perkara di atas adalah dirujuk.&#10;&#10;2. [Isi kandungan bermula di sini]"></textarea>
                    <p class="text-[9px] text-gray-500 italic">* Format standard PPD telah dimasukkan secara automatik.</p>
                </div>

                <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <label class="text-xs font-bold text-purple-800 uppercase mb-2 block">Pengesahan & Kontak</label>
                    <input type="text" id="in-nama" oninput="updatePreview()" class="w-full text-sm font-bold border border-gray-300 rounded p-2 uppercase mb-2 bg-white" placeholder="NAMA PEGAWAI">
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="in-phone" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 bg-white" placeholder="No Tel">
                        <input type="text" id="in-email" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 bg-white" placeholder="Email">
                    </div>

                    <div class="mt-4 pt-3 border-t border-purple-200 bg-white p-2 rounded shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="chk-signature" class="w-4 h-4 text-purple-600 rounded" onchange="toggleSignature()">
                                <span class="text-[10px] font-bold uppercase text-purple-700">Tandatangan</span>
                            </div>
                            <button id="btn-restore-sig" onclick="restoreDefaultSig()" class="hidden text-[9px] bg-blue-100 text-blue-700 px-2 py-1 rounded-md font-bold hover:bg-blue-200">Guna Simpanan</button>
                        </div>
                        <div id="sig-container" class="hidden">
                            <canvas id="signature-pad" class="w-full h-24 bg-white rounded cursor-crosshair mb-2 shadow-inner border border-gray-300"></canvas>
                            <div class="flex justify-end gap-2">
                                <button onclick="clearSignature()" class="text-[9px] bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200">PADAM</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 p-3 rounded-lg border border-green-200 mt-4">
                    <div class="flex justify-between items-center mb-2">
                         <label class="text-xs font-bold text-green-800 uppercase flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            QR Pengesahan / RSVP
                        </label>
                        <input type="checkbox" id="chk-show-qr" class="w-4 h-4 text-green-600 rounded" onchange="updatePreview()">
                    </div>
                    <div id="qr-settings" class="space-y-2">
                        <div class="flex gap-2 text-[10px]">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="qr-mode" value="spark" checked onchange="toggleQrMode()" class="text-green-600">
                                <span class="font-bold">Sistem SPARK</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="qr-mode" value="manual" onchange="toggleQrMode()" class="text-green-600">
                                <span class="font-bold">Pautan Luar</span>
                            </label>
                        </div>
                        <input type="text" id="in-qr-link" oninput="updatePreview()" class="hidden w-full text-xs border border-green-300 rounded p-2 bg-white" placeholder="Tampal Pautan (URL) di sini...">
                        <p id="spark-qr-hint" class="text-[9px] text-green-600 italic">Link kehadiran program SPARK yang dipilih.</p>
                        <input type="text" id="in-qr-label" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 bg-white mt-1 uppercase" value="IMBAS UNTUK PENGESAHAN KEHADIRAN">
                    </div>
                </div>
            </div>

            <div id="tab-content-history" class="hidden">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-xs font-bold text-gray-700 uppercase">Rekod Memo</h3>
                    <button onclick="loadSavedMemos()" class="text-[9px] bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">Refresh</button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm bg-white">
                    <table class="min-w-full text-xs text-left text-gray-600">
                        <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-3 py-3 font-bold tracking-wider">Tarikh</th>
                                <th class="px-3 py-3 font-bold tracking-wider">Perkara</th>
                                <th class="px-3 py-3 font-bold text-center tracking-wider w-28">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-gray-100">
                            <tr><td colspan="3" class="px-3 py-8 text-center text-gray-400 italic">Sedang memuatkan data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-[9px] text-gray-400 mt-2 italic">*Hanya 20 rekod terkini dipaparkan.</p>
            </div>

            <div id="tab-content-settings" class="hidden space-y-4">
                 
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Margin Halaman (mm)</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] text-gray-500 uppercase">Atas (Top)</label>
                            <input type="number" id="margin-top" value="15" onchange="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-purple-500 bg-gray-50">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 uppercase">Bawah (Bottom)</label>
                            <input type="number" id="margin-bottom" value="25" onchange="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-purple-500 bg-gray-50">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 uppercase">Kiri (Left)</label>
                            <input type="number" id="margin-left" value="25" onchange="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-purple-500 bg-gray-50">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 uppercase">Kanan (Right)</label>
                            <input type="number" id="margin-right" value="25" onchange="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-purple-500 bg-gray-50">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Pilihan Tambahan</label>
                    <div class="space-y-2">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Salinan Kepada</label>
                            <input type="text" id="in-salinan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500" placeholder="Contoh: Penyelaras EKSA">
                        </div>
                         <div class="flex flex-col">
                           <label class="text-[10px] font-bold text-gray-500 uppercase">No. Rujukan</label>
                           <input type="text" id="in-rujukan" oninput="updatePreview()" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-pink-500" value="PPDM.100-7/6/1 (     )">
                       </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Jarak Antara Perenggan (Spacing)</label>
                    <div class="flex items-center gap-4">
                        <button onclick="changeSpacing(-5)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded font-bold">-</button>
                        <span id="spacing-display" class="text-sm font-bold text-pink-600">0px</span>
                        <button onclick="changeSpacing(5)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded font-bold">+</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Saiz Tulisan</label>
                    <div class="flex items-center gap-4">
                        <button onclick="changeFontSize(-1)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded font-bold">-</button>
                        <span id="font-size-display" class="text-sm font-bold text-pink-600">11pt</span>
                        <button onclick="changeFontSize(1)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded font-bold">+</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Header Organisasi</label>
                    <input type="text" id="in-org-name" oninput="updateHeader()" class="w-full text-sm border-2 border-gray-100 rounded p-2 uppercase mb-2 font-bold" value="PEJABAT PENDIDIKAN DAERAH MIRI">
                    <input type="text" id="in-address-1" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 uppercase mb-1" value="ARAS 2, BLOK 1, WISMA PERSEKUTUAN FASA 1,">
                    <input type="text" id="in-address-2" oninput="updateHeader()" class="w-full text-xs border-2 border-gray-100 rounded p-2 uppercase" value="JALAN KIPAS, 98000 MIRI">
                </div>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-700 overflow-auto flex justify-center p-8">
            <div id="pdf-wrapper">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        window.currentUserIc = "";
        window.allMyMemos = [];
        window.allMyPrograms = [];
        window.selectedProgram = null;
        window.sigUrl = "";
        window.defaultSigUrl = ""; 
        window.currentFontSize = 11;
        window.paragraphSpacing = 0; 
        window.isSparkPro = false; 
        let isDrawing = false;
        let sigCanvas, sigCtx;

        // STANDARD OPENING CONSTANT
        const STANDARD_OPENING = "Tuan,\n\nDengan segala hormatnya perkara di atas adalah dirujuk.\n\n";

        // TEMPLATE DIKEMASKINI DENGAN FORMAT INDENT BARU
        const memoTemplates = {
            "mesyuarat": { 
                title: "JEMPUTAN MESYUARAT SEKTOR/UNIT BIL. 1/2025", 
                type: "jemputan", 
                content: `${STANDARD_OPENING}2. Sukacita dimaklumkan bahawa mesyuarat tersebut akan diadakan seperti ketetapan berikut:\n\nTarikh : [Masukkan Tarikh]\nMasa : [Masukkan Masa]\nTempat : [Masukkan Tempat]\nPengerusi : [Nama Pengerusi]\n\n3. Kehadiran tuan/puan adalah diwajibkan. Segala kerjasama dan komitmen tuan/puan amatlah dihargai.\n\nSekian, terima kasih.` 
            },
            "lantikan": { 
                title: "PELANTIKAN SEBAGAI JAWATANKUASA PELAKSANA [NAMA PROGRAM]", 
                type: "biasa", 
                content: `${STANDARD_OPENING}2. Sukacita dimaklumkan bahawa tuan/puan telah dilantik sebagai Ahli Jawatankuasa bagi program PPD yang dijadualkan berlangsung pada [Tarikh].\n\n3. Pelantikan ini bertujuan melancarkan gerak kerja program demi memastikan objektif tercapai dengan jayanya. Diharap tuan dapat melaksanakan amanah ini dengan cemerlang.\n\nSekian, terima kasih.` 
            },
            "arahan": { 
                title: "ARAHAN BERTUGAS SEMPENA [NAMA ACARA]", 
                type: "arahan", 
                content: `${STANDARD_OPENING}2. Tuan diarahkan untuk hadir bertugas di [Lokasi] pada [Tarikh] bermula jam [Masa] bagi memastikan kelancaran acara tersebut.\n\n3. Kegagalan tuan mematuhi arahan ini tanpa sebab yang munasabah boleh dikenakan tindakan tatatertib.\n\nSekian, terima kasih.` 
            },
            "cuti": { 
                title: "PERINGATAN BERKENAAN PERMOHONAN CUTI REHAT KHAS (CRK)", 
                type: "arahan", 
                content: `${STANDARD_OPENING}2. Adalah diingatkan bahawa semua permohonan Cuti Rehat Khas (CRK) hendaklah dibuat sekurang-kurangnya 3 hari sebelum tarikh bercuti, kecuali bagi kes-kes kecemasan.\n\n3. Kerjasama tuan mematuhi prosedur ini amat dihargai bagi melancarkan urusan pentadbiran.\n\nSekian, terima kasih.` 
            },
            "program": { 
                title: "JEMPUTAN KE PROGRAM PPD MIRI", 
                type: "jemputan", 
                content: `${STANDARD_OPENING}2. Pihak Pejabat Pendidikan Daerah Miri berbesar hati menjemput tuan untuk hadir memeriahkan majlis tersebut pada ketetapan berikut:\n\nTarikh : [Tarikh]\nMasa : [Masa]\nTempat : [Tempat]\n\n3. Kehadiran tuan amatlah dialu-alukan.\n\nSekian, terima kasih.` 
            }
        };

        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            window.currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
            if (window.currentUserIc) { await loadUserAndPrograms(); loadSavedMemos(); setDefaultDate(); initSignaturePad(); setDefaultText(); } 
            else { window.location.href = 'index.html'; }
        });

        function setDefaultText() {
            if(!document.getElementById('in-kandungan').value) {
                document.getElementById('in-kandungan').value = `${STANDARD_OPENING}2. `;
                updatePreview();
            }
        }

        async function loadUserAndPrograms() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const qUser = query(usersRef, where("ic", "==", window.currentUserIc));
            const userSnap = await getDocs(qUser);
            if (!userSnap.empty) {
                const uDoc = userSnap.docs[0];
                const uData = uDoc.data();
                window.isSparkPro = uData.isPro === true; 
                document.getElementById('in-nama').value = `(${uData.name.toUpperCase()})`;
                const badge = document.getElementById('account-badge');
                badge.textContent = uData.isPro ? "AKAUN PRO" : "AKAUN BIASA";
                if(uData.isPro) badge.className += " bg-yellow-100 text-yellow-800 border-yellow-300";
                if (uData.defaultSignatureUrl) { window.defaultSigUrl = uData.defaultSignatureUrl; document.getElementById('btn-restore-sig').classList.remove('hidden'); }
            }
            const progRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q1 = query(progRef, where("createdBy", "==", window.currentUserIc));
            const q2 = query(progRef, where("penyelaras_ic", "==", window.currentUserIc));
            try {
                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                const select = document.getElementById('program-select');
                window.allMyPrograms = [];
                const appendOption = (doc) => { const data = { id: doc.id, ...doc.data() }; if(window.allMyPrograms.some(p => p.id === data.id)) return; const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.name.toUpperCase(); select.appendChild(opt); window.allMyPrograms.push(data); };
                snap1.forEach(appendOption); snap2.forEach(appendOption);
            } catch (err) { console.error("Error loading programs", err); }
            updatePreview();
        }

        function setDefaultDate() { document.getElementById('in-tarikh').value = new Date().toISOString().split('T')[0]; updatePreview(); }
        window.applyTemplate = function(val) { if(!val) return; const tmpl = memoTemplates[val]; if(tmpl) { document.getElementById('in-perkara').value = tmpl.title; document.getElementById('in-kandungan').value = tmpl.content; document.getElementById('in-memo-type').value = tmpl.type; updatePreview(); } }
        window.importProgramData = function(progId) { const prog = window.allMyPrograms.find(p => p.id === progId); window.selectedProgram = prog; if(prog) { document.getElementById('in-perkara').value = prog.name ? prog.name.toUpperCase() : ""; let points = ""; if(prog.startDate) points += `- Tarikh: ${prog.startDate}\n`; if(prog.location) points += `- Tempat: ${prog.location}\n`; document.getElementById('in-ai-points').value = points; document.getElementById('in-memo-type').value = "jemputan"; document.getElementById('chk-show-qr').checked = true; const radios = document.getElementsByName('qr-mode'); for(let r of radios) { if(r.value === 'spark') r.checked = true; } toggleQrMode(); } updatePreview(); }
        window.toggleQrMode = function() { const mode = document.querySelector('input[name="qr-mode"]:checked').value; const inputLink = document.getElementById('in-qr-link'); const hint = document.getElementById('spark-qr-hint'); if (mode === 'spark') { inputLink.classList.add('hidden'); hint.classList.remove('hidden'); } else { inputLink.classList.remove('hidden'); hint.classList.add('hidden'); } updatePreview(); }
        
        // --- AI LIMIT 5x & STRICT PPD FORMAT + SMART INDENT ---
        window.askAIMemo = async function() { 
            const btn = event.currentTarget; 
            const originalText = btn.innerHTML; 
            const GROQ_API_KEY = "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"; 
            
            // LENGTH & LIMIT CHECK
            const lengthOption = document.getElementById('in-ai-length').value;
            let lengthInstruction = lengthOption === 'short' ? "2-3 perenggan" : (lengthOption === 'medium' ? "4-5 perenggan" : ">5 perenggan");
            let maxTokens = lengthOption === 'short' ? 500 : (lengthOption === 'medium' ? 800 : 1200);

            if (!window.isSparkPro) {
                const STORAGE_KEY = `spark_ai_memo_limit_${window.currentUserIc}`;
                const currentMonth = new Date().toISOString().slice(0, 7); 
                let usageData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { count: 0, month: currentMonth };
                if (usageData.month !== currentMonth) { usageData = { count: 0, month: currentMonth }; }
                if (usageData.count >= 5) { 
                    if (confirm("⚠️ Had AI Dicapai (5/5)\n\nMaaf, akaun biasa terhad kepada 5 kali penggunaan AI sebulan.\n\nKlik OK untuk ke halaman penaja.")) { window.location.href = 'sponsor.html'; }
                    return; 
                }
                usageData.count++; localStorage.setItem(STORAGE_KEY, JSON.stringify(usageData));
            }

            const tajuk = document.getElementById('in-perkara').value; 
            const kepada = document.getElementById('in-kepada').value; 
            const points = document.getElementById('in-ai-points').value; 
            const type = document.getElementById('in-memo-type').value; 
            if(!tajuk) { alert("Sila isi 'Perkara / Tajuk' dahulu."); return; } 
            btn.innerHTML = `Menulis...`; btn.disabled = true; 
            
            let toneContext = ""; 
            if (type === 'jemputan') toneContext = "Ini adalah SURAT JEMPUTAN RASMI PPD."; 
            else if (type === 'arahan') toneContext = "Ini adalah ARAHAN PENTADBIRAN PPD."; 
            else toneContext = "Ini adalah MEMO MAKLUMAN DALAMAN PPD."; 
            
            const systemPrompt = `Anda adalah pegawai tadbir di Pejabat Pendidikan Daerah Miri. Fokus penulisan adalah untuk memo dalaman sesama warga PPD Miri. ${toneContext} Gunakan Bahasa Melayu Baku, formal. 
            
            ARAHAN PENTING:
            1. ARAHAN PANJANG TEKS: ${lengthInstruction}
            2. JANGAN tulis 'Tuan,' atau 'Dengan segala hormatnya...'. Ia sudah ada dalam borang.
            3. MULA TERUS dengan nombor '2.' dan isi kandungan utama.
            4. Jarakkan setiap perenggan dengan satu baris kosong.
            5. JIKA ADA BUTIRAN PROGRAM (Tarikh, Masa, Tempat), WAJIB indent/jarakkan ke dalam sedikit supaya nampak seperti senarai yang kemas. Gunakan jarak tab atau space.
            6. Akhiri dengan 'Sekian, terima kasih.'`; 
            
            const userPrompt = `Tulis isi memo kepada "${kepada}" bertajuk "${tajuk}". Poin Penting: ${points}.
            Mula terus dari perenggan kedua (2.). Pastikan butiran program di-inden.`; 
            
            try { 
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", { 
                    method: "POST", 
                    headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" }, 
                    body: JSON.stringify({ 
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], 
                        model: "llama-3.3-70b-versatile", 
                        temperature: 0.6, 
                        max_tokens: maxTokens 
                    }) 
                }); 
                const data = await response.json(); 
                if (data.choices && data.choices[0]) { 
                    const aiOutput = data.choices[0].message.content.trim();
                    const fullText = `${STANDARD_OPENING}${aiOutput}`;
                    document.getElementById('in-kandungan').value = fullText; 
                    updatePreview(); 
                } 
            } catch (e) { alert("Ralat AI: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; } 
        }
        
        window.changeFontSize = function(change) { window.currentFontSize += change; if(window.currentFontSize < 8) window.currentFontSize = 8; if(window.currentFontSize > 16) window.currentFontSize = 16; document.getElementById('font-size-display').textContent = window.currentFontSize + 'pt'; updatePreview(); }
        window.changeSpacing = function(change) { window.paragraphSpacing += change; if(window.paragraphSpacing < 0) window.paragraphSpacing = 0; if(window.paragraphSpacing > 50) window.paragraphSpacing = 50; document.getElementById('spacing-display').textContent = window.paragraphSpacing + 'px'; updatePreview(); }

        window.updatePreview = function() {
            const wrapper = document.getElementById('pdf-wrapper');
            wrapper.innerHTML = ''; 

            const mTop = parseInt(document.getElementById('margin-top').value) || 15;
            const mBot = parseInt(document.getElementById('margin-bottom').value) || 25;
            const mLeft = parseInt(document.getElementById('margin-left').value) || 25;
            const mRight = parseInt(document.getElementById('margin-right').value) || 25;

            const MAX_PAGE_HEIGHT_MM = 297 - mTop - mBot - 5; 
            const mmToPx = (mm) => mm * 3.78; 
            const MAX_HEIGHT_PX = mmToPx(MAX_PAGE_HEIGHT_MM);

            let currentPage = createNewPage(mTop, mRight, mBot, mLeft);
            wrapper.appendChild(currentPage);
            let contentContainer = currentPage.querySelector('.memo-content-container');

            const headerDiv = document.createElement('div');
            headerDiv.innerHTML = `
                <div class="ppd-header">
                    <h2>${document.getElementById('in-org-name').value}</h2>
                    <p>${document.getElementById('in-address-1').value}</p>
                    <p>${document.getElementById('in-address-2').value}</p>
                </div>
                <div class="text-center mb-6 mt-4">
                    <div class="inline-block border-2 border-black px-6 py-1"><span class="font-bold text-[14pt] tracking-widest block">MEMO</span></div>
                </div>
            `;
            contentContainer.appendChild(headerDiv);

            const metaDiv = document.createElement('div');
            const salinanVal = document.getElementById('in-salinan').value;
            const dateInput = document.getElementById('in-tarikh');
            metaDiv.innerHTML = `
                <table class="memo-meta-table">
                    <tr><td class="meta-label">Kepada</td><td class="meta-sep">:</td><td class="meta-val font-bold">${document.getElementById('in-kepada').value}</td></tr>
                    <tr><td class="meta-label">Daripada</td><td class="meta-sep">:</td><td class="meta-val">${document.getElementById('in-daripada').value}</td></tr>
                    ${salinanVal ? `<tr><td class="meta-label">Salinan Kepada</td><td class="meta-sep">:</td><td class="meta-val">${salinanVal}</td></tr>` : ''}
                    <tr><td class="meta-label">No. Rujukan</td><td class="meta-sep">:</td><td class="meta-val">${document.getElementById('in-rujukan').value}</td></tr>
                    <tr><td class="meta-label">Tarikh</td><td class="meta-sep">:</td><td class="meta-val">${dateInput && dateInput.value ? formatDate(dateInput.value) : ''}</td></tr>
                    <tr><td class="meta-label">Perkara</td><td class="meta-sep">:</td><td class="meta-val font-bold uppercase" style="text-align:justify;">${document.getElementById('in-perkara').value}</td></tr>
                </table>
            `;
            contentContainer.appendChild(metaDiv);

            const rawContent = document.getElementById('in-kandungan').value;
            const paragraphs = rawContent.split('\n');
            const refNo = document.getElementById('in-rujukan').value;

            paragraphs.forEach((paraText) => {
                // --- SMART ALIGNMENT LOGIC ---
                // Detect Program Details (e.g. Tarikh : 20 Mei)
                const detailRegex = /^\s*(Tarikh|Masa|Tempat|Pengerusi|Anjuran)\s*:/i;
                const match = paraText.match(detailRegex);

                let p;
                if (match) {
                    // Create formatted GRID row for details
                    p = document.createElement('div');
                    p.className = 'memo-detail-row';
                    const label = match[1]; // e.g. Tarikh
                    const value = paraText.replace(match[0], '').trim(); // Remove "Tarikh :" from start
                    
                    p.innerHTML = `
                        <div class="memo-detail-label">${label}</div>
                        <div class="memo-detail-sep">:</div>
                        <div class="memo-detail-val">${value}</div>
                    `;
                } else {
                    // Standard Paragraph
                    p = document.createElement('p');
                    p.className = 'memo-paragraph';
                    p.innerHTML = paraText.trim() ? paraText : '&nbsp;'; 
                }

                p.style.marginBottom = window.paragraphSpacing + 'px'; 
                contentContainer.appendChild(p);

                // Page Break Check
                if (contentContainer.getBoundingClientRect().height > MAX_HEIGHT_PX) {
                    contentContainer.removeChild(p);
                    currentPage = createNewPage(mTop, mRight, mBot, mLeft);
                    wrapper.appendChild(currentPage);
                    contentContainer = currentPage.querySelector('.memo-content-container');
                    const contHeader = document.createElement('div');
                    contHeader.className = 'page-continuation-header';
                    contHeader.textContent = `No. Rujukan: ${refNo} (Sambungan)`;
                    contentContainer.appendChild(contHeader);
                    contentContainer.appendChild(p);
                }
            });

            // ... Signature & QR Code logic remains same ...
            const sigDiv = document.createElement('div');
            sigDiv.className = 'signature-section';
            sigDiv.innerHTML = `
                <div class="mt-8 mb-4">
                    <p class="mb-6 font-normal">Sekian, terima kasih.</p>
                    <div class="h-16 mb-1 flex items-end">
                         <img src="${window.sigUrl || ''}" class="h-full w-auto object-contain ${window.sigUrl ? '' : 'hidden'}">
                    </div>
                    <p class="font-bold uppercase">${document.getElementById('in-nama').value}</p>
                    <div class="text-[0.95em] mt-1 font-sans">
                         <p class="${document.getElementById('in-phone').value ? '' : 'hidden'} m-0">No Tel : ${document.getElementById('in-phone').value}</p>
                         <p class="${document.getElementById('in-email').value ? '' : 'hidden'} m-0">Email : ${document.getElementById('in-email').value}</p>
                    </div>
                </div>
            `;
            contentContainer.appendChild(sigDiv);
            if (contentContainer.getBoundingClientRect().height > MAX_HEIGHT_PX) {
                contentContainer.removeChild(sigDiv);
                currentPage = createNewPage(mTop, mRight, mBot, mLeft);
                wrapper.appendChild(currentPage);
                contentContainer = currentPage.querySelector('.memo-content-container');
                const contHeader = document.createElement('div');
                contHeader.className = 'page-continuation-header';
                contHeader.textContent = `No. Rujukan: ${refNo} (Sambungan)`;
                contentContainer.appendChild(contHeader);
                contentContainer.appendChild(sigDiv);
            }
             if (document.getElementById('chk-show-qr').checked) {
                const qrDiv = document.createElement('div');
                qrDiv.className = 'qr-floating-box';
                qrDiv.style.right = mRight + 'mm';
                qrDiv.style.bottom = mBot + 'mm';
                const label = document.getElementById('in-qr-label').value;
                let qrData = "https://google.com";
                const qrModeEl = document.querySelector('input[name="qr-mode"]:checked');
                if(qrModeEl) { if(qrModeEl.value === 'spark' && window.selectedProgram) { qrData = `https://myqrhadir.web.app/participant.html?kod=${window.selectedProgram.id}`; } else { const linkInput = document.getElementById('in-qr-link'); if (linkInput) qrData = linkInput.value || "https://google.com"; } }
                const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
                qrDiv.innerHTML = `<img src="${qrSrc}"><p>${label}</p>`;
                currentPage.appendChild(qrDiv); 
            }
        }

        function createNewPage(top, right, bottom, left) {
            const page = document.createElement('div');
            page.className = 'a4-page';
            page.style.fontSize = window.currentFontSize + 'pt';
            page.style.padding = `${top}mm ${right}mm ${bottom}mm ${left}mm`;
            page.innerHTML = '<div class="memo-content-container"></div>';
            return page;
        }

        function formatDate(dateString) {
            if(!dateString) return "";
            const d = new Date(dateString);
            const monthNames = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
            return `${d.getDate()} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
        }

        window.updateHeader = function() { window.updatePreview(); }
        window.showTab = function(tab) {
            document.querySelectorAll('[id^="tab-content-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-content-' + tab).classList.remove('hidden');
            document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
                btn.className = "flex-1 py-2 text-xs font-bold uppercase rounded-md text-gray-500 hover:text-gray-700 transition-all";
            });
            document.getElementById('tab-btn-' + tab).className = "flex-1 py-2 text-xs font-bold uppercase rounded-md shadow-sm bg-white text-pink-600 transition-all";
            if(tab === 'form') resizeCanvas();
        }

        // SIGNATURE FUNCTIONS
        function initSignaturePad() { sigCanvas = document.getElementById('signature-pad'); sigCtx = sigCanvas.getContext('2d'); sigCanvas.addEventListener('mousedown', startDrawing); sigCanvas.addEventListener('mouseup', stopDrawing); sigCanvas.addEventListener('mousemove', draw); sigCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); }); sigCanvas.addEventListener('touchend', (e) => { e.preventDefault(); stopDrawing(); }); sigCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); }); }
        function resizeCanvas() { if(sigCanvas) { const rect = sigCanvas.getBoundingClientRect(); sigCanvas.width = rect.width; sigCanvas.height = rect.height; } }
        function startDrawing(e) { isDrawing = true; const rect = sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
        function draw(e) { if(!isDrawing) return; const rect = sigCanvas.getBoundingClientRect(); sigCtx.lineWidth = 2; sigCtx.lineCap = 'round'; sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top); sigCtx.stroke(); }
        function stopDrawing() { isDrawing = false; updateSigFromCanvas(); }
        window.clearSignature = function() { sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height); window.sigUrl = ""; updatePreview(); }
        function updateSigFromCanvas() { const dataUrl = sigCanvas.toDataURL("image/png"); window.sigUrl = dataUrl; updatePreview(); }
        window.toggleSignature = function() { const chk = document.getElementById('chk-signature').checked; document.getElementById('sig-container').classList.toggle('hidden', !chk); if(!chk) { window.sigUrl = ""; updatePreview(); } else { resizeCanvas(); } }
        window.restoreDefaultSig = function() { if(window.defaultSigUrl) { window.sigUrl = window.defaultSigUrl; document.getElementById('chk-signature').checked = true; updatePreview(); alert("Tandatangan dimuatkan."); } }

        window.saveAndDownload = async function() {
            const btn = document.getElementById('btn-save'); btn.innerHTML = "Proses..."; btn.disabled = true;
            try {
                let finalSigUrl = window.sigUrl;
                if(finalSigUrl.startsWith('data:')) {
                     const blob = await (await fetch(finalSigUrl)).blob();
                     const formData = new FormData(); formData.append("image", blob);
                     const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                     const json = await res.json();
                     if(json.success) finalSigUrl = json.data.url;
                }

                // Get Current Margins
                const mTop = document.getElementById('margin-top').value;
                const mBot = document.getElementById('margin-bottom').value;
                const mLeft = document.getElementById('margin-left').value;
                const mRight = document.getElementById('margin-right').value;

                const data = {
                    ic: window.currentUserIc,
                    kepada: document.getElementById('in-kepada').value,
                    daripada: document.getElementById('in-daripada').value,
                    salinan: document.getElementById('in-salinan').value,
                    rujukan: document.getElementById('in-rujukan').value,
                    tarikh: document.getElementById('in-tarikh').value,
                    perkara: document.getElementById('in-perkara').value,
                    kandungan: document.getElementById('in-kandungan').value,
                    nama: document.getElementById('in-nama').value,
                    phone: document.getElementById('in-phone').value,
                    email: document.getElementById('in-email').value,
                    orgName: document.getElementById('in-org-name').value,
                    address1: document.getElementById('in-address-1').value,
                    address2: document.getElementById('in-address-2').value,
                    signatureUrl: finalSigUrl || "",
                    serial: document.getElementById('memo-serial-hidden').value,
                    fontSize: window.currentFontSize,
                    paragraphSpacing: window.paragraphSpacing,
                    margins: { top: mTop, bottom: mBot, left: mLeft, right: mRight }, 
                    programId: window.selectedProgram ? window.selectedProgram.id : "",
                    memoType: document.getElementById('in-memo-type').value,
                    showQr: document.getElementById('chk-show-qr').checked,
                    qrMode: document.querySelector('input[name="qr-mode"]:checked').value,
                    qrLink: document.getElementById('in-qr-link').value,
                    qrLabel: document.getElementById('in-qr-label').value,
                    updatedAt: new Date()
                };

                const memoId = document.getElementById('memo-id').value;
                if(memoId) { await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_memo_records`, memoId), data); }
                else { data.createdAt = new Date(); await addDoc(collection(db, `artifacts/${appId}/public/data/spark_memo_records`), data); }
                await generatePDF(); loadSavedMemos();
            } catch (e) { console.error(e); alert("Ralat: " + e.message); } finally { btn.innerHTML = "Simpan & PDF"; btn.disabled = false; }
        }

        async function generatePDF() {
            const element = document.getElementById('pdf-wrapper');
            const tajuk = document.getElementById('in-perkara').value.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 15);
            const opt = { margin: 0, filename: `MEMO_${tajuk}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            await html2pdf().set(opt).from(element).save();
        }

        // --- LOAD HISTORY TABLE (SEJARAH) ---
        async function loadSavedMemos() {
            const ref = collection(db, `artifacts/${appId}/public/data/spark_memo_records`);
            const q = query(ref, where("ic", "==", window.currentUserIc), orderBy("createdAt", "desc"), limit(20));
            const snaps = await getDocs(q);
            window.allMyMemos = [];
            const select = document.getElementById('history-select');
            select.innerHTML = '<option value="">-- Pilih Rekod --</option>';
            snaps.forEach(d => {
                const data = { id: d.id, ...d.data() };
                window.allMyMemos.push(data);
                const opt = document.createElement('option'); opt.value = data.id; opt.textContent = data.perkara.substring(0, 30) + "...";
                select.appendChild(opt);
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors group";
                const dateStr = data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleDateString('ms-MY') : '-';
                tr.innerHTML = `<td class="px-3 py-2 whitespace-nowrap">${dateStr}</td><td class="px-3 py-2 truncate max-w-[120px]" title="${data.perkara}">${data.perkara}</td><td class="px-3 py-2 text-center"><div class="flex items-center justify-center gap-2"><button onclick="loadHistory('${data.id}')" class="text-indigo-600 hover:text-indigo-800">✏️</button><button onclick="downloadFromHistory('${data.id}')" class="text-teal-600 hover:text-teal-800">📥</button><button onclick="deleteHistory('${data.id}')" class="text-red-500 hover:text-red-700">🗑️</button></div></td>`;
                document.getElementById('history-table-body').appendChild(tr);
            });
        }

        window.loadHistory = function(id) {
            const data = window.allMyMemos.find(m => m.id === id);
            if(!data) return;
            document.getElementById('memo-id').value = data.id;
            const map = ['in-kepada', 'in-daripada', 'in-salinan', 'in-rujukan', 'in-perkara', 'in-kandungan', 'in-nama', 'in-phone', 'in-email', 'in-tarikh'];
            map.forEach(fid => { const key = fid.replace('in-', ''); if(data[key]) document.getElementById(fid).value = data[key]; });
            if(data.fontSize) window.currentFontSize = data.fontSize;
            if(data.paragraphSpacing !== undefined) { window.paragraphSpacing = data.paragraphSpacing; document.getElementById('spacing-display').textContent = window.paragraphSpacing + 'px'; }
            if(data.margins) { document.getElementById('margin-top').value = data.margins.top; document.getElementById('margin-bottom').value = data.margins.bottom; document.getElementById('margin-left').value = data.margins.left; document.getElementById('margin-right').value = data.margins.right; }
            if(data.showQr) { document.getElementById('chk-show-qr').checked = true; if(data.qrMode) { const radios = document.getElementsByName('qr-mode'); for(let r of radios) { if(r.value === data.qrMode) r.checked = true; } } document.getElementById('in-qr-link').value = data.qrLink || ""; document.getElementById('in-qr-label').value = data.qrLabel || ""; toggleQrMode(); } else { document.getElementById('chk-show-qr').checked = false; }
            if(data.signatureUrl) { window.sigUrl = data.signatureUrl; document.getElementById('chk-signature').checked = true; } else { window.sigUrl = ""; document.getElementById('chk-signature').checked = false; }
            updatePreview(); updateHeader(); showTab('form'); 
        }

        window.deleteHistory = async function(id) { if(!confirm("Padam rekod ini?")) return; try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_memo_records`, id)); loadSavedMemos(); if(document.getElementById('memo-id').value === id) { document.getElementById('memo-id').value = ""; } } catch(e) { alert("Gagal padam."); } }
        window.downloadFromHistory = function(id) { loadHistory(id); setTimeout(() => { generatePDF(); }, 500); }

        updatePreview();
    </script>
</body>
</html>
