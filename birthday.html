<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK - Hantar Ucapan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .wish-card {
            border-left-width: 4px;
            transition: all 0.3s ease;
            break-inside: avoid;
        }
        .wish-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        input:disabled, textarea:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }
        .emoji-btn, .gift-btn { cursor: pointer; transition: all 0.2s; }
        .emoji-btn:hover { transform: scale(1.2); }
        .gift-btn:hover { background-color: #f9fafb; }
        .gift-btn.gift-selected {
            background-color: #4f46e5; color: white; border-color: #4f46e5;
            font-weight: 600; transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        
        /* Animasi */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .summary-anim { animation: float 3s ease-in-out infinite; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Pro Badge Glow */
        .pro-avatar {
            box-shadow: 0 0 0 2px white, 0 0 0 4px #fbbf24; /* Yellow/Gold ring */
        }
    </style>
</head>
<body class="bg-gradient-to-tr from-indigo-50 via-blue-50 to-purple-100 min-h-screen flex flex-col items-center pt-10 pb-20 px-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-xl z-10 relative">
        
        <div class="text-center mb-6">
            <div class="mb-3">
                <span id="birthday-date-display" class="inline-flex items-center gap-1 bg-pink-100 text-pink-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-sm border border-pink-200">
                    ğŸ‚ Memuatkan Tarikh...
                </span>
            </div>
            
            <h1 class="text-2xl font-bold text-indigo-600 mb-2 leading-tight">
                Selamat Hari Jadi kepada <br> 
                <span id="recipient-name-display" class="uppercase text-4xl md:text-5xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 block mt-2">...</span>
            </h1>
        </div>

        <div id="happiness-summary" class="hidden mb-8 mt-4 bg-white rounded-xl border-2 border-pink-100 shadow-md p-5 text-center relative overflow-hidden summary-anim">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400"></div>
            
            <div id="summary-photo-container" class="hidden mb-3 relative">
                <div class="relative w-32 h-32 mx-auto">
                    <img id="summary-main-photo" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg ring-2 ring-pink-200" src="">
                    <span id="photo-count-badge" class="absolute bottom-0 right-0 bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow border-2 border-white hidden">1</span>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 italic animate-pulse">Album Kenangan Rakan-rakan (Auto-Rotate)</p>
            </div>

            <p class="text-sm font-bold text-gray-700 mb-3">ğŸ Koleksi Hadiah Maya Anda:</p>
            <div id="summary-gift-list" class="flex flex-wrap justify-center gap-2 text-2xl"></div>
            <p id="no-gift-text" class="text-xs text-gray-400 italic hidden">Belum ada hadiah. Tunggu rakan hantar!</p>
        </div>
        
        <div id="random-wish-container" class="text-center space-y-4 mb-8 px-4 bg-indigo-50/50 p-4 rounded-lg border border-indigo-100"></div>

        <form id="wish-form" class="space-y-4">
            <input type="hidden" id="recipient-dob">
            <input type="hidden" id="recipient-name-hidden">
            
            <div class="mb-4 p-4 bg-gray-50 border rounded-lg">
                <label for="sender-ic" class="block text-sm font-medium text-gray-700">1. Masukkan No. IC Anda (12 Digit)</label>
                <div class="mt-1 flex">
                    <input type="text" id="sender-ic" placeholder="No. IC 12 digit" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" maxlength="12">
                    <button type="button" id="check-ic-btn" class="btn bg-indigo-600 text-white font-semibold px-5 py-2 rounded-r-md hover:bg-indigo-700">Semak</button>
                </div>
                <p id="ic-check-status" class="text-sm mt-2"></p>

                <div id="user-info-display" class="hidden mt-3 text-sm p-3 bg-indigo-50 rounded-md border border-indigo-200">
                    <div class="flex items-center gap-3">
                        <img id="sender-preview-img" src="" class="w-10 h-10 rounded-full object-cover border border-gray-300 hidden">
                        <div>
                            <p class="font-medium text-indigo-800">Maklumat Ditemui:</p>
                            <p class="text-indigo-700"><strong id="user-info-name"></strong> <span id="pro-badge" class="hidden text-[9px] bg-yellow-400 text-white px-1 rounded font-bold">PRO</span></p>
                            <p class="text-indigo-700 text-xs"><span id="user-info-position"></span>, <span id="user-info-station"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manual-info-section" class="space-y-4 hidden">
                <div class="flex items-center"><hr class="flex-grow border-gray-200"><span class="px-3 text-xs font-semibold text-gray-400">2. MAKLUMAT PENGHANTAR</span><hr class="flex-grow border-gray-200"></div>
                <div><label class="block text-sm font-medium text-gray-700">Nama Anda</label><input type="text" id="sender-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">Jawatan</label><input type="text" id="sender-position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Stesen Kerja</label><input type="text" id="sender-station" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                </div>
            </div>
            
            <div>
                 <div class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <label class="block text-sm font-medium text-blue-800 mb-1 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        Kongsi Foto Kenangan (Pilihan):
                    </label>
                    <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    <button type="button" id="trigger-upload-btn" class="w-full text-xs bg-white border border-blue-300 text-blue-700 py-2 px-3 rounded shadow-sm hover:bg-blue-50 font-semibold flex justify-center items-center gap-2" disabled>
                        <span>ğŸ“¸ Pilih & Potong Gambar</span>
                    </button>
                    <p id="upload-status" class="text-xs text-gray-500 mt-2 italic text-center"></p>
                    <input type="hidden" id="photo-url">
                </div>

                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Emoji:</label>
                <div id="emoji-picker" class="flex flex-wrap gap-2 mb-3 max-h-32 overflow-y-auto p-1">
                    <button type="button" class="emoji-btn">ğŸ‰</button><button type="button" class="emoji-btn">ğŸ‚</button><button type="button" class="emoji-btn">ğŸ¥³</button><button type="button" class="emoji-btn">ğŸˆ</button><button type="button" class="emoji-btn">ğŸ</button><button type="button" class="emoji-btn">ğŸ°</button><button type="button" class="emoji-btn">ğŸ•¯ï¸</button><button type="button" class="emoji-btn">ğŸŠ</button><button type="button" class="emoji-btn">ğŸ§</button><button type="button" class="emoji-btn">ğŸ¬</button><button type="button" class="emoji-btn">ğŸ­</button><button type="button" class="emoji-btn">ğŸ’</button><button type="button" class="emoji-btn">ğŸŒŸ</button><button type="button" class="emoji-btn">âœ¨</button><button type="button" class="emoji-btn">ğŸ’«</button><button type="button" class="emoji-btn">ğŸ’–</button><button type="button" class="emoji-btn">ğŸ¥°</button><button type="button" class="emoji-btn">ğŸ˜</button><button type="button" class="emoji-btn">ğŸ¤©</button><button type="button" class="emoji-btn">ğŸ¤—</button>
                </div>

                <label for="wish-message" class="block text-sm font-medium text-gray-700">Ucapan Anda</label>
                <textarea id="wish-message" rows="4" placeholder="Sila semak No. IC anda dahulu..." required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" disabled></textarea>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hantar Hadiah Visual (Pilih Satu):</label>
                    <div id="gift-selector" class="flex flex-wrap gap-2">
                        <button type="button" class="gift-btn" data-gift="iPhone">ğŸ“± iPhone 16 Pro</button><button type="button" class="gift-btn" data-gift="iPad">ğŸ“± iPad Pro</button><button type="button" class="gift-btn" data-gift="Kereta Sport">ğŸï¸ Kereta Sport</button><button type="button" class="gift-btn" data-gift="Rumah Banglo">ğŸ¡ Rumah Banglo</button><button type="button" class="gift-btn" data-gift="Percutian">âœˆï¸ Pakej Percutian</button><button type="button" class="gift-btn" data-gift="Gold Bar">ğŸ‘‘ Gold Bar 999</button><button type="button" class="gift-btn" data-gift="Beg Tangan">ğŸ‘œ Beg Berjenama</button><button type="button" class="gift-btn" data-gift="Jam Rolex">âŒšï¸ Jam Tangan Mewah</button><button type="button" class="gift-btn" data-gift="Kopi Setahun">â˜•ï¸ Kopi Setahun</button><button type="button" class="gift-btn" data-gift="Makan Malam">ğŸ½ï¸ Makan Malam Hotel</button><button type="button" class="gift-btn" data-gift="Kek Hari Jadi">ğŸ‚ Kek 3 Tingkat</button><button type="button" class="gift-btn" data-gift="Coklat Mahal">ğŸ« Coklat Premium</button><button type="button" class="gift-btn" data-gift="Jambangan Bunga">ğŸ’ Jambangan Bunga</button><button type="button" class="gift-btn" data-gift="Voucher Spa">ğŸ§–â€â™€ï¸ Pakej Spa</button>
                    </div>
                    <input type="hidden" id="selected-gift" value="">
                </div>
            </div>
            
            <button type="submit" id="submit-btn" class="w-full btn bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                HANTAR UCAPAN ğŸš€
            </button>
            <p id="success-msg" class="text-green-600 text-center text-sm hidden font-bold">Ucapan anda berjaya dihantar!</p>
            <p id="error-msg" class="text-red-600 text-center text-sm hidden">Gagal menghantar. Sila semak semula.</p>
        </form>
         <div class="mt-4 text-center">
             <a href="jadual.html" class="text-sm text-indigo-600 hover:underline">Kembali ke Kalendar</a>
         </div>
    </div>

    <div id="wishes-container" class="mt-12 w-full max-w-6xl z-10 relative">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6 uppercase tracking-wide">
            <span class="bg-indigo-100 text-indigo-800 px-4 py-1 rounded-full">Kad Ucapan Rakan-rakan</span>
        </h2>
        <div id="wishes-grid" class="columns-1 md:columns-2 lg:columns-3 gap-5 space-y-5">
            <p id="loading-wishes" class="text-center text-gray-500 col-span-3">Memuatkan ucapan...</p>
        </div>
    </div>

    <footer class="w-full text-center mt-16 mb-8 text-gray-500 text-xs z-10 relative">
        <p class="font-bold text-gray-600 text-sm">SPARK</p>
        <p class="text-xs">Percikan Inovasi Kehadiran Digital</p>
        <p class="mt-2 text-xs">Projek Inovasi oleh Pahan</p>
        <p class="text-xs">Versi 2.9 (2025)</p>
    </footer>

    <div id="crop-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden">
        <div class="bg-white rounded-lg p-4 w-full max-w-md mx-4 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Potong Gambar</h3>
            <div class="cropper-container-box mb-4">
                <img id="image-to-crop" src="" class="max-w-full block">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeCropModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 font-medium text-sm">Batal</button>
                <button type="button" onclick="cropAndUpload()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium text-sm">Potong & Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, getDocs, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b";

        let dbReady = false;
        let recipientNameFromUrl = null;
        let recipientDobFromUrl = null;
        let foundUserData = null;
        
        // --- SLIDESHOW VARIABLES ---
        let slideshowImages = [];
        let slideshowIndex = 0;
        let slideshowInterval = null;

        // --- CROPPER VARIABLES ---
        let cropper = null;

        const wishesRef = collection(db, `artifacts/${appId}/public/data/spark_wishes`);
        const staffRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);

        const wishCollections = [
            { text: "Selamat Hari Lahir! Semoga hari ini menjadi permulaan tahun yang penuh kejayaan.", quote: "\"Jangan mengira tahun-tahunmu, tapi buatlah tahun-tahunmu berharga.\"" },
            { text: "Sanah Helwah! Semoga Allah memberkati usiamu dan melimpahkan rezeki.", quote: "\"Sebaik-baik manusia adalah yang paling bermanfaat bagi orang lain.\"" },
            { text: "Happy Birthday! Teruskan menjadi inspirasi kepada kami semua.", quote: "\"Kecemerlangan bukanlah satu tindakan, tetapi satu tabiat.\"" },
            { text: "Selamat Ulang Tahun Kelahiran! Semoga setiap impian menjadi kenyataan.", quote: "\"Masa depan adalah milik mereka yang percaya pada keindahan impian mereka.\"" },
            { text: "Selamat Hari Jadi! Semoga panjang umur dan murah rezeki.", quote: "\"Umur hanyalah angka, tetapi semangat adalah segalanya.\"" }
        ];

        onAuthStateChanged(auth, async (user) => {
            if (!user) { try { await signInAnonymously(auth); } catch (error) { console.error(error); } }
            dbReady = true; 
            if (recipientNameFromUrl && recipientDobFromUrl) {
                loadWishes(recipientNameFromUrl, recipientDobFromUrl);
            }
        });

        function startFireworks() {
            var duration = 15 * 1000;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            setInterval(function() {
                var particleCount = 50;
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 2500);
        }

        window.addEventListener('load', () => {
            startFireworks();
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name') || 'Penerima';
            const encodedDob = params.get('dob') || '';
            let dob = '';
            try { dob = encodedDob ? atob(encodedDob) : ''; } catch (e) { console.error(e); }
            
            document.getElementById('recipient-name-display').textContent = name.toUpperCase();
            document.getElementById('recipient-name-hidden').value = name;
            document.getElementById('recipient-dob').value = dob;

            // --- PAPARAN TARIKH BIRTHDAY (BARU) ---
            if(dob) {
                const dateObj = new Date(dob);
                if(!isNaN(dateObj.getTime())) {
                    const formattedDate = dateObj.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('birthday-date-display').textContent = `ğŸ‚ ${formattedDate}`;
                } else {
                    document.getElementById('birthday-date-display').style.display = 'none';
                }
            } else {
                document.getElementById('birthday-date-display').style.display = 'none';
            }

            recipientNameFromUrl = name;
            recipientDobFromUrl = dob;

            const randomIndex = Math.floor(Math.random() * wishCollections.length);
            const selectedWish = wishCollections[randomIndex] || wishCollections[0];
            
            document.getElementById('random-wish-container').innerHTML = `
                <p class="text-base text-gray-700"><a href="https://pahanmy.github.io/ppdclub/member.html" target="_blank" class="font-bold text-indigo-700 hover:underline">PPD CLUB</a> ingin mengucapkan:</p>
                <p class="text-gray-800 font-medium italic">"${selectedWish.text}"</p>
                <blockquote class="pt-3 border-t border-indigo-200 mt-2"><p class="text-sm italic text-purple-600 font-medium">${selectedWish.quote}</p></blockquote>
            `;

            if (dbReady) loadWishes(recipientNameFromUrl, recipientDobFromUrl);

            document.getElementById('check-ic-btn').addEventListener('click', checkUserIc);
            document.getElementById('wish-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('trigger-upload-btn').addEventListener('click', () => document.getElementById('photo-upload-input').click());
            document.getElementById('photo-upload-input').addEventListener('change', handlePhotoSelect);
            document.getElementById('sender-ic').addEventListener('input', () => {
                document.getElementById('manual-info-section').classList.add('hidden');
                document.getElementById('user-info-display').classList.add('hidden');
                toggleWishFields(false);
                document.getElementById('ic-check-status').textContent = '';
                document.getElementById('wish-message').placeholder = "Sila semak No. IC anda dahulu...";
                foundUserData = null;
            });
            document.getElementById('manual-info-section').classList.add('hidden');
            toggleWishFields(false);

            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const textarea = document.getElementById('wish-message');
                    if (!textarea.disabled) {
                        textarea.value += btn.textContent;
                        textarea.focus();
                    }
                });
            });
            const giftSelector = document.getElementById('gift-selector');
            giftSelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('gift-btn')) {
                    if (e.target.classList.contains('gift-selected')) {
                        e.target.classList.remove('gift-selected');
                        document.getElementById('selected-gift').value = '';
                    } else {
                        giftSelector.querySelectorAll('.gift-btn').forEach(btn => btn.classList.remove('gift-selected'));
                        e.target.classList.add('gift-selected');
                        document.getElementById('selected-gift').value = e.target.dataset.gift;
                    }
                }
            });
        });

        window.handlePhotoSelect = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageElement = document.getElementById('image-to-crop');
                    imageElement.src = event.target.result;
                    document.getElementById('crop-modal').classList.remove('hidden');
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageElement, { aspectRatio: 1, viewMode: 1, autoCropArea: 0.8 });
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        }

        window.closeCropModal = function() {
            document.getElementById('crop-modal').classList.add('hidden');
            if (cropper) { cropper.destroy(); cropper = null; }
        }

        window.cropAndUpload = function() {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });
            canvas.toBlob(async (blob) => {
                closeCropModal();
                await uploadToImgBB(blob);
            }, 'image/jpeg', 0.8);
        }

        async function uploadToImgBB(imageBlob) {
            const statusEl = document.getElementById('upload-status');
            const urlInput = document.getElementById('photo-url');
            const btn = document.getElementById('trigger-upload-btn');
            
            statusEl.textContent = "â³ Memuat naik...";
            statusEl.className = "text-xs text-blue-600 mt-2 italic animate-pulse text-center";
            btn.disabled = true;

            const formData = new FormData();
            formData.append("image", imageBlob, "photo.jpg");

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await response.json();
                if (data.success) {
                    urlInput.value = data.data.url;
                    statusEl.textContent = "âœ… Gambar disimpan!";
                    statusEl.className = "text-xs text-green-600 mt-2 font-bold text-center";
                } else { throw new Error("Gagal"); }
            } catch (error) {
                console.error(error);
                statusEl.textContent = "âŒ Gagal muat naik.";
                statusEl.className = "text-xs text-red-600 mt-2 text-center";
            } finally { btn.disabled = false; }
        }

        function startPhotoSlideshow(images) {
            if (slideshowInterval) clearInterval(slideshowInterval);
            if (!images || images.length === 0) return;

            const imgEl = document.getElementById('summary-main-photo');
            const container = document.getElementById('summary-photo-container');
            const badge = document.getElementById('photo-count-badge');
            
            container.classList.remove('hidden');
            slideshowImages = images;
            slideshowIndex = 0;

            if(images.length > 1) { badge.textContent = images.length; badge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); }

            const showImage = () => {
                imgEl.classList.remove('fade-in');
                void imgEl.offsetWidth; 
                imgEl.src = slideshowImages[slideshowIndex];
                imgEl.classList.add('fade-in');
                slideshowIndex = (slideshowIndex + 1) % slideshowImages.length;
            };
            showImage();
            if (images.length > 1) { slideshowInterval = setInterval(showImage, 3500); }
        }

        async function checkUserIc() {
            const icInput = document.getElementById('sender-ic');
            const statusEl = document.getElementById('ic-check-status');
            const checkBtn = document.getElementById('check-ic-btn');
            const enteredIc = icInput.value.trim().replace(/[^0-9]/g, '');
            icInput.value = enteredIc;

            const manualName = document.getElementById('sender-name');
            const manualPosition = document.getElementById('sender-position');
            const manualStation = document.getElementById('sender-station');
            const profilePreview = document.getElementById('sender-preview-img');
            const proBadge = document.getElementById('pro-badge');

            toggleWishFields(false);
            document.getElementById('wish-message').placeholder = "Sila semak No. IC anda dahulu...";
            document.getElementById('manual-info-section').classList.add('hidden');
            document.getElementById('user-info-display').classList.add('hidden');
            foundUserData = null; 

            if (!enteredIc || enteredIc.length !== 12) {
                statusEl.textContent = 'Sila masukkan No. IC 12 digit yang sah.'; statusEl.className = 'text-sm mt-2 text-yellow-600'; return;
            }

            statusEl.textContent = 'Mencari...'; statusEl.className = 'text-sm mt-2 text-gray-500'; checkBtn.disabled = true;

            try {
                const q = query(staffRef, where("ic", "==", enteredIc), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userData = querySnapshot.docs[0].data();
                    foundUserData = {
                        name: userData.name || '', position: userData.position || 'N/A', station: userData.station || 'N/A',
                        photoUrl: userData.profilePic || userData.photoUrl || '', 
                        isPro: userData.isPro === true
                    };
                    
                    document.getElementById('user-info-name').textContent = foundUserData.name;
                    document.getElementById('user-info-position').textContent = foundUserData.position;
                    document.getElementById('user-info-station').textContent = foundUserData.station;
                    document.getElementById('user-info-display').classList.remove('hidden');
                    
                    if(foundUserData.photoUrl) {
                        profilePreview.src = foundUserData.photoUrl;
                        profilePreview.classList.remove('hidden');
                    } else {
                        profilePreview.classList.add('hidden');
                    }

                    if(foundUserData.isPro) proBadge.classList.remove('hidden');
                    else proBadge.classList.add('hidden');
                    
                    manualName.required = false; manualPosition.required = false; manualStation.required = false;
                    statusEl.textContent = 'Maklumat ditemui! Sila tulis ucapan anda.';
                    statusEl.className = 'text-sm mt-2 text-green-600';
                } else {
                    document.getElementById('manual-info-section').classList.remove('hidden');
                    toggleSenderInfoFields(true);
                    foundUserData = null; 
                    manualName.required = true; manualPosition.required = true; manualStation.required = true;
                    statusEl.textContent = 'IC tidak ditemui. Sila isi maklumat secara manual.';
                    statusEl.className = 'text-sm mt-2 text-red-600';
                }
                toggleWishFields(true);
                document.getElementById('wish-message').placeholder = "Tulis ucapan ikhlas anda di sini...";
            } catch (error) { console.error("Error:", error); statusEl.textContent = 'Gagal membuat semakan.'; } finally { checkBtn.disabled = false; }
        }
        
        function toggleSenderInfoFields(enabled) {
            document.getElementById('sender-name').disabled = !enabled;
            document.getElementById('sender-position').disabled = !enabled;
            document.getElementById('sender-station').disabled = !enabled;
            if (enabled) { document.getElementById('sender-name').value = ''; document.getElementById('sender-position').value = ''; document.getElementById('sender-station').value = ''; }
        }

        function toggleWishFields(enabled) {
            document.getElementById('wish-message').disabled = !enabled;
            document.getElementById('submit-btn').disabled = !enabled;
            document.getElementById('trigger-upload-btn').disabled = !enabled;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!dbReady) return alert("Pangkalan data belum bersedia.");
            
            const submitBtn = document.getElementById('submit-btn');
            const successMsg = document.getElementById('success-msg');
            const errorMsg = document.getElementById('error-msg');
            
            let senderName, senderPosition, senderStation, senderPhotoUrl = '', senderIsPro = false;
            
            if (foundUserData) {
                senderName = foundUserData.name; senderPosition = foundUserData.position; senderStation = foundUserData.station;
                senderPhotoUrl = foundUserData.photoUrl; senderIsPro = foundUserData.isPro;
            } else {
                senderName = document.getElementById('sender-name').value;
                senderPosition = document.getElementById('sender-position').value;
                senderStation = document.getElementById('sender-station').value;
            }
            
            const message = document.getElementById('wish-message').value;
            const selectedGift = document.getElementById('selected-gift').value; 
            const photoUrl = document.getElementById('photo-url').value; 
            
            if (!senderName || !senderPosition || !senderStation || !message) {
                errorMsg.textContent = "Sila lengkapkan semua maklumat."; errorMsg.classList.remove('hidden'); return;
            }

            submitBtn.disabled = true; submitBtn.textContent = "Menghantar...";
            successMsg.classList.add('hidden'); errorMsg.classList.add('hidden');
            
            try {
                await addDoc(wishesRef, {
                    recipientName: document.getElementById('recipient-name-hidden').value,
                    recipientDob: document.getElementById('recipient-dob').value,
                    senderName: senderName.toUpperCase(),
                    senderPosition: senderPosition.toUpperCase(),
                    senderStation: senderStation.toUpperCase(),
                    senderPhotoUrl: senderPhotoUrl || '', 
                    senderIsPro: senderIsPro,             
                    message: message,
                    gift: selectedGift || '',
                    imageUrl: photoUrl || '', 
                    sentAt: serverTimestamp(),
                    year: new Date().getFullYear()
                });

                successMsg.classList.remove('hidden');
                document.getElementById('wish-form').reset();
                document.getElementById('selected-gift').value = '';
                document.getElementById('photo-url').value = '';
                document.getElementById('upload-status').textContent = '';
                document.querySelectorAll('.gift-btn').forEach(btn => btn.classList.remove('gift-selected'));
                document.getElementById('manual-info-section').classList.add('hidden');
                document.getElementById('user-info-display').classList.add('hidden');
                toggleWishFields(false);
                foundUserData = null;
                document.getElementById('ic-check-status').textContent = '';
                document.getElementById('wish-message').placeholder = "Sila semak No. IC anda dahulu...";

            } catch (err) { console.error(err); errorMsg.textContent = "Gagal menghantar ucapan."; errorMsg.classList.remove('hidden'); } 
            finally { submitBtn.disabled = false; submitBtn.textContent = "HANTAR UCAPAN ğŸš€"; toggleWishFields(false); }
        }
        
        function loadWishes(name, dob) {
            const q = query(wishesRef, where("recipientName", "==", name), where("recipientDob", "==", dob), orderBy("sentAt", "desc"));
            const grid = document.getElementById('wishes-grid');
            const loadingMsg = document.getElementById('loading-wishes');
            const summaryBox = document.getElementById('happiness-summary');
            const summaryGiftList = document.getElementById('summary-gift-list');
            const noGiftText = document.getElementById('no-gift-text');
            const cardStyles = ["bg-white border-l-blue-400", "bg-white border-l-pink-400", "bg-white border-l-green-400", "bg-white border-l-yellow-400", "bg-white border-l-indigo-400", "bg-white border-l-purple-400"];
            const giftEmojis = { "iPhone": "ğŸ“±", "iPad": "ğŸ“±", "Kereta Sport": "ğŸï¸", "Rumah Banglo": "ğŸ¡", "Percutian": "âœˆï¸", "Gold Bar": "ğŸ‘‘", "Beg Tangan": "ğŸ‘œ", "Jam Rolex": "âŒšï¸", "Kopi Setahun": "â˜•ï¸", "Makan Malam": "ğŸ½ï¸", "Kek Hari Jadi": "ğŸ‚", "Coklat Mahal": "ğŸ«", "Jambangan Bunga": "ğŸ’", "Voucher Spa": "ğŸ§–â€â™€ï¸", "Apple Watch": "âŒšï¸", "Samsung Watch": "âŒšï¸", "Makan Malam Mewah": "ğŸ½ï¸", "Tiket Konsert": "ğŸŸï¸", "Baucar Beli-belah": "ğŸ›ï¸" };

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    loadingMsg.textContent = "Belum ada ucapan. Jadilah yang pertama!";
                    summaryBox.classList.add('hidden');
                } else {
                    grid.innerHTML = '';
                    summaryBox.classList.remove('hidden');
                    
                    let colorIndex = 0;
                    let collectedGifts = [];
                    let collectedPhotos = [];

                    snapshot.docs.forEach(doc => {
                        const wish = doc.data();
                        
                        if(wish.gift) {
                            const giftName = wish.gift.split(' ').slice(0,2).join(' ');
                            const emoji = giftEmojis[wish.gift] || giftEmojis[giftName] || 'ğŸ';
                            collectedGifts.push(emoji);
                        }
                        if (wish.imageUrl) collectedPhotos.push(wish.imageUrl);

                        const cardStyle = cardStyles[colorIndex % cardStyles.length];
                        const card = document.createElement('div');
                        card.className = `wish-card rounded-lg shadow-lg p-5 ${cardStyle} flex flex-col break-inside-avoid`;
                        
                        if (wish.imageUrl) {
                            card.innerHTML += `<div class="mb-4 rounded-lg overflow-hidden border border-gray-200"><img src="${wish.imageUrl}" class="w-full h-auto object-cover max-h-64 hover:scale-105 transition-transform duration-500"></div>`;
                        }
                        if (wish.gift) {
                            const giftName = wish.gift.split(' ').slice(0,2).join(' ');
                            const emoji = giftEmojis[wish.gift] || giftEmojis[giftName] || 'ğŸ';
                            card.innerHTML += `<div class="text-center mb-4 pb-4 border-b border-gray-200"><span class="text-4xl filter drop-shadow-md animate-bounce inline-block">${emoji}</span><p class="text-xs font-semibold text-gray-600 mt-2">Menghantar: <span class="text-indigo-600">${wish.gift}</span></p></div>`;
                        }

                        // --- SENDER INFO SECTION ---
                        const messageEl = document.createElement('p');
                        messageEl.className = "text-gray-700 text-base italic flex-grow whitespace-pre-wrap font-serif";
                        messageEl.textContent = `"${wish.message}"`;
                        card.appendChild(messageEl);

                        const senderContainer = document.createElement('div');
                        senderContainer.className = "flex justify-end items-center mt-4 gap-3";
                        
                        const textDiv = document.createElement('div');
                        textDiv.className = "text-right";
                        
                        let senderNameHTML = `<span class="font-bold text-sm text-gray-800">${wish.senderName}</span>`;
                        if (wish.senderIsPro) {
                            senderNameHTML += ` <span class="text-[9px] bg-yellow-400 text-white px-1.5 py-0.5 rounded-full font-bold shadow-sm inline-block transform -translate-y-0.5" title="Ahli Pro">PRO</span>`;
                        }
                        textDiv.innerHTML += `<p>${senderNameHTML}</p>`;

                        let detailsText = [];
                        if (wish.senderPosition) detailsText.push(wish.senderPosition);
                        if (wish.senderStation) detailsText.push(wish.senderStation);
                        textDiv.innerHTML += `<p class="text-[10px] text-gray-400 uppercase tracking-wide leading-tight">${detailsText.join(' | ')}</p>`;
                        
                        senderContainer.appendChild(textDiv);

                        if (wish.senderPhotoUrl) {
                            const avatar = document.createElement('img');
                            avatar.src = wish.senderPhotoUrl;
                            avatar.className = `w-10 h-10 rounded-full object-cover border-2 ${wish.senderIsPro ? 'border-yellow-400 shadow-md' : 'border-gray-200'}`;
                            senderContainer.appendChild(avatar);
                        }

                        card.appendChild(senderContainer);
                        grid.appendChild(card);
                        colorIndex++;
                    });
                    
                    startPhotoSlideshow(collectedPhotos);
                    summaryGiftList.innerHTML = '';
                    if(collectedGifts.length > 0) {
                        noGiftText.classList.add('hidden');
                        collectedGifts.forEach(icon => {
                            const span = document.createElement('span'); span.textContent = icon; summaryGiftList.appendChild(span);
                        });
                    } else { noGiftText.classList.remove('hidden'); }
                }
            }, (error) => { console.error(error); loadingMsg.textContent = "Gagal memuatkan ucapan."; });
        }
    </script>
</body>
</html>
