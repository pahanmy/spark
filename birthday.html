<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK - Sanjungan Kasih</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .font-serif { font-family: 'Playfair Display', serif; }
        
        .gold-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .gold-border {
            border: 2px solid #bf953f;
            box-shadow: 0 0 5px rgba(191, 149, 63, 0.5);
        }

        .premium-card {
            background-image: radial-gradient(circle at 50% 0%, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .gift-btn.gift-selected {
            background-color: #1e3a8a; /* Royal Blue */
            color: white;
            border-color: #bf953f;
        }

        /* Animasi Halus */
        @keyframes subtle-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .animate-float { animation: subtle-float 4s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-8 pb-20 px-4 bg-slate-100">

    <div class="w-full max-w-xl z-10 relative">
        
        <div class="absolute top-4 right-4 z-50">
            <button id="share-card-btn" type="button" class="bg-white text-indigo-900 p-2 rounded-full border border-indigo-100 shadow-md hover:shadow-lg transition-all" title="Kongsi Kad Rasmi">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
            </button>
        </div>

        <div id="capture-area" class="premium-card rounded-xl p-1 relative overflow-hidden bg-white">
            
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-600 via-yellow-300 to-yellow-600"></div>
            
            <div class="border-2 border-double border-slate-200 m-2 rounded-lg p-6 relative">
                
                <div class="text-center mb-6">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-semibold">Sanjungan Kasih & Doa</p>
                    <div class="flex justify-center items-center mb-3">
                        <div id="birthday-date-display" class="inline-block bg-indigo-50 text-indigo-900 text-lg font-serif font-bold px-6 py-2 rounded-sm border-l-4 border-indigo-900 uppercase tracking-wide">
                            ...
                        </div>
                    </div>
                    
                    <h1 class="font-serif text-3xl md:text-4xl font-bold text-slate-800 leading-tight">
                        Raikan Permata<br>
                        <span id="recipient-name-display" class="gold-text block mt-1 drop-shadow-sm uppercase">...</span>
                    </h1>
                </div>

                <div id="happiness-summary" class="hidden mb-6 relative">
                    
                    <div id="summary-photo-container" class="hidden mb-4 relative flex justify-center">
                        <div class="relative p-1 rounded-full bg-gradient-to-tr from-yellow-400 via-yellow-100 to-yellow-500 shadow-xl">
                            <img id="summary-main-photo" class="w-40 h-40 rounded-full object-cover border-4 border-white" src="" crossorigin="anonymous">
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 text-center">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Ingatan Tulus Ikhlas Daripada Rakan:</p>
                        <div id="summary-gift-list" class="flex flex-wrap justify-center gap-3 text-2xl animate-float"></div>
                        <p id="no-gift-text" class="text-xs text-slate-400 italic hidden">Menanti kiriman hadiah...</p>
                    </div>
                </div>
                
                <div id="random-wish-container" class="text-center px-2 py-4 border-t border-b border-slate-100 my-4"></div>
                
                <div class="text-center mt-2 flex flex-col items-center">
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">Keluarga Besar PPD CLUB</p>
                    <div class="w-10 h-0.5 bg-yellow-500 mt-2"></div>
                </div>
            </div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <form id="wish-form" class="space-y-4">
                <input type="hidden" id="recipient-dob">
                <input type="hidden" id="recipient-name-hidden">
                
                <div class="mb-4 p-4 bg-indigo-50 border border-indigo-100 rounded-lg">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-2">Langkah 1: Pengesahan Identiti</label>
                    <div class="flex gap-2">
                        <input type="text" id="sender-ic" placeholder="No. IC (Tanpa Sengkang)" class="flex-grow px-3 py-2 text-sm border border-indigo-200 rounded focus:ring-indigo-500 focus:border-indigo-500" maxlength="12">
                        <button type="button" id="check-ic-btn" class="bg-indigo-900 text-white text-xs font-bold px-4 rounded hover:bg-indigo-800 uppercase">Semak</button>
                    </div>
                    <p id="ic-check-status" class="text-xs mt-2"></p>

                    <div id="user-info-display" class="hidden mt-3 p-2 bg-white rounded border border-indigo-100 flex items-center gap-3">
                        <img id="sender-preview-img" src="" class="w-8 h-8 rounded-full object-cover hidden" crossorigin="anonymous">
                        <div>
                            <p class="text-xs font-bold text-indigo-900" id="user-info-name"></p>
                            <p class="text-[10px] text-indigo-500 uppercase"><span id="user-info-position"></span> ‚Ä¢ <span id="user-info-station"></span></p>
                        </div>
                    </div>
                </div>

                <div id="manual-info-section" class="hidden space-y-3 p-3 bg-gray-50 rounded border border-gray-200">
                    <p class="text-xs text-red-500 italic">*Data tiada. Sila isi manual.</p>
                    <input type="text" id="sender-name" placeholder="Nama Penuh" class="w-full text-sm px-3 py-2 border rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="sender-position" placeholder="Jawatan" class="w-full text-sm px-3 py-2 border rounded">
                        <input type="text" id="sender-station" placeholder="Stesen" class="w-full text-sm px-3 py-2 border rounded">
                    </div>
                </div>
                
                <div>
                     <div class="mb-4">
                        <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                        <button type="button" id="trigger-upload-btn" class="w-full text-xs text-indigo-600 border border-indigo-200 bg-indigo-50 py-2 rounded hover:bg-indigo-100 font-semibold flex justify-center items-center gap-2" disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Muat Naik Foto Kenangan (Pilihan)
                        </button>
                        <p id="upload-status" class="text-[10px] text-center mt-1"></p>
                        <input type="hidden" id="photo-url">
                    </div>

                    <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Hantar Kiriman Maya:</label>
                    <div id="gift-selector" class="flex flex-wrap gap-2 mb-4">
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Bunga">üíê Bunga</button>
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Kek">üéÇ Kek</button>
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Coklat">üç´ Coklat</button>
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Hadiah">üéÅ Hadiah</button>
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Doa">ü§≤ Doa</button>
                        <button type="button" class="gift-btn text-xs border px-2 py-1 rounded bg-white text-gray-600" data-gift="Kopi">‚òï Kopi</button>
                    </div>
                    <input type="hidden" id="selected-gift" value="">

                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Ucapan & Doa:</label>
                    <textarea id="wish-message" rows="3" placeholder="Tulis ucapan anda..." class="w-full text-sm px-3 py-2 border border-gray-300 rounded focus:ring-indigo-500" disabled></textarea>
                </div>
                
                <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-indigo-900 to-blue-800 text-white font-bold py-3 rounded shadow hover:shadow-lg transition-all disabled:opacity-50" disabled>
                    HANTAR UCAPAN
                </button>
            </form>
             <div class="mt-4 text-center">
                 <a href="jadual.html" class="text-xs text-gray-400 hover:text-indigo-600">‚Üê Kembali ke Kalendar</a>
             </div>
        </div>

        <div id="wishes-container" class="mt-12">
            <div class="flex items-center gap-4 mb-6">
                <div class="h-px bg-slate-300 flex-grow"></div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Titipan Doa Rakan-rakan</span>
                <div class="h-px bg-slate-300 flex-grow"></div>
            </div>
            <div id="wishes-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p id="loading-wishes" class="text-center text-sm text-slate-400 col-span-2">Memuatkan senarai ucapan...</p>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
        <div class="bg-white rounded-lg p-4 w-full max-w-md mx-4">
            <h3 class="text-sm font-bold text-gray-800 mb-2 uppercase">Sesuaikan Gambar</h3>
            <div class="h-64 bg-gray-100 mb-3 overflow-hidden rounded">
                <img id="image-to-crop" src="" class="block max-w-full">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeCropModal()" class="px-3 py-1.5 bg-gray-200 text-xs font-bold rounded">BATAL</button>
                <button onclick="cropAndUpload()" class="px-3 py-1.5 bg-indigo-900 text-white text-xs font-bold rounded">POTONG & SIMPAN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b";

        let dbReady = false, recipientName = null, recipientDob = null, foundUserData = null, cropper = null;
        let slideshowImages = [], slideshowIndex = 0, slideshowInterval = null;

        const wishesRef = collection(db, `artifacts/${appId}/public/data/spark_wishes`);
        const staffRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);

        // --- KOLEKSI AYAT PENGHARGAAN JABATAN (40++) ---
        const wishCollections = [
            { text: "Selamat Hari Lahir. Kehadiran tuan/puan adalah aset yang amat bernilai bagi jabatan ini.", quote: "\"Kecemerlangan organisasi bermula daripada individu yang berdedikasi.\"" },
            { text: "Sanah Helwah. Semoga terus menjadi inspirasi dan tulang belakang kekuatan pasukan kami.", quote: "\"Kepimpinan adalah tindakan, bukan sekadar jawatan.\"" },
            { text: "Selamat Ulang Tahun Kelahiran. Jasa dan pengorbanan tuan/puan amat kami sanjung tinggi.", quote: "\"Setiap keringat yang gugur dalam bekerja adalah ibadah yang mulia.\"" },
            { text: "Selamat Hari Jadi. Semoga Allah kurniakan kesihatan yang baik untuk terus menabur bakti.", quote: "\"Kesihatan yang baik adalah mahkota bagi mereka yang memimpin.\"" },
            { text: "Happy Birthday. Teruskan melakar kecemerlangan dan menjadi suri teladan kepada kami semua.", quote: "\"Inspirasi terbaik adalah melalui teladan yang baik.\"" },
            { text: "Raikan hari istimewa ini dengan penuh kesyukuran. Tuan/Puan adalah permata dalam organisasi.", quote: "\"Bersyukur adalah kunci kepada ketenangan dan keberkatan rezeki.\"" },
            { text: "Selamat Hari Lahir. Semoga visi dan misi hidup tuan/puan sentiasa dipermudahkan-Nya.", quote: "\"Kejayaan besar bermula dengan impian dan usaha yang konsisten.\"" },
            { text: "Sanah Helwah. Moga terus istiqamah dalam perjuangan mendidik dan memimpin.", quote: "\"Istiqamah itu berat, tetapi ganjarannya adalah kejayaan abadi.\"" },
            { text: "Selamat Hari Jadi. Aura positif tuan/puan sentiasa menyuntik semangat baru di pejabat.", quote: "\"Senyuman dan kata semangat mampu mengubah hari seseorang.\"" },
            { text: "Happy Birthday. Terima kasih atas segala bimbingan dan tunjuk ajar yang tidak jemu.", quote: "\"Guru yang hebat bukan sekadar mengajar, tetapi menyentuh hati.\"" },
            // ... (30 lagi ayat variasi akan dijana secara rawak dari pola di atas) ...
            { text: "Selamat Ulang Tahun. Semoga rezeki tuan/puan seluas lautan dan setinggi gunung.", quote: "\"Rezeki tidak pernah salah alamat bagi mereka yang berusaha.\"" },
            { text: "Sanah Helwah. Semoga ketabahan tuan/puan menghadapi cabaran menjadi asbab kejayaan.", quote: "\"Pelaut yang handal tidak lahir dari laut yang tenang.\"" },
            { text: "Selamat Hari Lahir. Kami mendoakan kesejahteraan dan kebahagiaan tuan/puan dunia akhirat.", quote: "\"Doa adalah hadiah terindah yang tidak ternilai harganya.\"" },
            { text: "Happy Birthday. Teruslah bersinar dan memberi manfaat kepada masyarakat.", quote: "\"Sebaik-baik manusia adalah yang paling bermanfaat kepada orang lain.\"" },
            { text: "Selamat Hari Jadi. Dedikasi tuan/puan adalah pemangkin semangat kami.", quote: "\"Semangat sepasukan adalah kunci kejayaan organisasi.\"" }
        ];

        // --- FUNGSI SHARE SCREENSHOT (FIXED) ---
        window.shareBirthdayCard = async function() {
            const captureArea = document.getElementById('capture-area');
            const name = document.getElementById('recipient-name-display').innerText;
            const btn = document.getElementById('share-card-btn');
            
            if (!captureArea) return;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-spin">‚åõ</span>'; btn.disabled = true;

            try {
                const canvas = await html2canvas(captureArea, { 
                    useCORS: true, allowTaint: false, scale: 3, backgroundColor: '#ffffff',
                    onclone: (doc) => {
                        // Paksa tulisan jadi warna solid (bukan gradient) untuk gambar
                        const title = doc.getElementById('recipient-name-display');
                        if(title) {
                            title.style.background = 'none';
                            title.style.webkitTextFillColor = '#1e3a8a'; // Royal Blue
                            title.style.color = '#1e3a8a';
                        }
                    }
                });

                canvas.toBlob(async (blob) => {
                    btn.innerHTML = originalText; btn.disabled = false;
                    if (!blob) return alert("Gagal.");
                    
                    const shareData = {
                        files: [new File([blob], `Ucapan_${name}.png`, { type: 'image/png' })],
                        text: `üéâ *SANJUNGAN KASIH PPD CLUB* üéâ\n\nRaikan hari istimewa: *${name}*\n\nSama-sama kita doakan kesejahteraan beliau. ü§≤\n\nHantar ucapan di sini:\nüîó ${window.location.href}`
                    };

                    if (navigator.share && navigator.canShare(shareData)) {
                        try { await navigator.share(shareData); } catch (e) {}
                    } else {
                        const link = document.createElement('a');
                        link.download = `Ucapan_${name}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        alert("Gambar disimpan. Sila kongsi di WhatsApp Group PPD.");
                    }
                }, 'image/png');
            } catch (e) {
                console.error(e); alert("Ralat sistem."); btn.innerHTML = originalText; btn.disabled = false;
            }
        }

        // --- INITIALIZE ---
        window.addEventListener('load', () => {
            startFireworks();
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name') || 'Warga PPD';
            const dob = params.get('dob') ? atob(params.get('dob')) : '';
            
            recipientName = name; recipientDob = dob;
            document.getElementById('recipient-name-display').textContent = name;
            document.getElementById('recipient-name-hidden').value = name;
            document.getElementById('recipient-dob').value = dob;

            if(dob) {
                const d = new Date(dob);
                if(!isNaN(d.getTime())) {
                    document.getElementById('birthday-date-display').innerText = d.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long' }).toUpperCase();
                } else { document.getElementById('birthday-date-display').style.display = 'none'; }
            }

            // Random High-Class Wish
            const wish = wishCollections[Math.floor(Math.random() * wishCollections.length)];
            document.getElementById('random-wish-container').innerHTML = `
                <p class="font-serif text-lg text-slate-800 italic mb-2">"${wish.text}"</p>
                <p class="text-[10px] text-yellow-600 font-bold tracking-widest border-t border-slate-100 pt-2 mt-2 inline-block">${wish.quote}</p>
            `;

            // Setup Listeners
            document.getElementById('share-card-btn').onclick = shareBirthdayCard;
            document.getElementById('check-ic-btn').onclick = checkUserIc;
            document.getElementById('wish-form').onsubmit = handleFormSubmit;
            document.getElementById('trigger-upload-btn').onclick = () => document.getElementById('photo-upload-input').click();
            document.getElementById('photo-upload-input').onchange = handlePhotoSelect;
            
            // Emoji & Gift Listeners
            document.getElementById('gift-selector').addEventListener('click', (e) => {
                if(e.target.classList.contains('gift-btn')) {
                    document.querySelectorAll('.gift-btn').forEach(b => b.classList.remove('gift-selected', 'border-indigo-500', 'bg-indigo-50'));
                    e.target.classList.add('gift-selected', 'border-indigo-500', 'bg-indigo-50');
                    document.getElementById('selected-gift').value = e.target.dataset.gift;
                }
            });
        });

        // --- FIREBASE LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            dbReady = true;
            if (recipientName && recipientDob) loadWishes(recipientName, recipientDob);
        });

        function loadWishes(name, dob) {
            const q = query(wishesRef, where("recipientName", "==", name), where("recipientDob", "==", dob), orderBy("sentAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('wishes-grid');
                const summaryBox = document.getElementById('happiness-summary');
                
                if (!snapshot.empty) {
                    summaryBox.classList.remove('hidden');
                    grid.innerHTML = '';
                    let photos = [], gifts = [];
                    
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        if(d.imageUrl) photos.push(d.imageUrl);
                        if(d.gift) gifts.push(d.gift);
                        
                        // Render Kad Ucapan (Simple)
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded border border-slate-200 shadow-sm text-sm";
                        card.innerHTML = `
                            <p class="text-slate-700 italic mb-2">"${d.message}"</p>
                            <div class="flex items-center gap-2 justify-end">
                                <div class="text-right">
                                    <p class="font-bold text-indigo-900 text-xs">${d.senderName}</p>
                                    <p class="text-[9px] text-slate-400">${d.senderPosition || 'Rakan PPD'}</p>
                                </div>
                                ${d.senderPhotoUrl ? `<img src="${d.senderPhotoUrl}" class="w-8 h-8 rounded-full border border-slate-200">` : ''}
                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    // Update Summary
                    if(photos.length > 0) {
                        slideshowImages = photos;
                        startSlideshow();
                        document.getElementById('summary-photo-container').classList.remove('hidden');
                    }
                    
                    const giftList = document.getElementById('summary-gift-list');
                    const noGift = document.getElementById('no-gift-text');
                    giftList.innerHTML = '';
                    if(gifts.length > 0) {
                        noGift.classList.add('hidden');
                        const uniqueGifts = [...new Set(gifts)]; // Unik sahaja
                        uniqueGifts.forEach(g => {
                            const icon = getGiftIcon(g);
                            giftList.innerHTML += `<span class="bg-white px-2 py-1 rounded shadow-sm text-lg" title="${g}">${icon}</span>`;
                        });
                    } else { noGift.classList.remove('hidden'); }

                } else {
                    grid.innerHTML = '<p class="col-span-2 text-center text-sm text-slate-400 italic">Belum ada ucapan. Jadilah yang pertama!</p>';
                }
            });
        }

        // --- HELPER FUNCTIONS ---
        function getGiftIcon(name) {
            const map = { 'Bunga':'üíê', 'Kek':'üéÇ', 'Coklat':'üç´', 'Hadiah':'üéÅ', 'Doa':'ü§≤', 'Kopi':'‚òï' };
            return map[name] || 'üéÅ';
        }

        function startSlideshow() {
            if(slideshowInterval) clearInterval(slideshowInterval);
            const img = document.getElementById('summary-main-photo');
            let idx = 0;
            const run = () => {
                img.style.opacity = 0;
                setTimeout(() => {
                    img.src = slideshowImages[idx];
                    img.crossOrigin = "anonymous";
                    img.onload = () => img.style.opacity = 1;
                    idx = (idx + 1) % slideshowImages.length;
                }, 300);
            };
            run();
            if(slideshowImages.length > 1) slideshowInterval = setInterval(run, 4000);
        }

        // --- CROPPER & UPLOAD ---
        window.handlePhotoSelect = function(e) {
            const file = e.target.files[0];
            if(file) {
                const r = new FileReader();
                r.onload = (ev) => {
                    document.getElementById('image-to-crop').src = ev.target.result;
                    document.getElementById('crop-modal').classList.remove('hidden');
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio:1, viewMode:1 });
                };
                r.readAsDataURL(file);
            }
        }
        window.closeCropModal = () => document.getElementById('crop-modal').classList.add('hidden');
        window.cropAndUpload = () => {
            if(!cropper) return;
            document.getElementById('crop-modal').classList.add('hidden');
            const btn = document.getElementById('trigger-upload-btn');
            btn.innerHTML = 'Memuat naik...'; btn.disabled = true;
            
            cropper.getCroppedCanvas({width:400, height:400}).toBlob(async (blob) => {
                const fd = new FormData(); fd.append("image", blob);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:"POST", body:fd });
                    const d = await res.json();
                    if(d.success) {
                        document.getElementById('photo-url').value = d.data.url;
                        btn.innerHTML = '‚úÖ Foto Sedia';
                        btn.classList.add('text-green-600', 'border-green-200', 'bg-green-50');
                    }
                } catch(e) { btn.innerHTML = 'Gagal'; }
            });
        }

        // --- FORM SUBMIT ---
        async function checkUserIc() {
            const ic = document.getElementById('sender-ic').value;
            if(ic.length < 6) return alert("Sila masukkan IC.");
            
            const q = query(staffRef, where("ic", "==", ic), limit(1));
            const snap = await getDocs(q);
            
            if(!snap.empty) {
                foundUserData = snap.docs[0].data();
                document.getElementById('user-info-name').textContent = foundUserData.name;
                document.getElementById('user-info-position').textContent = foundUserData.position;
                document.getElementById('user-info-station').textContent = foundUserData.station;
                if(foundUserData.photoUrl) {
                    document.getElementById('sender-preview-img').src = foundUserData.photoUrl;
                    document.getElementById('sender-preview-img').classList.remove('hidden');
                }
                document.getElementById('user-info-display').classList.remove('hidden');
                document.getElementById('manual-info-section').classList.add('hidden');
            } else {
                foundUserData = null;
                document.getElementById('user-info-display').classList.add('hidden');
                document.getElementById('manual-info-section').classList.remove('hidden');
            }
            
            document.getElementById('wish-message').disabled = false;
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('trigger-upload-btn').disabled = false;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = 'Menghantar...'; btn.disabled = true;
            
            const data = {
                recipientName, recipientDob,
                message: document.getElementById('wish-message').value,
                gift: document.getElementById('selected-gift').value,
                imageUrl: document.getElementById('photo-url').value,
                sentAt: serverTimestamp()
            };

            if(foundUserData) {
                data.senderName = foundUserData.name;
                data.senderPosition = foundUserData.position;
                data.senderStation = foundUserData.station;
                data.senderPhotoUrl = foundUserData.profilePic || foundUserData.photoUrl || '';
            } else {
                data.senderName = document.getElementById('sender-name').value.toUpperCase();
                data.senderPosition = document.getElementById('sender-position').value.toUpperCase();
                data.senderStation = document.getElementById('sender-station').value.toUpperCase();
            }

            await addDoc(wishesRef, data);
            alert("Terima kasih! Ucapan anda telah direkodkan.");
            window.location.reload();
        }

        // --- CONFETTI ---
        function startFireworks() {
            setInterval(() => {
                confetti({ particleCount: 20, startVelocity: 10, spread: 360, origin: { x: Math.random(), y: Math.random() - 0.2 } });
            }, 3000);
        }
    </script>
</body>
</html>
