<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">SPARK - Kemasukan Data Standard 3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Gaya asas */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .score-input {
            width: 80px;
            text-align: center;
            padding: 6px 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .score-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
            outline: none;
        }
        .header-cell { padding: 12px 16px; font-weight: 600; }
        .data-cell { padding: 10px 16px; font-size: 0.875rem; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-screen-xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div><h1 class="text-xl font-bold text-indigo-600">SPARK</h1><p class="text-xs text-gray-500">Kemasukan Data Sekolah</p></div>
            </div>
             <div class="flex items-center space-x-3">
                <a href="school_data.html" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 text-sm">Kembali ke Senarai Sekolah</a>
            </div>
        </div>
    </header>
    <main class="max-w-screen-xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div class="p-4 md:p-8 bg-white shadow-xl rounded-xl">
             <header class="mb-6 pb-4 border-b border-indigo-200">
                <h1 class="text-3xl font-extrabold text-indigo-800">Standard 3.1: Pengurusan Kurikulum</h1>
                <p class="text-lg font-semibold text-gray-700 mt-2">Sekolah: <span id="school-display-name" class="text-indigo-600">Memuatkan...</span></p>
                <div id="metadata-display" class="text-xs text-gray-500 mt-1">
                    <p id="last-update-info">Tarikh Kemaskini Terakhir: Tiada Rekod</p>
                </div>
            </header>

            <div class="mb-6 p-4 border border-blue-300 bg-blue-50 rounded-lg">
                <label for="user-input-name" class="block text-sm font-medium text-blue-800 mb-1">Nama Penuh / ID Pengguna (Wajib Sebelum Simpan)</label>
                <input type="text" id="user-input-name" placeholder="Contoh: En. Ahmad / 740101135050" 
                       class="w-full sm:w-80 px-4 py-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm"
                       oninput="checkFormValidity()">
            </div>

            <div id="loading-spinner" class="text-center p-8 text-indigo-500">
                <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Memuatkan struktur dan data sekolah...</p>
            </div>

            <div id="content-container" class="hidden">
                 <form id="score-form">
                    <table class="min-w-full border-collapse rounded-lg overflow-hidden border border-gray-200 shadow-sm">
                        <thead class="bg-indigo-600 text-white">
                            <tr>
                                <th class="header-cell w-1/12 border-r border-indigo-500">Aspek</th>
                                <th class="header-cell w-6/12 border-r border-indigo-500 text-left">Keterangan</th>
                                <th class="header-cell w-1/12 border-r border-indigo-500 text-center">Tindakan</th>
                                <th class="header-cell w-1/12 text-center">2024 (TOV)</th>
                                <th class="header-cell w-1/12 text-center">2025 (ETR)</th>
                            </tr>
                        </thead>
                        <tbody id="template-list-body" class="divide-y divide-gray-200">
                            </tbody>
                        <tfoot id="total-row-container">
                            </tfoot>
                    </table>
                </form>

                <div class="mt-8 pt-4 border-t border-gray-300 flex justify-end">
                    <button id="save-all-btn" class="btn bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" onclick="saveAllScores()" disabled>
                        <svg class="w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg>
                        Simpan Keseluruhan Data Sekolah
                    </button>
                </div>
            </div>

        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Sistem Pengurusan Data SPARK</p>
        <p class="text-xs text-gray-500">Versi Standard 3.1 (Kemasukan Data)</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase (Guna konfigurasi dari fail data.html)
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // Koleksi Data
        const templateCollectionRef = collection(db, `artifacts/${appId}/public/data/spark_edu_template`);
        const recordsCollectionPath = `artifacts/${appId}/public/data/spark_edu_records`; // Koleksi BARU untuk skor sekolah
        const recordsCollectionRef = collection(db, recordsCollectionPath);

        let schoolName = '';
        let templateData = [];
        let localScores = {}; // Struktur skor yang diubah suai secara lokal
        let recordDocId = ''; // ID dokumen Firestore untuk rekod sekolah ini

        // --- INISIALISASI PENTING ---
        function getSchoolFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const school = urlParams.get('sekolah');
            
            if (!school) {
                document.getElementById('school-display-name').textContent = 'RALAT: Nama Sekolah Tidak Ditemui dalam URL.';
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('content-container').classList.remove('hidden');
                alert('Sila akses halaman ini melalui pautan dari senarai sekolah (school_data.html).');
                return null;
            }
            
            schoolName = decodeURIComponent(school);
            document.getElementById('school-display-name').textContent = schoolName;
            
            // Format ID Dokumen: [NamaTemplate]_[NamaSekolahDibersihkan]
            const cleanedSchoolName = schoolName.trim().toUpperCase().replace(/[^A-Z0-9]/g, '_');
            // Hardcode template ID:
            const templateId = 'Standard3.1'; 
            recordDocId = `${templateId}_${cleanedSchoolName}`;

            document.title = `SPARK - Standard 3.1: ${schoolName}`;
            
            return schoolName;
        }

        // --- AUTENTIKASI ---
        function authenticateAndLoad() {
             onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Gagal daftar masuk tanpa nama:", error);
                    }
                }
                // Setelah disahkan, mulakan muatan data
                if (getSchoolFromUrl()) {
                    loadDataListeners();
                }
            });
        }
        
        // --- DATA LISTENERS ---
        function loadDataListeners() {
            // 1. Dapatkan Struktur Template (Standard 3.1.1, 3.1.2, etc.)
            const qTemplate = query(templateCollectionRef, orderBy("order", "asc"));
            onSnapshot(qTemplate, (snapshot) => {
                templateData = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                // Muat semula paparan apabila template berubah
                renderTemplateTable();
            }, (error) => {
                console.error("Ralat memuatkan data template:", error);
            });

            // 2. Dapatkan Rekod Skor Sekolah Semasa
            const docRef = doc(recordsCollectionRef, recordDocId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().scores) {
                    // Muatkan skor yang telah disimpan ke dalam localScores
                    localScores = docSnap.data().scores;
                    
                    // Paparkan Metadata Kemaskini
                    const metaData = docSnap.data();
                    let updateInfo = 'Tiada Rekod';
                    if (metaData.lastUpdatedBy && metaData.lastUpdatedTimestamp) {
                        const date = metaData.lastUpdatedTimestamp.toDate();
                        const formattedDate = date.toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        updateInfo = `Dikemaskini oleh: ${metaData.lastUpdatedBy} pada ${formattedDate}`;
                    }
                    document.getElementById('last-update-info').textContent = `Tarikh Kemaskini Terakhir: ${updateInfo}`;
                    
                } else {
                    localScores = {}; // Reset jika tiada data
                    document.getElementById('last-update-info').textContent = 'Tarikh Kemaskini Terakhir: Tiada Rekod';
                }
                renderTemplateTable(); // Muat semula untuk memaparkan skor yang baru dimuat
                
                // Sembunyikan spinner
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('content-container').classList.remove('hidden');
            }, (error) => {
                console.error("Ralat memuatkan rekod sekolah:", error);
            });
        }

        // --- RENDER TABLE ---
        function renderTemplateTable() {
            const listBody = document.getElementById('template-list-body');
            let htmlContent = '';
            let totalTOV = 0;
            let totalETR = 0;
            let itemCount = 0;

            templateData.forEach(item => {
                if (item.id === 'header') return; // Abaikan item header

                const currentScores = localScores[item.id] || { score_2024_tov: 0.00, score_2025_etr: 0.00 };
                
                const tovScore = currentScores.score_2024_tov || 0.00;
                const etrScore = currentScores.score_2025_etr || 0.00;

                totalTOV += parseFloat(tovScore);
                totalETR += parseFloat(etrScore);
                itemCount++;

                htmlContent += `
                    <tr class="hover:bg-gray-50 align-top">
                        <td class="data-cell w-1/12 font-semibold text-gray-800">${item.id}</td>
                        <td class="data-cell w-6/12 text-gray-600">
                            ${(item.keterangan || []).map(desc => `
                                <div class="mb-1">${desc}</div>
                            `).join('')}
                        </td>
                        <td class="data-cell w-1/12 text-center text-sm">
                            ${(item.tindakan || []).map(action => `
                                <p class="text-xs text-indigo-500 my-1">${action}</p>
                            `).join('')}
                        </td>
                        
                        <td class="data-cell w-1/12 text-center">
                            <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2024_tov"
                                   value="${tovScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input text-gray-700"
                            />
                        </td>
                        
                        <td class="data-cell w-1/12 text-center">
                             <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2025_etr"
                                   value="${etrScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input font-bold text-indigo-600"
                            />
                        </td>
                    </tr>
                `;
            });

            listBody.innerHTML = htmlContent;
            renderTotalRow(totalTOV, totalETR, itemCount);
            checkFormValidity(); // Semak semula butang simpan selepas render
        }

        // --- RENDER BARIS PURATA ---
        function renderTotalRow(totalTOV, totalETR, count) {
            const tfoot = document.getElementById('total-row-container');
            const avgTOV = count > 0 ? (totalTOV / count) : 0;
            const avgETR = count > 0 ? (totalETR / count) : 0;

            tfoot.innerHTML = `
                <tr class="bg-indigo-50 font-extrabold text-lg text-indigo-800 border-t-4 border-indigo-400">
                    <td class="data-cell text-center" colspan="3">Purata Keseluruhan:</td>
                    <td class="data-cell text-center">${avgTOV.toFixed(2)}</td>
                    <td class="data-cell text-center">${avgETR.toFixed(2)}</td>
                </tr>
            `;
        }


        // --- LOGIK KEMAS KINI LOKAL DAN SIMPAN ---

        // Fungsi yang mengemaskini skor dalam objek lokal (tidak terus ke Firebase)
        function updateLocalScore(id, fieldName, value) {
            const numericValue = parseFloat(value);
            
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 100) {
                console.error("Nilai skor tidak sah.");
                alert("Nilai skor mesti antara 0.00 hingga 100.00.");
                return;
            }
            
            // Pastikan item wujud dalam localScores
            if (!localScores[id]) {
                localScores[id] = { score_2024_tov: 0.00, score_2025_etr: 0.00 };
            }
            
            // Kemaskini skor lokal
            localScores[id][fieldName] = numericValue;

            // Muat semula baris purata sahaja
            let totalTOV = 0;
            let totalETR = 0;
            let itemCount = 0;

            for (const id in localScores) {
                if (localScores.hasOwnProperty(id)) {
                    totalTOV += localScores[id].score_2024_tov || 0;
                    totalETR += localScores[id].score_2025_etr || 0;
                    itemCount++;
                }
            }
            
            // Ambil kira item dari template yang mungkin belum ada skor, untuk purata yang betul
            const relevantItemsCount = templateData.filter(item => item.id !== 'header').length;
            renderTotalRow(totalTOV, totalETR, relevantItemsCount);
        }

        // Fungsi untuk menyemak sama ada butang simpan boleh diaktifkan
        function checkFormValidity() {
            const userNameInput = document.getElementById('user-input-name');
            const saveBtn = document.getElementById('save-all-btn');
            
            if (userNameInput.value.trim().length > 3) {
                saveBtn.disabled = false;
                userNameInput.classList.remove('border-blue-300');
                userNameInput.classList.add('border-green-500');
            } else {
                saveBtn.disabled = true;
                userNameInput.classList.remove('border-green-500');
                userNameInput.classList.add('border-blue-300');
            }
        }

        // Fungsi Simpan Keseluruhan ke Firestore
        async function saveAllScores() {
            const userName = document.getElementById('user-input-name').value.trim();
            const saveBtn = document.getElementById('save-all-btn');

            if (!userName) {
                alert('Sila masukkan Nama Penuh atau ID Pengguna anda sebelum menyimpan.');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const docRef = doc(recordsCollectionRef, recordDocId);
            
            const dataToSave = {
                schoolName: schoolName,
                scores: localScores, // Simpan semua skor lokal
                lastUpdatedBy: userName,
                lastUpdatedTimestamp: serverTimestamp() // Set cap masa server
            };

            try {
                await setDoc(docRef, dataToSave, { merge: true });
                alert(`Data Standard 3.1 bagi ${schoolName} berjaya dikemaskini oleh ${userName}!`);
                
                // Kemaskini paparan metadata
                document.getElementById('last-update-info').textContent = `Tarikh Kemaskini Terakhir: Sedang Mengemaskini (tunggu kemas kini Firestore)`;

            } catch (e) {
                console.error("Ralat menyimpan data: ", e);
                alert(`Gagal menyimpan data. Sila cuba lagi. ${e.message}`);
            } finally {
                saveBtn.textContent = 'Simpan Keseluruhan Data Sekolah';
                checkFormValidity(); // Semak semula keadaan butang
            }
        }
        
        // --- INISIALISASI ---
        authenticateAndLoad();
        
        // --- DEDAHKAN FUNGSI KE WINDOW ---
        Object.assign(window, {
            updateLocalScore,
            saveAllScores,
            checkFormValidity
        });
    </script>
</body>
</html>
