<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">SparkEdu - Pengurusan Kurikulum Pendidikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Gaya asas dan animasi */
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Gaya untuk konten utama */
        #kurikulum-content { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .data-table {
            min-width: 1400px; 
            width: 100%;
        }
        .data-cell {
            vertical-align: top;
            padding: 8px 12px;
            text-align: left;
        }
        .score-cell {
            text-align: center;
            width: 70px;
        }
        .score-input, .text-input {
            width: 100%;
            text-align: center;
            padding: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            /* Saiz Font untuk input skor diseragamkan */
            font-size: 0.875rem; 
        }
        .score-input:focus, .text-input:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        /* Custom styles for list rendering (KETERANGAN menggunakan a), b) */
        ol.list-alpha-keterangan {
            list-style-type: lower-alpha;
            padding-left: 20px !important; 
            margin-left: 0 !important;
        }
        ol.list-alpha-keterangan li {
            list-style-position: outside;
            margin-left: 0; 
            padding-left: 0;
        }
        ol.list-decimal.p-0.m-0 {
            padding-left: 20px !important; 
            margin-left: 0 !important;
        }
        ol.list-decimal.p-0.m-0 li {
            list-style-position: outside;
            margin-left: 0; 
            padding-left: 0;
        }

        /* Gaya untuk data yang TIDAK boleh diedit (paparan) */
        .read-only-text {
            font-size: 0.875rem;
            color: #1f2937;
            padding: 2px 0;
            display: block;
        }
        .read-only-list-item {
             margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div><h1 class="text-2xl font-bold text-indigo-600">SparkEdu</h1><p class="text-sm text-gray-500">Kemasukan Data Kurikulum Sekolah</p></div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 </div>
        </div>
    </header>
    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="ic-validation-section" class="max-w-lg mx-auto p-8 bg-white shadow-lg rounded-xl mt-12 hidden">
             <h2 class="text-2xl font-bold text-red-700 mb-4">Ralat Akses</h2>
             <p class="text-gray-600 mb-6">Sila pastikan anda mengakses halaman ini melalui pautan yang mengandungi ID Sekolah. Cth: `sparkeduisi.html?sekolah=SMKLUTONG`</p>
        </div>
        
        <div id="kurikulum-content" class="p-4 md:p-8 hidden">
             <div id="permission-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg shadow-md" role="alert">
                <p class="font-bold">Amaran Keizinan Firebase!</p>
                <p class="text-sm">Gagal memuatkan atau menyimpan data. Sila hubungi pentadbir untuk melonggarkan Peraturan Keselamatan Firestore bagi koleksi `public/data/*`.</p>
            </div>
            <div class="max-w-7xl mx-auto">
                <header class="mb-6 pb-4 border-b border-blue-200">
                    <h1 class="text-3xl font-extrabold text-blue-800" id="main-title">Standard 3.1: Pengurusan Kurikulum</h1>
                    <p class="text-lg font-semibold text-gray-700 mt-2">Sekolah: <span id="school-display-name" class="text-indigo-600">Memuatkan...</span></p>
                    <div id="metadata-display" class="text-sm text-gray-600 mt-1">
                        <p id="last-update-info">Tarikh Kemaskini Terakhir: Tiada Rekod</p>
                    </div>
                </header>
                
                <div id="save-controls" class="mb-6 p-4 border border-blue-300 bg-blue-50 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0">
                    <div class="w-full md:w-1/2">
                        <label for="user-input-name" class="block text-sm font-medium text-blue-800 mb-1">Nama Penuh / ID Pengguna (Wajib Sebelum Simpan)</label>
                        <input type="text" id="user-input-name" placeholder="Contoh: En. Ahmad / 740101135050" 
                               class="w-full px-4 py-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm"
                               oninput="checkFormValidity()">
                    </div>
                    <button id="save-all-btn" class="btn bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto" onclick="saveAllScores()" disabled>
                        <svg class="w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg>
                        Simpan Keseluruhan Data
                    </button>
                </div>


                <div id="loading-spinner" class="text-center p-8 text-blue-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Memuatkan data...</p>
                </div>

                <div class="scroll-container bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="data-table border-collapse" id="kurikulum-table">
                        <thead class="bg-blue-600 text-white sticky top-0" id="table-header">
                            </thead>
                        <tbody id="table-body">
                            </tbody>
                        <tfoot id="table-footer">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Dibangunkan oleh Pahan</p>
        <p id="version-info" class="text-xs text-gray-500">Sistem Pengurusan Data SPARK - Standard 3.1</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase (Guna konfigurasi sedia ada)
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // Koleksi Data
        const TEMPLATE_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_template`; 
        const RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_edu_records`; // Koleksi BARU
        const HEADER_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_headers`; 

        const templateCollectionRef = collection(db, TEMPLATE_COLLECTION_PATH);
        const recordsCollectionRef = collection(db, RECORDS_COLLECTION_PATH);
        const headerCollectionRef = collection(db, HEADER_COLLECTION_PATH);

        let schoolName = '';
        let recordDocId = ''; 
        let templateData = [];
        let headerTexts = {};
        let localScores = {}; // Struktur skor yang diubah suai secara lokal

        // --- UTILITY ---
        function getSchoolFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const school = urlParams.get('sekolah');
            
            if (!school) {
                document.getElementById('kurikulum-content').classList.add('hidden');
                document.getElementById('ic-validation-section').classList.remove('hidden');
                return null;
            }
            
            schoolName = decodeURIComponent(school);
            document.getElementById('school-display-name').textContent = schoolName;
            
            const cleanedSchoolName = schoolName.trim().toUpperCase().replace(/[^A-Z0-9]/g, '_');
            const templateId = 'Standard3.1'; 
            recordDocId = `${templateId}_${cleanedSchoolName}`;

            document.getElementById('kurikulum-content').classList.remove('hidden');
            return schoolName;
        }

        // --- AUTENTIKASI & INITIALISASI ---
        function authenticateAndLoad() {
             onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Gagal daftar masuk tanpa nama:", error);
                    }
                }
                
                if (getSchoolFromUrl()) {
                    loadDataListeners();
                }
            });
        }
        
        function loadDataListeners() {
            // 1. Dapatkan Headers (Untuk tajuk lajur)
            const headerRef = doc(headerCollectionRef, 'template_headers');
            onSnapshot(headerRef, (docSnap) => {
                headerTexts = docSnap.exists() ? docSnap.data().texts : {
                     aspek: 'Aspek', description: 'Keterangan', score_2022: '2022', score_2023: '2023', score_2024_tov: '2024 (TOV)', score_2025_etr: '2025 (ETR)', tindakan: 'Tindakan', follow_up: 'Follow Up / Pendokumentasian'
                };
                renderTableHeader();
            }, (error) => { console.error("Ralat memuatkan headers:", error); });


            // 2. Dapatkan Struktur Template
            const qTemplate = query(templateCollectionRef); // Tiada orderBy kerana template sepatutnya sudah disusun
            onSnapshot(qTemplate, (snapshot) => {
                templateData = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                // Sort template data based on ID for predictable rendering
                templateData.sort((a, b) => a.id.localeCompare(b.id)); 
                renderTemplateTable();
            }, (error) => { console.error("Ralat memuatkan data template:", error); });


            // 3. Dapatkan Rekod Skor Sekolah Semasa
            const docRef = doc(recordsCollectionRef, recordDocId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Muatkan skor yang telah disimpan ke dalam localScores
                    localScores = data.scores || {};
                    
                    // Paparkan Metadata Kemaskini
                    const updateInfo = formatMetadata(data.lastUpdatedBy, data.lastUpdatedTimestamp);
                    document.getElementById('last-update-info').textContent = `Tarikh Kemaskini Terakhir: ${updateInfo}`;
                    
                } else {
                    localScores = {}; // Reset jika tiada data
                    document.getElementById('last-update-info').textContent = 'Tarikh Kemaskini Terakhir: Tiada Rekod';
                }
                renderTemplateTable(); 
                
                document.getElementById('loading-spinner').classList.add('hidden');
            }, (error) => { console.error("Ralat memuatkan rekod sekolah:", error); });
        }

        // --- RENDER HEADER ---
        function renderTableHeader() {
            const thead = document.getElementById('table-header');
            const headers = [
                // Mengikut susunan template
                { key: 'aspek', class: 'w-1/8' },
                { key: 'description', class: 'w-2/8' }, // Keterangan dan Tindakan dijadikan Read-only
                { key: 'tindakan', class: 'w-2/8' },
                { key: 'follow_up', class: 'w-2/8' },
                { key: 'score_2024_tov', class: 'score-cell' },
                { key: 'score_2025_etr', class: 'score-cell' }
            ];

            thead.innerHTML = `
                <tr class="bg-blue-600 text-white sticky top-0">
                    ${headers.map(h => `
                        <th class="data-cell border-r border-blue-500 ${h.class}">
                            ${headerTexts[h.key] || h.key}
                        </th>
                    `).join('')}
                </tr>
            `;
        }

        // --- RENDER DATA UTAMA (Template + Input Skor) ---
        function renderTemplateTable() {
            const listBody = document.getElementById('table-body');
            let htmlContent = '';
            let totalTOV = 0;
            let totalETR = 0;
            let itemCount = 0;

            templateData.forEach(item => {
                const currentScores = localScores[item.id] || { score_2024_tov: 0.00, score_2025_etr: 0.00 };
                
                // Guna nilai lokal atau 0.00 sebagai lalai
                const tovScore = currentScores.score_2024_tov || 0.00;
                const etrScore = currentScores.score_2025_etr || 0.00;

                totalTOV += parseFloat(tovScore);
                totalETR += parseFloat(etrScore);
                itemCount++;

                htmlContent += `
                    <tr class="hover:bg-gray-50 align-top border-b border-gray-200">
                        <td class="data-cell w-1/8 font-semibold text-gray-900">${item.aspek || '-'}</td>
                        
                        <td class="data-cell w-2/8 text-gray-600">
                            ${renderReadOnlyList(item.description_list || [], 'description_list')}
                        </td>
                        
                        <td class="data-cell w-2/8 text-gray-600">
                            ${renderReadOnlyList(item.tindakan_list || [], 'tindakan_list')}
                        </td>

                        <td class="data-cell w-2/8 text-gray-600">
                            ${renderReadOnlyList(item.follow_up_list || [], 'follow_up_list')}
                        </td>
                        
                        <td class="data-cell score-cell">
                            <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2024_tov"
                                   value="${tovScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input text-gray-700 font-medium"
                            />
                        </td>
                        
                        <td class="data-cell score-cell">
                             <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2025_etr"
                                   value="${etrScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input font-bold text-indigo-600"
                            />
                        </td>
                    </tr>
                `;
            });

            listBody.innerHTML = htmlContent;
            renderTotalRow(totalTOV, totalETR, itemCount);
        }

        // --- RENDER READ-ONLY LIST (BARU) ---
        function renderReadOnlyList(list, fieldName) {
            if (!list || list.length === 0) return `<p class="text-sm text-gray-400">Tiada data disediakan.</p>`;

            const isDescription = fieldName === 'description_list';
            const isFollowUp = fieldName === 'follow_up_list';

            const ListTag = isDescription ? 'ol' : (isFollowUp ? 'ul' : 'ol');
            const listStyle = isDescription ? 'list-alpha-keterangan' : (isFollowUp ? 'list-none' : 'list-decimal');

            return `
                <${ListTag} class="p-0 m-0 ${listStyle} ${isDescription ? '' : 'pl-4'}">
                    ${list.map(item => `
                        <li class="read-only-list-item">
                            ${isFollowUp ? `<span class="text-blue-500 font-bold pr-1">âž¤</span>` : ''}
                            <span class="read-only-text inline">${item.text}</span>
                            ${item.links && item.links.length > 0 ? `<div class="text-xs mt-1 space-x-1">${item.links.map(link => `<a href="${link.url}" target="_blank" class="text-indigo-400 hover:text-indigo-600">${link.name}</a>`).join(' | ')}</div>` : ''}
                        </li>
                    `).join('')}
                </${ListTag}>
            `;
        }

        // --- RENDER BARIS PURATA ---
        function renderTotalRow(totalTOV, totalETR, count) {
            const tfoot = document.getElementById('table-footer');
            const avgTOV = count > 0 ? (totalTOV / count) : 0;
            const avgETR = count > 0 ? (totalETR / count) : 0;

            tfoot.innerHTML = `
                <tr class="bg-blue-100 text-blue-900 font-extrabold border-t-4 border-blue-600">
                    <td class="data-cell text-sm p-3" colspan="4">PERATUS SKOR KESELURUHAN</td>
                    <td class="data-cell score-cell p-3 font-mono text-sm">${avgTOV.toFixed(2)}</td>
                    <td class="data-cell score-cell p-3 font-mono text-sm">${avgETR.toFixed(2)}</td>
                </tr>
            `;
        }


        // --- LOGIK KEMAS KINI LOKAL DAN SIMPAN ---

        function updateLocalScore(id, fieldName, value) {
            const numericValue = parseFloat(value);
            
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 100) {
                // Jangan kemaskini lokal jika nilai tidak sah
                return;
            }
            
            if (!localScores[id]) {
                localScores[id] = { score_2024_tov: 0.00, score_2025_etr: 0.00 };
            }
            
            // Kemaskini skor lokal
            localScores[id][fieldName] = numericValue;
            
            // Muat semula baris purata
            const relevantItemsCount = templateData.length;
            let totalTOV = 0;
            let totalETR = 0;
            for (const item of templateData) {
                const current = localScores[item.id] || {};
                totalTOV += current.score_2024_tov || 0;
                totalETR += current.score_2025_etr || 0;
            }

            renderTotalRow(totalTOV, totalETR, relevantItemsCount);
        }

        function checkFormValidity() {
            const userNameInput = document.getElementById('user-input-name');
            const saveBtn = document.getElementById('save-all-btn');
            
            if (userNameInput.value.trim().length > 3) {
                saveBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
            }
        }

        async function saveAllScores() {
            const userName = document.getElementById('user-input-name').value.trim();
            const saveBtn = document.getElementById('save-all-btn');

            if (!userName) {
                alert('Sila masukkan Nama Penuh atau ID Pengguna anda sebelum menyimpan.');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="animate-spin w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menyimpan...';

            const docRef = doc(recordsCollectionRef, recordDocId);
            
            const dataToSave = {
                schoolName: schoolName,
                scores: localScores, // Simpan semua skor lokal
                lastUpdatedBy: userName,
                lastUpdatedTimestamp: serverTimestamp() 
            };

            try {
                await setDoc(docRef, dataToSave, { merge: true });
                alert(`Data Standard 3.1 bagi ${schoolName} berjaya dikemaskini oleh ${userName}!`);
            } catch (e) {
                console.error("Ralat menyimpan data: ", e);
                alert(`Gagal menyimpan data. Sila cuba lagi. ${e.message}`);
            } finally {
                 saveBtn.innerHTML = '<svg class="w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg> Simpan Keseluruhan Data';
                checkFormValidity();
            }
        }
        
        // --- UTILITY METADATA ---
        function formatMetadata(name, timestamp) {
            if (!name || !timestamp) return 'Tiada Rekod';
            
            let date;
            if (timestamp.toDate) { // Objek Firestore Timestamp
                date = timestamp.toDate();
            } else {
                 // Fallback untuk objek yang telah disiarkan
                date = new Date(timestamp.seconds * 1000); 
            }
            
            const formattedDate = date.toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return `Dikemaskini oleh: ${name} pada ${formattedDate}`;
        }

        authenticateAndLoad();
        
        Object.assign(window, {
            updateLocalScore,
            saveAllScores,
            checkFormValidity
        });
    </script>
</body>
</html>
