<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">SparkEdu - Pengurusan Kurikulum Pendidikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Gaya asas dan animasi */
        body { font-family: 'Arial', sans-serif; background-color: #f8f9fa; } 
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Gaya untuk konten utama */
        #kurikulum-content { font-family: 'Arial', sans-serif; background-color: #f7f9fb; } 
        .scroll-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .data-table {
            min-width: 1400px; 
            width: 100%;
        }
        .data-cell {
            vertical-align: top;
            padding: 8px 12px;
            text-align: left;
            font-size: 0.875rem; 
        }
        .score-cell {
            text-align: center;
            width: 70px;
        }
        /* Style untuk Input Skor (Lebar dan Padding disesuaikan) */
        .score-input {
            width: 100%;
            text-align: center;
            padding: 6px 4px; 
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: 'Arial', sans-serif; 
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .score-input:focus {
            border-color: #3b82f6; 
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        /* Style untuk Teks Read-Only */
        .read-only-text {
            font-size: 0.875rem;
            color: #1f2937;
            padding: 2px 0;
            display: block;
        }

        /* Gaya untuk ITEM BOLEH EDIT (Tindakan/Follow Up) */
        .editable-list-item {
            cursor: pointer;
            min-height: 20px;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 4px;
            width: 100%; 
        }
        .editable-list-item:hover {
            background-color: #f0f4ff; 
        }
        /* Gaya untuk Borang Inline */
         .inline-text-form {
            position: absolute;
            z-index: 10;
        }

        /* Custom styles for list rendering (Keterangan: a,b,c & Tindakan: 1,2,3) */
        ol.list-alpha-keterangan {
            list-style-type: lower-alpha;
            padding-left: 20px !important; 
            margin-left: 0 !important;
        }
        ol.list-alpha-keterangan li {
            list-style-position: outside;
            margin-left: 0; 
            padding-left: 0;
        }
        ol.list-decimal.p-0.m-0 {
            padding-left: 20px !important; 
            margin-left: 0 !important;
        }
        ol.list-decimal.p-0.m-0 li {
            list-style-position: outside;
            margin-left: 0; 
            padding-left: 0;
        }
        .follow-up-icon-container {
            flex-shrink: 0; 
            padding-top: 2px; 
        }
        .delete-btn {
            padding: 2px 6px;
            margin-left: 8px;
            font-size: 0.75rem; 
            background-color: #fecaca; 
            color: #b91c1c; 
            border-radius: 4px;
            transition: background-color 0.15s;
            flex-shrink: 0; 
        }
        .delete-btn:hover {
            background-color: #fca5a5; 
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div><h1 class="text-2xl font-bold text-indigo-600">SparkEdu</h1><p class="text-sm text-gray-500">Kemasukan Data Kurikulum Sekolah</p></div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 </div>
        </div>
    </header>
    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="ic-validation-section" class="max-w-lg mx-auto p-8 bg-white shadow-lg rounded-xl mt-12 hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-4">Ralat Akses</h2>
            <p class="text-gray-600 mb-6">Sila pastikan anda mengakses halaman ini melalui pautan yang mengandungi ID Sekolah. Cth: `sparkeduisi.html?sekolah=SMKLUTONG`</p>
        </div>
        
        <div id="kurikulum-content" class="p-4 md:p-8 hidden">
             <div id="permission-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg shadow-md" role="alert">
                <p class="font-bold">Amaran Keizinan Firebase!</p>
                <p class="text-sm">Gagal memuatkan atau menyimpan data. Sila semak Peraturan Keselamatan Firestore bagi koleksi rekod sekolah.</p>
            </div>
            <div id="save-controls" class="mb-6 p-4 border border-blue-300 bg-blue-50 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0">
                <div class="w-full md:w-1/2">
                    <label for="user-input-name" class="block text-sm font-medium text-blue-800 mb-1">Nama Penuh / ID Pengguna (Wajib Sebelum Simpan)</label>
                    <input type="text" id="user-input-name" placeholder="Contoh: En. Ahmad / 740101135050" 
                           class="w-full px-4 py-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm"
                           oninput="checkFormValidity()">
                </div>
                <button id="save-all-btn" class="btn bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto" onclick="saveAllScores()" disabled>
                    <svg class="w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg>
                    Simpan Keseluruhan Data
                </button>
            </div>
            
            <div class="max-w-7xl mx-auto">
                <header class="mb-6 pb-4 border-b border-blue-200">
                    <h1 class="text-3xl font-extrabold text-blue-800" id="main-title">Standard 3.1: Pengurusan Kurikulum (2025)</h1>
                    <p class="text-lg font-semibold text-gray-700 mt-2">Sekolah: <span id="school-display-name" class="text-indigo-600">Memuatkan...</span></p>
                    <div id="metadata-display" class="text-sm text-gray-600 mt-1">
                        <p id="last-update-info">Tarikh Kemaskini Terakhir: Tiada Rekod</p>
                    </div>
                </header>

                <div id="loading-spinner" class="text-center p-8 text-blue-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Memuatkan data...</p>
                </div>

                <div class="scroll-container bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="data-table border-collapse" id="kurikulum-table">
                        <thead class="bg-blue-600 text-white sticky top-0" id="table-header">
                             </thead>
                        <tbody id="table-body">
                            </tbody>
                        <tfoot id="table-footer">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Dibangunkan oleh Pahan</p>
        <p id="version-info" class="text-xs text-gray-500">Sistem Pengurusan Data SPARK - Standard 3.1</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // Path Collections
        const TEMPLATE_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_template`; 
        const RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_edu_records`; // KOLEKSI UNTUK REKOD SEKOLAH
        const HEADER_COLLECTION_PATH = `artifacts/${appId}/public/data/kurikulum_headers`; 
        const PERFORMANCE_COLLECTION_PATH = `artifacts/${appId}/public/data/spark_school_performance`; // UNTUK KEMASKINI SKOR RINGKAS

        const templateCollectionRef = collection(db, TEMPLATE_COLLECTION_PATH);
        const recordsCollectionRef = collection(db, RECORDS_COLLECTION_PATH);
        const headerCollectionRef = collection(db, HEADER_COLLECTION_PATH);

        let schoolName = '';
        let recordDocId = ''; 
        let templateData = [];
        let headerTexts = {};
        let localScores = {}; // Struktur skor yang diubah suai secara lokal
        let localActionData = {}; // Struktur Tindakan/FollowUp yang diubah suai secara lokal

        // --- UTILITY ---
        function getSchoolFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const school = urlParams.get('sekolah');
            
            if (!school) {
                document.getElementById('kurikulum-content').classList.add('hidden');
                document.getElementById('ic-validation-section').classList.remove('hidden');
                return null;
            }
            
            schoolName = decodeURIComponent(school);
            document.getElementById('school-display-name').textContent = schoolName;
            
            const cleanedSchoolName = schoolName.trim().toUpperCase().replace(/[^A-Z0-9]/g, '_');
            const templateId = 'Standard3.1'; 
            recordDocId = `${templateId}_${cleanedSchoolName}`;

            document.getElementById('kurikulum-content').classList.remove('hidden');
            return schoolName;
        }

        function formatMetadata(name, timestamp) {
            if (!name || !timestamp) return 'Tiada Rekod';
            
            let date;
            if (timestamp.toDate) { 
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp.seconds * 1000); 
            }
            
            const formattedDate = date.toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return `Dikemaskini oleh: ${name} pada ${formattedDate}`;
        }
        // --- END UTILITY ---


        // --- AUTENTIKASI & INITIALISASI ---
        function authenticateAndLoad() {
             onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Gagal daftar masuk tanpa nama:", error);
                    }
                }
                
                if (getSchoolFromUrl()) {
                    loadDataListeners();
                }
            });
        }
        
        function loadDataListeners() {
            // 1. Dapatkan Headers (Read-only)
            const headerRef = doc(headerCollectionRef, 'template_headers');
            onSnapshot(headerRef, (docSnap) => {
                headerTexts = docSnap.exists() ? docSnap.data().texts : {
                     aspek: 'Aspek', description: 'Keterangan', score_2022: '2022', score_2023: '2023', score_2024_tov: '2024 (TOV)', score_2025_etr: '2025 (ETR)', tindakan: 'Tindakan', follow_up: 'Follow Up / Pendokumentasian'
                };
                renderTableHeader();
            }, (error) => { 
                console.error("Ralat memuatkan headers:", error); 
                document.getElementById('permission-error-banner').classList.remove('hidden');
            });


            // 2. Dapatkan Struktur Template (Teks Lalai - Read-only)
            const qTemplate = query(templateCollectionRef); 
            onSnapshot(qTemplate, (snapshot) => {
                templateData = snapshot.docs.map(doc => {
                    const rowData = doc.data();
                    // Normalisasi field description
                     if (rowData.description && !rowData.description_list) {
                         rowData.description_list = [{ text: rowData.description }];
                         delete rowData.description;
                    }
                    return { id: doc.id, ...rowData };
                });
                templateData.sort((a, b) => a.id.localeCompare(b.id)); 
                renderTemplateTable();
            }, (error) => { 
                console.error("Ralat memuatkan data template:", error); 
                document.getElementById('permission-error-banner').classList.remove('hidden');
            });


            // 3. Dapatkan Rekod Skor & Tindakan Sekolah Semasa
            const docRef = doc(recordsCollectionRef, recordDocId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    localScores = data.scores || {};
                    localActionData = data.actionData || {};
                    
                    // Paparkan Metadata Kemaskini
                    const updateInfo = formatMetadata(data.lastUpdatedBy, data.lastUpdatedTimestamp);
                    document.getElementById('last-update-info').textContent = updateInfo;
                    
                } else {
                    localScores = {}; 
                    localActionData = {};
                    document.getElementById('last-update-info').textContent = 'Tarikh Kemaskini Terakhir: Tiada Rekod';
                }
                renderTemplateTable(); // Muat semula untuk memaparkan skor dan tindakan/follow up
            }, (error) => { 
                console.error("Ralat memuatkan rekod sekolah:", error); 
                document.getElementById('permission-error-banner').classList.remove('hidden');
            });
            document.getElementById('loading-spinner').classList.add('hidden');
        }


        // --- RENDER HEADER ---
        function renderTableHeader() {
            const thead = document.getElementById('table-header');
            const headers = [
                // Mengikut susunan template asal
                { key: 'aspek', class: 'w-1/8' },
                { key: 'description', class: 'w-1/6' }, 
                { key: 'score_2022', class: 'score-cell' },
                { key: 'score_2023', class: 'score-cell' },
                { key: 'score_2024_tov', class: 'score-cell' },
                { key: 'score_2025_etr', class: 'score-cell' },
                { key: 'tindakan', class: 'w-1/4' },
                { key: 'follow_up', class: 'w-1/4' }
            ];

            thead.innerHTML = `
                <tr class="bg-blue-600 text-white sticky top-0">
                    ${headers.map(h => `
                        <th class="p-3 border-r border-blue-500 ${h.class}">
                            ${headerTexts[h.key] || h.key}
                        </th>
                    `).join('')}
                </tr>
            `;
        }

        // --- RENDER LIST BOLEH EDIT (untuk Tindakan & Follow Up) ---
         function renderEditableList(templateList, docId, fieldName) {
            
            // Dapatkan data aksi dari rekod sekolah, jika ada, atau gunakan template
            const list = localActionData[docId]?.[fieldName] || templateList;

            if (!list || list.length === 0) {
                 return `<p class="text-sm text-gray-400">Tiada data disediakan.</p>`;
            }

            const isTindakan = fieldName === 'tindakan_list';
            const isFollowUp = fieldName === 'follow_up_list';

            const ListTag = isTindakan ? 'ol' : 'ul';
            const listStyle = isTindakan ? 'list-decimal p-0 m-0' : 'list-none p-0 m-0';

            const listItemsHtml = list.map((item, index) => {
                const itemTextHtml = `
                    <span class="editable-list-item list-item-content text-sm" 
                          onclick="showTextEditInput('${docId}', '${fieldName}', this.textContent.trim(), this, '${item.id}')">
                        ${item.text}
                    </span>
                `;
                
                let contentHtml = '';
                // Kandungan Item
                contentHtml = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start flex-grow min-w-0">
                            ${isFollowUp ? `<span class="text-blue-500 font-bold pr-1 flex-shrink-0">âž¤</span>` : ''}
                            <p class="text-sm text-gray-800 font-medium flex-grow min-w-0">${itemTextHtml}</p>
                        </div>
                        <button class="delete-btn flex-shrink-0" onclick="deleteListItem('${docId}', '${fieldName}', '${item.id}')">
                            X Hapus
                        </button>
                    </div>
                `;
                
                // Elemen Interaksi (Pautan)
                const interactionHtml = `
                    ${item.links && item.links.length > 0 ? `
                        <div class="mt-1 flex flex-wrap gap-1 text-xs">
                            ${item.links.map(link => `<a href="${link.url}" target="_blank" class="text-indigo-400 hover:text-indigo-600">${link.name}</a>`).join(' | ')}
                        </div>
                    ` : ''}
                    <button class="mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition"
                            onclick="showNewLinkInput('${docId}', '${fieldName}', '${item.id}', this)">
                        + Tambah Pautan
                    </button>
                `;

                const liClasses = `mb-1 p-2 border border-gray-100 rounded-lg bg-gray-50 break-words`;

                return `<li class="${liClasses}">
                    ${contentHtml}
                    ${interactionHtml}
                </li>`;

            }).join('');

            return `
                <${ListTag} class="mt-1 ${listStyle}">
                    ${listItemsHtml}
                </${ListTag}>
            `;
        }

        // --- RENDER READ-ONLY LIST (Untuk Aspek & Keterangan) ---
        function renderReadOnlyList(list, fieldName) {
            if (!list || list.length === 0) return `<p class="text-sm text-gray-400">Tiada data disediakan.</p>`;

            const isDescription = fieldName === 'description_list';

            const ListTag = isDescription ? 'ol' : 'ul';
            let listStyle = 'list-none p-0 m-0';
            if (isDescription) {
                listStyle = 'list-alpha-keterangan p-0 m-0';
            } else {
                 listStyle = 'list-decimal p-0 m-0'; // Tindakan/Follow Up (jika kod ini dipanggil)
            }

            return `
                <${ListTag} class="mt-1 ${listStyle} ${isDescription ? '' : 'pl-4'}">
                    ${list.map(item => `
                        <li class="read-only-list-item">
                            <div class="flex items-start">
                                ${isDescription ? '' : ''}
                                <span class="read-only-text inline flex-grow min-w-0">${item.text}</span>
                            </div>
                        </li>
                    `).join('')}
                </${ListTag}>
            `;
        }


        // --- RENDER DATA UTAMA ---
        function renderTemplateTable() {
            const listBody = document.getElementById('table-body');
            let htmlContent = '';
            let totalTOV = 0;
            let totalETR = 0;
            let itemCount = 0;

            templateData.forEach(item => {
                const currentScores = localScores[item.id] || { score_2024_tov: 0.00, score_2025_etr: 0.00 };
                
                const score2022 = item.score_2022 || 0;
                const score2023 = item.score_2023 || 0;
                
                const tovScore = currentScores.score_2024_tov || 0.00;
                const etrScore = currentScores.score_2025_etr || 0.00;

                totalTOV += parseFloat(tovScore);
                totalETR += parseFloat(etrScore);
                itemCount++;

                htmlContent += `
                    <tr class="hover:bg-gray-50 align-top border-b border-gray-200">
                        <td class="data-cell border-r border-gray-200 w-1/8">
                             <p class="font-semibold text-gray-900 read-only-text">${item.aspek || '-'}</p>
                        </td>
                        
                        <td class="data-cell border-r border-gray-200 w-1/6">
                            ${renderReadOnlyList(item.description_list || [], 'description_list')}
                        </td>
                        
                        <td class="data-cell score-cell border-r border-gray-200 text-center font-mono text-sm">${score2022.toFixed(2)}</td>
                        
                        <td class="data-cell score-cell border-r border-gray-200 text-center font-mono text-sm">${score2023.toFixed(2)}</td>

                        <td class="data-cell score-cell border-r border-gray-200">
                            <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2024_tov"
                                   value="${tovScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input text-gray-700 font-medium"
                            />
                        </td>
                        
                        <td class="data-cell score-cell border-r border-gray-200">
                             <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   max="100"
                                   data-id="${item.id}"
                                   data-field="score_2025_etr"
                                   value="${etrScore.toFixed(2)}" 
                                   onchange="updateLocalScore(this.getAttribute('data-id'), this.getAttribute('data-field'), this.value)"
                                   onblur="this.value = parseFloat(this.value).toFixed(2)"
                                   class="score-input font-bold text-indigo-600"
                            />
                        </td>

                        <td class="data-cell border-r border-gray-200 w-1/4">
                            ${renderEditableList(item.tindakan_list || [], item.id, 'tindakan_list')}
                            <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                    onclick="showNewItemInput('${item.id}', 'tindakan_list', this)">
                                + Tambah Tindakan
                            </button>
                        </td>

                        <td class="data-cell w-1/4">
                            ${renderEditableList(item.follow_up_list || [], item.id, 'follow_up_list')}
                            <button class="mt-3 w-full px-3 py-2 text-sm bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition"
                                    onclick="showNewItemInput('${item.id}', 'follow_up_list', this)">
                                + Tambah Follow Up
                            </button>
                        </td>
                    </tr>
                `;
            });

            listBody.innerHTML = htmlContent;
            renderTotalRow(totalTOV, totalETR, itemCount);
            checkFormValidity();
        }


        // --- RENDER BARIS PURATA ---
        function renderTotalRow(totalTOV, totalETR, count) {
            const tfoot = document.getElementById('table-footer');
            const avgTOV = count > 0 ? (totalTOV / count) : 0;
            const avgETR = count > 0 ? (totalETR / count) : 0;

            // Header asal anda mempunyai 8 lajur, jadi colspan untuk PURATA adalah 4
            tfoot.innerHTML = `
                <tr class="bg-blue-100 text-blue-900 font-extrabold border-t-4 border-blue-600">
                    <td class="data-cell text-sm p-3" colspan="4">PERATUS SKOR KESELURUHAN</td>
                    <td class="score-cell p-3 font-mono text-sm">${avgTOV.toFixed(2)}</td>
                    <td class="score-cell p-3 font-mono text-sm">${avgETR.toFixed(2)}</td>
                    <td class="data-cell border-r border-blue-300 p-3" colspan="2"></td>
                </tr>
            `;
        }


        // --- LOGIK KEMAS KINI LOKAL DAN SIMPAN KESELURUHAN (SKOR SAHAJA) ---

        function updateLocalScore(id, fieldName, value) {
            // Update skor hanya di lokal untuk Simpan Keseluruhan
            const numericValue = parseFloat(value);
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 100) return;
            
            if (!localScores[id]) {
                localScores[id] = {};
            }
            localScores[id][fieldName] = numericValue;
            
            // Muat semula baris purata
            const relevantItemsCount = templateData.length;
            let totalTOV = 0;
            let totalETR = 0;
            for (const item of templateData) {
                const current = localScores[item.id] || {};
                totalTOV += current.score_2024_tov || 0;
                totalETR += current.score_2025_etr || 0;
            }

            renderTotalRow(totalTOV, totalETR, relevantItemsCount);
        }

        function checkFormValidity() {
            const userNameInput = document.getElementById('user-input-name');
            const saveBtn = document.getElementById('save-all-btn');
            
            if (userNameInput.value.trim().length > 3) {
                saveBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
            }
        }

        async function saveAllScores() {
            const userName = document.getElementById('user-input-name').value.trim();
            const saveBtn = document.getElementById('save-all-btn');

            if (!userName) {
                alert('Sila masukkan Nama Penuh atau ID Pengguna anda sebelum menyimpan.');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="animate-spin w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menyimpan...';

            const docRef = doc(recordsCollectionRef, recordDocId);
            
            // Hitung purata TOV/ETR untuk skor ringkas
            const relevantItemsCount = templateData.length;
            let totalTOV = 0;
            let totalETR = 0;
            for (const item of templateData) {
                const current = localScores[item.id] || {};
                totalTOV += current.score_2024_tov || 0;
                totalETR += current.score_2025_etr || 0;
            }
            const avgTOV = relevantItemsCount > 0 ? (totalTOV / relevantItemsCount) : 0;
            const avgETR = relevantItemsCount > 0 ? (totalETR / relevantItemsCount) : 0;

            // Simpan data lengkap
            const dataToSave = {
                schoolName: schoolName,
                scores: localScores, // Skor terperinci
                actionData: localActionData, // Tindakan/Follow Up (Jika ada perubahan inline)
                lastUpdatedBy: userName,
                lastUpdatedTimestamp: serverTimestamp() 
            };

            try {
                // 1. Simpan rekod terperinci (Skor + Tindakan/Follow Up)
                await setDoc(docRef, dataToSave, { merge: true });
                
                // 2. Simpan skor purata ringkas ke koleksi prestasi sekolah
                const perfDocRef = doc(db, PERFORMANCE_COLLECTION_PATH, recordDocId.replace('Standard3.1_', ''));
                await setDoc(perfDocRef, { 
                    tov: parseFloat(avgTOV.toFixed(2)), 
                    etr: parseFloat(avgETR.toFixed(2)),
                    lastUpdatedTimestamp: serverTimestamp()
                }, { merge: true });
                
                alert(`Data Standard 3.1 bagi ${schoolName} berjaya dikemaskini oleh ${userName}!`);
            } catch (e) {
                console.error("Ralat menyimpan data: ", e);
                alert(`Gagal menyimpan data. Sila semak keizinan Firebase. ${e.message}`);
            } finally {
                 saveBtn.innerHTML = '<svg class="w-5 h-5 inline mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg> Simpan Keseluruhan Data';
                checkFormValidity();
            }
        }

        // --- INLINE EDITING LOGIC UNTUK TINDAKAN & FOLLOW UP ---

        function removeInlineForm() {
            const existingForms = document.querySelectorAll('.inline-edit-form, .inline-text-form');
            existingForms.forEach(form => {
                const button = form.previousElementSibling;
                 if (button && button.tagName === 'BUTTON') {
                    button.disabled = false;
                    button.classList.remove('hidden');
                }
                form.remove();
            });
            // Re-enable all list editable text and table header opacity
            document.querySelectorAll('.editable-list-item').forEach(el => el.classList.remove('hidden'));
        }
        
        // ------------------------------------
        // 1. Inisialisasi Borang Edit Teks Item Senarai
        // ------------------------------------

        function showTextEditInput(docId, fieldName, initialValue, targetElement, itemId) {
            removeInlineForm(); // Tutup borang sedia ada

            const isTindakanOrFollowUp = fieldName === 'tindakan_list' || fieldName === 'follow_up_list';
            if (!isTindakanOrFollowUp) return; // Hanya benarkan untuk Tindakan/Follow Up

            const containerId = `inline-text-form-container-${docId}-${fieldName}-${itemId}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-text-form mt-1 p-2 bg-yellow-50 border border-yellow-300 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Edit Teks:</label>
                    <textarea id="edit-text-inline" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 p-2 border text-sm resize-none">${initialValue}</textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-text-btn-inline" 
                                onclick="saveEditedText('${docId}', '${fieldName}', '${itemId}')" 
                                class="btn bg-yellow-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-yellow-700">Simpan Teks</button>
                    </div>
                </div>
            `;
            
            targetElement.insertAdjacentHTML('beforebegin', formHtml);
            targetElement.classList.add('hidden'); // Sembunyikan teks asal
            
            const textarea = document.getElementById('edit-text-inline');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length); 
        }
        
        async function saveEditedText(docId, fieldName, itemId) {
            const container = document.getElementById(`inline-text-form-container-${docId}-${fieldName}-${itemId}`);
            if (!container) return; 

            const textarea = container.querySelector('textarea');
            const text = textarea.value.trim();

            if (!text) {
                alert("Sila masukkan teks.");
                return;
            }

            const saveBtn = container.querySelector('#save-text-btn-inline');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            
            // KEMASKINI LOKAL (localActionData)
            if (!localActionData[docId]) {
                 // Guna template data asal jika tiada actionData sedia ada
                const templateItem = templateData.find(t => t.id === docId);
                localActionData[docId] = {
                    tindakan_list: JSON.parse(JSON.stringify(templateItem.tindakan_list)),
                    follow_up_list: JSON.parse(JSON.stringify(templateItem.follow_up_list))
                };
            }

            const list = localActionData[docId][fieldName];
            const itemIndex = list.findIndex(item => item.id === itemId);

            if (itemIndex > -1) {
                list[itemIndex].text = text;
            } else {
                 console.error("Item ID tidak dijumpai dalam senarai lokal.");
            }
            
            // SIMPAN DATA LENGKAP KE FIRESTORE
            await saveActionDataToFirestore(docId, 'Pengeditan Teks Item');

            removeInlineForm(); 
        }


        // ------------------------------------
        // 2. Tambah Item (Tindakan / Follow Up)
        // ------------------------------------

        async function saveNewItem(docId, fieldName) {
            const container = document.getElementById(`inline-form-container-${docId}-${fieldName}`);
            if (!container) return; 

            const textarea = container.querySelector('textarea');
            const text = textarea.value.trim();

            if (!text) {
                alert("Sila masukkan teks untuk item baru.");
                return;
            }

            const saveBtn = container.querySelector('#save-item-btn-inline');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const newItem = {
                id: Math.random().toString(36).substring(2),
                text: text,
                links: []
            };

            // KEMASKINI LOKAL (localActionData)
             if (!localActionData[docId]) {
                const templateItem = templateData.find(t => t.id === docId);
                localActionData[docId] = {
                    tindakan_list: JSON.parse(JSON.stringify(templateItem.tindakan_list)),
                    follow_up_list: JSON.parse(JSON.stringify(templateItem.follow_up_list))
                };
            }
            localActionData[docId][fieldName].push(newItem);
            
            // SIMPAN DATA LENGKAP KE FIRESTORE
            await saveActionDataToFirestore(docId, 'Tambah Item Senarai');
            
            removeInlineForm(); 
        }

        function showNewItemInput(docId, fieldName, buttonEl) {
            removeInlineForm(); 
            const isTindakan = fieldName === 'tindakan_list';
            const placeholder = isTindakan ? 'Masukkan item tindakan baru...' : 'Masukkan item follow up / pendokumentasian baru...';
            
            const containerId = `inline-form-container-${docId}-${fieldName}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-edit-form mt-2 p-3 bg-gray-50 border border-blue-200 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">${isTindakan ? 'Tambah Tindakan' : 'Tambah Follow Up'}:</label>
                    <textarea id="item-text-inline" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm resize-none" placeholder="${placeholder}"></textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-item-btn-inline" onclick="saveNewItem('${docId}', '${fieldName}')" class="btn bg-blue-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-blue-700">Simpan Item</button>
                    </div>
                </div>
            `;
            
            buttonEl.insertAdjacentHTML('beforebegin', formHtml);
            buttonEl.classList.add('hidden'); 
            buttonEl.disabled = true;
            document.getElementById('item-text-inline').focus();
        }

        // ------------------------------------
        // 3. Tambah Pautan (Link)
        // ------------------------------------
        
        async function saveNewLink(docId, fieldName, itemId) {
            const container = document.getElementById(`inline-link-form-container-${itemId}`);
            if (!container) return; 

            const linkNameInput = container.querySelector('#link-name-inline');
            const linkUrlInput = container.querySelector('#link-url-inline');
            
            const linkName = linkNameInput.value.trim();
            const linkUrl = linkUrlInput.value.trim();

            if (!linkName || !linkUrl || !linkUrl.startsWith('http')) {
                alert("Sila masukkan Nama Pautan dan URL yang sah (bermula dengan http/https).");
                return;
            }
            
            const saveBtn = container.querySelector('#save-link-btn-inline');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const newLink = { name: linkName, url: linkUrl };

            // KEMASKINI LOKAL (localActionData)
             if (!localActionData[docId]) {
                const templateItem = templateData.find(t => t.id === docId);
                localActionData[docId] = {
                    tindakan_list: JSON.parse(JSON.stringify(templateItem.tindakan_list)),
                    follow_up_list: JSON.parse(JSON.stringify(templateItem.follow_up_list))
                };
            }
            
            const list = localActionData[docId][fieldName];
            const itemIndex = list.findIndex(item => item.id === itemId);

            if (itemIndex > -1) {
                if (!list[itemIndex].links) { list[itemIndex].links = []; }
                list[itemIndex].links.push(newLink);
            } else {
                 console.error("Item ID tidak dijumpai dalam senarai lokal.");
            }

            // SIMPAN DATA LENGKAP KE FIRESTORE
            await saveActionDataToFirestore(docId, 'Tambah Pautan');

            removeInlineForm(); 
        }
        
        function showNewLinkInput(docId, fieldName, itemId, buttonEl) {
            removeInlineForm(); 
            const containerId = `inline-link-form-container-${itemId}`;
            
            const formHtml = `
                <div id="${containerId}" class="inline-edit-form mt-2 p-3 bg-green-50 border border-green-300 rounded-lg">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Nama Pautan:</label>
                    <input type="text" id="link-name-inline" class="w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm mb-2" placeholder="Nama Pautan">
                    <label class="block text-xs font-medium text-gray-700 mb-1">URL Pautan:</label>
                    <input type="url" id="link-url-inline" class="w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="https://..." value="https://">
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="removeInlineForm()" class="btn bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="save-link-btn-inline" onclick="saveNewLink('${docId}', '${fieldName}', '${itemId}')" class="btn bg-green-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-green-700">Simpan Pautan</button>
                    </div>
                </div>
            `;
            
            buttonEl.insertAdjacentHTML('beforebegin', formHtml);
            buttonEl.classList.add('hidden'); 
            buttonEl.disabled = true;
            document.getElementById('link-name-inline').focus();
        }

        // ------------------------------------
        // 4. Padam Item (Tindakan / Follow Up)
        // ------------------------------------

        async function deleteListItem(docId, fieldName, itemId) {
            if (!confirm("Adakah anda pasti mahu memadam item ini? Tindakan ini akan disimpan secara kekal.")) {
                return;
            }

            // KEMASKINI LOKAL (localActionData)
             if (!localActionData[docId]) {
                const templateItem = templateData.find(t => t.id === docId);
                localActionData[docId] = {
                    tindakan_list: JSON.parse(JSON.stringify(templateItem.tindakan_list)),
                    follow_up_list: JSON.parse(JSON.stringify(templateItem.follow_up_list))
                };
            }
            
            const list = localActionData[docId][fieldName];
            const itemIndex = list.findIndex(item => item.id === itemId);

            if (itemIndex > -1) {
                list.splice(itemIndex, 1);
            } else {
                 console.error("Item ID tidak dijumpai dalam senarai lokal.");
            }
            
            // SIMPAN DATA LENGKAP KE FIRESTORE
            await saveActionDataToFirestore(docId, 'Padam Item Senarai');
        }

        // ------------------------------------
        // 5. SIMPAN DATA TINDAKAN KE FIRESTORE (Dipanggil secara automatik)
        // ------------------------------------
        async function saveActionDataToFirestore(docId, reason) {
             const userName = document.getElementById('user-input-name').value.trim();
             
             if (!userName) {
                 alert('Sila masukkan Nama Penuh atau ID Pengguna anda untuk membenarkan pengeditan item (Tindakan/Follow Up).');
                 return;
             }
             
             const dataToSave = {
                actionData: localActionData, 
                lastUpdatedBy: userName,
                lastUpdatedTimestamp: serverTimestamp() 
            };
            
            try {
                // Gunakan setDoc dengan merge: true untuk mengemaskini actionData dan metadata sahaja
                const docRef = doc(recordsCollectionRef, recordDocId);
                await setDoc(docRef, dataToSave, { merge: true });
                console.log(`Data aksi untuk ${docId} berjaya dikemaskini. Sebab: ${reason}`);

            } catch (e) {
                console.error("Ralat menyimpan data aksi: ", e);
                alert(`Gagal menyimpan aksi. Sila semak keizinan Firebase. ${e.message}`);
            }
        }
        
        // --- INISIALISASI ---
        authenticateAndLoad();
        
        // DEDAHKAN FUNGSI KE WINDOW
        Object.assign(window, {
            updateLocalScore,
            saveAllScores,
            checkFormValidity,
            showTextEditInput,
            saveEditedText,
            showNewItemInput, 
            saveNewItem, 
            showNewLinkInput,
            saveNewLink,
            deleteListItem,
            removeInlineForm // Wajib untuk inline editing
        });
    </script>
</body>
</html>
