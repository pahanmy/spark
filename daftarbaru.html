<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Pendaftaran Pengguna Baharu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        /* Transisi untuk borang */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
             <div class="flex items-center gap-3 self-start sm:self-center">
                 <div class="bg-indigo-600 p-2 rounded-lg"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                 <div><h1 class="text-2xl font-bold text-indigo-600">SPARK</h1><p class="text-sm text-gray-500">Pendaftaran Baharu</p></div>
             </div>
             <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-4">
                 <button onclick="window.location.href='index.html'" class="btn bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-200 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Kembali Utama
                 </button>
             </div>
        </div>
    </header>

    <main class="max-w-screen-md mx-auto py-8 px-4 sm:px-6 lg:px-8 flex-grow w-full">
        
        <!-- FASA 1: SEMAKAN IC -->
        <div id="check-section" class="card p-8 mb-6 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" /></svg>
                Langkah 1: Semakan Status
            </h2>
            <p class="text-gray-600 mb-6 text-sm">Sila masukkan No. Kad Pengenalan anda untuk menyemak sama ada anda telah berdaftar dalam sistem SPARK.</p>
            
            <form id="check-ic-form" onsubmit="checkRegistration(event)" class="space-y-4">
                <div>
                    <label for="check-ic-input" class="block text-sm font-medium text-gray-700">No. Kad Pengenalan</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input type="text" id="check-ic-input" placeholder="Contoh: 900101131234" maxlength="12" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-4 pr-12 py-3 sm:text-lg border-gray-300 rounded-md tracking-wider" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span class="text-gray-400 sm:text-sm" id="ic-counter">0/12</span>
                        </div>
                    </div>
                </div>
                <div id="check-status-msg" class="hidden p-4 rounded-md text-sm font-medium"></div>
                <button type="submit" id="btn-check" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
                    Semak Status
                </button>
            </form>
        </div>

        <!-- FASA 2: BORANG PENDAFTARAN (Disembunyikan asalnya) -->
        <div id="registration-section" class="card hidden p-8 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                Langkah 2: Lengkapkan Profil
            </h2>
            <p class="text-sm text-gray-500 mb-6">Sila isi maklumat di bawah dengan tepat.</p>

            <form id="register-form" onsubmit="confirmRegistration(event)" class="space-y-6">
                
                <!-- IC (Read Only) -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">No. Kad Pengenalan</label>
                    <input type="text" id="reg-ic" class="mt-1 block w-full bg-transparent border-none text-gray-900 text-lg font-bold p-0 focus:ring-0" readonly>
                </div>

                <!-- Kategori Peserta -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Kategori Peserta</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-indigo-500 has-[:checked]:border-indigo-600 has-[:checked]:ring-1 has-[:checked]:ring-indigo-600">
                            <input type="radio" name="participant-category" value="warga" class="sr-only" checked onchange="handleCategoryChange()">
                            <span class="flex flex-col">
                                <span class="text-sm font-medium text-gray-900">Warga Pendidikan</span>
                                <span class="text-xs text-gray-500">Guru/AKP/PPD</span>
                            </span>
                            <span class="pointer-events-none absolute -inset-px rounded-lg border-2 border-transparent" aria-hidden="true"></span>
                        </label>
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-indigo-500 has-[:checked]:border-indigo-600 has-[:checked]:ring-1 has-[:checked]:ring-indigo-600">
                            <input type="radio" name="participant-category" value="murid" class="sr-only" onchange="handleCategoryChange()">
                            <span class="flex flex-col">
                                <span class="text-sm font-medium text-gray-900">Murid / Pelajar</span>
                                <span class="text-xs text-gray-500">Sekolah Rendah/Menengah</span>
                            </span>
                            <span class="pointer-events-none absolute -inset-px rounded-lg border-2 border-transparent" aria-hidden="true"></span>
                        </label>
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-indigo-500 has-[:checked]:border-indigo-600 has-[:checked]:ring-1 has-[:checked]:ring-indigo-600">
                            <input type="radio" name="participant-category" value="awam" class="sr-only" onchange="handleCategoryChange()">
                            <span class="flex flex-col">
                                <span class="text-sm font-medium text-gray-900">Orang Awam</span>
                                <span class="text-xs text-gray-500">Lain-lain</span>
                            </span>
                            <span class="pointer-events-none absolute -inset-px rounded-lg border-2 border-transparent" aria-hidden="true"></span>
                        </label>
                    </div>
                </div>

                <!-- Input Dinamik Berdasarkan Kategori -->
                
                <!-- 1. Warga Pendidikan -->
                <div id="warga-fields" class="space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Penuh</label>
                        <input type="text" id="warga-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase" placeholder="Nama Seperti Dalam KP">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Bertugas</label>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input id="warga-loc-miri" name="warga-location" type="radio" value="miri" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="handleLocationChange('warga')">
                                <label for="warga-loc-miri" class="ml-2 block text-sm text-gray-700">Dalam Miri</label>
                            </div>
                            <div class="flex items-center">
                                <input id="warga-loc-luar" name="warga-location" type="radio" value="luar" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="handleLocationChange('warga')">
                                <label for="warga-loc-luar" class="ml-2 block text-sm text-gray-700">Luar Miri</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="warga-station-miri-container">
                        <label for="warga-station-select" class="block text-sm font-medium text-gray-700">Pilih Sekolah/Stesen</label>
                        <select id="warga-station-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Sila Pilih --</option>
                        </select>
                    </div>

                    <div id="warga-station-luar-container" class="hidden space-y-4">
                        <div>
                            <label for="warga-station-manual" class="block text-sm font-medium text-gray-700">Nama Sekolah/Stesen</label>
                            <input type="text" id="warga-station-manual" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                        </div>
                        <div>
                            <label for="warga-district-manual" class="block text-sm font-medium text-gray-700">Daerah & Negeri</label>
                            <input type="text" id="warga-district-manual" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase" placeholder="CONTOH: BINTULU, SARAWAK">
                        </div>
                    </div>

                    <div>
                        <label for="warga-position" class="block text-sm font-medium text-gray-700">Jawatan</label>
                        <select id="warga-position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Sila Pilih Jawatan --</option>
                        </select>
                    </div>
                </div>

                <!-- 2. Murid/Pelajar -->
                <div id="murid-fields" class="hidden space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Penuh</label>
                        <input type="text" id="murid-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Sekolah</label>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input id="murid-loc-miri" name="murid-location" type="radio" value="miri" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="handleLocationChange('murid')">
                                <label for="murid-loc-miri" class="ml-2 block text-sm text-gray-700">Dalam Miri</label>
                            </div>
                            <div class="flex items-center">
                                <input id="murid-loc-luar" name="murid-location" type="radio" value="luar" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="handleLocationChange('murid')">
                                <label for="murid-loc-luar" class="ml-2 block text-sm text-gray-700">Luar Miri</label>
                            </div>
                        </div>
                    </div>
                    <div id="murid-station-miri-container">
                        <label for="murid-station-select" class="block text-sm font-medium text-gray-700">Pilih Sekolah</label>
                        <select id="murid-station-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Sila Pilih Sekolah --</option>
                        </select>
                    </div>
                    <div id="murid-station-luar-container" class="hidden">
                        <label for="murid-station-manual" class="block text-sm font-medium text-gray-700">Nama Sekolah & Daerah</label>
                        <input type="text" id="murid-station-manual" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase" placeholder="CONTOH: SK BATU NIAH">
                    </div>
                </div>

                <!-- 3. Orang Awam -->
                <div id="awam-fields" class="hidden space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Penuh</label>
                        <input type="text" id="awam-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pekerjaan</label>
                        <input type="text" id="awam-position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase" placeholder="Contoh: JURUTERA / SURI RUMAH">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Organisasi/Syarikat/Kampung</label>
                        <input type="text" id="awam-station" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 uppercase" placeholder="Tempat anda bertugas atau tinggal">
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-200">
                    <button type="submit" id="btn-register" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 btn">
                        Daftar Akaun
                    </button>
                </div>
            </form>
        </div>

    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200"><p class="text-sm text-gray-600">Dibangunkan oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p><p id="version-info" class="text-xs text-gray-500"></p></footer>

    <!-- MODAL PENGESAHAN PENDAFTARAN -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Pengesahan Pendaftaran</h3>
            <p class="text-sm text-gray-600 mb-6">Adakah anda pasti semua maklumat yang dimasukkan adalah tepat?</p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeModal('confirm-modal')" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Semak Semula</button>
                <button onclick="executeRegistration()" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Ya, Daftar</button>
            </div>
        </div>
    </div>

    <!-- MODAL TAHNIAH -->
    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8 text-center relative overflow-hidden">
            <!-- Confetti Effect Background (Simple CSS) -->
            <div class="absolute inset-0 pointer-events-none opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-yellow-300 via-transparent to-transparent"></div>
            
            <div class="mb-4 inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-100 text-green-600 mb-6 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            
            <h2 class="text-2xl font-extrabold text-gray-900 mb-2">TAHNIAH! ðŸŽ‰</h2>
            <p class="text-lg text-indigo-600 font-semibold mb-4">Selamat Menjadi Warga SPARK!</p>
            <p class="text-gray-600 mb-8">Pendaftaran anda telah berjaya. Terima kasih kerana menyertai komuniti inovasi digital kami.</p>
            
            <button onclick="window.location.href='index.html'" class="w-full btn bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:-translate-y-1">
                Log Masuk Sekarang ðŸš€
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, getDocs, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        let db, auth;
        const appId = firebaseConfig.projectId;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) { 
                try { await signInAnonymously(auth); } 
                catch (error) { console.error("Error signing in:", error); } 
            }
            initApp();
        });

        async function initApp() {
            // Load dropdowns secara senyap di belakang
            loadSchoolsIntoDropdowns();
            loadPositionsIntoDropdown();
            
            const versionInfo = document.getElementById('version-info');
            if(versionInfo) {
                const year = new Date().getFullYear();
                versionInfo.textContent = `Versi 2.1 (${year})`;
            }
        }

        // --- Logik Semakan IC ---
        window.checkRegistration = async function(event) {
            event.preventDefault();
            const icInput = document.getElementById('check-ic-input');
            const ic = icInput.value.trim();
            const btn = document.getElementById('btn-check');
            const statusMsg = document.getElementById('check-status-msg');

            if (ic.length !== 12) {
                alert("Sila masukkan 12 digit nombor kad pengenalan yang sah.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>`;
            statusMsg.classList.add('hidden');

            try {
                const participantsRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const q = query(participantsRef, where("ic", "==", ic));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Pengguna SUDAH ADA
                    statusMsg.className = "p-4 rounded-md text-sm font-medium bg-yellow-50 text-yellow-800 border border-yellow-200";
                    statusMsg.innerHTML = `
                        <strong>Akaun Telah Wujud!</strong><br>
                        No. Kad Pengenalan ${ic} telah didaftarkan. Anda tidak perlu mendaftar lagi.<br>
                        <a href="index.html" class="underline font-bold mt-2 inline-block">Log Masuk di Halaman Utama</a>
                    `;
                    statusMsg.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = "Semak Semula";
                } else {
                    // Pengguna TIADA (Boleh Daftar)
                    document.getElementById('check-section').classList.add('hidden');
                    document.getElementById('registration-section').classList.remove('hidden');
                    document.getElementById('reg-ic').value = ic; // Isi IC ke borang daftar
                }

            } catch (error) {
                console.error("Error checking IC:", error);
                alert("Ralat sistem. Sila cuba sebentar lagi.");
                btn.disabled = false;
                btn.textContent = "Semak Status";
            }
        }

        // --- Logik Borang Pendaftaran (Sama seperti participant.html) ---
        
        window.handleCategoryChange = function() {
            const category = document.querySelector('input[name="participant-category"]:checked').value;
            
            // Hide all fields first
            ['warga', 'murid', 'awam'].forEach(cat => {
                const el = document.getElementById(`${cat}-fields`);
                el.classList.add('hidden');
                // Disable inputs inside hidden sections to prevent validation errors
                el.querySelectorAll('input, select').forEach(input => input.disabled = true);
            });

            // Show selected
            const activeEl = document.getElementById(`${category}-fields`);
            activeEl.classList.remove('hidden');
            activeEl.querySelectorAll('input, select').forEach(input => {
                // Enable inputs, but respect manual logic for locations
                input.disabled = false; 
            });
            
            // Re-trigger location handler logic to ensure correct disabled state for nested inputs
            if (category === 'warga' || category === 'murid') {
                handleLocationChange(category);
            }
        }

        window.handleLocationChange = function(prefix) {
            const isMiri = document.querySelector(`input[name="${prefix}-location"]:checked`).value === 'miri';
            
            const selectContainer = document.getElementById(`${prefix}-station-miri-container`);
            const manualContainer = document.getElementById(`${prefix}-station-luar-container`);
            const selectEl = document.getElementById(`${prefix}-station-select`);
            const manualEl = document.getElementById(`${prefix}-station-manual`);
            const districtEl = document.getElementById(`${prefix}-district-manual`);

            if (isMiri) {
                selectContainer.classList.remove('hidden');
                manualContainer.classList.add('hidden');
                selectEl.disabled = false;
                selectEl.required = true;
                if(manualEl) { manualEl.disabled = true; manualEl.required = false; }
                if(districtEl) { districtEl.disabled = true; districtEl.required = false; }
            } else {
                selectContainer.classList.add('hidden');
                manualContainer.classList.remove('hidden');
                selectEl.disabled = true;
                selectEl.required = false;
                if(manualEl) { manualEl.disabled = false; manualEl.required = true; }
                if(districtEl) { districtEl.disabled = false; districtEl.required = true; }
            }
        }

        // TRIGGER MODAL PENGESAHAN
        window.confirmRegistration = function(event) {
            event.preventDefault();
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // LAKSANAKAN PENDAFTARAN SEBENAR
        window.executeRegistration = async function() {
            closeModal('confirm-modal'); // Tutup modal pengesahan
            const btn = document.getElementById('btn-register');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>`;

            const category = document.querySelector('input[name="participant-category"]:checked').value;
            const ic = document.getElementById('reg-ic').value;
            
            let newParticipant = {
                ic: ic,
                createdAt: new Date().toISOString()
            };

            // Kumpul Data
            if (category === 'warga') {
                const isMiri = document.querySelector('input[name="warga-location"]:checked').value === 'miri';
                newParticipant.name = document.getElementById('warga-name').value.toUpperCase();
                if (isMiri) {
                    newParticipant.station = document.getElementById('warga-station-select').value;
                } else {
                    const stationName = document.getElementById('warga-station-manual').value.toUpperCase();
                    const districtName = document.getElementById('warga-district-manual').value.toUpperCase();
                    newParticipant.station = `${stationName}, ${districtName}`;
                }
                newParticipant.position = document.getElementById('warga-position').value;
            } 
            else if (category === 'murid') {
                const isMiri = document.querySelector('input[name="murid-location"]:checked').value === 'miri';
                newParticipant.name = document.getElementById('murid-name').value.toUpperCase();
                newParticipant.station = isMiri ? document.getElementById('murid-station-select').value : document.getElementById('murid-station-manual').value.toUpperCase();
                newParticipant.position = "MURID/PELAJAR";
            } 
            else if (category === 'awam') {
                newParticipant.name = document.getElementById('awam-name').value.toUpperCase();
                newParticipant.position = document.getElementById('awam-position').value.toUpperCase();
                newParticipant.station = document.getElementById('awam-station').value.toUpperCase();
            }

            // Simpan ke Database
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/spark_participants`), newParticipant);
                
                // Tunjuk Modal Tahniah
                document.getElementById('success-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error("Error registering:", error);
                alert("Gagal mendaftar. Sila cuba lagi.");
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // MODAL HELPER
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Data Loading Functions ---
        async function loadSchoolsIntoDropdowns() {
            const selectors = ['#warga-station-select', '#murid-station-select'];
            try {
                const schoolsRef = collection(db, `artifacts/${appId}/public/data/spark_schools`);
                const q = query(schoolsRef, orderBy("name", "asc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) return;

                const schools = querySnapshot.docs.map(doc => doc.data().name);

                selectors.forEach(selector => {
                    const selectElement = document.querySelector(selector);
                    if(selectElement) {
                        schools.forEach(schoolName => {
                            const option = document.createElement('option');
                            option.value = schoolName;
                            option.textContent = schoolName;
                            selectElement.appendChild(option);
                        });
                    }
                });
            } catch (error) {
                console.error("Error loading schools: ", error);
            }
        }

        async function loadPositionsIntoDropdown() {
            const selectElement = document.querySelector('#warga-position');
            if(!selectElement) return;
            try {
                const positionsRef = collection(db, `artifacts/${appId}/public/data/spark_positions`);
                const q = query(positionsRef, orderBy("order", "asc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) return;

                const positions = querySnapshot.docs.map(doc => doc.data().name);

                positions.forEach(positionName => {
                    const option = document.createElement('option');
                    option.value = positionName;
                    option.textContent = positionName;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading positions: ", error);
            }
        }

        // Counter untuk input IC
        const icInput = document.getElementById('check-ic-input');
        if(icInput) {
            icInput.addEventListener('input', function() {
                const len = this.value.length;
                const counter = document.getElementById('ic-counter');
                counter.textContent = `${len}/12`;
                if(len === 12) counter.classList.add('text-green-600', 'font-bold');
                else counter.classList.remove('text-green-600', 'font-bold');
            });
        }

        // Init Form State (set kategori default)
        handleCategoryChange();

    </script>
</body>
</html>
