<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah Tugasan - SparkTask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* PERUBAHAN 1: Menimpa warna to-indigo-700 dengan #4cf7b4 (Aqua/Hijau Muda) */
        .to-indigo-700 {
            --tw-gradient-to: #4cf7b4 var(--tw-gradient-to-position); 
        }

        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled, input:disabled, select:disabled, textarea:disabled, button:disabled { 
            opacity: 0.7;
            cursor: not-allowed; 
            background-color: #f3f4f6;
        }
        .blue-column input:focus, .blue-column textarea:focus, .blue-column select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        .green-column input:focus, .green-column textarea:focus, .green-column select:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }
        .red-column input:focus, .red-column textarea:focus, .red-column select:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.buka {
            opacity: 1;
            visibility: visible;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-6">
            <a href="sparktask.html" class="inline-flex items-center text-gray-600 hover:text-blue-500 transition-colors">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Kembali ke Senarai Tugasan
            </a>
            <h1 class="text-3xl font-bold mt-2 text-gray-800">Tambah Tugasan Baharu</h1>
        </header>

        <form id="borangBaru" class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 blue-column">
                <div>
                    <label for="namaModal" class="block text-sm font-medium text-gray-700 mb-1">Nama Tugasan <span class="text-red-500">*</span></label>
                    <input type="text" id="namaModal" required class="w-full border-gray-300 rounded-md shadow-sm p-2 uppercase">
                </div>
                <div>
                    <label for="kategoriModal" class="block text-sm font-medium text-gray-700 mb-1">Kategori Tugasan <span class="text-red-500">*</span></label>
                    <select id="kategoriModal" required class="w-full border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Pilih Kategori</option>
                        <option value="Sistem">Sistem</option>
                        <option value="Tanggungjawab">Tanggungjawab</option>
                        <option value="Khas">Khas</option>
                        </select>
                </div>
                <div class="md:col-span-2">
                    <label for="peneranganModal" class="block text-sm font-medium text-gray-700 mb-1">Penerangan Tugasan</label>
                    <textarea id="peneranganModal" rows="3" class="w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 green-column">
                <div>
                    <label for="tarikhMulaModal" class="block text-sm font-medium text-gray-700 mb-1">Tarikh Mula <span class="text-red-500">*</span></label>
                    <input type="date" id="tarikhMulaModal" required class="w-full border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="tarikhSiapModal" class="block text-sm font-medium text-gray-700 mb-1">Tarikh Siap Dijangka <span class="text-red-500">*</span></label>
                    <input type="date" id="tarikhSiapModal" required class="w-full border-gray-300 rounded-md shadow-sm p-2">
                </div>

                <div class="md:col-span-2">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="perluPautanCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="perluPautanCheckbox" class="ml-2 block text-sm font-medium text-gray-700">Tugasan Perlukan Pautan Rujukan?</label>
                    </div>
                    
                    <div id="pautanSection" class="hidden border border-gray-200 p-4 rounded-md bg-gray-50">
                        <div class="flex space-x-2 mb-2">
                            <input type="text" id="inputPautanNama" placeholder="Nama Pautan" class="flex-grow border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <input type="url" id="inputPautanUrl" placeholder="URL Pautan (cth: https://google.com)" class="flex-grow border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <button type="button" id="tambahPautanBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Tambah</button>
                        </div>
                        <ul id="senaraiPautanContainer" class="space-y-1 text-sm">
                            </ul>
                    </div>
                </div>
            </div>

            <div class="mb-8 red-column">
                <label for="skop-list-textarea" class="block text-lg font-medium text-gray-800 mb-2">Skop Tugasan (Satu skop/sekolah/pegawai setiap baris)</label>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button type="button" onclick="loadReferenceSchools('all')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Muat Senarai Semua Sekolah</button>
                    <button type="button" onclick="loadReferenceSchools('sr')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Muat Senarai SK/SR</button>
                    <button type="button" onclick="loadReferenceSchools('sm')" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Muat Senarai SMK/SM</button>
                    <button type="button" onclick="loadReferenceSchools('ppd-sektor')" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Muat Senarai Sektor PPD</button>
                    <button type="button" onclick="loadReferenceSchools('ppd')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Muat Senarai Pegawai PPD</button>
                </div>

                <textarea id="skop-list-textarea" rows="10" placeholder="Masukkan nama sekolah, nama pegawai, atau unit di sini..." 
                          class="w-full border-gray-300 rounded-md shadow-sm p-2 uppercase"
                          data-keys-to-save="[]"
                ></textarea>
                
                <p class="mt-1 text-xs text-gray-500">Nota: Menggunakan butang rujukan PPD akan menyimpan Nombor IC pegawai (jika ada) sebagai kunci padanan unik di belakang tabir, walaupun hanya Nama dipaparkan di sini.</p>
            </div>

            <div class="mb-8 blue-column">
                <h3 class="text-lg font-medium text-gray-800 mb-2">Sub Tugasan (Pilihan)</h3>
                <div id="subTugasanTypeButtonsContainer" class="flex gap-2 mb-4">
                    <button type="button" data-type="Perlu Tindakan" class="py-1 px-3 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300">Perlu Tindakan</button>
                    <button type="button" data-type="Perlu Maklumat" class="py-1 px-3 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300">Perlu Maklumat</button>
                </div>
                
                <div id="subTugasanInputs" class="hidden border border-gray-200 p-4 rounded-md bg-gray-50">
                    <label for="inputSubTugasanNama" class="block text-sm font-medium text-gray-700 mb-1">Nama Sub Tugasan</label>
                    <div class="flex space-x-2">
                        <input type="text" id="inputSubTugasanNama" placeholder="Cth: Muat naik data" class="flex-grow border-gray-300 rounded-md shadow-sm p-2 text-sm uppercase">
                        <select id="inputSubTugasanType" class="border-gray-300 rounded-md shadow-sm p-2 text-sm w-40">
                            <option value="Perlu Tindakan">Perlu Tindakan</option>
                            <option value="Perlu Maklumat">Perlu Maklumat</option>
                        </select>
                        <button type="button" id="tambahSubTugasanBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-sm btn">Tambah</button>
                    </div>
                    <ul id="senaraiSubTugasanContainer" class="space-y-1 mt-3 text-sm">
                        </ul>
                </div>
            </div>

            <div id="ralatBorang" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg mb-4 text-sm font-medium">
                Sila pastikan semua medan bertanda (*) diisi dan sekurang-kurangnya satu skop dimasukkan.
            </div>

            <div class="flex justify-end space-x-3 mt-8">
                <button type="button" id="batalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md btn">Batal</button>
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md flex items-center justify-center btn">
                    <span id="submitText">Simpan Tugasan</span>
                    <div id="loadingSpinner" class="hidden loading-spinner h-5 w-5 border-4 border-t-white border-gray-300 rounded-full ml-2"></div>
                </button>
            </div>
        </form>
    </div>

    <script>
        // FIREBASE CONFIGURATION (DIAMBIL DARI FAIL ASAL ANDA)
        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const appId = firebaseConfig.projectId; // Menggunakan projectId sebagai appId untuk path koleksi
        
        // RUJUKAN ELEMEN BORANG
        const borangBaru = document.getElementById('borangBaru');
        const namaModal = document.getElementById('namaModal');
        const kategoriModal = document.getElementById('kategoriModal');
        const peneranganModal = document.getElementById('peneranganModal');
        const tarikhMulaModal = document.getElementById('tarikhMulaModal');
        const tarikhSiapModal = document.getElementById('tarikhSiapModal');
        const ralatBorang = document.getElementById('ralatBorang');
        const batalBtn = document.getElementById('batalBtn');
        const submitText = document.getElementById('submitText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Pautan Rujukan
        const perluPautanCheckbox = document.getElementById('perluPautanCheckbox');
        const pautanSection = document.getElementById('pautanSection');
        const tambahPautanBtn = document.getElementById('tambahPautanBtn');
        const inputPautanNama = document.getElementById('inputPautanNama');
        const inputPautanUrl = document.getElementById('inputPautanUrl');
        const senaraiPautanContainer = document.getElementById('senaraiPautanContainer');
        let pautanRujukan = [];

        // Sub Tugasan
        const tambahSubTugasanBtn = document.getElementById('tambahSubTugasanBtn');
        const inputSubTugasanNama = document.getElementById('inputSubTugasanNama');
        const inputSubTugasanType = document.getElementById('inputSubTugasanType');
        const senaraiSubTugasanContainer = document.getElementById('senaraiSubTugasanContainer');
        const subTugasanTypeButtonsContainer = document.getElementById('subTugasanTypeButtonsContainer');
        let subTugasanList = [];

        // Data Rujukan Sekolah/PPD
        let allSchools = [];
        let srSchools = [];
        let smSchools = [];
        let ppdOfficers = [];
        let ppdSectors = [];

        // Status
        let isSubmitting = false;

        // --- FUNGSI UTILITI ---

        function normalizeStationName(name) {
            if (!name) return '';
            // Buang ruang kosong di depan/belakang, tukar kepada huruf besar.
            // PENTING: Jangan buang semua ruang kosong, hanya ruang ganda. Ini untuk memastikan
            // Nama Sekolah (cth: SK MIRI) kekal boleh dibaca, walaupun IC akan melalui ini.
            return name.trim().toUpperCase().replace(/\s{2,}/g, ' '); 
        }

        function showLoading(show) {
            const submitButton = borangBaru.querySelector('button[type="submit"]');
            if (show) {
                isSubmitting = true;
                submitButton.disabled = true;
                submitText.textContent = 'Memproses...';
                loadingSpinner.classList.remove('hidden');
            } else {
                isSubmitting = false;
                submitButton.disabled = false;
                submitText.textContent = 'Simpan Tugasan';
                loadingSpinner.classList.add('hidden');
            }
        }

        function tunjukRalatBorang() {
            ralatBorang.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function sembunyiRalatBorang() {
            ralatBorang.classList.add('hidden');
        }

        // --- LOGIK PENGURUSAN PAUTAN RUJUKAN ---

        function tambahPautan() {
            const nama = inputPautanNama.value.trim();
            const url = inputPautanUrl.value.trim();

            if (nama && url) {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    alert('Sila masukkan URL yang sah (bermula dengan http:// atau https://)');
                    return;
                }
                pautanRujukan.push({ nama, url });
                renderPautan();
                inputPautanNama.value = '';
                inputPautanUrl.value = '';
            } else {
                alert('Sila masukkan Nama Pautan dan URL.');
            }
        }

        function renderPautan() {
            senaraiPautanContainer.innerHTML = '';
            pautanRujukan.forEach((p, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-1 bg-white rounded-md border border-gray-200';
                li.innerHTML = `
                    <a href="${p.url}" target="_blank" class="text-blue-600 hover:underline text-sm truncate">${p.nama}</a>
                    <button type="button" data-index="${index}" class="text-red-500 hover:text-red-700 ml-3 text-xs" data-action="padam-pautan">Padam</button>
                `;
                senaraiPautanContainer.appendChild(li);
            });
        }

        function handlePautanKlik(e) {
            if (e.target.dataset.action === 'padam-pautan') {
                const index = parseInt(e.target.dataset.index);
                pautanRujukan.splice(index, 1);
                renderPautan();
            }
        }

        // --- LOGIK PENGURUSAN SUB TUGASAN ---

        function tambahSubTugasan() {
            const nama = inputSubTugasanNama.value.trim();
            const jenis = inputSubTugasanType.value;

            if (nama) {
                subTugasanList.push({ 
                    nama: nama.toUpperCase(), 
                    jenis: jenis, 
                    status: 'Belum Siap', 
                    tindakan: [] 
                });
                renderSubTugasan();
                inputSubTugasanNama.value = '';
            } else {
                alert('Sila masukkan Nama Sub Tugasan.');
            }
        }

        function renderSubTugasan() {
            senaraiSubTugasanContainer.innerHTML = '';
            subTugasanList.forEach((sub, index) => {
                const li = document.createElement('li');
                const badgeClass = sub.jenis === 'Perlu Tindakan' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                li.className = 'flex items-center justify-between p-2 bg-white rounded-md border border-gray-200 text-sm';
                li.innerHTML = `
                    <span class="text-gray-700">${sub.nama}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${badgeClass}">${sub.jenis}</span>
                        <button type="button" data-index="${index}" class="text-red-500 hover:text-red-700 text-xs" data-action="padam-sub">Padam</button>
                    </div>
                `;
                senaraiSubTugasanContainer.appendChild(li);
            });
        }
        
        function handleSubTugasanKlik(e) {
            if (e.target.dataset.action === 'padam-sub') {
                const index = parseInt(e.target.dataset.index);
                subTugasanList.splice(index, 1);
                renderSubTugasan();
            }
        }

        function handleTypeButtonClick(e) {
            const type = e.target.dataset.type;
            if (type) {
                inputSubTugasanType.value = type;
                toggleOptionsInput();
            }
        }
        
        function toggleOptionsInput() {
            if (subTugasanList.length > 0 || document.getElementById('subTugasanInputs').classList.contains('hidden')) {
                document.getElementById('subTugasanInputs').classList.remove('hidden');
            } else {
                document.getElementById('subTugasanInputs').classList.add('hidden');
            }
        }

        // --- LOGIK MEMUAT DATA RUJUKAN (SEKOLAH/PPD) ---

        async function fetchReferenceData() {
            try {
                // Fetch Sekolah
                const schoolsRef = db.collection(`artifacts/${appId}/public/data/spark_schools`);
                const schoolsSnapshot = await schoolsRef.get();
                allSchools = schoolsSnapshot.docs.map(doc => doc.data()).filter(s => s.name);
                
                srSchools = allSchools.filter(s => s.category === 'SR').sort((a, b) => a.name.localeCompare(b.name));
                smSchools = allSchools.filter(s => s.category === 'SM').sort((a, b) => a.name.localeCompare(b.name));

                // Fetch Sektor PPD
                const sectorsRef = db.collection(`artifacts/${appId}/public/data/spark_ppd_officers`);
                const sectorsQuery = sectorsRef.where("category", "==", "sektor").orderBy("name", "asc");
                const sectorsSnapshot = await sectorsQuery.get();
                ppdSectors = sectorsSnapshot.docs.map(doc => doc.data().name.toUpperCase());
                
                // Fetch Pegawai PPD
                await loadPpdOfficers();

            } catch (error) {
                console.error("RALAT KETIKA MEMUAT DATA RUJUKAN. (Sila semak Rules & Index Firebase): ", error);
                // Biarkan array kosong jika ralat
            }
        }

        /**
         * FUNGSI KRITIKAL: MEMUAT PEGAWAI PPD
         * Ini diubah suai untuk menyimpan Nama dan IC (sebagai kunci).
         */
        async function loadPpdOfficers() {
            try {
                const officersRef = db.collection(`artifacts/${appId}/public/data/spark_ppd_officers`);
                const q = officersRef
                    .where("category", "==", "pegawai")
                    .where("station", "==", "PEJABAT PENDIDIKAN DAERAH")
                    .orderBy("name", "asc");
                
                const querySnapshot = await q.get();
                ppdOfficers = [];
                querySnapshot.forEach(doc => {
                    const officer = doc.data();
                    
                    // --- LOGIK BARU: UTAMAKAN IC UNTUK SKOP, TAPI SIMPAN NAMA UNTUK DISPLAY ---
                    const skopKey = officer.ic && officer.ic.length === 12 
                                    ? officer.ic.toUpperCase().replace(/\s/g, '') // Gunakan IC, buang semua ruang
                                    : officer.name.toUpperCase(); // Fallback ke Nama jika IC tiada
                    
                    ppdOfficers.push({
                        display: officer.name.toUpperCase(), // Ini yang akan dipaparkan
                        key: skopKey                       // Ini yang akan disimpan di Firebase
                    }); 
                    // --------------------------------------------------------------------------
                });
            } catch (error) {
                console.error("RALAT KETIKA MEMUAT PEGAWAI PPD. (Sila semak Rules & Index Firebase): ", error);
            }
        }


        /**
         * FUNGSI KRITIKAL: MEMUAT SKOP RUJUKAN KE TEXTAREA
         * Ini diubah suai untuk memaparkan Nama tetapi menyimpan IC dalam data-attribute.
         */
        function loadReferenceSchools(type) {
            const textarea = document.getElementById('skop-list-textarea');
            textarea.value = 'Memuatkan...';
            textarea.removeAttribute('data-keys-to-save'); // Reset

            let filteredList = []; // Untuk paparan
            let keysToSave = [];   // Untuk simpanan di Firebase

            if (type === 'ppd-sektor') { 
                if (ppdSectors.length === 0) {
                    textarea.value = 'Data Sektor PPD belum sedia atau tiada data ditemui.';
                } else {
                    filteredList = ppdSectors;
                    keysToSave = ppdSectors; // Sektor guna nama sebagai kunci
                }
            } else if (type === 'ppd') { 
                if (ppdOfficers.length === 0) {
                    textarea.value = 'Data Pegawai PPD belum sedia atau tiada data ditemui.';
                } else {
                    // Logik BARU: Paparkan Nama, tetapi simpan IC/Key di latar belakang.
                    filteredList = ppdOfficers.map(p => p.display); // Paparkan Nama (Display)
                    keysToSave = ppdOfficers.map(p => p.key);       // Simpan IC/Key sebenar (IC atau Nama)
                }
            } else if (type === 'sr') { 
                filteredList = srSchools.map(school => school.name);
                keysToSave = srSchools.map(school => school.name);
            } else if (type === 'sm') { 
                filteredList = smSchools.map(school => school.name); 
                keysToSave = smSchools.map(school => school.name);
            } else if (type === 'all') { 
                filteredList = [...srSchools, ...smSchools].map(school => school.name).sort();
                keysToSave = filteredList;
            }

            if (filteredList.length > 0) { 
                // Paparkan senarai Nama dalam textarea
                textarea.value = filteredList.join('\n'); 
                
                // PENTING: Simpan senarai kunci sebenar ke textarea menggunakan data-attribute 
                // untuk digunakan dalam langkah menyimpan di bawah.
                // Kunci IC tidak dinormalisasi lagi kerana ia sudah dibuang ruang dalam loadPpdOfficers.
                // Kunci Nama Sekolah/Sektor perlu dinormalisasi di sini.
                textarea.dataset.keysToSave = JSON.stringify(keysToSave.map(k => {
                    // Jika IC, ia tidak perlu normalizeName, tetapi normalizeStationName perlu dipanggil
                    // untuk nama sekolah/sektor untuk memastikan konsistensi dalam Firestore Rules/query.
                    // Namun, untuk IC, kita hanya perlu buang ruang. Logik di loadPpdOfficers sudah cukup.
                    // Kita panggil normalizeStationName (yang akan buang ruang ganda) untuk keselesaan.
                    return normalizeStationName(k);
                }));
                
            } else if (type !== 'ppd' && type !== 'ppd-sektor') {
                textarea.value = (allSchools.length === 0) 
                    ? 'Data sekolah belum sedia. Sila tunggu sebentar dan cuba lagi.' 
                    : `Tiada sekolah jenis '${type}' ditemui.`;
            }
        }


        // --- LOGIK PENGENDALIAN BORANG ---

        async function handleSimpanBorangBaru(e) {
            e.preventDefault();
            
            if (isSubmitting) return;

            // Semak Medan Wajib
            const requiredFields = [namaModal, kategoriModal, tarikhMulaModal, tarikhSiapModal];
            const isFormValid = requiredFields.every(field => field.value.trim() !== '');

            const textareaValue = document.getElementById('skop-list-textarea').value;
            
            if (!isFormValid || textareaValue.trim() === '') {
                tunjukRalatBorang();
                return;
            }

            try {
                showLoading(true);
                
                const textarea = document.getElementById('skop-list-textarea');
                
                // --- LOGIK MENGAMBIL KUNCI SKOP (IC/NAMA) ---
                let skopSenaraiSekolah;
                const savedKeys = textarea.dataset.keysToSave;
                
                if (savedKeys && savedKeys.length > 2) { 
                    // Jika butang rujukan PPD/Skop digunakan, ambil Kunci yang telah disimpan.
                    try {
                        skopSenaraiSekolah = JSON.parse(savedKeys);
                    } catch(err) {
                        console.error("Gagal parse savedKeys:", err);
                        // Fallback ke pemprosesan textarea biasa
                        skopSenaraiSekolah = textareaValue.split('\n')
                                                      .map(line => normalizeStationName(line)) 
                                                      .filter(line => line.length > 0);
                    }
                } else {
                    // Jika data ditaip secara manual, normalisasikan teks sedia ada
                    skopSenaraiSekolah = textareaValue.split('\n')
                                                      .map(line => normalizeStationName(line)) 
                                                      .filter(line => line.length > 0);
                }
                // --- TAMAT LOGIK KUNCI SKOP ---
                
                const jumlahBelum = skopSenaraiSekolah.length;

                // Subtugasan yang disimpan
                const subTugasanToSave = subTugasanList.map(sub => ({
                    nama: sub.nama,
                    jenis: sub.jenis,
                    status: sub.status, // 'Belum Siap'
                    tindakan: [] // Kosongkan tindakan
                }));
                
                const dataTugasan = {
                    nama: namaModal.value.toUpperCase().trim(),
                    kategori: kategoriModal.value.trim(),
                    penerangan: peneranganModal.value.trim(),
                    tarikh_mula: tarikhMulaModal.value,
                    tarikh_siap_dijangka: tarikhSiapModal.value,
                    tarikh_cipta: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'Aktif',
                    
                    // Skop & Progres
                    skopSenaraiSekolah: skopSenaraiSekolah, // Ini menyimpan IC/Nama yang dinormalisasi
                    jumlahSkop: skopSenaraiSekolah.length,
                    jumlahBelum: jumlahBelum,
                    jumlahSiap: 0,
                    progress: 0,
                    
                    // Pautan Rujukan
                    pautanRujukan: pautanRujukan,

                    // Sub Tugasan
                    subTugasan: subTugasanToSave,
                };

                const tugasanRef = db.collection(`artifacts/${appId}/private/tasks`);
                await tugasanRef.add(dataTugasan);

                alert('Tugasan baharu berjaya disimpan!');
                window.location.href = 'sparktask.html';

            } catch (error) {
                console.error("Ralat menyimpan tugasan: ", error);
                alert("Gagal menyimpan tugasan. Sila semak konsol untuk maklumat lanjut atau hubungi Admin. Error: " + error.message);
                showLoading(false);
            }
        }


        // --- EVENT LISTENERS & INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            fetchReferenceData(); // Muat data rujukan
            
            // Set Tarikh Mula ke hari ini secara default
            const today = new Date().toISOString().split('T')[0];
            tarikhMulaModal.value = today;
            
            // Logik Tarikh Siap: 14 hari dari tarikh mula
            tarikhMulaModal.addEventListener('change', () => {
                try {
                    const startDate = new Date(tarikhMulaModal.value);
                    startDate.setDate(startDate.getDate() + 14);
                    tarikhSiapModal.value = startDate.toISOString().split('T')[0];
                } catch (e) {
                    console.error("Invalid start date");
                    tarikhSiapModal.value = '';
                }
            });

            namaModal.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
            
            // Logik Pautan
            perluPautanCheckbox.addEventListener('change', () => {
                pautanSection.classList.toggle('hidden', !perluPautanCheckbox.checked);
                if (!perluPautanCheckbox.checked) {
                    // Kosongkan Pautan jika dinyahsemak
                    pautanRujukan = [];
                    renderPautan();
                }
            });

            tambahPautanBtn.addEventListener('click', tambahPautan);
            senaraiPautanContainer.addEventListener('click', handlePautanKlik);
            
            // Logik Sub Tugasan
            subTugasanTypeButtonsContainer.addEventListener('click', handleTypeButtonClick);
            tambahSubTugasanBtn.addEventListener('click', tambahSubTugasan);
            senaraiSubTugasanContainer.addEventListener('click', handleSubTugasanKlik);
        });

        borangBaru.addEventListener('submit', handleSimpanBorangBaru);
        batalBtn.addEventListener('click', () => {
            if (confirm("Anda pasti mahu batal? Perubahan tidak akan disimpan.")) {
                window.location.href = 'sparktask.html';
            }
        });
        
    </script>
</body>
</html>
