<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Kajian Keperluan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none; }
        
        .form-radio, .form-checkbox {
            appearance: none; display: inline-block; vertical-align: middle; height: 1.25rem; width: 1.25rem;
            flex-shrink: 0; border-radius: 0.25rem; border: 2px solid #cbd5e1; transition: all 0.2s;
        }
        .form-radio { border-radius: 9999px; }
        .form-radio:checked, .form-checkbox:checked {
            background-color: #4f46e5; border-color: #4f46e5;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%; background-position: center; background-repeat: no-repeat;
        }
        .form-radio:focus, .form-checkbox:focus { box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); outline: none; }

        .choice-label {
            display: block; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s;
        }
        .choice-label:has(input:checked) {
            border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        
        .progress-container {
            position: sticky; top: 0; z-index: 10; background-color: white; padding-top: 1rem; padding-bottom: 1rem;
        }
        .progress-bar-bg { width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar {
            height: 0.75rem; background-color: #4f46e5; width: 0%; transition: width 0.4s ease-in-out;
        }

        /* Animation for step transitions */
        .form-step { display: none; animation: fadeIn 0.5s; }
        .form-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-sm w-full">
        <div class="max-w-5xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
             <a href="index.html" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                Halaman Utama
             </a>
        </div>
    </header>

    <main class="w-full max-w-3xl mx-auto p-4">
        
        <div id="survey-card" class="card p-6 md:p-10">
            <div class="text-center mb-4">
                <h2 class="text-3xl font-bold text-gray-800">Borang Tinjauan</h2>
                <p class="mt-2 text-gray-600">Kajian Keperluan Pengurusan Kehadiran Program di Peringkat Sekolah / PPD</p>
            </div>
            
            <div class="progress-container">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-indigo-700">Kemajuan</span>
                    <span id="progress-text" class="text-sm font-medium text-indigo-700">Bahagian 1 / 5</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
            </div>

            <form id="kajian-form" onsubmit="submitSurvey(event)" class="mt-8">

                <fieldset data-step="0" class="form-step active space-y-6">
                    <legend class="text-xl font-semibold text-indigo-700 border-b-2 border-indigo-200 pb-2 w-full">Bahagian A: Maklumat Responden</legend>
                    
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">1. Jawatan / Peranan:</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="jawatan" value="Guru" class="form-radio" required><span>Guru</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="jawatan" value="Pentadbir" class="form-radio"><span>Pentadbir</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="jawatan" value="Urus setia program" class="form-radio"><span>Urus setia program</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="jawatan" value="Lain-lain" class="form-radio" onchange="toggleConditionalInput(this, 'jawatan-lain-input')"><span>Lain-lain</span></label>
                            <input type="text" id="jawatan-lain-input" name="jawatan-lain" placeholder="Sila nyatakan..." class="mt-2 ml-8 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md hidden">
                        </div>
                    </div>

                    <div>
                        <label for="tempat-bertugas" class="block text-md font-semibold text-gray-700 mb-2">2. Tempat bertugas:</label>
                        <input type="text" id="tempat-bertugas" name="tempat-bertugas" class="block w-full px-4 py-2 border border-gray-300 rounded-md" required>
                    </div>

                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">3. Pengalaman mengurus program (tahun):</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="choice-label text-center"><input type="radio" name="pengalaman" value="< 1 tahun" class="sr-only" required><span>&lt; 1 tahun</span></label>
                            <label class="choice-label text-center"><input type="radio" name="pengalaman" value="1-3 tahun" class="sr-only"><span>1–3 tahun</span></label>
                            <label class="choice-label text-center"><input type="radio" name="pengalaman" value="4-6 tahun" class="sr-only"><span>4–6 tahun</span></label>
                            <label class="choice-label text-center"><input type="radio" name="pengalaman" value="> 6 tahun" class="sr-only"><span>&gt; 6 tahun</span></label>
                        </div>
                    </div>
                </fieldset>

                <fieldset data-step="1" class="form-step space-y-6">
                    <legend class="text-xl font-semibold text-indigo-700 border-b-2 border-indigo-200 pb-2 w-full">Bahagian B: Proses Sedia Ada</legend>
                    
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">4. Langkah yang biasanya anda lakukan apabila ingin mengurus kehadiran program: (Boleh pilih satu atau lebih)</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="langkah_sedia_ada" value="Membina Google Form" class="form-checkbox"><span>Membina Google Form / borang digital</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="langkah_sedia_ada" value="Menjana kod QR manual" class="form-checkbox"><span>Menjana kod QR secara manual</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="langkah_sedia_ada" value="Mengedarkan pautan" class="form-checkbox"><span>Mengedarkan pautan melalui WhatsApp / surat</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="langkah_sedia_ada" value="Menyediakan senarai tandatangan" class="form-checkbox"><span>Menyediakan senarai tandatangan kehadiran</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="langkah_sedia_ada" value="Menyediakan laporan manual" class="form-checkbox"><span>Menyediakan laporan kehadiran manual / Excel</span></label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">5. Purata masa diambil untuk menyediakan sistem kehadiran sebelum program bermula:</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="choice-label text-center"><input type="radio" name="masa_penyediaan" value="< 5 minit" class="sr-only" required><span>&lt; 5 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_penyediaan" value="5-15 minit" class="sr-only"><span>5–15 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_penyediaan" value="15-30 minit" class="sr-only"><span>15–30 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_penyediaan" value="> 30 minit" class="sr-only"><span>&gt; 30 minit</span></label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">6. Adakah anda perlu menyediakan borang tinjauan kehadiran (RSVP) sebelum program?</label>
                        <div class="flex gap-4">
                            <label class="choice-label flex-1 text-center"><input type="radio" name="perlu_rsvp" value="Ya" class="sr-only" required onchange="toggleConditionalInput(this, 'rsvp-follow-up')"><span>Ya</span></label>
                            <label class="choice-label flex-1 text-center"><input type="radio" name="perlu_rsvp" value="Tidak" class="sr-only" onchange="toggleConditionalInput(this, 'rsvp-follow-up')"><span>Tidak</span></label>
                        </div>
                    </div>
                    
                    <div id="rsvp-follow-up" class="hidden space-y-6 pl-4 border-l-4 border-gray-200">
                        <div>
                            <label class="block text-md font-semibold text-gray-700 mb-3">7. Jika ya, bagaimanakah tinjauan tersebut biasanya dibuat? (Boleh pilih satu atau lebih)</label>
                            <div class="space-y-3">
                                <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_rsvp" value="Google Form berasingan" class="form-checkbox"><span>Membina Google Form/borang digital yang berasingan</span></label>
                                <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_rsvp" value="Tinjauan tidak rasmi" class="form-checkbox"><span>Tinjauan tidak rasmi di WhatsApp/Telegram</span></label>
                                <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_rsvp" value="Mesej / E-mel terus" class="form-checkbox"><span>Meminta maklum balas secara terus melalui mesej atau e-mel</span></label>
                                <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_rsvp" value="Lain-lain" class="form-checkbox" onchange="toggleConditionalInput(this, 'rsvp-lain-input')"><span>Lain-lain</span></label>
                                <input type="text" id="rsvp-lain-input" name="rsvp-lain" placeholder="Sila nyatakan..." class="mt-2 ml-8 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md hidden">
                            </div>
                        </div>
                        <div>
                            <label class="block text-md font-semibold text-gray-700 mb-3">8. Berapakah purata masa yang diambil untuk menyediakan borang tinjauan ini?</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="choice-label text-center"><input type="radio" name="masa_rsvp" value="< 5 minit" class="sr-only"><span>&lt; 5 minit</span></label>
                                <label class="choice-label text-center"><input type="radio" name="masa_rsvp" value="5-15 minit" class="sr-only"><span>5–15 minit</span></label>
                                <label class="choice-label text-center"><input type="radio" name="masa_rsvp" value="15-30 minit" class="sr-only"><span>15–30 minit</span></label>
                                <label class="choice-label text-center"><input type="radio" name="masa_rsvp" value="> 30 minit" class="sr-only"><span>&gt; 30 minit</span></label>
                            </div>
                        </div>
                    </div>
                     
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">9. Bagaimana anda merekodkan maklumat pengganti sekiranya ada? (Boleh pilih satu atau lebih)</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="rekod_pengganti" value="Kemas kini manual" class="form-checkbox"><span>Kemas kini manual dalam Google Form / Excel</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="rekod_pengganti" value="Catat semasa program" class="form-checkbox"><span>Catat secara manual semasa pendaftaran program</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="rekod_pengganti" value="Peserta isi semula" class="form-checkbox"><span>Meminta peserta pengganti mengisi semula borang pendaftaran</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="rekod_pengganti" value="Tidak direkodkan" class="form-checkbox"><span>Tidak direkodkan secara rasmi</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="rekod_pengganti" value="Lain-lain" class="form-checkbox" onchange="toggleConditionalInput(this, 'pengganti-lain-input')"><span>Lain-lain</span></label>
                            <input type="text" id="pengganti-lain-input" name="pengganti-lain" placeholder="Sila nyatakan..." class="mt-2 ml-8 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md hidden">
                        </div>
                    </div>
                </fieldset>

                <fieldset data-step="2" class="form-step space-y-6">
                    <legend class="text-xl font-semibold text-indigo-700 border-b-2 border-indigo-200 pb-2 w-full">Bahagian C: Rekod Semasa Program</legend>
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">10. Apakah kaedah yang digunakan untuk merekod kehadiran semasa program berlangsung? (Boleh pilih satu atau lebih)</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_semasa_program" value="Tandatangan manual" class="form-checkbox"><span>Tandatangan manual pada kertas</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_semasa_program" value="Imbas kod QR" class="form-checkbox"><span>Imbas kod QR (Google Form / SPLG KPM)</span></label>
                             <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_semasa_program" value="Urus setia menanda" class="form-checkbox"><span>Urus setia menanda kehadiran pada senarai nama</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="kaedah_semasa_program" value="Lain-lain" class="form-checkbox" onchange="toggleConditionalInput(this, 'kaedah-lain-input')"><span>Lain-lain</span></label>
                            <input type="text" id="kaedah-lain-input" name="kaedah-lain" placeholder="Sila nyatakan..." class="mt-2 ml-8 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md hidden">
                        </div>
                    </div>
                     <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">11. Adakah semua peserta berjaya rekod kehadiran tanpa masalah?</label>
                        <div class="flex gap-4">
                            <label class="choice-label flex-1 text-center"><input type="radio" name="rekod_berjaya" value="Ya" class="sr-only" required onchange="toggleConditionalInput(this, 'masalah-rekod-input-container')"><span>Ya</span></label>
                            <label class="choice-label flex-1 text-center"><input type="radio" name="rekod_berjaya" value="Tidak" class="sr-only" onchange="toggleConditionalInput(this, 'masalah-rekod-input-container')"><span>Tidak</span></label>
                        </div>
                         <div id="masalah-rekod-input-container" class="hidden mt-3">
                            <textarea id="masalah-rekod-input" name="masalah-rekod" rows="2" placeholder="Contoh: Peserta tiada capaian internet, kod QR tidak dapat diimbas..." class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="masalah-rekod-input-counter">0</span> / 30 patah perkataan</div>
                         </div>
                    </div>
                </fieldset>

                <fieldset data-step="3" class="form-step space-y-6">
                    <legend class="text-xl font-semibold text-indigo-700 border-b-2 border-indigo-200 pb-2 w-full">Bahagian D: Pengalaman SPLG KPM</legend>
                    
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">12. Berapa kerap anda menggunakan SPLG KPM?</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="kerap_splg" value="Sangat kerap (>5 kali sebulan)" class="form-radio" required><span>Sangat kerap (>5 kali sebulan)</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="kerap_splg" value="Kerap (2-4 kali sebulan)" class="form-radio"><span>Kerap (2-4 kali sebulan)</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="kerap_splg" value="Kadang-kadang (Sebulan sekali)" class="form-radio"><span>Kadang-kadang (Sebulan sekali)</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="kerap_splg" value="Jarang / Hanya bila diarahkan" class="form-radio"><span>Jarang / Hanya bila diarahkan</span></label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">13. Apakah cabaran utama semasa menggunakan SPLG KPM? (Boleh pilih satu atau lebih)</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="cabaran_splg" value="Laman web lambat" class="form-checkbox"><span>Laman web lambat / sering log keluar</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="cabaran_splg" value="QR sukar dijana" class="form-checkbox"><span>QR sukar dijana / diakses</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="cabaran_splg" value="Proses muat naik Excel lambat" class="form-checkbox"><span>Proses muat naik Excel mengambil masa</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="cabaran_splg" value="Tidak semua program diterima" class="form-checkbox"><span>Tidak semua program diterima sistem</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="checkbox" name="cabaran_splg" value="Lain-lain" class="form-checkbox" onchange="toggleConditionalInput(this, 'cabaran-lain-input')"><span>Lain-lain</span></label>
                             <input type="text" id="cabaran-lain-input" name="cabaran-lain" placeholder="Sila nyatakan..." class="mt-2 ml-8 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md hidden">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">14. Purata masa untuk siapkan laporan kehadiran selepas program tamat:</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="choice-label text-center"><input type="radio" name="masa_laporan" value="< 5 minit" class="sr-only" required><span>&lt; 5 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_laporan" value="5-10 minit" class="sr-only"><span>5–10 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_laporan" value="10-30 minit" class="sr-only"><span>10–30 minit</span></label>
                            <label class="choice-label text-center"><input type="radio" name="masa_laporan" value="> 30 minit" class="sr-only"><span>&gt; 30 minit</span></label>
                        </div>
                    </div>
                    
                     <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">15. Adakah anda pernah ingin rekod kehadiran untuk program tidak rasmi (cth: Bacaan Yasin, Gotong-royong)?</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="rekod_tak_rasmi" value="Ya, kerap (>5 kali sebulan)" class="form-radio" required><span>Ya, kerap (>5 kali sebulan)</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="rekod_tak_rasmi" value="Kadang-kadang (1-4 kali sebulan)" class="form-radio"><span>Kadang-kadang (1-4 kali sebulan)</span></label>
                             <label class="choice-label flex items-center gap-3"><input type="radio" name="rekod_tak_rasmi" value="Jarang (< 1 kali sebulan)" class="form-radio"><span>Jarang (&lt; 1 kali sebulan)</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="rekod_tak_rasmi" value="Tidak pernah" class="form-radio"><span>Tidak pernah</span></label>
                        </div>
                    </div>
                </fieldset>

                <fieldset data-step="4" class="form-step space-y-6">
                    <legend class="text-xl font-semibold text-indigo-700 border-b-2 border-indigo-200 pb-2 w-full">Bahagian E: Cadangan & Harapan</legend>
                    
                     <div>
                        <label class="block text-md font-semibold text-gray-700 mb-3">16. Sekiranya ada sistem yang boleh merekod semua jenis program (rasmi & tidak rasmi) dengan satu imbasan QR, adakah anda akan menggunakannya?</label>
                        <div class="space-y-3">
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="minat_sistem_baru" value="Sangat setuju / Pasti guna" class="form-radio" required><span>Sangat setuju / Pasti guna</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="minat_sistem_baru" value="Setuju" class="form-radio"><span>Setuju</span></label>
                            <label class="choice-label flex items-center gap-3"><input type="radio" name="minat_sistem_baru" value="Tidak pasti" class="form-radio"><span>Tidak pasti</span></label>
                             <label class="choice-label flex items-center gap-3"><input type="radio" name="minat_sistem_baru" value="Tidak setuju" class="form-radio"><span>Tidak setuju</span></label>
                        </div>
                    </div>

                    <div>
                        <label for="harapan_ideal" class="block text-md font-semibold text-gray-700 mb-2">17. Dalam satu ayat, apakah yang anda harapkan ada dalam sistem kehadiran digital ideal anda?</label>
                        <textarea id="harapan_ideal" name="harapan_ideal" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Contoh: Sistem yang pantas, mudah diguna, dan boleh menjana laporan secara automatik."></textarea>
                        <div class="text-right text-xs text-gray-500 mt-1"><span id="harapan_ideal-counter">0</span> / 50 patah perkataan</div>
                    </div>
                     <div>
                        <label for="cadangan_tambahan" class="block text-md font-semibold text-gray-700 mb-2">18. Cadangan tambahan untuk penambahbaikan sistem kehadiran digital:</label>
                        <textarea id="cadangan_tambahan" name="cadangan_tambahan" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Nyatakan sebarang idea atau fungsi tambahan yang anda rasa berguna."></textarea>
                        <div class="text-right text-xs text-gray-500 mt-1"><span id="cadangan_tambahan-counter">0</span> / 50 patah perkataan</div>
                    </div>

                </fieldset>

                <div id="navigation-buttons" class="pt-6 border-t flex justify-between items-center">
                    <button type="button" id="prev-btn" class="btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Kembali</button>
                    <button type="button" id="next-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Seterusnya</button>
                    <button type="submit" id="submit-btn" class="btn w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg hidden">Hantar Tinjauan</button>
                </div>
            </form>
        </div>

        <div id="thank-you-card" class="hidden card p-10 text-center">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-800">Syabas!</h2>
            <p class="mt-3 text-gray-600">Terima kasih atas jawapan anda. Anda adalah orang yang ke-<span id="response-count" class="font-bold"></span> mengisi tinjauan ini. Kami amat menghargai masa dan input yang anda berikan.</p>
            <a href="index.html" class="btn inline-block mt-8 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg">Kembali ke Halaman Utama</a>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 w-full border-t border-gray-200">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p>
        <p class="text-xs text-gray-500 mt-1">Versi 2.1 (2025)</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                initializeForm();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Gagal daftar masuk tanpa nama:", error);
                    alert("Gagal menyambung ke servis. Sila muat semula halaman.");
                }
            }
        });

        const form = document.getElementById('kajian-form');
        const steps = Array.from(form.querySelectorAll('.form-step'));
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        let currentStep = 0;

        function initializeForm() {
            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        showStep(currentStep);
                    }
                }
            });
            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
            showStep(currentStep);
            setupWordCounters();
        }

        function showStep(stepIndex) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === stepIndex);
            });
            const progress = ((stepIndex + 1) / steps.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Bahagian ${stepIndex + 1} / ${steps.length}`;
            prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-flex';
            nextBtn.style.display = stepIndex === steps.length - 1 ? 'none' : 'inline-flex';
            submitBtn.style.display = stepIndex === steps.length - 1 ? 'block' : 'none';
            if (stepIndex === 0) {
                document.getElementById('navigation-buttons').style.justifyContent = 'flex-end';
            } else {
                document.getElementById('navigation-buttons').style.justifyContent = 'space-between';
            }
        }
        
        function validateStep(stepIndex) {
            const currentStepElement = steps[stepIndex];
            currentStepElement.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
            
            const requiredInputs = currentStepElement.querySelectorAll('[required]');
            let allValid = true;
            const validatedGroups = new Set();

            for (const input of requiredInputs) {
                let isInputGroupValid = true;
                const name = input.name;

                if (input.type === 'radio') {
                    if (validatedGroups.has(name)) continue;
                    
                    const radioGroup = currentStepElement.querySelectorAll(`input[name="${name}"]`);
                    const isAnyChecked = Array.from(radioGroup).some(radio => radio.checked);
                    
                    if (!isAnyChecked) {
                        isInputGroupValid = false;
                        radioGroup.forEach(radio => radio.closest('.choice-label')?.classList.add('border-red-500'));
                    }
                    validatedGroups.add(name);
                } else {
                    if (input.value.trim() === '') {
                        isInputGroupValid = false;
                        input.classList.add('border-red-500');
                    }
                }
                
                if (!isInputGroupValid) {
                    allValid = false;
                }
            }

            if (!allValid) {
                alert('Sila lengkapkan semua soalan yang wajib di bahagian ini.');
            }
            return allValid;
        }

        function setupWordCounters() {
            const wordLimits = {
                'masalah-rekod-input': 30,
                'harapan_ideal': 50,
                'cadangan_tambahan': 50
            };
            for (const id in wordLimits) {
                const textarea = document.getElementById(id);
                const counterSpan = document.getElementById(`${id}-counter`);
                if (textarea && counterSpan) {
                    textarea.addEventListener('input', () => {
                        const text = textarea.value.trim();
                        const words = text === '' ? 0 : text.split(/\s+/).filter(Boolean).length;
                        counterSpan.textContent = words;
                        if (words > wordLimits[id]) {
                            counterSpan.parentElement.classList.add('text-red-500');
                            counterSpan.parentElement.classList.remove('text-gray-500');
                        } else {
                            counterSpan.parentElement.classList.remove('text-red-500');
                            counterSpan.parentElement.classList.add('text-gray-500');
                        }
                    });
                }
            }
        }
        
        window.toggleConditionalInput = (trigger, inputId) => {
            const target = document.getElementById(inputId);
            if (!target) return;

            let shouldShow;
            if (trigger.type === 'radio') {
                const radioGroup = form.querySelectorAll(`input[name="${trigger.name}"]:checked`);
                const selectedValue = radioGroup.length > 0 ? radioGroup[0].value : null;

                if (inputId === 'masalah-rekod-input-container') {
                    shouldShow = (selectedValue === 'Tidak');
                } else if (inputId === 'rsvp-follow-up') {
                    shouldShow = (selectedValue === 'Ya');
                } else {
                    shouldShow = (selectedValue === 'Lain-lain');
                }
            } else if (trigger.type === 'checkbox') {
                shouldShow = trigger.checked;
            }

            const radiosToMakeRequired = target.querySelectorAll('input[name="masa_rsvp"]');
            const textareaToMakeRequired = target.querySelector('textarea[name="masalah-rekod"]');

            if (shouldShow) {
                target.classList.remove('hidden');
                radiosToMakeRequired.forEach(el => el.required = true);
                if (textareaToMakeRequired) textareaToMakeRequired.required = true;
            } else {
                target.classList.add('hidden');
                radiosToMakeRequired.forEach(el => el.required = false);
                if (textareaToMakeRequired) textareaToMakeRequired.required = false;

                target.querySelectorAll('input, textarea').forEach(el => {
                    if (el.type === 'radio' || el.type === 'checkbox') el.checked = false;
                    else el.value = '';
                });
            }
        };

        window.submitSurvey = async (event) => {
            event.preventDefault();
            if (!validateStep(currentStep)) return;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menghantar...';
            
            const responsesRef = collection(db, `artifacts/${firebaseConfig.projectId}/public/data/spark_kajian_responses`);
            
            const formData = new FormData(form);
            const surveyData = {};

            const checkboxNames = new Set();
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => checkboxNames.add(cb.name));
            
            const keys = Array.from(formData.keys());
            const uniqueKeys = [...new Set(keys)];

            uniqueKeys.forEach(key => {
                if (checkboxNames.has(key)) {
                    const values = formData.getAll(key);
                    if (values.length > 0) {
                         surveyData[key] = values;
                    }
                } else {
                    surveyData[key] = formData.get(key);
                }
            });
            
            if (surveyData.jawatan === 'Lain-lain' && surveyData['jawatan-lain']) {
                surveyData.jawatan = `Lain-lain: ${surveyData['jawatan-lain']}`;
            }
             if (Array.isArray(surveyData.kaedah_rsvp) && surveyData.kaedah_rsvp.includes('Lain-lain') && surveyData['rsvp-lain']) {
                surveyData.kaedah_rsvp.push(`Lain-lain: ${surveyData['rsvp-lain']}`);
            }
            if (Array.isArray(surveyData.rekod_pengganti) && surveyData.rekod_pengganti.includes('Lain-lain') && surveyData['pengganti-lain']) {
                surveyData.rekod_pengganti.push(`Lain-lain: ${surveyData['pengganti-lain']}`);
            }
            if (Array.isArray(surveyData.kaedah_semasa_program) && surveyData.kaedah_semasa_program.includes('Lain-lain') && surveyData['kaedah-lain']) {
                surveyData.kaedah_semasa_program.push(`Lain-lain: ${surveyData['kaedah-lain']}`);
            }
             if (Array.isArray(surveyData.cabaran_splg) && surveyData.cabaran_splg.includes('Lain-lain') && surveyData['cabaran-lain']) {
                surveyData.cabaran_splg.push(`Lain-lain: ${surveyData['cabaran-lain']}`);
            }

            delete surveyData['jawatan-lain'];
            delete surveyData['rsvp-lain'];
            delete surveyData['pengganti-lain'];
            delete surveyData['kaedah-lain'];
            delete surveyData['cabaran-lain'];
            
            surveyData.timestamp = serverTimestamp();

            try {
                const snapshot = await getDocs(responsesRef);
                const currentCount = snapshot.size;
                await addDoc(responsesRef, surveyData);
                document.getElementById('response-count').textContent = currentCount + 1;
                document.getElementById('survey-card').classList.add('hidden');
                document.getElementById('thank-you-card').classList.remove('hidden');
            } catch (error) {
                console.error("Error submitting survey: ", error);
                let alertMsg = "Gagal menghantar tinjauan. Sila semak sambungan internet anda dan cuba lagi.";
                if(error.code === 'permission-denied') {
                    alertMsg = "Penghantaran gagal kerana isu kebenaran (Permission Denied). Sila hubungi pentadbir sistem dan pastikan Firebase Security Rules telah ditetapkan dengan betul.";
                }
                alert(alertMsg);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Tinjauan';
            }
        };

        document.addEventListener('DOMContentLoaded', initializeForm);
    </script>
</body>
</html>
