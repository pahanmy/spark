<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Sejarah & Perkembangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .timeline {
            position: relative;
            padding-left: 1.5rem; 
        }
        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0.25rem; 
            width: 3px;
            background-color: #e5e7eb; 
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
        }
        .timeline-date {
            font-weight: 600;
            font-size: 1.125rem; 
            margin-bottom: 0.5rem;
            color: #1f2937; 
        }
        .timeline-marker {
            position: absolute;
            left: 0;
            top: 0.375rem; 
            width: 1rem;
            height: 1rem;
            border-radius: 9999px; 
            background-color: white;
            /* Warna lalai: Indigo */
            border: 3px solid #6366f1; 
            z-index: 10;
        }
        /* Style untuk marker mengikut kategori */
        .marker-update { border-color: #3b82f6; } /* blue-500 */
        .marker-feature { border-color: #10b981; } /* emerald-500 */
        .marker-problem { border-color: #ef4444; } /* red-500 */
        .marker-suggestion { border-color: #f59e0b; } /* amber-500 */
        
        .timeline-content {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            display: flex; /* Aktifkan flex untuk susunan kandungan */
            gap: 1.5rem;
        }
        .timeline-text-content {
            flex-grow: 1;
        }
        .timeline-image-content {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            overflow: hidden;
            border-radius: 0.5rem;
            object-fit: cover;
        }
        @media (max-width: 640px) {
            .timeline-content {
                flex-direction: column;
            }
            .timeline-image-content {
                width: 100%;
                height: 180px;
            }
        }
        .timeline-content h4 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        /* Style untuk tajuk mengikut kategori */
        .title-update { color: #3b82f6; } 
        .title-feature { color: #10b981; } 
        .title-problem { color: #ef4444; } 
        .title-suggestion { color: #f59e0b; } 

        .timeline-content p {
            font-size: 0.875rem; 
            color: #4b5563;
        }
        .text-timestamp {
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-top: 0.5rem;
            display: block;
        }
        .logo-box {
            background-color: #4f46e5; 
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            width: 28px;
            border-radius: 0.5rem;
        }
        .modal-backdrop { 
            background-color: rgba(0,0,0,0.5); 
        }
        
        /* CSS BARU: Sembunyikan butang secara lalai */
        .admin-controls {
            display: none;
        }

        /* CSS BARU: Paparkan butang apabila admin mode diaktifkan */
        .admin-mode .admin-controls {
            display: flex;
        }

        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .timeline-icon-container {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            color: #4f46e5; /* Default */
        }
        .icon-update { color: #3b82f6; } 
        .icon-feature { color: #10b981; } 
        .icon-problem { color: #ef4444; } 
        .icon-suggestion { color: #f59e0b; } 

    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen pt-24">

    <!-- Header (Ambil dari program.html, diubah suai butang) -->
    <header id="page-header" class="bg-white shadow-sm fixed top-0 left-0 right-0 z-40 w-full">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="logo-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-2 sm:gap-4 flex-wrap">
                 <a href="index.html" class="bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-200 flex items-center gap-2 text-xs sm:text-sm transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.586l3-3 3 3V17a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>Halaman Utama</a>
                 <a href="program.html" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2 text-xs sm:text-sm transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Dashboard Program
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-8 sm:px-6 lg:px-8 flex-grow w-full relative">
        
        <!-- BUTANG LOCK/UNLOCK BARU (Untuk mengaktifkan/menyahaktifkan Admin Mode) -->
        <div class="absolute top-4 right-4 z-20">
            <button id="admin-lock-btn" onclick="promptAdminAuth('sejarah')" class="btn p-3 bg-white rounded-full shadow-md hover:bg-gray-100">
                <svg id="lock-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                 <svg id="unlock-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>
            </button>
        </div>
        
        <div class="flex flex-wrap justify-between items-center mb-10 gap-4">
            <div class="text-left">
                 <h2 class="text-3xl font-extrabold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Sejarah & Perkembangan SPARK
                </h2>
                <p class="mt-2 text-lg text-gray-500">Garis Masa Pembangunan dan Pencapaian Utama Sistem</p>
            </div>
            
            <!-- BUTANG TAMBAH - Hanya dipaparkan dalam Admin Mode -->
            <button id="add-history-btn" onclick="openAddModal()" class="admin-controls bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 items-center gap-2 text-sm transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Tambah Rekod Sejarah
            </button>
            <!-- AKHIR BUTANG TAMBAH -->
        </div>

        <div id="timeline-container" class="timeline w-full">
            <div id="loading-spinner" class="text-center p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-600">Memuatkan data sejarah...</p>
            </div>
            <!-- Timeline items will be injected here -->
        </div>

        <div id="timeline-error" class="hidden text-center p-10 card bg-red-50 text-red-800 border border-red-200">
            <p class="font-semibold">Ralat Memuatkan Data</p>
            <p class="text-sm">Gagal memuatkan sejarah perkembangan. Sila cuba muat semula halaman.</p>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200"><p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p><p id="version-info" class="text-xs text-gray-500">Versi 2.1</p></footer>
    
    <!-- MODAL PENGESAHAN ADMIN -->
    <div id="admin-auth-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-semibold mb-2">Pengesahan Pentadbir</h3>
            <p class="text-sm text-gray-600 mb-4">Sila masukkan No. IC Pentadbir untuk meneruskan.</p>
            <input type="hidden" id="admin-auth-next-modal">
            <input type="password" id="admin-auth-ic-input" placeholder="Masukkan No. IC Pentadbir" class="block w-full px-4 py-2 border border-gray-300 rounded-md mb-2">
            <p id="admin-auth-error" class="text-red-500 text-sm hidden mb-4">No. IC tidak sepadan.</p>
            <div class="mt-4 flex justify-end space-x-3">
                <button type="button" onclick="closeModal('admin-auth-modal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">Batal</button>
                <button type="button" onclick="verifyAdmin('890522135381', 'sejarah')" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Sahkan</button>
            </div>
        </div>
    </div>

    <!-- MODAL TAMBAH REKOD SEJARAH BARU -->
    <div id="add-history-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">Tambah Rekod Perkembangan SPARK</h3>
            <form id="add-history-form" onsubmit="addHistoryRecord(event)" class="space-y-4">
                <div>
                    <label for="history-type" class="block text-sm font-medium text-gray-700">Kategori / Jenis Rekod</label>
                    <select id="history-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white" required>
                        <option value="update">Kemaskini (Update)</option>
                        <option value="feature">Fungsi Baharu (New Feature)</option>
                        <option value="problem">Isu / Ralat (Problem)</option>
                        <option value="suggestion">Cadangan (Suggestion/Idea)</option>
                    </select>
                </div>
                <div>
                    <label for="history-date" class="block text-sm font-medium text-gray-700">Tarikh Kejadian / Perkembangan</label>
                    <input type="date" id="history-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="history-title" class="block text-sm font-medium text-gray-700">Tajuk Utama (Contoh: Pelancaran V2.0)</label>
                    <input type="text" id="history-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required maxlength="100">
                </div>
                <div>
                    <label for="history-subtitle" class="block text-sm font-medium text-gray-700">Subtajuk (Ringkasan Kemaskini)</label>
                    <input type="text" id="history-subtitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" maxlength="150">
                </div>
                <div>
                    <label for="history-image-url" class="block text-sm font-medium text-gray-700">URL Gambar/Imej (Pilihan)</label>
                    <input type="url" id="history-image-url" placeholder="http://atau-https://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="history-description" class="block text-sm font-medium text-gray-700 flex justify-between items-center">
                        <span>Deskripsi Penuh (Guna 'Enter' untuk perenggan baru)</span>
                        <button type="button" onclick="insertBullet('history-description')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full hover:bg-gray-200 transition duration-150">
                            Masukkan List Item
                        </button>
                    </label>
                    <textarea id="history-description" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('add-history-modal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">Batal</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">Simpan Rekod</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDIT REKOD SEJARAH (Struktur yang sama dengan modal Tambah) -->
    <div id="edit-history-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">Edit Rekod Perkembangan SPARK</h3>
            <form id="edit-history-form" onsubmit="updateHistoryRecord(event)" class="space-y-4">
                <input type="hidden" id="edit-record-id">
                <div>
                    <label for="edit-history-type" class="block text-sm font-medium text-gray-700">Kategori / Jenis Rekod</label>
                    <select id="edit-history-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white" required>
                        <option value="update">Kemaskini (Update)</option>
                        <option value="feature">Fungsi Baharu (New Feature)</option>
                        <option value="problem">Isu / Ralat (Problem)</option>
                        <option value="suggestion">Cadangan (Suggestion/Idea)</option>
                    </select>
                </div>
                <div>
                    <label for="edit-history-date" class="block text-sm font-medium text-gray-700">Tarikh Kejadian / Perkembangan</label>
                    <input type="date" id="edit-history-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-history-title" class="block text-sm font-medium text-gray-700">Tajuk Utama (Contoh: Pelancaran V2.0)</label>
                    <input type="text" id="edit-history-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required maxlength="100">
                </div>
                <div>
                    <label for="edit-history-subtitle" class="block text-sm font-medium text-gray-700">Subtajuk (Ringkasan Kemaskini)</label>
                    <input type="text" id="edit-history-subtitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" maxlength="150">
                </div>
                 <div>
                    <label for="edit-history-image-url" class="block text-sm font-medium text-gray-700">URL Gambar/Imej (Pilihan)</label>
                    <input type="url" id="edit-history-image-url" placeholder="http://atau-https://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="edit-history-description" class="block text-sm font-medium text-gray-700 flex justify-between items-center">
                        <span>Deskripsi Penuh (Guna 'Enter' untuk perenggan baru)</span>
                         <button type="button" onclick="insertBullet('edit-history-description')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full hover:bg-gray-200 transition duration-150">
                            Masukkan List Item
                        </button>
                    </label>
                    <textarea id="edit-history-description" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                </div>
                <div class="mt-6 flex justify-between space-x-3">
                    <button type="button" onclick="deleteHistoryRecord()" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> Padam
                    </button>
                    <div class="flex space-x-3">
                         <button type="button" onclick="closeModal('edit-history-modal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">Batal</button>
                         <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Simpan Perubahan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Definisikan konfigurasi Firebase secara kukuh (hardcoded) sebagai fallback
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.firebasestorage.app",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        // Ambil konfigurasi dari environment, jika gagal, gunakan hardcoded config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : hardcodedFirebaseConfig;
        
        // Dapatkan tokenAuth secara langsung dari global variable
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // No. IC Pentadbir Ditetapkan
        const ADMIN_IC = '890522135381';

        let db, auth, userId;
        let historyRecords = []; // Simpan semua rekod untuk edit
        
        // Peta jenis rekod kepada ikon SVG dan warna CSS
        const recordTypes = {
            'update': {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`,
                markerClass: 'marker-update',
                titleClass: 'title-update',
                iconClass: 'icon-update'
            },
            'feature': {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M19 12h1M18.364 18.364l-.707-.707M12 21v-1M5.636 18.364l.707-.707M4 12H3m1.636-6.364l.707-.707M6 10v4a2 2 0 002 2h6a2 2 0 002-2v-4"/></svg>`,
                markerClass: 'marker-feature',
                titleClass: 'title-feature',
                iconClass: 'icon-feature'
            },
            'problem': {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
                markerClass: 'marker-problem',
                titleClass: 'title-problem',
                iconClass: 'icon-problem'
            },
            'suggestion': {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M19 12h1M18.364 18.364l-.707-.707M12 21v-1M5.636 18.364l.707-.707M4 12H3m1.636-6.364l.707-.707M6 10v4a2 2 0 002 2h6a2 2 0 002-2v-4"/></svg>`,
                markerClass: 'marker-suggestion',
                titleClass: 'title-suggestion',
                iconClass: 'icon-suggestion'
            }
        };

        // Fungsi untuk menguruskan paparan ralat UI
        function showLoadingError(message = "Ralat Memuatkan Data") {
             const loadingSpinner = document.getElementById('loading-spinner');
             const errorDiv = document.getElementById('timeline-error');
             
             if (loadingSpinner) loadingSpinner.classList.add('hidden');
             
             if (errorDiv) {
                errorDiv.querySelector('.font-semibold').textContent = message;
                errorDiv.classList.remove('hidden');
             } else {
                 console.error("Error div not found in DOM.");
             }
        }

        function closeModal(modalId) {
             document.getElementById(modalId)?.classList.add('hidden');
             if (modalId === 'admin-auth-modal') {
                 document.getElementById('admin-auth-ic-input').value = '';
                 document.getElementById('admin-auth-error').classList.add('hidden');
             }
        }
        
        function openAddModal() {
             document.getElementById('add-history-form').reset();
             document.getElementById('history-type').value = 'update'; // Tetapkan lalai
             document.getElementById('add-history-modal').classList.remove('hidden');
        }
        
        // FUNGSI BARU: Masukkan Bullet List Item
        window.insertBullet = function(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            const bullet = "• ";
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            // Masukkan bullet pada kedudukan kursor
            const newValue = value.substring(0, start) + bullet + value.substring(end);

            textarea.value = newValue;
            
            // Gerakkan kursor selepas bullet yang dimasukkan
            const newCursorPosition = start + bullet.length;
            textarea.selectionStart = newCursorPosition;
            textarea.selectionEnd = newCursorPosition;
            textarea.focus();
        }

        try {
            // ** PEMBETULAN UNTUK MENGATASI ralat "projectId" **
            // Langkah 1: Buat salinan konfigurasi yang efektif
            const effectiveConfig = { ...firebaseConfig };
            // Langkah 2: Gunakan appId sebagai fallback jika projectId tiada
            if (!effectiveConfig.projectId && appId !== 'default-app-id') {
                effectiveConfig.projectId = appId;
            }
            
            const app = initializeApp(effectiveConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Log masuk menggunakan token tersuai atau anonim
            onAuthStateChanged(auth, async (user) => {
                if (user) { 
                    userId = user.uid; 
                    fetchTimelineData(); 
                } else { 
                    try { 
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken); 
                        } else {
                            await signInAnonymously(auth); 
                        }
                    } catch (error) { 
                        console.error("Ralat log masuk:", error); 
                        showLoadingError("Gagal log masuk. Sila cuba muat semula.");
                    } 
                }
            });
            
        } catch (e) { 
            console.error("Ralat memulakan Firebase:", e);
            // Menukar mesej ralat agar lebih generik apabila init gagal
            showLoadingError("Ralat inisialisasi sistem. (Sila semak konfigurasi konsol)");
        }
        
        // FUNGSI UTAMA UNTUK MENDAPATKAN DATA GARIS MASA
        function fetchTimelineData() {
            if (!db || !userId) return; 

            const timelineRef = collection(db, `artifacts/${appId}/public/data/spark_history`);
            const q = query(timelineRef); 

            onSnapshot(q, (snapshot) => {
                const timelineItems = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    let timestamp = 0;
                    if (data.date_timestamp && typeof data.date_timestamp.toMillis === 'function') {
                        timestamp = data.date_timestamp.toMillis();
                    } else if (data.date) {
                         try { timestamp = new Date(data.date).getTime(); } catch(e) {}
                    } else if (data.createdAt && typeof data.createdAt.toDate === 'function') {
                         timestamp = data.createdAt.toDate().getTime();
                    }

                    timelineItems.push({ 
                        id: doc.id, 
                        ...data,
                        timestamp: timestamp, 
                    });
                });
                
                // Simpan rekod dalam pembolehubah global untuk fungsi edit
                historyRecords = timelineItems;
                
                timelineItems.sort((a, b) => b.timestamp - a.timestamp);

                renderTimeline(timelineItems);
                // Sembunyikan spinner selepas data dimuat
                const loadingSpinner = document.getElementById('loading-spinner');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');

            }, (error) => {
                console.error("Ralat mendengar perubahan sejarah:", error);
                showLoadingError(error.message === "Missing or insufficient permissions." 
                    ? "Ralat Kebenaran Akses Data. (Sila semak Peraturan Keselamatan Firestore)." 
                    : "Gagal memuatkan sejarah perkembangan.");
            });
        }
        
        // FUNGSI UNTUK MERENDER GARIS MASA
        function renderTimeline(items) {
            const container = document.getElementById('timeline-container');
            if (!container) return; // Tambah null check untuk container

            const isAdminMode = document.body.classList.contains('admin-mode');

            if (items.length === 0) {
                container.innerHTML = `<div class="text-center p-10 card bg-white text-gray-500">Tiada rekod sejarah ditemui.</div>`;
                return;
            }

            let html = '';
            let currentMonthYear = '';

            items.forEach(item => {
                const dateObj = new Date(item.timestamp);
                
                if (isNaN(dateObj.getTime())) return; 
                
                const monthYear = dateObj.toLocaleDateString('ms-MY', { year: 'numeric', month: 'long' });
                
                // Semak untuk header bulan/tahun baru
                if (monthYear !== currentMonthYear) {
                    html += `<h3 class="text-2xl font-bold text-gray-800 mt-8 mb-4">${monthYear}</h3>`;
                    currentMonthYear = monthYear;
                }

                // Tetapkan jenis dan ambil konfigurasi
                const type = item.type || 'update';
                const typeConfig = recordTypes[type] || recordTypes['update'];

                // Format masa
                const itemDate = dateObj.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                const itemTime = dateObj.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: false });
                const itemDayTime = `${itemDate} ${itemTime}`;
                
                // Mengendalikan deskripsi (termasuk list item)
                const contentText = Array.isArray(item.description) 
                                ? item.description.map(desc => {
                                    const processedDesc = desc.startsWith('• ') 
                                        ? `<li class="flex items-start mt-1 text-sm"><span class="mr-2 text-indigo-500">•</span><span class="text-gray-700">${desc.substring(2)}</span></li>`
                                        : `<p class="mt-2 text-sm">${desc}</p>`;
                                    return processedDesc;
                                }).join('') 
                                : `<p class="mt-2 text-sm">${item.description || ''}</p>`;
                                
                const imageContent = item.imageUrl 
                                ? `<img src="${item.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/120x120/E5E7EB/4B5563?text=Tiada+Imej';" alt="${item.title}" class="timeline-image-content">`
                                : '';
                                
                const editButton = isAdminMode 
                                ? `<button onclick="openEditModal('${item.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs font-semibold px-2 py-1 rounded-full bg-indigo-100/70 ml-auto transition duration-300">Edit</button>`
                                : '';
                                
                const titleText = item.title || 'Kemaskini';
                const subtitleText = item.subtitle || titleText || 'Perkembangan SPARK';

                html += `
                    <div class="timeline-item">
                        <div class="timeline-marker ${typeConfig.markerClass}"></div>
                        <div class="timeline-date flex items-center gap-4">
                            <div class="timeline-icon-container ${typeConfig.iconClass}">${typeConfig.icon}</div>
                            <span class="font-semibold text-gray-800">${titleText}</span>
                            ${editButton}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-text-content">
                                <h4 class="text-base ${typeConfig.titleClass}">${subtitleText}</h4>
                                <div class="mt-2">
                                    ${item.description && item.description.length > 0 && item.description.some(d => d.startsWith('• ')) ? `<ul class="list-none space-y-1">${contentText}</ul>` : contentText}
                                </div>
                                <span class="text-timestamp">Direkodkan pada: ${itemDayTime}</span>
                            </div>
                            ${imageContent}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // FUNGSI KHAS: PENGESAHAN ADMIN
        window.promptAdminAuth = function(pageId) {
            if (document.body.classList.contains('admin-mode')) {
                // *** LOGIK UNTUK LOCK ***
                if (confirm('Keluar dari Mod Pentadbir?')) {
                    setAdminMode(false);
                }
                return;
            }
            
            // Masuk ke mod admin (tunjukkan modal pengesahan)
            document.getElementById('admin-auth-ic-input').value = '';
            document.getElementById('admin-auth-error').classList.add('hidden');
            document.getElementById('admin-auth-modal').classList.remove('hidden');
        }

        window.verifyAdmin = function(correctIc, pageId) {
            const enteredIc = document.getElementById('admin-auth-ic-input').value.trim();

            if (enteredIc === correctIc) {
                closeModal('admin-auth-modal');
                setAdminMode(true); // Aktifkan mod admin
            } else {
                document.getElementById('admin-auth-error').classList.remove('hidden');
            }
        }
        
        // FUNGSI BARU: Set Admin Mode
        function setAdminMode(enable) {
             document.body.classList.toggle('admin-mode', enable);
             
             // Pastikan ikon dikemas kini
             const lockIcon = document.getElementById('lock-icon');
             const unlockIcon = document.getElementById('unlock-icon');
             
             if(lockIcon) lockIcon.classList.toggle('hidden', enable);
             if(unlockIcon) unlockIcon.classList.toggle('hidden', !enable);

             // Render semula timeline untuk memaparkan/menyembunyikan butang edit
             renderTimeline(historyRecords.sort((a, b) => b.timestamp - a.timestamp)); 
        }

        // FUNGSI KHAS: TAMBAH REKOD SEJARAH
        window.addHistoryRecord = async function(event) {
            event.preventDefault();

            const type = document.getElementById('history-type').value;
            const dateInput = document.getElementById('history-date').value;
            const title = document.getElementById('history-title').value.trim();
            const subtitle = document.getElementById('history-subtitle').value.trim();
            const imageUrl = document.getElementById('history-image-url').value.trim();
            const descriptionText = document.getElementById('history-description').value.trim();
            
            // Pecahkan deskripsi berdasarkan baris baru untuk menjadikannya array
            const descriptionArray = descriptionText.split('\n').filter(p => p.trim() !== '');

            if (!dateInput || !title || descriptionArray.length === 0) {
                alert("Sila lengkapkan semua medan mandatori.");
                return;
            }

            const newRecord = {
                type: type, // Simpan jenis rekod
                date: dateInput,
                title: title,
                subtitle: subtitle || null,
                imageUrl: imageUrl || null,
                description: descriptionArray,
                createdAt: serverTimestamp(),
                // Firestore akan memerlukan objek Date untuk mencipta Timestamp
                date_timestamp: new Date(dateInput), 
            };

            const timelineRef = collection(db, `artifacts/${appId}/public/data/spark_history`);

            try {
                await addDoc(timelineRef, newRecord);
                alert("Rekod sejarah baru berjaya ditambah!");
                closeModal('add-history-modal');
            } catch (error) {
                console.error("Error adding history record: ", error);
                alert("Gagal menambah rekod sejarah. Sila semak konsol.");
            }
        }
        
        // FUNGSI BARU: BUKA MODAL EDIT
        window.openEditModal = function(id) {
            const record = historyRecords.find(r => r.id === id);
            if (!record) {
                alert("Rekod tidak ditemui.");
                return;
            }
            
            // Isi borang edit
            document.getElementById('edit-record-id').value = record.id;
            document.getElementById('edit-history-type').value = record.type || 'update'; // Muatkan jenis
            document.getElementById('edit-history-date').value = record.date;
            document.getElementById('edit-history-title').value = record.title || '';
            document.getElementById('edit-history-subtitle').value = record.subtitle || '';
            document.getElementById('edit-history-image-url').value = record.imageUrl || '';
            
            // Gabungkan array deskripsi kembali menjadi string dengan baris baru
            const descriptionString = Array.isArray(record.description) ? record.description.join('\n') : (record.description || '');
            document.getElementById('edit-history-description').value = descriptionString;
            
            document.getElementById('edit-history-modal').classList.remove('hidden');
        }

        // FUNGSI BARU: KEMAS KINI REKOD SEJARAH
        window.updateHistoryRecord = async function(event) {
            event.preventDefault();
            const recordId = document.getElementById('edit-record-id').value;

            const type = document.getElementById('edit-history-type').value;
            const dateInput = document.getElementById('edit-history-date').value;
            const title = document.getElementById('edit-history-title').value.trim();
            const subtitle = document.getElementById('edit-history-subtitle').value.trim();
            const imageUrl = document.getElementById('edit-history-image-url').value.trim();
            const descriptionText = document.getElementById('edit-history-description').value.trim();
            
            const descriptionArray = descriptionText.split('\n').filter(p => p.trim() !== '');

            if (!recordId || !dateInput || !title || descriptionArray.length === 0) {
                alert("Sila lengkapkan semua medan mandatori.");
                return;
            }

            const updatedData = {
                type: type, // Kemas kini jenis rekod
                date: dateInput,
                title: title,
                subtitle: subtitle || null,
                imageUrl: imageUrl || null,
                description: descriptionArray,
                // Kemas kini timestamp agar urutan garis masa dikemas kini
                date_timestamp: new Date(dateInput), 
            };

            const recordRef = doc(db, `artifacts/${appId}/public/data/spark_history`, recordId);

            try {
                await updateDoc(recordRef, updatedData);
                alert("Rekod sejarah berjaya dikemaskini!");
                closeModal('edit-history-modal');
            } catch (error) {
                console.error("Error updating history record: ", error);
                alert("Gagal mengemas kini rekod sejarah. Sila semak konsol.");
            }
        }
        
        // FUNGSI BARU: PADAM REKOD SEJARAH
        window.deleteHistoryRecord = async function() {
            const recordId = document.getElementById('edit-record-id').value;
            if (!recordId) return;

            if (!confirm("Anda pasti mahu memadam rekod sejarah ini secara kekal?")) {
                return;
            }

            const recordRef = doc(db, `artifacts/${appId}/public/data/spark_history`, recordId);
            try {
                await deleteDoc(recordRef);
                alert("Rekod sejarah berjaya dipadam!");
                closeModal('edit-history-modal');
            } catch (error) {
                console.error("Error deleting history record: ", error);
                alert("Gagal memadam rekod sejarah. Sila semak konsol.");
            }
        }

        Object.assign(window, { closeModal, verifyAdmin, promptAdminAuth, setAdminMode, openAddModal, addHistoryRecord, openEditModal, updateHistoryRecord, deleteHistoryRecord, insertBullet });
    </script>
</body>
</html>
