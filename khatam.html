<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadarus Bulan Ramadhan, PPD Miri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, where, onSnapshot, updateDoc, arrayUnion, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Data Constants ---
        const juzukNames = [
            "Alif Lam Mim", "Sayaqulu", "Tilka Rusul", "Lan Tanalu", "Wal Muhsanat", 
            "La Yuhibbullah", "Wa Iza Samiu", "Wa Lau Annana", "Qalal Malao", "Wa A'lamu",
            "Ya'tazeruna", "Wa Ma Min Dabbah", "Wa Ma Ubarri'u", "Rubama", "Subhanallazi",
            "Qala Alam", "Iqtaraba", "Qad Aflaha", "Wa Qalallazina", "Amman Khalaqa",
            "Utlu Ma Uhiya", "Wa Man Yaqnut", "Wa Maliya", "Faman Azlamu", "Ilaihi Yuraddu",
            "Ha Mim", "Qala Fama Khatbukum", "Qad Sami'allah", "Tabarakallazi", "'Amma Yatasa'alun"
        ];

        const juzukVersesCount = [
            148, 111, 126, 131, 124, 110, 149, 142, 159, 127,
            151, 170, 154, 227, 185, 269, 190, 202, 339, 171,
            178, 169, 357, 175, 246, 195, 399, 137, 431, 564
        ];

        const userFirebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.firebasestorage.app",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        let firebaseConfig = userFirebaseConfig; 
        let artifactAppId = 'myqrhadir';   
        let app, auth, db;
        let isOnlineMode = false;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isOnlineMode = true;
        } catch (e) {
            console.warn("Switching to Offline Mode.", e);
        }

        let currentUser = null;
        let juzukData = {}; 
        let currentJuzukSelection = null; 

        async function initApp() {
            if (isOnlineMode) {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        initFirestoreListeners();
                        document.getElementById('modeIndicator').innerHTML = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-[10px] font-bold border border-green-200"><i class="fas fa-cloud"></i> Online</span>';
                    }
                });
            } else {
                loadFromLocalStorage();
                document.getElementById('modeIndicator').innerHTML = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-[10px] font-bold border border-gray-300"><i class="fas fa-save"></i> Local Mode</span>';
                renderList();
            }
        }

        initApp();

        function initFirestoreListeners() {
            const dataRef = collection(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_data');
            onSnapshot(dataRef, (snapshot) => {
                const newData = {};
                snapshot.forEach(doc => { newData[doc.id] = doc.data(); });
                juzukData = newData;
                renderList();
            });
        }

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('tadarus_data_v2');
            if (stored) { juzukData = JSON.parse(stored); }
        }

        function saveToLocalStorage() {
            localStorage.setItem('tadarus_data_v2', JSON.stringify(juzukData));
            renderList();
        }

        window.openRegistrationModal = openRegistrationModal;
        window.checkIC = checkIC;
        window.confirmRegistration = confirmRegistration;
        window.toggleStatus = toggleStatus;
        window.removeParticipant = removeParticipant;
        window.copyToWhatsapp = copyToWhatsapp;
        window.closeModal = closeModal;
        window.clearAllData = clearAllData;

        function getDaysRemaining() {
            const targetDate = new Date("2026-03-06");
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
        }

        async function checkIC() {
            let icRaw = document.getElementById('modalIC').value.trim();
            const icInput = icRaw.replace(/[^0-9a-zA-Z]/g, '');
            const feedbackArea = document.getElementById('icFeedback');
            const nameInputContainer = document.getElementById('nameInputContainer');
            const nameInput = document.getElementById('modalName');
            const submitBtn = document.getElementById('submitBtn');

            if (icInput.length < 6) {
                feedbackArea.innerHTML = `<span class="text-red-500 text-xs">Sila masukkan No. IC yang sah.</span>`;
                return;
            }

            feedbackArea.innerHTML = `<span class="text-gray-500 text-xs"><i class="fas fa-circle-notch fa-spin"></i> Mencari rekod...</span>`;
            
            if (isOnlineMode) {
                try {
                    const userRef = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_users', icInput);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) { foundUser(userSnap.data(), "Rekod Tadarus"); return; }

                    const sparkCollections = ['spark_participants', 'spark_school_auth', 'spark_ppd_officers', 'spark_staff'];
                    for (const col of sparkCollections) {
                        const q = query(collection(db, 'artifacts', artifactAppId, 'public', 'data', col), where("ic", "==", icInput));
                        const snap = await getDocs(q);
                        if (!snap.empty) { foundUser(snap.docs[0].data(), "Rekod Rasmi"); return; }
                    }
                    promptNewUser(nameInput, nameInputContainer, feedbackArea, submitBtn);
                } catch (e) { feedbackArea.innerHTML = `<span class="text-red-500 text-xs">Ralat sambungan.</span>`; }
            } else {
                promptNewUser(nameInput, nameInputContainer, feedbackArea, submitBtn);
            }
        }

        function foundUser(data, msg) {
            const name = data.name || data.nama || data.full_name || data.Nama || "";
            const feedbackArea = document.getElementById('icFeedback');
            const nameInputContainer = document.getElementById('nameInputContainer');
            const nameInput = document.getElementById('modalName');
            const submitBtn = document.getElementById('submitBtn');

            if (name) {
                nameInput.value = name;
                nameInput.disabled = true;
                nameInputContainer.classList.remove('hidden');
                feedbackArea.innerHTML = `<span class="text-green-600 text-xs font-bold"><i class="fas fa-check-circle"></i> ${msg} ditemui: ${name}</span>`;
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                promptNewUser(nameInput, nameInputContainer, feedbackArea, submitBtn);
            }
        }

        function promptNewUser(nameInput, container, feedback, btn) {
            nameInput.value = '';
            nameInput.disabled = false;
            container.classList.remove('hidden');
            feedback.innerHTML = `<span class="text-amber-600 text-xs font-bold"><i class="fas fa-info-circle"></i> Peserta Baru. Sila masukkan nama.</span>`;
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function confirmRegistration() {
            const icRaw = document.getElementById('modalIC').value.trim();
            const ic = icRaw.replace(/[^0-9a-zA-Z]/g, '');
            const name = document.getElementById('modalName').value.trim();
            const juzukId = currentJuzukSelection.toString();
            
            if (!name || !ic) return;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            if (isOnlineMode) {
                try {
                    const userRef = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_users', ic);
                    await setDoc(userRef, { name: name, ic: ic, last_updated: new Date().toISOString() }, { merge: true });
                    const juzukRef = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_data', juzukId);
                    await setDoc(juzukRef, {
                        participants: arrayUnion({ ic, name, status: 'reading', timestamp: Date.now() }),
                        juzuk_id: parseInt(juzukId)
                    }, { merge: true });
                    closeModal();
                    showToast(`Berjaya: ${name}`);
                } catch (e) { alert("Gagal menyimpan."); }
            } else {
                if (!juzukData[juzukId]) juzukData[juzukId] = { participants: [] };
                juzukData[juzukId].participants.push({ ic, name, status: 'reading', timestamp: Date.now() });
                saveToLocalStorage();
                closeModal();
            }
            submitBtn.disabled = false;
        }

        async function toggleStatus(juzukId, ic, currentStatus) {
            const juzukStr = juzukId.toString();
            const newStatus = currentStatus === 'done' ? 'reading' : 'done';
            if (isOnlineMode) {
                const juzukRef = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_data', juzukStr);
                const docSnap = await getDoc(juzukRef);
                if (docSnap.exists()) {
                    const updated = docSnap.data().participants.map(p => p.ic === ic ? { ...p, status: newStatus } : p);
                    await updateDoc(juzukRef, { participants: updated });
                }
            } else {
                const p = juzukData[juzukStr].participants.find(p => p.ic === ic);
                if (p) { p.status = newStatus; saveToLocalStorage(); }
            }
        }

        // --- FUNGSI PADAM DENGAN PENGESAHAN IC (KEMAS KINI) ---
        async function removeParticipant(juzukId, ic, name) {
            const inputIC = prompt(`Sila masukkan No. IC untuk mengesahkan pemadaman bagi: ${name}`);
            if (inputIC === null) return; 

            const cleanedInputIC = inputIC.replace(/[^0-9a-zA-Z]/g, '');
            if (cleanedInputIC !== ic) {
                alert("Ralat: No. IC yang dimasukkan tidak sepadan. Pemadaman dibatalkan.");
                return;
            }

            const juzukStr = juzukId.toString();
            if (isOnlineMode) {
                const juzukRef = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_data', juzukStr);
                try {
                    const docSnap = await getDoc(juzukRef);
                    if (docSnap.exists()) {
                        const updated = docSnap.data().participants.filter(p => p.ic !== ic);
                        await updateDoc(juzukRef, { participants: updated });
                        showToast("Peserta berjaya dipadam.");
                    }
                } catch (e) { console.error(e); }
            } else {
                if (juzukData[juzukStr] && juzukData[juzukStr].participants) {
                    juzukData[juzukStr].participants = juzukData[juzukStr].participants.filter(p => p.ic !== ic);
                    saveToLocalStorage();
                    showToast("Peserta dipadam (Lokal).");
                }
            }
        }

        async function clearAllData() {
            if (!confirm("AWAS: Padam SEMUA data?")) return;
            const pin = prompt("Sila masukkan PIN Keselamatan (1234):");
            if (pin !== "1234") { alert("PIN Salah"); return; }
            
            if (isOnlineMode) {
                 for(let i=1; i<=30; i++) {
                     const ref = doc(db, 'artifacts', artifactAppId, 'public', 'data', 'tadarus_data', i.toString());
                     await setDoc(ref, { participants: [] });
                 }
            } else {
                juzukData = {};
                localStorage.removeItem('tadarus_data_v2');
                renderList();
            }
            showToast("Data diset semula.");
        }

        function renderList() {
            const container = document.getElementById('juzukContainer');
            container.innerHTML = '';
            const daysLeft = getDaysRemaining();
            document.getElementById('daysRemainingBadge').innerText = `${daysLeft} Hari Lagi`;
            document.getElementById('targetDateDisplay').innerText = `Sasaran: 6 Mac 2026`;

            let totalParticipants = 0;
            let totalDone = 0;

            for (let i = 1; i <= 30; i++) {
                const data = juzukData[i.toString()] || { participants: [] };
                const participants = data.participants || [];
                totalParticipants += participants.length;
                const doneInJuz = participants.filter(p => p.status === 'done').length;
                totalDone += doneInJuz;
                const isJuzukComplete = participants.length > 0 && doneInJuz === participants.length;

                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl card-shadow border-l-4 transition-all mb-3 ${isJuzukComplete ? 'border-green-500 bg-green-50/50' : 'border-emerald-500'}`;
                
                const juzName = juzukNames[i-1];
                const totalAyat = juzukVersesCount[i-1];
                const activeParticipants = participants.length > 0 ? participants.length : 1;
                const ayatPerPersonTotal = Math.ceil(totalAyat / activeParticipants);
                const ayatPerDay = daysLeft > 0 ? Math.ceil(ayatPerPersonTotal / daysLeft) : ayatPerPersonTotal;

                let splitInfoText = participants.length > 1 ? `
                    <div class="mt-1 text-[10px] text-emerald-600 bg-emerald-100/50 px-2 py-1 rounded inline-block">
                        <i class="fas fa-users mr-1"></i> Dikongsi ${participants.length} orang (${ayatPerPersonTotal} ayat/seorang)
                    </div>
                ` : '';

                const progressNote = isJuzukComplete 
                    ? `<div class="bg-green-50 p-2 rounded-lg border border-green-100 mb-2 flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <p class="text-xs font-bold text-green-700">Juzuk Selesai</p>
                     </div>`
                    : `<div class="bg-blue-50/80 p-3 rounded-lg border border-blue-100 mb-2">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-blue-600 uppercase font-bold tracking-wide">Target Harian Anda</span>
                                <span class="text-[10px] text-gray-400">Total Juz: ${totalAyat} ayat</span>
                            </div>
                            <div class="flex items-end gap-1 mt-1">
                                <span class="text-2xl font-bold text-blue-700 leading-none">${ayatPerDay}</span>
                                <span class="text-xs text-blue-600 font-medium mb-0.5">ayat / hari</span>
                            </div>
                            ${splitInfoText}
                        </div>
                     </div>`;

                let participantsHtml = participants.length > 0 ? `<div class="mt-3 space-y-2">` + participants.map(p => `
                    <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2 border border-gray-100 group">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleStatus(${i}, '${p.ic}', '${p.status}')" class="w-6 h-6 rounded flex items-center justify-center transition-colors ${p.status === 'done' ? 'bg-green-500 text-white border-green-500' : 'bg-white border-gray-300'}">
                                ${p.status === 'done' ? '<i class="fas fa-check text-xs"></i>' : ''}
                            </button>
                            <span class="text-sm font-semibold text-gray-800 ${p.status === 'done' ? 'line-through text-gray-400' : ''}">${p.name}</span>
                        </div>
                        <button onclick="removeParticipant(${i}, '${p.ic}', '${p.name}')" class="text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('') + `</div>` : `<div class="mt-2 text-xs text-gray-400 italic">Belum ada peserta.</div>`;

                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex flex-col items-center justify-center w-14 text-center pt-1">
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Juz</span>
                            <span class="text-xl font-bold text-emerald-700 font-arabic leading-none">${i}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-[10px] font-semibold text-emerald-600 uppercase tracking-wide truncate pr-2">${juzName}</div>
                                <button onclick="openRegistrationModal(${i})" class="shrink-0 text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-2 py-1 rounded-full font-medium">
                                    <i class="fas fa-plus mr-1"></i> Tambah
                                </button>
                            </div>
                            ${progressNote}
                            ${participantsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
            const perc = totalParticipants > 0 ? Math.round((totalDone / totalParticipants) * 100) : 0;
            document.getElementById('progressBar').style.width = `${perc}%`;
            document.getElementById('completedCount').innerText = `${totalDone} Selesai dibaca`;
        }

        function openRegistrationModal(juz) {
            currentJuzukSelection = juz;
            document.getElementById('modalJuzInfo').innerText = `Juzuk ${juz} (${juzukNames[juz-1]})`;
            document.getElementById('modalIC').value = '';
            document.getElementById('modalName').value = '';
            document.getElementById('icFeedback').innerHTML = '';
            document.getElementById('nameInputContainer').classList.add('hidden');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('authModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('authModal').classList.add('hidden'); }

        function showToast(m) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = m;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function copyToWhatsapp() {
            let text = `*TADARUS BULAN RAMADHAN, PPD MIRI* ðŸŒ™\n\n`;
            for (let i = 1; i <= 30; i++) {
                const parts = (juzukData[i.toString()] || {}).participants || [];
                text += `ðŸ”¹ Juz ${i}: ${parts.length > 0 ? parts.map(p => (p.status === 'done' ? 'âœ…' : 'ðŸ“–') + p.name).join(', ') : '_(Kosong)_'}\n`;
            }
            navigator.clipboard.writeText(text).then(() => showToast("Disalin!"));
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .font-arabic { font-family: 'Amiri', serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-emerald-50 min-h-screen pb-24">

    <div class="bg-emerald-700 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-10">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold"><i class="fas fa-quran mr-2"></i> Tadarus Ramadhan</h1>
                    <span class="text-xs bg-emerald-800 px-2 py-1 rounded-full border border-emerald-500">PPD Miri</span>
                </div>
                <div id="modeIndicator"></div>
            </div>
            <div class="bg-emerald-800/50 rounded-lg p-2 mb-4 border border-emerald-600/30 flex justify-between">
                <div>
                    <p class="text-[10px] text-emerald-200 uppercase" id="targetDateDisplay">Sasaran: ...</p>
                    <p class="text-sm font-bold" id="daysRemainingBadge">...</p>
                </div>
            </div>
            <div class="w-full bg-emerald-900 rounded-full h-2.5 mb-1">
                <div id="progressBar" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="completedCount" class="text-xs text-emerald-100 text-right">0 Selesai</div>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-3" id="juzukContainer"></div>

    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg border-t z-20">
        <div class="max-w-md mx-auto flex gap-2">
            <button onclick="copyToWhatsapp()" class="flex-1 bg-green-600 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp"></i> Salin List
            </button>
            <button onclick="clearAllData()" class="bg-red-50 text-red-600 py-3 px-4 rounded-xl"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold mb-1">Carian Peserta</h3>
            <p class="text-xs text-emerald-600 mb-6" id="modalJuzInfo"></p>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input type="tel" id="modalIC" class="flex-1 p-2 border-2 border-gray-100 rounded-xl text-sm" placeholder="No. Kad Pengenalan">
                    <button onclick="checkIC()" class="bg-emerald-100 px-4 rounded-xl text-emerald-700 font-bold"><i class="fas fa-search"></i></button>
                </div>
                <div id="icFeedback"></div>
                <div id="nameInputContainer" class="hidden">
                    <input type="text" id="modalName" class="w-full p-2 border-2 border-gray-100 rounded-xl text-sm" placeholder="Nama Penuh">
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 py-2.5 rounded-xl text-sm font-bold text-gray-600">Batal</button>
                    <button id="submitBtn" onclick="confirmRegistration()" disabled class="flex-1 bg-emerald-600 text-white py-2.5 rounded-xl text-sm font-bold opacity-50">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity z-50 text-sm">
        <span id="toastMsg"></span>
    </div>

</body>
</html>
