<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        @media print {
            body * { visibility: hidden; }
            #program-content, #program-content * { visibility: visible; }
            #program-content { position: absolute; left: 0; top: 0; width: 100%; }
            header, footer, #action-buttons { display: none; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; }
            canvas { max-width: 100% !important; max-height: 100% !important; }
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
             <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <a id="back-to-list-link" href="#" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Senarai Peserta
                </a>
                </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="loading-state" class="text-center p-8">
            <p>Memuatkan data analisis...</p>
        </div>
        <div id="program-content">
            <div id="program-details-container" class="card p-6 md:p-8 mb-6">
                <div id="program-details" class="pb-4">
                    <h2 id="program-name" class="text-2xl font-bold text-gray-900 uppercase"></h2>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-500 mt-2 uppercase font-medium">
                         <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                            <span id="program-location"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                            <span id="program-date"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                            <span id="program-time"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analytics-dashboard" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4 uppercase">Papan Pemuka Analisis</h3>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 lg:col-span-3">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Rumusan Kehadiran</h4>
                        <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                             <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-lg">
                                <div>
                                    <span class="block font-medium text-gray-700">Jumlah Kehadiran</span>
                                    <span id="total-attendance" class="font-bold text-3xl text-indigo-700">0</span>
                                </div>
                                <div class="p-3 bg-indigo-200 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                                <div>
                                    <span class="block font-medium text-blue-800">Lelaki</span>
                                    <span id="total-lelaki" class="font-bold text-3xl text-blue-900">0</span>
                                </div>
                                <div class="p-3 bg-blue-200 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-900" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-pink-50 rounded-lg">
                                <div>
                                    <span class="block font-medium text-pink-800">Perempuan</span>
                                    <span id="total-perempuan" class="font-bold text-3xl text-pink-900">0</span>
                                </div>
                                <div class="p-3 bg-pink-200 rounded-full">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-900" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg">
                                <div>
                                    <span class="block font-medium text-yellow-800">Daftar Lewat</span>
                                    <span id="total-late" class="font-bold text-3xl text-yellow-900">0</span>
                                </div>
                                <div class="p-3 bg-yellow-200 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-900" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg col-span-2 md:col-span-1">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0110 13c-1.86 0-3.44.97-4.33 2.47A6.988 6.988 0 0010 17c.34 0 .673-.024 1-.07.031.023.062.045.094.068.098.07.202.138.31.198.104.058.21.11.318.157.11.048.22.09.33.125.11.033.22.06.33.08.11.02.22.03.33.03.11 0 .22-.01.33-.03.11-.02.22-.04.33-.08.11-.03.22-.06.33-.125.108-.047.214-.1.318-.157.108-.06.212-.127.31-.198.032-.023.063-.045.094-.068z" /></svg>
                                    <span class="font-medium text-gray-600">Peserta</span>
                                </div>
                                <span id="total-peserta" class="font-semibold text-xl text-gray-800">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M12 6.253v1.42L14.47 9.5l-2.47 1.827v1.42L14.47 11l2.47-1.827v-1.42L14.47 6.253 12 7.673zM8 6.253v1.42L10.47 9.5 8 11.327v1.42L10.47 11l2.47-1.827v-1.42L10.47 6.253 8 7.673zM5 10a2 2 0 100 4 2 2 0 000-4z" /></svg>
                                    <span class="font-medium text-gray-600">Fasilitator</span>
                                </div>
                                <span id="total-fasilitator" class="font-semibold text-xl text-gray-800">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 5a1 1 0 100-2H4a1 1 0 100 2h12zM4 13a1 1 0 100 2h6a1 1 0 100-2H4z" clip-rule="evenodd" /></svg>
                                    <span class="font-medium text-gray-600">Urusetia</span>
                                </div>
                                <span id="total-urusetia" class="font-semibold text-xl text-gray-800">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17h-2v-2.07A5 5 0 014 10v-1h1.11a.5.5 0 01.44.7l.34 1.16a.5.5 0 00.94.06L8 8.41l.23.7a.5.5 0 00.94-.06l.34-1.16a.5.5 0 01.44-.7H11v1a5 5 0 01-3 4.93zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                    <span class="font-medium text-gray-600">Penceramah</span>
                                </div>
                                <span id="total-penceramah" class="font-semibold text-xl text-gray-800">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6 lg:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Pecahan Mengikut Peranan</h4>
                        <div class="h-72 md:h-80 flex justify-center items-center">
                            <canvas id="roleChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6 lg:col-span-1">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Pecahan Jantina</h4>
                        <div class="h-72 md:h-80 flex justify-center items-center">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6 lg:col-span-3">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Analisis KPI Kehadiran (Sasaran 90%)</h4>
                        
                        <div id="kpi-loading-note" class="text-center text-gray-500">
                            Memuatkan data KPI...
                        </div>
                        
                        <div id="kpi-no-quota-note" class="hidden text-center text-gray-500 p-4 bg-gray-50 rounded-lg">
                            Data kuota tidak ditetapkan (atau 0) untuk program ini. KPI tidak dapat dikira.
                        </div>

                        <div id="kpi-container" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                            <div class="flex flex-col p-4 bg-blue-50 rounded-lg text-center md:col-span-1">
                                <span class="font-medium text-blue-800">Peserta Disasarkan</span>
                                <span id="kpi-target-display" class="font-bold text-3xl text-blue-900 mt-1">0</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:col-span-3">
                                <div class="flex flex-col p-4 bg-green-50 rounded-lg text-center">
                                    <span class="font-medium text-green-800">Peratus Hadir</span>
                                    <span id="kpi-attendance-percent" class="font-bold text-3xl text-green-900 mt-1">0%</span>
                                </div>
                                <div class="flex flex-col p-4 bg-red-50 rounded-lg text-center">
                                    <span class="font-medium text-red-800">Peratus Tidak Hadir</span>
                                    <span id="kpi-absent-percent" class="font-bold text-3xl text-red-900 mt-1">0%</span>
                                </div>
                                <div class="flex flex-col p-4 bg-gray-100 rounded-lg text-center">
                                    <span class="font-medium text-gray-800">Status KPI</span>
                                    <span id="kpi-achievement-status" class="font-bold text-xl text-gray-900 mt-2"></span>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-4">Nota: Data 'Sebab Tidak Hadir' tidak dikumpul oleh sistem ini dan tidak boleh dipaparkan.</p>
                    </div>

                    <div class="card p-6 lg:col-span-1">
                         <h4 class="text-lg font-semibold text-gray-800 mb-4">Statistik Masa</h4>
                         <div class="space-y-4">
                            <div class="flex flex-col p-4 bg-cyan-50 rounded-lg">
                                <span class="font-medium text-cyan-800">Pendaftaran Terawal</span>
                                <span id="earliest-name" class="font-semibold text-lg text-cyan-900 mt-1 truncate">Memuatkan...</span>
                                <span id="earliest-time" class="text-sm text-cyan-700 font-mono"></span>
                            </div>
                         </div>
                    </div>
                    
                    <div class="card p-6 lg:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Corak Pendaftaran Lewat (Mengikut Jam)</h4>
                        <div class="h-64 relative">
                            <canvas id="lateHoursChart"></canvas>
                        </div>
                    </div>

                    <div class="card p-6 lg:col-span-3">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Pecahan Kehadiran Mengikut Stesyen Kerja</h4>
                        <div class="relative">
                            <canvas id="stationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6 lg:col-span-3">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Senarai Pendaftaran Lewat</h4>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stesyen Kerja</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masa Daftar</th>
                                    </tr>
                                </thead>
                                <tbody id="latecomers-list" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="action-buttons" class="mt-8 flex justify-end gap-3 hidden">
             <button onclick="printDashboard()" class="btn bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-gray-700 flex items-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h10a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zM6 4a1 1 0 011-1h6a1 1 0 011 1v3H6V4zm7 10v4H7v-4h6z" clip-rule="evenodd" /></svg>
                Cetak
            </button>
            <button id="export-pdf-btn" onclick="exportDashboardToPdf()" class="btn bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-red-700 flex items-center gap-2 text-sm">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                Muat Turun PDF
            </button>
        </div>
    </main>
    
    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500"></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        let db, auth;
        let currentProgram = null;
        let allParticipants = [];
        const appId = firebaseConfig.projectId;

        let roleChartInstance = null;
        let stationChartInstance = null;
        let genderChartInstance = null;
        let lateHoursChartInstance = null;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { main(); } 
            else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } }
        });

        function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const programKey = urlParams.get('kod');

            if (!programKey) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Kod program tidak ditemui. Sila akses halaman ini melalui pautan yang sah.</p>`;
                return;
            }

            // DIUBAHSUAI: Membuang pautan ke program.html
            document.getElementById('back-to-list-link').href = `maklumatpeserta.html?kod=${programKey}`;

            listenForProgramData(programKey);

            const versionInfo = document.getElementById('version-info');
            if(versionInfo) {
                const year = new Date().getFullYear();
                versionInfo.textContent = `Versi 2.1 (${year})`;
            }
        }

        function listenForProgramData(programKey) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
            onSnapshot(programRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgram = { id: docSnap.id, ...docSnap.data() };
                    allParticipants = currentProgram.attendance || [];

                    document.getElementById('loading-state').classList.add('hidden');
                    
                    document.getElementById('program-name').textContent = currentProgram.name;
                    document.getElementById('program-location').textContent = currentProgram.location;
                    document.getElementById('program-date').textContent = new Date(currentProgram.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('program-time').textContent = formatTimeRange(currentProgram.startTime, currentProgram.endTime);
                    
                    document.getElementById('analytics-dashboard').classList.remove('hidden');
                    document.getElementById('action-buttons').classList.remove('hidden');

                    renderAnalytics(allParticipants);
                } else {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Program dengan kunci "${programKey}" tidak ditemui.</p>`;
                }
            }, (error) => {
                console.error("Error fetching program: ", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Gagal memuatkan data program.</p>`;
            });
        }
        
        function renderAnalytics(participants) {
            // ... (Fungsi renderAnalytics tidak berubah)
            if (!participants) participants = []; // Pastikan ia array walaupun kosong
            
            renderSummaryStats(participants);
            renderRoleChart(participants);
            renderGenderChart(participants);
            renderStationChart(participants);
            renderLatecomersList(participants);
            renderTimeStats(participants);
            renderLateHoursChart(participants);
            calculateAndDisplayKpi(participants);
        }

        function getGenderFromIC(ic) {
            // ... (Fungsi getGenderFromIC tidak berubah)
            if (!ic || ic.length !== 12) return 'Tidak Diketahui';
            const lastDigit = parseInt(ic.slice(-1), 10);
            return (lastDigit % 2 === 0) ? 'Perempuan' : 'Lelaki';
        }

        function renderSummaryStats(participants) {
            // ... (Fungsi renderSummaryStats tidak berubah)
             const counts = participants.reduce((acc, p) => {
                const role = p.role || 'Peserta';
                acc[role] = (acc[role] || 0) + 1;
                if (p.status === 'Daftar Lewat') {
                    acc['Daftar Lewat'] = (acc['Daftar Lewat'] || 0) + 1;
                }
                const gender = getGenderFromIC(p.ic);
                acc[gender] = (acc[gender] || 0) + 1;
                return acc;
            }, {});

            document.getElementById('total-attendance').textContent = participants.length;
            document.getElementById('total-peserta').textContent = counts['Peserta'] || 0;
            document.getElementById('total-fasilitator').textContent = counts['Fasilitator'] || 0;
            document.getElementById('total-urusetia').textContent = counts['Urusetia'] || 0;
            document.getElementById('total-penceramah').textContent = counts['Penceramah'] || 0;
            document.getElementById('total-late').textContent = counts['Daftar Lewat'] || 0;
            document.getElementById('total-lelaki').textContent = counts['Lelaki'] || 0;
            document.getElementById('total-perempuan').textContent = counts['Perempuan'] || 0;
        }

        function renderRoleChart(participants) {
            // ... (Fungsi renderRoleChart tidak berubah)
            const ctx = document.getElementById('roleChart').getContext('2d');
            const counts = participants.reduce((acc, p) => {
                const role = p.role || 'Peserta';
                acc[role] = (acc[role] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (roleChartInstance) {
                roleChartInstance.destroy();
            }
            roleChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pecahan Peranan',
                        data: data,
                        backgroundColor: [ '#4f46e5', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6' ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function renderGenderChart(participants) {
            // ... (Fungsi renderGenderChart tidak berubah)
            const ctx = document.getElementById('genderChart').getContext('2d');
            const counts = participants.reduce((acc, p) => {
                const gender = getGenderFromIC(p.ic);
                acc[gender] = (acc[gender] || 0) + 1;
                return acc;
            }, { 'Lelaki': 0, 'Perempuan': 0, 'Tidak Diketahui': 0 });

            const labels = Object.keys(counts).filter(k => counts[k] > 0);
            const data = labels.map(k => counts[k]);
            const colors = labels.map(label => {
                if (label === 'Lelaki') return '#3b82f6';
                if (label === 'Perempuan') return '#ec4899';
                return '#9ca3af';
            });

            if (genderChartInstance) {
                genderChartInstance.destroy();
            }
            genderChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pecahan Jantina',
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderStationChart(participants) {
            // ... (Fungsi renderStationChart tidak berubah)
             const ctx = document.getElementById('stationChart').getContext('2d');
            const counts = participants.reduce((acc, p) => {
                const station = (p.station || 'Tidak Diketahui').toUpperCase();
                acc[station] = (acc[station] || 0) + 1;
                return acc;
            }, {});

            const sortedStations = Object.entries(counts).sort(([,a],[,b]) => b - a); 
            const labels = sortedStations.map(item => item[0]);
            const data = sortedStations.map(item => item[1]);

            const canvasHeight = Math.max(labels.length * 28 + 50, 300);
            ctx.canvas.parentNode.style.height = `${canvasHeight}px`;

            if (stationChartInstance) {
                stationChartInstance.destroy();
            }
            stationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Kehadiran',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#1f2937',
                            font: { weight: '600', size: 10 },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }

        function renderLatecomersList(participants) {
            // ... (Fungsi renderLatecomersList tidak berubah)
            const listBody = document.getElementById('latecomers-list');
            const latecomers = participants
                .filter(p => p.status === 'Daftar Lewat')
                .sort((a, b) => new Date(a.time) - new Date(b.time));

            if (latecomers.length === 0) {
                listBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Tiada pendaftaran lewat direkodkan.</td></tr>`;
                return;
            }

            listBody.innerHTML = latecomers.map((p, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${p.name}</div></td>
                    <td class="px-6 py-4 text-sm text-gray-700">${p.station.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        ${new Date(p.time).toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit' })}
                        @ ${new Date(p.time).toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: true })}
                    </td>
                </tr>
            `).join('');
        }
        
        function renderTimeStats(participants) {
            // ... (Fungsi renderTimeStats tidak berubah)
            if (participants.length === 0) {
                document.getElementById('earliest-name').textContent = "Tiada Data";
                document.getElementById('earliest-time').textContent = "-";
                return;
            };
            
            const sortedByTime = [...participants]
                .filter(p => p.time) 
                .sort((a, b) => new Date(a.time) - new Date(b.time));
            
            if (sortedByTime.length === 0) {
                document.getElementById('earliest-name').textContent = "Tiada Data Masa";
                document.getElementById('earliest-time').textContent = "-";
                return;
            }

            const earliest = sortedByTime[0];
            const earliestTime = new Date(earliest.time).toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: true });

            document.getElementById('earliest-name').textContent = earliest.name;
            document.getElementById('earliest-time').textContent = `@ ${earliestTime}`;
        }

        function renderLateHoursChart(participants) {
            // ... (Fungsi renderLateHoursChart tidak berubah)
            const ctx = document.getElementById('lateHoursChart').getContext('2d');
            const latecomers = participants.filter(p => p.status === 'Daftar Lewat' && p.time);

            const hourlyCounts = Array(24).fill(0);
            latecomers.forEach(p => {
                const hour = new Date(p.time).getHours(); 
                hourlyCounts[hour]++;
            });

            let minHour = 24, maxHour = 0;
            for(let i=0; i < 24; i++) {
                if(hourlyCounts[i] > 0) {
                    if (i < minHour) minHour = i;
                    if (i > maxHour) maxHour = i;
                }
            }
            
            let startHour = 6, endHour = 12; 
            if (latecomers.length > 0) {
                 startHour = Math.max(0, minHour - 1);
                 endHour = Math.min(23, maxHour + 1);
            }

            const labels = [];
            for (let i = startHour; i <= endHour; i++) {
                let hour = i % 12;
                if (hour === 0) hour = 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                labels.push(`${hour} ${ampm}`);
            }
            const data = hourlyCounts.slice(startHour, endHour + 1);
            
            if (lateHoursChartInstance) {
                lateHoursChartInstance.destroy();
            }
            lateHoursChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bilangan Daftar Lewat',
                        data: data,
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1,
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#1f2937',
                            font: { weight: '600' },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }
        
        function calculateAndDisplayKpi(participants) {
            // ... (Fungsi calculateAndDisplayKpi tidak berubah)
            const kpiContainer = document.getElementById('kpi-container');
            const loadingNote = document.getElementById('kpi-loading-note');
            const noQuotaNote = document.getElementById('kpi-no-quota-note');

            kpiContainer.classList.add('hidden');
            noQuotaNote.classList.add('hidden');
            loadingNote.classList.remove('hidden');

            const actual = participants.length;
            const target = parseInt(currentProgram.quota, 10); 

            if (!target || target <= 0) {
                loadingNote.classList.add('hidden');
                noQuotaNote.classList.remove('hidden');
                return;
            }

            const kpiTarget = 90.0; 
            const attendancePercent = (actual / target) * 100;
            
            const absentCount = Math.max(0, target - actual);
            const absentPercent = (absentCount / target) * 100;

            document.getElementById('kpi-target-display').textContent = target;
            document.getElementById('kpi-attendance-percent').textContent = `${attendancePercent.toFixed(1)}%`;
            document.getElementById('kpi-absent-percent').textContent = `${absentPercent.toFixed(1)}%`;

            const statusEl = document.getElementById('kpi-achievement-status');
            if (attendancePercent >= kpiTarget) {
                statusEl.textContent = 'TERCAPAI';
                statusEl.className = 'font-bold text-xl text-green-700 mt-2';
            } else {
                statusEl.textContent = 'TIDAK TERCAPAI';
                statusEl.className = 'font-bold text-xl text-red-700 mt-2';
            }

            loadingNote.classList.add('hidden');
            noQuotaNote.classList.add('hidden');
            kpiContainer.classList.remove('hidden');
        }


        // --- Fungsi Cetak & PDF ---

        function printDashboard() {
            // ... (Fungsi printDashboard tidak berubah)
            window.print();
        }

        async function exportDashboardToPdf() {
            // ... (Fungsi exportDashboardToPdf tidak berubah)
            const btn = document.getElementById('export-pdf-btn');
            const btnOriginalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Menjana PDF...';

            const { jsPDF } = window.jspdf;
            const html2canvas = window.html2canvas;

            const contentToCapture = document.getElementById('program-content');
            const programName = document.getElementById('program-name').textContent || 'Laporan Analisis';

            Chart.defaults.animation = false;
            [roleChartInstance, genderChartInstance, stationChartInstance, lateHoursChartInstance].forEach(chart => {
                if(chart) chart.update('none');
            });
            
            await new Promise(resolve => setTimeout(resolve, 500));

            const canvas = await html2canvas(contentToCapture, { scale: 2, useCORS: true });
            Chart.defaults.animation = true;
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            
            const imgProps = pdf.getImageProperties(imgData);
            const contentWidth = pdfWidth - (margin * 2);
            const contentHeight = (imgProps.height * contentWidth) / imgProps.width;
            
            let heightLeft = contentHeight;
            let position = 0;

            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            const titleLines = pdf.splitTextToSize(programName.toUpperCase(), contentWidth);
            pdf.text(titleLines, margin, margin + 5);
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const dateText = `Tarikh Jana: ${new Date().toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            pdf.text(dateText, margin, margin + 10 + (titleLines.length * 6));
            
            position = margin + 20 + (titleLines.length * 6);

            pdf.addImage(imgData, 'PNG', margin, position, contentWidth, contentHeight);
            heightLeft -= (pdfHeight - position - margin);

            while (heightLeft > 0) {
                pdf.addPage();
                position = (heightLeft - contentHeight) * -1;
                pdf.addImage(imgData, 'PNG', margin, position, contentWidth, contentHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save(`Analisis - ${programName}.pdf`);

            btn.disabled = false;
            btn.innerHTML = btnOriginalContent;
        }

        // --- Helper functions ---
        function formatTimeMalay(timeString) {
            // ... (Fungsi formatTimeMalay tidak berubah)
             if (!timeString) return '';
            const [hourStr, minuteStr] = timeString.split(':');
            let hour = parseInt(hourStr, 10);
            let period;
            if (hour === 0) { period = 'tengah malam'; hour = 12; }
            else if (hour < 12) { period = 'pagi'; }
            else if (hour === 12) { period = 'tengah hari'; }
            else { period = 'petang'; hour -= 12; }
            return `${hour}:${minuteStr} ${period}`;
        }
        function formatTimeRange(start, end) { 
            // ... (Fungsi formatTimeRange tidak berubah)
            return `${formatTimeMalay(start)} - ${formatTimeMalay(end)}`; 
        }
        
        Object.assign(window, {
            printDashboard,
            exportDashboardToPdf
        });

    </script>
</body>
</html>
