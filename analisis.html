<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
             <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <a id="back-to-list-link" href="#" class="btn bg-indigo-100 text-indigo-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-200 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Senarai Peserta
                </a>
                <a id="back-to-program-link" href="#" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Kembali ke Program
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="loading-state" class="text-center p-8">
            <p>Memuatkan data analisis...</p>
        </div>
        <div id="program-content" class="hidden">
            <div class="card p-6 md:p-8 mb-6">
                <div id="program-details" class="pb-4">
                    <h2 id="program-name" class="text-2xl font-bold text-gray-900 uppercase"></h2>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-500 mt-2 uppercase font-medium">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                            <span id="program-location"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                            <span id="program-date"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                            <span id="program-time"></span>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-4 uppercase">Papan Pemuka Analisis</h3>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6 lg:col-span-1">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Rumusan Kehadiran</h4>
                    <div id="summary-stats" class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                            <span class="font-medium text-gray-700">Jumlah Kehadiran</span>
                            <span id="total-attendance" class="font-bold text-2xl text-indigo-700">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-600">Peserta</span>
                            <span id="total-peserta" class="font-semibold text-lg text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-600">Fasilitator</span>
                            <span id="total-fasilitator" class="font-semibold text-lg text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-600">Urusetia</span>
                            <span id="total-urusetia" class="font-semibold text-lg text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-600">Penceramah</span>
                            <span id="total-penceramah" class="font-semibold text-lg text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="font-medium text-yellow-800">Daftar Lewat</span>
                            <span id="total-late" class="font-semibold text-lg text-yellow-900">0</span>
                        </div>
                    </div>
                </div>

                <div class="card p-6 lg:col-span-2">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Pecahan Mengikut Peranan</h4>
                    <div class="h-64 md:h-80 flex justify-center items-center">
                        <canvas id="roleChart"></canvas>
                    </div>
                </div>

                <div class="card p-6 lg:col-span-3">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Top 10 Kehadiran Stesyen Kerja</h4>
                    <div class="h-96 relative">
                        <canvas id="stationChart"></canvas>
                    </div>
                </div>

                <div class="card p-6 lg:col-span-3">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Garis Masa Pendaftaran</h4>
                    <div classa="h-80 relative">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                
                <div class="card p-6 lg:col-span-3">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Senarai Pendaftaran Lewat</h4>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stesyen Kerja</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masa Daftar</th>
                                </tr>
                            </thead>
                            <tbody id="latecomers-list" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500"></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        let db, auth;
        let currentProgram = null;
        let allParticipants = [];
        const appId = firebaseConfig.projectId;

        // Chart instances
        let roleChartInstance = null;
        let stationChartInstance = null;
        let timelineChartInstance = null;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { main(); } 
            else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } }
        });

        function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const programKey = urlParams.get('kod');

            if (!programKey) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Kod program tidak ditemui. Sila akses halaman ini melalui pautan yang sah.</p>`;
                return;
            }

            document.getElementById('back-to-list-link').href = `maklumatpeserta.html?kod=${programKey}`;
            document.getElementById('back-to-program-link').href = `program.html?kod=${programKey}`;

            listenForProgramData(programKey);

            const versionInfo = document.getElementById('version-info');
            if(versionInfo) {
                const year = new Date().getFullYear();
                versionInfo.textContent = `Versi 2.1 (${year})`;
            }
        }

        function listenForProgramData(programKey) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
            onSnapshot(programRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgram = { id: docSnap.id, ...docSnap.data() };
                    allParticipants = currentProgram.attendance || [];

                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('program-content').classList.remove('hidden');
                    
                    document.getElementById('program-name').textContent = currentProgram.name;
                    document.getElementById('program-location').textContent = currentProgram.location;
                    document.getElementById('program-date').textContent = new Date(currentProgram.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('program-time').textContent = formatTimeRange(currentProgram.startTime, currentProgram.endTime);
                    
                    renderAnalytics(allParticipants);
                } else {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Program dengan kunci "${programKey}" tidak ditemui.</p>`;
                }
            }, (error) => {
                console.error("Error fetching program: ", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Gagal memuatkan data program.</p>`;
            });
        }
        
        function renderAnalytics(participants) {
            if (!participants || participants.length === 0) {
                console.log("Tiada data peserta untuk dianalisis.");
                return;
            }
            renderSummaryStats(participants);
            renderRoleChart(participants);
            renderStationChart(participants);
            renderTimelineChart(participants);
            renderLatecomersList(participants);
        }

        function renderSummaryStats(participants) {
            const counts = participants.reduce((acc, p) => {
                const role = p.role || 'Peserta';
                acc[role] = (acc[role] || 0) + 1;
                if (p.status === 'Daftar Lewat') {
                    acc['Daftar Lewat'] = (acc['Daftar Lewat'] || 0) + 1;
                }
                return acc;
            }, {});

            document.getElementById('total-attendance').textContent = participants.length;
            document.getElementById('total-peserta').textContent = counts['Peserta'] || 0;
            document.getElementById('total-fasilitator').textContent = counts['Fasilitator'] || 0;
            document.getElementById('total-urusetia').textContent = counts['Urusetia'] || 0;
            document.getElementById('total-penceramah').textContent = counts['Penceramah'] || 0;
            document.getElementById('total-late').textContent = counts['Daftar Lewat'] || 0;
        }

        function renderRoleChart(participants) {
            const ctx = document.getElementById('roleChart').getContext('2d');
            const counts = participants.reduce((acc, p) => {
                const role = p.role || 'Peserta';
                acc[role] = (acc[role] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (roleChartInstance) {
                roleChartInstance.destroy();
            }
            roleChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pecahan Peranan',
                        data: data,
                        backgroundColor: [
                            '#4f46e5', // indigo-600
                            '#10b981', // emerald-500
                            '#3b82f6', // blue-500
                            '#f59e0b', // amber-500
                            '#8b5cf6', // violet-500
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderStationChart(participants) {
            const ctx = document.getElementById('stationChart').getContext('2d');
            const counts = participants.reduce((acc, p) => {
                const station = (p.station || 'Tidak Diketahui').toUpperCase();
                acc[station] = (acc[station] || 0) + 1;
                return acc;
            }, {});

            const sortedStations = Object.entries(counts)
                .sort(([,a],[,b]) => b - a)
                .slice(0, 10); // Ambil top 10

            const labels = sortedStations.map(item => item[0]);
            const data = sortedStations.map(item => item[1]);

            if (stationChartInstance) {
                stationChartInstance.destroy();
            }
            stationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Kehadiran',
                        data: data,
                        backgroundColor: '#3b82f6', // blue-500
                        borderColor: '#1d4ed8', // blue-700
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Jadikan horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTimelineChart(participants) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            const hourlyCounts = Array(24).fill(0);
            
            let earliestHour = 24;
            let latestHour = 0;

            participants.forEach(p => {
                if (p.time) {
                    const regTime = new Date(p.time);
                    const hour = regTime.getHours();
                    hourlyCounts[hour]++;
                    if (hour < earliestHour) earliestHour = hour;
                    if (hour > latestHour) latestHour = hour;
                }
            });

            // Hanya paparkan jam yang relevan (dari pendaftaran terawal hingga terlewat)
            const startHour = Math.max(0, earliestHour - 1);
            const endHour = Math.min(23, latestHour + 1);

            const labels = [];
            for (let i = startHour; i <= endHour; i++) {
                let hour = i % 12;
                if (hour === 0) hour = 12; // 0 & 12 jadi 12
                const ampm = i < 12 || i === 24 ? 'AM' : 'PM';
                labels.push(`${hour}:00 ${ampm}`);
            }
            const data = hourlyCounts.slice(startHour, endHour + 1);

            if (timelineChartInstance) {
                timelineChartInstance.destroy();
            }
            timelineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Pendaftaran per Jam',
                        data: data,
                        fill: true,
                        borderColor: '#10b981', // emerald-500
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                     plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderLatecomersList(participants) {
            const listBody = document.getElementById('latecomers-list');
            const latecomers = participants
                .filter(p => p.status === 'Daftar Lewat')
                .sort((a, b) => new Date(a.time) - new Date(b.time));

            if (latecomers.length === 0) {
                listBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Tiada pendaftaran lewat direkodkan.</td></tr>`;
                return;
            }

            listBody.innerHTML = latecomers.map((p, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${p.name}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">${p.station.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        ${new Date(p.time).toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit' })}
                        @ ${new Date(p.time).toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: true })}
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function formatTimeMalay(timeString) {
            if (!timeString) return '';
            const [hourStr, minuteStr] = timeString.split(':');
            let hour = parseInt(hourStr, 10);
            let period;
            if (hour === 0) { period = 'tengah malam'; hour = 12; }
            else if (hour < 12) { period = 'pagi'; }
            else if (hour === 12) { period = 'tengah hari'; }
            else { period = 'petang'; hour -= 12; }
            return `${hour}:${minuteStr} ${period}`;
        }
        function formatTimeRange(start, end) { return `${formatTimeMalay(start)} - ${formatTimeMalay(end)}`; }

    </script>
</body>
</html>
