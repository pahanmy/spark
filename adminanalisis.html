<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Admin V8.6 (Stabil)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .badge-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .bg-gradient-impact { background: linear-gradient(135deg, #3730a3 0%, #4338ca 100%); }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-200 badge-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-none">SPARK ANALYTICS V8.6</h1>
                    <p class="text-xs text-gray-500 font-medium tracking-wide mt-0.5">Analisis Data Raya & Laporan Penuh</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Kembali</button>
                <button onclick="initData()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition-all active:scale-95">Muat Semula</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-indigo-800 font-bold animate-pulse text-sm uppercase">Sedang Menjana Laporan Lengkap...</p>
        </div>

        <div class="card p-0 overflow-hidden border-0 shadow-xl">
            <div class="bg-gradient-impact p-6 sm:p-10 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-60 h-60 bg-white opacity-5 rounded-full blur-3xl"></div>
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-extrabold uppercase tracking-wide mb-2">Laporan Impak & ROI SPARK</h2>
                        <p class="text-indigo-200 text-sm max-w-2xl">Perbandingan terus menentang cara lama (Google Form/Manual) dari segi penjimatan kos, masa, dan integriti data.</p>
                    </div>
                    <span class="bg-white/20 backdrop-blur px-3 py-1 rounded text-xs font-bold border border-white/30">Data Masa Nyata</span>
                </div>
            </div>

            <div class="p-6 sm:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <div>
                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-4 text-center">SPARK vs Google Form vs Manual</h4>
                    <div class="chart-wrapper" style="height: 300px;"><canvas id="comparisonRadarChart"></canvas></div>
                    <p class="text-center text-xs text-gray-500 mt-2 italic">Graf semakin besar = Sistem semakin cekap.</p>
                </div>

                <div class="space-y-6">
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex justify-between items-center">
                        <div>
                            <h4 class="text-sm font-bold text-red-800 uppercase">Beban 'Data Cleaning' Dihapuskan</h4>
                            <p class="text-xs text-gray-600 mt-1">Masa yang admin jimat daripada membetulkan Excel.</p>
                        </div>
                        <div class="text-right"><span class="text-2xl font-black text-red-600" id="cleaning-hours">0</span><p class="text-[10px] text-red-500 font-bold uppercase">Jam</p></div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex justify-between items-center">
                        <div>
                            <h4 class="text-sm font-bold text-indigo-800 uppercase">Hari Bekerja Diselamatkan</h4>
                            <p class="text-xs text-gray-600 mt-1">Masa staf yang boleh digunakan untuk tugas hakiki.</p>
                        </div>
                        <div class="text-right"><span class="text-2xl font-black text-indigo-600" id="impact-mandays">0</span><p class="text-[10px] text-indigo-500 font-bold uppercase">Hari</p></div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 flex justify-between items-center">
                        <div>
                            <h4 class="text-sm font-bold text-green-800 uppercase">Inisiatif Hijau (Paperless)</h4>
                            <p class="text-xs text-gray-600 mt-1">Kertas A4 yang tidak digunakan.</p>
                        </div>
                        <div class="text-right"><span class="text-2xl font-black text-green-600" id="impact-paper">0</span><p class="text-[10px] text-green-500 font-bold uppercase">Rim</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Pengguna</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-users">0</h3>
                <p class="text-[10px] text-green-600 font-bold mt-1" id="stat-new-this-month">+0 Bulan Ini</p>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Total Kehadiran</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-attendance">0</h3>
                <p class="text-[10px] text-gray-400 mt-1">Rekod Transaksi</p>
            </div>
             <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Program Aktif</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-programs">0</h3>
                <p class="text-[10px] text-blue-600 font-bold mt-1" id="stat-avg-att">Purata: 0 Hadir/Prog</p>
            </div>
            <div class="card p-5 border-l-4 border-pink-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jantina (L:P)</p>
                <div class="flex items-end gap-1">
                    <span class="text-2xl font-bold text-blue-600" id="stat-male">0</span>
                    <span class="text-gray-300">:</span>
                    <span class="text-2xl font-bold text-pink-500" id="stat-female">0</span>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 uppercase">Momentum Pertumbuhan Pengguna</h3>
                    <p class="text-xs text-gray-500">Trend pendaftaran baharu (Bar) dan jumlah kumulatif (Garisan).</p>
                </div>
                <div class="flex gap-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-indigo-500 rounded-sm"></span> Baharu</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Terkumpul</span>
                </div>
            </div>
            <div class="chart-wrapper" style="height: 350px;">
                <canvas id="growthComboChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Komposisi Pengguna</h3>
                <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                    <div class="bg-blue-50 p-2 rounded border border-blue-100"><p class="text-[10px] font-bold text-blue-800">PENDIDIKAN</p><p class="text-lg font-bold text-blue-600" id="count-ppd">0</p></div>
                    <div class="bg-orange-50 p-2 rounded border border-orange-100"><p class="text-[10px] font-bold text-orange-800">MURID</p><p class="text-lg font-bold text-orange-600" id="count-murid">0</p></div>
                    <div class="bg-gray-50 p-2 rounded border border-gray-100"><p class="text-[10px] font-bold text-gray-600">AWAM</p><p class="text-lg font-bold text-gray-500" id="count-awam">0</p></div>
                </div>
                <div class="chart-wrapper" style="height: 250px;"><canvas id="categoryChart"></canvas></div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Jantina</h3>
                <div class="chart-wrapper" style="height: 250px;"><canvas id="genderChart"></canvas></div>
            </div>
        </div>

        <div class="card p-6 border-t-4 border-indigo-600 bg-indigo-50/10">
            <div class="mb-6"><h3 class="text-xl font-extrabold text-gray-900 uppercase">Produktiviti Penganjur</h3><p class="text-sm text-gray-500">Siapa pegawai yang paling aktif menggunakan SPARK.</p></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="col-span-1 flex flex-col justify-center">
                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-4 text-center">Tahap Penggunaan Pegawai</h4>
                    <div class="chart-wrapper" style="height: 220px;"><canvas id="organizerPieChart"></canvas></div>
                    <div class="mt-4 text-center"><span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full uppercase"><span id="super-user-count">0</span> Super User (>10 Prog)</span></div>
                </div>
                <div class="col-span-2">
                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-4">Top 5 Penganjur Paling Produktif</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-sm"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">#</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Prog</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Hadir</th><th class="px-4 py-3 text-center text-xs font-bold text-indigo-600 uppercase">Impak</th></tr></thead><tbody id="top-organizers-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    <div class="mt-6"><h4 class="text-sm font-bold text-gray-700 uppercase mb-2">Matriks Impak (Scatter Plot)</h4><div class="chart-wrapper" style="height: 180px;"><canvas id="organizerScatterChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <div class="card p-8 border-t-4 border-red-600 bg-red-50/10">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div><h3 class="text-2xl font-extrabold text-gray-900 uppercase flex items-center gap-2"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Analisis Kelajuan Imbasan</h3><p class="text-sm text-gray-500 mt-1">Bukti sistem pantas & mesra pengguna.</p></div>
                <div class="mt-4 md:mt-0 bg-white border border-gray-200 p-3 rounded-lg shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Purata Masa</p><p class="text-2xl font-black text-red-600" id="avg-scan-time">0.0s</p><p class="text-[10px] text-gray-500">Per Peserta</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm"><p class="text-xs font-bold text-gray-400 uppercase">Aliran Tertinggi</p><h4 class="text-xl font-bold text-gray-800 mt-1" id="max-throughput">0/Minit</h4></div>
                    <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm"><p class="text-xs font-bold text-gray-400 uppercase">Jurang Terpantas</p><h4 class="text-xl font-bold text-gray-800 mt-1" id="fastest-gap">0s</h4></div>
                </div>
                <div class="lg:col-span-2"><h4 class="text-sm font-bold text-gray-700 uppercase mb-4">Profil Aliran Trafik (Program Paling Sibuk)</h4><div class="chart-wrapper" style="height: 200px;"><canvas id="speedChart"></canvas></div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2 border-l-4 border-purple-500">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Kekerapan Penganjuran Program</h3>
                <div class="chart-wrapper"><canvas id="programFreqChart"></canvas></div>
            </div>
            <div class="card p-6 border-l-4 border-green-500 bg-green-50/10">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Penanda Aras Kehadiran</h3>
                <p class="text-xs text-gray-500 mb-4">KPI: Kehadiran melebihi 50% kuota.</p>
                <div class="chart-wrapper" style="height: 250px;"><canvas id="achievementChart"></canvas></div>
                <div class="mt-4 flex justify-center gap-4 text-center">
                    <div class="bg-white border border-green-200 px-3 py-2 rounded-lg shadow-sm"><p class="text-[10px] font-bold text-green-600 uppercase">Lulus KPI</p><p class="text-lg font-bold text-green-800" id="kpi-success">0</p></div>
                    <div class="bg-white border border-red-200 px-3 py-2 rounded-lg shadow-sm"><p class="text-[10px] font-bold text-red-600 uppercase">Bawah KPI</p><p class="text-lg font-bold text-red-800" id="kpi-fail">0</p></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2"><h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Waktu Puncak Program</h3><div class="chart-wrapper"><canvas id="timeAnalysisChart"></canvas></div></div>
            <div class="card p-6 flex flex-col gap-6">
                <div><h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Mod Program</h3><div class="chart-wrapper" style="height: 150px;"><canvas id="modeChart"></canvas></div></div>
                <div class="border-t pt-4"><h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Hari Paling Sibuk</h3><div class="chart-wrapper" style="height: 180px;"><canvas id="dayChart"></canvas></div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6"><h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Trend Kehadiran Bulanan</h3><div class="chart-wrapper"><canvas id="usageTrendChart"></canvas></div></div>
            <div class="card p-6"><h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Keaktifan Sektor</h3><div class="chart-wrapper"><canvas id="sectorChart"></canvas></div></div>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs bg-white mt-8 border-t">
        <p>SPARK Analytics V8.6 - Dashboard Laporan Lengkap</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let charts = {};
        const monthNames = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];

        window.initData = async function() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const [usersSnap, programsSnap] = await Promise.all([
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_participants`)),
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_programs`))
                ]);

                const users = usersSnap.docs.map(d => d.data());
                const programs = programsSnap.docs.map(d => d.data());

                processAnalytics(users, programs);
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Ralat memuatkan data. Sila semak sambungan internet.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Helper to safely update text content to prevent crash
        function safeUpdateText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function processAnalytics(users, programs) {
            
            // --- FILTERING (BUANG PROGRAM 0 KEHADIRAN) ---
            const activePrograms = programs.filter(p => p.attendance && p.attendance.length > 0);

            // --- VARIABLES INIT ---
            let male = 0, female = 0;
            let catMurid = 0, catPPD = 0, catAwam = 0;
            let newUsersPerMonth = {};
            let usageFreqPerMonth = {};
            let progCountPerMonth = {}; 
            let sectorCounts = {};
            let startTimeCounts = {}; 
            let dayCounts = { 'Ahad':0, 'Isnin':0, 'Selasa':0, 'Rabu':0, 'Khamis':0, 'Jumaat':0, 'Sabtu':0 };
            let dayNames = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
            let organizerStats = {}; 
            let modeOnline = 0, modePhysical = 0;
            let achAbove50 = 0, achBelow50 = 0;
            let allTimeGaps = [];
            let peakThroughput = 0;
            let busiestProgramAttendance = [];

            const currentYear = new Date().getFullYear();
            const currentMonthIndex = new Date().getMonth();

            // 1. DATE MAP (MOMENTUM LOGIC)
            let userEarliestDate = {}; 
            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                if (u.createdAt) userEarliestDate[ic] = u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt);
            });

            activePrograms.forEach(p => {
                const progDate = new Date(p.startDate);
                p.attendance.forEach(att => {
                    const ic = String(att.ic).replace(/[^0-9]/g, '');
                    if (!userEarliestDate[ic] || progDate < userEarliestDate[ic]) userEarliestDate[ic] = progDate;
                });
            });

            // 2. USER ANALYSIS LOOP
            let newUsersThisMonth = 0;
            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                if (ic.length >= 12) {
                    const lastDigit = parseInt(ic.slice(-1));
                    if (lastDigit % 2 === 0) female++; else male++;
                } else male++;

                const sectorRaw = (u.sector || "").toUpperCase();
                const stationRaw = (u.station || "").toUpperCase();
                const eduKeywords = ["SEKTOR", "PPD", "PEJABAT PENDIDIKAN", "SK ", "SMK", "SJK", "KOLEJ", "SEKOLAH", "GURU", "AKP"];
                const isEduStaff = eduKeywords.some(kw => sectorRaw.includes(kw) || stationRaw.includes(kw));

                if (isEduStaff) {
                    catPPD++;
                    let label = sectorRaw.replace("SEKTOR ", "").trim();
                    if(label === "" || label === "-") label = "SEKOLAH / LAIN";
                    sectorCounts[label] = (sectorCounts[label] || 0) + 1;
                } else {
                    let isStudent = false;
                    if (ic.length >= 12) {
                        const yearPrefix = parseInt(ic.substring(0, 2));
                        const birthYear = (yearPrefix > (currentYear % 100)) ? 1900 + yearPrefix : 2000 + yearPrefix;
                        const age = currentYear - birthYear;
                        if (age >= 7 && age <= 18) { catMurid++; isStudent = true; }
                    }
                    if (!isStudent) catAwam++;
                }

                let joinDate = userEarliestDate[ic] || new Date(); 
                if (isNaN(joinDate.getTime())) joinDate = new Date();
                if (joinDate.getMonth() === currentMonthIndex && joinDate.getFullYear() === currentYear) newUsersThisMonth++;
                const regKey = `${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
                newUsersPerMonth[regKey] = (newUsersPerMonth[regKey] || 0) + 1;
            });

            // 3. PROGRAM LOOP
            let totalAttendance = 0;
            activePrograms.forEach(p => {
                const startDate = new Date(p.startDate);
                if (!isNaN(startDate)) {
                    dayCounts[dayNames[startDate.getDay()]]++;
                    const progKey = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
                    progCountPerMonth[progKey] = (progCountPerMonth[progKey] || 0) + 1;
                }
                
                if (p.startTime) startTimeCounts[`${p.startTime.split(':')[0]}:00`] = (startTimeCounts[`${p.startTime.split(':')[0]}:00`] || 0) + 1;
                
                const loc = (p.location || "").toLowerCase();
                if (loc.includes('talian') || loc.includes('online') || loc.includes('zoom')) modeOnline++; else modePhysical++;

                const attendanceCount = p.attendance.length; 
                totalAttendance += attendanceCount;
                
                const quota = parseInt(p.quota || 0);
                if (quota > 0) {
                    const percent = (attendanceCount / quota) * 100;
                    if (percent > 50) achAbove50++; else achBelow50++;
                } else {
                    if (attendanceCount > 10) achAbove50++; else achBelow50++;
                }

                p.attendance.forEach(att => {
                    let useDate = att.timestamp ? (att.timestamp.toDate ? att.timestamp.toDate() : new Date(att.timestamp)) : new Date(p.startDate);
                    const useKey = `${monthNames[useDate.getMonth()]} ${useDate.getFullYear()}`;
                    usageFreqPerMonth[useKey] = (usageFreqPerMonth[useKey] || 0) + 1;
                });

                if (attendanceCount > 10) {
                    const sortedAtt = p.attendance.map(a => a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)) : null).filter(d => d !== null).sort((a,b) => a - b);
                    if (sortedAtt.length > 1) {
                        let throughputMap = {};
                        sortedAtt.forEach(d => { throughputMap[`${d.getHours()}:${d.getMinutes()}`] = (throughputMap[`${d.getHours()}:${d.getMinutes()}`] || 0) + 1; });
                        let progPeak = 0;
                        Object.values(throughputMap).forEach(v => { if(v > progPeak) progPeak = v; });
                        if (progPeak > peakThroughput) peakThroughput = progPeak;
                        for (let i = 0; i < sortedAtt.length - 1; i++) {
                            const diff = (sortedAtt[i+1] - sortedAtt[i]) / 1000;
                            if (diff > 0 && diff < 120) allTimeGaps.push(diff);
                        }
                        if (sortedAtt.length > busiestProgramAttendance.length) busiestProgramAttendance = Object.keys(throughputMap).sort().map(k => ({time: k, count: throughputMap[k]}));
                    }
                }

                const orgId = p.penyelaras_ic || p.createdBy || "unknown";
                const orgName = p.penyelaras_name || "Tanpa Nama";
                if (orgId !== "unknown") {
                    if (!organizerStats[orgId]) organizerStats[orgId] = { name: orgName, count: 0, totalAtt: 0 };
                    organizerStats[orgId].count += 1;
                    organizerStats[orgId].totalAtt += attendanceCount;
                    if(orgName !== "Tanpa Nama") organizerStats[orgId].name = orgName;
                }
            });

            // STATS & IMPACT (Use Safe Update)
            let avgScanTime = peakThroughput > 0 ? (60 / peakThroughput).toFixed(1) : 0;
            const minGap = allTimeGaps.length > 0 ? Math.min(...allTimeGaps.filter(g => g > 0.5)).toFixed(1) : "0";
            
            const timeSavedHours = totalAttendance * (40 / 3600); 
            const manDaysSaved = (timeSavedHours / 8).toFixed(1); 
            const paperReamsSaved = (totalAttendance / 500).toFixed(1);
            const cleaningHours = (totalAttendance / 10 * 2 / 60).toFixed(1);

            safeUpdateText('impact-hours', `${timeSavedHours.toFixed(1)} Jam`); // Is actually not in HTML in V8.6 layout (fixed)
            safeUpdateText('impact-mandays', `${manDaysSaved}`);
            safeUpdateText('impact-paper', `${paperReamsSaved}`);
            safeUpdateText('cleaning-hours', `${cleaningHours}`);

            safeUpdateText('avg-scan-time', `${avgScanTime}s`);
            safeUpdateText('max-throughput', `${peakThroughput} org/min`);
            safeUpdateText('fastest-gap', `${minGap}s`);
            safeUpdateText('kpi-success', achAbove50);
            safeUpdateText('kpi-fail', achBelow50);

            let org1 = 0, org2_9 = 0, org10plus = 0;
            Object.values(organizerStats).forEach(org => {
                if (org.count === 1) org1++; else if (org.count < 10) org2_9++; else org10plus++;
            });
            safeUpdateText('super-user-count', org10plus);

            const topOrganizers = Object.values(organizerStats).sort((a,b) => b.count - a.count).slice(0, 5);
            const tbody = document.getElementById('top-organizers-body');
            if (tbody) {
                tbody.innerHTML = "";
                topOrganizers.forEach((org, index) => {
                    const avg = Math.round(org.totalAtt / org.count);
                    let b = index === 0 ? "bg-yellow-100 text-yellow-800" : (index === 1 ? "bg-gray-200" : (index === 2 ? "bg-orange-100 text-orange-800" : "bg-gray-100"));
                    tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-3"><span class="inline-flex items-center justify-center h-6 w-6 rounded-full text-xs font-bold ${b}">${index+1}</span></td><td class="px-4 py-3 text-xs font-bold text-gray-700 truncate max-w-[150px]">${org.name}</td><td class="px-4 py-3 text-center text-xs font-medium">${org.count}</td><td class="px-4 py-3 text-center text-xs font-medium">${org.totalAtt}</td><td class="px-4 py-3 text-center text-xs font-bold text-indigo-600">${avg}/Prg</td></tr>`;
                });
            }

            safeUpdateText('stat-users', users.length);
            safeUpdateText('stat-new-this-month', `+${newUsersThisMonth} Bulan Ini`);
            safeUpdateText('stat-attendance', totalAttendance.toLocaleString());
            safeUpdateText('stat-programs', activePrograms.length);
            safeUpdateText('stat-avg-att', `Purata: ${Math.round(totalAttendance/activePrograms.length)} Hadir/Prog`);
            safeUpdateText('stat-male', male);
            safeUpdateText('stat-female', female);
            safeUpdateText('count-ppd', catPPD);
            safeUpdateText('count-murid', catMurid);
            safeUpdateText('count-awam', catAwam);

            const sortMonthKeys = (obj) => Object.keys(obj).sort((a,b) => {
                const [mA, yA] = a.split(' ');
                const [mB, yB] = b.split(' ');
                return (parseInt(yA) - parseInt(yB)) || (monthNames.indexOf(mA) - monthNames.indexOf(mB));
            });

            const growthKeys = sortMonthKeys(newUsersPerMonth);
            let cumU = 0;
            renderChart('growthComboChart', { type: 'bar', data: { labels: growthKeys, datasets: [{ label: 'Terkumpul', data: growthKeys.map(k => { cumU += newUsersPerMonth[k]; return cumU; }), type: 'line', borderColor: '#10b981', borderWidth: 2, yAxisID: 'y1' }, { label: 'Baharu', data: growthKeys.map(k => newUsersPerMonth[k]), backgroundColor: '#6366f1', yAxisID: 'y' }] }, options: { scales: { y: { beginAtZero: true, position: 'left' }, y1: { beginAtZero: true, position: 'right', grid: { display: false } } } } });

            renderChart('comparisonRadarChart', {
                type: 'radar',
                data: {
                    labels: ['Kelajuan', 'Integriti Data', 'Keselamatan', 'Automasi Laporan', 'Mesra Pengguna'],
                    datasets: [
                        { label: 'SPARK System', data: [95, 100, 90, 100, 95], fill: true, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgb(79, 70, 229)', pointBackgroundColor: 'rgb(79, 70, 229)' },
                        { label: 'Google Form', data: [60, 50, 60, 40, 80], fill: true, backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgb(239, 68, 68)', pointBackgroundColor: 'rgb(239, 68, 68)' },
                        { label: 'Manual (Kertas)', data: [20, 30, 20, 10, 40], fill: true, backgroundColor: 'rgba(156, 163, 175, 0.2)', borderColor: 'rgb(156, 163, 175)', pointBackgroundColor: 'rgb(156, 163, 175)' }
                    ]
                },
                options: { elements: { line: { borderWidth: 2 } }, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 100 } } }
            });

            renderChart('organizerPieChart', { type: 'doughnut', data: { labels: ['Novis (1)', 'Aktif (2-9)', 'Super User (10+)'], datasets: [{ data: [org1, org2_9, org10plus], backgroundColor: ['#e5e7eb', '#818cf8', '#4338ca'], borderWidth: 0 }] }, options: { cutout: '65%' } });

            renderChart('speedChart', { type: 'line', data: { labels: busiestProgramAttendance.map(b => b.time), datasets: [{ label: 'Aliran Trafik', data: busiestProgramAttendance.map(b => b.count), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }] } });

            renderChart('organizerScatterChart', { type: 'scatter', data: { datasets: [{ label: 'Penganjur', data: Object.values(organizerStats).slice(0, 30).map(o => ({ x: o.count, y: o.totalAtt })), backgroundColor: 'rgba(79, 70, 229, 0.6)' }] }, options: { scales: { x: { title: { display: true, text: 'Program' } }, y: { title: { display: true, text: 'Kehadiran' } } }, plugins: { legend: { display: false } } } });

            renderChart('categoryChart', { type: 'doughnut', data: { labels: ['Pendidik', 'Murid', 'Awam'], datasets: [{ data: [catPPD, catMurid, catAwam], backgroundColor: ['#3b82f6', '#f97316', '#9ca3af'], borderWidth: 0 }] }, options: { cutout: '65%' } });
            renderChart('genderChart', { type: 'pie', data: { labels: ['Lelaki', 'Perempuan'], datasets: [{ data: [male, female], backgroundColor: ['#3b82f6', '#ec4899'], borderWidth: 0 }] } });
            
            const timeKeys = Object.keys(startTimeCounts).sort();
            renderChart('timeAnalysisChart', { type: 'bar', data: { labels: timeKeys, datasets: [{ label: 'Mula Program', data: timeKeys.map(k=>startTimeCounts[k]), backgroundColor: '#8b5cf6', borderRadius: 4 }] } });
            
            renderChart('dayChart', { type: 'polarArea', data: { labels: Object.keys(dayCounts), datasets: [{ data: Object.values(dayCounts), backgroundColor: ['rgba(239, 68, 68, 0.6)', 'rgba(59, 130, 246, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.6)', 'rgba(139, 92, 246, 0.6)', 'rgba(236, 72, 153, 0.6)', 'rgba(107, 114, 128, 0.6)'], borderWidth: 0 }] }, options: { scales: { r: { ticks: { display: false }, grid: { display: false } } }, plugins: { legend: { display: false } } } });

            const modeKeys = ['Bersemuka', 'Dalam Talian'];
            renderChart('modeChart', { type: 'pie', data: { labels: modeKeys, datasets: [{ data: [modePhysical, modeOnline], backgroundColor: ['#ef4444', '#06b6d4'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'right' } } } });

            const useKeys = sortMonthKeys(usageFreqPerMonth);
            renderChart('usageTrendChart', { type: 'line', data: { labels: useKeys, datasets: [{ label: 'Kehadiran', data: useKeys.map(k=>usageFreqPerMonth[k]), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3 }] } });

            const sortedSectors = Object.entries(sectorCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            renderChart('sectorChart', { type: 'bar', data: { labels: sortedSectors.map(s => s[0]), datasets: [{ label: 'Bil. Staf', data: sortedSectors.map(s => s[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { indexAxis: 'y' } });

            const progFreqKeys = sortMonthKeys(progCountPerMonth);
            renderChart('programFreqChart', { type: 'bar', data: { labels: progFreqKeys, datasets: [{ label: 'Bilangan Program', data: progFreqKeys.map(k => progCountPerMonth[k]), backgroundColor: '#a855f7', borderRadius: 4 }] } });

            renderChart('achievementChart', {
                type: 'doughnut',
                data: {
                    labels: ['Melebihi 50%', 'Kurang 50%'],
                    datasets: [{
                        data: [achAbove50, achBelow50],
                        backgroundColor: ['#10b981', '#ef4444'], // Green vs Red
                        borderWidth: 0
                    }]
                },
                options: { cutout: '65%' }
            });
        }

        // FIXED RENDER CHART WITH SAFETY CHECK
        function renderChart(id, config) {
            const canvas = document.getElementById(id);
            if (!canvas) {
                console.warn("Canvas element not found:", id);
                return;
            }
            const ctx = canvas.getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, { type: config.type, data: config.data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Poppins', size: 10 } } } }, ...config.options } });
        }

        initData();
    </script>
</body>
</html>
