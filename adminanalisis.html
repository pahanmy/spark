<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Admin Pro V3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .stat-value { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-none">SPARK ANALYTICS</h1>
                    <p class="text-xs text-gray-500 font-medium tracking-wide mt-0.5">Laporan & Statistik Penggunaan</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Kembali
                </button>
                <button onclick="initData()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Muat Semula
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-indigo-800 font-bold animate-pulse text-sm uppercase">Sedang Menganalisis Data...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Pengguna</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-users">0</h3>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Total Kehadiran</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-attendance">0</h3>
                <p class="text-[10px] text-gray-400">Kali penggunaan</p>
            </div>
             <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Program</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-programs">0</h3>
            </div>
            <div class="card p-5 border-l-4 border-pink-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jantina (L:P)</p>
                <div class="flex items-end gap-1">
                    <span class="text-2xl font-bold text-blue-600" id="stat-male">0</span>
                    <span class="text-gray-300">:</span>
                    <span class="text-2xl font-bold text-pink-500" id="stat-female">0</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 uppercase">Pendaftaran Baharu</h3>
                        <p class="text-xs text-gray-500">Bilangan pengguna yang mendaftar buat kali pertama setiap bulan.</p>
                    </div>
                    <div class="bg-indigo-50 text-indigo-700 p-2 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="newUsersChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                 <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 uppercase">Kekerapan Penggunaan</h3>
                        <p class="text-xs text-gray-500">Trend jumlah kehadiran (imbasan QR) direkodkan setiap bulan.</p>
                    </div>
                     <div class="bg-green-50 text-green-700 p-2 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="usageFreqChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Kategori Pengguna</h3>
                <p class="text-xs text-gray-500 mb-6">Dikategorikan berdasarkan Sektor (Warga Pendidikan), Umur 7-17 (Murid), dan Tiada Sektor (Orang Awam).</p>
                
                <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-xs font-bold text-blue-800 uppercase">Pendidik / PPD</p>
                        <p class="text-xl font-extrabold text-blue-600" id="count-ppd">0</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <p class="text-xs font-bold text-orange-800 uppercase">Murid Sekolah</p>
                        <p class="text-xl font-extrabold text-orange-600" id="count-murid">0</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <p class="text-xs font-bold text-gray-600 uppercase">Orang Awam</p>
                        <p class="text-xl font-extrabold text-gray-500" id="count-awam">0</p>
                    </div>
                </div>

                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Demografi Jantina</h3>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Pecahan Warga Pendidikan Mengikut Sektor</h3>
            <div class="chart-wrapper" style="height: 400px;">
                <canvas id="sectorChart"></canvas>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs">
        <p>Dijana secara automatik oleh SPARK Analytics Engine v3.1</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let charts = {};
        const monthNames = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];

        window.initData = async function() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const [usersSnap, programsSnap] = await Promise.all([
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_participants`)),
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_programs`))
                ]);

                const users = usersSnap.docs.map(d => d.data());
                const programs = programsSnap.docs.map(d => d.data());

                processAnalytics(users, programs);
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Ralat memuatkan data.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function processAnalytics(users, programs) {
            
            // --- VARIABLES ---
            let male = 0, female = 0;
            let catMurid = 0, catPPD = 0, catAwam = 0;
            let newUsersPerMonth = {};
            let usageFreqPerMonth = {};
            let sectorCounts = {};
            const currentYear = new Date().getFullYear();

            // --- 1. USER ANALYSIS ---
            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                
                // Gender Analysis
                if (ic.length >= 12) {
                    const lastDigit = parseInt(ic.slice(-1));
                    if (lastDigit % 2 === 0) female++; else male++;
                } else {
                    male++; // Default fallback
                }

                // Category Analysis (Improved Logic)
                // 1. Check Profile Data First (Most Accurate)
                if (u.sector && u.sector !== "-" && u.sector !== "" && u.sector !== "BUKAN PPD") {
                    catPPD++; // Warga Pendidikan (Ada Sektor)
                    
                    // Sector Breakdown
                    const secName = u.sector.replace("SEKTOR ", "");
                    sectorCounts[secName] = (sectorCounts[secName] || 0) + 1;

                } else {
                    // 2. If no sector, check Age for Student
                    let isStudent = false;
                    if (ic.length >= 12) {
                        const yearPrefix = parseInt(ic.substring(0, 2));
                        const currentYearShort = currentYear % 100;
                        const birthYear = (yearPrefix > currentYearShort) ? 1900 + yearPrefix : 2000 + yearPrefix;
                        const age = currentYear - birthYear;
                        
                        if (age >= 7 && age <= 17) {
                            catMurid++;
                            isStudent = true;
                        }
                    }

                    // 3. If neither, assume Public/Guest
                    if (!isStudent) {
                        catAwam++;
                    }
                }

                // New User Registration Analysis
                let regDate = u.createdAt ? (u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt)) : new Date(); // Fallback to now if missing
                // Validasi tarikh (elak tarikh pelik)
                if (regDate.getFullYear() < 2023) regDate = new Date(); 

                const regKey = `${monthNames[regDate.getMonth()]} ${regDate.getFullYear()}`;
                newUsersPerMonth[regKey] = (newUsersPerMonth[regKey] || 0) + 1;
            });

            // --- 2. PROGRAM & USAGE ANALYSIS ---
            let totalAttendance = 0;

            programs.forEach(p => {
                if (p.attendance && Array.isArray(p.attendance)) {
                    totalAttendance += p.attendance.length;

                    // Analyze attendance dates for Frequency Chart
                    p.attendance.forEach(att => {
                        // Use check-in date if available, else program start date
                        let useDate = att.timestamp ? (att.timestamp.toDate ? att.timestamp.toDate() : new Date(att.timestamp)) : new Date(p.startDate);
                        
                        const useKey = `${monthNames[useDate.getMonth()]} ${useDate.getFullYear()}`;
                        usageFreqPerMonth[useKey] = (usageFreqPerMonth[useKey] || 0) + 1;
                    });
                }
            });

            // --- 3. UPDATE DOM STATS ---
            document.getElementById('stat-users').textContent = users.length;
            document.getElementById('stat-attendance').textContent = totalAttendance.toLocaleString();
            document.getElementById('stat-programs').textContent = programs.length;
            document.getElementById('stat-male').textContent = male;
            document.getElementById('stat-female').textContent = female;

            document.getElementById('count-ppd').textContent = catPPD;
            document.getElementById('count-murid').textContent = catMurid;
            document.getElementById('count-awam').textContent = catAwam;

            // --- 4. RENDER CHARTS ---
            
            // Helper Sort Function
            const sortMonthKeys = (obj) => Object.keys(obj).sort((a,b) => {
                const [mA, yA] = a.split(' ');
                const [mB, yB] = b.split(' ');
                return (parseInt(yA) - parseInt(yB)) || (monthNames.indexOf(mA) - monthNames.indexOf(mB));
            });

            // A. New Users Chart (Bar)
            const regKeys = sortMonthKeys(newUsersPerMonth);
            const regValues = regKeys.map(k => newUsersPerMonth[k]);
            renderChart('newUsersChart', 'bar', {
                labels: regKeys,
                datasets: [{
                    label: 'Pendaftaran Baharu',
                    data: regValues,
                    backgroundColor: '#4f46e5',
                    borderRadius: 5
                }]
            });

            // B. Usage Frequency Chart (Line)
            const useKeys = sortMonthKeys(usageFreqPerMonth);
            const useValues = useKeys.map(k => usageFreqPerMonth[k]);
            renderChart('usageFreqChart', 'line', {
                labels: useKeys,
                datasets: [{
                    label: 'Jumlah Penggunaan (Imbasan)',
                    data: useValues,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            });

            // C. Category Chart (Doughnut)
            renderChart('categoryChart', 'doughnut', {
                labels: ['Warga Pendidikan', 'Murid Sekolah', 'Orang Awam'],
                datasets: [{
                    data: [catPPD, catMurid, catAwam],
                    backgroundColor: ['#3b82f6', '#f97316', '#9ca3af'],
                    borderWidth: 0
                }]
            });

            // D. Gender Chart (Pie)
            renderChart('genderChart', 'pie', {
                labels: ['Lelaki', 'Perempuan'],
                datasets: [{
                    data: [male, female],
                    backgroundColor: ['#3b82f6', '#ec4899'],
                    borderWidth: 0
                }]
            });

            // E. Sector Chart (Bar Horizontal)
            renderChart('sectorChart', 'bar', {
                labels: Object.keys(sectorCounts),
                datasets: [{
                    label: 'Jumlah Pegawai/Staf',
                    data: Object.values(sectorCounts),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 4
                }]
            }, { indexAxis: 'y' }); // Horizontal Bar
        }

        function renderChart(id, type, data, options = {}) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Poppins', size: 10 } } }
                    },
                    ...options
                }
            });
        }

        initData();
    </script>
</body>
</html>
