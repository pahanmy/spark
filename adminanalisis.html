<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        .stat-value { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-none">SPARK INTELLIGENCE</h1>
                    <p class="text-xs text-gray-500 font-medium tracking-wide mt-0.5">Analisis Data Raya & Statistik</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Kembali
                </button>
                <button onclick="initData()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Muat Semula Data
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="relative w-24 h-24">
                <div class="absolute top-0 left-0 w-full h-full border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute top-0 left-0 w-full h-full border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p class="mt-4 text-indigo-800 font-bold animate-pulse tracking-widest text-sm">MEMPROSES DATA...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Populasi Pengguna</p>
                <h3 class="text-3xl font-extrabold stat-value" id="stat-users">0</h3>
                <div class="mt-2 flex items-center gap-2 text-xs font-medium bg-blue-50 text-blue-700 w-max px-2 py-1 rounded-md">
                    <span id="stat-pro-ratio">0%</span>
                    <span>Pengguna Pro</span>
                </div>
            </div>

            <div class="card p-5 relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-pink-500"></div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Nisbah Jantina</p>
                <div class="flex items-end gap-1 mt-1">
                    <h3 class="text-2xl font-bold text-blue-600" id="stat-male">0</h3>
                    <span class="text-sm text-gray-400 mb-1">:</span>
                    <h3 class="text-2xl font-bold text-pink-500" id="stat-female">0</h3>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">Lelaki : Perempuan (Anggaran dari IC)</p>
            </div>

            <div class="card p-5 relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Program Dijana</p>
                <h3 class="text-3xl font-extrabold text-indigo-600" id="stat-programs">0</h3>
                <div class="mt-2 text-xs font-medium text-gray-500">
                    <span class="text-green-600 font-bold" id="stat-active-programs">0</span> Aktif Bulan Ini
                </div>
            </div>

            <div class="card p-5 relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1 bg-green-500"></div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Impak Kehadiran</p>
                <h3 class="text-3xl font-extrabold text-green-600" id="stat-attendance">0</h3>
                <p class="text-[10px] text-gray-400 mt-1">Jumlah rekod kehadiran terkumpul</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 uppercase">Kategori Pengguna</h3>
                        <p class="text-xs text-gray-500">Pecahan mengikut kategori umur (IC) & data sektor.</p>
                    </div>
                    <span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-1 rounded border border-gray-200">DATA MASA NYATA</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Demografi Jantina</h3>
                <p class="text-xs text-gray-500 mb-6">Analisis digit akhir No. KP.</p>
                <div class="chart-wrapper" style="height: 220px;">
                    <canvas id="genderChart"></canvas>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-2 text-center">
                    <div class="bg-blue-50 p-2 rounded">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Lelaki (Ganjil)</p>
                        <p class="text-lg font-bold text-blue-700" id="lbl-male">0%</p>
                    </div>
                    <div class="bg-pink-50 p-2 rounded">
                        <p class="text-[10px] font-bold text-pink-400 uppercase">Perempuan (Genap)</p>
                        <p class="text-lg font-bold text-pink-700" id="lbl-female">0%</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Pertumbuhan Pengguna Baharu</h3>
                <div class="chart-wrapper">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Kekerapan Program (Bulanan)</h3>
                <div class="chart-wrapper">
                    <canvas id="freqChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Taburan Sektor / Unit</h3>
                <div class="chart-wrapper" style="height: 350px;">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Hari Paling Sibuk</h3>
                <p class="text-xs text-gray-500 mb-4">Trend penganjuran program mengikut hari.</p>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="dayAnalysisChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs">
        <p>Analisis Data Pintar &copy; SPARK System</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        // Global Chart Instances
        let charts = {};

        // Helper: Month Names
        const monthNames = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];

        window.initData = async function() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                // Fetch Data Parallel
                const [usersSnap, programsSnap] = await Promise.all([
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_participants`)),
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_programs`))
                ]);

                const users = usersSnap.docs.map(d => d.data());
                const programs = programsSnap.docs.map(d => d.data());

                processAnalytics(users, programs);
                
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Ralat memuatkan data.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function processAnalytics(users, programs) {
            
            // --- 1. DATA PROCESSING LOGIC ---
            
            // Gender & Category Logic
            let male = 0, female = 0;
            let catMurid = 0, catPPD = 0, catAwam = 0;
            let sectorCounts = {};
            let userGrowth = {};
            const currentYear = new Date().getFullYear();

            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                
                // Gender (Last Digit: Odd=Male, Even=Female)
                if (ic.length >= 12) {
                    const lastDigit = parseInt(ic.slice(-1));
                    if (lastDigit % 2 === 0) female++; else male++;
                    
                    // Category Logic (Age based)
                    const yearPrefix = parseInt(ic.substring(0, 2));
                    // Simple logic: if prefix > current year short (e.g. 24), likely 19xx, else 20xx
                    // Adjust threshold as needed. Assuming no one born 2025 yet is a user.
                    const birthYear = (yearPrefix > (currentYear % 100)) ? 1900 + yearPrefix : 2000 + yearPrefix;
                    const age = currentYear - birthYear;

                    if (age >= 7 && age <= 19) {
                        catMurid++; // Anggaran umur persekolahan
                    } else if (u.sector && u.sector !== "BUKAN PPD" && u.sector !== "-" && u.sector !== "") {
                        catPPD++; // Ada data sektor valid
                    } else {
                        catAwam++; // Lain-lain / Dewasa bukan PPD
                    }
                } else {
                    // Fallback for weird ICs
                    catAwam++;
                    male++; // Default assignment to avoid crash
                }

                // Sector Data
                if (u.sector && u.sector !== "-" && u.sector !== "") {
                    const sec = u.sector.replace("SEKTOR ", "");
                    sectorCounts[sec] = (sectorCounts[sec] || 0) + 1;
                }

                // Growth Data
                let d = u.createdAt ? (u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt)) : new Date();
                const key = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                userGrowth[key] = (userGrowth[key] || 0) + 1;
            });

            // Program Logic
            let activeProgs = 0;
            let attendanceTotal = 0;
            let progFreq = {};
            let dayCounts = { 'Ahad':0, 'Isnin':0, 'Selasa':0, 'Rabu':0, 'Khamis':0, 'Jumaat':0, 'Sabtu':0 };
            const dayNames = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];

            programs.forEach(p => {
                const start = new Date(p.startDate);
                
                // Active Check
                if (new Date(p.endDate) >= new Date()) activeProgs++;
                
                // Attendance
                if (p.attendance) attendanceTotal += p.attendance.length;

                // Freq
                const key = `${monthNames[start.getMonth()]} ${start.getFullYear()}`;
                progFreq[key] = (progFreq[key] || 0) + 1;

                // Day Analysis
                if(!isNaN(start)) {
                    const dayName = dayNames[start.getDay()];
                    dayCounts[dayName]++;
                }
            });


            // --- 2. UPDATE UI STATS ---
            document.getElementById('stat-users').innerText = users.length;
            document.getElementById('stat-male').innerText = male;
            document.getElementById('stat-female').innerText = female;
            document.getElementById('stat-programs').innerText = programs.length;
            document.getElementById('stat-active-programs').innerText = activeProgs;
            document.getElementById('stat-attendance').innerText = attendanceTotal.toLocaleString();
            
            const proCount = users.filter(u => u.isPro).length;
            document.getElementById('stat-pro-ratio').innerText = Math.round((proCount/users.length)*100) + "%";

            // Gender Labels
            const totalGen = male + female;
            document.getElementById('lbl-male').innerText = Math.round((male/totalGen)*100) + "%";
            document.getElementById('lbl-female').innerText = Math.round((female/totalGen)*100) + "%";


            // --- 3. RENDER CHARTS ---
            
            // Helper to sort month keys
            const sortKeys = (obj) => Object.keys(obj).sort((a,b) => {
                const [mA, yA] = a.split(' ');
                const [mB, yB] = b.split(' ');
                return (parseInt(yA) - parseInt(yB)) || (monthNames.indexOf(mA) - monthNames.indexOf(mB));
            });

            // Chart 1: Category (Bar Horizontal)
            renderChart('categoryChart', 'bar', {
                labels: ['Warga PPD/Pendidikan', 'Murid Sekolah', 'Orang Awam/Lain-lain'],
                datasets: [{
                    label: 'Jumlah',
                    data: [catPPD, catMurid, catAwam],
                    backgroundColor: ['#4f46e5', '#f59e0b', '#10b981'],
                    borderRadius: 6
                }]
            }, { indexAxis: 'y' });

            // Chart 2: Gender (Doughnut)
            renderChart('genderChart', 'doughnut', {
                labels: ['Lelaki', 'Perempuan'],
                datasets: [{
                    data: [male, female],
                    backgroundColor: ['#3b82f6', '#ec4899'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            });

            // Chart 3: User Growth (Line)
            const growthKeys = sortKeys(userGrowth);
            // Cumulative Sum
            let cumUsers = 0;
            const growthVals = growthKeys.map(k => { cumUsers += userGrowth[k]; return cumUsers; });
            
            renderChart('growthChart', 'line', {
                labels: growthKeys,
                datasets: [{
                    label: 'Jumlah Terkumpul',
                    data: growthVals,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });

            // Chart 4: Program Freq (Bar)
            const progKeys = sortKeys(progFreq);
            const progVals = progKeys.map(k => progFreq[k]);
            renderChart('freqChart', 'bar', {
                labels: progKeys,
                datasets: [{
                    label: 'Bilangan Program',
                    data: progVals,
                    backgroundColor: '#6366f1',
                    borderRadius: 4
                }]
            });

            // Chart 5: Sector (Pie)
            renderChart('sectorChart', 'pie', {
                labels: Object.keys(sectorCounts),
                datasets: [{
                    data: Object.values(sectorCounts),
                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'],
                    borderWidth: 1
                }]
            });

            // Chart 6: Day Analysis (Polar Area)
            renderChart('dayAnalysisChart', 'polarArea', {
                labels: Object.keys(dayCounts),
                datasets: [{
                    data: Object.values(dayCounts),
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.6)', // Ahad (Merah)
                        'rgba(59, 130, 246, 0.6)', // Isnin (Biru)
                        'rgba(16, 185, 129, 0.6)', // Selasa (Hijau)
                        'rgba(245, 158, 11, 0.6)', // Rabu (Kuning)
                        'rgba(139, 92, 246, 0.6)', // Khamis (Ungu)
                        'rgba(236, 72, 153, 0.6)', // Jumaat (Pink)
                        'rgba(107, 114, 128, 0.6)'  // Sabtu (Kelabu)
                    ]
                }]
            }, { scales: { r: { ticks: { backdropColor: 'transparent' } } } });

        }

        function renderChart(id, type, data, extraOptions = {}) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { family: 'Poppins', size: 10 } } }
                }
            };

            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: { ...commonOptions, ...extraOptions }
            });
        }

        // Init Data on Load
        initData();

    </script>
</body>
</html>
