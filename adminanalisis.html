<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Admin V4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .badge-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-200 badge-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-none">SPARK ANALYTICS V4.2</h1>
                    <p class="text-xs text-gray-500 font-medium tracking-wide mt-0.5">Analisis Pintar & Sejarah Data</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Kembali
                </button>
                <button onclick="initData()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Muat Semula
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-indigo-800 font-bold animate-pulse text-sm uppercase">Sedang Menganalisis Sejarah Data...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Pengguna</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-users">0</h3>
                <p class="text-[10px] text-green-600 font-bold mt-1" id="stat-new-this-month">+0 Bulan Ini</p>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Total Kehadiran</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-attendance">0</h3>
                <p class="text-[10px] text-gray-400 mt-1">Rekod Transaksi</p>
            </div>
             <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Program</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-programs">0</h3>
                <p class="text-[10px] text-blue-600 font-bold mt-1" id="stat-avg-att">Purata: 0 Hadir/Prog</p>
            </div>
            <div class="card p-5 border-l-4 border-pink-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jantina (L:P)</p>
                <div class="flex items-end gap-1">
                    <span class="text-2xl font-bold text-blue-600" id="stat-male">0</span>
                    <span class="text-gray-300">:</span>
                    <span class="text-2xl font-bold text-pink-500" id="stat-female">0</span>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 uppercase">Momentum Pertumbuhan Pengguna</h3>
                    <p class="text-xs text-gray-500">Analisis sejarah berdasarkan tarikh daftar atau kehadiran pertama kali.</p>
                </div>
                <div class="flex gap-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-indigo-500 rounded-sm"></span> Baharu</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Terkumpul</span>
                </div>
            </div>
            <div class="chart-wrapper" style="height: 350px;">
                <canvas id="growthComboChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Komposisi Pengguna</h3>
                <p class="text-xs text-gray-500 mb-6">Sekolah, PPD & Orang Awam.</p>
                <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                    <div class="bg-blue-50 p-2 rounded border border-blue-100"><p class="text-[10px] font-bold text-blue-800">WARGA PENDIDIKAN</p><p class="text-lg font-bold text-blue-600" id="count-ppd">0</p></div>
                    <div class="bg-orange-50 p-2 rounded border border-orange-100"><p class="text-[10px] font-bold text-orange-800">MURID</p><p class="text-lg font-bold text-orange-600" id="count-murid">0</p></div>
                    <div class="bg-gray-50 p-2 rounded border border-gray-100"><p class="text-[10px] font-bold text-gray-600">AWAM</p><p class="text-lg font-bold text-gray-500" id="count-awam">0</p></div>
                </div>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Demografi Jantina</h3>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Waktu Puncak Program</h3>
                <p class="text-xs text-gray-500 mb-4">Analisis masa mula program.</p>
                <div class="chart-wrapper">
                    <canvas id="timeAnalysisChart"></canvas>
                </div>
            </div>

            <div class="card p-6 flex flex-col gap-6">
                <div>
                    <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Mod Program</h3>
                    <div class="chart-wrapper" style="height: 150px;">
                        <canvas id="modeChart"></canvas>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Hari Paling Sibuk</h3>
                    <div class="chart-wrapper" style="height: 180px;">
                        <canvas id="dayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Trend Kehadiran (Bulanan)</h3>
                <div class="chart-wrapper">
                    <canvas id="usageTrendChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Keaktifan Sektor / Unit</h3>
                <div class="chart-wrapper">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6 border-t-4 border-purple-500">
            <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Statistik Penganjuran Program (Bulanan)</h3>
            <p class="text-xs text-gray-500 mb-4">Jumlah program yang telah dilaksanakan mengikut bulan.</p>
            <div class="chart-wrapper">
                <canvas id="programFreqChart"></canvas>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs bg-white mt-8 border-t">
        <p>SPARK Analytics V4.2 - Data dikemaskini secara masa nyata.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let charts = {};
        const monthNames = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];

        window.initData = async function() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const [usersSnap, programsSnap] = await Promise.all([
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_participants`)),
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_programs`))
                ]);

                const users = usersSnap.docs.map(d => d.data());
                const programs = programsSnap.docs.map(d => d.data());

                processAnalytics(users, programs);
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Ralat memuatkan data. Sila semak sambungan internet.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function processAnalytics(users, programs) {
            
            // --- VARIABLES ---
            let male = 0, female = 0;
            let catMurid = 0, catPPD = 0, catAwam = 0;
            let newUsersPerMonth = {};
            let usageFreqPerMonth = {};
            let progCountPerMonth = {}; // New variable for Program Frequency
            let sectorCounts = {};
            let startTimeCounts = {}; 
            let dayCounts = { 'Ahad':0, 'Isnin':0, 'Selasa':0, 'Rabu':0, 'Khamis':0, 'Jumaat':0, 'Sabtu':0 };
            let modeOnline = 0, modePhysical = 0;
            let dayNames = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];

            const currentYear = new Date().getFullYear();
            const currentMonthIndex = new Date().getMonth();

            // 1. MEMBUAT PETA TARIKH 'JOIN'
            let userEarliestDate = {}; 

            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                if (u.createdAt) {
                     userEarliestDate[ic] = u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt);
                }
            });

            programs.forEach(p => {
                if (p.attendance && Array.isArray(p.attendance)) {
                    const progDate = new Date(p.startDate);
                    p.attendance.forEach(att => {
                        const ic = String(att.ic).replace(/[^0-9]/g, '');
                        if (!userEarliestDate[ic] || progDate < userEarliestDate[ic]) {
                            userEarliestDate[ic] = progDate;
                        }
                    });
                }
            });

            // --- 2. USER ANALYSIS LOOP ---
            let newUsersThisMonth = 0;

            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                
                // Gender
                if (ic.length >= 12) {
                    const lastDigit = parseInt(ic.slice(-1));
                    if (lastDigit % 2 === 0) female++; else male++;
                } else male++;

                // Category
                const sectorRaw = (u.sector || "").toUpperCase();
                const unitRaw = (u.unit || "").toUpperCase();
                const stationRaw = (u.station || "").toUpperCase();
                const eduKeywords = ["SEKTOR", "PPD", "PEJABAT PENDIDIKAN", "SK ", "SMK", "SJK", "KOLEJ", "SEKOLAH", "GURU", "AKP"];
                const isEduStaff = eduKeywords.some(kw => sectorRaw.includes(kw) || stationRaw.includes(kw));

                if (isEduStaff) {
                    catPPD++;
                    let label = sectorRaw.replace("SEKTOR ", "").trim();
                    if(label === "" || label === "-") label = "SEKOLAH / LAIN";
                    sectorCounts[label] = (sectorCounts[label] || 0) + 1;
                } else {
                    let isStudent = false;
                    if (ic.length >= 12) {
                        const yearPrefix = parseInt(ic.substring(0, 2));
                        const currentYearShort = currentYear % 100;
                        const birthYear = (yearPrefix > currentYearShort) ? 1900 + yearPrefix : 2000 + yearPrefix;
                        const age = currentYear - birthYear;
                        if (age >= 7 && age <= 18) { catMurid++; isStudent = true; }
                    }
                    if (!isStudent) catAwam++;
                }

                // Growth Analysis
                let joinDate = userEarliestDate[ic] || new Date(); 
                if (isNaN(joinDate.getTime())) joinDate = new Date();

                if (joinDate.getMonth() === currentMonthIndex && joinDate.getFullYear() === currentYear) {
                    newUsersThisMonth++;
                }

                const regKey = `${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
                newUsersPerMonth[regKey] = (newUsersPerMonth[regKey] || 0) + 1;
            });

            // --- 3. PROGRAM ANALYSIS LOOP ---
            let totalAttendance = 0;

            programs.forEach(p => {
                // Program Frequency Per Month (NEW LOGIC)
                const startDate = new Date(p.startDate);
                if (!isNaN(startDate)) {
                    const progKey = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
                    progCountPerMonth[progKey] = (progCountPerMonth[progKey] || 0) + 1;
                    
                    // Day Analysis
                    const dayName = dayNames[startDate.getDay()];
                    dayCounts[dayName]++;
                }

                // Time
                if (p.startTime) {
                    const hour = p.startTime.split(':')[0];
                    const bucket = `${hour}:00`;
                    startTimeCounts[bucket] = (startTimeCounts[bucket] || 0) + 1;
                }

                // Mode
                const loc = (p.location || "").toLowerCase();
                if (loc.includes('talian') || loc.includes('online') || loc.includes('zoom') || loc.includes('meet') || loc.includes('maya')) {
                    modeOnline++;
                } else {
                    modePhysical++;
                }

                // Attendance Stats
                if (p.attendance && Array.isArray(p.attendance)) {
                    totalAttendance += p.attendance.length;
                    p.attendance.forEach(att => {
                        let useDate = att.timestamp ? (att.timestamp.toDate ? att.timestamp.toDate() : new Date(att.timestamp)) : new Date(p.startDate);
                        const useKey = `${monthNames[useDate.getMonth()]} ${useDate.getFullYear()}`;
                        usageFreqPerMonth[useKey] = (usageFreqPerMonth[useKey] || 0) + 1;
                    });
                }
            });

            // --- 4. UPDATE DOM ---
            document.getElementById('stat-users').textContent = users.length;
            document.getElementById('stat-new-this-month').textContent = `+${newUsersThisMonth} Bulan Ini`;
            document.getElementById('stat-attendance').textContent = totalAttendance.toLocaleString();
            document.getElementById('stat-programs').textContent = programs.length;
            const avgAtt = programs.length > 0 ? Math.round(totalAttendance / programs.length) : 0;
            document.getElementById('stat-avg-att').textContent = `Purata: ${avgAtt} Hadir/Prog`;
            document.getElementById('stat-male').textContent = male;
            document.getElementById('stat-female').textContent = female;

            document.getElementById('count-ppd').textContent = catPPD;
            document.getElementById('count-murid').textContent = catMurid;
            document.getElementById('count-awam').textContent = catAwam;

            // --- 5. RENDER CHARTS ---
            
            const sortMonthKeys = (obj) => Object.keys(obj).sort((a,b) => {
                const [mA, yA] = a.split(' ');
                const [mB, yB] = b.split(' ');
                return (parseInt(yA) - parseInt(yB)) || (monthNames.indexOf(mA) - monthNames.indexOf(mB));
            });

            // Chart A: Growth Combo
            const growthKeys = sortMonthKeys(newUsersPerMonth);
            const newUsersData = growthKeys.map(k => newUsersPerMonth[k]);
            let cumulativeUsers = 0;
            const cumulativeData = newUsersData.map(val => { cumulativeUsers += val; return cumulativeUsers; });

            renderChart('growthComboChart', {
                type: 'bar',
                data: {
                    labels: growthKeys,
                    datasets: [
                        { label: 'Jumlah Terkumpul', data: cumulativeData, type: 'line', borderColor: '#10b981', borderWidth: 2, yAxisID: 'y1', tension: 0.4, pointRadius: 0 },
                        { label: 'Pendaftaran Baharu', data: newUsersData, backgroundColor: '#6366f1', borderRadius: 4, yAxisID: 'y' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true, position: 'left' }, y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } } } }
            });

            // Chart B: Usage Trend
            const useKeys = sortMonthKeys(usageFreqPerMonth);
            const useValues = useKeys.map(k => usageFreqPerMonth[k]);
            renderChart('usageTrendChart', {
                type: 'line',
                data: {
                    labels: useKeys,
                    datasets: [{ label: 'Jumlah Kehadiran', data: useValues, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3 }]
                }
            });

            // Chart C: Time
            const timeKeys = Object.keys(startTimeCounts).sort();
            const timeValues = timeKeys.map(k => startTimeCounts[k]);
            renderChart('timeAnalysisChart', {
                type: 'bar',
                data: {
                    labels: timeKeys,
                    datasets: [{ label: 'Bil. Program Bermula', data: timeValues, backgroundColor: '#8b5cf6', borderRadius: 4 }]
                }
            });

            // Chart D: Category
            renderChart('categoryChart', {
                type: 'doughnut',
                data: {
                    labels: ['Warga Pendidikan', 'Murid', 'Awam'],
                    datasets: [{ data: [catPPD, catMurid, catAwam], backgroundColor: ['#3b82f6', '#f97316', '#9ca3af'], borderWidth: 0 }]
                },
                options: { cutout: '65%' }
            });

            // Chart E: Gender
            renderChart('genderChart', {
                type: 'pie',
                data: {
                    labels: ['Lelaki', 'Perempuan'],
                    datasets: [{ data: [male, female], backgroundColor: ['#3b82f6', '#ec4899'], borderWidth: 0 }]
                }
            });

            // Chart F: Mode
            renderChart('modeChart', {
                type: 'pie',
                data: {
                    labels: ['Bersemuka', 'Dalam Talian'],
                    datasets: [{ data: [modePhysical, modeOnline], backgroundColor: ['#ef4444', '#06b6d4'], borderWidth: 0 }]
                },
                options: { plugins: { legend: { position: 'right' } } }
            });

            // Chart G: Day
            renderChart('dayChart', {
                type: 'polarArea',
                data: {
                    labels: Object.keys(dayCounts),
                    datasets: [{
                        data: Object.values(dayCounts),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(107, 114, 128, 0.7)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: { scales: { r: { ticks: { display: false }, grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            // Chart H: Sector
            const sortedSectors = Object.entries(sectorCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            renderChart('sectorChart', {
                type: 'bar',
                data: {
                    labels: sortedSectors.map(s => s[0]),
                    datasets: [{ label: 'Bil. Staf', data: sortedSectors.map(s => s[1]), backgroundColor: '#3b82f6', borderRadius: 4 }]
                },
                options: { indexAxis: 'y' }
            });

            // Chart I: Program Frequency (NEW)
            const progFreqKeys = sortMonthKeys(progCountPerMonth);
            const progFreqValues = progFreqKeys.map(k => progCountPerMonth[k]);
            renderChart('programFreqChart', {
                type: 'bar',
                data: {
                    labels: progFreqKeys,
                    datasets: [{
                        label: 'Bilangan Program',
                        data: progFreqValues,
                        backgroundColor: '#a855f7', // Purple-500
                        borderRadius: 4
                    }]
                }
            });
        }

        function renderChart(id, config) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const defaults = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { family: 'Poppins', size: 10 } } }
                }
            };
            const finalConfig = {
                type: config.type,
                data: config.data,
                options: { ...defaults, ...config.options }
            };
            charts[id] = new Chart(ctx, finalConfig);
        }

        initData();
    </script>
</body>
</html>
