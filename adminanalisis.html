<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Analisis Admin V4.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .badge-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-200 badge-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-none">SPARK ANALYTICS V4.4</h1>
                    <p class="text-xs text-gray-500 font-medium tracking-wide mt-0.5">Analisis Produktiviti Penganjur</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Kembali
                </button>
                <button onclick="initData()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Muat Semula
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-indigo-800 font-bold animate-pulse text-sm uppercase">Sedang Menganalisis Sejarah Data...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Pengguna</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-users">0</h3>
                <p class="text-[10px] text-green-600 font-bold mt-1" id="stat-new-this-month">+0 Bulan Ini</p>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Total Kehadiran</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-attendance">0</h3>
                <p class="text-[10px] text-gray-400 mt-1">Rekod Transaksi</p>
            </div>
             <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jumlah Program</p>
                <h3 class="text-3xl font-extrabold text-gray-800" id="stat-programs">0</h3>
                <p class="text-[10px] text-blue-600 font-bold mt-1" id="stat-avg-att">Purata: 0 Hadir/Prog</p>
            </div>
            <div class="card p-5 border-l-4 border-pink-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Jantina (L:P)</p>
                <div class="flex items-end gap-1">
                    <span class="text-2xl font-bold text-blue-600" id="stat-male">0</span>
                    <span class="text-gray-300">:</span>
                    <span class="text-2xl font-bold text-pink-500" id="stat-female">0</span>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 uppercase">Momentum Pertumbuhan Pengguna</h3>
                    <p class="text-xs text-gray-500">Analisis sejarah berdasarkan tarikh daftar atau kehadiran pertama kali.</p>
                </div>
                <div class="flex gap-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-indigo-500 rounded-sm"></span> Baharu</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Terkumpul</span>
                </div>
            </div>
            <div class="chart-wrapper" style="height: 350px;">
                <canvas id="growthComboChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Komposisi Pengguna</h3>
                <p class="text-xs text-gray-500 mb-6">Sekolah, PPD & Orang Awam.</p>
                <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                    <div class="bg-blue-50 p-2 rounded border border-blue-100"><p class="text-[10px] font-bold text-blue-800">WARGA PENDIDIKAN</p><p class="text-lg font-bold text-blue-600" id="count-ppd">0</p></div>
                    <div class="bg-orange-50 p-2 rounded border border-orange-100"><p class="text-[10px] font-bold text-orange-800">MURID</p><p class="text-lg font-bold text-orange-600" id="count-murid">0</p></div>
                    <div class="bg-gray-50 p-2 rounded border border-gray-100"><p class="text-[10px] font-bold text-gray-600">AWAM</p><p class="text-lg font-bold text-gray-500" id="count-awam">0</p></div>
                </div>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-4">Demografi Jantina</h3>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6 border-t-4 border-indigo-600 bg-indigo-50/10">
            <div class="mb-6">
                <h3 class="text-xl font-extrabold text-gray-900 uppercase">Analisis Produktiviti Penganjur</h3>
                <p class="text-sm text-gray-500">Bukti keberkesanan sistem: Siapa yang menggunakan SPARK secara berulang kali untuk memudahkan kerja.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="col-span-1 flex flex-col justify-center">
                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-4 text-center">Kategori Pengguna Sistem</h4>
                    <div class="chart-wrapper" style="height: 220px;">
                        <canvas id="organizerPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full uppercase">
                            <span id="super-user-count">0</span> Super User (>10 Program)
                        </span>
                    </div>
                </div>

                <div class="col-span-2">
                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-4">Top 5 Penganjur Paling Produktif</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Pangkat</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama Penganjur</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Bil. Program</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Jumlah Kehadiran</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Impak</th>
                                </tr>
                            </thead>
                            <tbody id="top-organizers-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="text-center py-4 text-xs text-gray-400">Memuatkan data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-sm font-bold text-gray-700 uppercase mb-2">Matriks Impak (Scatter Plot)</h4>
                        <p class="text-xs text-gray-500 mb-2">Penganjur yang berada di penjuru <b>atas kanan</b> adalah yang paling produktif & berimpak tinggi.</p>
                        <div class="chart-wrapper" style="height: 200px;">
                            <canvas id="organizerScatterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Trend Kehadiran (Bulanan)</h3>
                <div class="chart-wrapper"><canvas id="usageTrendChart"></canvas></div>
            </div>
             <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Keaktifan Sektor / Unit</h3>
                <div class="chart-wrapper"><canvas id="sectorChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-900 uppercase mb-2">Waktu Puncak Program</h3>
                <div class="chart-wrapper"><canvas id="timeAnalysisChart"></canvas></div>
            </div>
             <div class="card p-6">
                <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Hari Paling Sibuk</h3>
                <div class="chart-wrapper"><canvas id="dayChart"></canvas></div>
            </div>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs bg-white mt-8 border-t">
        <p>SPARK Analytics V4.4 - Modul Penganjur Dipertingkat</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let charts = {};
        const monthNames = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];

        window.initData = async function() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const [usersSnap, programsSnap] = await Promise.all([
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_participants`)),
                    getDocs(collection(db, `artifacts/${appId}/public/data/spark_programs`))
                ]);

                const users = usersSnap.docs.map(d => d.data());
                const programs = programsSnap.docs.map(d => d.data());

                processAnalytics(users, programs);
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Ralat memuatkan data.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function processAnalytics(users, programs) {
            
            // --- VARIABLES ---
            let male = 0, female = 0;
            let catMurid = 0, catPPD = 0, catAwam = 0;
            let newUsersPerMonth = {};
            let usageFreqPerMonth = {};
            let sectorCounts = {};
            let startTimeCounts = {}; 
            let dayCounts = { 'Ahad':0, 'Isnin':0, 'Selasa':0, 'Rabu':0, 'Khamis':0, 'Jumaat':0, 'Sabtu':0 };
            let dayNames = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
            
            // ORGANIZER STATS
            let organizerStats = {}; // { ic: { name, programCount, totalAttendance } }

            const currentYear = new Date().getFullYear();
            const currentMonthIndex = new Date().getMonth();

            // 1. DATE MAP
            let userEarliestDate = {}; 
            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                if (u.createdAt) userEarliestDate[ic] = u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt);
            });

            programs.forEach(p => {
                if (p.attendance) {
                    const progDate = new Date(p.startDate);
                    p.attendance.forEach(att => {
                        const ic = String(att.ic).replace(/[^0-9]/g, '');
                        if (!userEarliestDate[ic] || progDate < userEarliestDate[ic]) userEarliestDate[ic] = progDate;
                    });
                }
            });

            // 2. USER LOOP
            let newUsersThisMonth = 0;
            users.forEach(u => {
                const ic = String(u.ic).replace(/[^0-9]/g, '');
                if (ic.length >= 12) {
                    const lastDigit = parseInt(ic.slice(-1));
                    if (lastDigit % 2 === 0) female++; else male++;
                } else male++;

                const sectorRaw = (u.sector || "").toUpperCase();
                const stationRaw = (u.station || "").toUpperCase();
                const eduKeywords = ["SEKTOR", "PPD", "PEJABAT PENDIDIKAN", "SK ", "SMK", "SJK", "KOLEJ", "SEKOLAH", "GURU", "AKP"];
                const isEduStaff = eduKeywords.some(kw => sectorRaw.includes(kw) || stationRaw.includes(kw));

                if (isEduStaff) {
                    catPPD++;
                    let label = sectorRaw.replace("SEKTOR ", "").trim();
                    if(label === "" || label === "-") label = "SEKOLAH / LAIN";
                    sectorCounts[label] = (sectorCounts[label] || 0) + 1;
                } else {
                    let isStudent = false;
                    if (ic.length >= 12) {
                        const yearPrefix = parseInt(ic.substring(0, 2));
                        const currentYearShort = currentYear % 100;
                        const birthYear = (yearPrefix > currentYearShort) ? 1900 + yearPrefix : 2000 + yearPrefix;
                        const age = currentYear - birthYear;
                        if (age >= 7 && age <= 18) { catMurid++; isStudent = true; }
                    }
                    if (!isStudent) catAwam++;
                }

                let joinDate = userEarliestDate[ic] || new Date(); 
                if (isNaN(joinDate.getTime())) joinDate = new Date();
                if (joinDate.getMonth() === currentMonthIndex && joinDate.getFullYear() === currentYear) newUsersThisMonth++;
                const regKey = `${monthNames[joinDate.getMonth()]} ${joinDate.getFullYear()}`;
                newUsersPerMonth[regKey] = (newUsersPerMonth[regKey] || 0) + 1;
            });

            // 3. PROGRAM LOOP & ORGANIZER ANALYSIS
            let totalAttendance = 0;

            programs.forEach(p => {
                const startDate = new Date(p.startDate);
                if (!isNaN(startDate)) {
                    dayCounts[dayNames[startDate.getDay()]]++;
                }
                if (p.startTime) {
                    const hour = p.startTime.split(':')[0];
                    startTimeCounts[`${hour}:00`] = (startTimeCounts[`${hour}:00`] || 0) + 1;
                }

                const attendanceCount = (p.attendance && Array.isArray(p.attendance)) ? p.attendance.length : 0;
                totalAttendance += attendanceCount;
                
                if (attendanceCount > 0) {
                     p.attendance.forEach(att => {
                        let useDate = att.timestamp ? (att.timestamp.toDate ? att.timestamp.toDate() : new Date(att.timestamp)) : new Date(p.startDate);
                        const useKey = `${monthNames[useDate.getMonth()]} ${useDate.getFullYear()}`;
                        usageFreqPerMonth[useKey] = (usageFreqPerMonth[useKey] || 0) + 1;
                    });
                }

                // --- ORGANIZER LOGIC ---
                const orgId = p.penyelaras_ic || p.createdBy || "unknown";
                const orgName = p.penyelaras_name || "Penyelaras Tanpa Nama";
                
                if (orgId !== "unknown") {
                    if (!organizerStats[orgId]) {
                        organizerStats[orgId] = { name: orgName, count: 0, totalAtt: 0 };
                    }
                    organizerStats[orgId].count += 1;
                    organizerStats[orgId].totalAtt += attendanceCount;
                    // Update name if better one found
                    if(orgName !== "Penyelaras Tanpa Nama") organizerStats[orgId].name = orgName;
                }
            });

            // --- PROCESS ORGANIZER STATS ---
            let org1 = 0, org2_9 = 0, org10plus = 0;
            const orgArray = Object.values(organizerStats);
            
            orgArray.forEach(org => {
                if (org.count === 1) org1++;
                else if (org.count < 10) org2_9++;
                else org10plus++;
            });

            document.getElementById('super-user-count').textContent = org10plus;

            // Sort Top 5
            const topOrganizers = orgArray.sort((a,b) => b.count - a.count).slice(0, 5);
            const tbody = document.getElementById('top-organizers-body');
            tbody.innerHTML = "";
            
            topOrganizers.forEach((org, index) => {
                const avg = Math.round(org.totalAtt / org.count);
                let badgeClass = "bg-gray-100 text-gray-800";
                if(index === 0) badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                else if(index === 1) badgeClass = "bg-gray-200 text-gray-700 border-gray-300";
                else if(index === 2) badgeClass = "bg-orange-100 text-orange-800 border-orange-200";

                const row = `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="inline-flex items-center justify-center h-6 w-6 rounded-full text-xs font-bold border ${badgeClass}">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-xs font-bold text-gray-700 uppercase truncate max-w-[150px]">${org.name}</td>
                        <td class="px-4 py-3 text-center text-xs font-medium text-gray-900">${org.count}</td>
                        <td class="px-4 py-3 text-center text-xs font-medium text-gray-500">${org.totalAtt}</td>
                        <td class="px-4 py-3 text-center text-xs font-bold text-indigo-600">${avg} / Prog</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Scatter Data (Top 20 for readability)
            const scatterData = orgArray.slice(0, 30).map(org => ({
                x: org.count,
                y: org.totalAtt,
                label: org.name
            }));

            // --- UPDATE DOM ---
            document.getElementById('stat-users').textContent = users.length;
            document.getElementById('stat-new-this-month').textContent = `+${newUsersThisMonth} Bulan Ini`;
            document.getElementById('stat-attendance').textContent = totalAttendance.toLocaleString();
            document.getElementById('stat-programs').textContent = programs.length;
            const avgAtt = programs.length > 0 ? Math.round(totalAttendance / programs.length) : 0;
            document.getElementById('stat-avg-att').textContent = `Purata: ${avgAtt} Hadir/Prog`;
            document.getElementById('stat-male').textContent = male;
            document.getElementById('stat-female').textContent = female;
            document.getElementById('count-ppd').textContent = catPPD;
            document.getElementById('count-murid').textContent = catMurid;
            document.getElementById('count-awam').textContent = catAwam;

            // --- RENDER CHARTS ---
            const sortMonthKeys = (obj) => Object.keys(obj).sort((a,b) => {
                const [mA, yA] = a.split(' ');
                const [mB, yB] = b.split(' ');
                return (parseInt(yA) - parseInt(yB)) || (monthNames.indexOf(mA) - monthNames.indexOf(mB));
            });

            // 1. Growth
            const growthKeys = sortMonthKeys(newUsersPerMonth);
            const newUsersData = growthKeys.map(k => newUsersPerMonth[k]);
            let cumulativeUsers = 0;
            const cumulativeData = newUsersData.map(val => { cumulativeUsers += val; return cumulativeUsers; });
            renderChart('growthComboChart', { type: 'bar', data: { labels: growthKeys, datasets: [{ label: 'Jumlah Terkumpul', data: cumulativeData, type: 'line', borderColor: '#10b981', borderWidth: 2, yAxisID: 'y1', pointRadius: 0 }, { label: 'Pendaftaran Baharu', data: newUsersData, backgroundColor: '#6366f1', borderRadius: 4, yAxisID: 'y' }] }, options: { scales: { y: { beginAtZero: true, position: 'left' }, y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } } } } });

            // 2. Organizer Pie
            renderChart('organizerPieChart', {
                type: 'doughnut',
                data: {
                    labels: ['Novis (1 Prog)', 'Aktif (2-9 Prog)', 'Super User (10+ Prog)'],
                    datasets: [{
                        data: [org1, org2_9, org10plus],
                        backgroundColor: ['#e5e7eb', '#818cf8', '#4338ca'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '65%' }
            });

            // 3. Organizer Scatter
            renderChart('organizerScatterChart', {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Penganjur',
                        data: scatterData,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: '#4f46e5',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Bilangan Program' }, beginAtZero: true },
                        y: { title: { display: true, text: 'Jumlah Kehadiran' }, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return `${point.label}: ${point.x} Prog, ${point.y} Hadir`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });

            // 4. Other Standard Charts (Category, Gender, Time, Day, Trend, Sector)
            renderChart('categoryChart', { type: 'doughnut', data: { labels: ['Warga Pendidikan', 'Murid', 'Awam'], datasets: [{ data: [catPPD, catMurid, catAwam], backgroundColor: ['#3b82f6', '#f97316', '#9ca3af'], borderWidth: 0 }] }, options: { cutout: '65%' } });
            renderChart('genderChart', { type: 'pie', data: { labels: ['Lelaki', 'Perempuan'], datasets: [{ data: [male, female], backgroundColor: ['#3b82f6', '#ec4899'], borderWidth: 0 }] } });
            
            const timeKeys = Object.keys(startTimeCounts).sort();
            renderChart('timeAnalysisChart', { type: 'bar', data: { labels: timeKeys, datasets: [{ label: 'Program Bermula', data: timeKeys.map(k=>startTimeCounts[k]), backgroundColor: '#8b5cf6', borderRadius: 4 }] } });
            
            renderChart('dayChart', { type: 'polarArea', data: { labels: Object.keys(dayCounts), datasets: [{ data: Object.values(dayCounts), backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(107, 114, 128, 0.7)'], borderWidth: 0 }] }, options: { scales: { r: { ticks: { display: false }, grid: { display: false } } }, plugins: { legend: { display: false } } } });

            const useKeys = sortMonthKeys(usageFreqPerMonth);
            renderChart('usageTrendChart', { type: 'line', data: { labels: useKeys, datasets: [{ label: 'Kehadiran', data: useKeys.map(k=>usageFreqPerMonth[k]), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3 }] } });

            const sortedSectors = Object.entries(sectorCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            renderChart('sectorChart', { type: 'bar', data: { labels: sortedSectors.map(s => s[0]), datasets: [{ label: 'Bil. Staf', data: sortedSectors.map(s => s[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { indexAxis: 'y' } });
        }

        function renderChart(id, config) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const defaults = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Poppins', size: 10 } } } } };
            const finalConfig = { type: config.type, data: config.data, options: { ...defaults, ...config.options } };
            charts[id] = new Chart(ctx, finalConfig);
        }

        initData();
    </script>
</body>
</html>
