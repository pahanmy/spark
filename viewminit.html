<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paparan Minit Curai - SPARK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
        
        /* A4 Paper */
        #pdf-wrapper { width: 210mm; margin: 20px auto 100px auto; background: white; transition: all 0.3s ease; }
        .a4-paper { 
            width: 210mm; 
            min-height: 297mm; 
            padding: 20mm 20mm; 
            background: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            color: black; 
            position: relative; 
            font-family: Arial, sans-serif; 
            display: flex;
            flex-direction: column;
        }

        .barcode-container { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 5px; z-index: 50; }

        /* Tables & Content */
        .minit-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt !important; line-height: 1.4 !important; }
        .minit-table th, .minit-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
        .minit-header { background-color: #e0f2fe; font-weight: bold; width: 25%; }
        .th-icon { display: inline-flex; align-items: center; gap: 5px; }
        #out-content { font-size: 11pt; line-height: 1.5; text-align: justify; flex-grow: 1; }
        .single-line-name { white-space: nowrap; overflow: visible; width: 100%; display: block; }

        .content-table { width: 100%; border-collapse: collapse; margin: 5px 0 15px 0; font-size: 0.9em; }
        .content-table th, .content-table td { border: 1px solid #333; padding: 5px; text-align: left; vertical-align: middle; }
        .content-table th { background-color: #f3f4f6; font-weight: bold; text-transform: uppercase; text-align: center; }

        /* Image Handling */
        .preview-image-container { text-align: center; margin: 10px 0; }
        .preview-image { max-width: 90%; max-height: 400px; height: auto; border: 1px solid #ddd; padding: 4px; background: white; margin-bottom: 5px; }
        .image-caption { font-size: 9pt; color: #555; font-style: italic; text-align: center; display: block; }

        /* Preview Structure */
        .preview-list { list-style: none; padding: 0; margin: 0; }
        .preview-item { margin-bottom: 10px; display: flex; align-items: flex-start; }
        .preview-num { font-weight: normal; min-width: 25px; }
        .preview-text { flex-grow: 1; text-align: justify; }
        
        .sub-list { margin-top: 5px; }
        .sub-item { display: flex; align-items: flex-start; margin-bottom: 4px; }
        .sub-num { font-weight: normal; min-width: 35px; font-size: 0.95em; }
        .sub-text-wrapper { flex-grow: 1; }
        .sub-text { font-size: 0.95em; }

        .sub-sub-list { margin-top: 3px; margin-left: 0; }
        .sub-sub-item { display: flex; align-items: flex-start; margin-bottom: 3px; }
        .sub-sub-num { font-weight: normal; min-width: 40px; font-size: 0.9em; font-style: italic; color: #444; }
        .sub-sub-text { font-size: 0.9em; font-style: italic; }

        .speaker-section { margin-bottom: 20px; padding-bottom: 10px; }
        .speaker-title { font-weight: bold; margin-bottom: 5px; font-size: 10pt; color: #334155; background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; text-transform: none !important; }
        .status-tag { display: block; text-align: right; margin-top: 2px; font-size: 8pt; font-weight: bold; color: black; text-transform: uppercase; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #0284c7; border-radius: 3px; }

        /* --- PRINT CSS: Elak Terpotong & Papar A4 Bersih --- */
        .minit-table tr, .content-table, .preview-image-container, .break-inside-avoid { 
            page-break-inside: avoid !important; 
            break-inside: avoid !important; 
        }

        h2, h3, h4, .speaker-title, .minit-header { 
            page-break-after: avoid !important; 
            break-after: avoid !important; 
        }

        @media print {
            .no-print, header, #read-acknowledgement-bar { display: none !important; }
            body, html {
                height: auto !important;
                overflow: visible !important;
                background-color: white !important;
            }
            #pdf-wrapper { 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            .a4-paper {
                width: 100% !important;
                margin: 0 !important;
                padding: 10mm 15mm !important; 
                box-shadow: none !important;
                min-height: auto !important;
                display: block !important; 
            }
        }

        /* Loading Screen */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0284c7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden relative">

    <div id="loader">
        <div class="spinner mb-4"></div>
        <p class="text-sm font-bold text-gray-500 uppercase tracking-wider">Memuatkan Dokumen...</p>
    </div>

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-sky-600 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-sky-700 uppercase tracking-wide">MINIT CURAI</h1>
                    <p class="text-xs text-gray-500">Dokumen Digital SPARK</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.print()" class="bg-gray-800 hover:bg-black text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg> Cetak / Simpan PDF</button>
            </div>
        </div>
    </header>

    <div class="flex-1 overflow-auto bg-gray-100 p-4 custom-scrollbar" id="main-scroll-area">
        <div id="pdf-wrapper">
            <div class="a4-paper transform scale-100 origin-top" id="main-report">
                
                <div class="break-inside-avoid">
                    <div class="w-full flex justify-end mb-2"><svg id="barcode"></svg></div>
                    <div class="text-center border-b-2 border-black pb-4 mb-6">
                        <h2 class="text-xl font-bold uppercase tracking-wider mb-2 text-black">MINIT CURAI</h2>
                        <h3 id="out-tajuk" class="text-lg font-semibold uppercase text-gray-800 leading-tight"></h3>
                    </div>
                </div>
                
                <table class="minit-table mb-6 break-inside-avoid">
                    <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> TARIKH</div></th><td id="out-tarikh" class="w-1/4 uppercase"></td><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> MASA</div></th><td id="out-masa" class="w-1/4 uppercase"></td></tr>
                    <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> TEMPAT</div></th><td id="out-tempat" colspan="3" class="uppercase"></td></tr>
                    <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg> ANJURAN</div></th><td id="out-anjuran" colspan="3" class="uppercase"></td></tr>
                </table>
                
                <div class="mb-8"><h4 class="text-sm font-bold uppercase border-b border-gray-300 mb-4 pb-1">Intipati / Coretan Mesyuarat</h4><div id="out-content" class="text-justify leading-relaxed"></div></div>
                
                <div class="mt-auto flex justify-between pt-12 pb-8 break-inside-avoid items-end">
                    <div class="w-1/3 flex flex-col items-start">
                        <p class="text-[8pt] italic mb-0 self-start w-full text-left">Disediakan Oleh:</p>
                        <div class="h-20 w-full flex items-end justify-start -mb-2 relative z-10">
                             <img id="out-sig-img" class="h-full max-w-[220px] object-contain object-bottom hidden" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="filter: contrast(1.5);">
                        </div>
                        <div class="border-b border-black w-full mb-1 relative z-0"></div>
                        <p id="out-nama" class="font-bold uppercase leading-tight text-[9pt] w-full text-left single-line-name"></p>
                        <p id="out-jawatan" class="text-[8pt] uppercase mt-0.5 w-full text-left single-line-name"></p>
                        <p id="out-sektor" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden"></p>
                        <p id="out-stesen" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden"></p>
                        <p id="out-tarikh-laporan" class="text-[8pt] mt-1.5 w-full text-left"></p>
                    </div>

                    <div id="out-semak-wrapper" class="w-1/3 flex flex-col items-start ml-auto hidden">
                        <p class="text-[8pt] italic mb-0 self-start w-full text-left">Disemak Oleh:</p>
                        <div class="h-20 w-full flex items-end justify-start -mb-2 relative z-10"></div>
                        <div class="border-b border-black w-full mb-1 relative z-0"></div>
                        <p id="out-semak-nama" class="font-bold uppercase leading-tight text-[9pt] w-full text-left single-line-name"></p>
                        <p id="out-semak-jawatan" class="text-[8pt] uppercase mt-0.5 w-full text-left single-line-name"></p>
                        <p id="out-semak-sektor" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden"></p>
                        <p id="out-semak-stesen" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden"></p>
                        <p class="text-[8pt] mt-1.5 w-full text-left">TARIKH: ______________</p>
                    </div>
                </div>

                <div class="mt-8 border-t-2 border-dashed border-gray-300 pt-4 break-inside-avoid w-full">
                    <h4 class="text-[8pt] font-bold text-gray-500 uppercase mb-2">Makluman & Pengesahan Telah Membaca:</h4>
                    <div id="out-readers-list" class="flex flex-wrap gap-1.5 text-[7pt]">
                        <span class="text-gray-400 italic">Memuatkan senarai...</span>
                    </div>
                </div>

                <div class="absolute bottom-4 left-0 w-full text-center"><p class="text-[8px] text-gray-300 uppercase tracking-[0.2em]">Dijana oleh SPARK Curai</p></div>
            </div>
        </div>
    </div>

    <div id="read-acknowledgement-bar" class="fixed bottom-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_15px_rgba(0,0,0,0.1)] p-4 z-50 no-print flex flex-col sm:flex-row justify-center items-center gap-3 hidden">
        <span class="text-sm font-bold text-gray-700">Sahkan anda telah membaca minit ini:</span>
        <div class="flex gap-2 w-full sm:w-auto">
            <input type="number" id="reader-ic" placeholder="No. Kad Pengenalan" class="border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 flex-1 sm:w-64">
            <button id="btn-confirm-read" onclick="confirmRead()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow transition-colors text-sm whitespace-nowrap">Sahkan</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Pangkalan Data
        const firebaseConfig = { 
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", 
            authDomain: "myqrhadir.firebaseapp.com", 
            projectId: "myqrhadir", 
            storageBucket: "myqrhadir.appspot.com", 
            messagingSenderId: "799691133747", 
            appId: "1:799691133747:web:835a5e3e9413eace806446" 
        };
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const appId = firebaseConfig.projectId;

        // Ambil ID dokumen daripada URL (contoh: viewminit.html?id=DOCUMENT_ID)
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        window.onload = async function() {
            if (!docId) {
                alert("Ralat: ID dokumen tidak dijumpai.");
                document.getElementById('loader').innerHTML = "<p class='text-red-500 font-bold'>Dokumen Tidak Ditemui.</p>";
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/spark_minit_curai`, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    renderDocument(docSnap.data(), docId);
                    loadReaders(docId);
                    document.getElementById('loader').style.display = 'none';
                    // Tunjuk palang pengesahan bacaan
                    document.getElementById('read-acknowledgement-bar').classList.remove('hidden');
                } else {
                    document.getElementById('loader').innerHTML = "<p class='text-red-500 font-bold'>Maaf, rekod telah dipadam atau tidak wujud.</p>";
                }
            } catch (error) {
                console.error("Gagal menarik data:", error);
                document.getElementById('loader').innerHTML = "<p class='text-red-500 font-bold'>Ralat sambungan pangkalan data.</p>";
            }
        };

        // FUNGSI LOAD PEMBACA
        async function loadReaders(id) {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/spark_minit_readers`), where("docId", "==", id));
                const snap = await getDocs(q);
                const listEl = document.getElementById('out-readers-list');
                listEl.innerHTML = "";
                
                if (snap.empty) {
                    listEl.innerHTML = "<span class='text-gray-400 italic'>Belum ada individu yang membuat pengesahan bacaan.</span>";
                    return;
                }
                
                snap.forEach(documentSnap => {
                    const data = documentSnap.data();
                    const badge = document.createElement('span');
                    badge.className = "bg-green-50 text-green-700 border border-green-200 px-2 py-0.5 rounded font-bold uppercase tracking-tight";
                    badge.innerText = data.name;
                    listEl.appendChild(badge);
                });
            } catch (e) { console.error("Gagal load readers", e); }
        }

        // FUNGSI PENGESAHAN BACAAN
        window.confirmRead = async function() {
            const icInput = document.getElementById('reader-ic').value.trim();
            if(!icInput || icInput.length < 10) { 
                alert("Sila masukkan No. Kad Pengenalan yang sah tanpa sengkang (-)."); 
                return; 
            }

            const btn = document.getElementById('btn-confirm-read');
            btn.innerText = "Sila Tunggu..."; btn.disabled = true;

            try {
                // 1. Semak jika IC ada dalam SPARK Participants
                const qUser = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", icInput));
                const snapUser = await getDocs(qUser);
                
                let readerName = "";
                if (!snapUser.empty) {
                    readerName = snapUser.docs[0].data().name;
                } else {
                    // Jika tiada dalam pangkalan data, minta taip nama secara manual
                    readerName = prompt("Rekod IC tidak ditemui di dalam sistem SPARK.\n\nSila masukkan NAMA PENUH anda untuk direkodkan sebagai pembaca:");
                    if(!readerName || readerName.trim() === "") {
                        btn.innerText = "Sahkan"; btn.disabled = false;
                        return;
                    }
                }

                // 2. Simpan Rekod Bacaan
                const readerDocId = docId + "_" + icInput;
                await setDoc(doc(db, `artifacts/${appId}/public/data/spark_minit_readers`, readerDocId), {
                    docId: docId,
                    ic: icInput,
                    name: readerName.toUpperCase(),
                    timestamp: new Date()
                });

                alert("Terima kasih! Pengesahan bacaan anda telah berjaya direkodkan.");
                document.getElementById('read-acknowledgement-bar').style.display = 'none';
                
                // Refresh list pembaca
                loadReaders(docId);

            } catch (e) {
                console.error(e);
                alert("Ralat semasa menyimpan pengesahan. Sila cuba lagi.");
            } finally {
                btn.innerText = "Sahkan"; btn.disabled = false;
            }
        }

        function renderDocument(data, id) {
            // Render Text Fields
            document.getElementById('out-tajuk').textContent = (data.tajuk || "").toUpperCase();
            document.getElementById('out-tempat').textContent = (data.tempat || "").toUpperCase();
            document.getElementById('out-anjuran').textContent = (data.anjuran || "").toUpperCase();
            document.getElementById('out-nama').textContent = (data.nama || "").toUpperCase();
            document.getElementById('out-jawatan').textContent = (data.jawatan || "").toUpperCase();
            
            // Sektor & Stesen Logic
            const elSektor = document.getElementById('out-sektor');
            if(data.sektor) { elSektor.textContent = data.sektor.toUpperCase(); elSektor.classList.remove('hidden'); }
            
            const elStesen = document.getElementById('out-stesen');
            if(data.stesen) { elStesen.textContent = data.stesen.toUpperCase(); elStesen.classList.remove('hidden'); }

            // Tarikh Logic
            let tarikhText = "";
            if(data.tarikh) { 
                const dojb1 = new Date(data.tarikh); 
                tarikhText = dojb1.toLocaleDateString('ms-MY', {day:'numeric',month:'long',year:'numeric'}).toUpperCase(); 
                document.getElementById('out-tarikh-laporan').textContent = `TARIKH: ${tarikhText}`; 
                
                if (data.tarikhHingga && data.tarikhHingga !== data.tarikh) {
                    const dojb2 = new Date(data.tarikhHingga);
                    if (dojb2 > dojb1) {
                        const tarikhText2 = dojb2.toLocaleDateString('ms-MY', {day:'numeric',month:'long',year:'numeric'}).toUpperCase(); 
                        tarikhText = `${tarikhText} - ${tarikhText2}`;
                    }
                }
                document.getElementById('out-tarikh').textContent = tarikhText;
            }

            // Masa Logic
            if(data.masa) { 
                let [h,m] = data.masa.split(':'); 
                let s = h >= 12 ? "PETANG" : "PAGI"; 
                if(h > 12) h -= 12; 
                if(h === '00') h = 12; 
                document.getElementById('out-masa').textContent = `${h}.${m} ${s}`; 
            }

            // Pegawai Penyemak (Verified) Logic
            if(data.showVerified) {
                document.getElementById('out-semak-wrapper').classList.remove('hidden');
                document.getElementById('out-semak-nama').textContent = (data.verifiedName || "NAMA PENYEMAK").toUpperCase();
                document.getElementById('out-semak-jawatan').textContent = (data.verifiedPos || "JAWATAN").toUpperCase();
                
                if(data.verifiedSektor) { 
                    document.getElementById('out-semak-sektor').textContent = data.verifiedSektor.toUpperCase(); 
                    document.getElementById('out-semak-sektor').classList.remove('hidden'); 
                }
                if(data.verifiedStesen) { 
                    document.getElementById('out-semak-stesen').textContent = data.verifiedStesen.toUpperCase(); 
                    document.getElementById('out-semak-stesen').classList.remove('hidden'); 
                }
            }

            // Tandatangan Logic
            if(data.showSignature && data.signatureUrl && data.signatureUrl.length > 1000) {
                document.getElementById('out-sig-img').src = data.signatureUrl;
                document.getElementById('out-sig-img').classList.remove('hidden');
            }

            // Styling Settings Logic
            const c = document.getElementById('out-content');
            const p = document.getElementById('main-report');
            if(data.settings) {
                if(data.settings.fontSize) c.style.fontSize = data.settings.fontSize;
                if(data.settings.lineHeight) c.style.lineHeight = data.settings.lineHeight;
                if(data.settings.padding) p.style.padding = `${data.settings.padding} 20mm`;
                if(data.settings.fontFamily) p.style.fontFamily = data.settings.fontFamily;
            }

            // Render Barcode
            JsBarcode("#barcode", id.substring(0,8).toUpperCase(), { format: "CODE128", width: 1, height: 15, displayValue: true, fontSize: 8, margin: 0, textMargin: 1 });

            // Render Points / Speakers
            const qrQueue = [];
            function getLinkHtml(link, qid) {
                if (!link) return '';
                qrQueue.push({ id: qid, url: link });
                return `<div class="mt-1 mb-2 flex flex-wrap items-center gap-2 bg-sky-50/50 p-1.5 rounded border border-sky-100 print:bg-transparent print:border-none print:p-0">
                            <div id="${qid}" class="w-10 h-10 print:w-12 print:h-12 border border-gray-200 p-0.5 rounded bg-white shadow-sm shrink-0"></div>
                            <a href="${link}" target="_blank" class="text-[8pt] text-sky-700 no-underline font-mono tracking-tight hover:underline break-all max-w-[80%]">
                                ${link}
                            </a>
                        </div>`;
            }

            c.innerHTML = '';
            if(data.speakers) {
                data.speakers.forEach((s, speakerIdx) => {
                    const sec = document.createElement('div'); sec.className = "speaker-section";
                    if(s.name) sec.innerHTML += `<div class="speaker-title">${s.name}</div>`;
                    const list = document.createElement('div'); list.className = "preview-list";
                    
                    if(s.points) {
                        s.points.forEach((pt, i) => {
                            // IMAGE RENDER
                            if(pt.type === 'image') {
                                const item = document.createElement('div'); item.className = "preview-image-container";
                                item.innerHTML = `<img src="${pt.url}" class="preview-image" crossorigin="anonymous"><span class="image-caption">${pt.caption || ''}</span>`;
                                list.appendChild(item); return;
                            }
                            
                            // TABLE RENDER
                            if(pt.type === 'table') {
                                 const item = document.createElement('div'); item.className = "preview-item";
                                 let thtml = '<table class="content-table"><thead><tr>';
                                 pt.tableData[0].forEach(h => thtml += `<th>${h}</th>`);
                                 thtml += '</tr></thead><tbody>';
                                 for(let r=1; r<pt.tableData.length; r++) { thtml += '<tr>'; pt.tableData[r].forEach(cl => thtml += `<td>${cl}</td>`); thtml += '</tr>'; }
                                 thtml += '</tbody></table>';
                                 item.innerHTML = `<div class="preview-num"></div><div class="preview-text">${thtml}</div>`;
                                 list.appendChild(item); return;
                            }

                            // TEXT RENDER
                            const item = document.createElement('div'); item.className = "preview-item";
                            let linkHtml = getLinkHtml(pt.link, `qr-p-${speakerIdx}-${i}`);
                            
                            item.innerHTML = `<div class="preview-num">${i+1}.</div><div class="preview-text"><div style="${pt.isBold?'font-weight:bold':''}">${pt.text}</div>${linkHtml}</div>`;
                            const td = item.querySelector('.preview-text');
                            
                            if(pt.subs && pt.subs.length > 0) { 
                                const sl = document.createElement('div'); sl.className = "sub-list"; 
                                pt.subs.forEach((sb, si) => { 
                                    const subText = (typeof sb === 'object') ? sb.text : sb;
                                    const subStatus = (typeof sb === 'object') ? sb.status : "";
                                    const subWho = (typeof sb === 'object') ? sb.who : "";
                                    const subLink = (typeof sb === 'object') ? sb.link : "";
                                    const subSubs = (typeof sb === 'object' && sb.subsubs) ? sb.subsubs : [];

                                    if(subText.trim() || subSubs.length > 0) {
                                        let sLinkHtml = getLinkHtml(subLink, `qr-s-${speakerIdx}-${i}-${si}`);
                                        let html = `<div class="sub-item"><div class="sub-num">${i+1}.${si+1}</div><div class="sub-text-wrapper"><div class="sub-text">${subText}</div>${sLinkHtml}`;
                                        if(subStatus) { const whoLabel = subStatus === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (subWho.toUpperCase() || "PGB"); html += `<div class="status-tag">${whoLabel}</div>`; }
                                        
                                        if(subSubs.length > 0) {
                                            html += `<div class="sub-sub-list">`;
                                            subSubs.forEach((ss, ssi) => {
                                                const ssStatus = ss.status || "";
                                                const ssWho = ss.who || "";
                                                const ssLink = ss.link || "";
                                                if(ss.text.trim()) {
                                                    let ssLinkHtml = getLinkHtml(ssLink, `qr-ss-${speakerIdx}-${i}-${si}-${ssi}`);
                                                    html += `<div class="sub-sub-item"><div class="sub-sub-num">${i+1}.${si+1}.${ssi+1}</div><div class="sub-sub-text-wrapper flex-grow"><div class="sub-sub-text">${ss.text}</div>${ssLinkHtml}`;
                                                    if(ssStatus) { const ssWhoLabel = ssStatus === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (ssWho.toUpperCase() || "PGB"); html += `<div class="status-tag">${ssWhoLabel}</div>`; }
                                                    html += `</div></div>`;
                                                }
                                            });
                                            html += `</div>`;
                                        }
                                        html += `</div></div>`;
                                        sl.innerHTML += html;
                                    } 
                                }); 
                                td.appendChild(sl); 
                            }
                            if(pt.status) td.innerHTML += `<div class="status-tag">${pt.status === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (pt.who.toUpperCase() || "PGB")}</div>`;
                            if(pt.text.trim() || (pt.subs && pt.subs.length>0)) list.appendChild(item);
                        });
                    }
                    sec.appendChild(list); if((s.points && s.points.length>0) || s.name) c.appendChild(sec);
                });
            }

            // Setup QR Codes
            setTimeout(() => {
                qrQueue.forEach(q => {
                    const el = document.getElementById(q.id);
                    if (el) {
                        el.innerHTML = ""; 
                        new QRCode(el, { text: q.url, width: 100, height: 100, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L });
                        const img = el.querySelector('img'); const cvs = el.querySelector('canvas');
                        if(img) img.style.cssText = "width: 100%; height: 100%; object-fit: contain; display: block;";
                        if(cvs) cvs.style.cssText = "width: 100%; height: 100%; object-fit: contain; display: block;";
                    }
                });
            }, 100);
        }
    </script>
</body>
</html>
