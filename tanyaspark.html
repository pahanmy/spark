<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Tanya Soalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .slide-in { animation: slideIn 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar cantik */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7cc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-sm z-40 shrink-0">
        <div class="max-w-screen-2xl mx-auto py-3 px-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-indigo-600 tracking-tight">SPARK Q&A</h1>
                    <p id="program-title" class="text-xs text-gray-500 font-medium">Memuatkan Program...</p>
                </div>
            </div>
            <a href="#" onclick="history.back()" class="text-sm font-semibold text-gray-500 hover:text-indigo-600">Kembali</a>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row h-full overflow-hidden">
        
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 p-6 flex flex-col items-center justify-center text-center z-10 shadow-lg relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Imbas untuk Tanya</h2>
            <p class="text-sm text-gray-500 mb-6 px-4">Gunakan kamera telefon anda untuk menghantar soalan kepada penceramah.</p>
            
            <div class="bg-white p-2 rounded-xl shadow-md border-2 border-indigo-100 mb-6 transform transition-transform hover:scale-105 duration-300">
                <img id="qa-qr-code" src="" alt="QR Soalan" class="w-48 h-48 md:w-56 md:h-56 object-contain">
            </div>

            <div class="grid grid-cols-2 gap-4 w-full mt-4">
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <p class="text-xs text-indigo-600 font-bold uppercase">Soalan Baru</p>
                    <p id="count-open" class="text-2xl font-bold text-indigo-700">0</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <p class="text-xs text-green-600 font-bold uppercase">Dijawab</p>
                    <p id="count-answered" class="text-2xl font-bold text-green-700">0</p>
                </div>
            </div>
        </aside>

        <section class="w-full md:w-2/3 lg:w-3/4 p-4 md:p-8 overflow-y-auto bg-gray-50 relative">
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-indigo-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 -mb-20 -ml-20 w-80 h-80 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 pointer-events-none"></div>

            <div class="max-w-4xl mx-auto space-y-8 relative z-10">
                
                <div>
                    <h3 class="flex items-center gap-2 text-lg font-bold text-gray-700 mb-4">
                        <span class="flex h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
                        Soalan Terkini
                    </h3>
                    <div id="questions-list" class="space-y-4 min-h-[100px]">
                        <div class="text-center py-10 text-gray-400 italic">
                            Belum ada soalan. Jadilah yang pertama bertanya!
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-dashed border-gray-200"></div>

                <div class="opacity-80">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-gray-500 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        Telah Dijawab
                    </h3>
                    <div id="answered-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </section>
    </main>

    <div id="answer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Jawab Soalan</h3>
            <div class="bg-indigo-50 p-3 rounded-lg mb-4 border border-indigo-100">
                <p id="modal-question-text" class="text-sm text-gray-700 italic font-medium">Soalan...</p>
                <p id="modal-asker-name" class="text-xs text-gray-500 mt-1 text-right">- Nama Peserta</p>
            </div>
            
            <form id="answer-form" onsubmit="submitAnswer(event)">
                <input type="hidden" id="modal-question-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jawapan / Catatan Penyelaras</label>
                    <textarea id="answer-input" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Tulis jawapan ringkas di sini..." required></textarea>
                </div>
                
                <div class="mb-4 border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pengesahan Penyelaras</label>
                    <input type="password" id="admin-ic-check" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" placeholder="Masukkan No. IC Penyelaras" required>
                    <p id="auth-error" class="text-red-500 text-xs mt-1 hidden">No. IC tidak sah.</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeAnswerModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-md">Simpan & Tanda Selesai</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let currentProgram = null;
        const urlParams = new URLSearchParams(window.location.search);
        const programKey = urlParams.get('kod');

        if (programKey) {
            initPage();
        } else {
            alert("Tiada kod program.");
        }

        function initPage() {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
            
            // Generate QR Code URL
            const baseUrl = window.location.origin + window.location.pathname.replace('tanyaspark.html', '');
            const askUrl = `${baseUrl}soalan.html?kod=${programKey}`;
            document.getElementById('qa-qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(askUrl)}`;

            onSnapshot(programRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgram = { id: docSnap.id, ...docSnap.data() };
                    document.getElementById('program-title').textContent = currentProgram.name.toUpperCase();
                    renderQuestions(currentProgram.questions || []);
                }
            });
        }

        function renderQuestions(questions) {
            const listContainer = document.getElementById('questions-list');
            const answeredContainer = document.getElementById('answered-list');
            const countOpen = document.getElementById('count-open');
            const countAnswered = document.getElementById('count-answered');

            // Asingkan soalan
            const openQuestions = questions.filter(q => !q.isAnswered).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const answeredQuestions = questions.filter(q => q.isAnswered).sort((a, b) => new Date(b.answeredAt) - new Date(a.answeredAt));

            countOpen.textContent = openQuestions.length;
            countAnswered.textContent = answeredQuestions.length;

            // Render Open Questions
            if (openQuestions.length === 0) {
                listContainer.innerHTML = `<div class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300"><p class="text-gray-400 italic">Belum ada soalan baru.</p></div>`;
            } else {
                listContainer.innerHTML = openQuestions.map(q => `
                    <div onclick="openAnswerModal('${q.id}')" class="card p-5 cursor-pointer hover:shadow-lg transition-all border-l-4 border-indigo-500 slide-in group">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold text-xs">?</div>
                                <div>
                                    <p class="text-sm font-bold text-gray-800">${q.senderName || 'Peserta'}</p>
                                    <p class="text-[10px] text-gray-500 uppercase">${q.senderStation || ''}</p>
                                </div>
                            </div>
                            <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full">${formatTime(q.timestamp)}</span>
                        </div>
                        <p class="text-gray-700 text-lg font-medium leading-relaxed mt-1">"${q.content}"</p>
                        <p class="text-xs text-indigo-400 mt-3 opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Klik untuk jawab &rarr;</p>
                    </div>
                `).join('');
            }

            // Render Answered Questions
            answeredContainer.innerHTML = answeredQuestions.map(q => `
                <div class="card p-4 border border-gray-100 bg-gray-50 opacity-90">
                    <div class="flex justify-between mb-2">
                        <p class="text-xs font-bold text-gray-600">${q.senderName}</p>
                        <span class="text-[10px] text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full">SELESAI</span>
                    </div>
                    <p class="text-gray-800 text-sm mb-3">"${q.content}"</p>
                    <div class="bg-white p-3 rounded-lg border border-green-100 flex gap-2">
                        <div class="mt-0.5 text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>
                        <div>
                            <p class="text-xs font-bold text-green-700 mb-0.5">Jawapan / Respon:</p>
                            <p class="text-sm text-gray-600">${q.answerText || 'Tiada catatan.'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(isoString) {
            if(!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
        }

        // --- ADMIN FUNCTIONS ---
        window.openAnswerModal = (qId) => {
            const q = currentProgram.questions.find(item => item.id === qId);
            if(!q) return;

            document.getElementById('modal-question-id').value = qId;
            document.getElementById('modal-question-text').textContent = q.content;
            document.getElementById('modal-asker-name').textContent = `- ${q.senderName} (${q.senderStation || ''})`;
            document.getElementById('answer-input').value = '';
            document.getElementById('admin-ic-check').value = '';
            document.getElementById('auth-error').classList.add('hidden');
            
            document.getElementById('answer-modal').classList.remove('hidden');
        };

        window.closeAnswerModal = () => {
            document.getElementById('answer-modal').classList.add('hidden');
        };

        window.submitAnswer = async (e) => {
            e.preventDefault();
            const inputIc = document.getElementById('admin-ic-check').value;
            const answerText = document.getElementById('answer-input').value;
            const qId = document.getElementById('modal-question-id').value;

            if(inputIc !== currentProgram.penyelaras_ic) {
                document.getElementById('auth-error').classList.remove('hidden');
                return;
            }

            // Cari soalan lama untuk dibuang, dan masukkan versi baru
            const oldQuestion = currentProgram.questions.find(item => item.id === qId);
            const newQuestion = { 
                ...oldQuestion, 
                isAnswered: true, 
                answerText: answerText, 
                answeredAt: new Date().toISOString() 
            };

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            
            try {
                // Dalam array firestore, update agak leceh. Kita remove dulu, then add modified one.
                await updateDoc(programRef, { questions: arrayRemove(oldQuestion) });
                await updateDoc(programRef, { questions: arrayUnion(newQuestion) });
                closeAnswerModal();
            } catch(err) {
                console.error(err);
                alert("Gagal menyimpan jawapan.");
            }
        };
    </script>
</body>
</html>
