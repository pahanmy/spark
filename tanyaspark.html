<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Dashboard Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card { border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .slide-in { animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(30px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* QR Pulse Animation */
        .qr-pulse { animation: qrPulse 3s infinite; }
        @keyframes qrPulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-sm z-40 shrink-0 border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto py-3 px-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-sm">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight leading-none">SPARK Q&A Live</h1>
                    <p id="program-title" class="text-sm text-gray-500 font-medium">Memuatkan Program...</p>
                </div>
            </div>
            <a href="#" onclick="history.back()" class="flex items-center gap-2 text-sm font-semibold text-gray-500 hover:text-indigo-600 transition-colors bg-gray-50 px-4 py-2 rounded-full border border-gray-200 hover:border-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                Kembali
            </a>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row h-full overflow-hidden">
        
        <aside class="w-full md:w-[350px] lg:w-[400px] bg-white border-r border-gray-200 p-6 flex flex-col items-center justify-center text-center z-10 shadow-xl relative shrink-0">
            <div class="absolute inset-0 bg-gradient-to-b from-indigo-50/50 to-white z-0"></div>
            
            <div class="relative z-10 flex flex-col items-center w-full h-full justify-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Imbas untuk Tanya</h2>
                <p class="text-sm text-gray-500 mb-8 px-4 leading-relaxed">Gunakan kamera telefon anda untuk menghantar soalan terus ke skrin ini.</p>
                
                <div class="bg-white p-4 rounded-3xl shadow-lg border border-gray-100 mb-8 transform transition-transform hover:scale-105 duration-500 qr-pulse">
                    <img id="qa-qr-code" src="" alt="QR Soalan" class="w-72 h-72 object-contain rounded-lg">
                </div>

                <div class="grid grid-cols-2 gap-4 w-full">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col items-center">
                        <span class="text-[10px] text-indigo-500 font-bold uppercase tracking-wider">Soalan Baru</span>
                        <p id="count-open" class="text-4xl font-bold text-indigo-700 mt-1">0</p>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex flex-col items-center">
                        <span class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">Dijawab</span>
                        <p id="count-answered" class="text-4xl font-bold text-emerald-700 mt-1">0</p>
                    </div>
                </div>
            </div>
        </aside>

        <section class="flex-1 p-6 md:p-10 overflow-y-auto bg-gray-50/80 relative scroll-smooth">
            <div class="max-w-4xl mx-auto space-y-10">
                
                <div>
                    <div class="flex items-center justify-between mb-6 sticky top-0 bg-gray-50/95 py-2 z-20 backdrop-blur-sm">
                        <h3 class="flex items-center gap-3 text-xl font-bold text-gray-800">
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                            Soalan Terkini
                        </h3>
                    </div>
                    
                    <div id="questions-list" class="space-y-5 min-h-[100px] pb-4">
                        <div class="text-center py-20 flex flex-col items-center justify-center border-2 border-dashed border-gray-200 rounded-2xl bg-white/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                            <p class="text-gray-400 font-medium">Menunggu soalan pertama...</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200"></div>

                <div class="opacity-75 hover:opacity-100 transition-opacity duration-300">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-gray-600 mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        Arkib Jawapan
                    </h3>
                    <div id="answered-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </section>
    </main>

    <div id="answer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 hidden backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform scale-100 transition-transform">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-gray-800">Jawab Soalan</h3>
                <button onclick="closeAnswerModal()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100">
                <div class="flex items-start gap-3">
                    <div class="mt-1 flex-shrink-0 text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    </div>
                    <div>
                        <p id="modal-question-text" class="text-gray-800 font-medium text-lg leading-snug">Soalan...</p>
                        <p id="modal-asker-name" class="text-sm text-gray-500 mt-2 font-semibold">- Nama Peserta</p>
                    </div>
                </div>
            </div>
            
            <form id="answer-form" onsubmit="submitAnswer(event)">
                <input type="hidden" id="modal-question-id">
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jawapan / Catatan</label>
                    <textarea id="answer-input" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white" placeholder="Taip respons anda di sini..." required></textarea>
                </div>
                
                <div class="mb-6 pt-4 border-t border-gray-100">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Pengesahan Admin</label>
                    <input type="password" id="admin-ic-check" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm" placeholder="Masukkan No. IC Penyelaras" required>
                    <p id="auth-error" class="text-red-500 text-xs mt-1 hidden font-medium flex items-center gap-1"><svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg> No. IC tidak sah.</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeAnswerModal()" class="px-5 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-semibold transition-colors">Batal</button>
                    <button type="submit" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-semibold shadow-lg shadow-indigo-200 transition-all transform active:scale-95">Simpan & Selesai</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayRemove, arrayUnion, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let currentProgram = null;
        let participantMap = new Map(); // Untuk simpan data peserta (IC -> Data)
        const urlParams = new URLSearchParams(window.location.search);
        const programKey = urlParams.get('kod');

        // Warna-warna pastel untuk kad soalan (Cycling Colors)
        const cardColors = [
            { bg: 'bg-white', border: 'border-l-indigo-500', iconBg: 'bg-indigo-100', iconText: 'text-indigo-600' },
            { bg: 'bg-blue-50', border: 'border-l-blue-500', iconBg: 'bg-blue-200', iconText: 'text-blue-700' },
            { bg: 'bg-purple-50', border: 'border-l-purple-500', iconBg: 'bg-purple-200', iconText: 'text-purple-700' },
            { bg: 'bg-rose-50', border: 'border-l-rose-500', iconBg: 'bg-rose-200', iconText: 'text-rose-700' },
            { bg: 'bg-emerald-50', border: 'border-l-emerald-500', iconBg: 'bg-emerald-200', iconText: 'text-emerald-700' },
            { bg: 'bg-amber-50', border: 'border-l-amber-500', iconBg: 'bg-amber-200', iconText: 'text-amber-700' },
        ];

        if (programKey) {
            initPage();
        } else {
            alert("Tiada kod program.");
        }

        async function initPage() {
            // 1. Fetch Peserta DAHULU (sekali jalan) untuk mapping gambar profile
            try {
                const participantsRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const snapshot = await getDocs(participantsRef);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.ic) {
                        participantMap.set(data.ic, data); // Simpan data based on IC
                    }
                });
            } catch (error) {
                console.error("Gagal muat data peserta:", error);
            }

            // 2. Setup Realtime Listener untuk Program & Soalan
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
            
            // Generate QR Code URL
            const baseUrl = window.location.origin + window.location.pathname.replace('tanyaspark.html', '');
            const askUrl = `${baseUrl}soalan.html?kod=${programKey}`;
            document.getElementById('qa-qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(askUrl)}`;

            onSnapshot(programRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgram = { id: docSnap.id, ...docSnap.data() };
                    document.getElementById('program-title').textContent = currentProgram.name.toUpperCase();
                    renderQuestions(currentProgram.questions || []);
                }
            });
        }

        // Fungsi Jana Avatar (Sama logic dengan program.html tapi diperbaiki)
        function getAvatarHTML(ic, name) {
            const pData = participantMap.get(ic); // Cari data peserta guna IC
            
            const isPro = pData && pData.isPro === true;
            const hasImage = pData && pData.profileImageUrl && pData.profileImageUrl.trim() !== "";
            
            // A. Akaun PRO dengan Gambar
            if (isPro && hasImage) {
                return `
                <div class="flex-shrink-0 h-10 w-10 rounded-full ring-2 ring-indigo-500 shadow-sm overflow-hidden bg-gray-200">
                    <img src="${pData.profileImageUrl}" alt="${name}" class="w-full h-full object-cover">
                </div>`;
            }
            // B. Akaun PRO tanpa Gambar
            else if (isPro) {
                return `<div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center text-[10px] font-bold bg-indigo-600 text-white ring-2 ring-indigo-400 shadow-sm">PRO</div>`;
            }
            // C. Pengguna Biasa (Inisial)
            else {
                const initials = name ? name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() : '?';
                return `<div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center text-xs font-bold bg-gray-200 text-gray-600 border border-gray-300">${initials}</div>`;
            }
        }

        function renderQuestions(questions) {
            const listContainer = document.getElementById('questions-list');
            const answeredContainer = document.getElementById('answered-list');
            const countOpen = document.getElementById('count-open');
            const countAnswered = document.getElementById('count-answered');

            const openQuestions = questions.filter(q => !q.isAnswered).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const answeredQuestions = questions.filter(q => q.isAnswered).sort((a, b) => new Date(b.answeredAt) - new Date(a.answeredAt));

            countOpen.textContent = openQuestions.length;
            countAnswered.textContent = answeredQuestions.length;

            // Render Open Questions
            if (openQuestions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-20 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl bg-white/50">
                        <div class="bg-gray-100 p-4 rounded-full mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                        </div>
                        <p class="text-gray-500 font-medium">Belum ada soalan baru.</p>
                        <p class="text-xs text-gray-400">Imbas QR di sebelah untuk bertanya.</p>
                    </div>`;
            } else {
                listContainer.innerHTML = openQuestions.map((q, index) => {
                    // Tentukan warna berdasarkan index (bergilir)
                    const style = cardColors[index % cardColors.length];
                    const avatar = getAvatarHTML(q.ic, q.senderName); // Jana avatar

                    return `
                    <div onclick="openAnswerModal('${q.id}')" class="card p-6 cursor-pointer hover:-translate-y-1 transition-all duration-300 border-l-[6px] ${style.border} ${style.bg} slide-in group shadow-sm hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3 mb-3">
                                ${avatar}
                                <div>
                                    <p class="text-sm font-bold text-gray-800 leading-tight">${q.senderName || 'Peserta'}</p>
                                    <p class="text-[11px] text-gray-500 uppercase font-semibold tracking-wide">${q.senderStation || 'Tetamu'}</p>
                                </div>
                            </div>
                            <span class="text-[10px] text-gray-500 font-mono bg-white/50 px-2 py-1 rounded border border-gray-100">${formatTime(q.timestamp)}</span>
                        </div>
                        <div class="pl-[52px]">
                            <p class="text-gray-800 text-lg font-medium leading-relaxed">"${q.content}"</p>
                            <div class="mt-4 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">Jawab Sekarang &rarr;</span>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            // Render Answered Questions
            answeredContainer.innerHTML = answeredQuestions.map(q => `
                <div class="card p-5 border border-gray-200 bg-white opacity-90 hover:opacity-100 transition-opacity">
                    <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                            <p class="text-xs font-bold text-gray-600 uppercase">${q.senderName}</p>
                        </div>
                        <span class="text-[10px] text-emerald-700 font-bold bg-emerald-100 px-2 py-0.5 rounded">SELESAI</span>
                    </div>
                    <p class="text-gray-800 text-sm font-medium mb-3 italic">"${q.content}"</p>
                    <div class="bg-emerald-50/50 p-3 rounded-lg border border-emerald-100 flex gap-3">
                        <div class="mt-0.5 text-emerald-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>
                        <div>
                            <p class="text-[10px] font-bold text-emerald-800 uppercase tracking-wide mb-1">Respon Admin:</p>
                            <p class="text-sm text-gray-700 leading-snug">${q.answerText || 'Tiada catatan.'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(isoString) {
            if(!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
        }

        // --- ADMIN FUNCTIONS ---
        window.openAnswerModal = (qId) => {
            const q = currentProgram.questions.find(item => item.id === qId);
            if(!q) return;

            document.getElementById('modal-question-id').value = qId;
            document.getElementById('modal-question-text').textContent = q.content;
            document.getElementById('modal-asker-name').textContent = `- ${q.senderName} (${q.senderStation || ''})`;
            document.getElementById('answer-input').value = '';
            document.getElementById('admin-ic-check').value = '';
            document.getElementById('auth-error').classList.add('hidden');
            
            const modal = document.getElementById('answer-modal');
            modal.classList.remove('hidden');
            // Sedikit delay untuk animasi opacity
            setTimeout(() => modal.classList.add('opacity-100'), 10);
        };

        window.closeAnswerModal = () => {
            const modal = document.getElementById('answer-modal');
            modal.classList.remove('opacity-100');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        window.submitAnswer = async (e) => {
            e.preventDefault();
            const inputIc = document.getElementById('admin-ic-check').value;
            const answerText = document.getElementById('answer-input').value;
            const qId = document.getElementById('modal-question-id').value;

            if(inputIc !== currentProgram.penyelaras_ic) {
                document.getElementById('auth-error').classList.remove('hidden');
                return;
            }

            const oldQuestion = currentProgram.questions.find(item => item.id === qId);
            const newQuestion = { 
                ...oldQuestion, 
                isAnswered: true, 
                answerText: answerText, 
                answeredAt: new Date().toISOString() 
            };

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            
            try {
                await updateDoc(programRef, { questions: arrayRemove(oldQuestion) });
                await updateDoc(programRef, { questions: arrayUnion(newQuestion) });
                closeAnswerModal();
            } catch(err) {
                console.error(err);
                alert("Gagal menyimpan jawapan.");
            }
        };
    </script>
</body>
</html>
