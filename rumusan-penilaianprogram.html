<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Laporan Penilaian Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
        }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Bar Progress Animasi */
        .progress-bar-fill { transition: width 1s ease-in-out; }

        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; margin-bottom: 20px; break-inside: avoid; }
            @page { margin: 1cm; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm w-full no-print">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-purple-600 p-2 rounded-lg logo-pulse"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-xl font-bold text-purple-600 leading-tight">SPARK</h1>
                    <p class="text-xs text-gray-500">Analitik Penilaian Program</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.history.back()" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200">Kembali</button>
                <button onclick="window.print()" class="btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                    Cetak Laporan
                </button>
            </div>
        </div>
    </header>

    <main class="w-full max-w-5xl mx-auto flex-grow p-4 sm:p-6 lg:p-8 space-y-6">
        
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin h-10 w-10 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-600 font-medium">Menjana laporan analitik...</p>
        </div>

        <div id="report-content" class="hidden space-y-6">
            
            <div class="card p-6 border-l-4 border-purple-500">
                <h3 class="text-sm font-bold text-purple-600 uppercase tracking-widest mb-1">Rumusan Keseluruhan Penilaian</h3>
                <h2 id="report-program-name" class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2"></h2>
                <p id="report-program-date" class="text-gray-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span></span>
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex items-center justify-between bg-gradient-to-r from-blue-50 to-white border border-blue-100">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 uppercase">Jumlah Kehadiran</p>
                        <p id="total-attendance" class="text-4xl font-black text-blue-900 mt-1">0</p>
                        <p class="text-xs text-gray-500 mt-1">Peserta hadir berdaftar</p>
                    </div>
                    <div class="p-4 bg-blue-100 rounded-full text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                </div>

                <div class="card p-6 flex items-center justify-between bg-gradient-to-r from-purple-50 to-white border border-purple-100">
                    <div>
                        <p class="text-sm font-semibold text-purple-600 uppercase">Jumlah Menilai</p>
                        <div class="flex items-baseline gap-2 mt-1">
                            <p id="total-evaluations" class="text-4xl font-black text-purple-900">0</p>
                            <p id="evaluation-percentage" class="text-sm font-bold text-purple-600 bg-purple-100 px-2 py-0.5 rounded-md">0%</p>
                        </div>
                        <p id="evaluation-status-text" class="text-xs text-gray-500 mt-1"></p>
                    </div>
                    <div class="p-4 bg-purple-100 rounded-full text-purple-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                    Skor Purata Keseluruhan (Skala 1 - 5)
                </h3>
                <div id="analytics-container" class="space-y-4">
                    </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg>
                    Rumusan Cadangan / Penambahbaikan
                </h3>
                <div id="suggestions-container" class="space-y-3">
                    </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Senarai Peserta Menilai
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">Bil</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama & No. IC</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarikh Diserahkan</th>
                            </tr>
                        </thead>
                        <tbody id="respondents-tbody" class="bg-white divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <footer class="text-center py-6 border-t border-gray-200 mt-8 no-print">
        <p class="text-sm text-gray-500">© 2026 SPARK oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-bold text-purple-600 hover:underline">PahanStudio</a></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        let db, auth;
        const appId = firebaseConfig.projectId;

        const evaluationQuestions = [
            "Pengurusan teratur", "Lokasi sesuai", "Program ini mampu meningkatkan prestasi kerja saya",
            "Program ini memberi keyakinan kepada saya dalam memberi perkhidmatan", "Tempoh masa program mencukupi",
            "Saya bersedia untuk memberi kursus dalaman", "Bahan perkongsian berguna dan membantu",
            "Bahan perkongsian mudah difahami dan jelas", "Isi kandungan sesuai dengan objektif dan menepati tajuk",
            "Isi kandungan mampu meningkatkan percambahan ilmu saya", "Isi kandungan membantu saya mengamalkannya dalam tugas seharian",
            "Penyampaian amat jelas", "Bahasa yang digunakan mudah difahami", "Interaksi penceramah/fasilitator adalah sesuai",
            "Penceramah/fasilitator bersifat bersedia, yakin dan terbuka", "Penampilan penceramah/fasilitator adalah sesuai dan profesional",
            "Penceramah/fasilitator menepati masa", "Penceramah/fasilitator menggunakan masa secara optimum"
        ];

        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => { if (user) main(); else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } } });

        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        async function main() {
            // Nota: Menggunakan parameter 'kod' yang merujuk kepada ID Dokumen Program (sama seperti dashboard)
            const urlParams = new URLSearchParams(window.location.search);
            const programKey = urlParams.get('kod');

            if (!programKey) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Ralat: Kod program tidak ditemui pada URL.</p>`;
                return;
            }

            try {
                const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
                const docSnap = await getDoc(programRef);

                if (!docSnap.exists()) {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Program tidak ditemui.</p>`;
                    return;
                }

                const programData = docSnap.data();
                const evaluations = programData.evaluations || [];
                const attendance = programData.attendance || [];

                // 1. Setup Maklumat Asas
                document.getElementById('report-program-name').textContent = programData.name.toUpperCase();
                let dateDisplay = formatShortDate(programData.startDate);
                if (programData.startDate !== programData.endDate) {
                    dateDisplay += ` - ${formatShortDate(programData.endDate)}`;
                }
                document.querySelector('#report-program-date span').textContent = dateDisplay;

                // 2. Metrik Perbandingan
                // Buang duplikasi kehadiran untuk dapatkan jumlah unik individu (jika berbilang hari)
                const uniqueAttendees = new Set(attendance.map(a => a.ic)).size;
                const uniqueEvaluators = new Set(evaluations.map(e => e.ic)).size;

                document.getElementById('total-attendance').textContent = uniqueAttendees;
                document.getElementById('total-evaluations').textContent = uniqueEvaluators;
                
                let percentage = 0;
                if (uniqueAttendees > 0) {
                    percentage = Math.round((uniqueEvaluators / uniqueAttendees) * 100);
                }
                document.getElementById('evaluation-percentage').textContent = `${percentage}%`;

                const statusText = document.getElementById('evaluation-status-text');
                if (uniqueEvaluators >= uniqueAttendees && uniqueAttendees > 0) {
                    statusText.innerHTML = `<span class="text-green-600 font-semibold">Tugasan Selesai.</span> Semua yang hadir telah menilai.`;
                } else {
                    const diff = uniqueAttendees - uniqueEvaluators;
                    statusText.innerHTML = `<span class="text-red-500 font-semibold">${diff} peserta</span> yang hadir belum memberi penilaian.`;
                }

                // 3. Analitik Skor (Kira Purata)
                renderAnalytics(evaluations);

                // 4. Render Cadangan
                renderSuggestions(evaluations);

                // 5. Render Jadual Responden
                renderRespondentsTable(evaluations);

                // Paparkan kandungan
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('report-content').classList.remove('hidden');

            } catch (error) {
                console.error("Gagal mengambil data:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Ralat teknikal semasa memuat turun data.</p>`;
            }
        }

        function renderAnalytics(evaluations) {
            const container = document.getElementById('analytics-container');
            
            if (evaluations.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic">Belum ada data penilaian direkodkan.</p>`;
                return;
            }

            // Kira jumlah skor dan kekerapan untuk setiap soalan
            const sums = Array(18).fill(0);
            const counts = Array(18).fill(0);

            evaluations.forEach(ev => {
                if (ev.responses) {
                    for (let i = 1; i <= 18; i++) {
                        if (ev.responses[`q${i}`]) {
                            sums[i-1] += ev.responses[`q${i}`];
                            counts[i-1]++;
                        }
                    }
                }
            });

            let html = '';
            evaluationQuestions.forEach((q_text, index) => {
                let avg = 0;
                if (counts[index] > 0) {
                    avg = (sums[index] / counts[index]).toFixed(2);
                }
                
                const percentage = (avg / 5) * 100;
                
                // Tentukan warna bar (Hijau jika > 4, Kuning jika > 3, Merah jika < 3)
                let barColor = 'bg-purple-500';
                if (avg >= 4.5) barColor = 'bg-green-500';
                else if (avg >= 3.5) barColor = 'bg-blue-500';
                else if (avg >= 2.5) barColor = 'bg-yellow-500';
                else barColor = 'bg-red-500';

                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700 truncate w-3/4" title="${q_text}">${index + 1}. ${q_text}</span>
                            <span class="text-sm font-bold text-gray-900">${avg} <span class="text-xs text-gray-500 font-normal">/ 5.0</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${barColor} h-2.5 rounded-full progress-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderSuggestions(evaluations) {
            const container = document.getElementById('suggestions-container');
            
            // Tapis hanya yang ada komen dan bukan sekadar whitespace
            const validSuggestions = evaluations.filter(ev => ev.suggestion && ev.suggestion.trim().length > 0);

            if (validSuggestions.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic text-sm">Tiada cadangan tambahan diberikan oleh peserta.</p>`;
                return;
            }

            let html = '';
            validSuggestions.forEach(ev => {
                html += `
                    <div class="p-4 bg-yellow-50/50 border border-yellow-100 rounded-lg">
                        <p class="text-sm text-gray-800 leading-relaxed italic">"${ev.suggestion}"</p>
                        <p class="text-xs font-semibold text-gray-500 mt-2 text-right">- ${ev.name.toUpperCase()}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderRespondentsTable(evaluations) {
            const tbody = document.getElementById('respondents-tbody');
            
            if (evaluations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">Tiada rekod.</td></tr>`;
                return;
            }

            // Susun dari yang terkini (terbaru) kepada yang lama
            const sortedEvals = [...evaluations].sort((a, b) => new Date(b.time) - new Date(a.time));

            let html = '';
            sortedEvals.forEach((ev, index) => {
                const submitDate = new Date(ev.time).toLocaleString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' });
                
                // Jika dia submit untuk hari tertentu
                let dayBadge = '';
                if (ev.evalDate) {
                    dayBadge = `<span class="inline-block mt-1 bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded border border-gray-200">Menilai untuk: ${formatShortDate(ev.evalDate)}</span>`;
                }

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-bold text-gray-900">${ev.name.toUpperCase()}</div>
                            <div class="text-xs text-gray-500">${ev.ic}</div>
                            ${dayBadge}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">${submitDate}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

    </script>
</body>
</html>
