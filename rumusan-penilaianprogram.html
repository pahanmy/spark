<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Laporan Penilaian Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
        }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
        
        /* Bar Progress Animasi */
        .progress-bar-fill { transition: width 1s ease-in-out; }
        
        .modal-backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }

        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; margin-bottom: 20px; break-inside: avoid; }
            @page { margin: 1cm; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm w-full no-print">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-purple-600 p-2 rounded-lg logo-pulse"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-xl font-bold text-purple-600 leading-tight">SPARK</h1>
                    <p class="text-xs text-gray-500">Analitik Penilaian Program</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center justify-center gap-2">
                <button onclick="window.history.back()" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200">Kembali</button>
                <button onclick="exportAnalysisToExcel()" class="btn bg-green-100 text-green-800 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-200 flex items-center gap-2" title="Muat Turun Excel">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Excel
                </button>
                <button onclick="exportAnalysisToPDF()" class="btn bg-red-100 text-red-800 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 flex items-center gap-2" title="Muat Turun PDF">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                    PDF
                </button>
                <button onclick="window.print()" class="btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 flex items-center gap-2" title="Cetak Paparan Penuh">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                    Cetak
                </button>
            </div>
        </div>
    </header>

    <main class="w-full max-w-5xl mx-auto flex-grow p-4 sm:p-6 lg:p-8 space-y-6">
        
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin h-10 w-10 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-600 font-medium">Menjana laporan analitik...</p>
        </div>

        <div id="report-content" class="hidden space-y-6">
            
            <div class="card p-6 border-l-4 border-purple-500">
                <h3 class="text-sm font-bold text-purple-600 uppercase tracking-widest mb-1">Laporan Penilaian Program</h3>
                <h2 id="report-program-name" class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2"></h2>
                <p id="report-program-date" class="text-gray-600 flex items-center gap-2 text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span></span>
                </p>
            </div>

            <div class="border-b border-gray-300 no-print">
                <nav id="eval-date-tabs" class="-mb-px flex space-x-2 overflow-x-auto pb-1"></nav>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex items-center justify-between bg-gradient-to-r from-blue-50 to-white border border-blue-100">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 uppercase">Jumlah Kehadiran (Wajib Menilai)</p>
                        <p id="total-attendance" class="text-4xl font-black text-blue-900 mt-1">0</p>
                        <p id="attendance-context-text" class="text-xs text-gray-500 mt-1 font-medium">Telah menolak peserta dikecualikan</p>
                    </div>
                    <div class="p-4 bg-blue-100 rounded-full text-blue-500 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                </div>

                <div class="card p-6 flex items-center justify-between bg-gradient-to-r from-purple-50 to-white border border-purple-100">
                    <div>
                        <p class="text-sm font-semibold text-purple-600 uppercase">Telah Menilai</p>
                        <div class="flex items-baseline gap-2 mt-1">
                            <p id="total-evaluations" class="text-4xl font-black text-purple-900">0</p>
                            <p id="evaluation-percentage" class="text-sm font-bold text-purple-600 bg-purple-100 px-2 py-0.5 rounded-md shadow-sm">0%</p>
                        </div>
                        <p id="evaluation-status-text" class="text-xs text-gray-500 mt-1 font-medium"></p>
                    </div>
                    <div class="p-4 bg-purple-100 rounded-full text-purple-500 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                    Skor Purata <span id="chart-context-label">Harian</span> (Skala 1 - 5)
                </h3>
                <div id="analytics-container" class="space-y-4"></div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg>
                    Rumusan Cadangan / Penambahbaikan
                </h3>
                <div id="suggestions-container" class="space-y-3"></div>
            </div>

            <div id="pending-section" class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-4 gap-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Senarai Belum Menilai (Peserta Wajib)
                    </h3>
                    <div class="flex flex-wrap items-center gap-2 no-print">
                        <button onclick="copyPendingNames()" class="btn bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-gray-200 flex items-center gap-2" title="Salin Senarai Nama">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                            Salin Nama
                        </button>
                        <button onclick="openBulkAttendanceChangeModal()" class="btn bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-indigo-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            Ubah Tarikh Hadir Pukal
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left w-10 no-print">
                                    <input type="checkbox" id="selectAllPendingCheckbox" onclick="toggleAllPendingCheckboxes(this)" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-12">Bil</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama Peserta</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-40 no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="pending-tbody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="exempted-section" class="card p-6 border-l-4 border-amber-400">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                    Senarai Dikecualikan Menilai
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-12">Bil</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama Peserta</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Sebab</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32 no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="exempted-tbody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-4 gap-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        Senarai Peserta Menilai
                    </h3>
                    <button onclick="openBulkChangeModal()" class="btn bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-indigo-200 flex items-center gap-2 no-print">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        Ubah Tarikh Pukal
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left w-10 no-print">
                                    <input type="checkbox" id="selectAllCheckbox" onclick="toggleAllCheckboxes(this)" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-12">Bil</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama Peserta</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tarikh / Masa Borang Diserahkan</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32 no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="respondents-tbody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div id="bulk-attendance-change-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Ubah Tarikh Kehadiran</h3>
            <p class="text-xs text-gray-500 mb-4">Ubah tarikh hadir untuk <span id="bulk-attendance-count" class="font-bold text-indigo-600">0</span> peserta yang tersalah imbas QR.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pindah ke Tarikh</label>
                    <select id="bulk-attendance-new-date" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 text-sm"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pengesahan Penyelaras</label>
                    <input type="password" id="bulk-attendance-admin-verify" placeholder="4 Digit Terakhir No. IC Penyelaras" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('bulk-attendance-change-modal')" class="btn bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm">Batal</button>
                <button onclick="submitBulkAttendanceChange()" class="btn bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg text-sm">Simpan</button>
            </div>
        </div>
    </div>

    <div id="exemption-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Kecualikan Peserta</h3>
            <p class="text-xs text-gray-500 mb-4">Pilih sebab untuk mengecualikan individu ini daripada wajib mengisi borang penilaian.</p>
            
            <input type="hidden" id="exemption-ic">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pilih Sebab</label>
                    <select id="exemption-reason" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-amber-500 focus:border-amber-500 text-sm">
                        <option value="Urusetia">Urusetia</option>
                        <option value="Penceramah">Penceramah</option>
                        <option value="Fasilitator">Fasilitator</option>
                        <option value="VIP / Jemputan">VIP / Jemputan Khas</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pengesahan Penyelaras</label>
                    <input type="password" id="exemption-admin-verify" placeholder="4 Digit Terakhir No. IC Penyelaras" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-amber-500 focus:border-amber-500 text-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('exemption-modal')" class="btn bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm">Batal</button>
                <button onclick="submitExemption()" class="btn bg-amber-500 text-white font-semibold px-4 py-2 rounded-lg text-sm hover:bg-amber-600">Simpan Status</button>
            </div>
        </div>
    </div>

    <div id="change-date-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Ubah Tarikh Penilaian</h3>
            <p class="text-xs text-gray-500 mb-4">Pilih tarikh baharu yang sepatutnya untuk rekod peserta ini.</p>
            
            <input type="hidden" id="change-date-ic">
            <input type="hidden" id="change-date-old">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tarikh Baharu</label>
                    <select id="new-date-select" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-purple-500 focus:border-purple-500 text-sm"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pengesahan Penyelaras</label>
                    <input type="password" id="admin-ic-verify" placeholder="4 Digit Terakhir No. IC Penyelaras" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-purple-500 focus:border-purple-500 text-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('change-date-modal')" class="btn bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm">Batal</button>
                <button onclick="submitChangeDate()" class="btn bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg text-sm">Simpan Tarikh</button>
            </div>
        </div>
    </div>

    <div id="bulk-change-date-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Ubah Tarikh Secara Pukal</h3>
            <p class="text-xs text-gray-500 mb-4">Anda sedang menukar tarikh penilaian untuk <span id="bulk-count-label" class="font-bold text-indigo-600">0</span> rekod yang dipilih.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tarikh Baharu</label>
                    <select id="bulk-new-date-select" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 text-sm"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pengesahan Penyelaras</label>
                    <input type="password" id="bulk-admin-ic-verify" placeholder="4 Digit Terakhir No. IC Penyelaras" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('bulk-change-date-modal')" class="btn bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm">Batal</button>
                <button onclick="submitBulkChangeDate()" class="btn bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg text-sm">Simpan Pukal</button>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 border-t border-gray-200 mt-8 no-print">
        <p class="text-sm text-gray-500">© 2026 SPARK oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-bold text-purple-600 hover:underline">PahanStudio</a></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        let db, auth;
        let currentProgram = null;
        let selectedEvalDate = 'all'; 
        const appId = firebaseConfig.projectId;

        const evaluationQuestions = [
            "Pengurusan teratur", "Lokasi sesuai", "Program ini mampu meningkatkan prestasi kerja saya",
            "Program ini memberi keyakinan kepada saya dalam memberi perkhidmatan", "Tempoh masa program mencukupi",
            "Saya bersedia untuk memberi kursus dalaman", "Bahan perkongsian berguna dan membantu",
            "Bahan perkongsian mudah difahami dan jelas", "Isi kandungan sesuai dengan objektif dan menepati tajuk",
            "Isi kandungan mampu meningkatkan percambahan ilmu saya", "Isi kandungan membantu saya mengamalkannya dalam tugas seharian",
            "Penyampaian amat jelas", "Bahasa yang digunakan mudah difahami", "Interaksi penceramah/fasilitator adalah sesuai",
            "Penceramah/fasilitator bersifat bersedia, yakin dan terbuka", "Penampilan penceramah/fasilitator adalah sesuai dan profesional",
            "Penceramah/fasilitator menepati masa", "Penceramah/fasilitator menggunakan masa secara optimum"
        ];

        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => { if (user) main(); else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } } });

        function getLocalDateString(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const programKey = urlParams.get('kod');

            if (!programKey) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Ralat: Kod program tidak ditemui pada URL.</p>`;
                return;
            }

            try {
                const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
                const docSnap = await getDoc(programRef);

                if (!docSnap.exists()) {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Program tidak ditemui.</p>`;
                    return;
                }

                currentProgram = { id: docSnap.id, ...docSnap.data() };
                if (!currentProgram.exemptions) currentProgram.exemptions = {}; // Initialize jika belum wujud

                document.getElementById('report-program-name').textContent = currentProgram.name.toUpperCase();
                let dateDisplay = formatShortDate(currentProgram.startDate);
                if (currentProgram.startDate !== currentProgram.endDate) {
                    dateDisplay += ` - ${formatShortDate(currentProgram.endDate)}`;
                }
                document.querySelector('#report-program-date span').textContent = dateDisplay;

                renderDateTabs();

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('report-content').classList.remove('hidden');

            } catch (error) {
                console.error("Gagal mengambil data:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-600 font-bold">Ralat teknikal semasa memuat turun data.</p>`;
            }
        }

        function renderDateTabs() {
            const tabsContainer = document.getElementById('eval-date-tabs');
            tabsContainer.innerHTML = '';
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            const programDates = [];

            for (let dt = startDate; dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                programDates.push(new Date(dt));
            }

            const isAllActive = selectedEvalDate === 'all';
            const allTab = document.createElement('a');
            allTab.href = '#';
            allTab.className = `whitespace-nowrap py-2 px-5 border-b-2 font-bold text-sm rounded-t-lg transition-all flex items-center gap-2 ${isAllActive ? 'text-indigo-700 border-indigo-600 bg-indigo-50' : 'text-gray-500 border-transparent hover:text-gray-700 hover:bg-gray-50 bg-white'}`;
            allTab.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg> KESELURUHAN`;
            allTab.onclick = (e) => { 
                e.preventDefault(); 
                selectedEvalDate = 'all'; 
                renderDateTabs(); 
            };
            tabsContainer.appendChild(allTab);

            if (programDates.length > 0) {
                programDates.forEach((date, index) => {
                    const dateStr = getLocalDateString(date);
                    const isActive = dateStr === selectedEvalDate;
                    
                    const tabColorClasses = [
                        'text-indigo-700 border-indigo-600 bg-indigo-50/50', 
                        'text-emerald-700 border-emerald-600 bg-emerald-50/50', 
                        'text-purple-700 border-purple-600 bg-purple-50/50', 
                        'text-amber-700 border-amber-600 bg-amber-50/50', 
                        'text-rose-700 border-rose-600 bg-rose-50/50' 
                    ];
                    const activeClass = tabColorClasses[index % tabColorClasses.length];
                    const inactiveClass = 'text-gray-500 border-transparent hover:text-gray-700 hover:bg-gray-50 bg-white';

                    const tab = document.createElement('a');
                    tab.href = '#';
                    tab.textContent = formatShortDate(dateStr);
                    tab.className = `whitespace-nowrap py-2 px-5 border-b-2 font-bold text-sm rounded-t-lg transition-all ${isActive ? activeClass : inactiveClass}`;
                    
                    tab.onclick = (e) => {
                        e.preventDefault();
                        selectedEvalDate = dateStr;
                        renderDateTabs(); 
                    };
                    tabsContainer.appendChild(tab);
                });
            }
            
            processDataForSelectedDate();
        }

        function processDataForSelectedDate() {
            const selectAllCb = document.getElementById('selectAllCheckbox');
            if(selectAllCb) selectAllCb.checked = false;
            
            const selectAllPendingCb = document.getElementById('selectAllPendingCheckbox');
            if(selectAllPendingCb) selectAllPendingCb.checked = false;

            const allAttendance = currentProgram.attendance || [];
            const allEvaluations = currentProgram.evaluations || [];
            const exemptions = currentProgram.exemptions || {};

            let filteredAttendance = [];
            let filteredEvals = [];

            if (selectedEvalDate === 'all') {
                filteredAttendance = allAttendance;
                filteredEvals = allEvaluations;
            } else {
                filteredAttendance = allAttendance.filter(a => a.time && getLocalDateString(new Date(a.time)) === selectedEvalDate);
                filteredEvals = allEvaluations.filter(e => e.evalDate === selectedEvalDate);
            }

            // Dapatkan senarai IC unik yang hadir
            const uniqueDailyAttendanceList = [];
            const seenIcs = new Set();
            filteredAttendance.forEach(a => {
                if (!seenIcs.has(a.ic)) {
                    seenIcs.add(a.ic);
                    uniqueDailyAttendanceList.push(a);
                }
            });

            // Senarai IC yang telah menilai
            const evaluatedIcs = new Set(filteredEvals.map(e => e.ic));
            
            // Pengasingan Data Wajib & Dikecualikan
            let requiredAttendeesCount = 0;
            let pendingParticipants = [];
            let exemptedParticipants = [];

            uniqueDailyAttendanceList.forEach(a => {
                const hasEvaluated = evaluatedIcs.has(a.ic);
                const reason = exemptions[a.ic];

                if (reason && !hasEvaluated) {
                    exemptedParticipants.push({ ...a, reason });
                } else if (!hasEvaluated) {
                    pendingParticipants.push(a);
                    requiredAttendeesCount++;
                } else {
                    requiredAttendeesCount++; // Jika dikecualikan tapi dia tetap isi, dia dikira dalam base wajib
                }
            });

            const uniqueDailyAttendees = requiredAttendeesCount; // Base Wajib
            const uniqueDailyEvaluators = evaluatedIcs.size;

            // Kemaskini Paparan Statistik
            document.getElementById('total-attendance').textContent = uniqueDailyAttendees;
            document.getElementById('total-evaluations').textContent = uniqueDailyEvaluators;
            
            let percentage = 0;
            if (uniqueDailyAttendees > 0) {
                percentage = Math.round((uniqueDailyEvaluators / uniqueDailyAttendees) * 100);
                if(percentage > 100) percentage = 100; // Utk keselamatan
            }
            document.getElementById('evaluation-percentage').textContent = `${percentage}%`;

            const statusText = document.getElementById('evaluation-status-text');
            if (uniqueDailyEvaluators >= uniqueDailyAttendees && uniqueDailyAttendees > 0) {
                statusText.innerHTML = `<span class="text-green-600 font-bold">Lengkap!</span> Semua peserta wajib telah menilai.`;
            } else if (uniqueDailyAttendees > 0) {
                const diffVal = uniqueDailyAttendees - uniqueDailyEvaluators;
                statusText.innerHTML = `<span class="text-red-500 font-bold">${diffVal} peserta wajib</span> belum menilai.`;
            } else {
                statusText.innerHTML = `Tiada rekod kehadiran wajib dijumpai.`;
            }

            renderAnalytics(filteredEvals);
            renderSuggestions(filteredEvals);
            renderRespondentsTable(filteredEvals);
            renderPendingAndExemptedTables(pendingParticipants, exemptedParticipants);
        }

        function renderPendingAndExemptedTables(pending, exempted) {
            // JADUAL BELUM MENILAI (WAJIB)
            const pendingTbody = document.getElementById('pending-tbody');
            if (pending.length === 0) {
                pendingTbody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-green-600 font-bold bg-green-50">Semua peserta wajib telah menghantar penilaian!</td></tr>`;
            } else {
                let p_html = '';
                pending.forEach((p, index) => {
                    let jawatanStesen = [];
                    let jawatan = p.jawatan || p.position;
                    let stesen = p.stesen || p.station;
                    if (jawatan) jawatanStesen.push(jawatan);
                    if (stesen) jawatanStesen.push(stesen);
                    
                    let subtitle = jawatanStesen.length > 0 ? `<div class="text-xs font-normal text-gray-500 mt-0.5">${jawatanStesen.join(' • ')}</div>` : '';

                    let attDate = getLocalDateString(new Date(p.time));
                    let cbValue = `${p.ic}|${attDate}`;

                    p_html += `
                        <tr class="hover:bg-red-50 transition-colors">
                            <td class="px-4 py-3 whitespace-nowrap text-left no-print">
                                <input type="checkbox" class="bulk-pending-cb rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" value="${cbValue}">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-bold text-gray-900">${(p.name || 'Tiada Nama Diperoleh').toUpperCase()}</div>
                                ${subtitle}
                            </td>
                            <td class="px-4 py-3 text-center no-print flex flex-wrap justify-center gap-2">
                                <button onclick="openAttendanceChangeModal('${p.ic}', '${attDate}')" class="btn bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200" title="Ubah Tarikh Hadir">Ubah Hari</button>
                                <button onclick="openExemptionModal('${p.ic}')" class="btn bg-amber-100 text-amber-700 px-3 py-1 rounded text-xs font-bold hover:bg-amber-200" title="Kecualikan Menilai">Kecualikan</button>
                            </td>
                        </tr>
                    `;
                });
                pendingTbody.innerHTML = p_html;
            }

            // JADUAL DIKECUALIKAN
            const exemptedTbody = document.getElementById('exempted-tbody');
            if (exempted.length === 0) {
                document.getElementById('exempted-section').classList.add('hidden');
            } else {
                document.getElementById('exempted-section').classList.remove('hidden');
                let e_html = '';
                exempted.forEach((e, index) => {
                    let jawatanStesen = [];
                    let jawatan = e.jawatan || e.position;
                    let stesen = e.stesen || e.station;
                    if (jawatan) jawatanStesen.push(jawatan);
                    if (stesen) jawatanStesen.push(stesen);
                    
                    let subtitle = jawatanStesen.length > 0 ? `<div class="text-xs font-normal text-gray-500 mt-0.5">${jawatanStesen.join(' • ')}</div>` : '';

                    e_html += `
                        <tr class="hover:bg-amber-50 transition-colors">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-bold text-gray-900">${(e.name || 'Tiada Nama Diperoleh').toUpperCase()}</div>
                                ${subtitle}
                            </td>
                            <td class="px-4 py-3"><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold uppercase">${e.reason}</span></td>
                            <td class="px-4 py-3 text-center no-print">
                                <button onclick="promptRemoveExemption('${e.ic}')" class="btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-300">Batal Status</button>
                            </td>
                        </tr>
                    `;
                });
                exemptedTbody.innerHTML = e_html;
            }
        }

        // --- FUNGSI SALIN NAMA PESERTA BELUM MENILAI ---
        window.copyPendingNames = function() {
            const pendingRows = document.querySelectorAll('#pending-tbody tr');
            const noDataCol = document.querySelector('#pending-tbody td[colspan]');
            
            if (pendingRows.length === 0 || noDataCol) {
                return alert("Tiada nama dalam senarai untuk disalin.");
            }

            let textToCopy = "Senarai Peserta Belum Menilai:\n\n";
            let nameElements = document.querySelectorAll('#pending-tbody .text-sm.font-bold.text-gray-900');
            
            nameElements.forEach((el, index) => {
                textToCopy += `${index + 1}. ${el.innerText.trim()}\n`;
            });

            navigator.clipboard.writeText(textToCopy).then(() => {
                alert("Berjaya disalin ke papan keratan (clipboard)!\nAnda boleh 'Paste' senarai ini di WhatsApp/Telegram.");
            }).catch(err => {
                alert("Gagal menyalin: " + err);
            });
        }

        // --- FUNGSI UBAH TARIKH KEHADIRAN (SALAH SCAN QR) ---
        window.toggleAllPendingCheckboxes = function(source) {
            const checkboxes = document.querySelectorAll('.bulk-pending-cb');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        window.openBulkAttendanceChangeModal = function() {
            const checkboxes = document.querySelectorAll('.bulk-pending-cb:checked');
            if (checkboxes.length === 0) return alert("Sila tandakan sekurang-kurangnya seorang peserta pada jadual belum menilai terlebih dahulu.");

            document.getElementById('bulk-attendance-count').textContent = checkboxes.length;
            document.getElementById('bulk-attendance-admin-verify').value = '';

            const select = document.getElementById('bulk-attendance-new-date');
            select.innerHTML = '';
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            
            for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                const dateStr = getLocalDateString(dt);
                const opt = document.createElement('option');
                opt.value = dateStr;
                opt.textContent = formatShortDate(dateStr);
                select.appendChild(opt);
            }
            document.getElementById('bulk-attendance-change-modal').classList.remove('hidden');
        }

        window.submitBulkAttendanceChange = async function() {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");
            const adminCode = document.getElementById('bulk-attendance-admin-verify').value;
            const newDateStr = document.getElementById('bulk-attendance-new-date').value;
            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) return alert("Akses ditolak: Kod pengesahan salah.");

            const selectedValues = Array.from(document.querySelectorAll('.bulk-pending-cb:checked')).map(cb => cb.value);
            
            const updatedAttendance = currentProgram.attendance.map(a => {
                const key = `${a.ic}|${getLocalDateString(new Date(a.time))}`;
                if (selectedValues.includes(key)) {
                    // Tukar time ke tarikh baru dengan masa lalai 08:00 pagi supaya kekal pada tarikh yang betul
                    return { ...a, time: newDateStr + 'T08:00:00' };
                }
                return a;
            });

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            try {
                await updateDoc(programRef, { attendance: updatedAttendance });
                currentProgram.attendance = updatedAttendance;
                closeModal('bulk-attendance-change-modal');
                renderDateTabs(); 
                alert(`Berjaya menukar tarikh kehadiran untuk ${selectedValues.length} peserta.`);
            } catch (e) { alert("Ralat teknikal: " + e.message); }
        }

        window.openAttendanceChangeModal = function(ic, currentAttDate) {
            const checkboxes = document.querySelectorAll('.bulk-pending-cb');
            checkboxes.forEach(cb => cb.checked = false); // Kosongkan yang lain
            const targetCb = Array.from(checkboxes).find(cb => cb.value === `${ic}|${currentAttDate}`);
            if(targetCb) {
                targetCb.checked = true;
                openBulkAttendanceChangeModal(); // Terus buka modal pukal untuk 1 orang
            }
        }

        // --- FUNGSI PENGECUALIAN (EXEMPTION) ---
        window.openExemptionModal = function(ic) {
            document.getElementById('exemption-ic').value = ic;
            document.getElementById('exemption-admin-verify').value = '';
            document.getElementById('exemption-modal').classList.remove('hidden');
        }

        window.submitExemption = async function() {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");
            
            const adminCode = document.getElementById('exemption-admin-verify').value;
            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) {
                return alert("Akses ditolak: Kod pengesahan salah.");
            }

            const ic = document.getElementById('exemption-ic').value;
            const reason = document.getElementById('exemption-reason').value;

            const updatedExemptions = { ...currentProgram.exemptions, [ic]: reason };
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);

            try {
                await updateDoc(programRef, { exemptions: updatedExemptions });
                currentProgram.exemptions = updatedExemptions;
                closeModal('exemption-modal');
                processDataForSelectedDate(); 
                alert("Status pengecualian berjaya direkodkan.");
            } catch (e) { alert("Ralat teknikal: " + e.message); }
        }

        window.promptRemoveExemption = async function(ic) {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");

            const adminCode = prompt("Tindakan Penyelaras:\nSila masukkan 4 digit terakhir No. IC anda untuk MEMBATALKAN pengecualian ini:");
            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) return alert("Akses ditolak: Kod pengesahan salah.");

            const updatedExemptions = { ...currentProgram.exemptions };
            delete updatedExemptions[ic]; 

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);

            try {
                await updateDoc(programRef, { exemptions: updatedExemptions });
                currentProgram.exemptions = updatedExemptions;
                processDataForSelectedDate(); 
            } catch (e) { alert("Ralat membatalkan status: " + e.message); }
        }

        // --- FUNGSI-FUNGSI LAIN DIKEKALKAN (ANALYTICS, SUGGESTIONS, TABLES DLL) ---
        function renderAnalytics(evaluations) {
            const container = document.getElementById('analytics-container');
            if (evaluations.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">Belum ada data penilaian untuk paparan ini.</div>`;
                return;
            }

            const sums = Array(18).fill(0);
            const counts = Array(18).fill(0);

            evaluations.forEach(ev => {
                if (ev.responses) {
                    for (let i = 1; i <= 18; i++) {
                        if (ev.responses[`q${i}`]) {
                            sums[i-1] += ev.responses[`q${i}`];
                            counts[i-1]++;
                        }
                    }
                }
            });

            let html = '';
            evaluationQuestions.forEach((q_text, index) => {
                let avg = 0;
                if (counts[index] > 0) avg = (sums[index] / counts[index]).toFixed(2);
                
                const percentage = (avg / 5) * 100;
                
                let barColor = 'bg-purple-500';
                if (avg >= 4.5) barColor = 'bg-green-500';
                else if (avg >= 3.5) barColor = 'bg-blue-500';
                else if (avg >= 2.5) barColor = 'bg-yellow-500';
                else barColor = 'bg-red-500';

                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700 truncate w-3/4" title="${q_text}">${index + 1}. ${q_text}</span>
                            <span class="text-sm font-bold text-gray-900">${avg} <span class="text-xs text-gray-500 font-normal">/ 5.0</span></span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                            <div class="${barColor} h-2.5 rounded-full progress-bar-fill shadow-sm" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderSuggestions(evaluations) {
            const container = document.getElementById('suggestions-container');
            const validSuggestions = evaluations.filter(ev => ev.suggestion && ev.suggestion.trim().length > 0);

            if (validSuggestions.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic text-sm p-4 bg-gray-50 rounded text-center">Tiada cadangan tambahan direkodkan untuk paparan ini.</p>`;
                return;
            }

            let html = '';
            validSuggestions.forEach(ev => {
                html += `
                    <div class="p-4 bg-yellow-50/70 border border-yellow-100 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-800 leading-relaxed italic">"${ev.suggestion}"</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderRespondentsTable(evaluations) {
            const tbody = document.getElementById('respondents-tbody');
            if (evaluations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500 bg-gray-50">Tiada responden direkodkan.</td></tr>`;
                return;
            }

            const duplicateCheck = {};
            evaluations.forEach(ev => {
                const key = `${ev.ic}_${ev.evalDate}`;
                duplicateCheck[key] = (duplicateCheck[key] || 0) + 1;
            });

            const sortedEvals = [...evaluations].sort((a, b) => new Date(b.time) - new Date(a.time));

            let html = '';
            sortedEvals.forEach((ev, index) => {
                const submitDate = new Date(ev.time).toLocaleString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' });
                
                let badgeHtml = '';
                if (selectedEvalDate === 'all' && ev.evalDate) {
                    badgeHtml = `<span class="block mt-1 text-[10px] bg-indigo-50 text-indigo-700 font-bold px-2 py-0.5 rounded w-max border border-indigo-100">Dinilai utk: ${formatShortDate(ev.evalDate)}</span>`;
                }

                const isDuplicate = duplicateCheck[`${ev.ic}_${ev.evalDate}`] > 1;
                const duplicateTag = isDuplicate ? `<span class="ml-2 bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">Pendua</span>` : '';
                const cbValue = `${ev.ic}|${ev.evalDate}`;

                let jawatanStesen = [];
                let jawatan = ev.jawatan || ev.position;
                let stesen = ev.stesen || ev.station;
                if (jawatan) jawatanStesen.push(jawatan);
                if (stesen) jawatanStesen.push(stesen);
                
                let subtitle = jawatanStesen.length > 0 ? `<div class="text-xs font-normal text-gray-500 mt-0.5">${jawatanStesen.join(' • ')}</div>` : '';

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap text-left no-print">
                            <input type="checkbox" class="bulk-cb rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" value="${cbValue}">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-bold text-gray-900 flex items-center flex-wrap gap-1">
                                ${(ev.name || 'Tiada Nama Diperoleh').toUpperCase()} ${duplicateTag}
                            </div>
                            ${subtitle}
                            ${badgeHtml}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs font-semibold text-gray-600">${submitDate}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center no-print">
                            <div class="flex justify-center gap-2">
                                <button onclick="openChangeDateModal('${ev.ic}', '${ev.evalDate}')" class="p-1.5 bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition-all" title="Ubah Tarikh Penilaian">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </button>
                                <button onclick="promptDeleteEvaluation('${ev.ic}', '${ev.evalDate}')" class="p-1.5 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition-all" title="Padam Rekod Ini">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        window.toggleAllCheckboxes = function(source) {
            const checkboxes = document.querySelectorAll('.bulk-cb');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        window.openBulkChangeModal = function() {
            const checkboxes = document.querySelectorAll('.bulk-cb:checked');
            if (checkboxes.length === 0) return alert("Sila tandakan sekurang-kurangnya satu rekod pada jadual terlebih dahulu.");

            document.getElementById('bulk-count-label').textContent = checkboxes.length;
            document.getElementById('bulk-admin-ic-verify').value = '';

            const select = document.getElementById('bulk-new-date-select');
            select.innerHTML = '';
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            
            for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                const dateStr = getLocalDateString(dt);
                const opt = document.createElement('option');
                opt.value = dateStr;
                opt.textContent = formatShortDate(dateStr);
                select.appendChild(opt);
            }
            document.getElementById('bulk-change-date-modal').classList.remove('hidden');
        }

        window.submitBulkChangeDate = async function() {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");
            const adminCode = document.getElementById('bulk-admin-ic-verify').value;
            const newDate = document.getElementById('bulk-new-date-select').value;
            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) return alert("Akses ditolak: Kod pengesahan salah.");

            const selectedValues = Array.from(document.querySelectorAll('.bulk-cb:checked')).map(cb => cb.value);
            const updatedEvaluations = currentProgram.evaluations.map(ev => {
                const key = `${ev.ic}|${ev.evalDate}`;
                if (selectedValues.includes(key)) return { ...ev, evalDate: newDate };
                return ev;
            });

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            try {
                await updateDoc(programRef, { evaluations: updatedEvaluations });
                currentProgram.evaluations = updatedEvaluations;
                closeModal('bulk-change-date-modal');
                selectedEvalDate = newDate; 
                renderDateTabs(); 
                alert(`Berjaya menukar tarikh borang penilaian untuk ${selectedValues.length} peserta secara pukal.`);
            } catch (e) { alert("Ralat teknikal: " + e.message); }
        }

        window.openChangeDateModal = function(ic, currentEvalDate) {
            document.getElementById('change-date-ic').value = ic;
            document.getElementById('change-date-old').value = currentEvalDate;
            document.getElementById('admin-ic-verify').value = '';

            const select = document.getElementById('new-date-select');
            select.innerHTML = '';
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            
            for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                const dateStr = getLocalDateString(dt);
                const opt = document.createElement('option');
                opt.value = dateStr;
                opt.textContent = formatShortDate(dateStr);
                if (dateStr === currentEvalDate) opt.selected = true;
                select.appendChild(opt);
            }
            document.getElementById('change-date-modal').classList.remove('hidden');
        }

        window.submitChangeDate = async function() {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");
            
            const ic = document.getElementById('change-date-ic').value;
            const oldDate = document.getElementById('change-date-old').value;
            const newDate = document.getElementById('new-date-select').value;
            const adminCode = document.getElementById('admin-ic-verify').value;

            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) return alert("Akses ditolak: Kod pengesahan salah.");
            if (oldDate === newDate) { closeModal('change-date-modal'); return; }

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            let hasUpdated = false;
            const updatedEvaluations = currentProgram.evaluations.map(ev => {
                if (!hasUpdated && ev.ic === ic && ev.evalDate === oldDate) {
                    hasUpdated = true;
                    return { ...ev, evalDate: newDate };
                }
                return ev;
            });

            try {
                await updateDoc(programRef, { evaluations: updatedEvaluations });
                currentProgram.evaluations = updatedEvaluations;
                closeModal('change-date-modal');
                selectedEvalDate = newDate; 
                renderDateTabs(); 
                alert("Berjaya menukar tarikh borang penilaian peserta tersebut.");
            } catch (e) { alert("Ralat teknikal: " + e.message); }
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        window.promptDeleteEvaluation = async function(participantIc, evalDate) {
            if (!currentProgram || !currentProgram.penyelaras_ic) return alert("Ralat: Maklumat penyelaras tidak ditemui.");
            const adminCode = prompt("Tindakan Penyelaras:\nSila masukkan 4 digit terakhir No. IC anda untuk MEMADAM rekod ini secara kekal:");
            if (adminCode !== currentProgram.penyelaras_ic.slice(-4)) return alert("Akses ditolak: Kod pengesahan tidak sepadan.");
            if(!confirm("Anda pasti ingin memadam penilaian ini? Tindakan ini tidak boleh diubah (kekal).")) return;
            
            let removed = false;
            const updatedEvaluations = currentProgram.evaluations.filter(ev => {
                if (!removed && ev.ic === participantIc && ev.evalDate === evalDate) {
                    removed = true;
                    return false;
                }
                return true;
            });

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            try {
                await updateDoc(programRef, { evaluations: updatedEvaluations });
                currentProgram.evaluations = updatedEvaluations;
                processDataForSelectedDate(); 
                alert("Rekod tersebut telah berjaya dipadam dari sistem.");
            } catch(e) { alert("Ralat memadam rekod: " + e.message); }
        }

        window.exportAnalysisToExcel = function() {
            if (!currentProgram) return;
            const allEvaluations = currentProgram.evaluations || [];
            let exportEvals = selectedEvalDate === 'all' ? allEvaluations : allEvaluations.filter(e => e.evalDate === selectedEvalDate);
            if (exportEvals.length === 0) return alert("Tiada data untuk dimuat turun.");

            const wb = XLSX.utils.book_new();
            const sums = Array(18).fill(0); const counts = Array(18).fill(0);
            exportEvals.forEach(ev => {
                if (ev.responses) {
                    for (let i = 1; i <= 18; i++) {
                        if (ev.responses[`q${i}`]) { sums[i-1] += ev.responses[`q${i}`]; counts[i-1]++; }
                    }
                }
            });

            const avgData = evaluationQuestions.map((q, i) => {
                let avg = counts[i] > 0 ? (sums[i] / counts[i]).toFixed(2) : 0;
                return { "No": i + 1, "Kriteria Penilaian": q, "Purata Skor (1-5)": parseFloat(avg) };
            });

            const wsAvg = XLSX.utils.json_to_sheet(avgData);
            XLSX.utils.book_append_sheet(wb, wsAvg, "Skor Purata");

            const validSuggestions = exportEvals.filter(ev => ev.suggestion && ev.suggestion.trim().length > 0);
            const suggestionData = validSuggestions.map((ev, i) => ({ "Bil": i + 1, "Nama Peserta": ev.name.toUpperCase(), "Cadangan / Komen": ev.suggestion }));
            const wsSugg = XLSX.utils.json_to_sheet(suggestionData.length > 0 ? suggestionData : [{"Notis": "Tiada cadangan diberikan."}]);
            XLSX.utils.book_append_sheet(wb, wsSugg, "Cadangan Penambahbaikan");

            const cleanProgramName = currentProgram.name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
            XLSX.writeFile(wb, `Analisis_Penilaian_${cleanProgramName}_${selectedEvalDate}.xlsx`);
        };

        window.exportAnalysisToPDF = function() {
            if (!currentProgram) return;
            const allEvaluations = currentProgram.evaluations || [];
            let exportEvals = selectedEvalDate === 'all' ? allEvaluations : allEvaluations.filter(e => e.evalDate === selectedEvalDate);
            let dateLabel = selectedEvalDate === 'all' ? "Keseluruhan Program" : formatShortDate(selectedEvalDate);
            if (exportEvals.length === 0) return alert("Tiada data untuk dimuat turun.");

            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const sums = Array(18).fill(0); const counts = Array(18).fill(0);
            exportEvals.forEach(ev => {
                if (ev.responses) {
                    for (let i = 1; i <= 18; i++) {
                        if (ev.responses[`q${i}`]) { sums[i-1] += ev.responses[`q${i}`]; counts[i-1]++; }
                    }
                }
            });

            const tableRows = evaluationQuestions.map((q, i) => {
                let avg = counts[i] > 0 ? (sums[i] / counts[i]).toFixed(2) : 0;
                return [i + 1, q, avg];
            });

            doc.setFontSize(14);
            const titleStr = doc.splitTextToSize(`Laporan Penilaian: ${currentProgram.name.toUpperCase()}`, 180);
            doc.text(titleStr, 14, 15);
            doc.setFontSize(10);
            const infoY = 15 + (titleStr.length * 6);
            doc.text(`Tarikh Dinilai: ${dateLabel} | Jumlah Responden: ${exportEvals.length}`, 14, infoY);

            doc.autoTable({
                startY: infoY + 6, head: [['No.', 'Kriteria Penilaian', 'Skor Purata (1-5)']], body: tableRows,
                headStyles: { fillColor: [147, 51, 234], halign: 'center' }, 
                columnStyles: { 0: { cellWidth: 10, halign: 'center' }, 2: { cellWidth: 35, halign: 'center', fontStyle: 'bold' } }, styles: { fontSize: 9 }
            });

            const finalY = doc.lastAutoTable.finalY || infoY + 6;
            const validSuggestions = exportEvals.filter(ev => ev.suggestion && ev.suggestion.trim().length > 0);
            if (validSuggestions.length > 0) {
                let suggStartY = finalY + 14;
                if (suggStartY > 260) { doc.addPage(); suggStartY = 20; } 
                else { doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("Rumusan Cadangan / Penambahbaikan:", 14, finalY + 10); }

                const suggRows = validSuggestions.map((ev, i) => [i + 1, ev.name.toUpperCase(), ev.suggestion]);
                doc.autoTable({
                    startY: suggStartY, head: [['Bil', 'Nama Peserta', 'Cadangan & Komen']], body: suggRows,
                    headStyles: { fillColor: [234, 179, 8], textColor: [0, 0, 0] }, 
                    columnStyles: { 0: { cellWidth: 10, halign: 'center' }, 1: { cellWidth: 50, fontStyle: 'bold' } }, styles: { fontSize: 8 }
                });
            }

            const cleanProgramName = currentProgram.name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
            const safeDateName = selectedEvalDate === 'all' ? 'Keseluruhan' : selectedEvalDate;
            doc.save(`Analisis_Penilaian_${cleanProgramName}_${safeDateName}.pdf`);
        };

    </script>
</body>
</html>
