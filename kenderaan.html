<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARKfleet ‚Äì Kalendar Tempahan Kenderaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn { transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* Gaya Kalendar */
        .calendar-day { min-height: 100px; display: flex; flex-direction: column; cursor: pointer; background-color: white; border: 1px solid #e5e7eb; }
        .calendar-day:hover { background-color: #fff1f2; border-color: #f43f5e; }
        .calendar-day.is-today { background-color: #dbeafe; border: 2px solid #2563eb; position: relative; }
        .calendar-day.is-today::after { content: 'HARI INI'; position: absolute; top: 4px; right: 4px; font-size: 0.5rem; background-color: #2563eb; color: white; padding: 1px 4px; border-radius: 2px; font-weight: 700; }
        .calendar-day.is-today .day-number { color: #1e40af; font-weight: 800; font-size: 1.1rem; }
        .calendar-day.selected { border: 2px solid #e11d48; background-color: #ffe4e6; }
        
        /* Tab & Modal */
        .tab-button { padding-bottom: 0.75rem; color: #6b7280; font-weight: 500; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-button:hover { color: #374151; border-color: #d1d5db; }
        .tab-button.active { color: #e11d48; border-color: #e11d48; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .table-container { max-height: 70vh; overflow-y: auto; }

        /* Flight Style Segments */
        .flight-segment { position: relative; padding-left: 1.8rem; padding-bottom: 1.5rem; border-left: 2px dashed #cbd5e1; margin-left: 0.5rem; }
        .flight-segment:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .flight-icon { position: absolute; left: -0.55rem; top: 0; width: 1.2rem; height: 1.2rem; border: 2px solid #e11d48; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; color: #e11d48; z-index: 10; }
        .flight-time { font-family: 'Courier Prime', monospace; font-weight: 700; color: #be123c; font-size: 0.75rem; background-color: #ffe4e6; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; letter-spacing: -0.5px; }
        .flight-loc { font-weight: 700; color: #1f2937; text-transform: uppercase; font-size: 0.85rem; line-height: 1.3; display: block; }
        
        .tab-nav-btn { padding: 8px 16px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid transparent; color: #9ca3af; margin-right: 4px; transition: 0.2s; background: none; }
        .tab-nav-btn:hover { color: #4b5563; background: #f9fafb; }
        .tab-nav-btn.active { color: #e11d48; border-bottom: 2px solid #e11d48; background: #fff1f2; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Emoji Rating */
        .emoji-btn { font-size: 1.5rem; filter: grayscale(100%); transition: all 0.2s; cursor: pointer; opacity: 0.5; }
        .emoji-btn:hover { transform: scale(1.2); opacity: 1; filter: grayscale(0%); }
        .emoji-wrapper.selected .emoji-btn { transform: scale(1.3); filter: grayscale(0%); opacity: 1; }
        .emoji-1.selected .emoji-btn { text-shadow: 0 0 10px rgba(239, 68, 68, 0.6); } 
        .emoji-2.selected .emoji-btn { text-shadow: 0 0 10px rgba(249, 115, 22, 0.6); } 
        .emoji-3.selected .emoji-btn { text-shadow: 0 0 10px rgba(234, 179, 8, 0.6); }  
        .emoji-4.selected .emoji-btn { text-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }  
        .emoji-5.selected .emoji-btn { text-shadow: 0 0 10px rgba(34, 197, 94, 0.6); } 
        
        .stat-card { transition: transform 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-3px); }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-rose-600 p-2 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a.75.75 0 01.75.75v.5a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-.5a.75.75 0 01.75-.75h1.05a2.5 2.5 0 014.9 0H19a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-rose-600">SPARKfleet</h1>
                    <p class="text-sm text-gray-500">Kalendar Tempahan Kenderaan Jabatan</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <a href="https://pahanmy.github.io/ppdmiri" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md text-sm hover:bg-gray-300">Halaman Utama</a>
                <a href="tempahkenderaan.html" class="btn bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-rose-700 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tempah Kenderaan
                </a>
                <button onclick="openAdminModal()" class="btn bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Admin
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 stat-card flex items-center gap-3">
                <div class="p-3 bg-blue-100 text-blue-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></div>
                <div><p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Keseluruhan</p><p id="stat-total" class="text-2xl font-bold text-gray-800">0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 stat-card flex items-center gap-3">
                <div class="p-3 bg-yellow-100 text-yellow-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div><p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Dalam Proses</p><p id="stat-pending" class="text-2xl font-bold text-gray-800">0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 stat-card flex items-center gap-3">
                <div class="p-3 bg-green-100 text-green-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div><p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Lulus</p><p id="stat-approved" class="text-2xl font-bold text-gray-800">0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 stat-card flex items-center gap-3">
                <div class="p-3 bg-red-100 text-red-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div><p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Gagal/Ditolak</p><p id="stat-rejected" class="text-2xl font-bold text-gray-800">0</p></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
                <div class="card p-6">
                    <div class="flex flex-wrap items-end gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Bulan</label>
                            <select id="month-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Tahun</label>
                            <select id="year-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Jenis Kenderaan</label>
                            <select id="vehicle-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm">
                                <option value="">SEMUA KENDERAAN</option>
                            </select>
                        </div>
                        <div class="flex-grow-[2]">
                            <label class="block text-sm font-medium text-gray-700">Carian</label>
                            <input type="text" id="search-input" placeholder="Cth: Lawatan Kerja..." class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm">
                        </div>
                    </div>

                    <div class="flex justify-center mb-6">
                        <div class="bg-gray-100 p-1.5 rounded-xl inline-flex shadow-inner border border-gray-200">
                            <button onclick="showTab('list')" id="tab-list" class="flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 bg-white text-rose-600 shadow-sm ring-1 ring-black/5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                Senarai Keseluruhan
                            </button>
                            <button onclick="showTab('calendar')" id="tab-calendar" class="flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-200/50 transition-all duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                Kalendar Bulanan
                            </button>
                        </div>
                    </div>

                    <div id="list-tab-content" class="tab-content">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tarikh</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Kenderaan & Pemandu</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Destinasi & Program</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status & Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="full-list-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p id="no-list-data" class="text-center text-gray-500 py-10 hidden">Tiada tempahan ditemui.</p>
                    </div>

                    <div id="calendar-tab-content" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&lt;</button>
                            <h2 id="calendar-header" class="text-xl font-bold text-gray-800 uppercase"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&gt;</button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-semibold text-sm text-gray-500 mb-2 uppercase tracking-wide">
                            <div>Ahad</div><div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div>Sabtu</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="card p-6 h-full sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 uppercase flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        Butiran: <span id="selected-date-text" class="text-rose-600">HARI INI</span>
                    </h3>
                    <div id="booking-list-content" class="space-y-4">
                        <p class="text-gray-400 italic text-sm text-center py-4">Sila pilih tarikh di kalendar.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 transform transition-all relative">
            <button onclick="closeItineraryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-xl font-bold text-gray-900 mb-2 border-b pb-3 uppercase flex items-center gap-2">
                üìã Jadual Pergerakan
            </h3>
            <div class="mb-4 bg-gray-50 p-3 rounded-lg text-sm border border-gray-100">
                <p class="font-bold text-gray-800 uppercase" id="modal-program-name"></p>
                <div class="flex justify-between mt-2 text-gray-600">
                    <span id="modal-driver-info"></span>
                    <span id="modal-vehicle-info" class="font-semibold text-rose-600"></span>
                </div>
            </div>
            <div class="max-h-[60vh] overflow-y-auto pr-2" id="modal-timeline-content"></div>
            <div class="mt-6 text-right">
                <button onclick="closeItineraryModal()" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg text-sm hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Kongsi Tempahan</h3>
            <div class="space-y-3">
                <button onclick="shareToTelegram()" class="w-full btn bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635.099-.002.321.023.465.141.119.098.152.228.166.319.014.094.03.373.015.539z"/></svg>
                    Penyelaras (+60 19-489 3021)
                </button>
                <button onclick="shareToWhatsapp()" class="w-full btn bg-green-500 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-green-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.894-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Kongsi ke WhatsApp
                </button>
            </div>
            <button onclick="closeShareModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700 underline">Batal</button>
        </div>
    </div>

    <div id="rating-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-1 text-center">Penilaian Perkhidmatan</h3>
            <div id="rating-info" class="bg-indigo-50 p-2 rounded-lg mb-4 text-xs text-indigo-800 border border-indigo-100 mt-2 text-center uppercase font-bold">
                <p id="rating-driver-name"></p>
            </div>
            
            <div class="space-y-4 mb-4">
                <div>
                    <p class="text-xs font-bold text-gray-700 mb-1">1. Cara Pemanduan</p>
                    <div class="flex justify-between px-2 bg-gray-50 rounded py-2 border border-gray-100">
                        <div class="text-center emoji-wrapper emoji-1" id="btn-driving-1" onclick="selectRating('driving', 1)"><div class="emoji-btn">üò°</div></div>
                        <div class="text-center emoji-wrapper emoji-2" id="btn-driving-2" onclick="selectRating('driving', 2)"><div class="emoji-btn">‚òπÔ∏è</div></div>
                        <div class="text-center emoji-wrapper emoji-3" id="btn-driving-3" onclick="selectRating('driving', 3)"><div class="emoji-btn">üòê</div></div>
                        <div class="text-center emoji-wrapper emoji-4" id="btn-driving-4" onclick="selectRating('driving', 4)"><div class="emoji-btn">üôÇ</div></div>
                        <div class="text-center emoji-wrapper emoji-5" id="btn-driving-5" onclick="selectRating('driving', 5)"><div class="emoji-btn">ü§©</div></div>
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-700 mb-1">2. Ketepatan Masa</p>
                    <div class="flex justify-between px-2 bg-gray-50 rounded py-2 border border-gray-100">
                        <div class="text-center emoji-wrapper emoji-1" id="btn-punctuality-1" onclick="selectRating('punctuality', 1)"><div class="emoji-btn">üò°</div></div>
                        <div class="text-center emoji-wrapper emoji-2" id="btn-punctuality-2" onclick="selectRating('punctuality', 2)"><div class="emoji-btn">‚òπÔ∏è</div></div>
                        <div class="text-center emoji-wrapper emoji-3" id="btn-punctuality-3" onclick="selectRating('punctuality', 3)"><div class="emoji-btn">üòê</div></div>
                        <div class="text-center emoji-wrapper emoji-4" id="btn-punctuality-4" onclick="selectRating('punctuality', 4)"><div class="emoji-btn">üôÇ</div></div>
                        <div class="text-center emoji-wrapper emoji-5" id="btn-punctuality-5" onclick="selectRating('punctuality', 5)"><div class="emoji-btn">ü§©</div></div>
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-700 mb-1">3. Layanan / Sikap</p>
                    <div class="flex justify-between px-2 bg-gray-50 rounded py-2 border border-gray-100">
                        <div class="text-center emoji-wrapper emoji-1" id="btn-service-1" onclick="selectRating('service', 1)"><div class="emoji-btn">üò°</div></div>
                        <div class="text-center emoji-wrapper emoji-2" id="btn-service-2" onclick="selectRating('service', 2)"><div class="emoji-btn">‚òπÔ∏è</div></div>
                        <div class="text-center emoji-wrapper emoji-3" id="btn-service-3" onclick="selectRating('service', 3)"><div class="emoji-btn">üòê</div></div>
                        <div class="text-center emoji-wrapper emoji-4" id="btn-service-4" onclick="selectRating('service', 4)"><div class="emoji-btn">üôÇ</div></div>
                        <div class="text-center emoji-wrapper emoji-5" id="btn-service-5" onclick="selectRating('service', 5)"><div class="emoji-btn">ü§©</div></div>
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-700 mb-1">4. Secara Keseluruhan</p>
                    <div class="flex justify-between px-2 bg-rose-50 rounded py-2 border border-rose-100">
                        <div class="text-center emoji-wrapper emoji-1" id="btn-overall-1" onclick="selectRating('overall', 1)"><div class="emoji-btn">üò°</div></div>
                        <div class="text-center emoji-wrapper emoji-2" id="btn-overall-2" onclick="selectRating('overall', 2)"><div class="emoji-btn">‚òπÔ∏è</div></div>
                        <div class="text-center emoji-wrapper emoji-3" id="btn-overall-3" onclick="selectRating('overall', 3)"><div class="emoji-btn">üòê</div></div>
                        <div class="text-center emoji-wrapper emoji-4" id="btn-overall-4" onclick="selectRating('overall', 4)"><div class="emoji-btn">üôÇ</div></div>
                        <div class="text-center emoji-wrapper emoji-5" id="btn-overall-5" onclick="selectRating('overall', 5)"><div class="emoji-btn">ü§©</div></div>
                    </div>
                </div>
            </div>

            <textarea id="rating-comment" rows="2" class="w-full border border-gray-300 rounded p-2 text-sm mb-4" placeholder="Komen tambahan (pilihan)..."></textarea>
            <div class="text-left bg-gray-50 p-3 rounded border mb-4">
                <label class="block text-xs font-bold text-gray-700 mb-1">Pengesahan Identiti (Wajib)</label>
                <input type="text" id="rating-verify-ic" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="Masukkan No. IC Pemohon">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeRatingModal()" class="btn bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm">Batal</button>
                <button onclick="submitRating()" class="btn bg-indigo-600 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-700 shadow-md">Hantar</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform transition-all">
            <div class="text-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Akses Admin</h3>
                <p class="text-sm text-gray-500">Sila masukkan kata laluan keselamatan.</p>
            </div>
            <input type="password" id="admin-password" placeholder="Kata Laluan" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 focus:ring-rose-500 focus:border-rose-500">
            <div class="flex justify-end gap-2">
                <button onclick="closeAdminModal()" class="btn bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm hover:bg-gray-300">Batal</button>
                <button onclick="checkAdminPassword()" class="btn bg-gray-800 text-white px-4 py-2 rounded-md text-sm hover:bg-gray-900">Masuk</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let allBookings = [];
        let activeTab = 'list';
        let selectedDateEl = null;
        let currentRatingBookingId = null;
        let currentRatingBookerIc = null;
        
        let ratingValues = { driving: 0, punctuality: 0, service: 0, overall: 0 };
        let shareDetails = { program: '', date: '', status: '' };

        const vehicleDetails = {
            "Toyota Hilux (QAA 1234)": { short: "HILUX" },
            "Van Toyota Hiace (QAB 5678)": { short: "VAN" },
            "Bas Mini (QAC 9012)": { short: "BAS" }
        };

        onAuthStateChanged(auth, async (user) => { if (user) main(); else signInAnonymously(auth); });

        function main() { populateFilters(); setupEventListeners(); listenForData(); }

        function populateFilters() {
            const today = new Date();
            const monthSelect = document.getElementById('month-select');
            const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}" ${i === today.getMonth() ? 'selected' : ''}>${m}</option>`).join('');
            monthSelect.value = today.getMonth();

            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = `<option value="${today.getFullYear()}" selected>${today.getFullYear()}</option><option value="${today.getFullYear()+1}">${today.getFullYear()+1}</option>`;
            yearSelect.value = today.getFullYear();

            const vehicleSelect = document.getElementById('vehicle-select');
            vehicleSelect.innerHTML = '<option value="">SEMUA KENDERAAN</option>';
            ["Toyota Hilux (QAA 1234)", "Van Toyota Hiace (QAB 5678)", "Bas Mini (QAC 9012)"].forEach(v => {
                 vehicleSelect.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        function setupEventListeners() {
            document.getElementById('month-select').addEventListener('change', updateView);
            document.getElementById('year-select').addEventListener('change', updateView);
            document.getElementById('vehicle-select').addEventListener('change', updateView);
            document.getElementById('search-input').addEventListener('input', updateView);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
        }

        function listenForData() {
            const q = query(collection(db, `artifacts/${appId}/public/data/spark_vehicle_bookings`), orderBy("start", "asc"));
            onSnapshot(q, (snapshot) => {
                allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
                calculatePublicStats(); 
            });
        }

        function calculatePublicStats() {
            const total = allBookings.length;
            const approved = allBookings.filter(b => b.status === 'DILULUSKAN').length;
            const rejected = allBookings.filter(b => b.status === 'DITOLAK').length;
            const pending = total - approved - rejected;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-rejected').textContent = rejected;
            document.getElementById('stat-pending').textContent = pending;
        }

        window.showTab = (tab) => {
            activeTab = tab;
            document.getElementById('calendar-tab-content').classList.toggle('hidden', tab !== 'calendar');
            document.getElementById('list-tab-content').classList.toggle('hidden', tab !== 'list');
            
            const btnCal = document.getElementById('tab-calendar');
            const btnList = document.getElementById('tab-list');
            
            const activeClasses = "bg-white text-rose-600 shadow-sm ring-1 ring-black/5 font-semibold";
            const inactiveClasses = "text-gray-500 hover:text-gray-700 hover:bg-gray-200/50 font-medium";
            
            if (tab === 'calendar') {
                btnCal.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${activeClasses}`;
                btnList.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${inactiveClasses}`;
            } else {
                btnCal.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${inactiveClasses}`;
                btnList.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${activeClasses}`;
            }
            updateView();
        }

        function updateView() {
            if (activeTab === 'calendar') renderCalendar();
            else renderList();
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('year-select').value) || new Date().getFullYear();
            const month = parseInt(document.getElementById('month-select').value) || new Date().getMonth();
            const months = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            document.getElementById('calendar-header').textContent = `${months[month]} ${year}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();

            for(let i=0; i<firstDayIndex; i++) grid.innerHTML += '<div class="bg-gray-50 border rounded-md min-h-[100px]"></div>';

            for(let day=1; day<=daysInMonth; day++) {
                const date = new Date(year, month, day);
                const events = getBookingsForDate(date);
                const isToday = new Date().toDateString() === date.toDateString();
                
                const eventsHtml = events.map(e => {
                    let displayLabel = vehicleDetails[e.vehicle] ? vehicleDetails[e.vehicle].short : e.vehicle.substring(0, 10);
                    let badgeClass = "bg-rose-100 text-rose-800 border-rose-200";
                    if (e.vehicle === "Menunggu Tetapan Admin") {
                        displayLabel = (e.programName || "MOHON").substring(0, 15);
                        badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-200"; 
                    } 
                    return `<div class="${badgeClass} text-[10px] font-bold px-1 rounded truncate mt-1 border" title="${e.vehicle}: ${e.destination}">${displayLabel}</div>`;
                }).join('');

                const dayDivId = `day-div-${day}`;
                grid.innerHTML += `
                    <div id="${dayDivId}" class="calendar-day border rounded-md p-2 transition hover:shadow-md ${isToday ? 'is-today' : 'bg-white'}" onclick="showDayDetails('${date.toISOString()}', '${dayDivId}')">
                        <div class="flex justify-between items-start">
                            <span class="day-number text-gray-700 text-sm">${day}</span>
                            ${events.length > 0 ? `<span class="bg-rose-500 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center shadow-sm">${events.length}</span>` : ''}
                        </div>
                        <div class="mt-1 overflow-y-auto max-h-[60px] space-y-1">${eventsHtml}</div>
                    </div>`;
            }
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth()) {
                setTimeout(() => {
                    const el = document.getElementById(`day-div-${today.getDate()}`);
                    if (el && !selectedDateEl) showDayDetails(today.toISOString(), el.id);
                }, 50);
            }
        }

        function getBookingsForDate(date) {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            return allBookings.filter(b => {
                if (!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
                const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const startDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                const endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());
                return checkDate >= startDate && checkDate <= endDate && (!filterVehicle || b.vehicle === filterVehicle) && ((b.programName || '').toLowerCase().includes(search));
            });
        }

        window.showDayDetails = (dateStr, elementId) => {
            const date = new Date(dateStr);
            const bookings = getBookingsForDate(date);
            const listContainer = document.getElementById('booking-list-content');
            
            if(selectedDateEl && document.body.contains(selectedDateEl)) selectedDateEl.classList.remove('selected');
            const el = document.getElementById(elementId);
            if(el) { el.classList.add('selected'); selectedDateEl = el; }

            document.getElementById('selected-date-text').textContent = date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            if(!bookings.length) {
                listContainer.innerHTML = '<div class="text-center py-8 border-2 border-dashed border-gray-200 rounded-lg"><p class="text-gray-500 font-medium text-sm">Tiada tempahan pada tarikh ini.</p></div>';
                return;
            }

            listContainer.innerHTML = bookings.map(b => {
                let vehicleDisplay = b.vehicle === "Menunggu Tetapan Admin" ? "MENUNGGU KEPUTUSAN" : b.vehicle;
                let statusColor = b.vehicle === "Menunggu Tetapan Admin" ? "text-yellow-600 border-yellow-500" : "text-rose-600 border-rose-500";
                let driverText = (b.status === 'DILULUSKAN' && b.driverName) ? b.driverName : '-';

                return `
                <div class="bg-white border-l-4 ${statusColor} p-4 rounded shadow-sm hover:shadow-md transition">
                    <div>
                        <p class="font-bold text-sm uppercase ${statusColor.replace('border-', '')}">${vehicleDisplay}</p>
                        <p class="font-semibold text-gray-800 leading-tight mt-1 text-sm">${b.programName}</p>
                    </div>
                    <div class="mt-3 text-xs text-gray-600 space-y-2 bg-gray-50 p-2 rounded border border-gray-100">
                        <button onclick="openItineraryModal('${b.id}')" class="w-full text-left text-rose-600 font-bold text-[10px] uppercase hover:underline flex items-center gap-1 mb-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            Lihat Jadual Penuh
                        </button>
                        <div class="flex justify-between">
                            <span><strong class="text-gray-400 text-[10px] uppercase">Masa:</strong> ${formatTime(b.start)} - ${formatTime(b.end)}</span>
                            <span><strong class="text-gray-400 text-[10px] uppercase">Pax:</strong> ${b.passengers || '-'}</span>
                        </div>
                        <div><strong class="text-gray-400 text-[10px] uppercase">Pemohon:</strong> ${b.bookedBy_name}</div>
                        <div class="pt-2 mt-2 border-t border-gray-200"><strong class="text-gray-500 text-[10px] uppercase">Pemandu:</strong> <span class="font-bold text-gray-800">${driverText}</span></div>
                    </div>
                </div>`;
            }).join('');
        };

        function renderList() {
            const tbody = document.getElementById('full-list-table-body');
            const noData = document.getElementById('no-list-data');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            const yearFilter = parseInt(document.getElementById('year-select').value);
            const monthFilter = parseInt(document.getElementById('month-select').value);

            const filtered = allBookings.filter(b => {
                if(!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                return start.getFullYear() === yearFilter && 
                       start.getMonth() === monthFilter &&
                       (!filterVehicle || b.vehicle === filterVehicle) &&
                       ((b.programName || '').toLowerCase().includes(search));
            }).sort((a,b) => (b.start.toDate ? b.start.toDate() : new Date(b.start)) - (a.start.toDate ? a.start.toDate() : new Date(a.start)));

            tbody.innerHTML = '';
            if (filtered.length === 0) { noData.classList.remove('hidden'); return; }
            noData.classList.add('hidden');

            filtered.forEach(b => {
                 const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                 const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
                 
                 let vehicleText = `<span class="font-bold text-rose-600 text-xs">${b.vehicle}</span>`;
                 let driverInfo = '<span class="text-gray-400 italic text-[10px]">Belum ditetapkan</span>';
                 let statusBadge = `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-[10px] font-bold uppercase">DITERIMA</span>`;
                 
                 let rowClass = "hover:bg-gray-50 border-b last:border-0";
                 if (b.status === 'DILULUSKAN') {
                     rowClass = "bg-green-50 hover:bg-green-100 border-b last:border-0 border-l-4 border-l-green-500";
                 }
                 
                 if (b.vehicle === "Menunggu Tetapan Admin") {
                     statusBadge = `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-[10px] font-bold uppercase">MENUNGGU KEPUTUSAN</span>`;
                     vehicleText = '<span class="text-gray-500 italic text-xs">Belum ditetapkan</span>';
                     driverInfo = '<span class="text-gray-400 italic text-[10px]">-</span>';
                 } else if (b.driverName && b.status === 'DILULUSKAN') {
                     driverInfo = `<div class="text-gray-800 text-xs font-semibold mt-1 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> ${b.driverName}</div>`;
                 }

                 let actionButtons = `<div class="flex gap-2 mt-1 flex-wrap">`;

                 actionButtons += `
                    <button onclick="openShareModal('${b.programName}', '${start.toLocaleDateString()}', '${b.status}')" class="text-white bg-blue-500 hover:bg-blue-600 text-xs flex items-center gap-1 px-3 py-1 rounded shadow-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> Kongsi
                    </button>
                 `;

                 if (b.status === 'DILULUSKAN') {
                     let hasRated = b.rating || b.ratingOverall;
                     let ratingButton = hasRated ? 
                        `<span class="text-[10px] bg-white text-green-600 px-2 py-1 rounded border border-green-200 cursor-default font-bold shadow-sm flex items-center gap-1">‚úÖ Dinilai</span>` :
                        `<button onclick="openRatingModal('${b.id}', '${b.driverName || 'Pemandu'}', '${b.bookedBy_ic}')" class="text-white bg-indigo-500 hover:bg-indigo-600 text-xs flex items-center gap-1 px-3 py-1 rounded shadow-sm">Nilai</button>`;
                     
                     actionButtons += `
                        <button onclick="downloadBookingPDF('${b.id}')" class="text-white bg-rose-600 hover:bg-rose-700 text-xs flex items-center gap-1 px-3 py-1 rounded shadow-sm">PDF</button>
                        ${ratingButton}
                     `;
                 }
                 actionButtons += `</div>`;

                 const startDateStr = start.toLocaleDateString('ms-MY', {day:'2-digit', month:'2-digit'});
                 const endDateStr = end.toLocaleDateString('ms-MY', {day:'2-digit', month:'2-digit'});
                 const isMultiDay = startDateStr !== endDateStr;

                 let dateDisplay = "";
                 if (isMultiDay) {
                    dateDisplay = `<div class="font-bold text-indigo-700 text-sm">${startDateStr} - ${endDateStr}</div>
                                   <div class="text-[10px] text-gray-500">${formatTime(start)}</div>`;
                 } else {
                    dateDisplay = `<div class="font-medium text-gray-900 text-sm">${startDateStr}</div>
                                   <div class="text-xs text-gray-500">${formatTime(start)} - ${formatTime(end)}</div>`;
                 }

                 tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-3 text-sm text-gray-900 font-medium">${dateDisplay}</td>
                        <td class="p-3 text-sm uppercase">${vehicleText}${driverInfo}</td>
                        <td class="p-3 text-sm text-gray-700">
                            <div class="text-[10px] mt-1 text-gray-900 font-semibold uppercase mb-1">${b.programName}</div>
                            <div class="text-[10px] text-gray-500 italic mb-2">Oleh: ${b.bookedBy_name}</div>
                            <button onclick="openItineraryModal('${b.id}')" class="text-gray-600 hover:text-gray-800 text-xs flex items-center gap-1 border border-gray-300 bg-white px-2 py-1 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Jadual</button>
                        </td>
                        <td class="p-3 text-sm space-y-2"><div>${statusBadge}</div>${actionButtons}</td>
                    </tr>`;
            });
        }

        // --- SHARE & RATING LOGIC ---
        window.openShareModal = (program, date, status) => {
            shareDetails = { program, date, status };
            document.getElementById('share-modal').classList.remove('hidden');
        };
        window.closeShareModal = () => document.getElementById('share-modal').classList.add('hidden');
        window.shareToTelegram = () => { window.open(`https://t.me/+60194893021?text=${encodeURIComponent(`Salam Tuan Penyelaras,\n\nMohon semakan untuk tempahan:\nProgram: ${shareDetails.program}\nTarikh: ${shareDetails.date}\nStatus: ${shareDetails.status}\n\nTerima kasih.`)}`, '_blank'); closeShareModal(); };
        window.shareToWhatsapp = () => { window.open(`https://wa.me/?text=${encodeURIComponent(`Salam,\n\nBerikut adalah butiran tempahan kenderaan SPARKfleet:\n\nProgram: *${shareDetails.program}*\nTarikh: *${shareDetails.date}*\nStatus: *${shareDetails.status}*\n\nSila semak di sistem. Terima kasih.`)}`, '_blank'); closeShareModal(); };

        window.openRatingModal = (bookingId, driverName, bookerIc) => {
            currentRatingBookingId = bookingId; currentRatingBookerIc = bookerIc;
            ratingValues = { driving: 0, punctuality: 0, service: 0, overall: 0 };
            document.getElementById('rating-driver-name').textContent = driverName;
            document.getElementById('rating-verify-ic').value = '';
            document.getElementById('rating-comment').value = '';
            document.querySelectorAll('.emoji-wrapper').forEach(el => el.classList.remove('selected'));
            document.getElementById('rating-modal').classList.remove('hidden');
        };
        window.closeRatingModal = () => document.getElementById('rating-modal').classList.add('hidden');
        window.selectRating = (category, val) => {
            ratingValues[category] = val;
            const rowBtns = document.querySelectorAll(`[id^="btn-${category}-"]`);
            rowBtns.forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`btn-${category}-${val}`).classList.add('selected');
        };
        window.submitRating = async () => {
            if (ratingValues.driving === 0 || ratingValues.punctuality === 0 || ratingValues.service === 0 || ratingValues.overall === 0) { alert("Sila lengkapkan semua 4 kategori penilaian."); return; }
            if (document.getElementById('rating-verify-ic').value.trim() !== currentRatingBookerIc) { alert("Nombor IC tidak sepadan dengan pemohon asal."); return; }
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_vehicle_bookings`, currentRatingBookingId), {
                    ratingDriving: ratingValues.driving, ratingPunctuality: ratingValues.punctuality, ratingService: ratingValues.service, ratingOverall: ratingValues.overall, rating: ratingValues.overall, ratingComment: document.getElementById('rating-comment').value, ratedAt: serverTimestamp()
                });
                alert("TERIMA KASIH!"); closeRatingModal();
            } catch (error) { console.error("Error:", error); alert("Gagal menghantar penilaian."); }
        };

        // --- PDF GENERATOR WITH QR STUB ---
        window.downloadBookingPDF = (id) => {
            const b = allBookings.find(x => x.id === id);
            if(!b) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // --- DRAW STUB LINE (VERTICAL) ---
            doc.setLineWidth(0.5); doc.setLineDash([3, 3], 0); doc.setDrawColor(150, 150, 150);
            doc.line(145, 10, 145, 200); doc.setLineDash([]); // Reset dash

            // --- LEFT SIDE (MAIN) ---
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("PEJABAT PENDIDIKAN DAERAH MIRI", 20, 20);
            doc.setFontSize(10); doc.text("TIKET TEMPAHAN KENDERAAN", 20, 26);
            
            const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
            const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
            
            // MAIN INFO TABLE
            doc.autoTable({
                startY: 35, margin: { right: 75 }, theme: 'plain',
                body: [
                    ["PEMOHON", b.bookedBy_name],
                    ["PROGRAM", b.programName],
                    ["TARIKH", `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`],
                    ["PENUMPANG", b.passengers],
                    ["KENDERAAN", b.vehicle],
                    ["PEMANDU", b.driverName]
                ],
                styles: { fontSize: 9, cellPadding: 1 }
            });

            // ITINERARY
            let currentY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold"); doc.text("JADUAL PERGERAKAN", 20, currentY);
            currentY += 8;

            const s = new Date(start); s.setHours(0,0,0,0);
            const e = new Date(end); e.setHours(0,0,0,0);
            const diffTime = Math.abs(e - s);
            const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            const destText = b.destination || "";
            let dayContentMap = {};
            if (destText.includes('[Hari')) {
                const blocks = destText.split(/(?=\[.*\]:)/g);
                blocks.forEach(block => {
                    const match = block.match(/^\[Hari\s+(\d+).*?\]:/i);
                    if (match) { dayContentMap[parseInt(match[1]) - 1] = block.replace(/^\[.*?\]:\s*/, '').trim(); }
                });
            } else { dayContentMap[0] = destText; }

            let lines = [];
            for (let i = 0; i < dayCount; i++) {
                let d = new Date(s); d.setDate(s.getDate() + i);
                lines.push(`[HARI ${i+1} - ${d.toLocaleDateString()}]:`);
                if (dayContentMap[i] && dayContentMap[i].length > 5) lines = lines.concat(dayContentMap[i].split('\n'));
                else lines.push("- Tiada pergerakan khusus.");
                lines.push("");
            }

            // Draw Lines
            doc.setFontSize(9);
            const lineX = 25; const contentX = 32; 
            lines.forEach((rawLine, i) => {
                const line = rawLine.trim(); if(!line) return;
                if (currentY > 270) { doc.addPage(); currentY = 20; doc.line(145, 10, 145, 200); } // Redraw stub line on new page

                if (line.startsWith('[')) {
                    doc.setFillColor(240, 240, 240); doc.roundedRect(20, currentY-4, 115, 7, 1, 1, 'FD');
                    doc.setFont("helvetica", "bold"); doc.text(line.replace(/[\[\]:]/g, ''), 22, currentY+1);
                    currentY += 12; return;
                }

                let timeStr = "", locStr = line;
                const timeMatch = line.match(/(?:-\s*)?(\d{1,2}:\d{2})\s+(.*)/);
                if (timeMatch) { timeStr = timeMatch[1]; locStr = timeMatch[2]; } else { locStr = line.replace(/^- /, ''); }

                if(timeStr) { doc.setFont("courier", "bold"); doc.setTextColor(190, 18, 60); doc.text(timeStr, 20, currentY); }
                
                doc.setDrawColor(180); doc.setLineDash([1, 1], 0); doc.line(lineX, currentY + 2, lineX, currentY + 10); doc.setLineDash([]);
                doc.setFillColor(255); doc.setDrawColor(225, 29, 72); doc.circle(lineX, currentY - 1, 1.5, 'FD'); 

                doc.setFont("helvetica", "normal"); doc.setTextColor(0);
                const splitLoc = doc.splitTextToSize(locStr, 95);
                doc.text(splitLoc, contentX, currentY);
                currentY += (splitLoc.length * 5) + 6; 
            });

            // --- RIGHT SIDE (STUB) ---
            doc.setFillColor(240, 240, 240);
            doc.rect(145, 0, 65, 297, 'F'); // Grey background for stub
            
            doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(50);
            doc.text("PAS", 155, 30); doc.text("KENDERAAN", 155, 36);
            
            // Generate QR Code
            const qrDiv = document.createElement('div');
            new QRCode(qrDiv, { text: `https://pahanmy.github.io/spark/kenderaan.html?id=${b.id}`, width: 150, height: 150 });
            const qrImage = qrDiv.querySelector('canvas').toDataURL("image/png");
            
            doc.addImage(qrImage, 'PNG', 153, 50, 45, 45);
            doc.setFontSize(8); doc.text("IMBAS UNTUK RUJUKAN", 175, 100, null, null, "center");

            doc.setFontSize(12); doc.setTextColor(0, 150, 0); doc.text("DILULUSKAN", 155, 120);
            doc.setFontSize(9); doc.setTextColor(0);
            doc.text("Tarikh Mula:", 155, 135); doc.setFont("courier", "bold"); doc.text(start.toLocaleDateString(), 155, 140);
            doc.setFont("helvetica", "normal"); doc.text("Masa:", 155, 145); doc.setFont("courier", "bold"); doc.text(formatTime(start), 155, 150);

            doc.save(`Tiket_${b.programName.substring(0,10)}.pdf`);
        };

        // --- ITINERARY MODAL PARSER (WEB) ---
        window.openItineraryModal = (id) => {
            const b = allBookings.find(x => x.id === id); if(!b) return;
            document.getElementById('itinerary-modal').classList.remove('hidden');
            document.getElementById('modal-program-name').textContent = b.programName;
            
            let driverText = (b.status === 'DILULUSKAN' && b.driverName) ? b.driverName : '-';
            document.getElementById('modal-driver-info').textContent = `Pemandu: ${driverText}`;
            
            const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
            const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
            const s = new Date(start); s.setHours(0,0,0,0);
            const e = new Date(end); e.setHours(0,0,0,0);
            const diffTime = Math.abs(e - s);
            const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            const durationHtml = `<span class="ml-2 bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded border border-indigo-200 font-bold">${dayCount} Hari</span>`;
            document.getElementById('modal-vehicle-info').innerHTML = `${b.vehicle} ${durationHtml}`;
            
            renderItineraryWithTabs(b.destination, 'modal-timeline-content', start, dayCount);
        };

        function renderItineraryWithTabs(destinationText, containerId, startDateObj, totalDays) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            const destText = destinationText || "";
            let dayContentMap = {};
            if (destText.includes('[Hari')) {
                const blocks = destText.split(/(?=\[.*\]:)/g);
                blocks.forEach(block => {
                    const match = block.match(/^\[Hari\s+(\d+).*?\]:/i);
                    if (match) { const dayIndex = parseInt(match[1]) - 1; dayContentMap[dayIndex] = block.replace(/^\[.*?\]:\s*/, '').trim(); }
                });
            } else { dayContentMap[0] = destText; }

            if (totalDays <= 1) { container.innerHTML = renderTimelineHTML(dayContentMap[0] || destText); } 
            else {
                let tabsHtml = '<div class="flex overflow-x-auto border-b border-gray-200 mb-4 no-scrollbar pb-1 gap-1">';
                let contentHtml = '';
                for (let i = 0; i < totalDays; i++) {
                    let currentDate = new Date(startDateObj); currentDate.setDate(startDateObj.getDate() + i);
                    let dateLabel = currentDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short' });
                    const isActive = i === 0; const hasContent = dayContentMap[i] && dayContentMap[i].length > 5;
                    tabsHtml += `<button onclick="switchItineraryTab('${containerId}', ${i})" class="tab-nav-btn ${isActive ? 'active' : ''} ${!hasContent ? 'opacity-60' : ''}" id="btn-${containerId}-${i}">HARI ${i + 1} <span class="text-[9px] block font-normal text-gray-400">${dateLabel}</span></button>`;
                    let contentBody = hasContent ? renderTimelineHTML(dayContentMap[i]) : `<div class="text-center py-6 text-gray-400 border border-dashed border-gray-200 rounded bg-gray-50 text-xs">Tiada pergerakan khusus.</div>`;
                    contentHtml += `<div id="content-${containerId}-${i}" class="${isActive ? '' : 'hidden'} animate-fade-in py-2">${contentBody}</div>`;
                }
                tabsHtml += '</div>'; container.innerHTML = tabsHtml + contentHtml;
            }
        }

        function renderTimelineHTML(text) {
            let html = '';
            const carIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a.75.75 0 01.75.75v.5a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-.5a.75.75 0 01.75-.75h1.05a2.5 2.5 0 014.9 0H19a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" /></svg>`;
            text.split('\n').forEach(line => {
                line = line.trim();
                if(!line || (line.startsWith('[') && line.endsWith(']:'))) return;
                const timeMatch = line.match(/(?:-\s*)?(\d{1,2}:\d{2})\s+(.*)/);
                let time = "", loc = line.replace(/^- /, '');
                if (timeMatch) { time = timeMatch[1]; loc = timeMatch[2]; }
                html += `<div class="flight-segment"><div class="flight-icon bg-white text-rose-600 shadow-sm">${carIconSvg}</div>${time ? `<span class="flight-time">${time}</span>` : ''}<span class="flight-loc">${loc}</span></div>`;
            });
            return html;
        }

        window.switchItineraryTab = (containerId, index) => {
            const container = document.getElementById(containerId);
            if(!container) return;
            const btns = container.querySelectorAll('button.tab-nav-btn');
            btns.forEach((btn, i) => { if(i === index) btn.classList.add('active'); else btn.classList.remove('active'); });
            const contents = container.querySelectorAll(`div[id^="content-${containerId}-"]`);
            contents.forEach((div, i) => { if(i === index) div.classList.remove('hidden'); else div.classList.add('hidden'); });
        };

        window.closeItineraryModal = () => document.getElementById('itinerary-modal').classList.add('hidden');

        // --- ADMIN LOGIN ---
        window.openAdminModal = () => document.getElementById('admin-login-modal').classList.remove('hidden');
        window.closeAdminModal = () => document.getElementById('admin-login-modal').classList.add('hidden');
        window.checkAdminPassword = () => {
            if (document.getElementById('admin-password').value === '123') window.location.href = 'https://pahanmy.github.io/spark/admintempahankenderaan';
            else alert('Kata laluan salah!');
        };

        function formatTime(t) { 
            if (!t) return "";
            const date = t.toDate ? t.toDate() : new Date(t);
            return date.toLocaleTimeString('ms-MY', {hour: '2-digit', minute:'2-digit'}); 
        }
        function changeMonth(dir) {
            const m = document.getElementById('month-select');
            let idx = m.selectedIndex + dir;
            if (idx > 11) { idx = 0; document.getElementById('year-select').value++; }
            else if (idx < 0) { idx = 11; document.getElementById('year-select').value--; }
            m.selectedIndex = idx;
            m.dispatchEvent(new Event('change'));
        }
    </script>
</body>
</html>
