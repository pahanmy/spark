<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARKfleet â€“ Kalendar Tempahan Kenderaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn { transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* Gaya Kalendar */
        .calendar-day { min-height: 100px; display: flex; flex-direction: column; cursor: pointer; background-color: white; border: 1px solid #e5e7eb; }
        .calendar-day:hover { background-color: #fff1f2; border-color: #f43f5e; }
        
        /* HARI SEMASA (Lebih Jelas) */
        .calendar-day.is-today { 
            background-color: #eff6ff; /* Biru Muda */
            border: 2px solid #3b82f6; /* Bingkai Biru Gelap */
        }
        .calendar-day.is-today .day-number {
            color: #1d4ed8;
            font-weight: 800;
        }

        .calendar-day.selected { border: 2px solid #e11d48; background-color: #ffe4e6; }
        
        /* Tab */
        .tab-button { padding-bottom: 0.75rem; color: #6b7280; font-weight: 500; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-button:hover { color: #374151; border-color: #d1d5db; }
        .tab-button.active { color: #e11d48; border-color: #e11d48; font-weight: 600; }
        
        .table-container { max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-rose-600 p-2 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a.75.75 0 01.75.75v.5a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-.5a.75.75 0 01.75-.75h1.05a2.5 2.5 0 014.9 0H19a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-rose-600">SPARKfleet</h1>
                    <p class="text-sm text-gray-500">Kalendar Tempahan Kenderaan Jabatan</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="index.html" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md text-sm hover:bg-gray-300">Halaman Utama</a>
                <a href="tempahkenderaan.html" class="btn bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-rose-700 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tempah Kenderaan
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            
            <div class="lg:col-span-2">
                <div class="card p-6">
                    <div class="flex flex-wrap items-end gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Bulan</label>
                            <select id="month-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm shadow-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Tahun</label>
                            <select id="year-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm shadow-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Jenis Kenderaan</label>
                            <select id="vehicle-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm shadow-sm">
                                <option value="">SEMUA KENDERAAN</option>
                            </select>
                        </div>
                        <div class="flex-grow-[2]">
                            <label class="block text-sm font-medium text-gray-700">Carian</label>
                            <input type="text" id="search-input" placeholder="Cth: Lawatan Kerja..." class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm shadow-sm">
                        </div>
                    </div>

                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showTab('calendar')" id="tab-calendar" class="tab-button active">Kalendar Bulanan</button>
                            <button onclick="showTab('list')" id="tab-list" class="tab-button">Senarai Keseluruhan</button>
                        </nav>
                    </div>

                    <div id="calendar-tab-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&lt;</button>
                            <h2 id="calendar-header" class="text-xl font-bold text-gray-800 uppercase"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&gt;</button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-semibold text-sm text-gray-500 mb-2 uppercase tracking-wide">
                            <div>Ahad</div><div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div>Sabtu</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    </div>

                    <div id="list-tab-content" class="tab-content hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tarikh</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Kenderaan</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Destinasi & Program</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="full-list-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p id="no-list-data" class="text-center text-gray-500 py-10 hidden">Tiada tempahan ditemui.</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="card p-6 h-full sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 uppercase flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        Butiran: <span id="selected-date-text" class="text-rose-600">HARI INI</span>
                    </h3>
                    <div id="booking-list-content" class="space-y-4">
                        <p class="text-gray-400 italic text-sm text-center py-4">Sila pilih tarikh di kalendar.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-4 mt-8 border-t border-gray-200"><p class="text-xs text-gray-500">Sistem SPARKfleet</p></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let allBookings = [];
        let activeTab = 'calendar';
        let selectedDateEl = null;

        const vehicleDetails = {
            "Toyota Hilux (QAA 1234)": { short: "HILUX" },
            "Van Toyota Hiace (QAB 5678)": { short: "VAN" },
            "Bas Mini (QAC 9012)": { short: "BAS" }
        };

        onAuthStateChanged(auth, async (user) => { if (user) main(); else signInAnonymously(auth); });

        function main() { populateFilters(); setupEventListeners(); listenForData(); }

        function populateFilters() {
            const today = new Date();
            const monthSelect = document.getElementById('month-select');
            const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}" ${i === today.getMonth() ? 'selected' : ''}>${m}</option>`).join('');
            monthSelect.value = today.getMonth();

            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = `<option value="${today.getFullYear()}" selected>${today.getFullYear()}</option><option value="${today.getFullYear()+1}">${today.getFullYear()+1}</option>`;
            yearSelect.value = today.getFullYear();

            const vehicleSelect = document.getElementById('vehicle-select');
            vehicleSelect.innerHTML = '<option value="">SEMUA KENDERAAN</option>';
            ["Toyota Hilux (QAA 1234)", "Van Toyota Hiace (QAB 5678)", "Bas Mini (QAC 9012)"].forEach(v => {
                 vehicleSelect.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        function setupEventListeners() {
            document.getElementById('month-select').addEventListener('change', updateView);
            document.getElementById('year-select').addEventListener('change', updateView);
            document.getElementById('vehicle-select').addEventListener('change', updateView);
            document.getElementById('search-input').addEventListener('input', updateView);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
        }

        function listenForData() {
            const q = query(collection(db, `artifacts/${appId}/public/data/spark_vehicle_bookings`), orderBy("start", "asc"));
            onSnapshot(q, (snapshot) => {
                allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
            });
        }

        window.showTab = (tab) => {
            activeTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tab}-tab-content`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            updateView();
        }

        function updateView() {
            if (activeTab === 'calendar') renderCalendar();
            else renderList();
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('year-select').value) || new Date().getFullYear();
            const month = parseInt(document.getElementById('month-select').value) || new Date().getMonth();
            const months = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            document.getElementById('calendar-header').textContent = `${months[month]} ${year}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();

            for(let i=0; i<firstDayIndex; i++) grid.innerHTML += '<div class="bg-gray-50 border rounded-md min-h-[100px]"></div>';

            for(let day=1; day<=daysInMonth; day++) {
                const date = new Date(year, month, day);
                const events = getBookingsForDate(date);
                const isToday = new Date().toDateString() === date.toDateString();
                
                // EVENTS HTML
                const eventsHtml = events.map(e => {
                    let displayLabel = 'KDRN';
                    let badgeClass = "bg-rose-100 text-rose-800 border-rose-200";

                    // LOGIK: Jika belum ditetapkan, paparkan nama PROGRAM (Tajuk)
                    if (e.vehicle === "Menunggu Tetapan Admin") {
                        // Ambil nama program, pendekkan jika perlu
                        displayLabel = (e.programName || "MOHON").substring(0, 15);
                        badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-200"; 
                    } else if (vehicleDetails[e.vehicle]) {
                        displayLabel = vehicleDetails[e.vehicle].short;
                    }

                    return `<div class="${badgeClass} text-[10px] font-bold px-1 rounded truncate mt-1 border" title="${e.vehicle}: ${e.destination}">${displayLabel}</div>`;
                }).join('');

                const dayDivId = `day-div-${day}`;
                
                // Tambah class 'is-today' jika hari ini
                let dayHtml = `
                    <div id="${dayDivId}" class="calendar-day border rounded-md p-2 transition hover:shadow-md ${isToday ? 'is-today' : 'bg-white'}" onclick="showDayDetails('${date.toISOString()}', '${dayDivId}')">
                        <div class="flex justify-between items-start">
                            <span class="day-number text-gray-700 text-sm">${day}</span>
                            ${events.length > 0 ? `<span class="bg-rose-500 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center shadow-sm">${events.length}</span>` : ''}
                        </div>
                        <div class="mt-1 overflow-y-auto max-h-[60px] space-y-1">
                            ${eventsHtml}
                        </div>
                    </div>`;
                grid.innerHTML += dayHtml;
            }
        }

        function getBookingsForDate(date) {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            return allBookings.filter(b => {
                if (!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
                const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const startDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                const endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());
                const isDateMatch = checkDate >= startDate && checkDate <= endDate;
                const isVehicleMatch = !filterVehicle || b.vehicle === filterVehicle;
                const isSearchMatch = (b.programName || '').toLowerCase().includes(search) || (b.destination || '').toLowerCase().includes(search);
                return isDateMatch && isVehicleMatch && isSearchMatch;
            });
        }

        window.showDayDetails = (dateStr, elementId) => {
            const date = new Date(dateStr);
            const bookings = getBookingsForDate(date);
            const listContainer = document.getElementById('booking-list-content');
            
            if(selectedDateEl) selectedDateEl.classList.remove('selected');
            const el = document.getElementById(elementId);
            if(el) { el.classList.add('selected'); selectedDateEl = el; }

            document.getElementById('selected-date-text').textContent = date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            if(!bookings.length) {
                listContainer.innerHTML = '<div class="text-center py-8 border-2 border-dashed border-gray-200 rounded-lg"><p class="text-gray-500 font-medium text-sm">Tiada tempahan pada tarikh ini.</p></div>';
                return;
            }

            listContainer.innerHTML = bookings.map(b => {
                // LOGIK STATUS DISPLAY
                let vehicleDisplay = b.vehicle;
                let statusColor = "text-rose-600 border-rose-500";
                
                if (b.vehicle === "Menunggu Tetapan Admin") {
                    vehicleDisplay = "MENUNGGU KEPUTUSAN"; // Tukar teks ini
                    statusColor = "text-yellow-600 border-yellow-500";
                }

                return `
                <div class="bg-white border-l-4 ${statusColor} p-4 rounded shadow-sm hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-sm uppercase ${statusColor.replace('border-', '')}">${vehicleDisplay}</p>
                            <p class="font-semibold text-gray-800 leading-tight mt-1 text-sm">${b.programName}</p>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-600 space-y-2 bg-gray-50 p-2 rounded border border-gray-100">
                        <div><strong class="text-gray-400 text-[10px] uppercase">Destinasi:</strong><div class="whitespace-pre-line pl-1">${b.destination || '-'}</div></div>
                        <div class="flex justify-between">
                            <span><strong class="text-gray-400 text-[10px] uppercase">Masa:</strong> ${formatTime(b.start)} - ${formatTime(b.end)}</span>
                            <span><strong class="text-gray-400 text-[10px] uppercase">Pax:</strong> ${b.passengers || '-'}</span>
                        </div>
                        <div><strong class="text-gray-400 text-[10px] uppercase">Pemohon:</strong> ${b.bookedBy_name}</div>
                        ${b.vipNames ? `<div class="text-rose-700 bg-rose-50 px-1 py-0.5 rounded border border-rose-100"><strong class="uppercase text-[10px]">VIP:</strong> ${b.vipNames}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        };

        function renderList() {
            const tbody = document.getElementById('full-list-table-body');
            const noData = document.getElementById('no-list-data');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            const yearFilter = parseInt(document.getElementById('year-select').value);
            const monthFilter = parseInt(document.getElementById('month-select').value);

            const filtered = allBookings.filter(b => {
                if(!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                return start.getFullYear() === yearFilter && 
                       start.getMonth() === monthFilter &&
                       (!filterVehicle || b.vehicle === filterVehicle) &&
                       ((b.programName || '').toLowerCase().includes(search));
            }).sort((a,b) => (b.start.toDate ? b.start.toDate() : new Date(b.start)) - (a.start.toDate ? a.start.toDate() : new Date(a.start)));

            tbody.innerHTML = '';
            if (filtered.length === 0) { noData.classList.remove('hidden'); return; }
            noData.classList.add('hidden');

            filtered.forEach(b => {
                 const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                 
                 // LOGIK BADGE LIST
                 let statusBadge = `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-[10px] font-bold uppercase">DITERIMA</span>`;
                 let vehicleText = b.vehicle;
                 
                 if (b.vehicle === "Menunggu Tetapan Admin") {
                     statusBadge = `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-[10px] font-bold uppercase">KEPUTUSAN PERMOHONAN</span>`;
                     vehicleText = "-";
                 }

                 tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="p-3 text-sm text-gray-900 font-medium">
                            ${start.toLocaleDateString('ms-MY', {day:'2-digit', month:'2-digit'})}
                            <br><span class="text-xs text-gray-500">${formatTime(b.start)}</span>
                        </td>
                        <td class="p-3 text-sm font-semibold text-rose-600 uppercase text-xs">${vehicleText}</td>
                        <td class="p-3 text-sm text-gray-700">
                            <div class="font-bold text-xs line-clamp-2" title="${b.destination}">${b.destination}</div>
                            <div class="text-[10px] mt-1 text-gray-500 uppercase">${b.programName}</div>
                        </td>
                        <td class="p-3 text-sm">${statusBadge}</td>
                    </tr>`;
            });
        }

        function formatTime(timestamp) { 
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('ms-MY', {hour: '2-digit', minute:'2-digit'}); 
        }

        function changeMonth(dir) {
            const select = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            let newIndex = select.selectedIndex + dir;
            if (newIndex > 11) { newIndex = 0; yearSelect.value = parseInt(yearSelect.value) + 1; } 
            else if (newIndex < 0) { newIndex = 11; yearSelect.value = parseInt(yearSelect.value) - 1; }
            select.selectedIndex = newIndex;
            select.dispatchEvent(new Event('change'));
            yearSelect.dispatchEvent(new Event('change'));
        }
    </script>
</body>
</html>
