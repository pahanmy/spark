<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARKfleet ‚Äì Kalendar Tempahan Kenderaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn { transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* Gaya Kalendar */
        .calendar-day { min-height: 100px; display: flex; flex-direction: column; cursor: pointer; background-color: white; border: 1px solid #e5e7eb; }
        .calendar-day:hover { background-color: #fff1f2; border-color: #f43f5e; }
        .calendar-day.is-today { background-color: #eff6ff; border: 2px solid #3b82f6; }
        .calendar-day.is-today .day-number { color: #1d4ed8; font-weight: 800; }
        .calendar-day.selected { border: 2px solid #e11d48; background-color: #ffe4e6; }
        
        /* Tab & Modal */
        .tab-button { padding-bottom: 0.75rem; color: #6b7280; font-weight: 500; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-button:hover { color: #374151; border-color: #d1d5db; }
        .tab-button.active { color: #e11d48; border-color: #e11d48; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        
        .table-container { max-height: 70vh; overflow-y: auto; }

        /* Emoji Rating */
        .emoji-btn { font-size: 1.5rem; filter: grayscale(100%); transition: all 0.2s; cursor: default; }
        .emoji-btn.active { filter: grayscale(0%); transform: scale(1.2); }

        /* --- FLIGHT ITINERARY STYLES (GAYA KERETA/FLIGHT) --- */
        /* Ini adalah style yang sama dari tempahkenderaan.html */
        
        .flight-segment {
            position: relative;
            padding-left: 1.8rem;
            padding-bottom: 1.5rem;
            border-left: 2px dashed #cbd5e1;
            margin-left: 0.5rem;
        }
        .flight-segment:last-child {
            border-left: 2px solid transparent;
            padding-bottom: 0;
        }
        .flight-icon {
            position: absolute;
            left: -0.55rem;
            top: 0;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid #e11d48;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e11d48;
            z-index: 10;
        }
        .flight-time {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            color: #be123c;
            font-size: 0.75rem;
            background-color: #ffe4e6;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        .flight-loc {
            font-weight: 700;
            color: #1f2937;
            text-transform: uppercase;
            font-size: 0.85rem;
            line-height: 1.3;
            display: block;
        }
        .flight-day-header {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #4b5563;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
            margin: 10px 0 10px 0;
            border: 1px solid #e5e7eb;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-rose-600 p-2 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a.75.75 0 01.75.75v.5a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-.5a.75.75 0 01.75-.75h1.05a2.5 2.5 0 014.9 0H19a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-rose-600">SPARKfleet</h1>
                    <p class="text-sm text-gray-500">Kalendar Tempahan Kenderaan Jabatan</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <a href="https://pahanmy.github.io/ppdmiri" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md text-sm hover:bg-gray-300">Halaman Utama</a>
                <a href="tempahkenderaan.html" class="btn bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-rose-700 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tempah Kenderaan
                </a>
                <button onclick="openAdminModal()" class="btn bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Admin
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            
            <div class="lg:col-span-2">
                <div class="card p-6">
                    <div class="flex flex-wrap items-end gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Bulan</label>
                            <select id="month-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Tahun</label>
                            <select id="year-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm"></select>
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Jenis Kenderaan</label>
                            <select id="vehicle-select" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm">
                                <option value="">SEMUA KENDERAAN</option>
                            </select>
                        </div>
                        <div class="flex-grow-[2]">
                            <label class="block text-sm font-medium text-gray-700">Carian</label>
                            <input type="text" id="search-input" placeholder="Cth: Lawatan Kerja..." class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3 sm:text-sm">
                        </div>
                    </div>

                    <div class="flex justify-center mb-6">
                        <div class="bg-gray-100 p-1.5 rounded-xl inline-flex shadow-inner border border-gray-200">
                            <button onclick="showTab('calendar')" id="tab-calendar" class="flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 bg-white text-rose-600 shadow-sm ring-1 ring-black/5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                Kalendar Bulanan
                            </button>
                            <button onclick="showTab('list')" id="tab-list" class="flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-200/50 transition-all duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                Senarai Keseluruhan
                            </button>
                        </div>
                    </div>

                    <div id="calendar-tab-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&lt;</button>
                            <h2 id="calendar-header" class="text-xl font-bold text-gray-800 uppercase"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold">&gt;</button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-semibold text-sm text-gray-500 mb-2 uppercase tracking-wide">
                            <div>Ahad</div><div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div>Sabtu</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    </div>

                    <div id="list-tab-content" class="tab-content hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tarikh</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Kenderaan & Pemandu</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Destinasi & Program</th>
                                        <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status & Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="full-list-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p id="no-list-data" class="text-center text-gray-500 py-10 hidden">Tiada tempahan ditemui.</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="card p-6 h-full sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 uppercase flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        Butiran: <span id="selected-date-text" class="text-rose-600">HARI INI</span>
                    </h3>
                    <div id="booking-list-content" class="space-y-4">
                        <p class="text-gray-400 italic text-sm text-center py-4">Sila pilih tarikh di kalendar.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 transform transition-all relative">
            <button onclick="closeItineraryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <h3 class="text-xl font-bold text-gray-900 mb-2 border-b pb-3 uppercase flex items-center gap-2">
                üìã Jadual Pergerakan
            </h3>
            
            <div class="mb-4 bg-gray-50 p-3 rounded-lg text-sm border border-gray-100">
                <p class="font-bold text-gray-800 uppercase" id="modal-program-name"></p>
                <div class="flex justify-between mt-2 text-gray-600">
                    <span id="modal-driver-info"></span>
                    <span id="modal-vehicle-info" class="font-semibold text-rose-600"></span>
                </div>
            </div>

            <div class="max-h-[60vh] overflow-y-auto pr-2" id="modal-timeline-content">
                </div>

            <div class="mt-6 text-right">
                <button onclick="closeItineraryModal()" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg text-sm hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform transition-all">
            <div class="text-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Akses Admin</h3>
                <p class="text-sm text-gray-500">Sila masukkan kata laluan keselamatan.</p>
            </div>
            <input type="password" id="admin-password" placeholder="Kata Laluan" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 focus:ring-rose-500 focus:border-rose-500">
            <div class="flex justify-end gap-2">
                <button onclick="closeAdminModal()" class="btn bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm hover:bg-gray-300">Batal</button>
                <button onclick="checkAdminPassword()" class="btn bg-gray-800 text-white px-4 py-2 rounded-md text-sm hover:bg-gray-900">Masuk</button>
            </div>
        </div>
    </div>

    <div id="rating-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 text-center transform transition-all">
            <h3 class="text-lg font-bold text-gray-900 mb-1">Penilaian Pemanduan</h3>
            <div id="rating-info" class="bg-indigo-50 p-3 rounded-lg mb-4 text-sm text-indigo-800 border border-indigo-100 mt-2">
                <p class="font-bold uppercase" id="rating-driver-name"></p>
            </div>
            <div class="flex justify-center gap-4 mb-6">
                <div class="text-center" onclick="selectRating(1)"><div class="emoji-btn" id="emoji-1">üò°</div><div class="text-xs text-gray-500">Teruk</div></div>
                <div class="text-center" onclick="selectRating(2)"><div class="emoji-btn" id="emoji-2">‚òπÔ∏è</div><div class="text-xs text-gray-500">Kurang</div></div>
                <div class="text-center" onclick="selectRating(3)"><div class="emoji-btn" id="emoji-3">üòê</div><div class="text-xs text-gray-500">Biasa</div></div>
                <div class="text-center" onclick="selectRating(4)"><div class="emoji-btn" id="emoji-4">üôÇ</div><div class="text-xs text-gray-500">Baik</div></div>
                <div class="text-center" onclick="selectRating(5)"><div class="emoji-btn" id="emoji-5">ü§©</div><div class="text-xs text-gray-500">Cemerlang</div></div>
            </div>
            <textarea id="rating-comment" rows="2" class="w-full border border-gray-300 rounded p-2 text-sm mb-4" placeholder="Komen tambahan (pilihan)..."></textarea>
            <div class="text-left bg-gray-50 p-3 rounded border mb-4">
                <label class="block text-xs font-bold text-gray-700 mb-1">Pengesahan Identiti (Wajib)</label>
                <input type="text" id="rating-verify-ic" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="Masukkan No. IC Pemohon">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeRatingModal()" class="btn bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm">Batal</button>
                <button onclick="submitRating()" class="btn bg-indigo-600 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-700 shadow-md">Hantar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let allBookings = [];
        let activeTab = 'calendar';
        let selectedDateEl = null;
        let currentRatingBookingId = null;
        let currentRatingBookerIc = null;
        let selectedRatingValue = 0;

        const vehicleDetails = {
            "Toyota Hilux (QAA 1234)": { short: "HILUX" },
            "Van Toyota Hiace (QAB 5678)": { short: "VAN" },
            "Bas Mini (QAC 9012)": { short: "BAS" }
        };

        onAuthStateChanged(auth, async (user) => { if (user) main(); else signInAnonymously(auth); });

        function main() { populateFilters(); setupEventListeners(); listenForData(); }

        function populateFilters() {
            const today = new Date();
            const monthSelect = document.getElementById('month-select');
            const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}" ${i === today.getMonth() ? 'selected' : ''}>${m}</option>`).join('');
            monthSelect.value = today.getMonth();

            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = `<option value="${today.getFullYear()}" selected>${today.getFullYear()}</option><option value="${today.getFullYear()+1}">${today.getFullYear()+1}</option>`;
            yearSelect.value = today.getFullYear();

            const vehicleSelect = document.getElementById('vehicle-select');
            vehicleSelect.innerHTML = '<option value="">SEMUA KENDERAAN</option>';
            ["Toyota Hilux (QAA 1234)", "Van Toyota Hiace (QAB 5678)", "Bas Mini (QAC 9012)"].forEach(v => {
                 vehicleSelect.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        function setupEventListeners() {
            document.getElementById('month-select').addEventListener('change', updateView);
            document.getElementById('year-select').addEventListener('change', updateView);
            document.getElementById('vehicle-select').addEventListener('change', updateView);
            document.getElementById('search-input').addEventListener('input', updateView);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
        }

        function listenForData() {
            const q = query(collection(db, `artifacts/${appId}/public/data/spark_vehicle_bookings`), orderBy("start", "asc"));
            onSnapshot(q, (snapshot) => {
                allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
            });
        }

        window.showTab = (tab) => {
            activeTab = tab;
            document.getElementById('calendar-tab-content').classList.toggle('hidden', tab !== 'calendar');
            document.getElementById('list-tab-content').classList.toggle('hidden', tab !== 'list');
            
            const btnCal = document.getElementById('tab-calendar');
            const btnList = document.getElementById('tab-list');
            
            const activeClasses = "bg-white text-rose-600 shadow-sm ring-1 ring-black/5 font-semibold";
            const inactiveClasses = "text-gray-500 hover:text-gray-700 hover:bg-gray-200/50 font-medium";
            
            if (tab === 'calendar') {
                btnCal.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${activeClasses}`;
                btnList.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${inactiveClasses}`;
            } else {
                btnCal.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${inactiveClasses}`;
                btnList.className = `flex items-center gap-2 px-6 py-2.5 rounded-lg text-sm transition-all duration-300 ${activeClasses}`;
            }
            updateView();
        }

        function updateView() {
            if (activeTab === 'calendar') renderCalendar();
            else renderList();
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('year-select').value) || new Date().getFullYear();
            const month = parseInt(document.getElementById('month-select').value) || new Date().getMonth();
            const months = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            document.getElementById('calendar-header').textContent = `${months[month]} ${year}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();

            for(let i=0; i<firstDayIndex; i++) grid.innerHTML += '<div class="bg-gray-50 border rounded-md min-h-[100px]"></div>';

            for(let day=1; day<=daysInMonth; day++) {
                const date = new Date(year, month, day);
                const events = getBookingsForDate(date);
                const isToday = new Date().toDateString() === date.toDateString();
                
                const eventsHtml = events.map(e => {
                    let displayLabel = vehicleDetails[e.vehicle] ? vehicleDetails[e.vehicle].short : e.vehicle.substring(0, 10);
                    let badgeClass = "bg-rose-100 text-rose-800 border-rose-200";
                    if (e.vehicle === "Menunggu Tetapan Admin") {
                        displayLabel = (e.programName || "MOHON").substring(0, 15);
                        badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-200"; 
                    } 
                    return `<div class="${badgeClass} text-[10px] font-bold px-1 rounded truncate mt-1 border" title="${e.vehicle}: ${e.destination}">${displayLabel}</div>`;
                }).join('');

                const dayDivId = `day-div-${day}`;
                grid.innerHTML += `
                    <div id="${dayDivId}" class="calendar-day border rounded-md p-2 transition hover:shadow-md ${isToday ? 'is-today' : 'bg-white'}" onclick="showDayDetails('${date.toISOString()}', '${dayDivId}')">
                        <div class="flex justify-between items-start">
                            <span class="day-number text-gray-700 text-sm">${day}</span>
                            ${events.length > 0 ? `<span class="bg-rose-500 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center shadow-sm">${events.length}</span>` : ''}
                        </div>
                        <div class="mt-1 overflow-y-auto max-h-[60px] space-y-1">${eventsHtml}</div>
                    </div>`;
            }
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth()) {
                setTimeout(() => {
                    const el = document.getElementById(`day-div-${today.getDate()}`);
                    if (el && !selectedDateEl) showDayDetails(today.toISOString(), el.id);
                }, 50);
            }
        }

        function getBookingsForDate(date) {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            return allBookings.filter(b => {
                if (!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
                const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const startDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                const endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());
                return checkDate >= startDate && checkDate <= endDate && (!filterVehicle || b.vehicle === filterVehicle) && ((b.programName || '').toLowerCase().includes(search));
            });
        }

        window.showDayDetails = (dateStr, elementId) => {
            const date = new Date(dateStr);
            const bookings = getBookingsForDate(date);
            const listContainer = document.getElementById('booking-list-content');
            
            if(selectedDateEl && document.body.contains(selectedDateEl)) selectedDateEl.classList.remove('selected');
            const el = document.getElementById(elementId);
            if(el) { el.classList.add('selected'); selectedDateEl = el; }

            document.getElementById('selected-date-text').textContent = date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            if(!bookings.length) {
                listContainer.innerHTML = '<div class="text-center py-8 border-2 border-dashed border-gray-200 rounded-lg"><p class="text-gray-500 font-medium text-sm">Tiada tempahan pada tarikh ini.</p></div>';
                return;
            }

            listContainer.innerHTML = bookings.map(b => {
                let vehicleDisplay = b.vehicle === "Menunggu Tetapan Admin" ? "MENUNGGU KEPUTUSAN" : b.vehicle;
                let statusColor = b.vehicle === "Menunggu Tetapan Admin" ? "text-yellow-600 border-yellow-500" : "text-rose-600 border-rose-500";
                
                return `
                <div class="bg-white border-l-4 ${statusColor} p-4 rounded shadow-sm hover:shadow-md transition">
                    <div>
                        <p class="font-bold text-sm uppercase ${statusColor.replace('border-', '')}">${vehicleDisplay}</p>
                        <p class="font-semibold text-gray-800 leading-tight mt-1 text-sm">${b.programName}</p>
                    </div>
                    <div class="mt-3 text-xs text-gray-600 space-y-2 bg-gray-50 p-2 rounded border border-gray-100">
                        <button onclick="openItineraryModal('${b.id}')" class="w-full text-left text-rose-600 font-bold text-[10px] uppercase hover:underline flex items-center gap-1 mb-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            Lihat Jadual Penuh
                        </button>
                        <div class="flex justify-between">
                            <span><strong class="text-gray-400 text-[10px] uppercase">Masa:</strong> ${formatTime(b.start)} - ${formatTime(b.end)}</span>
                            <span><strong class="text-gray-400 text-[10px] uppercase">Pax:</strong> ${b.passengers || '-'}</span>
                        </div>
                        <div><strong class="text-gray-400 text-[10px] uppercase">Pemohon:</strong> ${b.bookedBy_name}</div>
                        ${b.driverName ? `<div class="pt-2 mt-2 border-t border-gray-200"><strong class="text-gray-500 text-[10px] uppercase">Pemandu:</strong> <span class="font-bold text-gray-800">${b.driverName}</span></div>` : ''}
                    </div>
                </div>`;
            }).join('');
        };

        function renderList() {
            const tbody = document.getElementById('full-list-table-body');
            const noData = document.getElementById('no-list-data');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterVehicle = document.getElementById('vehicle-select').value;
            const yearFilter = parseInt(document.getElementById('year-select').value);
            const monthFilter = parseInt(document.getElementById('month-select').value);

            const filtered = allBookings.filter(b => {
                if(!b.start) return false;
                const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                return start.getFullYear() === yearFilter && 
                       start.getMonth() === monthFilter &&
                       (!filterVehicle || b.vehicle === filterVehicle) &&
                       ((b.programName || '').toLowerCase().includes(search));
            }).sort((a,b) => (b.start.toDate ? b.start.toDate() : new Date(b.start)) - (a.start.toDate ? a.start.toDate() : new Date(a.start)));

            tbody.innerHTML = '';
            if (filtered.length === 0) { noData.classList.remove('hidden'); return; }
            noData.classList.add('hidden');

            filtered.forEach(b => {
                 const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
                 let vehicleText = `<span class="font-bold text-rose-600 text-xs">${b.vehicle}</span>`;
                 let driverInfo = '<span class="text-gray-400 italic text-[10px]">Belum ditetapkan</span>';
                 let statusBadge = `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-[10px] font-bold uppercase">DITERIMA</span>`;
                 
                 if (b.vehicle === "Menunggu Tetapan Admin") {
                     statusBadge = `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-[10px] font-bold uppercase">MENUNGGU KEPUTUSAN</span>`;
                     vehicleText = '<span class="text-gray-500 italic text-xs">Belum ditetapkan</span>';
                     driverInfo = '<span class="text-gray-400 italic text-[10px]">-</span>';
                 } else if (b.driverName) {
                     driverInfo = `<div class="text-gray-800 text-xs font-semibold mt-1 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> ${b.driverName}</div>`;
                 }

                 let actionButtons = `
                    <div class="flex gap-2 mt-1">
                        `;

                 if (b.status === 'DILULUSKAN') {
                     let ratingButton = b.rating ? 
                        `<span class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 cursor-default" title="${b.ratingComment || ''}">Dinilai: ${["üò°","‚òπÔ∏è","üòê","üôÇ","ü§©"][b.rating-1] || "‚≠ê"}</span>` :
                        `<button onclick="openRatingModal('${b.id}', '${b.driverName || 'Pemandu'}', '${b.bookedBy_ic}')" class="text-white bg-indigo-500 hover:bg-indigo-600 text-xs flex items-center gap-1 px-3 py-1 rounded shadow-sm">Nilai</button>`;
                     
                     actionButtons += `
                        <button onclick="downloadBookingPDF('${b.id}')" class="text-white bg-rose-600 hover:bg-rose-700 text-xs flex items-center gap-1 px-3 py-1 rounded shadow-sm">PDF</button>
                        ${ratingButton}
                     `;
                 }
                 actionButtons += `</div>`;

                 tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="p-3 text-sm text-gray-900 font-medium">
                            ${start.toLocaleDateString('ms-MY', {day:'2-digit', month:'2-digit'})}
                            <br><span class="text-xs text-gray-500">${formatTime(b.start)}</span>
                        </td>
                        <td class="p-3 text-sm uppercase">${vehicleText}${driverInfo}</td>
                        <td class="p-3 text-sm text-gray-700">
                            <div class="text-[10px] mt-1 text-gray-900 font-semibold uppercase mb-1">${b.programName}</div>
                            <div class="text-[10px] text-gray-500 italic mb-2">Oleh: ${b.bookedBy_name}</div>
                            <button onclick="openItineraryModal('${b.id}')" class="text-gray-600 hover:text-gray-800 text-xs flex items-center gap-1 border border-gray-300 bg-white px-2 py-1 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Jadual</button>
                        </td>
                        <td class="p-3 text-sm space-y-2"><div>${statusBadge}</div>${actionButtons}</td>
                    </tr>`;
            });
        }

        // --- RATING MODAL LOGIC ---
        window.openRatingModal = (bookingId, driverName, bookerIc) => {
            currentRatingBookingId = bookingId;
            currentRatingBookerIc = bookerIc;
            selectedRatingValue = 0;
            document.getElementById('rating-driver-name').textContent = driverName;
            document.getElementById('rating-verify-ic').value = '';
            document.getElementById('rating-comment').value = '';
            for (let i = 1; i <= 5; i++) document.getElementById(`emoji-${i}`).classList.remove('selected');
            document.getElementById('rating-modal').classList.remove('hidden');
        };

        window.closeRatingModal = () => document.getElementById('rating-modal').classList.add('hidden');

        window.selectRating = (val) => {
            selectedRatingValue = val;
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById(`emoji-${i}`);
                if (i === val) el.classList.add('selected'); else el.classList.remove('selected');
            }
        };

        window.submitRating = async () => {
            if (selectedRatingValue === 0) { alert("Sila pilih emoji penilaian."); return; }
            const inputIc = document.getElementById('rating-verify-ic').value.trim();
            if (inputIc !== currentRatingBookerIc) { alert("Nombor IC tidak sepadan dengan pemohon asal."); return; }
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_vehicle_bookings`, currentRatingBookingId), {
                    rating: selectedRatingValue,
                    ratingComment: document.getElementById('rating-comment').value,
                    ratedAt: serverTimestamp()
                });
                alert("Terima kasih! Penilaian anda telah direkodkan.");
                closeRatingModal();
            } catch (error) { console.error("Error:", error); alert("Gagal menghantar penilaian."); }
        };

        // --- PDF & ITINERARY MODAL ---
        window.downloadBookingPDF = (id) => {
            const b = allBookings.find(x => x.id === id);
            if(!b) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("PEJABAT PENDIDIKAN DAERAH MIRI", 105, 20, null, null, "center");
            doc.setFontSize(12); doc.text("BORANG TEMPAHAN KENDERAAN (DILULUSKAN)", 105, 28, null, null, "center");
            doc.line(20, 35, 190, 35);
            
            const start = b.start.toDate ? b.start.toDate() : new Date(b.start);
            const end = b.end.toDate ? b.end.toDate() : new Date(b.end);
            
            doc.autoTable({ startY: 50, head: [], body: [
                ["Nama Pemohon", b.bookedBy_name],
                ["Nama Program", b.programName],
                ["Tarikh Mula", start.toLocaleDateString() + " " + formatTime(start)],
                ["Tarikh Tamat", end.toLocaleDateString() + " " + formatTime(end)],
                ["Penumpang", b.passengers]
            ], theme: 'plain' });
            
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold"); doc.text("BUTIRAN KENDERAAN", 20, finalY);
            doc.autoTable({ startY: finalY + 5, body: [["Kenderaan", b.vehicle], ["Pemandu", b.driverName]], theme: 'grid' });
            
            finalY = doc.lastAutoTable.finalY + 10;
            doc.text("JADUAL PERGERAKAN", 20, finalY);
            const splitDest = doc.splitTextToSize(b.destination || "", 170);
            doc.setFont("helvetica", "normal"); doc.text(splitDest, 20, finalY + 7);
            doc.save(`Tempahan_${b.programName.substring(0,10)}.pdf`);
        };

        // --- NEW: ITINERARY MODAL PARSER (GAYA KERETA) ---
        window.openItineraryModal = (id) => {
            const b = allBookings.find(x => x.id === id);
            if(!b) return;
            document.getElementById('itinerary-modal').classList.remove('hidden');
            document.getElementById('modal-program-name').textContent = b.programName;
            document.getElementById('modal-driver-info').textContent = b.driverName ? `Pemandu: ${b.driverName}` : 'Pemandu: -';
            document.getElementById('modal-vehicle-info').textContent = b.vehicle;
            
            const container = document.getElementById('modal-timeline-content');
            let contentHtml = '';
            
            // Helper function untuk baris perjalanan (Car Icon)
            const renderFlightRow = (time, loc) => {
                const carIconSvg = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a.75.75 0 01.75.75v.5a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-.5a.75.75 0 01.75-.75h1.05a2.5 2.5 0 014.9 0H19a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" />
                    </svg>`;
                return `
                <div class="flight-segment">
                    <div class="flight-icon bg-white text-rose-600 shadow-sm">${carIconSvg}</div>
                    ${time ? `<span class="flight-time">${time}</span>` : ''}
                    <span class="flight-loc">${loc}</span>
                </div>`;
            };

            const destText = b.destination || '';
            let lines = [];

            // Detect format: Arrow (->) single day OR Newlines
            if (destText.includes('->')) {
                // Single day arrow format
                lines = destText.split('->').map(s => s.trim());
            } else {
                // Standard multiline / Bullet format
                lines = destText.split('\n');
            }

            let groupBuffer = "";

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                // Cek Header Hari [Hari X...]
                if (line.startsWith('[') && line.endsWith(']:')) {
                    // Tutup group sebelum ini jika ada
                     if(groupBuffer) { contentHtml += groupBuffer; groupBuffer = ""; }
                     
                     contentHtml += `
                     <div class="mb-2">
                         <div class="flight-segment border-l-0 pb-0 pl-0">
                             <span class="flight-day-header">${line.replace('[','').replace(']:','')}</span>
                         </div>
                     </div>`;
                     return;
                }

                // Cek Masa & Lokasi. Regex support:
                // 1. "08:00 LOKASI"
                // 2. "- 08:00 LOKASI" (bullet)
                const timeMatch = line.match(/(?:-\s*)?(\d{1,2}:\d{2})\s+(.*)/);
                
                if (timeMatch) {
                    contentHtml += renderFlightRow(timeMatch[1], timeMatch[2]);
                } else {
                    // Fallback (tiada masa dikesan, paparkan teks shj)
                    contentHtml += renderFlightRow("", line.replace(/^- /, ''));
                }
            });

            container.innerHTML = contentHtml || '<p class="text-gray-400 italic text-center py-4">Tiada maklumat jadual.</p>';
        };
        
        window.closeItineraryModal = () => document.getElementById('itinerary-modal').classList.add('hidden');

        // --- ADMIN LOGIN ---
        window.openAdminModal = () => document.getElementById('admin-login-modal').classList.remove('hidden');
        window.closeAdminModal = () => document.getElementById('admin-login-modal').classList.add('hidden');
        window.checkAdminPassword = () => {
            if (document.getElementById('admin-password').value === '123') window.location.href = 'https://pahanmy.github.io/spark/admintempahankenderaan';
            else alert('Kata laluan salah!');
        };

        function formatTime(t) { 
            if (!t) return "";
            const date = t.toDate ? t.toDate() : new Date(t);
            return date.toLocaleTimeString('ms-MY', {hour: '2-digit', minute:'2-digit'}); 
        }
        function changeMonth(dir) {
            const m = document.getElementById('month-select');
            let idx = m.selectedIndex + dir;
            if (idx > 11) { idx = 0; document.getElementById('year-select').value++; }
            else if (idx < 0) { idx = 11; document.getElementById('year-select').value--; }
            m.selectedIndex = idx;
            m.dispatchEvent(new Event('change'));
        }
    </script>
</body>
</html>
