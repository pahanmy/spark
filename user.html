<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK ‚Äì Papan Pemuka Pengguna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .nav-tabs-container {
            background-color: #f3f4f6;
            padding: 0.35rem;
            border-radius: 0.75rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
        }
        
        .nav-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: #6b7280;
        }

        .nav-tab:hover {
            background-color: rgba(255, 255, 255, 0.6);
            color: #374151;
        }

        .nav-tab.active {
            background-color: white;
            color: #4f46e5;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transform: scale(1.02);
        }

        @keyframes loadProgress { 0% { width: 0; } }
        .progress-bar-fill { animation: loadProgress 1.5s ease-out forwards; }

        @keyframes pulse-new {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .badge-new { animation: pulse-new 2s infinite; }
        
        #mention-dropdown::-webkit-scrollbar { width: 6px; }
        #mention-dropdown::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .profile-pic-container:hover .profile-overlay { opacity: 1; }
        .profile-overlay { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-2 sm:gap-4 flex-wrap">
                 <button onclick="window.location.href='index.html'" class="btn bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-200 flex items-center gap-2 text-xs sm:text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Halaman Utama
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full bg-gray-50">
        
        <div class="relative w-full h-[260px] bg-gradient-to-br from-indigo-900 to-purple-800">
            <div class="absolute inset-0 bg-black/20"></div>
        </div>

        <div class="relative z-10 px-4 sm:px-6 lg:px-8 -mt-20">
            <div class="max-w-4xl mx-auto">
                <div class="glass-card p-6 md:p-10 rounded-2xl shadow-2xl relative">
                    <a id="edit-profile-btn" href="edit.html" class="absolute top-4 right-4 md:top-6 md:right-6 btn bg-gray-100 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 p-2 rounded-full transition-colors shadow-sm" title="Kemaskini Profil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </a>

                    <div class="flex flex-col md:flex-row items-center gap-6">
                        
                        <div class="relative profile-pic-container group cursor-pointer" onclick="triggerProfileUpload()">
                            <div id="default-profile-icon" class="bg-indigo-100 p-4 rounded-full border-4 border-white shadow-md w-24 h-24 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <img id="user-profile-image" src="" class="hidden w-24 h-24 rounded-full border-4 border-white shadow-md object-cover bg-gray-200" alt="Profile Picture">
                            <div class="profile-overlay absolute inset-0 bg-black/40 rounded-full flex flex-col items-center justify-center opacity-0 transition-opacity">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span class="text-[8px] text-white font-bold uppercase mt-1">Tukar</span>
                            </div>
                            <div id="profile-loading" class="absolute inset-0 bg-white/80 rounded-full flex items-center justify-center hidden">
                                <svg class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <input type="file" id="profile-upload-input" class="hidden" accept="image/*" onchange="handleProfileImageUpload(this)">
                        </div>

                        <div class="text-center md:text-left flex-grow">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight mb-1" id="user-name">Memuatkan...</h2>
                            <div class="flex flex-col md:flex-row gap-2 md:gap-4 text-gray-600 text-sm font-medium justify-center md:justify-start">
                                <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0c0 .884-.5 1.5-1.5 1.5S8 7 8 6m4 0c0 .884.5 1.5 1.5 1.5S15 7 15 6"></path></svg> <span id="user-ic">-</span></span>
                                <span class="hidden md:inline">|</span>
                                <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> <span id="user-org">-</span></span>
                            </div>
                            
                            <p id="user-sector-unit" class="text-xs text-indigo-600 font-bold mt-2 uppercase hidden flex items-center justify-center md:justify-start gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg>
                                <span id="sector-text"></span>
                            </p>
                        </div>
                        
                        </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

                <div class="lg:col-span-3 space-y-6">
                    
                    <div class="nav-tabs-container mb-6">
                        <button id="tab-planner" onclick="switchTab('planner')" class="nav-tab active">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            AKTIVITI SAYA
                        </button>

                        <button id="tab-attendance" onclick="switchTab('attendance')" class="nav-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                            Kehadiran
                        </button>
                        <button id="tab-created" onclick="switchTab('created')" class="nav-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Program Saya
                        </button>
                        <button id="tab-tasks" onclick="switchTab('tasks')" class="nav-tab">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            SparkTask
                        </button>
                    </div>

                    <div id="view-table" class="hidden">
                        <div class="card p-5 border border-gray-100 bg-white mb-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 uppercase" id="table-title">
                                    SENARAI KEHADIRAN
                                </h3>
                                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                    <div class="relative">
                                        <select id="rows-per-page" onchange="changeRowsPerPage(this.value)" class="appearance-none pl-3 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-full text-sm bg-white cursor-pointer uppercase">
                                            <option value="5" selected>5 PAPARAN</option>
                                            <option value="10">10 PAPARAN</option>
                                            <option value="15">15 PAPARAN</option>
                                            <option value="30">30 PAPARAN</option>
                                            <option value="50">50 PAPARAN</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </div>
                                    </div>
                                    <div class="relative w-full sm:w-64">
                                        <input type="text" id="search-input" oninput="filterTable()" placeholder="CARI PROGRAM..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-full text-sm uppercase">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card overflow-hidden shadow-lg border border-gray-100">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50" id="table-head">
                                        </thead>
                                    <tbody id="programs-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                </table>
                            </div>
                            
                            <div id="no-data-message" class="hidden text-center py-10">
                                <p class="text-gray-500 uppercase">TIADA REKOD DITEMUI.</p>
                            </div>

                            <div id="pagination-controls" class="px-6 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                                <div class="text-xs text-gray-500 uppercase" id="pagination-info">
                                    Menunjukkan 0 hingga 0 daripada 0 rekod
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="prevPage()" id="btn-prev" class="px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed uppercase">
                                        Sebelumnya
                                    </button>
                                    <button onclick="nextPage()" id="btn-next" class="px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed uppercase">
                                        Seterusnya
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-locked-task" class="hidden">
                         <div class="card p-10 text-center flex flex-col items-center justify-center min-h-[300px] border border-gray-100 shadow-lg">
                            <div class="bg-gray-100 p-5 rounded-full mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 uppercase mb-2">Ciri Ini Dikunci</h3>
                            <p class="text-gray-500 mb-6 text-sm">Ciri SparkTask akan datang tidak lama lagi.</p>
                            <span class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-5 py-2 rounded-full text-xs font-bold uppercase shadow-md tracking-wider">
                                Eksklusif untuk SparkPro
                            </span>
                        </div>
                    </div>

                    <div id="view-planner" class="">
                        <div class="card p-6 bg-white border border-gray-100 shadow-lg">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 uppercase flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                        AKTIVITI SAYA <span id="planner-month-year" class="text-teal-600"></span>
                                    </h3>
                                    <p class="text-xs text-gray-500">Urus dan rancang aktiviti bulanan peribadi anda.</p>
                                </div>
                                
                                <div class="flex items-center gap-2 flex-wrap">
                                    
                                    <button onclick="window.location.href='jadualuser.html'" class="btn bg-purple-100 text-purple-700 hover:bg-purple-200 text-xs font-bold py-2 px-3 rounded-lg shadow-sm uppercase flex items-center gap-2" title="Semak Kalendar Rasmi">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        Kalendar Rasmi
                                    </button>

                                    <button onclick="jumpToToday()" class="btn bg-gray-100 text-gray-600 hover:bg-gray-200 text-xs font-bold py-2 px-3 rounded-lg shadow-sm uppercase">
                                        Hari Ini
                                    </button>

                                    <div class="flex bg-gray-100 rounded-lg p-0.5">
                                        <button onclick="changePlannerMonth(-1)" class="p-1.5 rounded hover:bg-white shadow-sm text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                        <button onclick="changePlannerMonth(1)" class="p-1.5 rounded hover:bg-white shadow-sm text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                                    </div>
                                    <button onclick="clickAddButton()" class="ml-2 btn bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md uppercase flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                        Tambah
                                    </button>
                                </div>
                            </div>
                            
                            <div id="planner-list-container" class="space-y-3 min-h-[300px]">
                                </div>
                        </div>
                    </div>

                </div>

                <div class="lg:col-span-1 space-y-6">
                    
                    <div class="card p-4 border-l-4 border-yellow-500 bg-white">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-sm font-bold text-gray-800 flex items-center gap-1 uppercase">
                                üèÜ SPARK <span class="bg-red-600 text-white px-1.5 py-0.5 rounded text-[10px]">PRO</span>
                            </h3>
                            <span class="text-[10px] font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full uppercase">Sasaran: 100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div id="sparkpro-progress-bar" class="bg-gradient-to-r from-yellow-400 to-yellow-600 h-2 rounded-full progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <p id="progress-remaining" class="text-[10px] text-gray-500 uppercase text-right">Memuatkan...</p>
                    </div>

                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-indigo-700 text-white shadow-lg transform hover:scale-105 transition-all cursor-pointer relative overflow-hidden group" onclick="goToGenerateProgram()">
                        <div class="absolute right-[-20px] top-[-20px] opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div class="flex items-center justify-between relative z-10">
                            <div>
                                <h3 class="text-xl font-extrabold uppercase tracking-wide">Jana Program</h3>
                                <p class="text-xs text-indigo-100 mt-1">Untuk menjana program SPARK</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-full shadow-inner">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 border-t-4 border-red-500 bg-white shadow-lg relative overflow-hidden group">
                        <div class="relative z-10">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Akaun</h3>
                            <button onclick="logout()" class="w-full flex justify-center items-center gap-2 py-2.5 px-4 border border-red-500 text-sm font-bold rounded-lg text-red-600 bg-white hover:bg-red-50 transition-all shadow-sm uppercase">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                Log Keluar
                            </button>
                        </div>
                    </div>

                    <div class="card p-5 border border-gray-200 bg-white">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Komuniti</h3>
                        <p class="text-xs text-gray-600 mb-4">Ada masalah dengan rekod anda?</p>
                        <button onclick="safeNavigate('index.html')" class="btn w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 flex items-center justify-center gap-2 text-sm shadow-sm uppercase">
                            Hubungi Admin
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </main>
    
    <div id="phone-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Lengkapkan Profil Anda</h3>
                <p class="text-sm text-gray-500 mb-6">Sila masukkan nombor telefon anda untuk tujuan keselamatan dan pemulihan akaun di masa hadapan.</p>
                <form onsubmit="savePhoneNumber(event)">
                    <div class="mb-4 text-left">
                        <label for="user-phone" class="block text-sm font-medium text-gray-700 mb-1">No. Telefon</label>
                        <input type="tel" id="user-phone" placeholder="Contoh: 0123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required pattern="[0-9]{9,12}">
                    </div>
                    <button type="submit" id="save-phone-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                        Simpan & Teruskan
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="sector-setup-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase">Kemaskini Profil</h3>
            <p class="text-xs text-gray-500 mb-4">Adakah anda pegawai/staf di Pejabat Pendidikan Daerah (PPD) Miri?</p>
            
            <div id="sector-question-step">
                <div class="flex flex-col gap-2">
                    <button type="button" onclick="showSectorDropdowns()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 uppercase text-sm shadow-sm">
                        Ya, Saya Warga PPD
                    </button>
                    <button type="button" onclick="saveNonPPDUser()" class="w-full bg-white text-gray-700 border border-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 uppercase text-sm">
                        Bukan (Sekolah/Luar)
                    </button>
                </div>
            </div>

            <form id="sector-form-step" onsubmit="saveSector(event)" class="hidden mt-4">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pilih Sektor Anda</label>
                    <select id="user-sector-select" onchange="populateUnits(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-xs uppercase" required>
                        <option value="">-- PILIH SEKTOR --</option>
                        <option value="SEKTOR PERANCANGAN">SEKTOR PERANCANGAN</option>
                        <option value="SEKTOR PEMBELAJARAN">SEKTOR PEMBELAJARAN</option>
                        <option value="SEKTOR PEMBANGUNAN MURID">SEKTOR PEMBANGUNAN MURID</option>
                        <option value="SEKTOR PENTAKSIRAN & PEPERIKSAAN">SEKTOR PENTAKSIRAN & PEPERIKSAAN</option>
                        <option value="SEKTOR PSIKOLOGI & KAUNSELING">SEKTOR PSIKOLOGI & KAUNSELING</option>
                        <option value="SEKTOR PENGURUSAN">SEKTOR PENGURUSAN</option>
                    </select>
                </div>

                <div id="unit-field-container" class="mb-4 hidden">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pilih Unit Anda</label>
                    <select id="user-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-xs uppercase" required>
                        <option value="">-- PILIH UNIT --</option>
                        </select>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="resetSectorModal()" class="w-1/3 bg-gray-200 text-gray-700 font-bold py-2 px-2 rounded-lg hover:bg-gray-300 uppercase text-xs">
                        Kembali
                    </button>
                    <button type="submit" class="w-2/3 bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 uppercase text-sm">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="planner-details-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative m-4 max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('planner-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <h3 class="text-lg font-bold text-gray-800 mb-4 uppercase flex items-center gap-2">
                <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Butiran Program
            </h3>
            
            <div id="planner-details-content" class="space-y-4 text-sm">
                </div>
            
            <div id="planner-actions" class="mt-6 flex flex-wrap justify-end gap-2 border-t border-gray-100 pt-4 hidden">
                </div>
        </div>
    </div>

    <div id="planner-modal-form" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative m-4 max-h-[90vh] overflow-y-auto">
            <button onclick="closePlannerModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <h3 id="planner-modal-title" class="text-lg font-bold text-gray-800 mb-1 uppercase">Rancang Aktiviti</h3>
            <p class="text-xs text-gray-500 mb-4">Masukkan butiran aktiviti anda.</p>
            
            <form onsubmit="savePlannerActivity(event)" class="space-y-4">
                
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nama Program / Aktiviti</label>
                    <input type="text" id="plan-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase" required placeholder="Cth: Mesyuarat PIBG">
                </div>
                
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <input id="is-one-day" type="checkbox" checked onchange="toggleDateRange()" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="is-one-day" class="ml-2 block text-xs font-bold text-gray-700 uppercase">
                            Program Sehari Sahaja?
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input id="is-public-program" type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="is-public-program" class="ml-2 block text-xs font-bold text-indigo-700 uppercase">
                            Paparkan di Takwim Utama?
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh Mula</label>
                        <input type="date" id="plan-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Mula</label>
                        <input type="time" id="plan-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" required>
                    </div>
                </div>

                <div id="single-day-end-time" class="grid grid-cols-2 gap-4">
                    <div></div> <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Tamat</label>
                        <input type="time" id="plan-end-time-single" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                </div>

                <div id="end-date-container" class="grid grid-cols-2 gap-4 hidden bg-gray-50 p-2 rounded border border-gray-200">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tarikh Tamat</label>
                        <input type="date" id="plan-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Masa Tamat</label>
                        <input type="time" id="plan-end-time-multi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Mod Perjumpaan</label>
                        <select id="plan-mode" onchange="toggleMeetingMode()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase">
                            <option value="BERSEMUKA">BERSEMUKA</option>
                            <option value="DALAM TALIAN">DALAM TALIAN</option>
                        </select>
                    </div>
                    <div id="plan-link-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Pautan / Link</label>
                        <input type="text" id="plan-link" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" placeholder="https://...">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Lokasi</label>
                    <input type="text" id="plan-location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase" placeholder="Cth: Bilik Gerakan">
                </div>

                <div class="relative p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-700 uppercase">Peserta</label>
                        
                        <button type="button" onclick="saveCurrentGroup()" class="text-[10px] bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded border border-indigo-200 font-bold uppercase flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                            Simpan List Ini
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <select id="group-selector" onchange="loadGroup(this.value)" class="w-full text-xs border-gray-300 rounded focus:ring-teal-500 focus:border-teal-500 uppercase bg-white py-1.5">
                            <option value="">-- PILIH SENARAI SIMPANAN --</option>
                            </select>
                    </div>

                    <div class="relative">
                        <input type="text" id="participant-search-input" placeholder="Cari nama & tekan..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm uppercase mb-2 bg-white">
                        <div id="participant-dropdown" class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-40 overflow-y-auto hidden"></div>
                    </div>

                    <div id="selected-participants-container" class="flex flex-wrap gap-2 p-2 bg-white border border-gray-200 rounded-md min-h-[50px]">
                        <span class="text-xs text-gray-400 italic self-center">Tiada peserta dipilih.</span>
                    </div>
                    
                    <div class="text-right mt-1">
                         <button type="button" onclick="clearParticipants()" class="text-[10px] text-red-500 hover:text-red-700 underline uppercase">
                            Kosongkan Semua
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Catatan / Minit / Info</label>
                    <textarea id="plan-notes" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm" placeholder="Tampal teks panjang dari Telegram/WhatsApp di sini..."></textarea>
                    
                    <div class="mt-2 p-2 border border-dashed border-gray-300 rounded bg-gray-50">
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Muat Naik Gambar (Pilihan)
                        </label>
                        <input type="file" id="plan-image-file" accept="image/*" onchange="uploadImageToImgBB(this)" class="block w-full text-xs text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                        <input type="hidden" id="plan-image-url">
                        <div id="image-upload-status" class="text-xs text-gray-500 mt-1 italic"></div>
                        <div id="image-preview" class="hidden mt-2">
                             <img src="" alt="Preview" class="max-h-[150px] rounded border border-gray-200">
                             <button type="button" onclick="clearImage()" class="text-[10px] text-red-500 underline mt-1">Padam Gambar</button>
                        </div>
                    </div>
                </div>

                <button type="submit" id="btn-save-plan" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition shadow-md uppercase text-sm mt-2">
                    Simpan Aktiviti
                </button>
            </form>
        </div>
    </div>

    <footer class="text-center py-4 mt-8 border-t border-gray-200 bg-white"><p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p><p id="version-info" class="text-xs text-gray-500"></p></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setDoc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let currentUserIc = "";
        let currentUserSector = ""; 
        let currentUserUnit = ""; 
        
        let attendanceList = [];
        let createdList = [];
        let taskList = [];
        let allProgramsList = [];
        let plannerList = [];
        
        let allUsersData = []; 
        let selectedParticipants = []; 
        let mySavedGroups = []; 
        
        let filteredResults = []; 
        let currentPage = 1;
        let rowsPerPage = 5; 
        
        let participantDocId = null;
        let currentTab = 'planner'; 
        let currentCalendarDate = new Date();
        let currentPlannerDate = new Date();
        
        let editingPlannerId = null;

        // DATA: Unit per Sektor
        const sectorUnitData = {
            "SEKTOR PERANCANGAN": [
                "UNIT PERANCANGAN DAN PENGURUSAN PPD",
                "UNIT PENGURUSAN MAKLUMAT (ICT)",
                "UNIT DATA DAN MAKLUMAT"
            ],
            "SEKTOR PEMBELAJARAN": [
                "UNIT BAHASA",
                "UNIT SAINS DAN MATEMATIK",
                "UNIT TVET",
                "UNIT SAINS SOSIAL & KEMANUSIAAN",
                "UNIT PENDIDIKAN ISLAM",
                "UNIT PENDIDIKAN KHAS",
                "UNIT PEMULIHAN KHAS",
                "UNIT SUMBER PENDIDIKAN"
            ],
            "SEKTOR PEMBANGUNAN MURID": [
                "UNIT HAL EHWAL MURID",
                "UNIT PEMBANGUNAN BAKAT MURID"
            ],
            "SEKTOR PENTAKSIRAN & PEPERIKSAAN": [
                "UNIT PENTAKSIRAN & PEPERIKSAAN"
            ],
            "SEKTOR PSIKOLOGI & KAUNSELING": [
                "UNIT PSIKOLOGI & KAUNSELING"
            ],
            "SEKTOR PENGURUSAN": [
                "UNIT PENTADBIRAN DAN KUMPULAN SOKONGAN",
                "UNIT KEWANGAN DAN AKAUN",
                "UNIT INFRASTRUKTUR DAN PEROLEHAN",
                 "UNIT ICT"
            ]
        };

        // AUTH & SESSION
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlIc = urlParams.get('ic');
                let storedIc = localStorage.getItem('user_ic');

                if (urlIc) {
                    storedIc = urlIc.trim();
                    localStorage.setItem('user_ic', storedIc);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                if (storedIc) {
                    currentUserIc = storedIc;
                    loadUserData(currentUserIc);
                } else {
                    const input = prompt("Sesi tamat atau tiada data. Sila masukkan No. IC anda:");
                    if (input) {
                        currentUserIc = input.trim().replace(/[^0-9]/g, '');
                        if (currentUserIc) {
                            localStorage.setItem('user_ic', currentUserIc); 
                            loadUserData(currentUserIc);
                        } else {
                            alert("No. IC tidak sah.");
                            window.location.href = 'index.html';
                        }
                    } else {
                        window.location.href = 'index.html';
                    }
                }
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        const normalizeIc = (val) => String(val).replace(/[^0-9]/g, '');

        function formatIc(ic) {
            if (ic && ic.length >= 10) {
                return "******-**-" + ic.slice(-4);
            }
            return ic;
        }

        async function loadUserData(ic) {
            try {
                const cleanUserIc = normalizeIc(ic);
                
                // Fetch User Profile
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const qUser = query(usersRef, where("ic", "==", cleanUserIc));
                const userSnap = await getDocs(qUser);
                
                let profileImageUrl = null;

                if (!userSnap.empty) {
                    const userData = userSnap.docs[0].data();
                    participantDocId = userSnap.docs[0].id;
                    currentUserSector = userData.sector || "";
                    currentUserUnit = userData.unit || ""; 
                    profileImageUrl = userData.profileImageUrl || null;
                }
                
                // Handle Profile Image UI
                const defaultIcon = document.getElementById('default-profile-icon');
                const userImage = document.getElementById('user-profile-image');
                
                if (profileImageUrl) {
                    userImage.src = profileImageUrl;
                    userImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                } else {
                    userImage.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                }
                
                // Handle Sector/Unit Display
                const sectorUnitEl = document.getElementById('user-sector-unit');
                const sectorTextEl = document.getElementById('sector-text');
                
                if (currentUserSector) {
                    let displayTxt = currentUserSector;
                    if (currentUserUnit && currentUserUnit !== '-') {
                        displayTxt += ` | ${currentUserUnit.replace("UNIT ", "")}`;
                    }
                    sectorTextEl.textContent = displayTxt;
                    sectorUnitEl.classList.remove('hidden');
                } else {
                    sectorUnitEl.classList.add('hidden');
                }

                const programsRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
                const programsSnapshot = await getDocs(programsRef);

                const tasksRef = collection(db, `artifacts/${appId}/public/data/spark_tasks`);
                const tasksSnapshot = await getDocs(tasksRef);
                
                // Fetch Planner Data
                const plannerRef = collection(db, `artifacts/${appId}/public/data/spark_planner`);
                const qOwn = query(plannerRef, where("ic", "==", cleanUserIc));
                const qTagged = query(plannerRef, where("taggedIcs", "array-contains", cleanUserIc));

                const [ownSnap, taggedSnap] = await Promise.all([getDocs(qOwn), getDocs(qTagged)]);

                const plannerMap = new Map();
                ownSnap.forEach(doc => plannerMap.set(doc.id, { id: doc.id, ...doc.data() }));
                taggedSnap.forEach(doc => plannerMap.set(doc.id, { id: doc.id, ...doc.data() }));
                plannerList = Array.from(plannerMap.values());

                const usersSnapshot = await getDocs(usersRef);
                allUsersData = [];
                usersSnapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.ic) {
                        allUsersData.push({ 
                            name: d.name.toUpperCase(), 
                            ic: normalizeIc(d.ic) 
                        });
                    }
                });
                
                const groupsRef = collection(db, `artifacts/${appId}/public/data/spark_user_groups`);
                const qGroups = query(groupsRef, where("ownerIc", "==", cleanUserIc));
                const groupSnap = await getDocs(qGroups);
                mySavedGroups = [];
                groupSnap.forEach(doc => {
                    mySavedGroups.push({ id: doc.id, ...doc.data() });
                });
                updateGroupDropdown();

                attendanceList = [];
                createdList = [];
                taskList = [];
                allProgramsList = [];
                
                let participantData = null;
                
                document.getElementById('edit-profile-btn').href = `edit.html?ic=${cleanUserIc}`;

                programsSnapshot.forEach(programDoc => {
                    const programData = programDoc.data();
                    const attendanceArray = programData.attendance || [];
                    allProgramsList.push(programData);
                    
                    const pData = attendanceArray.find(p => normalizeIc(p.ic) === cleanUserIc);
                    if (pData) {
                        if (!participantData) participantData = pData;
                        attendanceList.push({ programData, participantData: pData });
                    }

                    const progAdminIc = programData.admin_ic ? normalizeIc(programData.admin_ic) : '';
                    const progCreatedBy = programData.createdBy ? normalizeIc(programData.createdBy) : '';
                    const progPenganjurIc = programData.ic_penganjur ? normalizeIc(programData.ic_penganjur) : '';
                    const progPenyelarasIc = programData.penyelaras_ic ? normalizeIc(programData.penyelaras_ic) : '';
                    const progIcPenyelaras = programData.ic_penyelaras ? normalizeIc(programData.ic_penyelaras) : '';

                    if (progCreatedBy === cleanUserIc || 
                        progAdminIc === cleanUserIc || 
                        progPenganjurIc === cleanUserIc ||
                        progPenyelarasIc === cleanUserIc ||
                        progIcPenyelaras === cleanUserIc) {
                        createdList.push({ programData, participantData: null });
                    }
                });

                tasksSnapshot.forEach(taskDoc => {
                     const taskData = taskDoc.data();
                     const taskCreator = taskData.createdBy ? normalizeIc(taskData.createdBy) : '';
                     const taskPegawaiIc = taskData.ic_pegawai ? normalizeIc(taskData.ic_pegawai) : '';
                     
                     if (taskCreator === cleanUserIc || taskPegawaiIc === cleanUserIc) {
                         taskList.push({ id: taskDoc.id, ...taskData });
                     }
                });

                if (participantData) {
                    document.getElementById('user-name').textContent = participantData.name.toUpperCase();
                    document.getElementById('user-ic').textContent = formatIc(participantData.ic);
                    document.getElementById('user-org').textContent = (participantData.station || participantData.org || "-").toUpperCase();
                    checkPhoneNumber(participantData);
                } else {
                    document.getElementById('user-name').textContent = "TIADA REKOD";
                    document.getElementById('user-ic').textContent = formatIc(ic);
                    document.getElementById('user-org').textContent = "-";
                    checkPhoneNumber({ ic: ic }); 
                }
                
                const totalPrograms = attendanceList.length + createdList.length + taskList.length;
                document.getElementById('total-programs-count').textContent = totalPrograms;
                
                updateInfographics(totalPrograms);
                switchTab('planner'); 
                setupParticipantSearch();

            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Gagal memuatkan data. Sila cuba lagi.");
            }
        }
        
        function updateInfographics(total) {
            const target = 100;
            const percentage = Math.min((total / target) * 100, 100);
            const progressBar = document.getElementById('sparkpro-progress-bar');
            progressBar.style.width = `${percentage}%`;
            const remaining = Math.max(target - total, 0);
            const remainingEl = document.getElementById('progress-remaining');
            
            if (remaining === 0) {
                 remainingEl.innerHTML = `TAHNIAH! ANDA SPARK <span class="bg-red-600 text-white px-1 py-0.5 rounded text-[9px] ml-1">PRO</span>`;
                 remainingEl.classList.remove('text-gray-500');
                 remainingEl.classList.add('text-green-600', 'font-bold');
            } else {
                 remainingEl.innerHTML = `${remaining} LAGI UNTUK SPARK <span class="bg-red-600 text-white px-1 rounded text-[9px] align-middle">PRO</span>`;
            }
        }

        window.goToGenerateProgram = function() {
            if (currentUserIc) {
                window.location.href = `semak.html?ic=${currentUserIc}`;
            } else {
                window.location.href = 'semak.html';
            }
        }

        window.triggerProfileUpload = function() {
            document.getElementById('profile-upload-input').click();
        }

        window.handleProfileImageUpload = async function(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const loading = document.getElementById('profile-loading');
            const overlay = document.querySelector('.profile-overlay');
            loading.classList.remove('hidden');
            overlay.classList.add('hidden'); 

            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('https://api.imgbb.com/1/upload?key=a7c600ac733fe14649cacd8e65619c4b', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const imageUrl = data.data.url;
                    
                    if (participantDocId) {
                        const userDocRef = doc(db, `artifacts/${appId}/public/data/spark_participants`, participantDocId);
                        await updateDoc(userDocRef, { profileImageUrl: imageUrl });
                        
                        const userImage = document.getElementById('user-profile-image');
                        const defaultIcon = document.getElementById('default-profile-icon');
                        
                        userImage.src = imageUrl;
                        userImage.classList.remove('hidden');
                        defaultIcon.classList.add('hidden');
                        
                        inputElement.value = "";
                    } else {
                        throw new Error("User record not found to update.");
                    }

                } else {
                    throw new Error("Gagal memuat naik ke ImgBB.");
                }
            } catch (error) {
                console.error("Profile Upload Error:", error);
                alert("Gagal menukar gambar profil. Sila cuba lagi.");
            } finally {
                loading.classList.add('hidden');
                overlay.classList.remove('hidden');
            }
        }
        
        window.switchTab = function(tabName) {
            currentTab = tabName;
            currentPage = 1;
            
            const tabA = document.getElementById('tab-attendance');
            const tabC = document.getElementById('tab-created');
            const tabTasks = document.getElementById('tab-tasks');
            const tabP = document.getElementById('tab-planner');
            
            const activeClass = "nav-tab active";
            const inactiveClass = "nav-tab";
            
            tabA.className = inactiveClass;
            tabC.className = inactiveClass;
            tabTasks.className = inactiveClass;
            tabP.className = inactiveClass;
            
            document.getElementById('view-table').classList.add('hidden');
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-locked-task').classList.add('hidden');

            if (tabName === 'attendance') {
                tabA.className = activeClass;
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "SENARAI KEHADIRAN";
                filteredResults = [...attendanceList];
                filteredResults.sort((a, b) => new Date(b.programData.startDate) - new Date(a.programData.startDate));
                renderTableHeader();
                renderTable();
            } else if (tabName === 'created') {
                tabC.className = activeClass;
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "PROGRAM DIJANA OLEH SAYA";
                filteredResults = [...createdList];
                filteredResults.sort((a, b) => new Date(b.programData.startDate) - new Date(a.programData.startDate));
                renderTableHeader();
                renderTable();
            } else if (tabName === 'tasks') {
                // LOCK SPARK TASK
                tabTasks.className = activeClass;
                document.getElementById('view-locked-task').classList.remove('hidden');
            } else {
                // Default to Planner
                tabP.className = activeClass;
                document.getElementById('view-planner').classList.remove('hidden');
                renderPlannerList(); 
            }
        }

        function renderTableHeader() {
            const thead = document.getElementById('table-head');
            let html = `
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-10">BIL</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">NAMA ITEM</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">TARIKH & LOKASI/STATUS</th>
            `;
            if (currentTab === 'attendance') {
                html += `<th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">STATUS</th>`;
            } else {
                html += `<th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-20">PAUTAN</th>`;
            }
            html += `</tr>`;
            thead.innerHTML = html;
        }

        function renderTable() {
            const tbody = document.getElementById('programs-table-body');
            const noDataMsg = document.getElementById('no-data-message');
            tbody.innerHTML = '';
            if (filteredResults.length === 0) {
                noDataMsg.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
                document.getElementById('pagination-controls').classList.remove('hidden');
            }
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredResults.slice(startIndex, endIndex);
            paginatedData.forEach((item, index) => {
                const row = createTableRow(item, startIndex + index);
                tbody.innerHTML += row;
            });
            updatePaginationInfo();
        }

        function createTableRow(result, index) {
            let lastColumnHTML = '';
            let name = '';
            let dateStr = '';
            let metaInfo = '';

            if (currentTab === 'tasks') {
               // Logic disabled due to lock
            } else {
                const { programData } = result;
                name = programData.name;
                const startDateStr = programData.startDate ? new Date(programData.startDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
                dateStr = startDateStr;
                metaInfo = programData.location || 'DALAM TALIAN';

                if (currentTab === 'attendance') {
                    lastColumnHTML = `<td class="px-6 py-4 whitespace-nowrap text-center"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 uppercase">HADIR</span></td>`;
                } else {
                    const link = `program.html?kod=${programData.key}`;
                    const tooltip = currentTab === 'created' ? "URUS PROGRAM" : "LIHAT BUTIRAN";
                    lastColumnHTML = `<td class="px-6 py-4 whitespace-nowrap text-center"><a href="${link}" class="inline-flex items-center justify-center p-2 rounded-full text-indigo-600 hover:bg-indigo-50 transition-colors group" title="${tooltip}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a></td>`;
                }
            }
            return `<tr class="hover:bg-gray-50 transition-colors"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}.</td><td class="px-6 py-4"><div class="text-sm font-semibold text-gray-900 uppercase">${name.toUpperCase()}</div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 uppercase"><div class="font-medium text-gray-900">${dateStr.toUpperCase()}</div><div class="text-xs text-gray-500">${metaInfo.toUpperCase()}</div></td>${lastColumnHTML}</tr>`;
        }
        
        window.changePlannerMonth = function(offset) {
            currentPlannerDate.setMonth(currentPlannerDate.getMonth() + offset);
            renderPlannerList();
        }

        window.jumpToToday = function() {
            currentPlannerDate = new Date();
            renderPlannerList();
        }

        // ===== KEMASKINI LOGIK RENDER PLANNER (HARI & COUNTDOWN) =====
        window.renderPlannerList = function() {
            const date = currentPlannerDate;
            const month = date.getMonth();
            const year = date.getFullYear();
            const monthNames = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            document.getElementById('planner-month-year').textContent = `${monthNames[month]} ${year}`;
            
            const container = document.getElementById('planner-list-container');
            container.innerHTML = '';

            const filteredEvents = plannerList.filter(p => {
                const pDate = new Date(p.startDate);
                return pDate.getMonth() === month && pDate.getFullYear() === year;
            }).sort((a, b) => new Date(a.startDate + 'T' + (a.startTime || '00:00')) - new Date(b.startDate + 'T' + (b.startTime || '00:00')));

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 flex flex-col items-center justify-center opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="text-gray-500 text-sm italic">Tiada aktiviti dirancang untuk bulan ini.</p>
                    </div>
                `;
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);
            const todayStr = today.toISOString().split('T')[0];

            filteredEvents.forEach(ev => {
                const startDateObj = new Date(ev.startDate);
                const day = startDateObj.getDate();
                const monthShort = startDateObj.toLocaleDateString('ms-MY', { month: 'short' }).toUpperCase();
                const dayName = startDateObj.toLocaleDateString('ms-MY', { weekday: 'long' }).toUpperCase();
                
                const eventDate = new Date(ev.startDate);
                eventDate.setHours(0,0,0,0);
                
                const diffTime = eventDate - today; 
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                let countdownBadge = '';
                let borderClass = 'border-l-4 border-l-transparent bg-gray-50';

                if (diffDays === 0) {
                    countdownBadge = '<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-green-100 text-green-700 uppercase whitespace-nowrap border border-green-200">HARI INI</span>';
                    borderClass = 'border-l-4 border-l-green-500 bg-green-50';
                } else if (diffDays === 1) {
                    countdownBadge = '<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-blue-100 text-blue-700 uppercase whitespace-nowrap border border-blue-200">ESOK</span>';
                    borderClass = 'border-l-4 border-l-blue-400 bg-blue-50';
                } else if (diffDays > 1) {
                    countdownBadge = `<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-gray-200 text-gray-600 uppercase whitespace-nowrap">${diffDays} HARI LAGI</span>`;
                } else {
                    countdownBadge = '<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-gray-100 text-gray-400 uppercase whitespace-nowrap">SELESAI</span>';
                    borderClass = 'border-l-4 border-l-gray-300 bg-gray-100 opacity-75';
                }
                
                let timeDisplay = ev.startTime || '';
                if (ev.endTime) timeDisplay += ` - ${ev.endTime}`;
                if (!timeDisplay) timeDisplay = "SEPANJANG HARI";
                
                let showNewLabel = false;
                if (ev.createdAt) {
                    const createdDate = ev.createdAt.toDate ? ev.createdAt.toDate() : new Date(ev.createdAt);
                    const now = new Date();
                    const diffHours = (now - createdDate) / (1000 * 60 * 60);
                    if (diffHours < 24) showNewLabel = true;
                }

                const isMyEvent = ev.ic === currentUserIc;
                const tagLabel = isMyEvent ? '' : '<span class="text-[9px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded uppercase ml-2 border border-purple-200">DITAG</span>';

                const item = document.createElement('div');
                item.className = `flex flex-row p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer mb-3 ${borderClass}`;
                item.innerHTML = `
                    <div class="flex flex-col items-center justify-center pr-3 border-r border-gray-200 min-w-[70px]">
                        <span class="text-[10px] font-bold text-gray-500 uppercase leading-none mb-1">${dayName}</span>
                        <span class="text-2xl font-bold text-gray-800 leading-none">${day}</span>
                        <span class="text-[10px] font-bold text-gray-400 uppercase mt-1">${monthShort}</span>
                    </div>
                    <div class="pl-3 flex-grow overflow-hidden">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex items-center flex-wrap gap-1">
                                <h4 class="text-sm font-bold text-gray-800 uppercase truncate leading-tight">${ev.title}</h4>
                                ${tagLabel}
                            </div>
                            <div class="ml-2 flex-shrink-0">
                                ${countdownBadge}
                            </div>
                        </div>
                        
                        <p class="text-xs text-teal-600 font-semibold uppercase flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ${timeDisplay}
                        </p>
                        
                        <div class="mt-1 text-xs text-gray-500 flex items-center gap-1 truncate">
                            ${ev.location ? `
                                <svg class="w-3 h-3 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> 
                                <span class="uppercase truncate">${ev.location}</span>
                            ` : ''}
                        </div>
                    </div>
                `;
                item.onclick = () => showPlannerDetails(ev);
                container.appendChild(item);
            });
        }

        window.showPlannerDetails = function(eventData) {
            const modal = document.getElementById('planner-details-modal');
            const content = document.getElementById('planner-details-content');
            const actions = document.getElementById('planner-actions');
            
            const startDateFormatted = new Date(eventData.startDate).toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            let endDateFormatted = '';
            if (eventData.endDate && eventData.endDate !== eventData.startDate) {
                endDateFormatted = new Date(eventData.endDate).toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }

            content.innerHTML = `
                <div class="mb-4 pb-4 border-b border-gray-100">
                    <h2 class="text-xl font-extrabold text-gray-900 uppercase leading-snug">${eventData.title}</h2>
                    ${eventData.ic !== currentUserIc ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded uppercase font-bold mt-1 inline-block">PROGRAM DITAG (DARI ORANG LAIN)</span>' : ''}
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Tarikh</p>
                        <p class="font-medium text-gray-800 uppercase">${startDateFormatted} ${endDateFormatted ? ' - <br>' + endDateFormatted : ''}</p>
                    </div>
                    
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Masa</p>
                        <p class="font-medium text-gray-800 uppercase">
                            ${eventData.startTime || 'TIADA'} - ${eventData.endTime || 'TIADA'}
                        </p>
                    </div>

                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Mod Perjumpaan</p>
                        <p class="font-medium text-gray-800 uppercase">${eventData.mode || 'BERSEMUKA'}</p>
                        ${eventData.link ? `<a href="${eventData.link}" target="_blank" class="text-blue-600 hover:underline text-xs block mt-1 truncate">${eventData.link}</a>` : ''}
                    </div>

                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Lokasi</p>
                        <p class="font-medium text-gray-800 uppercase">${eventData.location || '-'}</p>
                    </div>

                    ${eventData.notes || eventData.imageUrl ? `
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Catatan / Minit / Info</p>
                        ${eventData.imageUrl ? `<img src="${eventData.imageUrl}" class="w-full rounded mb-3 border border-gray-200 shadow-sm" alt="Gambar Aktiviti">` : ''}
                        <div class="text-gray-700 text-sm whitespace-pre-wrap leading-relaxed font-normal">${eventData.notes || 'Tiada catatan.'}</div>
                    </div>` : ''}

                    ${eventData.participants ? `
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Peserta Terlibat</p>
                        <div class="flex flex-wrap gap-1">
                            ${eventData.participants.split(',').map(p => `<span class="bg-teal-50 text-teal-700 px-2 py-1 rounded text-xs border border-teal-100">${p.trim()}</span>`).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
            
            actions.innerHTML = '';
            actions.classList.remove('hidden');

            if (eventData.ic === currentUserIc) {
                const btnSpark = document.createElement('button');
                btnSpark.className = "flex-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded uppercase shadow-md flex justify-center items-center gap-2";
                btnSpark.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> JANA SPARK`;
                btnSpark.onclick = () => {
                    convertToSpark(eventData);
                };
                actions.appendChild(btnSpark);

                const btnEdit = document.createElement('button');
                btnEdit.className = "text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded uppercase";
                btnEdit.textContent = "UBAH";
                btnEdit.onclick = () => {
                    modal.classList.add('hidden');
                    openPlannerModal(null, null, eventData); 
                };
                
                const btnDelete = document.createElement('button');
                btnDelete.className = "text-xs bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 px-4 rounded uppercase";
                btnDelete.textContent = "PADAM";
                btnDelete.onclick = () => {
                    if(confirm("Adakah anda pasti mahu memadam aktiviti ini?")) {
                        deletePlannerActivity(eventData.id);
                        modal.classList.add('hidden');
                    }
                };
                
                actions.appendChild(btnEdit);
                actions.appendChild(btnDelete);
            }

            modal.classList.remove('hidden');
        }

        window.deletePlannerActivity = async function(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_planner`, id));
                plannerList = plannerList.filter(p => p.id !== id);
                renderPlannerList();
                alert("Aktiviti berjaya dipadam.");
            } catch (err) {
                console.error("Error deleting:", err);
                alert("Gagal memadam.");
            }
        }

        window.convertToSpark = function(data) {
            localStorage.setItem('spark_import_data', JSON.stringify(data));
            window.location.href = 'tukarspark.html';
        }

        window.clickAddButton = function() {
            if (!currentUserSector || !currentUserUnit) {
                // OPEN NEW MODAL STYLE
                document.getElementById('sector-setup-modal').classList.remove('hidden');
                document.getElementById('sector-question-step').classList.remove('hidden');
                document.getElementById('sector-form-step').classList.add('hidden');
            } else {
                openPlannerModal();
            }
        }

        // ===== FUNGSI PENGURUSAN SEKTOR/UNIT BARU =====
        window.showSectorDropdowns = function() {
            document.getElementById('sector-question-step').classList.add('hidden');
            document.getElementById('sector-form-step').classList.remove('hidden');
        }

        window.resetSectorModal = function() {
            document.getElementById('sector-question-step').classList.remove('hidden');
            document.getElementById('sector-form-step').classList.add('hidden');
        }

        window.populateUnits = function(sector) {
            const unitSelect = document.getElementById('user-unit-select');
            const unitContainer = document.getElementById('unit-field-container');
            
            unitSelect.innerHTML = '<option value="">-- PILIH UNIT --</option>';
            
            if (sector && sectorUnitData[sector]) {
                sectorUnitData[sector].forEach(unit => {
                    const opt = document.createElement('option');
                    opt.value = unit;
                    opt.textContent = unit;
                    unitSelect.appendChild(opt);
                });
                unitContainer.classList.remove('hidden');
            } else {
                unitContainer.classList.add('hidden');
            }
        }

        window.saveSector = async function(e) {
            e.preventDefault();
            const sector = document.getElementById('user-sector-select').value;
            const unit = document.getElementById('user-unit-select').value;
            
            if(!sector || !unit) return alert("Sila pilih Sektor dan Unit!");

            try {
                if (participantDocId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, participantDocId), { 
                        sector: sector,
                        unit: unit 
                    });
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_participants`), {
                        ic: currentUserIc,
                        name: document.getElementById('user-name').textContent,
                        sector: sector,
                        unit: unit
                    });
                }
                currentUserSector = sector;
                currentUserUnit = unit;
                document.getElementById('sector-setup-modal').classList.add('hidden');
                
                // Update UI Display immediately
                const sectorUnitEl = document.getElementById('user-sector-unit');
                const sectorTextEl = document.getElementById('sector-text');
                sectorTextEl.textContent = `${sector} | ${unit.replace("UNIT ", "")}`;
                sectorUnitEl.classList.remove('hidden');

                openPlannerModal();
            } catch (err) {
                console.error("Error saving sector:", err);
                alert("Gagal menyimpan data.");
            }
        }

        window.saveNonPPDUser = async function() {
            try {
                const sector = "BUKAN PPD";
                const unit = "-";

                if (participantDocId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_participants`, participantDocId), { 
                        sector: sector,
                        unit: unit 
                    });
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/spark_participants`), {
                        ic: currentUserIc,
                        name: document.getElementById('user-name').textContent,
                        sector: sector,
                        unit: unit
                    });
                }
                currentUserSector = sector;
                currentUserUnit = unit;
                document.getElementById('sector-setup-modal').classList.add('hidden');
                openPlannerModal();
            } catch (err) {
                console.error("Error saving non-ppd:", err);
                alert("Ralat sistem. Sila cuba lagi.");
            }
        }

        window.toggleMeetingMode = function() {
            const mode = document.getElementById('plan-mode').value;
            const linkContainer = document.getElementById('plan-link-container');
            
            if (mode === 'DALAM TALIAN') {
                linkContainer.classList.remove('hidden');
            } else {
                linkContainer.classList.add('hidden');
            }
        }

        window.toggleDateRange = function() {
            const isOneDay = document.getElementById('is-one-day').checked;
            const endDateContainer = document.getElementById('end-date-container');
            const singleDayEndTime = document.getElementById('single-day-end-time');
            
            if (isOneDay) {
                endDateContainer.classList.add('hidden');
                singleDayEndTime.classList.remove('hidden');
            } else {
                endDateContainer.classList.remove('hidden');
                singleDayEndTime.classList.add('hidden');
            }
        }

        function setupParticipantSearch() {
            const input = document.getElementById('participant-search-input');
            const dropdown = document.getElementById('participant-dropdown');

            input.addEventListener('input', function(e) {
                const query = e.target.value.toUpperCase();
                dropdown.innerHTML = '';
                
                if (query.length < 2) {
                    dropdown.classList.add('hidden');
                    return;
                }

                const matches = allUsersData.filter(u => 
                    u.name.includes(query) && 
                    !selectedParticipants.some(sel => sel.ic === u.ic)
                ).slice(0, 10);

                if (matches.length > 0) {
                    dropdown.classList.remove('hidden');
                    matches.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-teal-50 cursor-pointer text-xs font-medium text-gray-700 border-b border-gray-100 last:border-0';
                        div.textContent = user.name;
                        div.onclick = () => {
                            addParticipant(user);
                            input.value = '';
                            dropdown.classList.add('hidden');
                        };
                        dropdown.appendChild(div);
                    });
                } else {
                    dropdown.classList.add('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function addParticipant(user) {
            if (!selectedParticipants.some(p => p.ic === user.ic)) {
                selectedParticipants.push(user);
                renderSelectedParticipants();
            }
        }

        window.clearParticipants = function() {
            selectedParticipants = [];
            renderSelectedParticipants();
        }
        
        window.removeParticipant = function(index) {
            selectedParticipants.splice(index, 1);
            renderSelectedParticipants();
        }

        function renderSelectedParticipants() {
            const container = document.getElementById('selected-participants-container');
            container.innerHTML = '';

            if (selectedParticipants.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic self-center">Tiada peserta dipilih.</span>';
                return;
            }

            selectedParticipants.forEach((user, index) => {
                const tag = document.createElement('div');
                tag.className = 'flex items-center gap-1 bg-teal-100 text-teal-800 px-2 py-1 rounded-full text-[10px] font-bold border border-teal-200 shadow-sm';
                tag.innerHTML = `
                    <span>${user.name}</span>
                    <button type="button" onclick="removeParticipant(${index})" class="text-teal-600 hover:text-red-500 ml-1 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.243a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                container.appendChild(tag);
            });
        }

        function updateGroupDropdown() {
            const select = document.getElementById('group-selector');
            select.innerHTML = '<option value="">-- PILIH SENARAI SIMPANAN --</option>';
            mySavedGroups.forEach(grp => {
                const opt = document.createElement('option');
                opt.value = grp.id;
                opt.textContent = grp.groupName.toUpperCase();
                select.appendChild(opt);
            });
        }

        window.loadGroup = function(groupId) {
            if (!groupId) return;
            const group = mySavedGroups.find(g => g.id === groupId);
            if (group && group.members) {
                group.members.forEach(member => {
                    if (!selectedParticipants.some(p => p.ic === member.ic)) {
                        selectedParticipants.push(member);
                    }
                });
                renderSelectedParticipants();
                document.getElementById('group-selector').value = "";
            }
        }

        window.saveCurrentGroup = async function() {
            if (selectedParticipants.length === 0) {
                alert("Sila pilih sekurang-kurangnya seorang peserta untuk disimpan.");
                return;
            }
            const groupName = prompt("Namakan Senarai/Kumpulan ini (Contoh: AJK PIBG):");
            if (!groupName) return; 

            try {
                const newGroup = {
                    ownerIc: currentUserIc,
                    groupName: groupName.toUpperCase(),
                    members: selectedParticipants, 
                    createdAt: new Date()
                };
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_user_groups`), newGroup);
                mySavedGroups.push({ id: docRef.id, ...newGroup });
                updateGroupDropdown();
                alert(`Senarai "${groupName}" berjaya disimpan!`);
            } catch (error) {
                console.error("Error saving group:", error);
                alert("Gagal menyimpan senarai.");
            }
        }

        window.uploadImageToImgBB = async function(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('image-upload-status');
            const previewDiv = document.getElementById('image-preview');
            const urlInput = document.getElementById('plan-image-url');

            statusDiv.textContent = "Memuat naik gambar...";
            statusDiv.classList.remove("text-red-500", "text-green-500");
            statusDiv.classList.add("text-blue-500");

            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('https://api.imgbb.com/1/upload?key=a7c600ac733fe14649cacd8e65619c4b', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const imageUrl = data.data.url;
                    urlInput.value = imageUrl;
                    
                    previewDiv.classList.remove('hidden');
                    previewDiv.querySelector('img').src = imageUrl;

                    statusDiv.textContent = "Gambar berjaya dimuat naik.";
                    statusDiv.classList.remove("text-blue-500");
                    statusDiv.classList.add("text-green-500");
                } else {
                    throw new Error("Gagal memuat naik.");
                }
            } catch (error) {
                console.error("ImgBB Error:", error);
                statusDiv.textContent = "Gagal memuat naik gambar.";
                statusDiv.classList.remove("text-blue-500");
                statusDiv.classList.add("text-red-500");
                inputElement.value = ""; 
            }
        }

        window.clearImage = function() {
            document.getElementById('plan-image-file').value = "";
            document.getElementById('plan-image-url').value = "";
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-upload-status').textContent = "";
        }

        window.openPlannerModal = function(dateStr = '', existingEvents = [], editData = null) {
            const formModal = document.getElementById('planner-modal-form');
            const titleLabel = document.getElementById('planner-modal-title');
            const btnSave = document.getElementById('btn-save-plan');
            
            if (editData) {
                editingPlannerId = editData.id;
                titleLabel.textContent = "KEMASKINI AKTIVITI";
                btnSave.textContent = "KEMASKINI";
                
                document.getElementById('plan-title').value = editData.title;
                document.getElementById('plan-location').value = editData.location;
                // Don't uppercase notes to preserve user typing
                document.getElementById('plan-notes').value = editData.notes || "";
                document.getElementById('is-public-program').checked = editData.isPublic;
                document.getElementById('plan-mode').value = editData.mode || "BERSEMUKA";
                document.getElementById('plan-link').value = editData.link || "";
                
                // Handle Image
                const imgUrl = editData.imageUrl || "";
                document.getElementById('plan-image-url').value = imgUrl;
                if(imgUrl) {
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('image-preview').querySelector('img').src = imgUrl;
                } else {
                    document.getElementById('image-preview').classList.add('hidden');
                }
                
                document.getElementById('plan-start-date').value = editData.startDate;
                document.getElementById('plan-start-time').value = editData.startTime;
                
                const isOneDay = editData.isOneDay;
                document.getElementById('is-one-day').checked = isOneDay;
                
                if (isOneDay) {
                    document.getElementById('plan-end-time-single').value = editData.endTime;
                } else {
                    document.getElementById('plan-end-date').value = editData.endDate;
                    document.getElementById('plan-end-time-multi').value = editData.endTime;
                }
                
                selectedParticipants = [];
                if(editData.taggedIcs && editData.taggedIcs.length > 0) {
                     editData.taggedIcs.forEach(ic => {
                         const user = allUsersData.find(u => u.ic === ic);
                         if(user) selectedParticipants.push(user);
                     });
                } else if (editData.participants) {
                    editData.participants.split(',').forEach(pName => {
                        if(pName.trim()) selectedParticipants.push({name: pName.trim(), ic: 'unknown'});
                    });
                }
                renderSelectedParticipants();

            } else {
                editingPlannerId = null;
                titleLabel.textContent = "RANCANG AKTIVITI";
                btnSave.textContent = "SIMPAN AKTIVITI";
                
                document.getElementById('plan-title').value = '';
                document.getElementById('plan-location').value = '';
                document.getElementById('plan-notes').value = '';
                document.getElementById('participant-search-input').value = '';
                document.getElementById('participant-dropdown').innerHTML = '';
                document.getElementById('is-public-program').checked = false;
                
                document.getElementById('plan-mode').value = "BERSEMUKA";
                document.getElementById('plan-link').value = "";
                
                clearImage();
                
                document.getElementById('is-one-day').checked = true;
                
                selectedParticipants = [];
                const myName = document.getElementById('user-name').textContent;
                if(myName !== "TIADA REKOD") {
                     selectedParticipants.push({ name: myName, ic: currentUserIc });
                }
                renderSelectedParticipants();

                const todayStr = new Date().toISOString().split('T')[0];
                const targetDate = dateStr || todayStr;

                document.getElementById('plan-start-date').value = targetDate;
                document.getElementById('plan-end-date').value = targetDate; // Default
                document.getElementById('plan-start-time').value = "08:00";
                document.getElementById('plan-end-time-single').value = "17:00";
                document.getElementById('plan-end-time-multi').value = "17:00";
            }
            
            toggleDateRange();
            toggleMeetingMode();
            formModal.classList.remove('hidden');
        }

        window.closePlannerModal = function() {
            document.getElementById('planner-modal-form').classList.add('hidden');
        }

        // ===== KEMASKINI LOGIK SIMPAN (REAL-TIME TANPA REFRESH) =====
        window.savePlannerActivity = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-plan');
            btn.disabled = true;
            btn.textContent = "Menyimpan...";
            
            const title = document.getElementById('plan-title').value.toUpperCase();
            const location = document.getElementById('plan-location').value.toUpperCase();
            const notes = document.getElementById('plan-notes').value;
            const isPublic = document.getElementById('is-public-program').checked; 
            const imageUrl = document.getElementById('plan-image-url').value;
            
            const mode = document.getElementById('plan-mode').value;
            const link = document.getElementById('plan-link').value;

            const startDate = document.getElementById('plan-start-date').value;
            const startTime = document.getElementById('plan-start-time').value;
            const isOneDay = document.getElementById('is-one-day').checked;
            
            let endDate = startDate;
            let endTime = document.getElementById('plan-end-time-single').value;
            
            if (!isOneDay) {
                endDate = document.getElementById('plan-end-date').value;
                endTime = document.getElementById('plan-end-time-multi').value;
                if (endDate < startDate) {
                    alert("Tarikh Tamat tidak boleh sebelum Tarikh Mula.");
                    btn.disabled = false;
                    btn.textContent = "SIMPAN";
                    return;
                }
            }

            const participantNames = selectedParticipants.map(u => u.name).join(', ');
            const taggedIcs = selectedParticipants.map(u => u.ic);

            try {
                const planData = {
                    ic: currentUserIc,
                    sector: currentUserSector, 
                    unit: currentUserUnit,
                    title,
                    startDate,
                    startTime,
                    endDate,
                    endTime, 
                    isOneDay,
                    location,
                    mode, 
                    link, 
                    imageUrl,
                    participants: participantNames, 
                    taggedIcs: taggedIcs, 
                    notes,
                    isPublic: isPublic, 
                    updatedAt: new Date()
                };
                
                if (editingPlannerId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/spark_planner`, editingPlannerId);
                    await updateDoc(docRef, planData);
                    const index = plannerList.findIndex(p => p.id === editingPlannerId);
                    if (index !== -1) {
                        plannerList[index] = { id: editingPlannerId, ...planData, createdAt: plannerList[index].createdAt }; 
                    }
                    alert("Aktiviti berjaya dikemaskini!");
                } else {
                    planData.createdAt = new Date();
                    const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_planner`), planData);
                    plannerList.push({ id: docRef.id, ...planData });
                    alert("Aktiviti berjaya disimpan!");
                }
                
                renderPlannerList();
                closePlannerModal();
            } catch (error) {
                console.error("Error saving plan:", error);
                alert("Gagal menyimpan. Sila cuba lagi.");
            } finally {
                btn.disabled = false;
                btn.textContent = "SIMPAN";
            }
        }

        async function checkPhoneNumber(pData) {
            try {
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const q = query(usersRef, where("ic", "==", pData.ic));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    participantDocId = userDoc.id; 
                    if (!userData.phone) document.getElementById('phone-modal').classList.remove('hidden');
                } else {
                    document.getElementById('phone-modal').classList.remove('hidden');
                }
            } catch (error) { console.error("Error checking phone:", error); }
        }

        async function savePhoneNumber(event) {
            event.preventDefault();
            const phoneInput = document.getElementById('user-phone');
            const btn = document.getElementById('save-phone-btn');
            const phone = phoneInput.value.trim();
            if (!phone) return;
            btn.disabled = true; btn.textContent = "MENYIMPAN...";
            try {
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                if (participantDocId) {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/spark_participants`, participantDocId);
                    await updateDoc(userDocRef, { phone: phone });
                } else {
                    const name = document.getElementById('user-name').textContent;
                    const org = document.getElementById('user-org').textContent;
                    await addDoc(usersRef, { ic: currentUserIc, name: name !== "TIADA REKOD" ? name : "", station: org !== "-" ? org : "", phone: phone, createdAt: new Date() });
                }
                alert("PROFIL BERJAYA DIKEMASKINI.");
                document.getElementById('phone-modal').classList.add('hidden');
            } catch (error) {
                alert("GAGAL MENYIMPAN. SILA CUBA LAGI.");
                btn.disabled = false; btn.textContent = "SIMPAN & TERUSKAN";
            }
        }
        
        function filterTable() {
            const input = document.getElementById('search-input');
            const filter = input.value.toUpperCase();
            let sourceList = [];
            if (currentTab === 'attendance') sourceList = attendanceList;
            else if (currentTab === 'created') sourceList = createdList;
            else if (currentTab === 'tasks') sourceList = taskList;
            else sourceList = allProgramsList;
            filteredResults = sourceList.filter(item => {
                const name = item.programData ? item.programData.name : item.nama;
                return name && name.toUpperCase().includes(filter);
            });
            currentPage = 1; renderTable();
        }

        function changeRowsPerPage(val) { rowsPerPage = parseInt(val); currentPage = 1; renderTable(); }
        function prevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if ((currentPage * rowsPerPage) < filteredResults.length) { currentPage++; renderTable(); } }
        function updatePaginationInfo() {
            const total = filteredResults.length;
            const start = total === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
            const end = Math.min(start + rowsPerPage - 1, total);
            document.getElementById('pagination-info').textContent = `MENUNJUKKAN ${start} HINGGA ${end} DARIPADA ${total} REKOD`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= total;
        }
        function safeNavigate(url) { try { window.location.href = url; } catch (e) { console.warn("Navigasi dihalang:", e); } }
        function logout() { localStorage.removeItem('user_ic'); safeNavigate('index.html'); }

        window.logout = logout;
        window.filterTable = filterTable;
        window.safeNavigate = safeNavigate;
        window.changeRowsPerPage = changeRowsPerPage;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.savePhoneNumber = savePhoneNumber;
        window.switchTab = switchTab; 
        
        window.changePlannerMonth = changePlannerMonth;
        window.renderPlannerList = renderPlannerList;
        window.jumpToToday = jumpToToday;
        window.openPlannerModal = openPlannerModal;
        window.closePlannerModal = closePlannerModal;
        window.savePlannerActivity = savePlannerActivity;
        window.deletePlannerActivity = deletePlannerActivity;
        window.convertToSpark = convertToSpark;
        
        window.toggleDateRange = toggleDateRange;
        window.saveCurrentGroup = saveCurrentGroup;
        window.loadGroup = loadGroup;
        window.clearParticipants = clearParticipants;
        window.removeParticipant = removeParticipant;
        
        window.clickAddButton = clickAddButton;
        window.saveSector = saveSector;
        window.saveNonPPDUser = saveNonPPDUser;
        window.showSectorDropdowns = showSectorDropdowns;
        window.resetSectorModal = resetSectorModal;
        
        window.showPlannerDetails = showPlannerDetails;
        window.populateUnits = populateUnits;
        window.toggleMeetingMode = toggleMeetingMode;
        
        // Expose new functions
        window.uploadImageToImgBB = uploadImageToImgBB;
        window.clearImage = clearImage;
        window.triggerProfileUpload = triggerProfileUpload;
        window.handleProfileImageUpload = handleProfileImageUpload;
        window.goToGenerateProgram = goToGenerateProgram;

    </script>
</body>
</html>
