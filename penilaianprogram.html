<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK – Penilaian Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #4f46e5, #8b5cf6, #ec4899, #f43f5e, #4f46e5);
            background-size: 400% 400%;
            animation: sparkGradient 15s ease infinite;
            min-height: 100vh;
        }
        
        @keyframes sparkGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card { 
            background-color: white; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom scrollbar untuk borang soalan panjang */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c084fc; border-radius: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a855f7; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <main id="main-content" class="w-full max-w-2xl mx-auto flex-grow flex flex-col items-center justify-center p-3 sm:p-4">
        <div class="w-full">
            <div id="loading-state" class="text-center">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-white/80 text-sm font-medium">Memuatkan borang penilaian...</p>
            </div>

            <div id="ic-card" class="card p-5 sm:p-8 hidden max-w-md mx-auto">
                <div class="text-center mb-3">
                    <div class="inline-block bg-purple-100 p-2.5 rounded-xl logo-pulse">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-purple-600">
                            <path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-purple-600 mt-2 leading-tight">SPARK</h1>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-1 border-b pb-4 border-gray-100">Borang Penilaian</p>
                </div>
                
                <div class="text-center mb-4 mt-2">
                    <h2 id="program-name" class="text-lg sm:text-xl font-bold text-gray-800 uppercase leading-tight"></h2>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="flex items-center gap-2 text-gray-700 bg-purple-50 p-2.5 rounded-lg col-span-2 shadow-sm border border-purple-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        <span id="program-location" class="font-semibold text-xs sm:text-sm uppercase truncate"></span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-700 bg-purple-50 p-2.5 rounded-lg shadow-sm border border-purple-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span id="program-date" class="font-semibold text-[10px] sm:text-xs uppercase"></span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-700 bg-purple-50 p-2.5 rounded-lg shadow-sm border border-purple-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        <span id="program-time" class="font-semibold text-[10px] sm:text-xs uppercase"></span>
                    </div>
                </div>
                
                <div id="mini-stats-container" class="mb-4 hidden w-full"></div>

                <form id="ic-form" onsubmit="handleIcSubmit(event)">
                    <label for="participant-ic" class="block text-sm font-medium text-gray-700 mb-1.5 text-center">Sila Masukkan No. IC Anda</label>
                    <input type="tel" id="participant-ic" required placeholder="Cth: 900101131234" maxlength="12" oninput="validateIcInput(this)" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg tracking-widest text-center font-semibold">
                    <div class="text-right text-[10px] text-gray-500 mt-1 pr-1"><span id="ic-counter">0</span>/12 Digit</div>
                    <button type="submit" id="submit-ic-btn" class="btn w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl text-sm uppercase tracking-wide shadow-md">Mula Menilai</button>
                </form>
            </div>

            <div id="evaluation-form-card" class="card p-5 sm:p-8 hidden">
                <div class="text-center mb-5 border-b pb-4">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 uppercase tracking-wide">Soal Selidik Program</h3>
                    <p id="evaluator-name" class="text-sm text-gray-500 mt-2 leading-tight"></p>
                </div>
                
                <div class="p-3 bg-purple-50 rounded-xl mb-6 border border-purple-100 text-center shadow-sm">
                    <h4 class="text-[10px] font-bold text-purple-800 uppercase tracking-widest mb-1">Skala Penilaian</h4>
                    <p class="text-[10px] sm:text-xs text-purple-600 leading-relaxed font-medium">
                        1: Sangat Tidak Setuju &nbsp;&bull;&nbsp; 2: Tidak Setuju &nbsp;&bull;&nbsp; 3: Kurang Setuju<br class="hidden sm:block"> 
                        4: Setuju &nbsp;&bull;&nbsp; 5: Sangat Setuju
                    </p>
                </div>

                <form id="evaluation-form" onsubmit="submitEvaluation(event)">
                    <div id="questions-container" class="space-y-6 max-h-[55vh] overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                    <button type="submit" id="submit-evaluation-btn" class="btn w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 px-4 rounded-xl text-sm uppercase tracking-wide shadow-md">Hantar Maklum Balas</button>
                </form>
            </div>

            <div id="message-card" class="card p-8 text-center hidden max-w-md mx-auto">
                 <div id="message-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"></div>
                <h2 id="message-title" class="text-2xl font-bold text-gray-800"></h2>
                <p id="message-body" class="text-gray-600 mt-2 text-sm leading-relaxed"></p>
                <div id="cert-button-container" class="mt-8 hidden">
                    <button onclick="printCertificate()" class="btn w-full inline-flex justify-center items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 px-6 rounded-xl shadow-md uppercase tracking-wide text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Cetak Sijil Penyertaan
                    </button>
                    <p class="text-[10px] text-gray-400 mt-3 italic">Sijil akan dibuka di tetingkap baru (Pop-up).</p>
                </div>
            </div>
            
            <footer class="text-center mt-6 mb-2 w-full flex flex-col items-center justify-center gap-3">
                <p class="text-[11px] text-white/90 font-medium tracking-wide leading-relaxed drop-shadow-sm">
                    © 2026 SPARK oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-bold hover:text-white transition-colors underline decoration-white/50 underline-offset-2">PahanStudio</a>.<br>
                    Dibangunkan dengan ❤️ di Miri.
                </p>
                <a href="sponsor.html" class="inline-flex items-center gap-1.5 px-4 py-1.5 rounded-full bg-white/10 hover:bg-white/20 text-white border border-white/20 shadow-sm transition-all duration-300 text-[10px] font-semibold tracking-wide backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-pink-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                    Sokong Pembangunan SPARK
                </a>
            </footer>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        let db, auth;
        let currentProgram = null;
        let participantInfo = null;
        let evaluationDate = null; 
        const appId = firebaseConfig.projectId;

        const evaluationQuestions = [
            "Pengurusan teratur", "Lokasi sesuai", "Program ini mampu meningkatkan prestasi kerja saya",
            "Program ini mampu memberi keyakinan kepada saya dalam memberi perkhidmatan", "Tempoh masa program mencukupi",
            "Saya bersedia untuk memberi kursus dalaman", "Bahan perkongsian berguna dan membantu",
            "Bahan perkongsian mudah difahami dan jelas", "Isi kandungan sesuai dengan objektif dan menepati tajuk",
            "Isi kandungan mampu meningkatkan percambahan ilmu saya", "Isi kandungan membantu saya mengamalkannya dalam tugas seharian",
            "Penyampaian amat jelas", "Bahasa yang digunakan mudah difahami", "Interaksi penceramah/fasilitator adalah sesuai",
            "Penceramah/fasilitator bersifat bersedia, yakin dan terbuka", "Penampilan penceramah/fasilitator adalah sesuai dan profesional",
            "Penceramah/fasilitator menepati masa", "Penceramah/fasilitator menggunakan masa secara optimum"
        ];

        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => { if (user) main(); else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } } });

        // Helper untuk format tarikh & masa dengan betulan masa tempatan (Zon Waktu)
        function getLocalDateString(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        function formatDateRange(start, end) {
            if (!start) return '';
            if (start === end || !end) return formatShortDate(start);
            return `${formatShortDate(start)} - ${formatShortDate(end)}`;
        }

        function formatTimeMalay(timeString) {
            if (!timeString) return '';
            const [hourStr, minuteStr] = timeString.split(':');
            let hour = parseInt(hourStr, 10);
            let period;
            if (hour === 0) { period = 'tengah malam'; hour = 12; }
            else if (hour < 12) { period = 'pagi'; }
            else if (hour === 12) { period = 'tengah hari'; }
            else { period = 'ptg'; hour -= 12; }
            return `${hour}:${minuteStr} ${period}`;
        }
        function formatTimeRange(start, end) { return `${formatTimeMalay(start)} - ${formatTimeMalay(end)}`; }

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const evaluationKey = urlParams.get('kod');
            evaluationDate = urlParams.get('tarikh'); 
            
            if (!evaluationKey) { return showMessage('error', 'Pautan Tidak Sah', 'Kod penilaian tidak ditemui dalam pautan.'); }

            const programsRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q = query(programsRef, where("evaluationKey", "==", evaluationKey));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const programDoc = querySnapshot.docs[0];
                currentProgram = { id: programDoc.id, ...programDoc.data() };
                
                document.getElementById('program-name').textContent = `${currentProgram.name.toUpperCase()}`;
                document.getElementById('program-location').textContent = currentProgram.location;
                document.getElementById('program-time').textContent = formatTimeRange(currentProgram.startTime, currentProgram.endTime);
                
                // Paparkan tarikh yang spesifik jika ada, kalau tiada papar julat tarikh
                if (evaluationDate) {
                    document.getElementById('program-date').textContent = formatShortDate(evaluationDate);
                } else {
                    document.getElementById('program-date').textContent = formatDateRange(currentProgram.startDate, currentProgram.endDate);
                }
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('ic-card').classList.remove('hidden');
                
                renderStats(); // Panggil paparan statistik mini
            } else { showMessage('error', 'Penilaian Tidak Ditemui', 'Sila pastikan anda menggunakan pautan yang betul.'); }
        }

        function renderStats() {
            const container = document.getElementById('mini-stats-container');
            if (!currentProgram) return;

            // 1. Tentukan tarikh sasaran
            const targetDate = evaluationDate || getLocalDateString(new Date());

            // 2. Kira jumlah kehadiran (attendance) untuk hari tersebut
            const attendanceList = currentProgram.attendance || [];
            const dailyAttendance = attendanceList.filter(a => {
                if (!a.time) return false;
                return getLocalDateString(new Date(a.time)) === targetDate;
            });
            const totalAttendance = dailyAttendance.length;

            // 3. Kira jumlah borang dijawab (evaluations) untuk hari tersebut
            const evaluations = currentProgram.evaluations || [];
            const dailyEvals = evaluations.filter(ev => ev.evalDate === targetDate);
            const totalEvals = dailyEvals.length;

            // Sembunyikan jika tiada kehadiran langsung pada hari tersebut
            if (totalAttendance === 0 && totalEvals === 0) {
                container.classList.add('hidden');
                return;
            }

            // 4. Kira Peratusan
            let pct = 0;
            if (totalAttendance > 0) {
                pct = Math.round((totalEvals / totalAttendance) * 100);
                if (pct > 100) pct = 100; // Langkah berjaga-jaga
            }

            // 5. Paparan UI Mini dan Kompak
            container.innerHTML = `
                <div class="bg-purple-50 rounded-xl p-3 border border-purple-100 shadow-sm">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-[10px] font-bold text-purple-800 uppercase tracking-wide">Status Maklum Balas Hari Ini</span>
                        <span class="text-[10px] font-bold text-purple-600 bg-white px-2 py-0.5 rounded shadow-sm border border-purple-100">${totalEvals} / ${totalAttendance} (${pct}%)</span>
                    </div>
                    <div class="w-full bg-purple-200 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-purple-500 h-1.5 rounded-full transition-all duration-1000 ease-out" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
        }

        function renderEvaluationForm() {
            const container = document.getElementById('questions-container');
            let html = '';
            evaluationQuestions.forEach((q_text, index) => {
                const q_index = index + 1;
                html += `
                    <div class="pt-5 border-t border-gray-100 first:border-t-0 first:pt-0">
                        <label class="block text-sm font-semibold text-gray-800 mb-2 leading-snug">${q_index}. ${q_text}</label>
                        <div class="flex justify-between items-center mt-2 space-x-1 sm:space-x-2">
                            ${[1,2,3,4,5].map(val => `
                                <label class="flex flex-col items-center flex-1 cursor-pointer p-2 sm:p-3 rounded-xl hover:bg-purple-50 bg-gray-50 border border-gray-200 transition-colors shadow-sm">
                                    <input type="radio" name="q${q_index}" value="${val}" class="h-4 w-4 sm:h-5 sm:w-5 text-purple-600 border-gray-300 focus:ring-purple-500" required>
                                    <span class="mt-2 text-xs sm:text-sm font-bold text-gray-700">${val}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            html += `
                <div class="pt-6 border-t border-gray-200 mt-4">
                    <label for="suggestion-textarea" class="block text-sm font-semibold text-gray-800 mb-2">${evaluationQuestions.length + 1}. Kekuatan / Cadangan Penambahbaikan (Jika ada)</label>
                    <textarea id="suggestion-textarea" rows="4" class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm bg-gray-50" placeholder="Tuliskan cadangan membina anda di sini..."></textarea>
                </div>
            `;
            container.innerHTML = html;
        }

        function validateIcInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            const counter = document.getElementById('ic-counter');
            const currentLength = input.value.length;
            counter.textContent = currentLength;
             if (currentLength === 12) {
                counter.classList.add('text-green-600', 'font-bold');
            } else {
                counter.classList.remove('text-green-600', 'font-bold');
            }
        }

        window.handleIcSubmit = async function(event) {
            event.preventDefault();
            const icInput = document.getElementById('participant-ic');
            const ic = icInput.value.trim();
            if (!ic || ic.length !== 12) { alert("Sila masukkan No. IC yang sah (12 digit nombor sahaja)."); return; }

            const submitBtn = document.getElementById('submit-ic-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const isAlreadyEvaluated = (currentProgram.evaluations || []).some(p => {
                if (evaluationDate && p.evalDate) {
                    return p.ic === ic && p.evalDate === evaluationDate;
                }
                return p.ic === ic; 
            });

            // Beri makluman boleh muat turun Sijil dari Halaman Utama (jika sudah daftar)
            if (isAlreadyEvaluated) { 
                const currentYear = new Date().getFullYear();
                return showMessage('warning', 'Telah Menjawab', `Anda telah pun memberi maklum balas penilaian pada tarikh ini.<br><br>Sijil penyertaan atau penghargaan anda boleh disemak dan dimuat turun melalui <a href="index.html" class="text-purple-600 font-bold hover:underline">Halaman Utama SPARK</a> sepanjang tahun <b>${currentYear}</b>.`); 
            }

            const participantsRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const q = query(participantsRef, where("ic", "==", ic));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Mula Menilai";
                return alert("No. IC anda tidak ditemui dalam rekod kehadiran SPARK. Sila pastikan anda mendaftar kehadiran terlebih dahulu.");
            }
            
            const participantData = querySnapshot.docs[0].data();
            participantInfo = { ic: ic, name: participantData.name };
            
            renderEvaluationForm();
            document.getElementById('evaluator-name').innerHTML = `PENILAI: <span class="font-bold text-purple-700 ml-1 uppercase border-b-2 border-purple-200 pb-0.5">${participantInfo.name}</span>`;
            document.getElementById('ic-card').classList.add('hidden');
            document.getElementById('mini-stats-container').classList.add('hidden'); // Sembunyikan ketika menjawab
            document.getElementById('evaluation-form-card').classList.remove('hidden');
        }

        window.submitEvaluation = async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-evaluation-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = "Menghantar...";

            if (!participantInfo) {
                showMessage('error', 'Ralat', 'Maklumat peserta tidak ditemui.');
                submitBtn.disabled = false;
                submitBtn.textContent = "Hantar Maklum Balas";
                return;
            }
            
            const responses = {};
            for (let i = 1; i <= evaluationQuestions.length; i++) {
                const checkedRadio = document.querySelector(`input[name="q${i}"]:checked`);
                if (!checkedRadio) {
                    alert(`Sila jawab soalan nombor ${i}.`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Hantar Maklum Balas";
                    document.querySelector(`input[name="q${i}"]`).closest('div.pt-5').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return; 
                }
                responses[`q${i}`] = parseInt(checkedRadio.value, 10);
            }

            const newEvaluation = {
                ic: participantInfo.ic, 
                name: participantInfo.name,
                time: new Date().toISOString(),
                evalDate: evaluationDate || getLocalDateString(new Date()), 
                responses: responses,
                suggestion: document.getElementById('suggestion-textarea').value.trim()
            };

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            try {
                await updateDoc(programRef, { evaluations: arrayUnion(newEvaluation) });
                
                // Kemas kini array di lokal memori dan jana carta terkini
                if(!currentProgram.evaluations) currentProgram.evaluations = [];
                currentProgram.evaluations.push(newEvaluation);
                renderStats();

                // Beri makluman boleh muat turun Sijil dari Halaman Utama (selepas berjaya nilai)
                const currentYear = new Date().getFullYear();
                if (currentProgram.eCertificateNeeded) {
                    const successTitle = `Tahniah, ${participantInfo.name}!`;
                    const successBody = `Penilaian anda direkodkan dengan jayanya. Anda kini boleh mencetak Sijil di bawah.<br><br>Sijil ini juga sentiasa boleh dimuat turun melalui <a href="index.html" class="text-purple-600 font-bold hover:underline">Halaman Utama SPARK</a> sepanjang tahun <b>${currentYear}</b>.`;
                    showMessage('success', successTitle, successBody, true);
                } else {
                    showMessage('success', 'Penilaian Diterima!', `Terima kasih, ${participantInfo.name}.<br><br>Sijil penyertaan/penghargaan (jika disediakan untuk program ini) boleh disemak dan dimuat turun melalui <a href="index.html" class="text-purple-600 font-bold hover:underline">Halaman Utama SPARK</a> sepanjang tahun <b>${currentYear}</b>.`);
                }
            } catch(error) {
                console.error("Error saving evaluation: ", error);
                showMessage('error', 'Gagal', 'Gagal menyimpan penilaian. Sila cuba lagi.');
                submitBtn.disabled = false;
                submitBtn.textContent = "Hantar Maklum Balas";
            }
        }

        function showMessage(type, title, body, showCertButton = false) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('ic-card').classList.add('hidden');
            document.getElementById('mini-stats-container').classList.add('hidden');
            document.getElementById('evaluation-form-card').classList.add('hidden');
            
            const msgCard = document.getElementById('message-card');
            const msgIcon = document.getElementById('message-icon');
            const msgTitle = document.getElementById('message-title');
            const msgBody = document.getElementById('message-body');
            msgTitle.textContent = title;
            msgBody.innerHTML = body; // Tukar innerHTML untuk pautan html
            
            const certButtonContainer = document.getElementById('cert-button-container');
            if (showCertButton) {
                certButtonContainer.classList.remove('hidden');
            } else {
                certButtonContainer.classList.add('hidden');
            }

            let icon, color;
            if (type === 'success') { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; color = 'bg-green-500'; } 
            else if (type === 'warning') { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z" /></svg>`; color = 'bg-yellow-500'; } 
            else { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; color = 'bg-red-500'; }
            msgIcon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${color} shadow-lg`;
            msgIcon.innerHTML = icon;
            msgCard.classList.remove('hidden');
        }
        
        function printCertificate() {
            if (!participantInfo || !currentProgram) return;

            const participantName = participantInfo.name.toUpperCase();
            const participantIC = participantInfo.ic;
            const courseName = currentProgram.name.toUpperCase();
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            let dateString;
            
            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const serialNumber = `SPK/${currentProgram.id}/${participantIC.slice(-4)}`;
            const validationUrl = `${window.location.origin}${window.location.pathname.replace('penilaianprogram.html', 'sijil.html')}?siri=${encodeURIComponent(serialNumber)}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ms">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Sijil Penyertaan - ${participantName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; font-weight: 400; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #333; }
                        .certificate-container { width: 210mm; height: 297mm; background-color: white; padding: 12mm; box-sizing: border-box; position: relative; display: flex; flex-direction: column; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; }
                        .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
                        .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                        .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                        .certificate-content { border: 6px solid; border-image-slice: 1; border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); height: 100%; padding: 10mm; box-sizing: border-box; position: relative; z-index: 2; display: flex; flex-direction: column; background: #ffffff; }
                        .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                        .qr-code { width: 65px; height: 65px; }
                        .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                        .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                        h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                        .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                        .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                        .event-title-label { font-size: 16px; color: #555; }
                        .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                        .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                        .signature-section { margin-top: auto; }
                        .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                        .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                        .spark-section { margin-top: 15px; }
                        .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                        @media print {
                            body { background-color: white; }
                            .certificate-container { box-shadow: none; margin: 0; }
                            @page { size: A4 portrait; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="certificate-content">
                            <div class="header-section">
                                <img src="${qrCodeUrl}" alt="QR Code" class="qr-code">
                                <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                            </div>
                            <img src="https://i.imgur.com/FQpwGDo.png" alt="Logo Pejabat Pendidikan Daerah Miri" class="logo">
                            <h1>Sijil Penyertaan</h1>
                            <p class="intro-text">Dengan ini disahkan bahawa</p>
                            <p class="recipient-name">${participantName}</p>
                            <p class="recipient-ic">${participantIC}</p>
                            <p class="event-title-label">telah mengikuti</p>
                            <p class="event-title">${courseName}</p>
                            <p class="event-date">${dateString}</p>
                            <hr class="divider">
                            <div class="signature-section">
                                <p class="signatory-name">MARIAM HAJI MONEK</p>
                                <p class="signatory-title">PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                            </div>
                            <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                            <div class="spark-section">
                                <p class="spark-title">SPARK</p>
                                <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { 
                printWindow.focus(); 
                printWindow.print();
            };
        }
        
        window.validateIcInput = validateIcInput;
        window.printCertificate = printCertificate;
    </script>
</body>
</html>
