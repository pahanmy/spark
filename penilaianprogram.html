<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Penilaian Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
        }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { cursor: not-allowed; opacity: 0.7; }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .logo-pulse { animation: pulse-animation 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm w-full">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-center items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="w-full max-w-2xl mx-auto flex-grow flex items-center justify-center p-4">
        <div class="w-full">
            <div id="loading-state" class="text-center">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-600">Memuatkan borang penilaian...</p>
            </div>

            <div id="ic-card" class="card p-8 hidden">
                <div class="text-center mb-6">
                    <h1 id="program-name" class="text-2xl font-bold text-gray-800"></h1>
                    <p id="program-date" class="text-sm text-gray-500 mt-1"></p>
                </div>
                
                <form id="ic-form" onsubmit="handleIcSubmit(event)">
                    <label for="participant-ic" class="block text-sm font-medium text-gray-700 mb-2">Sila Masukkan No. IC Anda Untuk Mula</label>
                    <input type="tel" id="participant-ic" required placeholder="Contoh: 900101131234 (tanpa sengkang)" maxlength="12" oninput="validateIcInput(this)" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg tracking-wider">
                    <div class="text-right text-xs text-gray-500 mt-1 pr-1"><span id="ic-counter">0</span>/12</div>
                    <button type="submit" id="submit-ic-btn" class="btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-base">Seterusnya</button>
                </form>
            </div>

            <div id="evaluation-form-card" class="card p-8 hidden">
                <h3 class="text-xl font-semibold mb-1">Soal Selidik Penilaian Program</h3>
                <p id="evaluator-name" class="text-gray-600 mb-6"></p>
                
                <div class="p-4 bg-gray-50 rounded-lg mb-6 border">
                    <h4 class="text-sm font-semibold text-gray-800">SKALA PENILAIAN</h4>
                    <p class="text-xs text-gray-600 mt-1">1-Sangat Tidak Setuju, 2-Tidak Setuju, 3-Kurang Setuju, 4-Setuju, 5-Sangat Setuju</p>
                </div>

                <form id="evaluation-form" onsubmit="submitEvaluation(event)" class="max-h-[60vh] overflow-y-auto pr-2">
                    <div id="questions-container" class="space-y-6">
                        </div>
                    <button type="submit" id="submit-evaluation-btn" class="btn w-full mt-8 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg">Hantar Penilaian</button>
                </form>
            </div>

            <div id="message-card" class="card p-8 text-center hidden">
                 <div id="message-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"></div>
                <h2 id="message-title" class="text-2xl font-bold"></h2>
                <p id="message-body" class="text-gray-600 mt-2"></p>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 mt-8 border-t border-gray-200 w-full">
        <p class="text-sm text-gray-600">Dibangunkan oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-600 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500"></p>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        let db, auth;
        let currentProgram = null;
        let participantInfo = null;
        const appId = firebaseConfig.projectId;

        const evaluationQuestions = [
            "Pengurusan teratur", "Lokasi sesuai", "Program ini mampu meningkatkan prestasi kerja saya",
            "Program ini mampu memberi keyakinan kepada saya dalam memberi perkhidmatan", "Tempoh masa program mencukupi",
            "Saya bersedia untuk memberi kursus dalaman", "Bahan perkongsian berguna dan membantu",
            "Bahan perkongsian mudah difahami dan jelas", "Isi kandungan sesuai dengan objektif dan menepati tajuk",
            "Isi kandungan mampu meningkatkan percambahan ilmu saya", "Isi kandungan membantu saya mengamalkannya dalam tugas seharian",
            "Penyampaian amat jelas", "Bahasa yang digunakan mudah difahami", "Interaksi penceramah/fasilitator adalah sesuai",
            "Penceramah/fasilitator bersifat bersedia, yakin dan terbuka", "Penampilan penceramah/fasilitator adalah sesuai dan profesional",
            "Penceramah/fasilitator menepati masa", "Penceramah/fasilitator menggunakan masa secara optimum"
        ];

        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => { if (user) main(); else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } } });

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const evaluationKey = urlParams.get('kod');
            
            const versionInfo = document.getElementById('version-info');
            if(versionInfo) { const year = new Date().getFullYear(); versionInfo.textContent = `Versi 2.1 (${year})`; }

            if (!evaluationKey) { return showMessage('error', 'Pautan Tidak Sah', 'Kod penilaian tidak ditemui dalam pautan.'); }

            const programsRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
            const q = query(programsRef, where("evaluationKey", "==", evaluationKey));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const programDoc = querySnapshot.docs[0];
                currentProgram = { id: programDoc.id, ...programDoc.data() };
                document.getElementById('program-name').textContent = `Penilaian Program: ${currentProgram.name}`;
                document.getElementById('program-date').textContent = new Date(currentProgram.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('ic-card').classList.remove('hidden');
            } else { showMessage('error', 'Penilaian Tidak Ditemui', 'Sila pastikan anda menggunakan pautan yang betul.'); }
        }

        function renderEvaluationForm() {
            const container = document.getElementById('questions-container');
            let html = '';
            evaluationQuestions.forEach((q_text, index) => {
                const q_index = index + 1;
                html += `
                    <div class="pt-4 border-t first:border-t-0">
                        <label class="block text-sm font-medium text-gray-700">${q_index}. ${q_text}</label>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                            <span>Sangat Tidak Setuju</span>
                            <span>Sangat Setuju</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 space-x-2">
                            ${[1,2,3,4,5].map(val => `
                                <label class="flex flex-col items-center flex-1 cursor-pointer p-2 rounded-lg hover:bg-indigo-50">
                                    <input type="radio" name="q${q_index}" value="${val}" class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500" required>
                                    <span class="mt-1 text-sm font-semibold">${val}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            html += `
                <div class="pt-4 border-t">
                    <label for="suggestion-textarea" class="block text-sm font-medium text-gray-700">${evaluationQuestions.length + 1}. Kekuatan/Cadangan Penambahbaikan (Jika ada)</label>
                    <textarea id="suggestion-textarea" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
            `;
            container.innerHTML = html;
        }

        function validateIcInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            const counter = document.getElementById('ic-counter');
            const currentLength = input.value.length;
            counter.textContent = currentLength;
             if (currentLength === 12) {
                counter.classList.add('text-green-600', 'font-bold');
            } else {
                counter.classList.remove('text-green-600', 'font-bold');
            }
        }

        window.handleIcSubmit = async function(event) {
            event.preventDefault();
            const icInput = document.getElementById('participant-ic');
            const ic = icInput.value.trim();
            if (!ic || ic.length !== 12) { alert("Sila masukkan No. IC yang sah (12 digit nombor sahaja)."); return; }

            const submitBtn = document.getElementById('submit-ic-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const isAlreadyEvaluated = (currentProgram.evaluations || []).some(p => p.ic === ic);
            if (isAlreadyEvaluated) { return showMessage('warning', 'Telah Menjawab', 'Anda telah pun memberi maklum balas penilaian untuk program ini.'); }

            const participantsRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
            const q = query(participantsRef, where("ic", "==", ic));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Seterusnya";
                return alert("No. IC anda tidak ditemui dalam rekod. Sila pastikan anda telah mendaftar kehadiran untuk program ini.");
            }
            
            const participantData = querySnapshot.docs[0].data();
            participantInfo = { ic: ic, name: participantData.name };
            
            renderEvaluationForm();
            document.getElementById('evaluator-name').textContent = `Nama Penilai: ${participantInfo.name}`;
            document.getElementById('ic-card').classList.add('hidden');
            document.getElementById('evaluation-form-card').classList.remove('hidden');
        }

        window.submitEvaluation = async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-evaluation-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = "Menghantar...";

            if (!participantInfo) {
                showMessage('error', 'Ralat', 'Maklumat peserta tidak ditemui.');
                submitBtn.disabled = false;
                submitBtn.textContent = "Hantar Penilaian";
                return;
            }
            
            const responses = {};
            for (let i = 1; i <= evaluationQuestions.length; i++) {
                const checkedRadio = document.querySelector(`input[name="q${i}"]:checked`);
                if (!checkedRadio) {
                    alert(`Sila jawab soalan nombor ${i}.`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Hantar Penilaian";
                    document.querySelector(`input[name="q${i}"]`).closest('div.pt-4').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return; 
                }
                responses[`q${i}`] = parseInt(checkedRadio.value, 10);
            }

            const newEvaluation = {
                ic: participantInfo.ic, name: participantInfo.name,
                time: new Date().toISOString(),
                responses: responses,
                suggestion: document.getElementById('suggestion-textarea').value.trim()
            };

            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            try {
                await updateDoc(programRef, { evaluations: arrayUnion(newEvaluation) });
                showMessage('success', 'Penilaian Diterima!', `Terima kasih, ${participantInfo.name}. Maklum balas anda amat kami hargai.`);
            } catch(error) {
                console.error("Error saving evaluation: ", error);
                showMessage('error', 'Gagal', 'Gagal menyimpan penilaian. Sila cuba lagi.');
                submitBtn.disabled = false;
                submitBtn.textContent = "Hantar Penilaian";
            }
        }

        function showMessage(type, title, body) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('ic-card').classList.add('hidden');
            document.getElementById('evaluation-form-card').classList.add('hidden');
            const msgCard = document.getElementById('message-card');
            const msgIcon = document.getElementById('message-icon');
            const msgTitle = document.getElementById('message-title');
            const msgBody = document.getElementById('message-body');
            msgTitle.textContent = title;
            msgBody.textContent = body;
            let icon, color;
            if (type === 'success') { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; color = 'bg-green-500'; } 
            else if (type === 'warning') { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`; color = 'bg-yellow-500'; } 
            else { icon = `<svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; color = 'bg-red-500'; }
            msgIcon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${color}`;
            msgIcon.innerHTML = icon;
            msgCard.classList.remove('hidden');
        }
        
        window.validateIcInput = validateIcInput;
    </script>
</body>
</html>
