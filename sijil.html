<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ e-Sijil & Penghargaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        /* Animasi Loading */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .logo-pulse { animation: pulse-logo 2s infinite; }
        @keyframes pulse-logo { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white">
                        <path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-indigo-600 uppercase tracking-wide">SPARK Sijil</h1>
                    <p class="text-[10px] text-gray-500 font-medium">Hab Sijil Digital & Penghargaan</p>
                </div>
            </div>
            <div>
                 <button onclick="window.location.href='user.html'" class="btn bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-xs uppercase">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Kembali ke Menu
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-5xl mx-auto px-4 sm:px-6 py-8">
        
        <div id="initial-loader" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4 border-indigo-600 border-t-transparent"></div>
            <p class="text-sm text-gray-500 font-medium animate-pulse">Sedang menyemak rekod sijil anda...</p>
        </div>

        <div id="content-container" class="hidden space-y-6">

            <div class="card p-6 border-l-4 border-amber-400 bg-gradient-to-r from-white to-amber-50/50">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-0.5 rounded uppercase tracking-wider">Pencapaian Anda</span>
                            <span id="pro-badge" class="hidden text-[10px] font-bold text-white bg-black px-2 py-0.5 rounded uppercase">PRO USER</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 uppercase" id="welcome-title">Tahniah!</h2>
                        <p class="text-sm text-gray-600 mt-1" id="summary-text">Mengira sijil...</p>
                    </div>
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Tahun Semasa</p>
                        <p class="text-3xl font-extrabold text-indigo-600" id="current-year-display">2026</p>
                    </div>
                </div>
            </div>

            <div class="card overflow-hidden shadow-lg border border-gray-100">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138z" /></svg>
                        Senarai Sijil Penyertaan
                    </h3>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider w-10">Bil</th>
                                <th scope="col" class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider">Program / Tahun</th>
                                <th scope="col" class="px-6 py-3 text-center text-[10px] font-bold text-gray-400 uppercase tracking-wider w-32">Status</th>
                                <th scope="col" class="px-6 py-3 text-center text-[10px] font-bold text-gray-400 uppercase tracking-wider w-40">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div id="no-results-message" class="hidden text-center py-12 px-4 bg-white">
                    <div class="bg-gray-50 rounded-full p-4 inline-block mb-3">
                        <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">Tiada sijil yang tersedia buat masa ini.</p>
                </div>
            </div>

            <p class="text-xs text-gray-400 text-center italic">
                Nota: Sijil tahun-tahun terdahulu hanya boleh diakses oleh akaun <span class="font-bold text-gray-600">Spark PRO</span>.
            </p>
        </div>
    </main>

    <footer class="text-center py-6 mt-auto border-t border-gray-200 bg-white">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="#" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p class="text-xs text-gray-400 mt-1">Versi 3.1 (e-Sijil)</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = firebaseConfig.projectId;

        const currentYear = new Date().getFullYear();
        document.getElementById('current-year-display').textContent = currentYear;

        // UI Elements
        const loader = document.getElementById('initial-loader');
        const container = document.getElementById('content-container');
        const tableBody = document.getElementById('certificates-table-body');
        const noResults = document.getElementById('no-results-message');

        // Main Logic
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlIc = urlParams.get('ic');

                if (urlIc) {
                    await initPage(urlIc);
                } else {
                    alert("Akses tidak sah. Sila log masuk semula.");
                    window.location.href = 'user.html';
                }
            } else {
                auth.signInAnonymously().catch(e => console.error(e));
            }
        });

        async function initPage(icRaw) {
            const icNumber = icRaw.trim().replace(/[^0-9]/g, '');
            
            try {
                // 1. Cek Status PRO User (Atau Admin)
                const isSparkPro = await checkUserProStatus(icNumber);
                
                // Update Badge jika Pro
                if(isSparkPro) document.getElementById('pro-badge').classList.remove('hidden');

                // 2. Cari Sijil
                await findCertificatesByIc(icNumber, isSparkPro);

            } catch (error) {
                console.error("Ralat init:", error);
                alert("Gagal memuatkan data. Sila cuba lagi.");
            }
        }

        async function checkUserProStatus(ic) {
            try {
                // Logic: Admin IC sentiasa Pro
                if(ic === "890522135381") return true;

                const usersRef = db.collection(`artifacts/${appId}/public/data/spark_participants`);
                const q = usersRef.where("ic", "==", ic);
                const snapshot = await q.get();

                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    // Kembalikan true jika flag isPro wujud dan true
                    return data.isPro === true;
                }
                return false;
            } catch (e) {
                console.warn("Gagal cek status user, anggap biasa.", e);
                return false;
            }
        }

        async function findCertificatesByIc(ic, isProUser) {
            const programsRef = db.collection(`artifacts/${appId}/public/data/spark_programs`);
            const snapshot = await programsRef.get();

            let actionableCertificates = [];
            let totalAvailable = 0;
            let totalLocked = 0;
            let userName = "";

            snapshot.docs.forEach(doc => {
                const prog = doc.data();
                const attendance = prog.attendance || [];
                const participant = attendance.find(p => p.ic === ic);

                if (participant) {
                    if (!userName) userName = participant.name; // Ambil nama dari rekod pertama
                    
                    const status = getCertificateStatus(prog, participant, isProUser);
                    
                    // Kita simpan program jika ia ada kaitan sijil (available atau locked)
                    if (status.isRelevant) {
                        if (status.isLocked) totalLocked++;
                        else if (status.type === 'DOWNLOAD') totalAvailable++;

                        actionableCertificates.push({
                            program: prog,
                            participant: participant,
                            status: status
                        });
                    }
                }
            });

            // Kemaskini Tajuk & Ringkasan
            updateSummaryCard(userName, totalAvailable, totalLocked);

            // Render Table
            loader.classList.add('hidden');
            container.classList.remove('hidden');

            if (actionableCertificates.length > 0) {
                // Sort: Tahun terkini di atas, kemudian ikut tarikh
                actionableCertificates.sort((a, b) => {
                    return new Date(b.program.startDate) - new Date(a.program.startDate);
                });
                renderTable(actionableCertificates);
            } else {
                noResults.classList.remove('hidden');
            }
        }

        function updateSummaryCard(name, available, locked) {
            const titleEl = document.getElementById('welcome-title');
            const summaryEl = document.getElementById('summary-text');
            
            const shortName = name ? name.split(' ')[0].toUpperCase() : "PENGGUNA";
            titleEl.textContent = `TAHNIAH, ${shortName}!`;

            if (available > 0) {
                summaryEl.innerHTML = `Anda boleh memuat turun <span class="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">${available} sijil</span> pada masa ini.`;
            } else {
                summaryEl.textContent = "Tiada sijil baharu untuk dimuat turun.";
            }

            if (locked > 0) {
                 summaryEl.innerHTML += ` <br><span class="text-xs text-gray-400 italic mt-1 inline-block">(${locked} sijil tahun lepas dikunci/diarkibkan)</span>`;
            }
        }

        function getCertificateStatus(prog, part, isPro) {
            let result = { isRelevant: false, isLocked: false, html: '', btn: '', type: 'NONE' };
            
            // Cek logik Sijil
            if (prog.eCertificateNeeded === true) {
                
                // Logic Tahun
                const progYear = new Date(prog.startDate).getFullYear();
                const isPastYear = progYear < currentYear;

                // Jika tahun lepas DAN bukan pro -> KUNCI
                if (isPastYear && !isPro) {
                    result.isRelevant = true;
                    result.isLocked = true;
                    result.html = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 uppercase">DIARKIBKAN</span>`;
                    result.btn = `<button disabled class="w-full flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 text-gray-400 text-[10px] font-bold rounded cursor-not-allowed uppercase border border-gray-200">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        Tahun ${progYear} (PRO)
                    </button>`;
                    return result; 
                }

                // Logic Biasa (Tahun Semasa ATAU Pro User)
                const evals = prog.evaluations || [];
                const hasEvaluated = evals.some(e => e.ic === part.ic);

                if (prog.evaluationNeeded === true && !hasEvaluated) {
                    // Perlu Penilaian
                    result.isRelevant = true;
                    result.type = 'EVAL';
                    result.html = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200 uppercase">Perlu Penilaian</span>`;
                    result.btn = `<a href="penilaianprogram.html?kod=${prog.evaluationKey}" class="w-full flex items-center justify-center gap-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold rounded shadow-sm uppercase transition-all">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Isi Borang
                    </a>`;
                } else if (prog.endDate) {
                    // Cek Tarikh Tamat
                    const today = new Date(); today.setHours(0,0,0,0);
                    const endDate = new Date(prog.endDate + 'T00:00:00');

                    if (today > endDate || (prog.evaluationNeeded && hasEvaluated)) {
                        // Sijil Ready
                        result.isRelevant = true;
                        result.type = 'DOWNLOAD';
                        result.html = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200 uppercase">Tersedia</span>`;
                        result.btn = `<button onclick="printCertificate('${prog.key}')" class="w-full flex items-center justify-center gap-1 px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white text-[10px] font-bold rounded shadow-sm uppercase transition-all">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Muat Turun
                        </button>`;
                    } else {
                        // Belum Tamat
                        result.isRelevant = true;
                        result.html = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200 uppercase">Belum Tamat</span>`;
                        result.btn = `<span class="text-[10px] text-gray-400 italic">Tunggu tamat</span>`;
                    }
                }
            }
            return result;
        }

        function renderTable(list) {
            tableBody.innerHTML = "";
            
            // Simpan data global untuk print
            window.certificateData = list;

            list.forEach((item, idx) => {
                const dateObj = new Date(item.program.startDate);
                const dateStr = dateObj.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                const yearStr = dateObj.getFullYear();
                
                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 font-medium">${idx + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-800 uppercase leading-tight mb-0.5">${item.program.name}</div>
                            <div class="flex items-center gap-2 text-[10px] text-gray-400 uppercase font-bold">
                                <span class="bg-gray-100 px-1.5 rounded text-gray-500">${yearStr}</span>
                                <span>${dateStr}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            ${item.status.html}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle w-40">
                            ${item.status.btn}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Fungsi Cetak (Kekal sama, cuma ambil dari window.certificateData)
        window.printCertificate = function(key) {
            const dataItem = window.certificateData.find(d => d.program.key === key);
            if(!dataItem) return alert("Ralat data.");

            const { program, participant } = dataItem;
            
            // --- GENERATE HTML SIJIL (Sama macam kod sebelum ini) ---
            const participantName = participant.name.toUpperCase();
            const participantIC = participant.ic;
            const courseName = program.name.toUpperCase();
            
            const startDate = new Date(program.startDate + 'T00:00:00');
            const endDate = new Date(program.endDate + 'T00:00:00');
            let dateString;
            
            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const serialNumber = `SPK/${program.key || 'GEN'}/${participantIC.slice(-4)}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(window.location.origin + window.location.pathname)}`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sijil - ${participantName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background: #fff; display: flex; justify-content: center; }
                        .certificate-container { width: 210mm; height: 297mm; padding: 10mm; box-sizing: border-box; text-align: center; position: relative; }
                        .content { border: 5px double #daa520; height: 100%; padding: 10mm; display: flex; flex-direction: column; }
                        h1 { font-family: 'Playfair Display', serif; font-size: 36pt; color: #1a237e; margin: 20px 0; text-transform: uppercase; }
                        .name { font-family: 'Playfair Display', serif; font-size: 24pt; font-weight: bold; color: #b8860b; margin: 10px 0; border-bottom: 1px solid #ddd; display: inline-block; padding-bottom: 5px;}
                        .details { font-size: 14pt; margin: 10px 0; color: #333; }
                        .title { font-size: 18pt; font-weight: bold; margin: 10px 0; }
                        .footer { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; text-align: left; }
                        .signature { text-align: center; }
                        .signature p { margin: 2px 0; font-size: 11pt; }
                        .qr { width: 80px; height: 80px; }
                        @media print { @page { size: A4 portrait; margin: 0; } body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="content">
                            <div style="text-align: right; font-size: 10pt; font-family: monospace;">NO. SIRI: ${serialNumber}</div>
                            <div style="margin: 0 auto;"><img src="https://i.imgur.com/FQpwGDo.png" style="width: 120px;"></div>
                            <h1>Sijil Penyertaan</h1>
                            <p class="details">Dengan ini disahkan bahawa</p>
                            <div class="name">${participantName}</div>
                            <p class="details">${participantIC}</p>
                            <p class="details">telah menjayakan</p>
                            <div class="title">${courseName}</div>
                            <p class="details">${dateString}</p>
                            
                            <div class="footer">
                                <div class="qr"><img src="${qrCodeUrl}" style="width:100%"></div>
                                <div class="signature">
                                    <p style="font-weight:bold; color:#1a237e;">MARIAM HAJI MONEK</p>
                                    <p>PEGAWAI PENDIDIKAN DAERAH</p>
                                    <p>PEJABAT PENDIDIKAN DAERAH MIRI</p>
                                </div>
                            </div>
                            <div style="font-size: 9pt; color: #888; margin-top: 20px;">Sijil ini adalah cetakan komputer. Tandatangan tidak diperlukan.</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.focus(); printWindow.print(); };
        }
    </script>
</body>
</html>
