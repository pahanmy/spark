<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ e-Sijil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .input-with-icon { position: relative; }
        .input-with-icon svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af; }
        .input-with-icon input { padding-left: 2.5rem; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <a href="index.html" class="flex flex-col">
                        <span class="text-2xl font-bold text-indigo-600">SPARK</span>
                        <span class="text-xs text-gray-500 -mt-1">Percikan Inovasi Kehadiran Digital</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" class="w-full max-w-5xl mx-auto flex-grow p-4 md:p-8">
        <div class="text-center my-8">
            <h1 class="text-4xl font-bold text-indigo-600">e-Sijil</h1>
            <p class="text-gray-600 mt-2">Masukkan No. Kad Pengenalan untuk paparkan sijil penyertaan anda.</p>
        </div>
        <div id="search-card" class="card p-8 mb-10 max-w-2xl mx-auto">
            <label for="ic-input" class="block text-sm font-medium text-gray-700 mb-2">Nombor Kad Pengenalan (tanpa sengkang)</label>
            <div class="flex shadow-sm rounded-md">
                <input type="text" id="ic-input" placeholder="Contoh: 900101131234" class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                <button id="check-btn" class="btn bg-indigo-600 text-white font-semibold px-8 py-3 rounded-r-md hover:bg-indigo-700 flex items-center">
                    <svg id="search-icon" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <svg id="loading-spinner" class="animate-spin h-5 w-5 mr-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="button-text">Semak</span>
                </button>
            </div>
        </div>
        <div id="participant-info" class="hidden card bg-indigo-50 p-6 mb-8 border border-indigo-200 max-w-2xl mx-auto">
             <h2 class="text-xl font-semibold text-indigo-800 mb-3">Maklumat Peserta</h2>
             <div class="space-y-1 text-gray-700">
                <p><span class="font-semibold w-32 inline-block">Nama</span>: <span id="participant-name">-</span></p><p><span class="font-semibold w-32 inline-block">No. K/P</span>: <span id="participant-ic">-</span></p><p><span class="font-semibold w-32 inline-block">Jawatan</span>: <span id="participant-position">-</span></p><p><span class="font-semibold w-32 inline-block">Stesen</span>: <span id="participant-station">-</span></p>
             </div>
        </div>

        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Senarai Sijil Penyertaan</h2>

            <div class="card p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label for="search-program-input" class="block text-sm font-medium text-gray-700">Cari Program</label>
                        <div class="input-with-icon mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            <input type="text" id="search-program-input" oninput="resetPageAndFilter()" placeholder="Taip nama program..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="md:col-span-1">
                         <label for="filter-month-select" class="block text-sm font-medium text-gray-700">Pilih Bulan</label>
                         <select id="filter-month-select" onchange="resetPageAndFilter()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Semua Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Mac</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Jun</option>
                            <option value="7">Julai</option>
                            <option value="8">Ogos</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Disember</option>
                         </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="filter-year-select" class="block text-sm font-medium text-gray-700">Pilih Tahun</label>
                         <select id="filter-year-select" onchange="resetPageAndFilter()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Semua Tahun</option>
                         </select>
                    </div>
                    <div class="md:col-span-1 flex items-end pb-2">
                        <div class="flex items-center">
                            <input id="filter-sijil-sahaja" type="checkbox" checked onchange="resetPageAndFilter()" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="filter-sijil-sahaja" class="ml-2 block text-sm font-medium text-gray-700">Papar Ada Sijil Sahaja</label>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card overflow-x-auto shadow-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Program</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarikh</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Sijil</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="certificates-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
                <div id="no-filter-results" class="text-center py-10 hidden">
                    <p class="text-gray-600 text-lg">Tiada program ditemui yang sepadan dengan carian anda.</p>
                </div>

                <div id="pagination-controls" class="flex justify-between items-center px-6 py-3 border-t border-gray-200" style="display: none;">
                    <div>
                        <label for="items-per-page" class="text-sm font-medium text-gray-700">Papar:</label>
                        <select id="items-per-page" onchange="changeItemsPerPage()" class="ml-2 py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <span id="pagination-info" class="text-sm text-gray-700 mr-4">Halaman 1 dari 1</span>
                        <button id="prev-page-btn" onclick="changePage(-1)" class="btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm hover:bg-gray-300" disabled>&lt; Sblm</button>
                        <button id="next-page-btn" onclick="changePage(1)" class="btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm ml-2 hover:bg-gray-300" disabled>Nxt &gt;</button>
                    </div>
                </div>
            </div>

            <div id="no-results-message" class="text-center py-10 card hidden"><p class="text-gray-600 text-lg">Tiada rekod sijil ditemui.</p></div>
        </div>
    </main>

    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600 text-sm"><p>Projek Inovasi oleh Pahan</p><p class="text-xs text-gray-500 mt-1">Versi 3.0 (2025)</p></div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = firebaseConfig.projectId;

        const certificatesTableBody = document.getElementById('certificates-table-body');
        let certificateResults = [];

        let currentPage = 1;
        let itemsPerPage = 10;

        const paginationControls = document.getElementById('pagination-controls');
        const paginationInfo = document.getElementById('pagination-info');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const itemsPerPageSelect = document.getElementById('items-per-page');
        const sijilOnlyFilter = document.getElementById('filter-sijil-sahaja');

        const checkBtn = document.getElementById('check-btn');
        const icInput = document.getElementById('ic-input');
        const resultsSection = document.getElementById('results-section');
        const noResultsMessage = document.getElementById('no-results-message');
        const participantInfoDiv = document.getElementById('participant-info');
        const searchIcon = document.getElementById('search-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');

        const searchInput = document.getElementById('search-program-input');
        const monthFilter = document.getElementById('filter-month-select');
        const yearFilter = document.getElementById('filter-year-select');
        const noFilterResults = document.getElementById('no-filter-results');

        auth.onAuthStateChanged(user => {
            if (user) {
                checkBtn.disabled = false;
                buttonText.textContent = 'Semak';
                checkBtn.addEventListener('click', findCertificatesByIc);
                icInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') findCertificatesByIc(); });
            }
        });
        if (!auth.currentUser) { auth.signInAnonymously().catch(e => console.error(e)); }

        async function findCertificatesByIc() {
            const icNumber = icInput.value.trim().replace(/[^0-9]/g, '');
            if (!icNumber) { alert("Sila masukkan Nombor Kad Pengenalan."); return; }
            setLoading(true);
            resetDisplay();
            try {
                const programsRef = db.collection(`artifacts/${appId}/public/data/spark_programs`);
                const programsSnapshot = await programsRef.get();

                window.certificateResults = [];

                programsSnapshot.docs.forEach(programDoc => {
                    const programData = programDoc.data();
                    const attendanceArray = programData.attendance || [];
                    const participantData = attendanceArray.find(p => p.ic === icNumber);

                    if (participantData) {
                        window.certificateResults.push({
                            programData: programData,
                            participantData: participantData
                        });
                    }
                });

                window.certificateResults.sort((a, b) => {
                    const dateA = a.programData.startDate ? new Date(a.programData.startDate + 'T00:00:00') : new Date(0);
                    const dateB = b.programData.startDate ? new Date(b.programData.startDate + 'T00:00:00') : new Date(0);
                    return dateB - dateA;
                });

                const results = window.certificateResults;

                if (results.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    resultsSection.classList.remove('hidden');
                } else {
                    displayParticipantInfo(results[0].participantData, maskIc(icNumber));
                    populateYearFilter(results);
                    resetPageAndFilter();
                    resultsSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Ralat mencari sijil: ", error);
                alert("Berlaku ralat semasa semakan.");
            } finally {
                setLoading(false);
            }
        }

        function populateYearFilter(results) {
            const yearSelect = document.getElementById('filter-year-select');
            // Pastikan pilihan lama dibersihkan sebelum menambah yang baru
            yearSelect.innerHTML = '<option value="">Semua Tahun</option>';
            const years = [...new Set(results.map(r =>
                r.programData.startDate ? new Date(r.programData.startDate + 'T00:00:00').getFullYear() : null
            ))].filter(Boolean);

            years.sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function filterAndDisplayResults() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedMonth = monthFilter.value;
            const selectedYear = yearFilter.value;
            const sijilOnly = sijilOnlyFilter.checked;

            const filteredList = window.certificateResults.filter(result => {
                const program = result.programData;
                const programDate = program.startDate ? new Date(program.startDate + 'T00:00:00') : null;

                const nameMatch = !searchTerm || (program.name && program.name.toLowerCase().includes(searchTerm));
                const yearMatch = !selectedYear || (programDate && programDate.getFullYear() == selectedYear);
                const monthMatch = !selectedMonth || (programDate && (programDate.getMonth() + 1) == selectedMonth);
                const sijilMatch = !sijilOnly || program.eCertificateNeeded === true;

                return nameMatch && yearMatch && monthMatch && sijilMatch;
            });

            certificatesTableBody.innerHTML = "";
            noFilterResults.classList.add('hidden');

            itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            const totalItems = filteredList.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedList = filteredList.slice(startIndex, endIndex);

            if (paginatedList.length > 0) {
                paginatedList.forEach((result, index) => {
                    const overallIndex = startIndex + index;
                    const rowHTML = createCertificateRow(result, overallIndex);
                    certificatesTableBody.innerHTML += rowHTML;
                });
                paginationControls.style.display = 'flex';
            } else {
                paginationControls.style.display = 'none';
                if (window.certificateResults.length > 0) { // Hanya tunjuk jika ada hasil asal
                   noFilterResults.classList.remove('hidden');
                }
            }

            paginationInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            prevPageBtn.disabled = (currentPage === 1);
            nextPageBtn.disabled = (currentPage === totalPages || totalItems === 0);
        }

        function createCertificateRow(result, bilIndex) {
            const { programData, participantData } = result;

            const startDateStr = programData.startDate ? new Date(programData.startDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const endDateStr = programData.endDate ? new Date(programData.endDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const dateDisplay = (startDateStr === endDateStr) ? startDateStr : `${startDateStr} - ${endDateStr}`;

            let isCertificateAvailable = false;
            let statusHTML = '';
            let actionHTML = '';
            let unavailableMessage = "Sijil tidak disediakan.";

            if (programData.eCertificateNeeded === true) {

                const evaluations = programData.evaluations || [];
                const hasEvaluated = evaluations.some(eval => eval.ic === participantData.ic);

                if (programData.evaluationNeeded === true) {

                    if (!hasEvaluated) {
                        statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Perlu Penilaian</span>`;
                        const evalUrl = `penilaianprogram.html?kod=${programData.evaluationKey}`;
                        actionHTML = `<a href="${evalUrl}" target="_blank" class="btn bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">Isi Penilaian</a>`;

                    } else {
                        isCertificateAvailable = true;
                        statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Tersedia</span>`;
                    }

                } else {
                    if (programData.endDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const programEndDate = new Date(programData.endDate + 'T00:00:00');
                        isCertificateAvailable = today > programEndDate;

                        if (isCertificateAvailable) {
                            statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Tersedia</span>`;
                        } else {
                            const endDateString = programEndDate.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long' });
                            unavailableMessage = `Tersedia selepas ${endDateString}`;
                            statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Belum Sedia</span>`;
                            actionHTML = `<p class="text-sm text-gray-500 italic px-4">${unavailableMessage}</p>`;
                        }
                    } else {
                        unavailableMessage = "Tarikh tamat tidak ditetapkan.";
                        statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-700">Ralat</span>`;
                        actionHTML = `<p class="text-sm text-gray-500 italic px-4">${unavailableMessage}</p>`;
                    }
                }
            } else {
                statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-700">Tiada Sijil</span>`;
                actionHTML = `<p class="text-sm text-gray-500 italic px-4">-</p>`;
            }

            if (isCertificateAvailable) {
                 actionHTML = `
                    <div class="flex justify-center items-center gap-2">
                        <button onclick="printCertificate('${programData.key}')" title="Cetak Sijil" class="btn bg-green-500 text-white font-bold p-2 rounded-lg hover:bg-green-600 text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                            <span class="ml-1 hidden md:inline">Cetak</span>
                        </button>
                        <button id="pdf-btn-${programData.key}" onclick="downloadCertificatePDF(this, '${programData.key}')" title="Muat Turun PDF" class="btn bg-red-500 text-white font-bold p-2 rounded-lg hover:bg-red-600 text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            <span class="ml-1 hidden md:inline">PDF</span>
                        </button>
                    </div>
                `;
            }

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bilIndex + 1}.</td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-semibold text-gray-900">${programData.name || 'Nama Program Tidak Ditemui'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${dateDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusHTML}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${actionHTML}</td>
                </tr>
            `;
        }

        function getCertificateData(programKey) {
            const result = window.certificateResults.find(r => r.programData.key === programKey);
            if (result === undefined) {
                alert("Ralat: Data sijil tidak ditemui.");
                return null;
            }
            const { programData, participantData } = result;

            const participantName = participantData.name.toUpperCase();
            const participantIC = participantData.ic;
            const courseName = programData.name.toUpperCase();

            const startDate = new Date(programData.startDate + 'T00:00:00');
            const endDate = new Date(programData.endDate + 'T00:00:00');
            let dateString;

            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const programIdentifier = programData.key || 'SPARK';
            const serialNumber = `SPK/${programIdentifier}/${participantIC.slice(-4)}`;

            const validationUrl = `${window.location.origin}${window.location.pathname}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;

            return {
                participantName, participantIC, courseName, dateString, serialNumber, qrCodeUrl
            };
        }

        function getCertificateHTML(data) {
            return `
                <!DOCTYPE html>
                <html lang="ms">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Sijil Penyertaan - ${data.participantName}</title>
                    <script src="https://cdn.tailwindcss.com"></script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; font-weight: 400; margin: 0; padding: 0; color: #333; }
                        body.pdf-render { background-color: white; min-height: 0; }
                        .certificate-container { width: 210mm; height: 297mm; background-color: white; padding: 12mm; box-sizing: border-box; position: relative; display: flex; flex-direction: column; text-align: center; overflow: hidden; }
                        body.print-preview { background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                        body.print-preview .certificate-container { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); }
                        .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
                        .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                        .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                        .certificate-content { border: 6px solid; border-image-slice: 1; border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); height: 100%; padding: 10mm; box-sizing: border-box; position: relative; z-index: 2; display: flex; flex-direction: column; background: #ffffff; }
                        .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                        .qr-code { width: 65px; height: 65px; }
                        .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                        .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                        h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                        .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                        .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                        .event-title-label { font-size: 16px; color: #555; }
                        .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                        .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                        .signature-section { margin-top: auto; }
                        .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                        .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                        .spark-section { margin-top: 15px; }
                        .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                        @media print {
                            body { background-color: white; }
                            .certificate-container { box-shadow: none; margin: 0; }
                            @page { size: A4 portrait; margin: 0; }
                        }
                    </style>
                </head>
                <body class="print-preview">
                    <div class="certificate-container">
                        <div class="certificate-content">
                            <div class="header-section">
                                <img src="${data.qrCodeUrl}" alt="QR Code" class="qr-code">
                                <p class="serial-number">NO. SIRI: ${data.serialNumber}</p>
                            </div>
                            <img src="https://i.imgur.com/FQpwGDo.png" alt="Logo Pejabat Pendidikan Daerah Miri" class="logo">
                            <h1>Sijil Penyertaan</h1>
                            <p class="intro-text">Dengan ini disahkan bahawa</p>
                            <p class="recipient-name">${data.participantName}</p>
                            <p class="recipient-ic">${data.participantIC}</p>
                            <p class="event-title-label">telah mengikuti</p>
                            <p class="event-title">${data.courseName}</p>
                            <p class="event-date">${data.dateString}</p>
                            <hr class="divider">
                            <div class="signature-section">
                                <p class="signatory-name">MARIAM HAJI MONEK</p>
                                <p class="signatory-title">PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                            </div>
                            <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                            <div class="spark-section">
                                <p class="spark-title">SPARK</p>
                                <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        function printCertificate(programKey) {
            const data = getCertificateData(programKey);
            if (!data) return;
            const htmlContent = getCertificateHTML(data);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.onload = function() {
                const images = printWindow.document.images;
                let loadedImages = 0;
                const totalImages = images.length;
                if (totalImages === 0) {
                     printWindow.focus();
                     printWindow.print();
                     return;
                }
                [...images].forEach(img => {
                    if (img.complete) {
                        loadedImages++;
                    } else {
                        img.onload = () => {
                            loadedImages++;
                            if (loadedImages === totalImages) {
                                printWindow.focus();
                                printWindow.print();
                            }
                        };
                        img.onerror = img.onload;
                    }
                });
                if (loadedImages === totalImages) {
                     printWindow.focus();
                     printWindow.print();
                }
            };
        }

        async function downloadCertificatePDF(buttonElement, programKey) {
            const { jsPDF } = window.jspdf;
            const html2canvas = window.html2canvas;
            if (typeof jsPDF === 'undefined' || typeof html2canvas === 'undefined') {
                alert("Gagal memuatkan perpustakaan PDF. Sila muat semula halaman.");
                return;
            }
            const originalButtonContent = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            const data = getCertificateData(programKey);
            if (!data) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonContent;
                return;
            }
            const renderArea = document.createElement('div');
            renderArea.id = 'pdf-render-area';
            renderArea.style.position = 'fixed';
            renderArea.style.left = '-300mm';
            renderArea.style.top = '0';
            renderArea.style.width = '210mm';
            renderArea.style.height = '297mm';
            document.body.appendChild(renderArea);
            renderArea.innerHTML = getCertificateHTML(data).replace('class="print-preview"', 'class="pdf-render"');
            const certificateElement = renderArea.querySelector('.certificate-container');
            const images = certificateElement.querySelectorAll('img');
            const imagePromises = [...images].map(img =>
                new Promise((resolve) => {
                    img.crossOrigin = 'anonymous';
                    if (img.complete) {
                        resolve();
                    } else {
                        img.onload = resolve;
                        img.onerror = resolve;
                    }
                    const originalSrc = img.src;
                    img.src = ''; // Force reload if cached without CORS
                    img.src = originalSrc;
                })
            );

            try {
                await Promise.all(imagePromises);
                await new Promise(resolve => setTimeout(resolve, 100)); // Short delay for rendering

                const canvas = await html2canvas(certificateElement, {
                    scale: 3,
                    useCORS: true,
                    width: certificateElement.offsetWidth,
                    height: certificateElement.offsetHeight,
                    logging: false
                });

                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });
                const pdfWidth = 210;
                const pdfHeight = 297;
                pdf.addImage(canvas.toDataURL('image/png', 0.95), 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`sijil_${data.participantName.replace(/ /g, '_')}_${programKey}.pdf`);

            } catch (error) {
                console.error("Gagal menjana PDF:", error);
                alert("Berlaku ralat semasa menjana PDF. Imej luaran mungkin disekat atau isu pemaparan. Sila cuba cetak.");
            } finally {
                if (document.getElementById('pdf-render-area')) {
                     document.body.removeChild(renderArea);
                }
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonContent;
            }
        }

        function displayParticipantInfo(data,maskedIc){const pName=document.getElementById("participant-name"),pIc=document.getElementById("participant-ic"),pPos=document.getElementById("participant-position"),pSta=document.getElementById("participant-station");pName.textContent=data.name||"-";pIc.textContent=maskedIc;pPos.textContent=data.position||"-";pSta.textContent=data.station||"-";document.getElementById("participant-info").classList.remove("hidden")}
        function maskIc(ic){if(ic&&ic.length>4){return ic.slice(0,-4).replace(/./g,"*")+ic.slice(-4)}return"****"}
        function setLoading(isLoading){checkBtn.disabled=isLoading;document.getElementById("search-icon").classList.toggle("hidden",isLoading);document.getElementById("loading-spinner").classList.toggle("hidden",!isLoading);buttonText.textContent=isLoading?"Menyemak...":"Semak"}

        function resetPageAndFilter() {
            currentPage = 1;
            filterAndDisplayResults();
        }

        function changeItemsPerPage() {
            resetPageAndFilter();
        }

        function changePage(direction) {
            currentPage += direction;
            filterAndDisplayResults();
        }

        function resetDisplay(){
            resultsSection.classList.add("hidden");
            certificatesTableBody.innerHTML="";
            participantInfoDiv.classList.add("hidden");
            noResultsMessage.classList.add("hidden");
            noFilterResults.classList.add('hidden');
            window.certificateResults = [];

            searchInput.value = "";
            monthFilter.value = "";
            yearFilter.innerHTML = '<option value="">Semua Tahun</option>';
            sijilOnlyFilter.checked = true;

            currentPage = 1;
            itemsPerPageSelect.value = "10";
            paginationControls.style.display = 'none';
        }

        window.printCertificate = printCertificate;
        window.downloadCertificatePDF = downloadCertificatePDF;
        window.resetPageAndFilter = resetPageAndFilter;
        window.changeItemsPerPage = changeItemsPerPage;
        window.changePage = changePage;
    </script>
</body>
</html>
