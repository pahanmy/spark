<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ e-Sijil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Animasi Loading */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                     <button onclick="window.history.back()" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors" title="Kembali">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <div>
                        <span class="text-xl font-bold text-indigo-600 block leading-none">SPARK</span>
                        <span class="text-[10px] text-gray-500">e-Sijil & Penghargaan</span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" class="w-full max-w-5xl mx-auto flex-grow p-4 md:p-8">
        
        <div id="initial-loader" class="text-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 animate-pulse">Sedang mencari rekod sijil anda...</p>
        </div>

        <input type="hidden" id="ic-input">

        <div id="participant-info" class="hidden card bg-indigo-50 p-6 mb-6 border border-indigo-200 max-w-4xl mx-auto">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                 <div>
                     <h2 class="text-lg font-bold text-indigo-800 uppercase" id="participant-name">Memuatkan...</h2>
                     <p class="text-sm text-indigo-600 font-medium" id="participant-ic">-</p>
                 </div>
                 <div class="text-sm text-gray-600 bg-white/50 p-3 rounded-lg border border-indigo-100 w-full md:w-auto">
                     <p><span class="font-bold text-xs uppercase text-gray-400">Jawatan:</span> <span id="participant-position" class="font-medium">-</span></p>
                     <p><span class="font-bold text-xs uppercase text-gray-400">Stesen:</span> <span id="participant-station" class="font-medium">-</span></p>
                 </div>
             </div>
        </div>
        
        <div id="results-section" class="hidden max-w-4xl mx-auto">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138z"></path></svg>
                    Sijil Anda
                </h2>
                <div class="text-xs text-gray-500 italic">
                    Hanya sijil yang tersedia dipaparkan.
                </div>
            </div>

            <div class="card overflow-hidden shadow-lg border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-10">Bil</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Program</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32">Status</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-40">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                
                <div id="no-results-message" class="hidden text-center py-12 px-4">
                    <div class="bg-gray-50 rounded-full p-4 inline-block mb-3">
                        <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">Tiada Sijil Ditemui</h3>
                    <p class="text-sm text-gray-500 mt-1">Anda mungkin belum menghadiri program yang menawarkan sijil, atau program tersebut belum tamat.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t mt-auto">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600 text-xs"><p>SPARK e-Sijil System</p></div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = firebaseConfig.projectId;
        
        const certificatesTableBody = document.getElementById('certificates-table-body');
        const resultsSection = document.getElementById('results-section');
        const noResultsMessage = document.getElementById('no-results-message');
        const participantInfoDiv = document.getElementById('participant-info');
        const initialLoader = document.getElementById('initial-loader');

        // Main Logic: Auto-run bila user login (anonymous)
        auth.onAuthStateChanged(user => {
            if (user) {
                // 1. Ambil IC dari URL secara automatik
                const urlParams = new URLSearchParams(window.location.search);
                const urlIc = urlParams.get('ic');

                if (urlIc) {
                    findCertificatesByIc(urlIc);
                } else {
                    // Jika tiada IC di URL, tendang balik ke user.html
                    alert("Akses tidak sah. Sila masuk melalui Papan Pemuka.");
                    window.location.href = 'user.html';
                }
            } else {
                auth.signInAnonymously().catch(e => console.error(e));
            }
        });

        async function findCertificatesByIc(icRaw) {
            const icNumber = icRaw.trim().replace(/[^0-9]/g, '');
            
            try {
                // Fetch semua program
                const programsRef = db.collection(`artifacts/${appId}/public/data/spark_programs`);
                const programsSnapshot = await programsRef.get();

                let actionableCertificates = [];
                
                programsSnapshot.docs.forEach(programDoc => {
                    const programData = programDoc.data();
                    const attendanceArray = programData.attendance || [];
                    
                    // Cari peserta dalam program ini
                    const participantData = attendanceArray.find(p => p.ic === icNumber); 
                    
                    if (participantData) {
                        // Tentukan status sijil
                        const status = getCertificateStatus(programData, participantData);
                        
                        // HANYA simpan jika status ialah "Tersedia" atau "Perlu Penilaian"
                        if (status.isActionable) {
                            actionableCertificates.push({ 
                                programData, 
                                participantData,
                                statusInfo: status 
                            });
                        }
                    }
                });

                // Paparan
                initialLoader.classList.add('hidden');
                
                if (actionableCertificates.length > 0) {
                    // Sort: Yang perlu penilaian diletakkan di atas sekali
                    actionableCertificates.sort((a, b) => {
                        if (a.statusInfo.type === 'EVAL' && b.statusInfo.type !== 'EVAL') return -1;
                        if (a.statusInfo.type !== 'EVAL' && b.statusInfo.type === 'EVAL') return 1;
                        // Kalau sama, ikut tarikh baru ke lama
                        return new Date(b.programData.startDate) - new Date(a.programData.startDate);
                    });

                    // Update Header Info (Ambil dari data pertama yang jumpa)
                    displayParticipantInfo(actionableCertificates[0].participantData, maskIc(icNumber));
                    
                    // Render Table
                    renderTable(actionableCertificates);
                    resultsSection.classList.remove('hidden');
                } else {
                    resultsSection.classList.remove('hidden');
                    noResultsMessage.classList.remove('hidden');
                    document.querySelector('table').classList.add('hidden'); // Sembunyi table kosong
                }

            } catch (error) {
                console.error("Ralat:", error);
                alert("Berlaku ralat sistem. Sila cuba sebentar lagi.");
                initialLoader.classList.add('hidden');
            }
        }

        function getCertificateStatus(programData, participantData) {
            // Default: Tidak Actionable
            let result = { isActionable: false, html: '', actionBtn: '', type: 'NONE' };
            
            // Cek 1: Adakah program menyediakan sijil?
            if (programData.eCertificateNeeded === true) {
                
                const evaluations = programData.evaluations || [];
                const hasEvaluated = evaluations.some(eval => eval.ic === participantData.ic);

                // Cek 2: Perlu Penilaian?
                if (programData.evaluationNeeded === true) {
                    if (!hasEvaluated) {
                        // KES: PERLU PENILAIAN (ACTIONABLE)
                        result.isActionable = true;
                        result.type = 'EVAL';
                        result.html = `<span class="px-3 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700 border border-blue-200 uppercase tracking-wide">PERLU PENILAIAN</span>`;
                        const evalUrl = `penilaianprogram.html?kod=${programData.evaluationKey}`;
                        result.actionBtn = `<a href="${evalUrl}" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg shadow-sm uppercase transition-all gap-2 w-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Isi Borang
                        </a>`;
                    } else {
                        // KES: SUDAH NILAI -> BOLEH DOWNLOAD (ACTIONABLE)
                        result.isActionable = true;
                        result.type = 'DOWNLOAD';
                        result.html = `<span class="px-3 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-700 border border-green-200 uppercase tracking-wide">SIJIL TERSEDIA</span>`;
                        result.actionBtn = `<button onclick="printCertificate('${programData.key}')" class="inline-flex items-center justify-center px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white text-xs font-bold rounded-lg shadow-sm uppercase transition-all gap-2 w-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Muat Turun
                        </button>`;
                    }
                } else {
                    // Cek 3: Tak perlu penilaian, cek tarikh tamat
                    if (programData.endDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const programEndDate = new Date(programData.endDate + 'T00:00:00');
                        
                        if (today > programEndDate) {
                            // KES: TAMAT -> BOLEH DOWNLOAD (ACTIONABLE)
                            result.isActionable = true;
                            result.type = 'DOWNLOAD';
                            result.html = `<span class="px-3 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-700 border border-green-200 uppercase tracking-wide">SIJIL TERSEDIA</span>`;
                            result.actionBtn = `<button onclick="printCertificate('${programData.key}')" class="inline-flex items-center justify-center px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white text-xs font-bold rounded-lg shadow-sm uppercase transition-all gap-2 w-full">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Muat Turun
                            </button>`;
                        }
                    }
                }
            }
            return result;
        }

        function renderTable(list) {
            certificatesTableBody.innerHTML = "";
            list.forEach((item, index) => {
                const { programData, statusInfo } = item;
                
                // Format Tarikh
                const startDateStr = programData.startDate ? new Date(programData.startDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
                
                const row = `
                    <tr class="hover:bg-indigo-50/30 transition-colors border-b border-gray-100 last:border-0">
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 font-medium">${index + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-800 uppercase leading-snug">${programData.name}</div>
                            <div class="text-[10px] text-gray-500 mt-1 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                ${startDateStr}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            ${statusInfo.html}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            ${statusInfo.actionBtn}
                        </td>
                    </tr>
                `;
                certificatesTableBody.innerHTML += row;
            });
            
            // Simpan data global untuk fungsi print
            window.certificateResults = list;
        }
        
        function printCertificate(programKey) {
            const result = window.certificateResults.find(r => r.programData.key === programKey);

            if (!result) { alert("Data sijil tidak ditemui."); return; }
            
            const { programData, participantData } = result;
            
            // --- KOD CETAK SIJIL (SAMA SEPERTI SEBELUM INI) ---
            const participantName = participantData.name.toUpperCase();
            const participantIC = participantData.ic;
            const courseName = programData.name.toUpperCase();
            
            const startDate = new Date(programData.startDate + 'T00:00:00');
            const endDate = new Date(programData.endDate + 'T00:00:00');
            let dateString;
            
            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const programIdentifier = programData.key || 'SPARK'; 
            const serialNumber = `SPK/${programIdentifier}/${participantIC.slice(-4)}`;
            
            const validationUrl = `${window.location.origin}${window.location.pathname}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ms">
                <head>
                    <meta charset="UTF-8">
                    <title>Sijil Penyertaan - ${participantName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #333; }
                        .certificate-container { width: 210mm; height: 297mm; background-color: white; padding: 12mm; box-sizing: border-box; position: relative; display: flex; flex-direction: column; text-align: center; overflow: hidden; }
                        .certificate-content { border: 6px solid; border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); border-image-slice: 1; height: 100%; padding: 10mm; box-sizing: border-box; position: relative; z-index: 2; display: flex; flex-direction: column; background: #ffffff; }
                        .header-section { display: flex; justify-content: space-between; width: 100%; height: 75px; }
                        .qr-code { width: 65px; height: 65px; }
                        .serial-number { font-family: 'Courier New', monospace; font-size: 14px; color: #555; }
                        .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                        h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; color: #4B40FF; }
                        .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                        .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                        .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; }
                        .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; }
                        .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; }
                        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                        .signature-section { margin-top: auto; }
                        .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; color: #4B40FF; }
                        @media print { body { background-color: white; } .certificate-container { box-shadow: none; margin: 0; } @page { size: A4 portrait; margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="certificate-content">
                            <div class="header-section">
                                <img src="${qrCodeUrl}" alt="QR" class="qr-code">
                                <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                            </div>
                            <img src="https://i.imgur.com/FQpwGDo.png" alt="Logo" class="logo">
                            <h1>Sijil Penyertaan</h1>
                            <p class="intro-text">Dengan ini disahkan bahawa</p>
                            <p class="recipient-name">${participantName}</p>
                            <p class="recipient-ic">${participantIC}</p>
                            <p class="intro-text">telah mengikuti</p>
                            <p class="event-title">${courseName}</p>
                            <p class="event-date">${dateString}</p>
                            <hr class="divider">
                            <div class="signature-section">
                                <p class="signatory-name">MARIAM HAJI MONEK</p>
                                <p>PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                            </div>
                            <div style="margin-top:20px; font-size:10px; font-style:italic; color:#999;">Sijil cetakan komputer. Tandatangan tidak diperlukan.</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.focus(); printWindow.print(); };
        }
        
        function displayParticipantInfo(data, maskedIc){
            document.getElementById("participant-name").textContent = data.name.toUpperCase() || "-";
            document.getElementById("participant-ic").textContent = maskedIc;
            document.getElementById("participant-position").textContent = (data.position || "-").toUpperCase();
            document.getElementById("participant-station").textContent = (data.station || "-").toUpperCase();
            document.getElementById("participant-info").classList.remove("hidden");
        }
        
        function maskIc(ic){
            if(ic && ic.length > 4){ return ic.slice(0,-4).replace(/./g,"*") + ic.slice(-4); }
            return "****";
        }
    </script>
</body>
</html>
