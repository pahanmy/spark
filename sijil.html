<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK ‚Äì e-Sijil & Penghargaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        /* Animasi Loading */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .logo-pulse { animation: pulse-logo 2s infinite; }
        @keyframes pulse-logo { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white">
                        <path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-indigo-600 uppercase tracking-wide">SPARK Sijil</h1>
                    <p class="text-[10px] text-gray-500 font-medium">Hab Sijil Digital & Penghargaan</p>
                </div>
            </div>
            <div>
                 <button onclick="window.location.href='user.html'" class="btn bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 flex items-center gap-2 text-xs uppercase">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Kembali ke Menu
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-5xl mx-auto px-4 sm:px-6 py-8">
        
        <div id="initial-loader" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4 border-indigo-600 border-t-transparent"></div>
            <p class="text-sm text-gray-500 font-medium animate-pulse">Sedang menyemak rekod sijil anda...</p>
        </div>

        <div id="content-container" class="hidden space-y-6">

            <div class="card p-6 border-l-4 border-amber-400 bg-gradient-to-r from-white to-amber-50/50">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Status Akaun:</span>
                            
                            <span id="pro-badge" class="hidden flex items-center gap-1 font-bold text-gray-800 text-xs uppercase">
                                üèÜ SPARK <span class="bg-red-600 text-white px-1.5 py-0.5 rounded text-[10px]">PRO</span>
                            </span>

                            <span id="normal-badge" class="text-xs font-bold text-gray-400 uppercase">BIASA</span>
                        </div>

                        <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 uppercase tracking-tight leading-none" id="welcome-title">Tahniah!</h2>
                        <p class="text-sm text-gray-600 mt-2 leading-relaxed" id="summary-text">Mengira sijil...</p>
                    </div>
                    
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Paparan Rekod</p>
                        <p class="text-3xl font-extrabold text-indigo-600" id="current-year-display">...</p>
                    </div>
                </div>
            </div>

            <div class="card overflow-hidden shadow-lg border border-gray-100">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h3 class="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138z" /></svg>
                        Senarai Sijil
                    </h3>
                    
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <label for="year-filter" class="text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Tahun:</label>
                        <select id="year-filter" onchange="applyYearFilter()" class="block w-full sm:w-32 px-2 py-1.5 text-xs font-bold text-gray-700 bg-white border border-gray-300 rounded focus:border-indigo-500 focus:outline-none uppercase shadow-sm">
                            </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider w-10">Bil</th>
                                <th scope="col" class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-wider">Program / Jenis</th>
                                <th scope="col" class="px-6 py-3 text-center text-[10px] font-bold text-gray-400 uppercase tracking-wider w-32">Status</th>
                                <th scope="col" class="px-6 py-3 text-center text-[10px] font-bold text-gray-400 uppercase tracking-wider w-40">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div id="no-results-message" class="hidden text-center py-12 px-4 bg-white">
                    <div class="bg-gray-50 rounded-full p-4 inline-block mb-3">
                        <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">Tiada rekod sijil dijumpai untuk tahun ini.</p>
                </div>
            </div>

            <p class="text-xs text-gray-400 text-center italic mt-4">
                SPARK e-Sijil v3.5. Sijil dijana secara digital.
            </p>
        </div>
    </main>

    <footer class="text-center py-6 mt-auto border-t border-gray-200 bg-white">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="#" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p class="text-xs text-gray-400 mt-1">Hak Cipta Terpelihara</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = firebaseConfig.projectId;

        // TAHUN SEMASA SYSTEM
        const currentYear = new Date().getFullYear();
        document.getElementById('current-year-display').textContent = currentYear;

        const loader = document.getElementById('initial-loader');
        const container = document.getElementById('content-container');
        const tableBody = document.getElementById('certificates-table-body');
        const noResults = document.getElementById('no-results-message');
        const yearSelect = document.getElementById('year-filter');

        // Global Data Storage
        let allCertificates = [];
        let globalUserName = "";
        let globalIsPro = false;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlIc = urlParams.get('ic');
                if (urlIc) {
                    await initPage(urlIc);
                } else {
                    alert("Akses tidak sah. Sila log masuk semula dari Papan Pemuka.");
                    window.location.href = 'user.html';
                }
            } else {
                auth.signInAnonymously().catch(e => console.error(e));
            }
        });

        async function initPage(icRaw) {
            const icNumber = icRaw.trim().replace(/[^0-9]/g, '');
            try {
                // 1. Cek Status PRO
                globalIsPro = await checkUserProStatus(icNumber);
                if(globalIsPro) {
                    document.getElementById('pro-badge').classList.remove('hidden');
                    document.getElementById('normal-badge').classList.add('hidden');
                }
                
                // 2. Fetch Semua Data
                await fetchAllCertificates(icNumber);

            } catch (error) {
                console.error("Ralat init:", error);
                alert("Gagal memuatkan data.");
            }
        }

        async function checkUserProStatus(ic) {
            try {
                if(ic === "890522135381") return true; 
                const usersRef = db.collection(`artifacts/${appId}/public/data/spark_participants`);
                const q = usersRef.where("ic", "==", ic);
                const snapshot = await q.get();
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    return data.isPro === true;
                }
                return false;
            } catch (e) { return false; }
        }

        async function fetchAllCertificates(ic) {
            const programsRef = db.collection(`artifacts/${appId}/public/data/spark_programs`);
            const snapshot = await programsRef.get();

            allCertificates = [];
            globalUserName = "";

            snapshot.docs.forEach(doc => {
                const prog = doc.data();
                const attendance = prog.attendance || [];
                const participant = attendance.find(p => p.ic === ic);

                if (participant) {
                    if (!globalUserName) globalUserName = participant.name;
                    allCertificates.push({
                        program: prog,
                        participant: participant
                    });
                }
            });

            populateYearDropdown();
            yearSelect.value = currentYear;
            applyYearFilter();
            
            loader.classList.add('hidden');
            container.classList.remove('hidden');
        }

        function populateYearDropdown() {
            const years = new Set();
            years.add(currentYear); 
            allCertificates.forEach(item => {
                const y = new Date(item.program.startDate).getFullYear();
                years.add(y);
            });
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            yearSelect.innerHTML = "";
            sortedYears.forEach(year => {
                const opt = document.createElement('option');
                opt.value = year;
                opt.textContent = `TAHUN ${year}`;
                yearSelect.appendChild(opt);
            });
        }

        window.applyYearFilter = function() {
            const selectedYear = parseInt(yearSelect.value);
            document.getElementById('current-year-display').textContent = selectedYear;

            const filteredData = allCertificates.filter(item => {
                const itemYear = new Date(item.program.startDate).getFullYear();
                return itemYear === selectedYear;
            });

            const processedList = [];
            let totalAvailable = 0;
            let totalLocked = 0;

            filteredData.forEach(item => {
                const status = getCertificateStatus(item.program, item.participant, globalIsPro);
                if (status.isRelevant) {
                    if (status.isLocked) totalLocked++;
                    else if (status.type === 'DOWNLOAD') totalAvailable++;
                    processedList.push({ ...item, status: status });
                }
            });

            updateSummaryCard(globalUserName, totalAvailable, totalLocked, selectedYear);

            if (processedList.length > 0) {
                processedList.sort((a, b) => new Date(b.program.startDate) - new Date(a.program.startDate));
                renderTable(processedList);
                noResults.classList.add('hidden');
                document.querySelector('table').classList.remove('hidden');
            } else {
                renderTable([]); 
                noResults.classList.remove('hidden');
                document.querySelector('table').classList.add('hidden');
            }
        }

        function updateSummaryCard(name, available, locked, year) {
            const titleEl = document.getElementById('welcome-title');
            const summaryEl = document.getElementById('summary-text');
            const fullName = name ? name.toUpperCase() : "PENGGUNA";
            
            titleEl.textContent = `TAHNIAH, ${fullName}!`;

            if (available > 0) {
                summaryEl.innerHTML = `Pada tahun <span class="font-bold">${year}</span>, anda mempunyai <span class="font-bold text-indigo-600">${available} sijil</span> untuk dimuat turun.`;
            } else {
                summaryEl.textContent = `Tiada sijil yang tersedia untuk tahun ${year}.`;
            }

            if (locked > 0) {
                 summaryEl.innerHTML += ` <br><span class="text-xs text-gray-500 mt-2 inline-block bg-gray-100 px-3 py-1.5 rounded-lg border border-gray-200 leading-snug">
                    Terdapat <b>${locked} sijil arkib</b> pada tahun ${year}. Akses arkib dikhaskan untuk akaun <b>Spark Pro</b>.
                    <a href="sponsor.html" class="text-indigo-600 hover:text-indigo-800 underline font-bold ml-1">Ketahui Lanjut</a>
                 </span>`;
            }
        }

        function getCertificateStatus(prog, part, isPro) {
            let result = { isRelevant: false, isLocked: false, html: '', btn: '', type: 'NONE' };
            const specialRoles = ['Penceramah', 'Fasilitator', 'Urusetia'];
            const isSpecial = specialRoles.includes(part.role);
            
            if (prog.eCertificateNeeded === true) {
                const progDate = new Date(prog.startDate);
                const progYear = progDate.getFullYear();
                const isPastYear = progYear < currentYear;

                if (isPastYear && !isPro) {
                    result.isRelevant = true;
                    result.isLocked = true;
                    result.html = `<span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 uppercase tracking-wide">ARKIB ${progYear}</span>`;
                    result.btn = `<button onclick="window.location.href='sponsor.html'" class="w-full flex items-center justify-center gap-1.5 px-3 py-2 bg-white hover:bg-indigo-50 text-indigo-600 border border-indigo-200 text-[10px] font-bold rounded shadow-sm uppercase transition-all group" title="Ciri Eksklusif Akaun Pro">
                        <svg class="w-3 h-3 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg> Info Pro
                    </button>`;
                    return result; 
                }

                const evals = prog.evaluations || [];
                const hasEvaluated = evals.some(e => e.ic === part.ic);

                // Khas: Penceramah/Fasi/Urusetia tak wajib isi penilaian untuk dapat sijil, tapi jika program perlu penilaian, kita bagi juga.
                // Logik Asal: Jika Evaluation Needed & Not Evaluated -> Show Eval Button.
                // Modifikasi: Jika Special Role -> Bypass Evaluation Check? 
                // Untuk keselamatan & konsistensi sistem SPARK sedia ada, biasanya semua kena isi borang. 
                // TETAPI, selalunya Penceramah dapat sijil terus. 
                // Di sini saya kekalkan logik asal (Perlu Penilaian) KECUALI jika anda mahu ubah. 
                // Assumption: Penceramah pun perlu klik 'submit' evaluation walau kosong untuk trigger sijil dalam sistem ini, ATAU kita benarkan download terus.
                // SAYA KEKALKAN LOGIK ASAL (Mesti isi borang jika program kata perlu) supaya data konsisten.
                
                if (prog.evaluationNeeded === true && !hasEvaluated) {
                    result.isRelevant = true;
                    result.type = 'EVAL';
                    result.html = `<span class="px-2 py-1 rounded text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200 uppercase tracking-wide">PERLU PENILAIAN</span>`;
                    result.btn = `<a href="penilaianprogram.html?kod=${prog.evaluationKey}" class="w-full flex items-center justify-center gap-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold rounded shadow-sm uppercase transition-all">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Isi Borang
                    </a>`;
                } else if (prog.endDate) {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const endDate = new Date(prog.endDate + 'T00:00:00');
                    if (today > endDate || (prog.evaluationNeeded && hasEvaluated)) {
                        result.isRelevant = true;
                        result.type = 'DOWNLOAD';
                        const certType = isSpecial ? "PENGHARGAAN" : "PENYERTAAN";
                        const colorClass = isSpecial ? "bg-amber-100 text-amber-700 border-amber-200" : "bg-green-100 text-green-700 border-green-200";
                        result.html = `<span class="px-2 py-1 rounded text-[10px] font-bold ${colorClass} border uppercase tracking-wide">${certType}</span>`;
                        result.btn = `<button onclick="printCertificate('${prog.key}')" class="w-full flex items-center justify-center gap-1 px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white text-[10px] font-bold rounded shadow-sm uppercase transition-all">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Muat Turun
                        </button>`;
                    } else {
                        result.isRelevant = true;
                        result.html = `<span class="px-2 py-1 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200 uppercase tracking-wide">BELUM TAMAT</span>`;
                        result.btn = `<span class="text-[10px] text-gray-400 italic">Tunggu program tamat</span>`;
                    }
                }
            }
            return result;
        }

        function renderTable(list) {
            tableBody.innerHTML = "";
            window.certificateData = list;
            
            list.forEach((item, idx) => {
                const dateObj = new Date(item.program.startDate);
                const dateStr = dateObj.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                const yearStr = dateObj.getFullYear();
                const isCurrent = yearStr === currentYear;
                const yearBadgeClass = isCurrent ? "bg-indigo-100 text-indigo-700 border-indigo-200" : "bg-gray-100 text-gray-500 border-gray-200";
                
                const specialRoles = ['Penceramah', 'Fasilitator', 'Urusetia'];
                const userRole = item.participant.role || 'Peserta';
                const roleDisplay = specialRoles.includes(userRole) 
                    ? `<span class="text-[9px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 uppercase ml-2">${userRole}</span>` 
                    : '';

                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 font-medium">${idx + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-800 uppercase leading-tight mb-1 flex items-center flex-wrap">
                                ${item.program.name} ${roleDisplay}
                            </div>
                            <div class="flex items-center gap-2 text-[10px] font-bold uppercase">
                                <span class="${yearBadgeClass} px-1.5 py-0.5 rounded border">${yearStr}</span>
                                <span class="text-gray-400 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    ${dateStr}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle">
                            ${item.status.html}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center align-middle w-48">
                            ${item.status.btn}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        window.printCertificate = function(key) {
            const dataItem = window.certificateData.find(d => d.program.key === key);
            if(!dataItem) return alert("Ralat data.");

            const { program, participant } = dataItem;
            const participantName = participant.name.toUpperCase();
            const participantIC = participant.ic;
            const courseName = program.name.toUpperCase();
            const role = (participant.role || 'Peserta');
            
            // Logic Penentuan Jenis Sijil
            const specialRoles = ['Penceramah', 'Fasilitator', 'Urusetia'];
            const isSpecial = specialRoles.includes(role);
            const certificateTitle = isSpecial ? "Sijil Penghargaan" : "Sijil Penyertaan";
            
            // Badge Peranan (Hanya untuk Sijil Penghargaan)
            const roleBadge = isSpecial 
                ? `<div class="role-badge">SEBAGAI ${role.toUpperCase()}</div>` 
                : '';

            // Teks Intro (Berbeza sedikit ikut jenis)
            const introText = isSpecial 
                ? "Dengan tulus ikhlas merakamkan setinggi-tinggi penghargaan kepada" 
                : "Dengan ini disahkan bahawa";

            const eventLabel = isSpecial
                ? "Atas sumbangan bakti dan komitmen menjayakan"
                : "telah mengikuti";

            const startDate = new Date(program.startDate + 'T00:00:00');
            const endDate = new Date(program.endDate + 'T00:00:00');
            let dateString;
            
            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            // No Siri Khas: H (Penghargaan) atau P (Penyertaan - Default)
            const prefix = isSpecial ? "SPK-H" : "SPK";
            const serialNumber = `${prefix}/${program.key || 'GEN'}/${participantIC.slice(-4)}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent("VERIFIED: " + serialNumber)}`;
            
            const now = new Date();
            const genDate = now.toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const genTime = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: true });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ms">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${certificateTitle} - ${participantName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; font-weight: 400; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #333; }
                        .certificate-container { width: 210mm; height: 297mm; background-color: white; padding: 12mm; box-sizing: border-box; position: relative; display: flex; flex-direction: column; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; }
                        .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
                        .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                        .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                        .certificate-content { border: 6px solid; border-image-slice: 1; border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); height: 100%; padding: 10mm; box-sizing: border-box; position: relative; z-index: 2; display: flex; flex-direction: column; background: #ffffff; }
                        .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                        .qr-code { width: 65px; height: 65px; }
                        .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                        .logo { width: 150px; height: auto; margin: 0 auto 10px auto; }
                        
                        h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 10px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        
                        .role-badge { font-size: 18px; font-weight: 700; color: #d4af37; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }
                        
                        .intro-text { font-size: 16px; margin-top: 20px; margin-bottom: 20px; color: #555; }
                        .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                        .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                        .event-title-label { font-size: 16px; color: #555; }
                        .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                        .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                        
                        .signature-section { margin-top: auto; }
                        .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                        
                        .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                        
                        .spark-section { margin-top: 15px; }
                        .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                        .gen-timestamp { position: absolute; bottom: 5px; right: 10px; font-size: 9px; color: #aaa; font-family: sans-serif; }
                        
                        @media print {
                            body { background-color: white; }
                            .certificate-container { box-shadow: none; margin: 0; }
                            @page { size: A4 portrait; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="certificate-content">
                            <div class="header-section">
                                <img src="${qrCodeUrl}" alt="QR Code" class="qr-code">
                                <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                            </div>
                            <img src="https://i.imgur.com/FQpwGDo.png" alt="Logo PPD Miri" class="logo">
                            
                            <h1>${certificateTitle}</h1>
                            ${roleBadge}
                            
                            <p class="intro-text">${introText}</p>
                            <p class="recipient-name">${participantName}</p>
                            <p class="recipient-ic">${participantIC}</p>
                            <p class="event-title-label">${eventLabel}</p>
                            <p class="event-title">${courseName}</p>
                            <p class="event-date">${dateString}</p>
                            <hr class="divider">
                            
                            <div class="signature-section">
                                <p class="signatory-name">MARIAM HAJI MONEK</p>
                                <p class="signatory-title">PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                            </div>
                            <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                            
                            <div class="spark-section">
                                <p class="spark-title">SPARK</p>
                                <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                            </div>
                            <div class="gen-timestamp">Dijana: ${genDate}, ${genTime}</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { 
                printWindow.focus(); 
                printWindow.print();
            };
        }
    </script>
</body>
</html>
