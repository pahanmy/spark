<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ e-Sijil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .btn { transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .input-with-icon { position: relative; }
        .input-with-icon svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af; }
        .input-with-icon input { padding-left: 2.5rem; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <a href="index.html" class="flex flex-col">
                        <span class="text-2xl font-bold text-indigo-600">SPARK</span>
                        <span class="text-xs text-gray-500 -mt-1">Percikan Inovasi Kehadiran Digital</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" class="w-full max-w-5xl mx-auto flex-grow p-4 md:p-8">
        <div class="text-center my-8">
            <h1 class="text-4xl font-bold text-indigo-600">e-Sijil</h1>
            <p class="text-gray-600 mt-2">Masukkan No. Kad Pengenalan untuk paparkan sijil penyertaan anda.</p>
        </div>
        <div id="search-card" class="card p-8 mb-10 max-w-2xl mx-auto">
            <label for="ic-input" class="block text-sm font-medium text-gray-700 mb-2">Nombor Kad Pengenalan (tanpa sengkang)</label>
            <div class="flex shadow-sm rounded-md">
                <input type="text" id="ic-input" placeholder="Contoh: 900101131234" class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                <button id="check-btn" class="btn bg-indigo-600 text-white font-semibold px-8 py-3 rounded-r-md hover:bg-indigo-700 flex items-center">
                    <svg id="search-icon" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <svg id="loading-spinner" class="animate-spin h-5 w-5 mr-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="button-text">Semak</span>
                </button>
            </div>
        </div>
        <div id="participant-info" class="hidden card bg-indigo-50 p-6 mb-8 border border-indigo-200 max-w-2xl mx-auto">
             <h2 class="text-xl font-semibold text-indigo-800 mb-3">Maklumat Peserta</h2>
             <div class="space-y-1 text-gray-700">
                <p><span class="font-semibold w-32 inline-block">Nama</span>: <span id="participant-name">-</span></p><p><span class="font-semibold w-32 inline-block">No. K/P</span>: <span id="participant-ic">-</span></p><p><span class="font-semibold w-32 inline-block">Jawatan</span>: <span id="participant-position">-</span></p><p><span class="font-semibold w-32 inline-block">Stesen</span>: <span id="participant-station">-</span></p>
             </div>
        </div>
        
        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Senarai Sijil Penyertaan</h2>
            
            <div class="card p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <label for="search-program-input" class="block text-sm font-medium text-gray-700">Cari Program</label>
                        <div class="input-with-icon mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            <input type="text" id="search-program-input" oninput="filterAndDisplayResults()" placeholder="Taip nama program..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="md:col-span-1">
                         <label for="filter-month-select" class="block text-sm font-medium text-gray-700">Pilih Bulan</label>
                         <select id="filter-month-select" onchange="filterAndDisplayResults()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Semua Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Mac</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Jun</option>
                            <option value="7">Julai</option>
                            <option value="8">Ogos</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Disember</option>
                         </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="filter-year-select" class="block text-sm font-medium text-gray-700">Pilih Tahun</label>
                         <select id="filter-year-select" onchange="filterAndDisplayResults()" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Semua Tahun</option>
                         </select>
                    </div>
                </div>
            </div>

            <div class="card overflow-x-auto shadow-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Program</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarikh</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Sijil</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="certificates-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
                <div id="no-filter-results" class="text-center py-10 hidden">
                    <p class="text-gray-600 text-lg">Tiada program ditemui yang sepadan dengan carian anda.</p>
                </div>
            </div>
            
            <div id="no-results-message" class="text-center py-10 card hidden"><p class="text-gray-600 text-lg">Tiada rekod sijil ditemui.</p></div>
        </div>
    </main>

    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600 text-sm"><p>Projek Inovasi oleh Pahan</p><p class="text-xs text-gray-500 mt-1">Versi 3.0 (2025)</p></div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = firebaseConfig.projectId;
        
        const certificatesTableBody = document.getElementById('certificates-table-body');
        let certificateResults = []; 
        
        const checkBtn = document.getElementById('check-btn');
        const icInput = document.getElementById('ic-input');
        const resultsSection = document.getElementById('results-section');
        const noResultsMessage = document.getElementById('no-results-message');
        const participantInfoDiv = document.getElementById('participant-info');
        const searchIcon = document.getElementById('search-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        
        const searchInput = document.getElementById('search-program-input');
        const monthFilter = document.getElementById('filter-month-select');
        const yearFilter = document.getElementById('filter-year-select');
        const noFilterResults = document.getElementById('no-filter-results');

        auth.onAuthStateChanged(user => {
            if (user) {
                checkBtn.disabled = false;
                buttonText.textContent = 'Semak';
                checkBtn.addEventListener('click', findCertificatesByIc);
                icInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') findCertificatesByIc(); });
            }
        });
        if (!auth.currentUser) { auth.signInAnonymously().catch(e => console.error(e)); }

        async function findCertificatesByIc() {
            const icNumber = icInput.value.trim().replace(/[^0-9]/g, '');
            if (!icNumber) { alert("Sila masukkan Nombor Kad Pengenalan."); return; }
            setLoading(true);
            resetDisplay();
            try {
                const programsRef = db.collection(`artifacts/${appId}/public/data/spark_programs`);
                const programsSnapshot = await programsRef.get();

                window.certificateResults = [];
                
                programsSnapshot.docs.forEach(programDoc => {
                    const programData = programDoc.data();
                    const attendanceArray = programData.attendance || [];
                    const participantData = attendanceArray.find(p => p.ic === icNumber); 
                    
                    if (participantData) {
                        window.certificateResults.push({ 
                            programData: programData, 
                            participantData: participantData 
                        });
                    }
                });
                
                const results = window.certificateResults;

                if (results.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    resultsSection.classList.remove('hidden');
                } else {
                    displayParticipantInfo(results[0].participantData, maskIc(icNumber));
                    populateYearFilter(results);
                    filterAndDisplayResults();
                    resultsSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Ralat mencari sijil: ", error);
                alert("Berlaku ralat semasa semakan.");
            } finally {
                setLoading(false);
            }
        }
        
        function populateYearFilter(results) {
            const yearSelect = document.getElementById('filter-year-select');
            const years = [...new Set(results.map(r => 
                r.programData.startDate ? new Date(r.programData.startDate + 'T00:00:00').getFullYear() : null
            ))].filter(Boolean);
            
            years.sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function filterAndDisplayResults() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedMonth = monthFilter.value;
            const selectedYear = yearFilter.value;

            const filteredList = window.certificateResults.filter(result => {
                const program = result.programData;
                const programDate = program.startDate ? new Date(program.startDate + 'T00:00:00') : null;

                const nameMatch = !searchTerm || (program.name && program.name.toLowerCase().includes(searchTerm));
                const yearMatch = !selectedYear || (programDate && programDate.getFullYear() == selectedYear);
                const monthMatch = !selectedMonth || (programDate && (programDate.getMonth() + 1) == selectedMonth);

                return nameMatch && yearMatch && monthMatch;
            });

            certificatesTableBody.innerHTML = "";
            noFilterResults.classList.add('hidden');

            if (filteredList.length > 0) {
                filteredList.forEach((result, index) => {
                    const rowHTML = createCertificateRow(result, index);
                    certificatesTableBody.innerHTML += rowHTML;
                });
            } else {
                noFilterResults.classList.remove('hidden');
            }
        }

        // =================================================================
        // #### FUNGSI JAVASCRIPT DIUBAH SUAI: createCertificateRow ####
        // (Logik semakan penilaian ditukar di sini)
        // =================================================================
        function createCertificateRow(result, bilIndex) {
            const { programData, participantData } = result;

            const startDateStr = programData.startDate ? new Date(programData.startDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const endDateStr = programData.endDate ? new Date(programData.endDate + 'T00:00:00').toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const dateDisplay = (startDateStr === endDateStr) ? startDateStr : `${startDateStr} - ${endDateStr}`;
            
            let isCertificateAvailable = false;
            let statusHTML = '';
            let actionHTML = '';
            let unavailableMessage = "Sijil tidak disediakan.";

            // 1. Semak jika sijil DISEDIAKAN
            if (programData.eCertificateNeeded === true) {
                
                // #### PERUBAHAN UTAMA: Semak Array Penilaian ####
                // Dapatkan array 'evaluations', atau array kosong jika tiada
                const evaluations = programData.evaluations || [];
                // Semak jika IC peserta wujud dalam array 'evaluations'
                const hasEvaluated = evaluations.some(eval => eval.ic === participantData.ic);
                // #### TAMAT PERUBAHAN UTAMA ####

                // 2. Semak jika perlu PENILAIAN
                // Logik diubah: `participantData.certificateUnlocked !== true` ditukar kepada `!hasEvaluated`
                if (programData.evaluationNeeded === true && !hasEvaluated) {
                    // PERLU PENILAIAN & BELUM ISI
                    statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Perlu Penilaian</span>`;
                    
                    const evalUrl = `penilaianprogram.html?kod=${programData.evaluationKey}`;
                    actionHTML = `<a href="${evalUrl}" target="_blank" class="btn bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">Isi Penilaian</a>`;

                } else {
                    // TIDAK PERLU PENILAIAN (atau SUDAH ISI)
                    // 3. Semak jika tarikh program sudah TAMAT
                    if (programData.endDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const programEndDate = new Date(programData.endDate + 'T00:00:00');
                        isCertificateAvailable = today > programEndDate;
                        
                        if (isCertificateAvailable) {
                            // SIJIL TERSEDIA
                            statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Tersedia</span>`;
                            actionHTML = `<button onclick="printCertificate('${programData.key}')" class="btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm">Muat Turun</button>`;
                        } else {
                            // BELUM TERSEDIA (tarikh)
                            const endDateString = programEndDate.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long' });
                            unavailableMessage = `Tersedia selepas ${endDateString}`;
                            statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Belum Sedia</span>`;
                            actionHTML = `<p class="text-sm text-gray-500 italic px-4">${unavailableMessage}</p>`;
                        }
                    } else {
                        // BELUM TERSEDIA (tiada tarikh)
                        unavailableMessage = "Tarikh tamat tidak ditetapkan.";
                        statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-700">Ralat</span>`;
                        actionHTML = `<p class="text-sm text-gray-500 italic px-4">${unavailableMessage}</p>`;
                    }
                }
            } else {
                // TIADA SIJIL DISEDIAKAN
                statusHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-700">Tiada Sijil</span>`;
                actionHTML = `<p class="text-sm text-gray-500 italic px-4">-</p>`;
            }

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bilIndex + 1}.</td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-semibold text-gray-900">${programData.name || 'Nama Program Tidak Ditemui'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${dateDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusHTML}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${actionHTML}</td>
                </tr>
            `;
        }
        // =================================================================
        // #### TAMAT FUNGSI 'createCertificateRow' ####
        // =================================================================
        
        
        function printCertificate(programKey) {
            const result = window.certificateResults.find(r => r.programData.key === programKey);

            if (result === undefined) {
                alert("Ralat: Data sijil tidak ditemui.");
                return;
            }
            const { programData, participantData } = result;
            
            const participantInfo = participantData;
            const currentProgram = programData;

            // --- Kod cetak sijil (kekal sama) ---
            const participantName = participantInfo.name.toUpperCase();
            const participantIC = participantInfo.ic;
            const courseName = currentProgram.name.toUpperCase();
            
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            let dateString;
            
            if (startDate.getTime() === endDate.getTime()) {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateString = `pada ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} hingga ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            const programIdentifier = currentProgram.key || 'SPARK'; 
            const serialNumber = `SPK/${programIdentifier}/${participantIC.slice(-4)}`;
            
            const validationUrl = `${window.location.origin}${window.location.pathname}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ms">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Sijil Penyertaan - ${participantName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap');
                        body { font-family: 'Montserrat', sans-serif; font-weight: 400; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #333; }
                        .certificate-container { width: 210mm; height: 297mm; background-color: white; padding: 12mm; box-sizing: border-box; position: relative; display: flex; flex-direction: column; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; }
                        .certificate-container::before, .certificate-container::after { content: ''; position: absolute; width: 170px; height: 170px; background-color: #4B40FF; opacity: 0.9; z-index: 1; }
                        .certificate-container::before { top: -85px; left: -85px; transform: rotate(45deg); }
                        .certificate-container::after { bottom: -85px; right: -85px; transform: rotate(45deg); }
                        .certificate-content { border: 6px solid; border-image-slice: 1; border-image-source: linear-gradient(to right top, #d4af37, #4B40FF, #d4af37); height: 100%; padding: 10mm; box-sizing: border-box; position: relative; z-index: 2; display: flex; flex-direction: column; background: #ffffff; }
                        .header-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 75px; }
                        .qr-code { width: 65px; height: 65px; }
                        .serial-number { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #555; margin: 0; }
                        .logo { width: 150px; height: auto; margin: 0 auto 15px auto; }
                        h1 { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; margin: 15px 0; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(45deg, #4B40FF, #a8871a, #4B40FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .intro-text { font-size: 16px; margin-top: 25px; margin-bottom: 20px; color: #555; }
                        .recipient-name { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; margin: 10px 0; color: #c59d1e; }
                        .recipient-ic { font-size: 16px; font-weight: 500; margin-bottom: 30px; color: #444; }
                        .event-title-label { font-size: 16px; color: #555; }
                        .event-title { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0; color: #111; }
                        .event-date { font-size: 16px; font-weight: 500; margin-top: 10px; margin-bottom: 40px; color: #444; }
                        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, #d4af37, #4B40FF); margin: 0 auto 20px auto; border: none; }
                        .signature-section { margin-top: auto; }
                        .signatory-name { font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .signatory-title { font-size: 14px; font-weight: 500; line-height: 1.5; color: #333; }
                        .footer-note { font-size: 10px; font-style: italic; margin-top: 25px; color: #999; }
                        .spark-section { margin-top: 15px; }
                        .spark-title { font-weight: 700; font-size: 14px; letter-spacing: 2px; background: linear-gradient(90deg, #4B40FF, #3a32cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
                        .spark-subtitle { font-size: 10px; color: #555; margin: 4px 0 0 0; font-style: italic; }
                        @media print {
                            body { background-color: white; }
                            .certificate-container { box-shadow: none; margin: 0; }
                            @page { size: A4 portrait; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="certificate-content">
                            <div class="header-section">
                                <img src="${qrCodeUrl}" alt="QR Code" class="qr-code">
                                <p class="serial-number">NO. SIRI: ${serialNumber}</p>
                            </div>
                            <img src="https://i.imgur.com/FQpwGDo.png" alt="Logo Pejabat Pendidikan Daerah Miri" class="logo">
                            <h1>Sijil Penyertaan</h1>
                            <p class="intro-text">Dengan ini disahkan bahawa</p>
                            <p class="recipient-name">${participantName}</p>
                            <p class="recipient-ic">${participantIC}</p>
                            <p class="event-title-label">telah mengikuti</p>
                            <p class="event-title">${courseName}</p>
                            <p class="event-date">${dateString}</p>
                            <hr class="divider">
                            <div class="signature-section">
                                <p class="signatory-name">MARIAM HAJI MONEK</p>
                                <p class="signatory-title">PEGAWAI PENDIDIKAN DAERAH,<br>PEJABAT PENDIDIKAN DAERAH MIRI.</p>
                            </div>
                            <p class="footer-note">Sijil ini adalah cetakan komputer, tandatangan tidak diperlukan.</p>
                            <div class="spark-section">
                                <p class="spark-title">SPARK</p>
                                <p class="spark-subtitle">Percikan Inovasi Kehadiran Digital</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { 
                printWindow.focus(); 
                printWindow.print();
            };
        }
        
        function displayParticipantInfo(data,maskedIc){const pName=document.getElementById("participant-name"),pIc=document.getElementById("participant-ic"),pPos=document.getElementById("participant-position"),pSta=document.getElementById("participant-station");pName.textContent=data.name||"-";pIc.textContent=maskedIc;pPos.textContent=data.position||"-";pSta.textContent=data.station||"-";document.getElementById("participant-info").classList.remove("hidden")}
        function maskIc(ic){if(ic&&ic.length>4){return ic.slice(0,-4).replace(/./g,"*")+ic.slice(-4)}return"****"}
        function setLoading(isLoading){checkBtn.disabled=isLoading;document.getElementById("search-icon").classList.toggle("hidden",isLoading);document.getElementById("loading-spinner").classList.toggle("hidden",!isLoading);buttonText.textContent=isLoading?"Menyemak...":"Semak"}
        function resetDisplay(){
            resultsSection.classList.add("hidden");
            certificatesTableBody.innerHTML=""; 
            participantInfoDiv.classList.add("hidden");
            noResultsMessage.classList.add("hidden");
            noFilterResults.classList.add('hidden');
            window.certificateResults = [];
            
            searchInput.value = "";
            monthFilter.value = "";
            yearFilter.innerHTML = '<option value="">Semua Tahun</option>';
        }

        window.printCertificate = printCertificate;
        window.filterAndDisplayResults = filterAndDisplayResults;
    </script>
</body>
</html>
