<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK Curai â€“ Final Free Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f9ff; }
        
        /* A4 Paper */
        #pdf-wrapper { width: 210mm; margin: 0 auto; background: white; transition: all 0.3s ease; }
        .a4-paper { width: 210mm; min-height: 297mm; padding: 20mm 20mm; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); color: black; position: relative; font-family: 'Arial', sans-serif; }
        .barcode-container { position: absolute; top: 20mm; right: 20mm; z-index: 50; text-align: right; }

        /* Tables & Content */
        .minit-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt !important; line-height: 1.4 !important; }
        .minit-table th, .minit-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
        .minit-header { background-color: #e0f2fe; font-weight: bold; width: 25%; }
        .th-icon { display: inline-flex; align-items: center; gap: 5px; }
        #out-content { font-size: 11pt; line-height: 1.5; text-align: justify; }
        .single-line-name { white-space: nowrap; overflow: visible; width: 100%; display: block; }

        /* UI Elements */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #0284c7; border-radius: 3px; }
        .spark-input { width: 100%; font-size: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; transition: all 0.2s; background: white; resize: none; overflow-y: hidden; min-height: 38px; }
        .spark-input:focus { outline: none; border-color: #0284c7; ring: 2px solid #e0f2fe; }

        .nav-tab { padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .nav-tab.active { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
        .nav-tab.inactive { color: #64748b; background-color: transparent; }
        
        /* Preview Structure */
        .preview-list { list-style: none; padding: 0; margin: 0; }
        .preview-item { margin-bottom: 10px; display: flex; align-items: flex-start; }
        .preview-num { font-weight: bold; min-width: 25px; }
        .preview-text { flex-grow: 1; text-align: justify; }
        .sub-list { margin-top: 5px; }
        .sub-item { display: flex; align-items: flex-start; margin-bottom: 4px; }
        .sub-num { font-weight: normal; min-width: 35px; font-size: 0.95em; }
        .sub-text-wrapper { flex-grow: 1; }
        .sub-text { font-size: 0.95em; }

        .speaker-section { margin-bottom: 20px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .speaker-section:last-child { border-bottom: none; }
        
        /* FIX: REMOVED UPPERCASE, ADDED !important to force it */
        .speaker-title { font-weight: bold; margin-bottom: 5px; font-size: 10pt; color: #334155; background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; text-transform: none !important; }
        
        .status-tag { display: block; text-align: right; margin-top: 2px; font-size: 8pt; font-weight: bold; color: black; text-transform: uppercase; }

        /* Buttons */
        .btn-ai-fancy { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; font-weight: 700; font-size: 9px; padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 5px rgba(168, 85, 247, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; text-transform: uppercase; }
        .btn-ai-fancy:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(168, 85, 247, 0.5); }
        .btn-ai-locked { background: #cbd5e1; color: #64748b; cursor: not-allowed; box-shadow: none; border: 1px solid #94a3b8; }
        .btn-ai-locked:hover { transform: none; box-shadow: none; background: #cbd5e1; }

        .btn-bold { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold; font-family: serif; font-size: 14px; transition: all 0.2s; border: 1px solid #ddd; }
        .btn-bold.active { background-color: #334155; color: white; border-color: #334155; }

        #save-indicator { position: fixed; bottom: 20px; right: 20px; background: #64748b; color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; opacity: 1; transition: all 0.3s; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; items-center; gap: 5px; }
        #save-indicator.active { background: #22c55e; }
        #save-indicator.saving { background: #eab308; }

        #start-overlay { transition: all 0.3s ease; }
        #start-overlay.hidden-overlay { display: none; }

        canvas#signature-pad { touch-action: none; border: 1px dashed #cbd5e1; border-radius: 0.5rem; cursor: crosshair; background: white; width: 100%; height: 100%; display: block; } 

        @media print { .no-print { display: none !important; } .a4-paper { box-shadow: none; margin: 0; } }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <div id="save-indicator"><span id="save-text">Menunggu Mula</span></div>

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-sky-600 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold text-sky-700 uppercase tracking-wide">SPARK CURAI</h1>
                        <div id="account-badge-container">
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">Memuatkan...</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Minit Curai & Nota Mesyuarat</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showCreditModal()" class="text-xs font-bold text-indigo-600 bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 px-3 py-2 rounded-lg flex items-center gap-1 transition-colors mr-2">ðŸ’¡ Kredit Idea</button>
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-sky-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">Kembali</button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button id="btn-share" onclick="shareRecord()" class="hidden bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg> Kongsi</button>
                <button onclick="saveAndGeneratePDF()" id="btn-final-save" class="bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-700 hover:to-indigo-700 text-white text-xs font-bold py-2 px-6 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg> Selesai & Jana PDF</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-full lg:w-1/2 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar flex flex-col">
            
            <div class="flex p-1 bg-gray-100 rounded-xl mb-4 gap-1">
                <div onclick="switchTab('editor')" id="tab-editor" class="nav-tab active flex-1 text-center">Isi Borang</div>
                <div onclick="switchTab('history')" id="tab-history" class="nav-tab inactive flex-1 text-center">Sejarah</div>
                <div onclick="switchTab('settings')" id="tab-settings" class="nav-tab inactive flex-1 text-center">Ketetapan</div>
            </div>

            <div id="view-editor" class="block relative">
                <div class="mb-4 flex gap-2 hidden" id="reset-btn-container">
                    <button onclick="clearForm(true)" class="flex-1 bg-red-50 text-red-600 border border-red-200 py-2 rounded text-xs font-bold uppercase hover:bg-red-100 transition">Buat Baru / Reset</button>
                </div>

                <form id="minit-form" oninput="triggerAutoSave(); updatePreview()">
                    <div class="bg-sky-50 p-4 rounded-xl border border-sky-100 mb-4">
                        <h3 class="text-xs font-bold text-sky-700 uppercase mb-3 border-b border-sky-200 pb-2">Maklumat Mesyuarat</h3>
                        <div class="input-group"><label class="input-label">Tajuk Program</label><textarea id="in-tajuk" rows="2" class="spark-input font-bold uppercase" placeholder="Tajuk..."></textarea></div>
                        <div class="grid grid-cols-2 gap-3"><div class="input-group"><label class="input-label">Tarikh</label><input type="date" id="in-tarikh" class="spark-input font-semibold"></div><div class="input-group"><label class="input-label">Masa</label><input type="time" id="in-masa" class="spark-input font-semibold"></div></div>
                        <div class="input-group"><label class="input-label">Tempat</label><input type="text" id="in-tempat" class="spark-input" placeholder="Contoh: Bilik Gerakan"></div>
                        <div class="input-group"><label class="input-label">Pengerusi / Anjuran</label><input type="text" id="in-anjuran" class="spark-input" placeholder="Contoh: PPD Miri"></div>
                    </div>

                    <div id="start-section" class="mb-4">
                        <button type="button" onclick="startSession()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 uppercase text-sm border-2 border-green-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Mula Rekod (Aktifkan Auto-Save)
                        </button>
                        <p class="text-[10px] text-gray-400 text-center mt-2 italic">Pastikan maklumat di atas tepat, kemudian tekan butang ini.</p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4 mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-gray-700 uppercase">Catatan Minit</h3><span id="session-status" class="text-[9px] text-gray-400 bg-gray-100 px-2 py-1 rounded">Mod Lihat</span></div>
                        <div id="speakers-container" class="space-y-6"></div>
                        <button type="button" onclick="addSpeaker()" class="mt-6 w-full py-3 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-lg text-xs font-bold uppercase hover:bg-indigo-100 transition flex justify-center items-center gap-2 border-dashed border-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Tambah Sesi / Penyampai</button>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 pb-2">Disediakan Oleh</h3>
                        <div class="input-group"><label class="input-label">Nama Pegawai</label><input type="text" id="in-nama" class="spark-input font-bold uppercase"></div>
                        <div class="input-group"><label class="input-label">Jawatan</label><input type="text" id="in-jawatan" class="spark-input uppercase"></div>
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <div class="flex items-center justify-between mb-2"><label class="flex items-center text-[10px] font-bold text-gray-500 uppercase cursor-pointer"><input type="checkbox" id="chk-signature" class="w-3 h-3 text-sky-600 rounded mr-2" onchange="toggleSignature(); triggerAutoSave(); updatePreview()"> Sertakan Tandatangan</label></div>
                            <div id="sig-input-container" class="hidden space-y-3">
                                 <div class="border border-gray-300 rounded-lg bg-white overflow-hidden"><div class="bg-gray-100 px-3 py-1 border-b border-gray-200 flex justify-between items-center"><span class="text-[10px] font-bold text-gray-500 uppercase">Lukis</span><button type="button" onclick="clearSignature()" class="text-[9px] text-red-600 hover:text-red-800 font-bold uppercase">Padam</button></div><div class="relative w-full h-24 bg-white cursor-crosshair"><canvas id="signature-pad" class="w-full h-full block relative z-10"></canvas><div id="sig-instruction" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-300 text-[10px] font-bold uppercase z-0">Lukis Tandatangan Di Sini</div></div></div>
                                 <div class="relative flex py-1 items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink-0 mx-2 text-[9px] text-gray-400 uppercase">Atau Muat Naik</span><div class="flex-grow border-t border-gray-300"></div></div>
                                 <input type="file" id="sig-upload" accept="image/*" class="w-full text-[10px] text-gray-500" onchange="handleSigUpload(this)">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div id="view-history" class="hidden h-full">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Rekod Minit Terdahulu</h3>
                <div id="history-list" class="space-y-3 overflow-y-auto pb-10"><p class="text-xs text-gray-400 text-center py-4">Memuatkan data dari Firebase...</p></div>
            </div>

            <div id="view-settings" class="hidden">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Konfigurasi Dokumen</h3>
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Saiz Tulisan (Isi)</label><input type="range" min="9" max="14" step="0.5" value="11" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('fontSize', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Kecil</span><span id="lbl-fontSize">11pt</span><span>Besar</span></div></div>
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Jarak Baris</label><input type="range" min="1.0" max="2.0" step="0.1" value="1.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('lineHeight', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Rapat</span><span id="lbl-lineHeight">1.5</span><span>Jarang</span></div></div>
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Ruang Tepi</label><input type="range" min="10" max="30" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('padding', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Sempit</span><span id="lbl-padding">20mm</span><span>Luas</span></div></div>
            </div>
        </div>

        <div class="w-full lg:w-1/2 bg-gray-100 overflow-auto flex justify-center p-8 custom-scrollbar">
            <div id="pdf-wrapper">
                <div class="a4-paper transform scale-100 origin-top" id="main-report">
                    <div class="barcode-container"><svg id="barcode"></svg></div>
                    <div class="text-center border-b-2 border-black pb-4 mb-6 mt-6">
                        <h2 class="text-xl font-bold uppercase tracking-wider mb-2 text-black">MINIT CURAI</h2>
                        <h3 id="out-tajuk" class="text-lg font-semibold uppercase text-gray-800 leading-tight">TAJUK PROGRAM</h3>
                    </div>
                    <table class="minit-table mb-6">
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> TARIKH</div></th><td id="out-tarikh" class="w-1/4 uppercase"></td><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> MASA</div></th><td id="out-masa" class="w-1/4 uppercase"></td></tr>
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> TEMPAT</div></th><td id="out-tempat" colspan="3" class="uppercase"></td></tr>
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg> ANJURAN</div></th><td id="out-anjuran" colspan="3" class="uppercase"></td></tr>
                    </table>
                    <div class="mb-8"><h4 class="text-sm font-bold uppercase border-b border-gray-300 mb-4 pb-1">Intipati / Coretan Mesyuarat</h4><div id="out-content" class="text-justify leading-relaxed"></div></div>
                    <div class="mt-auto flex justify-end pt-5 break-inside-avoid">
                        <div class="w-1/2 flex flex-col items-start pl-2">
                            <p class="text-xs italic mb-2 w-full text-left">Disediakan oleh:</p>
                            <div class="w-full flex flex-col items-start">
                                 <div class="h-16 w-full flex items-end justify-start mb-1"><img id="out-sig-img" class="h-full w-auto object-contain hidden" src=""></div>
                                <div class="border-b border-black w-full mb-1"></div>
                                <p id="out-nama" class="font-bold uppercase text-sm w-full text-left single-line-name">NAMA PEGAWAI</p>
                                <p id="out-jawatan" class="text-xs uppercase text-left single-line-name">JAWATAN</p>
                                <p id="out-tarikh-laporan" class="text-xs text-left mt-1 uppercase">TARIKH</p>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-4 left-0 w-full text-center"><p class="text-[8px] text-gray-300 uppercase tracking-[0.2em]">Dijana oleh SPARK Curai</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="credit-modal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative"><button onclick="closeCreditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button><div class="text-center"><div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4"><svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></div><h3 class="text-xl font-extrabold text-gray-900 mb-1 uppercase">Penghargaan Khas</h3><div class="bg-gray-50 p-4 rounded-lg border border-gray-100 mb-4"><p class="text-sm text-gray-600 mb-2">Terima kasih atas idea bernas:</p><p class="text-lg font-bold text-gray-800 uppercase">PN. SU YIEN JIONG</p><p class="text-xs text-gray-500 uppercase font-semibold">(SIPartners+ PPD Miri)</p></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = firebaseConfig.projectId;
        const SECRET_G = "Z3NrX3hUbHQxRjVIYjRIdmRtejliS3Z5V0dkeWIzRllJcHdSazhrbWRxVlkySTdmTDlOZVdMMGs="; 
        function getKey(encoded) { try { return atob(encoded); } catch (e) { return ""; } }

        window.speakersData = []; window.currentUserIc = ""; window.currentDocId = ""; window.isSparkPro = false; window.isSessionActive = false;
        let sigCanvas, sigCtx, isDrawing = false, isSignatureDrawn = false, saveTimeout;
        
        window.renderBarcode = function(serial) { if(!serial) serial = "SPARK-" + Math.floor(Math.random() * 1000000); JsBarcode("#barcode", serial, { format: "CODE128", width: 1, height: 15, displayValue: true, fontSize: 8, margin: 0, textMargin: 1 }); }

        window.onload = function() {
            initSignaturePad();
            onAuthStateChanged(auth, async (user) => {
                const urlParams = new URLSearchParams(window.location.search);
                window.currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
                if (window.currentUserIc) {
                    await fetchUserData(window.currentUserIc);
                    setDefaults();
                    addSpeaker(true); loadHistory(); window.renderBarcode();
                } else { alert("Sila log masuk semula."); window.location.href = 'index.html'; }
            });
        };

        async function fetchUserData(ic) {
            try { const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic)); const snap = await getDocs(q);
                if (!snap.empty) { const d = snap.docs[0].data(); 
                const adminIC = "890522135381";
                window.isSparkPro = (d.isPro === true) || (ic === adminIC);

                const badgeContainer = document.getElementById('account-badge-container');
                if (window.isSparkPro) {
                    badgeContainer.innerHTML = '<span class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 font-bold uppercase tracking-wider">PRO</span>';
                } else {
                    badgeContainer.innerHTML = '<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">AKAUN BIASA</span>';
                }

                if(!document.getElementById('in-nama').value) document.getElementById('in-nama').value = d.name.toUpperCase();
                if(!document.getElementById('in-jawatan').value) document.getElementById('in-jawatan').value = (d.jawatan || d.unit || "").toUpperCase(); }
            } catch (e) { console.error(e); }
        }

        window.startSession = async function() {
            const title = document.getElementById('in-tajuk').value;
            if(title.length < 5) { alert("Sila isikan Tajuk Program yang lengkap."); return; }
            window.isSessionActive = true;
            document.getElementById('start-section').classList.add('hidden');
            document.getElementById('reset-btn-container').classList.remove('hidden');
            document.getElementById('save-indicator').className = "active";
            document.getElementById('save-indicator').innerHTML = "Aktif (Auto-Save On)";
            document.getElementById('session-status').innerText = "Sedang Direkod...";
            document.getElementById('session-status').className = "text-[9px] text-green-700 bg-green-100 px-2 py-1 rounded animate-pulse";
            await saveToFirebase();
        }

        window.triggerAutoSave = function() {
            if(!window.isSessionActive && !window.currentDocId) return; 
            const ind = document.getElementById('save-indicator'); ind.className = "saving"; ind.innerHTML = "Menyimpan...";
            clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { await saveToFirebase(true); }, 2000);
        }

        window.saveToFirebase = async function(silent = false) {
            const ind = document.getElementById('save-indicator');
            const dataToSave = {
                ic: window.currentUserIc, tajuk: document.getElementById('in-tajuk').value, tarikh: document.getElementById('in-tarikh').value,
                masa: document.getElementById('in-masa').value, tempat: document.getElementById('in-tempat').value, anjuran: document.getElementById('in-anjuran').value,
                nama: document.getElementById('in-nama').value, jawatan: document.getElementById('in-jawatan').value, speakers: window.speakersData,
                signatureUrl: document.getElementById('out-sig-img').src, showSignature: document.getElementById('chk-signature').checked,
                settings: { fontSize: document.getElementById('lbl-fontSize').innerText, lineHeight: document.getElementById('lbl-lineHeight').innerText, padding: document.getElementById('lbl-padding').innerText },
                updatedAt: new Date()
            };
            try {
                if(window.currentDocId) await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_minit_curai`, window.currentDocId), dataToSave);
                else { if(dataToSave.tajuk) { dataToSave.createdAt=new Date(); const r=await addDoc(collection(db, `artifacts/${appId}/public/data/spark_minit_curai`), dataToSave); window.currentDocId=r.id; } }
                ind.className="saved"; ind.innerHTML="Disimpan"; document.getElementById('last-saved-time').innerText=`Disimpan: ${new Date().toLocaleTimeString()}`;
                if(window.currentDocId) document.getElementById('btn-share').classList.remove('hidden'); if(!silent) loadHistory();
            } catch(e){ ind.className="bg-red-500"; ind.innerHTML="Gagal"; }
        }

        window.saveAndGeneratePDF = async function() {
            const btn = document.getElementById('btn-final-save'); const t = btn.innerHTML; btn.innerHTML = "Menyimpan..."; btn.disabled = true;
            await saveToFirebase(true); btn.innerHTML = "Menjana PDF..."; setTimeout(() => { window.downloadPDF(); btn.innerHTML = t; btn.disabled = false; }, 500);
        }

        window.loadHistory = async function() {
            const listDiv = document.getElementById('history-list');
            try { const q = query(collection(db, `artifacts/${appId}/public/data/spark_minit_curai`), where("ic", "==", window.currentUserIc), orderBy("updatedAt", "desc"));
                const snap = await getDocs(q); listDiv.innerHTML = ""; if(snap.empty) { listDiv.innerHTML = "<p class='text-xs text-center text-gray-400'>Tiada rekod.</p>"; return; }
                snap.forEach(dSnap => { const d = dSnap.data(); const dt = d.tarikh?new Date(d.tarikh).toLocaleDateString('ms-MY'):"-";
                    const item = document.createElement('div'); item.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer";
                    item.onclick = () => loadFromHistory(dSnap.id, d);
                    item.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="text-xs font-bold text-gray-800 uppercase line-clamp-1">${d.tajuk||"Tiada Tajuk"}</h4><p class="text-[10px] text-gray-500">${dt} | ${d.tempat||"-"}</p></div><button onclick="event.stopPropagation(); deleteRecord('${dSnap.id}')" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div>`; listDiv.appendChild(item); });
            } catch (e) { console.error(e); }
        }

        window.loadFromHistory = function(id, data) {
            window.currentDocId = id; window.isSessionActive = true; 
            document.getElementById('start-section').classList.add('hidden'); document.getElementById('reset-btn-container').classList.remove('hidden');
            document.getElementById('in-tajuk').value = data.tajuk; document.getElementById('in-tarikh').value = data.tarikh;
            document.getElementById('in-masa').value = data.masa; document.getElementById('in-tempat').value = data.tempat;
            document.getElementById('in-anjuran').value = data.anjuran; document.getElementById('in-nama').value = data.nama;
            document.getElementById('in-jawatan').value = data.jawatan; window.speakersData = data.speakers || [];
            if(data.settings) { updateSettings('fontSize', parseFloat(data.settings.fontSize)); updateSettings('lineHeight', parseFloat(data.settings.lineHeight)); updateSettings('padding', parseFloat(data.settings.padding)); }
            
            // SIGNATURE LOADING FIX
            if(data.signatureUrl && data.showSignature) { 
                document.getElementById('out-sig-img').src = data.signatureUrl; 
                document.getElementById('chk-signature').checked = true; 
                window.toggleSignature(); 
            }
            renderFormFromData(); updatePreview(); switchTab('editor'); document.getElementById('btn-share').classList.remove('hidden');
        }

        window.deleteRecord = async function(id) { if(!confirm("Padam?")) return; try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_minit_curai`, id)); loadHistory(); if(window.currentDocId === id) clearForm(true); } catch(e) { alert("Ralat."); } }
        window.switchTab = function(tName) { ['editor', 'history', 'settings'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).className = 'nav-tab inactive flex-1 text-center'; }); document.getElementById(`view-${tName}`).classList.remove('hidden'); document.getElementById(`view-${tName}`).classList.add('block'); document.getElementById(`tab-${tName}`).className = 'nav-tab active flex-1 text-center'; }
        window.updateSettings = function(type, val) { const c = document.getElementById('out-content'); const p = document.getElementById('main-report'); if(type === 'fontSize') { c.style.fontSize = val + 'pt'; document.getElementById('lbl-fontSize').innerText = val + 'pt'; } else if (type === 'lineHeight') { c.style.lineHeight = val; document.getElementById('lbl-lineHeight').innerText = val; } else if (type === 'padding') { p.style.padding = `${val}mm 20mm`; document.getElementById('lbl-padding').innerText = val + 'mm'; } }
        window.shareRecord = function() { if(!window.currentDocId) { alert("Simpan dulu."); return; } const link = window.location.href.replace('sparkcurai.html', `viewminit.html?id=${window.currentDocId}`); window.open(`https://wa.me/?text=${encodeURIComponent("Salam, berikut pautan Minit Curai: " + link)}`, '_blank'); }
        window.autoResize = function(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- AI LOGIC (PRO ONLY) ---
        window.askAI = async function(btn, type, sIndex, pIndex, subIndex = null) {
            if(!window.isSparkPro) { alert("ðŸ”’ AKSES TERHAD\n\nMaaf, fungsi AI ini eksklusif untuk pengguna SPARK PRO sahaja."); return; }
            const originalText = btn.innerHTML; let inputId = (type === 'point') ? `input-point-${sIndex}-${pIndex}` : `input-sub-${sIndex}-${pIndex}-${subIndex}`;
            const inputEl = document.getElementById(inputId); const userText = inputEl.value;
            if(!userText || userText.length < 3) { alert("Tulis minima 3 huruf."); return; }
            btn.innerHTML = `...`; btn.disabled = true;
            const GROQ_API_KEY = getKey(SECRET_G);
            try {
                const r = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ messages: [{ role: "system", content: "Tukar teks input menjadi ayat minit mesyuarat formal Bahasa Melayu." }, { role: "user", content: userText }], model: "llama-3.3-70b-versatile", temperature: 0.5 }) });
                const d = await r.json(); let nText = d.choices[0].message.content.replace(/"/g, '').trim();
                if(type === 'point') { updatePointText(sIndex, pIndex, nText); inputEl.value = nText; } else { updateSubPoint(sIndex, pIndex, subIndex, nText); inputEl.value = nText; }
                autoResize(inputEl); triggerAutoSave();
            } catch (e) { alert("AI Gagal."); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        window.renderFormFromData = function() { document.getElementById('speakers-container').innerHTML = ''; window.speakersData.forEach((s, i) => createSpeakerHTML(s, i)); document.querySelectorAll('textarea.spark-input').forEach(el => autoResize(el)); }
        
        window.createSpeakerHTML = function(s, i) {
            const w = document.createElement('div'); w.className = "bg-gray-50 border border-gray-300 rounded-lg p-3 relative"; w.id = `speaker-wrapper-${i}`;
            let pts = ''; s.points.forEach((p, pi) => pts += createPointHTML(p, i, pi));
            w.innerHTML = `<div class="mb-3 bg-white p-2 rounded border border-gray-200"><label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Penyampai</label><div class="flex gap-2"><input type="text" value="${s.name}" oninput="updateSpeakerName(${i}, this.value)" class="flex-grow text-xs font-bold text-indigo-700 bg-indigo-50 border border-indigo-100 rounded p-1.5 placeholder-indigo-300 uppercase" placeholder="Cth: Pengarah JPNS"><button onclick="removeSpeaker(${i})" class="text-red-400 hover:text-red-600 p-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div></div><div id="points-list-${i}" class="space-y-4 pl-2 border-l-2 border-indigo-100">${pts}</div><div class="mt-4 pl-2"><button type="button" onclick="addPoint(${i})" class="text-[10px] font-bold text-sky-600 hover:text-sky-800 flex items-center gap-1 uppercase bg-white px-3 py-1.5 rounded border border-sky-100 hover:bg-sky-50 shadow-sm">+ Tambah Poin Utama</button></div>`;
            document.getElementById('speakers-container').appendChild(w);
        }

        window.createPointHTML = function(p, i, pi) {
            const isStat = p.status !== ""; const statHide = isStat ? "" : "hidden"; const whoHide = p.status === "TINDAKAN" ? "" : "hidden"; const boldCls = p.isBold ? "active" : "inactive"; const aiClass = window.isSparkPro ? "" : "btn-ai-locked";
            
            let subs = ''; 
            p.subs.forEach((s, si) => { 
                const subText = (typeof s === 'object') ? s.text : s;
                const subStatus = (typeof s === 'object') ? s.status : "";
                const subWho = (typeof s === 'object') ? s.who : "";
                
                const isSubStat = subStatus !== "";
                const subStatHide = isSubStat ? "" : "hidden";
                const subWhoHide = subStatus === "TINDAKAN" ? "" : "hidden";

                subs += `
                <div class="flex flex-col gap-1 mt-2 ml-4 border-l border-gray-200 pl-2">
                    <div class="flex gap-2 items-start">
                        <span class="mt-2 text-[10px] text-gray-400 font-bold w-6 text-right">${pi + 1}.${si + 1}</span>
                        <div class="flex-grow relative">
                             <textarea id="input-sub-${i}-${pi}-${si}" oninput="autoResize(this); updateSubPoint(${i}, ${pi}, ${si}, this.value)" rows="1" class="spark-input text-xs bg-white w-full pr-16" placeholder="Isi Sub-Poin...">${subText}</textarea>
                             <button onclick="askAI(this, 'sub', ${i}, ${pi}, ${si})" class="btn-ai-fancy absolute right-1 top-1 ${aiClass}">AI</button>
                        </div>
                        <button type="button" onclick="removeSubPoint(${i}, ${pi}, ${si})" class="mt-1 text-gray-300 hover:text-red-400">x</button>
                    </div>
                    <div class="ml-8 flex items-center justify-between">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${isSubStat ? 'checked' : ''} onchange="toggleSubPointStatus(${i}, ${pi}, ${si}, this.checked)" class="form-checkbox h-3 w-3 text-sky-600">
                            <span class="ml-1 text-[9px] text-gray-400 hover:text-gray-600">Status/Tindakan</span>
                        </label>
                    </div>
                    <div id="sub-status-box-${i}-${pi}-${si}" class="ml-8 flex items-center gap-2 bg-gray-50 p-1.5 rounded border border-gray-100 ${subStatHide}">
                        <div class="w-1/3">
                            <select onchange="updateSubPointStatusType(${i}, ${pi}, ${si}, this.value)" class="w-full text-[10px] border border-gray-300 rounded p-1">
                                <option value="MAKLUMAN" ${subStatus === "MAKLUMAN" ? "selected" : ""}>Makluman</option>
                                <option value="TINDAKAN" ${subStatus === "TINDAKAN" ? "selected" : ""}>Tindakan</option>
                            </select>
                        </div>
                        <div class="w-2/3 ${subWhoHide}" id="sub-who-box-${i}-${pi}-${si}">
                            <input type="text" value="${subWho}" oninput="updateSubPointWho(${i}, ${pi}, ${si}, this.value)" class="w-full text-[10px] border border-gray-300 rounded p-1" placeholder="Siapa?">
                        </div>
                    </div>
                </div>`; 
            });

            return `<div class="relative bg-white border border-gray-100 rounded p-2 shadow-sm"><div class="flex gap-2 items-start"><div class="flex flex-col gap-1 mt-1"><span class="text-xs font-bold text-gray-400 bg-gray-100 w-6 h-6 flex items-center justify-center rounded-full">${pi + 1}</span><button onclick="toggleBold(${i}, ${pi})" class="btn-bold ${boldCls}" title="Bold?">B</button></div><div class="flex-grow"><div class="relative"><textarea id="input-point-${i}-${pi}" oninput="autoResize(this); updatePointText(${i}, ${pi}, this.value)" rows="1" class="spark-input text-sm mb-1 pr-16" placeholder="Isi Poin Utama...">${p.text}</textarea><button onclick="askAI(this, 'point', ${i}, ${pi})" class="btn-ai-fancy absolute right-2 top-2 ${aiClass}">AI</button></div><div class="flex items-center justify-between mb-2 mt-1"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" ${isStat ? 'checked' : ''} onchange="togglePointStatus(${i}, ${pi}, this.checked)" class="form-checkbox h-3 w-3 text-sky-600"><span class="ml-2 text-[9px] text-gray-400 hover:text-gray-600 uppercase font-bold">Status/Tindakan</span></label><button onclick="addSubPoint(${i}, ${pi})" class="text-[10px] font-bold text-teal-600 bg-teal-50 border border-teal-200 px-4 py-1.5 rounded-lg hover:bg-teal-100 flex items-center gap-1 transition-colors shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg> Sub-Poin (1.x)</button></div><div id="status-box-${i}-${pi}" class="flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100 ${statHide} mb-2"><div class="w-1/3"><select onchange="updatePointStatusType(${i}, ${pi}, this.value)" class="w-full text-xs border border-gray-300 rounded p-1"><option value="MAKLUMAN" ${p.status === "MAKLUMAN" ? "selected" : ""}>Makluman</option><option value="TINDAKAN" ${p.status === "TINDAKAN" ? "selected" : ""}>Tindakan</option></select></div><div class="w-2/3 ${whoHide}" id="who-box-${i}-${pi}"><input type="text" value="${p.who}" oninput="updatePointWho(${i}, ${pi}, this.value)" class="w-full text-xs border border-gray-300 rounded p-1" placeholder="Siapa? (Cth: Semua Guru)"></div></div><div id="subs-container-${i}-${pi}">${subs}</div></div><button onclick="removePoint(${i}, ${pi})" class="text-gray-300 hover:text-red-400 self-start mt-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>`;
        }

        // --- SUB POINT ACTIONS ---
        window.addSubPoint = function(i, pi) { 
            window.speakersData[i].points[pi].subs.push({ text: "", status: "", who: "" }); 
            renderFormFromData(); triggerAutoSave(); updatePreview(); 
        }
        window.updateSubPoint = function(i, pi, si, v) { 
            let sub = window.speakersData[i].points[pi].subs[si];
            if(typeof sub === 'string') sub = { text: v, status: "", who: "" }; 
            else sub.text = v;
            window.speakersData[i].points[pi].subs[si] = sub;
            triggerAutoSave(); updatePreview(); 
        }
        window.toggleSubPointStatus = function(i, pi, si, chk) {
            let sub = window.speakersData[i].points[pi].subs[si];
            if(typeof sub === 'string') sub = { text: sub, status: "", who: "" };
            sub.status = chk ? "MAKLUMAN" : "";
            window.speakersData[i].points[pi].subs[si] = sub;
            renderFormFromData(); triggerAutoSave(); updatePreview();
        }
        window.updateSubPointStatusType = function(i, pi, si, val) {
            window.speakersData[i].points[pi].subs[si].status = val;
            renderFormFromData(); triggerAutoSave(); updatePreview();
        }
        window.updateSubPointWho = function(i, pi, si, val) {
            window.speakersData[i].points[pi].subs[si].who = val;
            triggerAutoSave(); updatePreview();
        }

        // Standard CRUD Operations
        // FIX: DEFAULT SPEAKER NAME IS "PENGERUSI"
        window.addSpeaker = function() { 
            window.speakersData.push({ name: "Pengerusi", points: [] }); 
            addPoint(window.speakersData.length - 1); 
            triggerAutoSave(); 
        }
        
        window.removeSpeaker = function(i) { if(confirm("Padam?")) { window.speakersData.splice(i, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); } }
        window.updateSpeakerName = function(i, v) { window.speakersData[i].name = v; triggerAutoSave(); updatePreview(); }
        
        window.addPoint = function(i, silent = false) { 
            window.speakersData[i].points.push({ text: "", subs: [], status: "", who: "", isBold: false }); 
            renderFormFromData(); if(!silent) triggerAutoSave(); updatePreview(); 
        }

        window.removePoint = function(i, pi) { window.speakersData[i].points.splice(pi, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointText = function(i, pi, v) { window.speakersData[i].points[pi].text = v; triggerAutoSave(); updatePreview(); }
        window.toggleBold = function(i, pi) { window.speakersData[i].points[pi].isBold = !window.speakersData[i].points[pi].isBold; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.togglePointStatus = function(i, pi, chk) { window.speakersData[i].points[pi].status = chk ? "MAKLUMAN" : ""; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointStatusType = function(i, pi, v) { window.speakersData[i].points[pi].status = v; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointWho = function(i, pi, v) { window.speakersData[i].points[pi].who = v; triggerAutoSave(); updatePreview(); }
        window.removeSubPoint = function(i, pi, si) { window.speakersData[i].points[pi].subs.splice(si, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.clearForm = function(r) { if(confirm("Reset?")) { window.currentDocId = ""; if(r) { document.getElementById('in-tajuk').value = ""; document.getElementById('in-tempat').value = ""; document.getElementById('in-anjuran').value = ""; } window.speakersData = []; addSpeaker(true); updatePreview(); document.getElementById('start-section').classList.remove('hidden'); document.getElementById('reset-btn-container').classList.add('hidden'); document.getElementById('save-indicator').className = ""; document.getElementById('save-indicator').innerHTML = "Menunggu Mula"; document.getElementById('session-status').innerText = "Mod Lihat (Tidak Disimpan)"; document.getElementById('session-status').className = "text-[9px] text-gray-400 bg-gray-100 px-2 py-1 rounded"; } }

        window.updatePreview = function() {
            ['tajuk', 'tempat', 'anjuran', 'nama', 'jawatan'].forEach(id => document.getElementById(`out-${id}`).textContent = document.getElementById(`in-${id}`).value.toUpperCase());
            const d = document.getElementById('in-tarikh').value; if(d) { const dojb = new Date(d); document.getElementById('out-tarikh').textContent = dojb.toLocaleDateString('ms-MY', {day:'numeric',month:'long',year:'numeric'}).toUpperCase(); document.getElementById('out-tarikh-laporan').textContent = document.getElementById('out-tarikh').textContent; }
            const t = document.getElementById('in-masa').value; if(t) { let [h,m]=t.split(':'); let s=h>=12?"PETANG":"PAGI"; if(h>12)h-=12; if(h==='00')h=12; document.getElementById('out-masa').textContent = `${h}.${m} ${s}`; }
            const c = document.getElementById('out-content'); c.innerHTML = '';
            window.speakersData.forEach(s => {
                const sec = document.createElement('div'); sec.className = "speaker-section";
                if(s.name) sec.innerHTML += `<div class="speaker-title">${s.name}</div>`; // Removed uppercase transform in CSS
                const list = document.createElement('div'); list.className = "preview-list";
                s.points.forEach((p, i) => {
                    const item = document.createElement('div'); item.className = "preview-item";
                    item.innerHTML = `<div class="preview-num">${i+1}.</div><div class="preview-text"><div style="${p.isBold?'font-weight:bold':''}">${p.text}</div></div>`;
                    const td = item.querySelector('.preview-text');
                    if(p.subs.length > 0) { 
                        const sl = document.createElement('div'); sl.className = "sub-list"; 
                        p.subs.forEach((sb, si) => { 
                            const subText = (typeof sb === 'object') ? sb.text : sb;
                            const subStatus = (typeof sb === 'object') ? sb.status : "";
                            const subWho = (typeof sb === 'object') ? sb.who : "";
                            
                            if(subText.trim()) {
                                let html = `<div class="sub-item"><div class="sub-num">${i+1}.${si+1}</div><div class="sub-text-wrapper"><div class="sub-text">${subText}</div>`;
                                if(subStatus) {
                                    const whoLabel = subStatus === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (subWho.toUpperCase() || "PGB");
                                    html += `<div class="status-tag">${whoLabel}</div>`;
                                }
                                html += `</div></div>`;
                                sl.innerHTML += html;
                            } 
                        }); 
                        td.appendChild(sl); 
                    }
                    if(p.status) {
                        td.innerHTML += `<div class="status-tag">${p.status === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (p.who.toUpperCase() || "PGB")}</div>`;
                    }
                    if(p.text.trim() || p.subs.length>0) list.appendChild(item);
                });
                sec.appendChild(list); if(s.points.length>0 || s.name) c.appendChild(sec);
            });
            window.renderBarcode();
        }

        window.setDefaults = function() { const n = new Date(); document.getElementById('in-tarikh').value = n.toISOString().split('T')[0]; document.getElementById('in-masa').value = n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); }
        window.renderBarcode = function() { const s = `SPARK-${Math.floor(Math.random()*1000000)}`; JsBarcode("#barcode", s, { format: "CODE128", width: 1, height: 15, displayValue: true, fontSize: 8, margin: 0, textMargin: 1 }); }
        window.downloadPDF = function() { const el = document.getElementById('pdf-wrapper'); let t = document.getElementById('in-tajuk').value.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_'); html2pdf().set({ margin: 0, filename: `CURAI_${t}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(el).save(); }
        
        function initSignaturePad() { sigCanvas = document.getElementById('signature-pad'); if (!sigCanvas) return; sigCtx = sigCanvas.getContext('2d'); setTimeout(()=>{const r=sigCanvas.getBoundingClientRect();sigCanvas.width=r.width;sigCanvas.height=r.height;},500); sigCanvas.addEventListener('mousedown', sD); sigCanvas.addEventListener('mouseup', eD); sigCanvas.addEventListener('mousemove', dD); sigCanvas.addEventListener('touchstart', (e)=>{e.preventDefault();sD(e.touches[0])}); sigCanvas.addEventListener('touchend', (e)=>{e.preventDefault();eD()}); sigCanvas.addEventListener('touchmove', (e)=>{e.preventDefault();dD(e.touches[0])}); }
        function sD(e){ isDrawing=true; isSignatureDrawn=true; const i = document.getElementById('sig-instruction'); if(i) i.classList.add('hidden'); dD(e); } function eD(){ isDrawing=false; sigCtx.beginPath(); uS(); } function dD(e){ if(!isDrawing)return; const r=sigCanvas.getBoundingClientRect(); sigCtx.lineWidth=2; sigCtx.lineTo(e.clientX-r.left, e.clientY-r.top); sigCtx.stroke(); sigCtx.beginPath(); sigCtx.moveTo(e.clientX-r.left, e.clientY-r.top); }
        
        // --- FINAL ROBUST SIGNATURE VISIBILITY LOGIC ---
        function checkSigVisibility() {
            const chk = document.getElementById('chk-signature');
            const img = document.getElementById('out-sig-img');
            
            // Check directly if image has substantial data
            // > 100 length filters out empty/corrupt data
            const hasValidImage = img.src && img.src.length > 100 && img.src.startsWith('data:image');
            
            if(chk.checked && hasValidImage) {
                img.classList.remove('hidden');
                img.style.display = 'block'; // Force display
            } else {
                img.classList.add('hidden');
                img.style.display = 'none';
            }
        }

        function uS(){ 
            document.getElementById('out-sig-img').src=sigCanvas.toDataURL(); 
            checkSigVisibility();
            triggerAutoSave(); 
        }

        window.clearSignature=function(){ 
            sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); 
            const i = document.getElementById('sig-instruction'); 
            if(i) i.classList.remove('hidden'); 
            
            // Clear image source
            document.getElementById('out-sig-img').src = "";
            checkSigVisibility();
            triggerAutoSave(); 
        }
        
        window.toggleSignature=function(){ 
            const chk=document.getElementById('chk-signature'); 
            const cont=document.getElementById('sig-input-container'); 
            if(chk.checked){ 
                cont.classList.remove('hidden'); 
            } else { 
                cont.classList.add('hidden'); 
            } 
            checkSigVisibility(); 
        }
        
        window.handleSigUpload=function(input){ 
            if(input.files[0]){ 
                const r=new FileReader(); 
                r.onload=(e)=>{
                    document.getElementById('out-sig-img').src=e.target.result; 
                    checkSigVisibility();
                    triggerAutoSave(); 
                }; 
                r.readAsDataURL(input.files[0]); 
            } 
        }

        window.showCreditModal=function(){ document.getElementById('credit-modal').classList.remove('hidden'); }
        window.closeCreditModal=function(){ document.getElementById('credit-modal').classList.add('hidden'); }
    </script>
</body>
</html>
