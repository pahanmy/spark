<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK Curai â€“ V9 (AI Strict Formal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f9ff; }
        
        /* A4 Paper */
        #pdf-wrapper { width: 210mm; margin: 0 auto; background: white; transition: all 0.3s ease; }
        .a4-paper { 
            width: 210mm; 
            min-height: 297mm; 
            padding: 20mm 20mm; 
            background: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            color: black; 
            position: relative; 
            font-family: Arial, sans-serif; 
            display: flex;
            flex-direction: column;
        }

        /* Tables & Content */
        .minit-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt !important; line-height: 1.4 !important; }
        .minit-table th, .minit-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
        .minit-header { background-color: #e0f2fe; font-weight: bold; width: 25%; }
        .th-icon { display: inline-flex; align-items: center; gap: 5px; }
        #out-content { font-size: 11pt; line-height: 1.5; text-align: justify; flex-grow: 1; }
        .single-line-name { white-space: nowrap; overflow: visible; width: 100%; display: block; }

        /* Content Table (User Created) */
        .content-table { width: 100%; border-collapse: collapse; margin: 5px 0 15px 0; font-size: 0.9em; }
        .content-table th, .content-table td { border: 1px solid #333; padding: 5px; text-align: left; vertical-align: middle; }
        .content-table th { background-color: #f3f4f6; font-weight: bold; text-transform: uppercase; text-align: center; }

        /* Image Handling */
        .preview-image-container { text-align: center; margin: 10px 0; page-break-inside: avoid; }
        .preview-image { max-width: 90%; max-height: 400px; height: auto; border: 1px solid #ddd; padding: 4px; background: white; margin-bottom: 5px; }
        .image-caption { font-size: 9pt; color: #555; font-style: italic; text-align: center; display: block; }

        /* UI Elements */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #0284c7; border-radius: 3px; }
        .spark-input { width: 100%; font-size: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; transition: all 0.2s; background: white; resize: none; overflow-y: hidden; min-height: 38px; }
        .spark-input:focus { outline: none; border-color: #0284c7; ring: 2px solid #e0f2fe; }

        .nav-tab { padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .nav-tab.active { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
        .nav-tab.inactive { color: #64748b; background-color: transparent; }
        
        /* Preview Structure */
        .preview-list { list-style: none; padding: 0; margin: 0; }
        .preview-item { margin-bottom: 10px; display: flex; align-items: flex-start; }
        .preview-num { font-weight: normal; min-width: 25px; }
        .preview-text { flex-grow: 1; text-align: justify; }
        
        /* Level 2 (Sub) */
        .sub-list { margin-top: 5px; }
        .sub-item { display: flex; align-items: flex-start; margin-bottom: 4px; }
        .sub-num { font-weight: normal; min-width: 35px; font-size: 0.95em; }
        .sub-text-wrapper { flex-grow: 1; }
        .sub-text { font-size: 0.95em; }

        /* Level 3 (Sub-Sub) */
        .sub-sub-list { margin-top: 3px; margin-left: 0; }
        .sub-sub-item { display: flex; align-items: flex-start; margin-bottom: 3px; }
        .sub-sub-num { font-weight: normal; min-width: 40px; font-size: 0.9em; font-style: italic; color: #444; }
        .sub-sub-text { font-size: 0.9em; font-style: italic; }

        .speaker-section { margin-bottom: 20px; padding-bottom: 10px; }
        
        .speaker-title { font-weight: bold; margin-bottom: 5px; font-size: 10pt; color: #334155; background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; text-transform: none !important; }
        
        .status-tag { display: block; text-align: right; margin-top: 2px; font-size: 8pt; font-weight: bold; color: black; text-transform: uppercase; }

        /* Buttons & Drag Handles */
        .btn-ai-fancy { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; font-weight: 700; font-size: 9px; padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 5px rgba(168, 85, 247, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; text-transform: uppercase; }
        .btn-ai-fancy:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(168, 85, 247, 0.5); }
        .btn-ai-locked { background: #cbd5e1 !important; color: #64748b !important; cursor: not-allowed !important; box-shadow: none !important; border: 1px solid #94a3b8 !important; }
        .btn-ai-locked:hover { transform: none !important; box-shadow: none !important; background: #cbd5e1 !important; }

        .btn-bold { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold; font-family: serif; font-size: 14px; transition: all 0.2s; border: 1px solid #ddd; }
        .btn-bold.active { background-color: #334155; color: white; border-color: #334155; }

        /* Drag Handle Styling */
        .drag-handle { cursor: move; color: #94a3b8; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
        .drag-handle:hover { color: #475569; background-color: #f1f5f9; }
        .sortable-ghost { opacity: 0.4; background-color: #e0f2fe; border: 1px dashed #0284c7; }
        .sortable-drag { cursor: grabbing; }

        #save-indicator { position: fixed; bottom: 20px; right: 20px; background: #64748b; color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; opacity: 1; transition: all 0.3s; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px; }
        #save-indicator.active { background: #22c55e; }
        #save-indicator.saving { background: #eab308; }

        canvas#signature-pad { 
            touch-action: none; 
            border: 1px dashed #cbd5e1; 
            border-radius: 0.5rem; 
            cursor: crosshair; 
            background: white; 
            width: 100%; 
            height: 100%; 
            display: block; 
        } 

        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        /* --- KEMAS KINI TETAPAN ELAK POTONG UNTUK CETAK/PDF --- */
        /* Kita buang class yg tak perlu supaya teks boleh mengalir dengan cantik ke page sebelah tanpa tinggalkan ruang kosong besar */
        .minit-table tr, .content-table, .preview-image-container, .break-inside-avoid { 
            page-break-inside: avoid !important; 
            break-inside: avoid !important; 
        }

        h2, h3, h4, .speaker-title, .minit-header { 
            page-break-after: avoid !important; 
            break-after: avoid !important; 
        }

        /* --- KEMAS KINI CETAKAN NATIVE (CTRL + P / PRINT) --- */
        @media print {
            .no-print, header, .lg\:w-1\/3, #save-indicator { display: none !important; }
            
            body, html, .flex-1, .lg\:w-2\/3 {
                height: auto !important;
                overflow: visible !important;
                width: 100% !important;
                display: block !important;
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            #pdf-wrapper { 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                background: white !important;
            }
            
            .a4-paper {
                width: 100% !important;
                margin: 0 !important;
                padding: 10mm 15mm !important; /* Ruang padding yg cantik untuk A4 */
                box-shadow: none !important;
                min-height: auto !important;
                display: block !important; 
            }

            .bg-gray-100 { background-color: white !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <div id="save-indicator"><span id="save-text">Menunggu Mula</span></div>

    <header class="bg-white shadow-sm border-b border-gray-200 z-50 no-print flex-shrink-0">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-sky-600 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold text-sky-700 uppercase tracking-wide">SPARK CURAI</h1>
                        <div id="account-badge-container">
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">Memuatkan...</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Minit Curai, Nota & Jadual</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showCreditModal()" class="text-xs font-bold text-indigo-600 bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 px-3 py-2 rounded-lg flex items-center gap-1 transition-colors mr-2">ðŸ’¡ Kredit Idea</button>
                <button onclick="window.location.href='user.html'" class="text-gray-500 hover:text-sky-600 text-sm font-semibold px-3 flex items-center gap-1 transition-colors">Kembali</button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                
                <button id="btn-share" onclick="shareRecord()" class="hidden bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg> Kongsi</button>
                
                <button onclick="window.print()" class="bg-gray-800 hover:bg-black text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg> Cetak</button>

                <button onclick="downloadPDF()" class="bg-sky-600 hover:bg-sky-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Muat Turun PDF</button>
                
                <button onclick="saveWork()" id="btn-final-save" class="bg-gradient-to-r from-teal-500 to-green-600 hover:from-teal-600 hover:to-green-700 text-white text-xs font-bold py-2 px-6 rounded-lg shadow-md flex items-center gap-2 uppercase transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Selesai & Simpan</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-5 no-print z-10 custom-scrollbar flex flex-col">
            
            <div class="flex p-1 bg-gray-100 rounded-xl mb-4 gap-1">
                <div onclick="switchTab('editor')" id="tab-editor" class="nav-tab active flex-1 text-center">Isi Borang</div>
                <div onclick="switchTab('history')" id="tab-history" class="nav-tab inactive flex-1 text-center">Sejarah</div>
                <div onclick="switchTab('settings')" id="tab-settings" class="nav-tab inactive flex-1 text-center">Ketetapan</div>
            </div>

            <div id="view-editor" class="block relative">
                <div class="mb-4 flex gap-2 hidden" id="reset-btn-container">
                    <button onclick="clearForm(true)" class="flex-1 bg-red-50 text-red-600 border border-red-200 py-2 rounded text-xs font-bold uppercase hover:bg-red-100 transition">Buat Baru / Reset</button>
                </div>

                <form id="minit-form" oninput="triggerAutoSave(); updatePreview()">
                    <div class="bg-sky-50 p-4 rounded-xl border border-sky-100 mb-4">
                        <h3 class="text-xs font-bold text-sky-700 uppercase mb-3 border-b border-sky-200 pb-2">Maklumat Mesyuarat</h3>
                        <div class="input-group"><label class="input-label">Tajuk Program</label><textarea id="in-tajuk" rows="2" class="spark-input font-bold uppercase" placeholder="Tajuk..."></textarea></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2">
                            <div class="input-group"><label class="input-label text-[10px]">Tarikh Mula</label><input type="date" id="in-tarikh" class="spark-input font-semibold"></div>
                            <div class="input-group"><label class="input-label text-[10px]">Hingga (Pilihan)</label><input type="date" id="in-tarikh-hingga" class="spark-input font-semibold text-gray-500"></div>
                            <div class="input-group"><label class="input-label text-[10px]">Masa</label><input type="time" id="in-masa" class="spark-input font-semibold"></div>
                        </div>
                        <div class="input-group"><label class="input-label">Tempat</label><input type="text" id="in-tempat" class="spark-input" placeholder="Contoh: Bilik Gerakan"></div>
                        <div class="input-group"><label class="input-label">Pengerusi / Anjuran</label><input type="text" id="in-anjuran" class="spark-input" placeholder="Contoh: PPD Miri"></div>
                    </div>

                    <div id="start-section" class="mb-4">
                        <button type="button" onclick="startSession()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 uppercase text-sm border-2 border-green-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Mula Rekod (Aktifkan Auto-Save)
                        </button>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4 mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-gray-700 uppercase">Catatan Minit</h3><span id="session-status" class="text-[9px] text-gray-400 bg-gray-100 px-2 py-1 rounded">Mod Lihat</span></div>
                        
                        <div id="speakers-container" class="space-y-6"></div>
                        
                        <button type="button" onclick="addSpeaker()" class="mt-6 w-full py-3 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-lg text-xs font-bold uppercase hover:bg-indigo-100 transition flex justify-center items-center gap-2 border-dashed border-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Tambah Sesi / Penyampai</button>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 pb-2">Disediakan Oleh</h3>
                        <div class="input-group"><label class="input-label">Nama Pegawai</label><input type="text" id="in-nama" class="spark-input font-bold"></div>
                        <div class="input-group"><label class="input-label">Jawatan</label><input type="text" id="in-jawatan" class="spark-input" placeholder="Cth: Pegawai SISC+"></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group"><label class="input-label">Sektor (Pilihan)</label><input type="text" id="in-sektor" class="spark-input" placeholder="Cth: Sektor Pembelajaran"></div>
                            <div class="input-group"><label class="input-label">Stesen Kerja</label><input type="text" id="in-stesen" class="spark-input" placeholder="Cth: PPD Miri"></div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-200">
                             <div class="flex items-center justify-between mb-2">
                                <label class="flex items-center text-[10px] font-bold text-gray-500 uppercase cursor-pointer">
                                    <input type="checkbox" id="chk-verified" class="w-3 h-3 text-sky-600 rounded mr-2" onchange="toggleVerified(); triggerAutoSave();"> Sertakan Pegawai Penyemak (Pilihan)
                                </label>
                            </div>
                            <div id="verified-input-container" class="hidden bg-white p-3 rounded border border-gray-200 shadow-sm mb-4">
                                <div class="input-group mb-2"><label class="input-label">Nama Penyemak</label><input type="text" id="in-semak-nama" class="spark-input font-bold" placeholder="Nama Pegawai Penyemak"></div>
                                <div class="input-group mb-2"><label class="input-label">Jawatan</label><input type="text" id="in-semak-jawatan" class="spark-input" placeholder="Jawatan"></div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="input-group"><label class="input-label">Sektor (Pilihan)</label><input type="text" id="in-semak-sektor" class="spark-input" placeholder="Sektor Penyemak"></div>
                                    <div class="input-group"><label class="input-label">Stesen Kerja (Pilihan)</label><input type="text" id="in-semak-stesen" class="spark-input" placeholder="Stesen Penyemak"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <div class="flex items-center justify-between mb-2"><label class="flex items-center text-[10px] font-bold text-gray-500 uppercase cursor-pointer"><input type="checkbox" id="chk-signature" class="w-3 h-3 text-sky-600 rounded mr-2" onchange="toggleSignature(); triggerAutoSave();"> Sertakan Tandatangan (Penyedia)</label></div>
                            <div id="sig-input-container" class="hidden space-y-3">
                                 <div class="border border-gray-300 rounded-lg bg-white overflow-hidden"><div class="bg-gray-100 px-3 py-1 border-b border-gray-200 flex justify-between items-center"><span class="text-[10px] font-bold text-gray-500 uppercase">Lukis</span><button type="button" onclick="clearSignature()" class="text-[9px] text-red-600 hover:text-red-800 font-bold uppercase">Padam</button></div>
                                 <div class="relative w-full h-40 bg-white cursor-crosshair">
                                    <canvas id="signature-pad" class="w-full h-full block relative z-10"></canvas>
                                    <div id="sig-instruction" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-300 text-[10px] font-bold uppercase z-0">Lukis Tandatangan Di Sini</div>
                                 </div>
                                 </div>
                                 <div class="relative flex py-1 items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink-0 mx-2 text-[9px] text-gray-400 uppercase">Atau Muat Naik</span><div class="flex-grow border-t border-gray-300"></div></div>
                                 <input type="file" id="sig-upload" accept="image/*" class="w-full text-[10px] text-gray-500" onchange="handleSigUpload(this)">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div id="view-history" class="hidden h-full">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Rekod Minit Terdahulu</h3>
                <div id="history-list" class="space-y-3 overflow-y-auto pb-10"><p class="text-xs text-gray-400 text-center py-4">Memuatkan data dari Firebase...</p></div>
            </div>

            <div id="view-settings" class="hidden">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Konfigurasi Dokumen</h3>
                
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm">
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Jenis Tulisan (Font)</label>
                    <select id="sel-fontFamily" onchange="updateSettings('fontFamily', this.value)" class="w-full text-xs font-semibold border border-gray-300 rounded p-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-gray-700">
                        <option value="Arial, sans-serif" selected>Arial (Standard)</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Calibri', sans-serif">Calibri</option>
                        <option value="'Tahoma', sans-serif">Tahoma</option>
                        <option value="'Helvetica', sans-serif">Helvetica</option>
                    </select>
                </div>

                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Saiz Tulisan (Isi)</label><input type="range" min="9" max="14" step="0.5" value="11" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('fontSize', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Kecil</span><span id="lbl-fontSize">11pt</span><span>Besar</span></div></div>
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Jarak Baris</label><input type="range" min="1.0" max="2.0" step="0.1" value="1.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('lineHeight', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Rapat</span><span id="lbl-lineHeight">1.5</span><span>Jarang</span></div></div>
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Ruang Tepi</label><input type="range" min="10" max="30" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600" oninput="updateSettings('padding', this.value)"><div class="flex justify-between text-[9px] text-gray-400 mt-1"><span>Sempit</span><span id="lbl-padding">20mm</span><span>Luas</span></div></div>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-100 overflow-auto flex justify-center p-8 custom-scrollbar">
            <div id="pdf-wrapper">
                <div class="a4-paper transform scale-100 origin-top" id="main-report">
                    
                    <div class="break-inside-avoid">
                        <div class="w-full flex justify-end mb-2"><svg id="barcode"></svg></div>
                        <div class="text-center border-b-2 border-black pb-4 mb-6">
                            <h2 class="text-xl font-bold uppercase tracking-wider mb-2 text-black">MINIT CURAI</h2>
                            <h3 id="out-tajuk" class="text-lg font-semibold uppercase text-gray-800 leading-tight">TAJUK PROGRAM</h3>
                        </div>
                    </div>
                    
                    <table class="minit-table mb-6 break-inside-avoid">
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> TARIKH</div></th><td id="out-tarikh" class="w-1/4 uppercase"></td><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> MASA</div></th><td id="out-masa" class="w-1/4 uppercase"></td></tr>
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> TEMPAT</div></th><td id="out-tempat" colspan="3" class="uppercase"></td></tr>
                        <tr><th class="minit-header"><div class="th-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg> ANJURAN</div></th><td id="out-anjuran" colspan="3" class="uppercase"></td></tr>
                    </table>
                    
                    <div class="mb-8"><h4 class="text-sm font-bold uppercase border-b border-gray-300 mb-4 pb-1">Intipati / Coretan Mesyuarat</h4><div id="out-content" class="text-justify leading-relaxed"></div></div>
                    
                    <div class="mt-auto flex justify-between pt-12 pb-8 break-inside-avoid items-end">
                        
                        <div class="w-1/3 flex flex-col items-start">
                            <p class="text-[8pt] italic mb-0 self-start w-full text-left">Disediakan Oleh:</p>
                            
                            <div class="h-20 w-full flex items-end justify-start -mb-2 relative z-10">
                                 <img id="out-sig-img" class="h-full max-w-[220px] object-contain object-bottom hidden" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="filter: contrast(1.5);">
                            </div>

                            <div class="border-b border-black w-full mb-1 relative z-0"></div>
                            <p id="out-nama" class="font-bold uppercase leading-tight text-[9pt] w-full text-left single-line-name">NAMA PEGAWAI</p>
                            <p id="out-jawatan" class="text-[8pt] uppercase mt-0.5 w-full text-left single-line-name">JAWATAN</p>
                            <p id="out-sektor" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden">SEKTOR</p>
                            <p id="out-stesen" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden">STESEN KERJA</p>
                            <p id="out-tarikh-laporan" class="text-[8pt] mt-1.5 w-full text-left">TARIKH</p>
                        </div>

                        <div id="out-semak-wrapper" class="w-1/3 flex flex-col items-start ml-auto hidden">
                            <p class="text-[8pt] italic mb-0 self-start w-full text-left">Disemak Oleh:</p>
                            
                            <div class="h-20 w-full flex items-end justify-start -mb-2 relative z-10"></div>

                            <div class="border-b border-black w-full mb-1 relative z-0"></div>
                            <p id="out-semak-nama" class="font-bold uppercase leading-tight text-[9pt] w-full text-left single-line-name">NAMA PENYEMAK</p>
                            <p id="out-semak-jawatan" class="text-[8pt] uppercase mt-0.5 w-full text-left single-line-name">JAWATAN</p>
                            <p id="out-semak-sektor" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden">SEKTOR</p>
                            <p id="out-semak-stesen" class="text-[8pt] uppercase mt-0 w-full text-left single-line-name hidden">STESEN KERJA</p>
                            <p class="text-[8pt] mt-1.5 w-full text-left">TARIKH: ______________</p>
                        </div>

                    </div>

                    <div class="absolute bottom-4 left-0 w-full text-center"><p class="text-[8px] text-gray-300 uppercase tracking-[0.2em]">Dijana oleh SPARK Curai</p></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = firebaseConfig.projectId;
        const SECRET_G = "Z3NrX3hUbHQxRjVIYjRIdmRtejliS3Z5V0dkeWIzRllJcHdSazhrbWRxVlkySTdmTDlOZVdMMGs="; 
        
        const IMGBB_API_KEY = "a7c600ac733fe14649cacd8e65619c4b"; 

        function getKey(encoded) { try { return atob(encoded); } catch (e) { return ""; } }

        window.speakersData = []; window.currentUserIc = ""; window.currentDocId = ""; window.isSparkPro = false; window.isSessionActive = false;
        let sigCanvas, sigCtx, isDrawing = false, isSignatureDrawn = false, saveTimeout;

        window.renderBarcode = function(serial) { if(!serial) serial = "SPARK-" + Math.floor(Math.random() * 1000000); JsBarcode("#barcode", serial, { format: "CODE128", width: 1, height: 15, displayValue: true, fontSize: 8, margin: 0, textMargin: 1 }); }

        window.onload = function() {
            initSignaturePad();
            onAuthStateChanged(auth, async (user) => {
                const urlParams = new URLSearchParams(window.location.search);
                window.currentUserIc = urlParams.get('ic') || localStorage.getItem('user_ic');
                if (window.currentUserIc) {
                    await fetchUserData(window.currentUserIc);
                    setDefaults();
                    addSpeaker(true); loadHistory(); window.renderBarcode();
                } else { alert("Sila log masuk semula."); window.location.href = 'index.html'; }
            });
        };

        async function fetchUserData(ic) {
            try { const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic)); const snap = await getDocs(q);
                if (!snap.empty) { const d = snap.docs[0].data(); 
                const adminIC = "890522135381";
                window.isSparkPro = (d.isPro === true) || (ic === adminIC);
                const badgeContainer = document.getElementById('account-badge-container');
                if (window.isSparkPro) {
                    badgeContainer.innerHTML = '<span class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 font-bold uppercase tracking-wider">PRO</span>';
                } else {
                    badgeContainer.innerHTML = '<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200 font-bold uppercase tracking-wider">AKAUN BIASA</span>';
                }
                updateAIButtons();
                if(!document.getElementById('in-nama').value) document.getElementById('in-nama').value = d.name.toUpperCase();
                if(!document.getElementById('in-jawatan').value) document.getElementById('in-jawatan').value = (d.jawatan || d.unit || "").toUpperCase();
                
                // Set Stesen Kerja & Sektor if available
                if(!document.getElementById('in-stesen').value) document.getElementById('in-stesen').value = (d.stesen || d.sekolah || d.jabatan || "").toUpperCase();
                if(!document.getElementById('in-sektor').value) document.getElementById('in-sektor').value = (d.sektor || "").toUpperCase();
                }
            } catch (e) { console.error(e); }
        }

        function updateAIButtons() {
            const buttons = document.querySelectorAll('.btn-ai-fancy');
            buttons.forEach(btn => { if (window.isSparkPro) btn.classList.remove('btn-ai-locked'); else btn.classList.add('btn-ai-locked'); });
        }

        window.startSession = async function() {
            const title = document.getElementById('in-tajuk').value;
            if(title.length < 5) { alert("Sila isikan Tajuk Program yang lengkap."); return; }
            window.isSessionActive = true;
            document.getElementById('start-section').classList.add('hidden');
            document.getElementById('reset-btn-container').classList.remove('hidden');
            document.getElementById('save-indicator').className = "active";
            document.getElementById('save-indicator').innerHTML = "Aktif (Auto-Save On)";
            document.getElementById('session-status').innerText = "Sedang Direkod...";
            document.getElementById('session-status').className = "text-[9px] text-green-700 bg-green-100 px-2 py-1 rounded animate-pulse";
            await saveToFirebase();
        }

        window.triggerAutoSave = function() {
            if(!window.isSessionActive && !window.currentDocId) return; 
            const ind = document.getElementById('save-indicator'); ind.className = "saving"; ind.innerHTML = "Menyimpan...";
            clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { await saveToFirebase(true); }, 2000);
        }

        window.saveToFirebase = async function(silent = false) {
            const ind = document.getElementById('save-indicator');
            const dataToSave = {
                ic: window.currentUserIc, tajuk: document.getElementById('in-tajuk').value, tarikh: document.getElementById('in-tarikh').value,
                tarikhHingga: document.getElementById('in-tarikh-hingga').value, stesen: document.getElementById('in-stesen').value, sektor: document.getElementById('in-sektor').value,
                masa: document.getElementById('in-masa').value, tempat: document.getElementById('in-tempat').value, anjuran: document.getElementById('in-anjuran').value,
                nama: document.getElementById('in-nama').value, jawatan: document.getElementById('in-jawatan').value, speakers: window.speakersData,
                signatureUrl: document.getElementById('out-sig-img').src, showSignature: document.getElementById('chk-signature').checked,
                showVerified: document.getElementById('chk-verified').checked,
                verifiedName: document.getElementById('in-semak-nama').value,
                verifiedPos: document.getElementById('in-semak-jawatan').value,
                verifiedSektor: document.getElementById('in-semak-sektor').value,
                verifiedStesen: document.getElementById('in-semak-stesen').value,
                settings: { 
                    fontSize: document.getElementById('lbl-fontSize').innerText, 
                    lineHeight: document.getElementById('lbl-lineHeight').innerText, 
                    padding: document.getElementById('lbl-padding').innerText,
                    fontFamily: document.getElementById('sel-fontFamily').value
                },
                updatedAt: new Date()
            };
            try {
                if(window.currentDocId) await updateDoc(doc(db, `artifacts/${appId}/public/data/spark_minit_curai`, window.currentDocId), dataToSave);
                else { if(dataToSave.tajuk) { dataToSave.createdAt=new Date(); const r=await addDoc(collection(db, `artifacts/${appId}/public/data/spark_minit_curai`), dataToSave); window.currentDocId=r.id; } }
                ind.className="saved"; ind.innerHTML="Disimpan"; 
                if(window.currentDocId) document.getElementById('btn-share').classList.remove('hidden'); if(!silent) loadHistory();
            } catch(e){ ind.className="bg-red-500"; ind.innerHTML="Gagal"; }
        }

        // FUNGSI SIMPAN KERJA BAHARU SAHAJA (Tanpa Jana PDF Automatik)
        window.saveWork = async function() {
            const btn = document.getElementById('btn-final-save'); 
            const t = btn.innerHTML; 
            btn.innerHTML = "Menyimpan..."; 
            btn.disabled = true;
            await saveToFirebase(true); 
            btn.innerHTML = t; 
            btn.disabled = false;
            alert("Minit curai anda telah berjaya disimpan ke dalam pangkalan data!");
        }

        window.loadHistory = async function() {
            const listDiv = document.getElementById('history-list');
            try { const q = query(collection(db, `artifacts/${appId}/public/data/spark_minit_curai`), where("ic", "==", window.currentUserIc), orderBy("updatedAt", "desc"));
                const snap = await getDocs(q); listDiv.innerHTML = ""; if(snap.empty) { listDiv.innerHTML = "<p class='text-xs text-center text-gray-400'>Tiada rekod.</p>"; return; }
                snap.forEach(dSnap => { const d = dSnap.data(); const dt = d.tarikh?new Date(d.tarikh).toLocaleDateString('ms-MY'):"-";
                    const item = document.createElement('div'); item.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer";
                    item.onclick = () => loadFromHistory(dSnap.id, d);
                    item.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="text-xs font-bold text-gray-800 uppercase line-clamp-1">${d.tajuk||"Tiada Tajuk"}</h4><p class="text-[10px] text-gray-500">${dt} | ${d.tempat||"-"}</p></div><button onclick="event.stopPropagation(); deleteRecord('${dSnap.id}')" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div>`; listDiv.appendChild(item); });
            } catch (e) { console.error(e); }
        }

        window.loadFromHistory = function(id, data) {
            window.currentDocId = id; window.isSessionActive = true; 
            document.getElementById('start-section').classList.add('hidden'); document.getElementById('reset-btn-container').classList.remove('hidden');
            document.getElementById('in-tajuk').value = data.tajuk; document.getElementById('in-tarikh').value = data.tarikh;
            document.getElementById('in-tarikh-hingga').value = data.tarikhHingga || "";
            document.getElementById('in-masa').value = data.masa; document.getElementById('in-tempat').value = data.tempat;
            document.getElementById('in-anjuran').value = data.anjuran; document.getElementById('in-nama').value = data.nama;
            document.getElementById('in-jawatan').value = data.jawatan; window.speakersData = data.speakers || [];
            document.getElementById('in-stesen').value = data.stesen || "";
            document.getElementById('in-sektor').value = data.sektor || "";
            
            document.getElementById('chk-verified').checked = data.showVerified || false;
            document.getElementById('in-semak-nama').value = data.verifiedName || "";
            document.getElementById('in-semak-jawatan').value = data.verifiedPos || "";
            document.getElementById('in-semak-sektor').value = data.verifiedSektor || "";
            document.getElementById('in-semak-stesen').value = data.verifiedStesen || "";
            window.toggleVerified();

            if(data.settings) { 
                updateSettings('fontSize', parseFloat(data.settings.fontSize)); 
                updateSettings('lineHeight', parseFloat(data.settings.lineHeight)); 
                updateSettings('padding', parseFloat(data.settings.padding)); 
                if(data.settings.fontFamily) {
                    document.getElementById('sel-fontFamily').value = data.settings.fontFamily;
                    updateSettings('fontFamily', data.settings.fontFamily);
                }
            }
            
            if(data.signatureUrl && data.showSignature) { 
                document.getElementById('out-sig-img').src = data.signatureUrl; document.getElementById('chk-signature').checked = true; window.toggleSignature();
            } else { document.getElementById('chk-signature').checked = false; window.toggleSignature(); }
            renderFormFromData(); updatePreview(); switchTab('editor'); document.getElementById('btn-share').classList.remove('hidden');
        }

        window.deleteRecord = async function(id) { if(!confirm("Padam?")) return; try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/spark_minit_curai`, id)); loadHistory(); if(window.currentDocId === id) clearForm(true); } catch(e) { alert("Ralat."); } }
        window.switchTab = function(tName) { ['editor', 'history', 'settings'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).className = 'nav-tab inactive flex-1 text-center'; }); document.getElementById(`view-${tName}`).classList.remove('hidden'); document.getElementById(`view-${tName}`).classList.add('block'); document.getElementById(`tab-${tName}`).className = 'nav-tab active flex-1 text-center'; }
        window.updateSettings = function(type, val) { 
            const c = document.getElementById('out-content'); 
            const p = document.getElementById('main-report'); 
            if(type === 'fontSize') { 
                c.style.fontSize = val + 'pt'; document.getElementById('lbl-fontSize').innerText = val + 'pt'; 
            } else if (type === 'lineHeight') { 
                c.style.lineHeight = val; document.getElementById('lbl-lineHeight').innerText = val; 
            } else if (type === 'padding') { 
                p.style.padding = `${val}mm 20mm`; document.getElementById('lbl-padding').innerText = val + 'mm'; 
            } else if (type === 'fontFamily') {
                p.style.fontFamily = val;
            }
        }
        
       window.shareRecord = function() { 
    if(!window.currentDocId) { alert("Sila simpan minit ini terlebih dahulu."); return; } 
    const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]+$/, '/viewminit.html');
    const link = baseUrl + `?id=${window.currentDocId}`; 
    
    // Fungsi menyalin link terus ke Papan Keratan (Clipboard)
    navigator.clipboard.writeText(link).then(() => {
        alert("Selesai! Pautan telah disalin (Copy).\n\nAnda boleh 'Paste' (Tampal) pautan ini di WhatsApp, Telegram, atau e-mel.\n\nPautan: " + link);
    }).catch(err => {
        // Jika browser pengguna sekat auto-copy, ia akan buka kotak manual
        prompt("Sila salin pautan di bawah secara manual (Copy / Ctrl+C):", link);
    });
}
        
        window.autoResize = function(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- AI LOGIC ---
        window.askAI = async function(btn, type, sIndex, pIndex, subIndex = null) {
            if(!window.isSparkPro) { alert("ðŸ”’ AKSES TERHAD\n\nFungsi AI eksklusif untuk SPARK PRO."); return; }
            const originalText = btn.innerHTML; let inputId = (type === 'point') ? `input-point-${sIndex}-${pIndex}` : `input-sub-${sIndex}-${pIndex}-${subIndex}`;
            const inputEl = document.getElementById(inputId); const userText = inputEl.value;
            if(!userText || userText.length < 3) { alert("Tulis minima 3 huruf."); return; }
            btn.innerHTML = `...`; btn.disabled = true;
            const GROQ_API_KEY = getKey(SECRET_G);
            try {
                const systemPrompt = "Bertindak sebagai pencatat minit profesional. Tukar input pengguna menjadi ayat minit mesyuarat rasmi Bahasa Melayu yang padat, formal, dan gramatis. Gunakan gaya bahasa pentadbiran kerajaan Malaysia. Mulakan ayat dengan frasa tegas seperti 'Pengerusi memaklumkan', 'Mesyuarat memutuskan', 'Pihak pengurusan menegaskan', atau 'Ahli mesyuarat bersetuju'. HANYA berikan output teks minit sahaja tanpa sebarang penjelasan, mukadimah, atau tanda petik.";

                const r = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userText }], model: "llama-3.3-70b-versatile", temperature: 0.5 }) });
                const d = await r.json(); let nText = d.choices[0].message.content.replace(/"/g, '').trim();
                if(type === 'point') { updatePointText(sIndex, pIndex, nText); inputEl.value = nText; } else { updateSubPoint(sIndex, pIndex, subIndex, nText); inputEl.value = nText; }
                autoResize(inputEl); triggerAutoSave();
            } catch (e) { alert("AI Gagal."); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        // --- HTML RENDER WITH DRAG HANDLES ---
        window.renderFormFromData = function() { 
            const container = document.getElementById('speakers-container');
            container.innerHTML = ''; 
            window.speakersData.forEach((s, i) => createSpeakerHTML(s, i)); 
            document.querySelectorAll('textarea.spark-input').forEach(el => autoResize(el));
            
            if(window.speakersSortable) window.speakersSortable.destroy();
            window.speakersSortable = Sortable.create(container, { animation: 150, handle: '.speaker-drag-handle', ghostClass: 'sortable-ghost', onEnd: function(evt) { moveArrayItem(window.speakersData, evt.oldIndex, evt.newIndex); renderFormFromData(); triggerAutoSave(); updatePreview(); } });

            window.speakersData.forEach((s, i) => {
                const pointsList = document.getElementById(`points-list-${i}`);
                if(pointsList) { Sortable.create(pointsList, { animation: 150, handle: '.point-drag-handle', ghostClass: 'sortable-ghost', onEnd: function(evt) { moveArrayItem(window.speakersData[i].points, evt.oldIndex, evt.newIndex); renderFormFromData(); triggerAutoSave(); updatePreview(); } }); }
                s.points.forEach((p, pi) => {
                   const subsContainer = document.getElementById(`subs-container-${i}-${pi}`);
                   if(subsContainer && p.subs.length > 0) { Sortable.create(subsContainer, { animation: 150, handle: '.sub-drag-handle', ghostClass: 'sortable-ghost', onEnd: function(evt) { moveArrayItem(window.speakersData[i].points[pi].subs, evt.oldIndex, evt.newIndex); renderFormFromData(); triggerAutoSave(); updatePreview(); } }); } 
                });
            });
        }
        
        function moveArrayItem(arr, oldIndex, newIndex) {
            if (newIndex >= arr.length) { var k = newIndex - arr.length + 1; while (k--) { arr.push(undefined); } }
            arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
        }

        window.createSpeakerHTML = function(s, i) {
            const w = document.createElement('div'); w.className = "bg-gray-50 border border-gray-300 rounded-lg p-3 relative mb-4"; w.id = `speaker-wrapper-${i}`;
            let pts = ''; s.points.forEach((p, pi) => pts += createPointHTML(p, i, pi));
            w.innerHTML = `
            <div class="mb-3 bg-white p-2 rounded border border-gray-200 flex items-center gap-2">
                <div class="speaker-drag-handle text-gray-400 hover:text-gray-600 cursor-move px-2 text-xl">â˜°</div>
                <div class="flex-grow">
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Penyampai / Sesi</label>
                    <div class="flex gap-2">
                        <input type="text" value="${s.name}" oninput="updateSpeakerName(${i}, this.value)" class="flex-grow text-xs font-bold text-indigo-700 bg-indigo-50 border border-indigo-100 rounded p-1.5 placeholder-indigo-300" placeholder="Cth: Pengarah JPNS">
                        <button onclick="removeSpeaker(${i})" class="text-red-400 hover:text-red-600 p-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                    </div>
                </div>
            </div>
            <div id="points-list-${i}" class="space-y-4 pl-2 border-l-2 border-indigo-100 min-h-[10px]">${pts}</div>
            
            <div class="mt-4 pt-2 border-t border-gray-200 flex flex-col gap-2">
                <button type="button" onclick="addPoint(${i})" class="w-full py-2 bg-sky-50 text-sky-700 border border-sky-200 rounded text-xs font-bold uppercase hover:bg-sky-100 transition flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Tambah Poin Utama
                </button>
                <div class="flex gap-2">
                    <button type="button" onclick="addTablePoint(${i})" class="flex-1 py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded text-xs font-bold uppercase hover:bg-orange-100 transition flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z M4 12h16" /></svg> Tambah Jadual
                    </button>
                    <button type="button" onclick="addImagePoint(${i})" class="flex-1 py-2 bg-green-50 text-green-700 border border-green-200 rounded text-xs font-bold uppercase hover:bg-green-100 transition flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Tambah Gambar
                    </button>
                </div>
            </div>`;
            document.getElementById('speakers-container').appendChild(w);
        }

        window.addImagePoint = function(i) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const btn = document.activeElement;
                if(btn) btn.innerText = "Sedang Muat Naik...";

                const formData = new FormData();
                formData.append("image", file);
                formData.append("key", IMGBB_API_KEY);

                try {
                    const response = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData });
                    const data = await response.json();
                    
                    if (data.success) {
                        window.speakersData[i].points.push({ 
                            type: 'image', 
                            url: data.data.url, 
                            caption: "", 
                            subs: [], status: "", who: "" 
                        });
                        renderFormFromData();
                        triggerAutoSave();
                        updatePreview();
                    } else {
                        alert("Gagal memuat naik gambar. Sila cuba lagi.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Ralat sambungan ke ImgBB.");
                }
            };
            input.click();
        }

        window.updateImageCaption = function(i, pi, val) { window.speakersData[i].points[pi].caption = val; triggerAutoSave(); updatePreview(); }
        // NEW: Link Update Functions
        window.updatePointLink = function(i, pi, val) { window.speakersData[i].points[pi].link = val; triggerAutoSave(); updatePreview(); }
        window.updateSubPointLink = function(i, pi, si, val) { window.speakersData[i].points[pi].subs[si].link = val; triggerAutoSave(); updatePreview(); }
        window.updateSubSubPointLink = function(i, pi, si, ssi, val) { window.speakersData[i].points[pi].subs[si].subsubs[ssi].link = val; triggerAutoSave(); updatePreview(); }

        window.createPointHTML = function(p, i, pi) {
            const aiClass = window.isSparkPro ? "" : "btn-ai-locked";
            
            if(p.type === 'image') {
                return `<div class="relative bg-white border border-green-200 rounded p-2 shadow-sm border-l-4 border-l-green-400 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="point-drag-handle cursor-move text-gray-400 hover:text-gray-600">â˜°</div>
                            <span class="text-[10px] font-bold text-green-600 uppercase">Gambar</span>
                        </div>
                        <button onclick="removePoint(${i}, ${pi})" class="text-gray-300 hover:text-red-400">x</button>
                    </div>
                    <div class="flex flex-col items-center">
                        <img src="${p.url}" class="h-32 object-contain border border-gray-200 rounded mb-2">
                        <input type="text" value="${p.caption || ''}" oninput="updateImageCaption(${i}, ${pi}, this.value)" class="w-full text-xs p-1 border border-gray-300 rounded text-center" placeholder="Kapsyen Gambar (Pilihan)...">
                    </div>
                </div>`;
            }

            if(p.type === 'table') {
                let rowsHtml = '';
                p.tableData.forEach((row, rIndex) => {
                    let colsHtml = '';
                    row.forEach((cell, cIndex) => {
                        colsHtml += `<td class="p-1 border border-gray-300"><input type="text" value="${cell}" oninput="updateTableCell(${i}, ${pi}, ${rIndex}, ${cIndex}, this.value)" class="w-full text-xs p-1 bg-white" placeholder="..."></td>`;
                    });
                    rowsHtml += `<tr>${colsHtml}<td class="w-6 p-1 text-center"><button onclick="removeTableRow(${i}, ${pi}, ${rIndex})" class="text-red-500 hover:text-red-700 font-bold">x</button></td></tr>`;
                });

                return `<div class="relative bg-white border border-orange-200 rounded p-2 shadow-sm border-l-4 border-l-orange-400 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="point-drag-handle cursor-move text-gray-400 hover:text-gray-600">â˜°</div>
                            <span class="text-[10px] font-bold text-orange-600 uppercase">Jadual</span>
                        </div>
                        <button onclick="removePoint(${i}, ${pi})" class="text-gray-300 hover:text-red-400">x</button>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full border-collapse mb-2">${rowsHtml}</table></div>
                    <div class="flex gap-2"><button onclick="addTableRow(${i}, ${pi})" class="text-[9px] bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">+ Baris</button><button onclick="addTableCol(${i}, ${pi})" class="text-[9px] bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">+ Lajur</button></div>
                </div>`;
            }

            const isStat = p.status !== ""; const statHide = isStat ? "" : "hidden"; const whoHide = p.status === "TINDAKAN" ? "" : "hidden"; const boldCls = p.isBold ? "active" : "inactive";
            
            let subs = ''; 
            p.subs.forEach((s, si) => { 
                const subText = (typeof s === 'object') ? s.text : s;
                const subStatus = (typeof s === 'object') ? s.status : "";
                const subWho = (typeof s === 'object') ? s.who : "";
                const subLink = (typeof s === 'object') ? (s.link || "") : "";
                const subSubsArray = (typeof s === 'object' && s.subsubs) ? s.subsubs : [];
                
                let subSubsHtml = '';
                subSubsArray.forEach((ss, ssi) => {
                     const ssStatus = ss.status || "";
                     const ssStatHide = ssStatus !== "" ? "" : "hidden";
                     const ssWhoHide = ssStatus === "TINDAKAN" ? "" : "hidden";
                     const ssLink = ss.link || "";
                     
                     subSubsHtml += `<div class="mt-2 ml-4 border-l border-gray-300 pl-2">
                        <div class="flex gap-2 items-center">
                            <span class="text-[9px] text-gray-400 italic">${pi+1}.${si+1}.${ssi+1}</span>
                            <textarea oninput="updateSubSubPoint(${i}, ${pi}, ${si}, ${ssi}, this.value); autoResize(this)" rows="1" class="spark-input text-[11px] bg-white w-full italic" placeholder="Perincian...">${ss.text}</textarea>
                            <button onclick="removeSubSubPoint(${i}, ${pi}, ${si}, ${ssi})" class="text-gray-300 hover:text-red-400">x</button>
                        </div>
                        <div class="mt-1 ml-6 flex items-center gap-1">
                            <svg class="w-3 h-3 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                            <input type="url" value="${ssLink}" oninput="updateSubSubPointLink(${i}, ${pi}, ${si}, ${ssi}, this.value)" class="w-full text-[9px] border border-gray-200 rounded px-1.5 py-0.5 text-sky-600 focus:outline-none focus:border-sky-400" placeholder="URL Pautan Rujukan (Jika ada)...">
                        </div>
                        <div class="ml-6 mt-1 flex items-center justify-between">
                            <label class="inline-flex items-center cursor-pointer"><input type="checkbox" ${ssStatus !== "" ? 'checked' : ''} onchange="toggleSubSubPointStatus(${i}, ${pi}, ${si}, ${ssi}, this.checked)" class="form-checkbox h-3 w-3 text-sky-600"><span class="ml-1 text-[8px] text-gray-400 hover:text-gray-600">Status</span></label>
                        </div>
                        <div id="subsub-status-box-${i}-${pi}-${si}-${ssi}" class="ml-6 mt-1 flex items-center gap-2 bg-gray-50 p-1 rounded border border-gray-100 ${ssStatHide}">
                             <div class="w-1/3"><select onchange="updateSubSubPointStatusType(${i}, ${pi}, ${si}, ${ssi}, this.value)" class="w-full text-[9px] border border-gray-300 rounded p-1"><option value="MAKLUMAN" ${ssStatus === "MAKLUMAN" ? "selected" : ""}>Makluman</option><option value="TINDAKAN" ${ssStatus === "TINDAKAN" ? "selected" : ""}>Tindakan</option></select></div>
                            <div class="w-2/3 ${ssWhoHide}"><input type="text" value="${ss.who || ''}" oninput="updateSubSubPointWho(${i}, ${pi}, ${si}, ${ssi}, this.value)" class="w-full text-[9px] border border-gray-300 rounded p-1" placeholder="Siapa?"></div>
                        </div>
                     </div>`;
                });

                const isSubStat = subStatus !== "";
                const subStatHide = isSubStat ? "" : "hidden";
                const subWhoHide = subStatus === "TINDAKAN" ? "" : "hidden";

                subs += `
                <div class="flex flex-col gap-1 mt-2 ml-4 border-l border-gray-200 pl-2 bg-gray-50/50 rounded-lg p-1">
                    <div class="flex gap-2 items-start">
                         <div class="sub-drag-handle cursor-move text-gray-300 hover:text-gray-500 mt-2 text-xs">â˜°</div>
                        <span class="mt-2 text-[10px] text-gray-400 font-bold w-6 text-right">${pi + 1}.${si + 1}</span>
                        <div class="flex-grow relative">
                             <textarea id="input-sub-${i}-${pi}-${si}" oninput="autoResize(this); updateSubPoint(${i}, ${pi}, ${si}, this.value)" rows="1" class="spark-input text-xs bg-white w-full pr-16" placeholder="Isi Sub-Poin...">${subText}</textarea>
                             <button onclick="askAI(this, 'sub', ${i}, ${pi}, ${si})" class="btn-ai-fancy absolute right-1 top-1 ${aiClass}">AI</button>
                        </div>
                        <button type="button" onclick="removeSubPoint(${i}, ${pi}, ${si})" class="mt-1 text-gray-300 hover:text-red-400">x</button>
                    </div>
                    <div class="mt-1 flex items-center gap-1 pl-10 pr-2">
                         <svg class="w-3 h-3 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                         <input type="url" value="${subLink}" oninput="updateSubPointLink(${i}, ${pi}, ${si}, this.value)" class="w-full text-[9.5px] border border-gray-200 rounded px-1.5 py-1 text-sky-600 focus:outline-none focus:border-sky-400" placeholder="URL Pautan Rujukan (Jika ada)...">
                    </div>
                    <div class="ml-10 flex gap-3 items-center">
                         <label class="inline-flex items-center cursor-pointer"><input type="checkbox" ${isSubStat ? 'checked' : ''} onchange="toggleSubPointStatus(${i}, ${pi}, ${si}, this.checked)" class="form-checkbox h-3 w-3 text-sky-600"><span class="ml-1 text-[9px] text-gray-400 hover:text-gray-600">Status</span></label>
                         <button onclick="addSubSubPoint(${i}, ${pi}, ${si})" class="text-[9px] text-pink-600 bg-pink-50 border border-pink-200 px-2 py-1 rounded hover:bg-pink-100 flex items-center gap-1 font-bold shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Perincian (${pi+1}.${si+1}.x)
                         </button>
                    </div>
                    <div id="sub-status-box-${i}-${pi}-${si}" class="ml-10 flex items-center gap-2 bg-gray-50 p-1.5 rounded border border-gray-100 ${subStatHide}">
                        <div class="w-1/3"><select onchange="updateSubPointStatusType(${i}, ${pi}, ${si}, this.value)" class="w-full text-[10px] border border-gray-300 rounded p-1"><option value="MAKLUMAN" ${subStatus === "MAKLUMAN" ? "selected" : ""}>Makluman</option><option value="TINDAKAN" ${subStatus === "TINDAKAN" ? "selected" : ""}>Tindakan</option></select></div>
                        <div class="w-2/3 ${subWhoHide}" id="sub-who-box-${i}-${pi}-${si}"><input type="text" value="${subWho}" oninput="updateSubPointWho(${i}, ${pi}, ${si}, this.value)" class="w-full text-[10px] border border-gray-300 rounded p-1" placeholder="Siapa?"></div>
                    </div>
                    <div id="subsubs-container-${i}-${pi}-${si}">${subSubsHtml}</div>
                </div>`; 
            });

            return `<div class="relative bg-white border border-gray-100 rounded p-2 shadow-sm mb-2">
                <div class="flex gap-2 items-start">
                    <div class="flex flex-col gap-1 mt-1 items-center">
                        <div class="point-drag-handle cursor-move text-gray-300 hover:text-gray-500 mb-1">â˜°</div>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 w-6 h-6 flex items-center justify-center rounded-full">${pi + 1}</span>
                        <button onclick="toggleBold(${i}, ${pi})" class="btn-bold ${boldCls}" title="Bold?">B</button>
                    </div>
                    <div class="flex-grow">
                        <div class="relative">
                            <textarea id="input-point-${i}-${pi}" oninput="autoResize(this); updatePointText(${i}, ${pi}, this.value)" rows="1" class="spark-input text-sm mb-1 pr-16" placeholder="Isi Poin Utama...">${p.text}</textarea>
                            <button onclick="askAI(this, 'point', ${i}, ${pi})" class="btn-ai-fancy absolute right-2 top-2 ${aiClass}">AI</button>
                        </div>
                        <div class="mt-1 flex items-center gap-1 mb-2">
                             <svg class="w-4 h-4 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                             <input type="url" value="${p.link || ''}" oninput="updatePointLink(${i}, ${pi}, this.value)" class="w-full text-[10px] border border-gray-200 rounded px-2 py-1.5 text-sky-600 focus:outline-none focus:border-sky-400" placeholder="URL Pautan Rujukan (Jika ada)...">
                        </div>
                        <div class="flex items-center justify-between mb-2 mt-1">
                             <label class="inline-flex items-center cursor-pointer"><input type="checkbox" ${isStat ? 'checked' : ''} onchange="togglePointStatus(${i}, ${pi}, this.checked)" class="form-checkbox h-3 w-3 text-sky-600"><span class="ml-2 text-[9px] text-gray-400 hover:text-gray-600 uppercase font-bold">Status/Tindakan</span></label>
                        </div>
                        <div id="status-box-${i}-${pi}" class="flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100 ${statHide} mb-2">
                            <div class="w-1/3"><select onchange="updatePointStatusType(${i}, ${pi}, this.value)" class="w-full text-xs border border-gray-300 rounded p-1"><option value="MAKLUMAN" ${p.status === "MAKLUMAN" ? "selected" : ""}>Makluman</option><option value="TINDAKAN" ${p.status === "TINDAKAN" ? "selected" : ""}>Tindakan</option></select></div>
                            <div class="w-2/3 ${whoHide}" id="who-box-${i}-${pi}"><input type="text" value="${p.who}" oninput="updatePointWho(${i}, ${pi}, this.value)" class="w-full text-xs border border-gray-300 rounded p-1" placeholder="Siapa? (Cth: Semua Guru)"></div>
                        </div>
                        <div id="subs-container-${i}-${pi}" class="min-h-[5px]">${subs}</div>
                        <div class="mt-3 pt-2 border-t border-dashed border-gray-200">
                             <button onclick="addSubPoint(${i}, ${pi})" class="w-full text-[10px] font-bold text-teal-600 bg-teal-50 border border-teal-200 px-4 py-1.5 rounded-lg hover:bg-teal-100 flex items-center justify-center gap-1 transition-colors shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg> Tambah Sub-Poin (1.x)
                             </button>
                        </div>
                    </div>
                    <button onclick="removePoint(${i}, ${pi})" class="text-gray-300 hover:text-red-400 self-start mt-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
            </div>`;
        }

        window.addSubPoint = function(i, pi) { window.speakersData[i].points[pi].subs.push({ text: "", status: "", who: "", link: "", subsubs: [] }); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.addSubSubPoint = function(i, pi, si) { let sub = window.speakersData[i].points[pi].subs[si]; if(!sub.subsubs) sub.subsubs = []; sub.subsubs.push({ text: "", status: "", who: "", link: "" }); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateSubPoint = function(i, pi, si, v) { let sub = window.speakersData[i].points[pi].subs[si]; if(typeof sub === 'string') sub = { text: v, status: "", who: "", link: "", subsubs: [] }; else sub.text = v; window.speakersData[i].points[pi].subs[si] = sub; triggerAutoSave(); updatePreview(); }
        window.updateSubSubPoint = function(i, pi, si, ssi, v) { window.speakersData[i].points[pi].subs[si].subsubs[ssi].text = v; triggerAutoSave(); updatePreview(); }
        window.removeSubSubPoint = function(i, pi, si, ssi) { window.speakersData[i].points[pi].subs[si].subsubs.splice(ssi, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        
        window.toggleSubSubPointStatus = function(i, pi, si, ssi, chk) { window.speakersData[i].points[pi].subs[si].subsubs[ssi].status = chk ? "MAKLUMAN" : ""; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateSubSubPointStatusType = function(i, pi, si, ssi, val) { window.speakersData[i].points[pi].subs[si].subsubs[ssi].status = val; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateSubSubPointWho = function(i, pi, si, ssi, val) { window.speakersData[i].points[pi].subs[si].subsubs[ssi].who = val; triggerAutoSave(); updatePreview(); }

        window.addTablePoint = function(i) { window.speakersData[i].points.push({ type: 'table', tableData: [['Header 1', 'Header 2'], ['Data 1', 'Data 2']], subs: [], status: "", who: "" }); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateTableCell = function(i, pi, r, c, val) { window.speakersData[i].points[pi].tableData[r][c] = val; triggerAutoSave(); updatePreview(); }
        window.addTableRow = function(i, pi) { const cols = window.speakersData[i].points[pi].tableData[0].length; window.speakersData[i].points[pi].tableData.push(new Array(cols).fill("")); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.addTableCol = function(i, pi) { window.speakersData[i].points[pi].tableData.forEach(row => row.push("")); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.removeTableRow = function(i, pi, r) { if(window.speakersData[i].points[pi].tableData.length > 1) { window.speakersData[i].points[pi].tableData.splice(r, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); } else alert("Jadual mesti ada sekurangnya 1 baris."); }
        
        window.toggleSubPointStatus = function(i, pi, si, chk) { let sub = window.speakersData[i].points[pi].subs[si]; if(typeof sub === 'string') sub = { text: sub, status: "", who: "", link: "" }; sub.status = chk ? "MAKLUMAN" : ""; window.speakersData[i].points[pi].subs[si] = sub; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateSubPointStatusType = function(i, pi, si, val) { window.speakersData[i].points[pi].subs[si].status = val; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updateSubPointWho = function(i, pi, si, val) { window.speakersData[i].points[pi].subs[si].who = val; triggerAutoSave(); updatePreview(); }
        window.addSpeaker = function() { window.speakersData.push({ name: "Pengerusi", points: [] }); addPoint(window.speakersData.length - 1); triggerAutoSave(); }
        window.removeSpeaker = function(i) { if(confirm("Padam?")) { window.speakersData.splice(i, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); } }
        window.updateSpeakerName = function(i, v) { window.speakersData[i].name = v; triggerAutoSave(); updatePreview(); }
        window.addPoint = function(i, silent = false) { window.speakersData[i].points.push({ text: "", subs: [], status: "", who: "", isBold: false, type: 'text', link: "" }); renderFormFromData(); if(!silent) triggerAutoSave(); updatePreview(); }
        window.removePoint = function(i, pi) { window.speakersData[i].points.splice(pi, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointText = function(i, pi, v) { window.speakersData[i].points[pi].text = v; triggerAutoSave(); updatePreview(); }
        window.toggleBold = function(i, pi) { window.speakersData[i].points[pi].isBold = !window.speakersData[i].points[pi].isBold; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.togglePointStatus = function(i, pi, chk) { window.speakersData[i].points[pi].status = chk ? "MAKLUMAN" : ""; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointStatusType = function(i, pi, v) { window.speakersData[i].points[pi].status = v; renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.updatePointWho = function(i, pi, v) { window.speakersData[i].points[pi].who = v; triggerAutoSave(); updatePreview(); }
        window.removeSubPoint = function(i, pi, si) { window.speakersData[i].points[pi].subs.splice(si, 1); renderFormFromData(); triggerAutoSave(); updatePreview(); }
        window.clearForm = function(r) { if(confirm("Reset?")) { window.currentDocId = ""; if(r) { document.getElementById('in-tajuk').value = ""; document.getElementById('in-tempat').value = ""; document.getElementById('in-anjuran').value = ""; document.getElementById('in-tarikh-hingga').value = ""; } window.speakersData = []; addSpeaker(true); updatePreview(); document.getElementById('start-section').classList.remove('hidden'); document.getElementById('reset-btn-container').classList.add('hidden'); document.getElementById('save-indicator').className = ""; document.getElementById('save-indicator').innerHTML = "Menunggu Mula"; document.getElementById('session-status').innerText = "Mod Lihat (Tidak Disimpan)"; document.getElementById('session-status').className = "text-[9px] text-gray-400 bg-gray-100 px-2 py-1 rounded"; } }

        window.updatePreview = function() {
            // Updated to handle both stesen and sektor
            ['tajuk', 'tempat', 'anjuran', 'nama', 'jawatan', 'stesen', 'sektor'].forEach(id => {
                const el = document.getElementById(`out-${id}`);
                const inEl = document.getElementById(`in-${id}`);
                if (el && inEl) {
                    el.textContent = inEl.value.toUpperCase();
                    // Hide stesen/sektor if empty to save space, show if filled
                    if ((id === 'sektor' || id === 'stesen') && el.textContent.trim() === "") {
                        el.classList.add('hidden');
                    } else if (id === 'sektor' || id === 'stesen') {
                        el.classList.remove('hidden');
                    }
                }
            });

            const d1 = document.getElementById('in-tarikh').value; 
            const d2 = document.getElementById('in-tarikh-hingga').value;
            
            if(d1) { 
                const dojb1 = new Date(d1); 
                let tarikhText = dojb1.toLocaleDateString('ms-MY', {day:'numeric',month:'long',year:'numeric'}).toUpperCase(); 
                document.getElementById('out-tarikh-laporan').textContent = `TARIKH: ${tarikhText}`; 
                
                if (d2 && d2 !== d1) {
                    const dojb2 = new Date(d2);
                    if (dojb2 > dojb1) {
                        const tarikhText2 = dojb2.toLocaleDateString('ms-MY', {day:'numeric',month:'long',year:'numeric'}).toUpperCase(); 
                        tarikhText = `${tarikhText} - ${tarikhText2}`;
                    }
                }
                document.getElementById('out-tarikh').textContent = tarikhText;
            } else { 
                document.getElementById('out-tarikh-laporan').textContent = "TARIKH:"; 
                document.getElementById('out-tarikh').textContent = "";
            }

            const t = document.getElementById('in-masa').value; if(t) { let [h,m]=t.split(':'); let s=h>=12?"PETANG":"PAGI"; if(h>12)h-=12; if(h==='00')h=12; document.getElementById('out-masa').textContent = `${h}.${m} ${s}`; }
            
            if(document.getElementById('chk-verified').checked) {
                document.getElementById('out-semak-wrapper').classList.remove('hidden');
                document.getElementById('out-semak-nama').textContent = document.getElementById('in-semak-nama').value.toUpperCase() || "NAMA PENYEMAK";
                document.getElementById('out-semak-jawatan').textContent = document.getElementById('in-semak-jawatan').value.toUpperCase() || "JAWATAN";
                
                const semakSektor = document.getElementById('in-semak-sektor').value.toUpperCase();
                const elSemakSektor = document.getElementById('out-semak-sektor');
                if(semakSektor) { elSemakSektor.textContent = semakSektor; elSemakSektor.classList.remove('hidden'); } else { elSemakSektor.classList.add('hidden'); }
                
                const semakStesen = document.getElementById('in-semak-stesen').value.toUpperCase();
                const elSemakStesen = document.getElementById('out-semak-stesen');
                if(semakStesen) { elSemakStesen.textContent = semakStesen; elSemakStesen.classList.remove('hidden'); } else { elSemakStesen.classList.add('hidden'); }
            } else { document.getElementById('out-semak-wrapper').classList.add('hidden'); }

            const qrQueue = [];
            function getLinkHtml(link, id) {
                if (!link) return '';
                qrQueue.push({ id: id, url: link });
                return `<div class="mt-1 mb-2 flex flex-wrap items-center gap-2 bg-sky-50/50 p-1.5 rounded border border-sky-100 print:bg-transparent print:border-none print:p-0">
                            <div id="${id}" class="w-10 h-10 print:w-12 print:h-12 border border-gray-200 p-0.5 rounded bg-white shadow-sm shrink-0"></div>
                            <a href="${link}" target="_blank" class="text-[8pt] text-sky-700 no-underline font-mono tracking-tight hover:underline break-all max-w-[80%]">
                                ${link}
                            </a>
                        </div>`;
            }

            const c = document.getElementById('out-content'); c.innerHTML = '';
            window.speakersData.forEach((s, speakerIdx) => {
                const sec = document.createElement('div'); sec.className = "speaker-section";
                if(s.name) sec.innerHTML += `<div class="speaker-title">${s.name}</div>`;
                const list = document.createElement('div'); list.className = "preview-list";
                s.points.forEach((p, i) => {
                    // IMAGE RENDER
                    if(p.type === 'image') {
                        const item = document.createElement('div'); item.className = "preview-image-container";
                        item.innerHTML = `<img src="${p.url}" class="preview-image" crossorigin="anonymous"><span class="image-caption">${p.caption || ''}</span>`;
                        list.appendChild(item); return;
                    }
                    
                    if(p.type === 'table') {
                         const item = document.createElement('div'); item.className = "preview-item";
                         let thtml = '<table class="content-table"><thead><tr>';
                         p.tableData[0].forEach(h => thtml += `<th>${h}</th>`);
                         thtml += '</tr></thead><tbody>';
                         for(let r=1; r<p.tableData.length; r++) { thtml += '<tr>'; p.tableData[r].forEach(c => thtml += `<td>${c}</td>`); thtml += '</tr>'; }
                         thtml += '</tbody></table>';
                         item.innerHTML = `<div class="preview-num"></div><div class="preview-text">${thtml}</div>`;
                         list.appendChild(item); return;
                    }

                    const item = document.createElement('div'); item.className = "preview-item";
                    let linkHtml = getLinkHtml(p.link, `qr-p-${speakerIdx}-${i}`);
                    
                    item.innerHTML = `<div class="preview-num">${i+1}.</div><div class="preview-text"><div style="${p.isBold?'font-weight:bold':''}">${p.text}</div>${linkHtml}</div>`;
                    const td = item.querySelector('.preview-text');
                    
                    if(p.subs.length > 0) { 
                        const sl = document.createElement('div'); sl.className = "sub-list"; 
                        p.subs.forEach((sb, si) => { 
                            const subText = (typeof sb === 'object') ? sb.text : sb;
                            const subStatus = (typeof sb === 'object') ? sb.status : "";
                            const subWho = (typeof sb === 'object') ? sb.who : "";
                            const subLink = (typeof sb === 'object') ? sb.link : "";
                            const subSubs = (typeof sb === 'object' && sb.subsubs) ? sb.subsubs : [];

                            if(subText.trim() || subSubs.length > 0) {
                                let sLinkHtml = getLinkHtml(subLink, `qr-s-${speakerIdx}-${i}-${si}`);
                                let html = `<div class="sub-item"><div class="sub-num">${i+1}.${si+1}</div><div class="sub-text-wrapper"><div class="sub-text">${subText}</div>${sLinkHtml}`;
                                if(subStatus) { const whoLabel = subStatus === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (subWho.toUpperCase() || "PGB"); html += `<div class="status-tag">${whoLabel}</div>`; }
                                
                                if(subSubs.length > 0) {
                                    html += `<div class="sub-sub-list">`;
                                    subSubs.forEach((ss, ssi) => {
                                        const ssStatus = ss.status || "";
                                        const ssWho = ss.who || "";
                                        const ssLink = ss.link || "";
                                        if(ss.text.trim()) {
                                            let ssLinkHtml = getLinkHtml(ssLink, `qr-ss-${speakerIdx}-${i}-${si}-${ssi}`);
                                            html += `<div class="sub-sub-item"><div class="sub-sub-num">${i+1}.${si+1}.${ssi+1}</div><div class="sub-sub-text-wrapper flex-grow"><div class="sub-sub-text">${ss.text}</div>${ssLinkHtml}`;
                                            if(ssStatus) { const ssWhoLabel = ssStatus === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (ssWho.toUpperCase() || "PGB"); html += `<div class="status-tag">${ssWhoLabel}</div>`; }
                                            html += `</div></div>`;
                                        }
                                    });
                                    html += `</div>`;
                                }
                                html += `</div></div>`;
                                sl.innerHTML += html;
                            } 
                        }); 
                        td.appendChild(sl); 
                    }
                    if(p.status) td.innerHTML += `<div class="status-tag">${p.status === "MAKLUMAN" ? "MAKLUMAN" : "TINDAKAN: " + (p.who.toUpperCase() || "PGB")}</div>`;
                    if(p.text.trim() || p.subs.length>0) list.appendChild(item);
                });
                sec.appendChild(list); if(s.points.length>0 || s.name) c.appendChild(sec);
            });
            window.renderBarcode();
            checkSigVisibility();

            // Render QR Codes after DOM is updated
            setTimeout(() => {
                qrQueue.forEach(q => {
                    const el = document.getElementById(q.id);
                    if (el) {
                        el.innerHTML = ""; 
                        new QRCode(el, {
                            text: q.url,
                            width: 100, 
                            height: 100,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.L
                        });
                        const img = el.querySelector('img');
                        const cvs = el.querySelector('canvas');
                        if(img) img.style.cssText = "width: 100%; height: 100%; object-fit: contain; display: block;";
                        if(cvs) cvs.style.cssText = "width: 100%; height: 100%; object-fit: contain; display: block;";
                    }
                });
            }, 100);
        }

        window.setDefaults = function() { const n = new Date(); document.getElementById('in-tarikh').value = n.toISOString().split('T')[0]; document.getElementById('in-masa').value = n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); }
        
        // PANDUAN MEMBUAT PDF MENGGUNAKAN ENJIN CETAKAN (Lebih Stabil)
        window.downloadPDF = function() { 
            alert("Untuk kualiti PDF terbaik tanpa muka surat kosong:\n\n1. Skrin cetakan akan dibuka sebentar lagi.\n2. Sila pilih 'Save as PDF' (Simpan sebagai PDF) pada pilihan 'Destination' atau 'Printer'.\n3. Tekan butang Print/Save.");
            window.print();
        }
        
        function initSignaturePad() { 
            sigCanvas = document.getElementById('signature-pad'); if (!sigCanvas) return; 
            sigCtx = sigCanvas.getContext('2d'); 
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            sigCanvas.width = sigCanvas.offsetWidth * ratio; sigCanvas.height = sigCanvas.offsetHeight * ratio; sigCtx.scale(ratio, ratio);
            sigCanvas.addEventListener('mousedown', sD); sigCanvas.addEventListener('mouseup', eD); sigCanvas.addEventListener('mousemove', dD); 
            sigCanvas.addEventListener('touchstart', (e)=>{e.preventDefault();sD(e.touches[0])}); sigCanvas.addEventListener('touchend', (e)=>{e.preventDefault();eD()}); sigCanvas.addEventListener('touchmove', (e)=>{e.preventDefault();dD(e.touches[0])}); 
        }

        function sD(e){ isDrawing=true; isSignatureDrawn=true; const i = document.getElementById('sig-instruction'); if(i) i.classList.add('hidden'); dD(e); } 
        function eD(){ isDrawing=false; sigCtx.beginPath(); uS(); } 
        function dD(e){ if(!isDrawing) return; const r=sigCanvas.getBoundingClientRect(); sigCtx.lineWidth=3; sigCtx.lineCap = "round"; sigCtx.lineTo(e.clientX-r.left, e.clientY-r.top); sigCtx.stroke(); sigCtx.beginPath(); sigCtx.moveTo(e.clientX-r.left, e.clientY-r.top); }
        function uS(){ document.getElementById('out-sig-img').src=sigCanvas.toDataURL(); checkSigVisibility(); triggerAutoSave(); }

        function checkSigVisibility() {
            const chk = document.getElementById('chk-signature'); const img = document.getElementById('out-sig-img');
            const hasData = img.src && img.src.length > 1000; 
            if(chk.checked && hasData) img.classList.remove('hidden'); else img.classList.add('hidden');
        }

        window.clearSignature=function(){ 
            sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); 
            isSignatureDrawn=false; 
            const i = document.getElementById('sig-instruction'); 
            if(i) i.classList.remove('hidden'); 
            document.getElementById('out-sig-img').src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; 
            checkSigVisibility(); 
            triggerAutoSave(); 
        }
        
        window.toggleSignature=function(){ const chk=document.getElementById('chk-signature'); const cont=document.getElementById('sig-input-container'); if(chk.checked){ cont.classList.remove('hidden'); setTimeout(() => { const rect = sigCanvas.getBoundingClientRect(); if(rect.width > 0) { const ratio = Math.max(window.devicePixelRatio || 1, 1); sigCanvas.width = rect.width * ratio; sigCanvas.height = rect.height * ratio; sigCtx.scale(ratio, ratio); } }, 100); } else { cont.classList.add('hidden'); } checkSigVisibility(); }
        window.handleSigUpload=function(input){ if(input.files[0]){ const r=new FileReader(); r.onload=(e)=>{ document.getElementById('out-sig-img').src=e.target.result; if(document.getElementById('chk-signature').checked) checkSigVisibility(); triggerAutoSave(); }; r.readAsDataURL(input.files[0]); } }
        
        window.toggleVerified = function() {
            const chk = document.getElementById('chk-verified');
            const cont = document.getElementById('verified-input-container');
            if(chk.checked) cont.classList.remove('hidden'); else cont.classList.add('hidden');
            updatePreview();
        }

        window.showCreditModal=function(){ document.getElementById('credit-modal').classList.remove('hidden'); }
        window.closeCreditModal=function(){ document.getElementById('credit-modal').classList.add('hidden'); }
    </script>
</body>
</html>
