<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ Maklumat Peserta Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { transition: background-color 0.3s, color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
             <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500">Percikan Inovasi Kehadiran Digital</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <a id="back-to-program-link" href="#" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Kembali ke Program
                </a>
                 
                 <a id="go-to-analysis-link" href="#" class="btn relative bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-200 flex items-center gap-2 text-sm">
                    <span class="absolute -top-1.5 -right-1.5 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">Baru</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
                    <span>Analisis</span>
                </a>

                 <a href="index.html" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    Halaman Utama
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto py-6 sm:px-6 lg:px-8 flex-grow w-full">
        <div id="loading-state" class="text-center p-8">
            <p>Memuatkan data program...</p>
        </div>
        <div id="program-content" class="card p-6 md:p-8 hidden">
            <div id="program-details" class="mb-6 pb-4 border-b">
                <h2 id="program-name" class="text-2xl font-bold text-gray-900 uppercase"></h2>
                <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-500 mt-2 uppercase font-medium">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        <span id="program-location"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span id="program-date"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        <span id="program-time"></span>
                    </div>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-4 uppercase">Senarai Peserta Program</h3>
            <div class="flex flex-wrap gap-4 mb-4 items-end">
                <div class="flex-grow">
                    <label for="search-input" class="text-sm font-medium text-gray-700">Carian</label>
                    <input type="text" id="search-input" placeholder="Cari nama..." class="mt-1 block w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex-grow">
                    <label for="station-filter" class="text-sm font-medium text-gray-700">Tapis Stesyen Kerja</label>
                    <select id="station-filter" class="mt-1 block w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Semua Stesyen Kerja</option>
                    </select>
                </div>
                 <div class="flex-grow">
                    <label for="items-per-page" class="text-sm font-medium text-gray-700">Papar</label>
                    <select id="items-per-page" onchange="changeItemsPerPage()" class="mt-1 block w-full sm:w-32 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportToExcel()" title="Muat Turun Excel" class="btn text-sm bg-green-100 text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm2 1v2h12V6H4zm0 4v2h12v-2H4zm0 4v2h12v-2H4z" /></svg>
                        <span>Excel</span>
                    </button>
                     <button onclick="exportToSplkpm()" title="Muat Turun Excel SPLG-KPM" class="btn text-sm bg-sky-100 text-sky-800 font-semibold py-2 px-3 rounded-lg hover:bg-sky-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        <span>SPLG-KPM</span>
                    </button>
                    <button onclick="exportToPdf()" title="Eksport ke PDF (Senarai Hadir)" class="btn text-sm bg-red-100 text-red-800 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                       <span>PDF</span>
                    </button>
                    <button onclick="downloadAllAppreciationCertificates()" title="Jana Semua Sijil Penghargaan" class="btn text-sm bg-amber-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-amber-600 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0 1 1 0 002 0zM7 8a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        <span>Sijil Pukal</span>
                    </button>
                    <button onclick="showLateAttendanceModal()" title="Tambah Kehadiran Lewat" class="btn text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-3 rounded-lg hover:bg-blue-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        <span>Tambah Lewat</span>
                    </button>
                    <button onclick="showCompareModal()" title="Bandingkan Data Kehadiran" class="btn text-sm bg-orange-100 text-orange-800 font-semibold py-2 px-3 rounded-lg hover:bg-orange-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3zm3.146 5.146L8 10.001V15l1.001-1 2.147-2.146.853-.854L15 8.146V4H5v4.146z" clip-rule="evenodd" /></svg>
                        <span>Banding Data</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peserta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. IC</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Peranan</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="participant-list-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls" class="flex justify-between items-center mt-4"></div>
        </div>
    </main>
    
    <footer class="text-center py-4 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-600">Projek Inovasi oleh <a href="https://pahanmy.github.io/works/" target="_blank" class="font-semibold text-indigo-500 hover:underline">Pahan</a></p>
        <p id="version-info" class="text-xs text-gray-500"></p>
    </footer>

    <div id="late-attendance-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-semibold mb-4">Tambah Kehadiran Lewat</h3><div id="late-ic-entry"><p class="text-sm text-gray-600">Masukkan No. IC peserta yang ingin ditambah.</p><div class="relative my-4"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 5a1 1 0 100-2H4a1 1 0 100 2h12zM4 13a1 1 0 100 2h6a1 1 0 100-2H4z" clip-rule="evenodd" /></svg></div><input type="text" id="late-ic-input" placeholder="No. IC (tanpa sengkang)" class="block w-full pl-10 px-4 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="flex justify-end gap-3"><button type="button" onclick="closeModal('late-attendance-modal')" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Batal</button><button type="button" onclick="findLateParticipant()" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Cari</button></div></div><form id="new-late-participant-form" class="hidden text-left" onsubmit="registerLateParticipant(event)"><p class="text-center text-sm text-gray-600 mb-4">Peserta tidak ditemui. Sila lengkapkan maklumat.</p><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">No. IC</label><input type="text" id="new-late-ic" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div><div><label class="block text-sm font-medium text-gray-700">Nama Penuh</label><input type="text" id="new-late-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></div><div><label class="block text-sm font-medium text-gray-700">Stesyen Kerja</label><input type="text" id="new-late-station" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></div><div><label class="block text-sm font-medium text-gray-700">Jawatan</label><input type="text" id="new-late-position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" onclick="resetLateModal()" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Batal</button><button type="submit" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Tambah Peserta</button></div></form></div></div>
    <div id="compare-data-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6"><h3 class="text-xl font-semibold mb-2">Semak Senarai Kehadiran</h3><p class="text-sm text-gray-600 mb-4">Tampal senarai peserta (2 lajur: Nama dan Sekolah/Stesyen) dari Excel.</p><div id="compare-options" class="mb-4"><label class="block text-sm font-medium text-gray-700">Bandingkan Mengikut:</label><div class="flex items-center gap-x-6 mt-1"><label class="inline-flex items-center"><input type="radio" name="compare-by" value="name" class="form-radio h-4 w-4 text-indigo-600" checked><span class="ml-2 text-sm text-gray-800">Nama Peserta (Semakan Fleksibel)</span></label><label class="inline-flex items-center"><input type="radio" name="compare-by" value="station" class="form-radio h-4 w-4 text-indigo-600"><span class="ml-2 text-sm text-gray-800">Sekolah / Stesyen Kerja</span></label></div></div><div class="grid grid-cols-2 gap-4"><div><label for="compare-input" class="block text-sm font-medium text-gray-700">Senarai Asal (Tampal di sini)</label><textarea id="compare-input" rows="10" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm" placeholder="Contoh:&#10;ALI BIN ABU	SK CONTOH&#10;SITI BINTI AMINAH	PPD CONTOH"></textarea></div><div><label for="compare-output" class="block text-sm font-medium text-gray-700">Senarai Tidak Hadir (Hasil)</label><textarea id="compare-output" rows="10" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm bg-gray-50"></textarea></div></div><div id="compare-review-area" class="mt-4"></div><div id="compare-actions" class="mt-4 flex justify-between items-center"><div class="flex gap-2"><button id="start-comparison-btn" type="button" onclick="performComparison()" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Semak Senarai</button><button id="finish-review-btn" type="button" onclick="showFinalResults(true)" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Papar Senarai Tidak Hadir</button></div><div><button id="copy-results-btn" type="button" onclick="copyResults()" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Salin Hasil</button><button type="button" onclick="closeModal('compare-data-modal')" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg ml-2">Tutup</button></div></div></div></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, addDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM",
            authDomain: "myqrhadir.firebaseapp.com",
            projectId: "myqrhadir",
            storageBucket: "myqrhadir.appspot.com",
            messagingSenderId: "799691133747",
            appId: "1:799691133747:web:835a5e3e9413eace806446"
        };
        
        let db, auth;
        let currentProgram = null;
        let allParticipants = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        const appId = firebaseConfig.projectId;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase:", e); }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) { main(); } 
            else { try { await signInAnonymously(auth); } catch (error) { console.error("Error signing in:", error); } }
        });

        function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const programKey = urlParams.get('kod');

            if (!programKey) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Kod program tidak ditemui. Sila akses halaman ini melalui pautan yang sah.</p>`;
                return;
            }

            document.getElementById('back-to-program-link').href = `program.html?kod=${programKey}`;
            document.getElementById('go-to-analysis-link').href = `analisis.html?kod=${programKey}`; 

            listenForProgramData(programKey);
            document.getElementById('search-input').addEventListener('input', () => { currentPage = 1; renderParticipantTable(); });
            document.getElementById('station-filter').addEventListener('change', () => { currentPage = 1; renderParticipantTable(); });

            const versionInfo = document.getElementById('version-info');
            if(versionInfo) {
                const year = new Date().getFullYear();
                versionInfo.textContent = `Versi 2.1 (${year})`;
            }
        }

        function listenForProgramData(programKey) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, programKey);
            onSnapshot(programRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgram = { id: docSnap.id, ...docSnap.data() };
                    allParticipants = currentProgram.attendance || [];

                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('program-content').classList.remove('hidden');
                    
                    document.getElementById('program-name').textContent = currentProgram.name;
                    document.getElementById('program-location').textContent = currentProgram.location;
                    document.getElementById('program-date').textContent = new Date(currentProgram.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('program-time').textContent = formatTimeRange(currentProgram.startTime, currentProgram.endTime);
                    
                    populateStationFilter();
                    renderParticipantTable();
                } else {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Program dengan kunci "${programKey}" tidak ditemui.</p>`;
                }
            }, (error) => {
                console.error("Error fetching program: ", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Gagal memuatkan data program.</p>`;
            });
        }
        
        function formatTimeMalay(timeString) {
            if (!timeString) return '';
            const [hourStr, minuteStr] = timeString.split(':');
            let hour = parseInt(hourStr, 10);
            let period;
            if (hour === 0) { period = 'tengah malam'; hour = 12; }
            else if (hour < 12) { period = 'pagi'; }
            else if (hour === 12) { period = 'tengah hari'; }
            else { period = 'petang'; hour -= 12; }
            return `${hour}:${minuteStr} ${period}`;
        }
        function formatTimeRange(start, end) { return `${formatTimeMalay(start)} - ${formatTimeMalay(end)}`; }

        function maskIc(ic) {
            if (!ic || ic.length < 8) return ic;
            return `${ic.substring(0, 4)}******${ic.substring(ic.length - 4)}`;
        }

        function populateStationFilter() {
            const stationFilter = document.getElementById('station-filter');
            const stations = [...new Set(allParticipants.map(p => p.station.toUpperCase()))];
            stationFilter.innerHTML = '<option value="">Semua Stesyen Kerja</option>';
            stations.sort().forEach(station => {
                const option = document.createElement('option');
                option.value = station;
                option.textContent = station;
                stationFilter.appendChild(option);
            });
        }

        function getFilteredAndSortedParticipants() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const stationFilter = document.getElementById('station-filter').value;
            
            let filtered = [...allParticipants];

            if (searchTerm) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            if (stationFilter) {
                filtered = filtered.filter(p => p.station.toUpperCase() === stationFilter);
            }

            return filtered.sort((a, b) => {
                const aIsPpd = (a.station || '').toUpperCase().trim() === 'PPD MIRI';
                const bIsPpd = (b.station || '').toUpperCase().trim() === 'PPD MIRI';

                if (aIsPpd && !bIsPpd) return -1;
                if (!aIsPpd && bIsPpd) return 1;

                const stationCompare = (a.station || '').localeCompare(b.station || '');
                if (stationCompare !== 0) return stationCompare;
                return a.name.localeCompare(b.name);
            });
        }

        function renderParticipantTable() {
            const listBody = document.getElementById('participant-list-body');
            const finalParticipants = getFilteredAndSortedParticipants();
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = finalParticipants.slice(startIndex, startIndex + itemsPerPage);

            if (paginatedItems.length === 0) {
                listBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Tiada peserta ditemui.</td></tr>`;
            } else {
                listBody.innerHTML = paginatedItems.map((p, index) => {
                    const role = p.role || 'Peserta';
                    // Check if eligible for Appreciation Certificate
                    const isAppreciationEligible = ['Penceramah', 'Fasilitator', 'Urusetia'].includes(role);

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${startIndex + index + 1}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900 truncate max-w-xs" title="${p.name}">${p.name}</div>
                            <div class="text-sm text-gray-700 truncate max-w-xs" title="${p.position}">${p.position.toUpperCase()}</div>
                            <div class="text-xs text-gray-500 truncate max-w-xs" title="${p.station}">${p.station.toUpperCase()}</div>
                             ${isAppreciationEligible ? `
                                <button onclick="downloadSingleAppreciation('${p.ic}')" class="mt-2 flex items-center gap-1 text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200 hover:bg-amber-100 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                    SIJIL
                                </button>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${maskIc(p.ic)}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex w-full items-center justify-center">
                                <div class="inline-flex items-center bg-gray-200 rounded-lg p-1 space-x-1">
                                    <button title="Peserta" onclick="updateParticipantRole('${p.ic}', 'Peserta')" class="btn rounded-md px-2 py-1 text-xs font-semibold transition-colors duration-200 ${role === 'Peserta' ? 'bg-white text-indigo-700 shadow' : 'bg-transparent text-gray-600 hover:bg-gray-300'}">Peserta</button>
                                    <button title="Fasilitator" onclick="updateParticipantRole('${p.ic}', 'Fasilitator')" class="btn rounded-md px-2 py-1 text-xs font-semibold transition-colors duration-200 ${role === 'Fasilitator' ? 'bg-white text-indigo-700 shadow' : 'bg-transparent text-gray-600 hover:bg-gray-300'}">Fasi</button>
                                    <button title="Urusetia" onclick="updateParticipantRole('${p.ic}', 'Urusetia')" class="btn rounded-md px-2 py-1 text-xs font-semibold transition-colors duration-200 ${role === 'Urusetia' ? 'bg-white text-indigo-700 shadow' : 'bg-transparent text-gray-600 hover:bg-gray-300'}">Urusetia</button>
                                    <button title="Penceramah" onclick="updateParticipantRole('${p.ic}', 'Penceramah')" class="btn rounded-md px-2 py-1 text-xs font-semibold transition-colors duration-200 ${role === 'Penceramah' ? 'bg-white text-indigo-700 shadow' : 'bg-transparent text-gray-600 hover:bg-gray-300'}">Penceramah</button>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="promptDeleteParticipant('${p.ic}', '${p.name}')" class="text-gray-400 hover:text-red-600 p-2 rounded-full" title="Padam Peserta">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `}).join('');
            }
            renderPaginationControls(finalParticipants.length);
        }

        function renderPaginationControls(totalItems) {
            const paginationControls = document.getElementById('pagination-controls');
            if (totalItems <= itemsPerPage && currentPage === 1) {
                paginationControls.innerHTML = '';
                return;
            }
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            paginationControls.innerHTML = `
                <span class="text-sm text-gray-700">
                    Memaparkan <span class="font-medium">${Math.min(totalItems, (currentPage - 1) * itemsPerPage + 1)}</span> hingga <span class="font-medium">${Math.min(currentPage * itemsPerPage, totalItems)}</span> dari <span class="font-medium">${totalItems}</span> keputusan
                </span>
                <div class="flex gap-2">
                    <button onclick="prevPage()" class="btn bg-white text-gray-700 border border-gray-300 text-sm py-1.5 px-3 rounded-lg" ${currentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                    <button onclick="nextPage()" class="btn bg-white text-gray-700 border border-gray-300 text-sm py-1.5 px-3 rounded-lg" ${currentPage === totalPages || totalItems === 0 ? 'disabled' : ''}>Seterusnya</button>
                </div>
            `;
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('items-per-page').value, 10);
            currentPage = 1;
            renderParticipantTable();
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderParticipantTable(); } }
        function nextPage() { 
            const totalItems = getFilteredAndSortedParticipants().length;
            if (currentPage < Math.ceil(totalItems / itemsPerPage)) { currentPage++; renderParticipantTable(); }
        }

        async function updateParticipantRole(participantIc, newRole) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            const updatedAttendance = allParticipants.map(p => {
                if (p.ic === participantIc) {
                    return { ...p, role: newRole };
                }
                return p;
            });

            try {
                await updateDoc(programRef, { attendance: updatedAttendance });
            } catch (error) {
                console.error("Error updating role: ", error);
                alert("Gagal mengemaskini peranan.");
            }
        }
        
        function exportToExcel() {
            const participants = getFilteredAndSortedParticipants();
            if (participants.length === 0) return alert('Tiada data untuk dieksport.');

            const dataToExport = participants.map((p, index) => ({
                'Bil.': index + 1,
                'Nama': p.name,
                'No. IC': `'${p.ic}`,
                'Jawatan': p.position,
                'Stesyen Kerja': p.station,
                'Peranan': p.role || 'Peserta'
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Senarai Peserta");
            XLSX.writeFile(workbook, `Senarai Peserta - ${currentProgram.name}.xlsx`);
        }

        function exportToSplkpm() {
            const participants = getFilteredAndSortedParticipants();
            if (participants.length === 0) return alert('Tiada data untuk dieksport.');

            const getStatusCode = (role) => {
                switch (role) {
                    case 'Penceramah': return 1;
                    case 'Fasilitator': return 2;
                    case 'Urusetia': return 3;
                    case 'Peserta': 
                    default:
                        return 8;
                }
            };

            const dataToExport = participants.map(p => ({
                kputama: p.ic,
                status: getStatusCode(p.role)
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dataToExport, { header: ["kputama", "status"], skipHeader: false });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "SPLG-KPM");
            XLSX.writeFile(workbook, `SPLG-KPM - ${currentProgram.name}.xlsx`);
        }

        async function exportToPdf() {
            const participants = getFilteredAndSortedParticipants();
            if (participants.length === 0) return alert('Tiada data untuk dieksport.');

            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();

            try {
                const logoUrl = 'https://i.imgur.com/bPfJlFR.png';
                const response = await fetch(logoUrl);
                const blob = await response.blob();
                const logoBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
                pdfDoc.addImage(logoBase64, 'PNG', 14, 15, 25, 25);
            } catch (error) {
                console.error("Gagal memuatkan logo:", error);
            }

            const textStartX = 45;
            let currentY = 20;

            pdfDoc.setFontSize(16);
            pdfDoc.setFont(undefined, 'bold');
            const programNameLines = pdfDoc.splitTextToSize(currentProgram.name.toUpperCase(), 150);
            pdfDoc.text(programNameLines, textStartX, currentY);
            currentY += (programNameLines.length * 6) + 5;

            pdfDoc.setFontSize(9);
            
            const locationLabel = 'LOKASI:';
            const locationValue = currentProgram.location.toUpperCase();
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(locationLabel, textStartX, currentY);
            pdfDoc.setFont(undefined, 'normal');
            pdfDoc.text(locationValue, textStartX + pdfDoc.getTextWidth(locationLabel) + 2, currentY);
            currentY += 6;

            const dateStr = new Date(currentProgram.startDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
            const timeStr = formatTimeRange(currentProgram.startTime, currentProgram.endTime).toUpperCase();
            const dateTimeLabel = 'TARIKH & MASA:';
            const dateTimeValue = `${dateStr} | ${timeStr}`;
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(dateTimeLabel, textStartX, currentY);
            pdfDoc.setFont(undefined, 'normal');
            pdfDoc.text(dateTimeValue, textStartX + pdfDoc.getTextWidth(dateTimeLabel) + 2, currentY);
            currentY += 15;

            const tableColumn = ["BIL.", "NAMA PESERTA", "JAWATAN", "STESEN BERTUGAS", "PERANAN"];
            const tableRows = participants.map((p, index) => [
                index + 1,
                (p.name || '').toUpperCase(),
                (p.position || '').toUpperCase(),
                (p.station || '').toUpperCase(),
                (p.role || 'PESERTA').toUpperCase()
            ]);

            pdfDoc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: currentY,
                theme: 'striped',
                headStyles: {
                    fillColor: [22, 78, 99],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 10 },
                    1: { cellWidth: 50 },
                    2: { cellWidth: 40 },
                },
                didDrawPage: function(data) {
                    const pageCount = pdfDoc.internal.getNumberOfPages();
                    pdfDoc.setFontSize(8);
                    const footerText = `SENARAI KEHADIRAN DIJANA OLEH SPARK | MUKA SURAT ${pdfDoc.internal.getCurrentPageInfo().pageNumber} DARI ${pageCount}`;
                    pdfDoc.text(footerText, data.settings.margin.left, pdfDoc.internal.pageSize.height - 10);
                }
            });

            pdfDoc.save(`Senarai Kehadiran - ${currentProgram.name}.pdf`);
        }
        
        function showLateAttendanceModal() {
            if (!currentProgram.penyelaras_ic) {
                alert("Maklumat penyelaras tidak ditemui untuk pengesahan.");
                return;
            }
            const confirmation = prompt("Sila sahkan 4 digit terakhir No. IC penyelaras untuk meneruskan.");
            if (confirmation !== currentProgram.penyelaras_ic.slice(-4)) {
                alert("Pengesahan gagal.");
                return;
            }
            resetLateModal();
            document.getElementById('late-attendance-modal').classList.remove('hidden');
        }

        async function findLateParticipant() {
            const ic = document.getElementById('late-ic-input').value.trim().replace(/[^0-9]/g, '');
            if (ic.length !== 12) { return alert("Sila masukkan No. IC yang sah."); }
            if (allParticipants.find(p => p.ic === ic)) { return alert("Peserta ini telah ada dalam senarai kehadiran."); }

            const q = query(collection(db, `artifacts/${appId}/public/data/spark_participants`), where("ic", "==", ic));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const participant = {id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data()};
                if (confirm(`Tambah ${participant.name} ke senarai kehadiran?`)) {
                    addParticipantToAttendance(participant, 'Daftar Lewat');
                    alert("Kehadiran lewat berjaya ditambah.");
                    closeModal('late-attendance-modal');
                }
            } else {
                document.getElementById('late-ic-entry').classList.add('hidden');
                document.getElementById('new-late-ic').value = ic;
                document.getElementById('new-late-participant-form').classList.remove('hidden');
            }
        }

        async function registerLateParticipant(event) {
            event.preventDefault();
            const newParticipant = {
                ic: document.getElementById('new-late-ic').value,
                name: document.getElementById('new-late-name').value.toUpperCase(),
                station: document.getElementById('new-late-station').value.toUpperCase(),
                position: document.getElementById('new-late-position').value.toUpperCase()
            };
            const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/spark_participants`), newParticipant);
            addParticipantToAttendance({ id: docRef.id, ...newParticipant }, 'Daftar Lewat');
            alert("Peserta baru berjaya didaftar dan kehadiran lewat telah ditambah.");
            closeModal('late-attendance-modal');
        }

        async function addParticipantToAttendance(participantData, status) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            const newAttendanceRecord = { ...participantData, time: new Date().toISOString(), status: status };
            try {
                await updateDoc(programRef, {
                    attendance: arrayUnion(newAttendanceRecord)
                });
            } catch(error) {
                console.error("Error adding late attendance: ", error);
                alert("Gagal menambah kehadiran lewat.");
            }
        }
        
        function promptDeleteParticipant(participantIc, participantName) {
            if (!currentProgram || !currentProgram.penyelaras_ic) {
                return alert("Ralat: Maklumat penyelaras tidak ditemui untuk pengesahan.");
            }

            const confirmation = prompt(`Untuk memadam ${participantName}, sila sahkan 4 digit terakhir No. IC penyelaras.`);
            
            if (confirmation === null) return; // User cancelled prompt

            if (confirmation !== currentProgram.penyelaras_ic.slice(-4)) {
                return alert("Pengesahan gagal. Tindakan dibatalkan.");
            }

            if (confirm(`Anda pasti ingin memadam ${participantName} daripada senarai ini? Tindakan ini tidak boleh diubah.`)) {
                deleteParticipant(participantIc);
            }
        }

        async function deleteParticipant(participantIc) {
            const programRef = doc(db, `artifacts/${appId}/public/data/spark_programs`, currentProgram.id);
            const updatedAttendance = allParticipants.filter(p => p.ic !== participantIc);

            try {
                await updateDoc(programRef, { attendance: updatedAttendance });
                alert("Peserta telah berjaya dipadam.");
            } catch (error) {
                console.error("Error deleting participant: ", error);
                alert("Gagal memadam peserta.");
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function resetLateModal() {
            document.getElementById('late-ic-entry').classList.remove('hidden');
            document.getElementById('new-late-participant-form').classList.add('hidden');
            document.getElementById('new-late-participant-form').reset();
            document.getElementById('late-ic-input').value = '';
        }

        // --- FUNGSI SEMAKAN KEHADIRAN (TELAH DIUBAHSUAI) ---

        let comparisonReviewState = {};

        function showCompareModal() {
            document.getElementById('compare-input').value = '';
            document.getElementById('compare-output').value = '';
            document.getElementById('copy-results-btn').classList.add('hidden');
            document.querySelector('input[name="compare-by"][value="name"]').checked = true;
            
            // Reset UI to initial state
            document.getElementById('compare-review-area').innerHTML = '';
            document.getElementById('start-comparison-btn').classList.remove('hidden');
            document.getElementById('finish-review-btn').classList.add('hidden');
            document.getElementById('compare-data-modal').classList.remove('hidden');
        }

        function calculateSimilarity(str1, str2) {
            const normalize = s => s.toLowerCase()
                                    .replace(/\b(bin|binti|bte|anak lelaki|a\/l|anak perempuan|a\/p)\b/g, '')
                                    .replace(/[^a-z0-9\s]/g, '')
                                    .replace(/\s+/g, ' ').trim();
            const s1 = normalize(str1);
            const s2 = normalize(str2);
            if (s1 === s2) return 1.0;
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            const longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            const distance = (longer.split('').filter((char, i) => char !== shorter.charAt(i))).length + Math.abs(longer.length - shorter.length);
            const levenshtein = (str1 = '', str2 = '') => {
                const track = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));
                for (let i = 0; i <= str1.length; i += 1) { track[0][i] = i; }
                for (let j = 0; j <= str2.length; j += 1) { track[j][0] = j; }
                for (let j = 1; j <= str2.length; j += 1) {
                    for (let i = 1; i <= str1.length; i += 1) {
                        const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                        track[j][i] = Math.min(
                            track[j][i - 1] + 1,
                            track[j - 1][i] + 1,
                            track[j - 1][i - 1] + indicator,
                        );
                    }
                }
                return track[str2.length][str1.length];
            };
            return (longerLength - levenshtein(s1, s2)) / parseFloat(longerLength);
        }

        function performComparison() {
            const pastedData = document.getElementById('compare-input').value.trim();
            if (!pastedData) {
                alert('Sila tampal data dari Excel untuk disemak.');
                return;
            }

            const compareBy = document.querySelector('input[name="compare-by"]:checked').value;
            const pastedRows = pastedData.split('\n').filter(row => row.trim() !== '');

            if (compareBy === 'station') {
                 const absentees = [];
                 const presentStations = new Set(allParticipants.map(p => p.station.trim().toUpperCase()));
                 pastedRows.forEach(row => {
                     if (row.trim() === '') return;
                     const columns = row.split('\t');
                     if (columns.length > 1) {
                         const stationName = columns[1].trim();
                         if (stationName && !presentStations.has(stationName.toUpperCase())) {
                             absentees.push(row);
                         }
                     }
                 });
                 const outputTextarea = document.getElementById('compare-output');
                 const copyBtn = document.getElementById('copy-results-btn');
                 if (absentees.length > 0) {
                    outputTextarea.value = absentees.join('\n');
                    copyBtn.classList.remove('hidden');
                 } else {
                    outputTextarea.value = 'Hebat! Semua stesyen dari senarai anda didapati telah hadir.';
                    copyBtn.classList.add('hidden');
                 }
                 return;
            }
            
            // Logic for name comparison
            const definiteMatchThreshold = 0.95;
            const potentialMatchThreshold = 0.70;
            const availableAttendees = [...allParticipants];
            
            comparisonReviewState = {
                pastedList: pastedRows.map(row => ({ raw: row, name: row.split('\t')[0].trim() })),
                reviewItems: [],
                absentees: [],
            };

            const remainingPasted = [];
            comparisonReviewState.pastedList.forEach(pastedItem => {
                let bestMatchIndex = -1, bestScore = -1;
                availableAttendees.forEach((attendee, index) => {
                    const score = calculateSimilarity(pastedItem.name, attendee.name);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatchIndex = index;
                    }
                });

                if (bestScore >= definiteMatchThreshold && bestMatchIndex > -1) {
                    availableAttendees.splice(bestMatchIndex, 1);
                } else {
                    remainingPasted.push(pastedItem);
                }
            });

            remainingPasted.forEach(pastedItem => {
                let bestMatch = null, bestScore = -1;
                availableAttendees.forEach(attendee => {
                    const score = calculateSimilarity(pastedItem.name, attendee.name);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = attendee;
                    }
                });

                if (bestScore >= potentialMatchThreshold) {
                    comparisonReviewState.reviewItems.push({
                        pasted: pastedItem,
                        potential: bestMatch,
                        score: bestScore,
                        id: `review-${Math.random().toString(36).substr(2, 9)}`
                    });
                } else {
                    comparisonReviewState.absentees.push(pastedItem.raw);
                }
            });

            displayReviewUI();
        }

        function displayReviewUI() {
            const reviewArea = document.getElementById('compare-review-area');
            const startBtn = document.getElementById('start-comparison-btn');
            const finishBtn = document.getElementById('finish-review-btn');
            
            startBtn.classList.add('hidden');
            document.getElementById('compare-output').value = '';
            
            if (comparisonReviewState.reviewItems.length > 0) {
                reviewArea.innerHTML = `<h4 class="text-md font-semibold text-gray-800 mb-2">Sahkan Padanan Berikut:</h4>
                <p class="text-xs text-gray-500 mb-3">Sistem mendapati nama berikut mempunyai persamaan. Sila sahkan sama ada mereka adalah orang yang sama.</p>
                <div class="space-y-3 max-h-60 overflow-y-auto p-2 border rounded-md bg-gray-50">
                    ${comparisonReviewState.reviewItems.map(item => `
                        <div id="${item.id}" class="p-3 border rounded-lg bg-white shadow-sm transition-all duration-300">
                            <div class="grid grid-cols-2 gap-2 items-center">
                                 <div><span class="font-semibold text-sm text-gray-600">SENARAI ANDA:</span><br>${item.pasted.name}</div>
                                 <div><span class="font-semibold text-sm text-indigo-600">SENARAI HADIR:</span><br>${item.potential.name}</div>
                            </div>
                             <div class="text-center mt-3 text-xs font-medium text-gray-500">Tahap Keyakinan: ${(item.score * 100).toFixed(0)}%</div>
                            <div class="flex justify-center gap-3 mt-2">
                                <button onclick="resolveMatch('${item.id}', true)" class="btn text-xs bg-green-100 text-green-800 font-semibold py-1 px-3 rounded-lg hover:bg-green-200">Ya, Orang Sama</button>
                                <button onclick="resolveMatch('${item.id}', false)" class="btn text-xs bg-red-100 text-red-800 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Bukan Orang Sama</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
                finishBtn.classList.remove('hidden');
            } else {
                reviewArea.innerHTML = '';
                showFinalResults();
            }
        }

        function resolveMatch(itemId, isMatch) {
            const item = comparisonReviewState.reviewItems.find(i => i.id === itemId);
            if (!item) return;
            item.decision = isMatch;
            
            const itemElement = document.getElementById(itemId);
            itemElement.style.opacity = '0.5';
            itemElement.style.pointerEvents = 'none';
            if (isMatch) {
                itemElement.innerHTML += `<p class="text-center text-sm font-bold text-green-700 p-2">âœ… DISAHKAN HADIR</p>`;
            } else {
                itemElement.innerHTML += `<p class="text-center text-sm font-bold text-red-700 p-2">âŒ DITANDA TIDAK HADIR</p>`;
            }
            
            if (comparisonReviewState.reviewItems.every(i => typeof i.decision !== 'undefined')) {
                document.getElementById('finish-review-btn').click();
            }
        }

        function showFinalResults(force = false) {
            comparisonReviewState.reviewItems.forEach(item => {
                if (item.decision === false || (force && typeof item.decision === 'undefined')) {
                    if (!comparisonReviewState.absentees.includes(item.pasted.raw)) {
                         comparisonReviewState.absentees.push(item.pasted.raw);
                    }
                }
            });

            const outputTextarea = document.getElementById('compare-output');
            const copyBtn = document.getElementById('copy-results-btn');
            
            if (comparisonReviewState.absentees.length > 0) {
                outputTextarea.value = comparisonReviewState.absentees.sort().join('\n');
                copyBtn.classList.remove('hidden');
            } else {
                outputTextarea.value = 'Hebat! Semua peserta dari senarai anda didapati telah hadir.';
                copyBtn.classList.add('hidden');
            }
            
            document.getElementById('compare-review-area').innerHTML = '<p class="text-center font-semibold text-indigo-700 p-4">Semakan selesai. Sila lihat hasil di sebelah kanan.</p>';
            document.getElementById('finish-review-btn').classList.add('hidden');
        }

        function copyResults() {
            const outputTextarea = document.getElementById('compare-output');
            navigator.clipboard.writeText(outputTextarea.value).then(() => {
                alert('Senarai tidak hadir telah disalin!');
            }, (err) => {
                console.error('Gagal menyalin: ', err);
                alert('Gagal menyalin senarai.');
            });
        }

        // --- FUNGSI JANA SIJIL PENGHARGAAN (BARU & SMART) ---
        async function generateAppreciationPDF(doc, participant, isBulk = false) {
            const width = doc.internal.pageSize.getWidth();
            const height = doc.internal.pageSize.getHeight();
            const logoUrl = 'https://i.imgur.com/FQpwGDo.png';
            const courseName = currentProgram.name.toUpperCase();
            const participantName = participant.name.toUpperCase();
            const role = (participant.role || 'Peserta').toUpperCase();

            // Format Tarikh
            const startDate = new Date(currentProgram.startDate + 'T00:00:00');
            const endDate = new Date(currentProgram.endDate + 'T00:00:00');
            let dateStr;
            if (startDate.getTime() === endDate.getTime()) {
                dateStr = `PADA ${startDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            } else {
                dateStr = `PADA ${startDate.toLocaleDateString('ms-MY', { day: '2-digit' })} HINGGA ${endDate.toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}`;
            }

            // 1. Bingkai Dwi-Warna Smart (Biru & Emas) & Elemen Teknologi
            doc.setDrawColor(75, 64, 255); // Biru
            doc.setLineWidth(1.5);
            doc.rect(10, 10, width - 20, height - 20);
            doc.setDrawColor(212, 175, 55); // Emas
            doc.setLineWidth(0.5);
            doc.rect(12, 12, width - 24, height - 24);

            // Tambah elemen "litar" di bucu untuk kesan teknologi
            const cornerSize = 15;
            doc.setDrawColor(75, 64, 255); doc.setLineWidth(1);
            // Kiri Atas
            doc.line(10, 10 + cornerSize, 10 + cornerSize, 10); doc.circle(10 + cornerSize, 10, 1, 'F'); doc.circle(10, 10 + cornerSize, 1, 'F');
            // Kanan Atas
            doc.line(width - 10 - cornerSize, 10, width - 10, 10 + cornerSize); doc.circle(width - 10 - cornerSize, 10, 1, 'F'); doc.circle(width - 10, 10 + cornerSize, 1, 'F');
            // Kiri Bawah
            doc.line(10, height - 10 - cornerSize, 10 + cornerSize, height - 10); doc.circle(10 + cornerSize, height - 10, 1, 'F'); doc.circle(10, height - 10 - cornerSize, 1, 'F');
            // Kanan Bawah
            doc.line(width - 10 - cornerSize, height - 10, width - 10, height - 10 - cornerSize); doc.circle(width - 10 - cornerSize, height - 10, 1, 'F'); doc.circle(width - 10, height - 10 - cornerSize, 1, 'F');

            // 2. Logo PPD Miri (Nisbah Betul, Latar Putih Bulat, Tidak Gepet)
            try {
                doc.setFillColor(255, 255, 255); 
                doc.circle(width / 2, 35, 18, 'F'); // Latar belakang logo putih bulat
                doc.addImage(logoUrl, 'PNG', (width / 2) - 15, 20, 30, 30); // Saiz 30x30 (persegi) kekalkan aspek
            } catch (e) {
                doc.setFontSize(10); doc.text("PPD MIRI", width/2, 35, {align:"center"});
            }

            // 3. Tajuk Utama
            doc.setTextColor(75, 64, 255);
            doc.setFont("times", "bold");
            doc.setFontSize(35);
            doc.text("SIJIL PENGHARGAAN", width / 2, 65, { align: "center" });

            // 4. Peranan (Emas)
            doc.setTextColor(197, 157, 30);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`SEBAGAI ${role}`, width / 2, 75, { align: "center" });

            // 5. Teks Penghargaan
            doc.setTextColor(60, 60, 60);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text("Dengan tulus ikhlas merakamkan setinggi-tinggi penghargaan kepada:", width / 2, 95, { align: "center" });

            // 6. Nama Penerima
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(22);
            doc.setFont("times", "bold");
            doc.text(participantName, width / 2, 110, { align: "center" });
            
            // No IC (Tanpa perkataan 'NO. KAD PENGENALAN:')
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(participant.ic, width / 2, 120, { align: "center" });

            // 7. Deskripsi Program
            doc.setFontSize(13);
            const desc = "Atas sumbangan bakti, kepakaran dan komitmen yang telah diberikan bagi menjayakan program:";
            doc.text(doc.splitTextToSize(desc, 150), width / 2, 140, { align: "center" });

            doc.setFont("helvetica", "bolditalic");
            doc.setFontSize(16);
            doc.text(doc.splitTextToSize(`"${courseName}"`, 160), width / 2, 155, { align: "center" });

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text(dateStr, width / 2, 175, { align: "center" });

            // 8. Tandatangan (3 Baris Smart & Ruang Kosong)
            const sigY = 225;
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line((width / 2) - 40, sigY, (width / 2) + 40, sigY); // Garisan kosong untuk tandatangan

            doc.setTextColor(0);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("MARIAM HAJI MONEK", width / 2, sigY + 10, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Pegawai Pendidikan Daerah,", width / 2, sigY + 16, { align: "center" });
            doc.text("Pejabat Pendidikan Daerah Miri.", width / 2, sigY + 22, { align: "center" });

            // 9. Footer No Siri
            doc.setFontSize(8);
            doc.setTextColor(150);
            const serial = `NO SIRI: SPK-H/${currentProgram.id.substring(0,4)}/${participant.ic.slice(-4)} | DIJANA OLEH SPARK`;
            doc.text(serial, width / 2, height - 15, { align: "center" });

            if (!isBulk) {
                doc.save(`Sijil_Penghargaan_${participantName}.pdf`);
            }
        }

        window.downloadSingleAppreciation = function(ic) {
            const p = allParticipants.find(item => item.ic === ic);
            if (!p) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            generateAppreciationPDF(doc, p);
        };

        window.downloadAllAppreciationCertificates = async function() {
            const eligible = allParticipants.filter(p => ['Penceramah', 'Fasilitator', 'Urusetia'].includes(p.role));
            if (eligible.length === 0) return alert("Tiada Fasilitator, Urusetia atau Penceramah untuk dijana.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            for (let i = 0; i < eligible.length; i++) {
                if (i > 0) doc.addPage();
                await generateAppreciationPDF(doc, eligible[i], true);
            }
            doc.save(`Sijil_Penghargaan_Pukal_${currentProgram.name}.pdf`);
        };

        Object.assign(window, { 
            updateParticipantRole, 
            exportToExcel, 
            exportToPdf, 
            exportToSplkpm,
            showLateAttendanceModal, 
            closeModal, 
            findLateParticipant,
            registerLateParticipant,
            resetLateModal,
            changeItemsPerPage,
            prevPage,
            nextPage,
            promptDeleteParticipant,
            showCompareModal,
            performComparison,
            resolveMatch,
            showFinalResults,
            copyResults,
            downloadSingleAppreciation,         // Added
            downloadAllAppreciationCertificates // Added
        });
    </script>
</body>
</html>
