<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK â€“ PDCA Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .nav-tabs-container {
            background-color: #f3f4f6;
            padding: 0.35rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .tabs-wrapper {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            flex: 1;
        }

        .nav-tab {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            color: #6b7280;
        }

        .nav-tab:hover {
            background-color: rgba(255, 255, 255, 0.6);
            color: #374151;
        }

        /* PDCA Tab Active Styles */
        .nav-tab.active-plan { background-color: #14b8a6; color: white; shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4); }
        .nav-tab.active-check { background-color: #f59e0b; color: white; shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.4); }
        .nav-tab.active-do { background-color: #6366f1; color: white; shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4); }

        @keyframes loadProgress { 0% { width: 0; } }
        .progress-bar-fill { animation: loadProgress 1.5s ease-out forwards; }
        
        #mention-dropdown::-webkit-scrollbar { width: 6px; }
        #mention-dropdown::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .profile-pic-container:hover .profile-overlay { opacity: 1; }
        .profile-overlay { transition: opacity 0.3s ease; }

        .img-container {
            max-height: 50vh;
            min-height: 250px;
            background-color: #000;
            overflow: hidden; 
            border-radius: 0.5rem;
        }
        .img-container img {
            max-width: 100%;
            display: block; 
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div class="flex items-center gap-3 self-start sm:self-center">
                <div class="bg-indigo-600 p-2 rounded-lg logo-pulse"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white"><path d="M4 4H8V8H4V4Z" fill="currentColor"></path><path d="M4 16H8V20H4V16Z" fill="currentColor"></path><path d="M16 4H20V8H16V4Z" fill="currentColor"></path><path d="M10 4H14V6H10V4Z" fill="currentColor"></path><path d="M10 8H12V10H10V8Z" fill="currentColor"></path><path d="M12 12H14V14H12V12Z" fill="currentColor"></path><path d="M10 16H12V18H10V16Z" fill="currentColor"></path><path d="M14 16H16V18H14V16Z" fill="currentColor"></path><path d="M16 12H18V14H16V12Z" fill="currentColor"></path><path d="M16 8H20V10H16V8Z" fill="currentColor"></path><path d="M12 18H14V20H12V18Z" fill="currentColor"></path><path d="M4 10H6V14H4V10Z" fill="currentColor"></path></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">SPARK</h1>
                    <p class="text-sm text-gray-500 uppercase font-bold tracking-tighter">Sistem Pengurusan Aktiviti & Rekod Kehadiran</p>
                </div>
            </div>
            <div id="header-buttons" class="flex w-full sm:w-auto justify-center sm:justify-end items-center gap-2 sm:gap-4 flex-wrap">
                <button onclick="logout()" class="group flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-gray-200 text-red-600 text-xs font-bold uppercase tracking-wider shadow-sm hover:bg-red-50 hover:border-red-200 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Log Keluar
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full bg-gray-50">
        
        <div id="dynamic-header-bg" class="relative w-full h-[260px] bg-gradient-to-br from-indigo-900 to-purple-800">
            <div class="absolute inset-0 bg-black/20"></div>
        </div>

        <div class="relative z-10 px-4 sm:px-6 lg:px-8 -mt-20">
            <div class="max-w-4xl mx-auto">
                <div class="glass-card p-6 md:p-10 rounded-2xl shadow-2xl relative mt-4">
                    
                    <button onclick="window.location.href='sponsor.html'" id="account-status-badge" class="absolute -top-5 right-6 md:right-10 z-30 group px-3 py-2 pr-4 rounded-full bg-white/90 backdrop-blur-xl border border-gray-100 shadow-md flex items-center gap-3 transition-all transform hover:scale-105">
                        <div class="bg-gray-100 p-2 rounded-full group-hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wider leading-none mb-0.5">Status Akaun</p>
                            <div id="badge-text-label" class="flex items-center text-xs font-bold text-gray-800 tracking-wide">Akaun Biasa</div>
                        </div>
                    </button>

                    <a id="edit-profile-btn" href="edit.html" class="absolute top-4 left-4 md:top-6 md:left-6 btn bg-gray-100 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 p-2 rounded-full transition-colors shadow-sm z-20" title="Kemaskini Profil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </a>

                    <div class="flex flex-col md:flex-row items-center gap-6 mt-4 md:mt-0">
                        <div class="flex flex-col items-center justify-center shrink-0">
                            <div class="relative profile-pic-container group cursor-pointer mx-auto md:mx-0" onclick="triggerProfileUpload()">
                                <div id="default-profile-icon" class="bg-indigo-100 p-4 rounded-full border-4 border-white shadow-lg w-28 h-28 flex items-center justify-center transition-transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <img id="user-profile-image" src="" class="hidden w-28 h-28 rounded-full border-4 border-white shadow-lg object-cover bg-gray-200 transition-transform hover:scale-105" alt="Profile Picture">
                                <div class="profile-overlay absolute inset-0 bg-black/40 rounded-full flex flex-col items-center justify-center opacity-0 transition-opacity z-10">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /></svg>
                                    <span class="text-[8px] text-white font-bold uppercase mt-1">Tukar</span>
                                </div>
                                <input type="file" id="profile-upload-input" class="hidden" accept="image/*" onchange="handleProfileImageUpload(this)">
                            </div>
                        </div>

                        <div class="text-center md:text-left flex-grow w-full">
                            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight mb-1" id="user-name">Memuatkan...</h2>
                            <div class="flex flex-col md:flex-row gap-2 md:gap-4 text-gray-600 text-sm font-medium justify-center md:justify-start">
                                <span class="flex items-center gap-1 justify-center md:justify-start"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0c0 .884-.5 1.5-1.5 1.5S8 7 8 6m4 0c0 .884.5 1.5 1.5 1.5S15 7 15 6"></path></svg> <span id="user-ic">-</span></span>
                                <span class="hidden md:inline">|</span>
                                <span class="flex items-center gap-1 justify-center md:justify-start"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> <span id="user-org">-</span></span>
                            </div>
                            <p id="user-sector-unit" class="text-xs text-indigo-600 font-bold mt-2 uppercase hidden flex items-center justify-center md:justify-start gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" /></svg>
                                <span id="sector-text"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <div class="lg:col-span-3 space-y-6">

                    <div class="flex flex-wrap items-center justify-start gap-3 mb-4 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="w-full mb-1"><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Aliran Kerja PDCA</p></div>
                        
                        <button onclick="window.location.href='jadualuser.html'" class="btn bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 text-xs font-bold py-2.5 px-4 rounded-xl shadow-sm flex items-center gap-2 uppercase">
                            <span class="bg-teal-600 text-white px-1.5 py-0.5 rounded text-[8px]">PLAN</span>
                            Kalendar Rasmi
                        </button>

                        <button onclick="goToMemo()" class="btn bg-indigo-50 border border-indigo-200 text-indigo-700 hover:bg-indigo-100 text-xs font-bold py-2.5 px-4 rounded-xl shadow-sm flex items-center gap-2 uppercase">
                            <span class="bg-indigo-600 text-white px-1.5 py-0.5 rounded text-[8px]">DO</span>
                            Memo Dalaman
                        </button>

                        <button onclick="goToSijil()" class="btn bg-amber-50 border border-amber-200 text-amber-700 hover:bg-amber-100 text-xs font-bold py-2.5 px-4 rounded-xl shadow-sm flex items-center gap-2 uppercase">
                            <span class="bg-amber-500 text-white px-1.5 py-0.5 rounded text-[8px]">CHECK</span>
                            Sijil & Penghargaan
                        </button>

                        <button onclick="goToOPR()" class="btn bg-rose-50 border border-rose-200 text-rose-700 hover:bg-rose-100 text-xs font-bold py-2.5 px-4 rounded-xl shadow-sm flex items-center gap-2 uppercase">
                            <span class="bg-rose-600 text-white px-1.5 py-0.5 rounded text-[8px]">ACT</span>
                            One Page Report
                        </button>
                    </div>

                    <div class="nav-tabs-container mb-6">
                        <div class="tabs-wrapper">
                            <button id="tab-planner" onclick="switchTab('planner')" class="nav-tab active-plan relative">
                                <span class="text-[9px] font-black opacity-50 mr-1">P</span>
                                AKTIVITI SAYA
                                <span id="planner-badge" class="absolute top-1.5 right-1.5 flex h-2.5 w-2.5 hidden">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                                </span>
                            </button>

                            <button id="tab-created" onclick="switchTab('created')" class="nav-tab">
                                <span class="text-[9px] font-black opacity-50 mr-1">D</span>
                                Program Saya
                            </button>

                            <button id="tab-attendance" onclick="switchTab('attendance')" class="nav-tab">
                                <span class="text-[9px] font-black opacity-50 mr-1">C</span>
                                Kehadiran
                            </button>
                            
                            <button id="tab-tasks" onclick="switchTab('tasks')" class="nav-tab">
                                <span class="text-[9px] font-black opacity-50 mr-1">A</span>
                                SparkTask
                            </button>
                        </div>
                    </div>

                    <div id="view-table" class="hidden">
                        <div class="card p-5 border border-gray-100 bg-white mb-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 uppercase" id="table-title">SENARAI KEHADIRAN</h3>
                                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                    <div class="relative">
                                        <select id="rows-per-page" onchange="changeRowsPerPage(this.value)" class="appearance-none pl-3 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full text-sm bg-white cursor-pointer uppercase">
                                            <option value="5" selected>5 PAPARAN</option>
                                            <option value="10">10 PAPARAN</option>
                                            <option value="30">30 PAPARAN</option>
                                        </select>
                                    </div>
                                    <div class="relative w-full sm:w-64">
                                        <input type="text" id="search-input" oninput="filterTable()" placeholder="CARI PROGRAM..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full text-sm uppercase">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card overflow-hidden shadow-lg border border-gray-100">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50" id="table-head"></thead>
                                    <tbody id="programs-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <div id="no-data-message" class="hidden text-center py-10 uppercase text-gray-500">Tiada rekod ditemui.</div>
                            <div id="pagination-controls" class="px-6 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                                <div class="text-xs text-gray-500 uppercase" id="pagination-info">Menunjukkan 0 hingga 0 daripada 0 rekod</div>
                                <div class="flex gap-2">
                                    <button onclick="prevPage()" id="btn-prev" class="px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 uppercase disabled:opacity-50">Sebelumnya</button>
                                    <button onclick="nextPage()" id="btn-next" class="px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 uppercase disabled:opacity-50">Seterusnya</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-locked-task" class="hidden">
                         <div class="card p-10 text-center flex flex-col items-center justify-center min-h-[300px] border border-gray-100 shadow-lg">
                            <div class="bg-rose-50 p-5 rounded-full mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 uppercase mb-2">Fasa Act: Penambahbaikan</h3>
                            <p class="text-gray-500 mb-6 text-sm">Ciri SparkTask untuk tindakan susulan akan datang tidak lama lagi.</p>
                            <span class="bg-gradient-to-r from-rose-500 to-rose-700 text-white px-5 py-2 rounded-full text-xs font-bold uppercase shadow-md tracking-wider">Eksklusif SparkPro</span>
                        </div>
                    </div>

                    <div id="view-planner" class="">
                        <div class="card p-6 bg-white border border-gray-100 shadow-lg">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 uppercase flex items-center gap-2">
                                        <div class="bg-teal-600 text-white p-1 rounded shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></div>
                                        FASA PLAN: AKTIVITI SAYA <span id="planner-month-year" class="text-teal-600"></span>
                                    </h3>
                                    <p class="text-xs text-gray-500">Rancang aktiviti bulanan anda sebelum pelaksanaan (Fasa Do).</p>
                                </div>
                                <div class="flex items-center gap-2 flex-wrap w-full md:w-auto justify-end">
                                    <button onclick="jumpToToday()" class="btn bg-gray-100 text-gray-600 hover:bg-gray-200 text-xs font-bold py-2 px-3 rounded-lg shadow-sm uppercase h-10">Hari Ini</button>
                                    <div class="flex bg-gray-100 rounded-lg p-0.5 h-10 items-center">
                                        <button onclick="changePlannerMonth(-1)" class="p-2 rounded hover:bg-white shadow-sm text-gray-600 h-full flex items-center"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                        <button onclick="changePlannerMonth(1)" class="p-2 rounded hover:bg-white shadow-sm text-gray-600 h-full flex items-center"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                                    </div>
                                    <button onclick="goToPersonalCalendar()" class="btn bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 text-xs font-bold py-2 px-4 rounded-lg shadow-sm uppercase flex items-center gap-2 h-10 transition-all group">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        Kalendar
                                    </button>
                                    <button onclick="clickAddButton()" class="btn bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-md uppercase flex items-center gap-2 h-10">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v16m8-8H4" /></svg>
                                        Tambah
                                    </button>
                                </div>
                            </div>
                            <div id="planner-list-container" class="space-y-3 min-h-[300px]"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="card px-5 py-4 border border-gray-100 bg-gray-50/50 shadow-sm">
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Pencapaian</h3>
                                <div class="text-xs font-semibold text-gray-700 flex items-center gap-1">Misi Spark Pro <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>
                            </div>
                            <div id="progress-remaining" class="text-[10px] text-right text-gray-500 font-medium uppercase tracking-wide">Memuatkan...</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="sparkpro-progress-bar" class="bg-gray-400 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-indigo-700 text-white shadow-lg transform hover:scale-105 transition-all cursor-pointer relative overflow-hidden group" onclick="goToGenerateProgram()">
                        <div class="absolute right-[-20px] top-[-20px] opacity-10 group-hover:opacity-20 transition-opacity rotate-12">
                            <span class="text-8xl font-black">D</span>
                        </div>
                        <div class="flex items-center justify-between relative z-10">
                            <div>
                                <div class="bg-white/20 inline-block px-2 py-0.5 rounded text-[8px] font-bold mb-2 uppercase">Fasa Do (Laksana)</div>
                                <h3 class="text-xl font-extrabold uppercase tracking-wide">Jana Program</h3>
                                <p class="text-xs text-indigo-100 mt-1">Cipta rekod kehadiran rasmi</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-full shadow-inner">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 bg-white border-l-4 border-indigo-600 shadow-lg transform hover:scale-105 transition-all cursor-pointer relative overflow-hidden group" onclick="window.location.href='qr.html'">
                        <div class="flex items-center justify-between relative z-10">
                            <div>
                                <div class="bg-indigo-50 text-indigo-600 inline-block px-2 py-0.5 rounded text-[8px] font-bold mb-2 uppercase border border-indigo-100">Fasa Do (Laksana)</div>
                                <h3 class="text-xl font-extrabold uppercase tracking-wide text-gray-800">myQR Hadir</h3>
                                <p class="text-xs text-gray-500 mt-1 font-medium">Imbas kehadiran peserta</p>
                            </div>
                            <div class="bg-indigo-600 p-3 rounded-xl shadow-lg border border-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zm-6 0H6.414a1 1 0 00-.707.293L4.293 16.707A1 1 0 004 17.414V20h4v-2.586a1 1 0 00-.293-.707L6 15.414V14t1 1h2m4-9V4m0 0H8m4 0h4m-4 1v1m0 0h4m-4 0v2m0-2H8m0 0v2a1 1 0 01-1 1H6a1 1 0 01-1-1V5a1 1 0 011-1h1a1 1 0 011 1v1m0 0h2m2 0h2M5 12h14" /></svg>
                            </div>
                        </div>
                    </div>

                    <div class="card border border-gray-200 bg-white overflow-hidden">
                        <button onclick="toggleQuickMenu()" class="w-full flex items-center justify-between p-5 bg-gray-50 hover:bg-gray-100 transition-colors">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Menu Pantas</h3>
                            <svg id="menu-arrow" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="quick-menu-content" class="hidden px-5 pb-5 pt-2 space-y-3 border-t border-gray-200">
                            <a href="jadual.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-teal-50 border border-gray-100">
                                <div class="bg-teal-100 text-teal-600 p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" /></svg></div>
                                <div><p class="text-sm font-semibold text-gray-700 uppercase">Takwim Utama</p></div>
                            </a>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // ... Initialization Firebase (Kekal Sama) ...
        
        // Custom Tab PDCA Switching
        window.switchTab = function(tabName) {
            currentTab = tabName;
            currentPage = 1;
            
            const tabA = document.getElementById('tab-attendance');
            const tabC = document.getElementById('tab-created');
            const tabTasks = document.getElementById('tab-tasks');
            const tabP = document.getElementById('tab-planner');
            
            // Reset classes
            [tabA, tabC, tabTasks, tabP].forEach(t => t.className = "nav-tab relative");
            
            document.getElementById('view-table').classList.add('hidden');
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-locked-task').classList.add('hidden');

            if (tabName === 'attendance') { // Fasa Check
                tabA.className = "nav-tab active-check relative";
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "FASA CHECK: SENARAI KEHADIRAN";
                filteredResults = [...attendanceList];
                renderTableHeader(); renderTable();
            } else if (tabName === 'created') { // Fasa Do
                tabC.className = "nav-tab active-do relative";
                document.getElementById('view-table').classList.remove('hidden');
                document.getElementById('table-title').textContent = "FASA DO: PROGRAM SAYA";
                filteredResults = [...createdList];
                renderTableHeader(); renderTable();
            } else if (tabName === 'tasks') { // Fasa Act
                tabTasks.className = "nav-tab bg-rose-600 text-white relative";
                document.getElementById('view-locked-task').classList.remove('hidden');
            } else { // Fasa Plan
                tabP.className = "nav-tab active-plan relative";
                document.getElementById('view-planner').classList.remove('hidden');
                renderPlannerList(); 
            }
        }
        
        // ... Logik Selebihnya (Kekal Sama) ...

      // --- Sambungan Skrip (Logic & Modals) ---

        // Fungsi khusus untuk menukar warna Tab secara dinamik mengikut Fasa PDCA
        function updateTabStyles(activeTab) {
            const tabs = {
                'planner': document.getElementById('tab-planner'),
                'created': document.getElementById('tab-created'),
                'attendance': document.getElementById('tab-attendance'),
                'tasks': document.getElementById('tab-tasks')
            };

            // Reset semua kepada gaya asal
            Object.values(tabs).forEach(t => {
                t.className = "nav-tab relative";
            });

            // Beri warna khusus kepada tab yang aktif mengikut fasa
            if (activeTab === 'planner') tabs.planner.className = "nav-tab active-plan relative";
            if (activeTab === 'created') tabs.created.className = "nav-tab active-do relative";
            if (activeTab === 'attendance') tabs.attendance.className = "nav-tab active-check relative";
            if (activeTab === 'tasks') tabs.tasks.className = "nav-tab bg-rose-600 text-white relative";
        }

        // Override fungsi switchTab sedia ada untuk menyokong visual PDCA
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            updateTabStyles(tabName);
            
            // Panggil logik asal untuk paparan table/planner
            const viewTable = document.getElementById('view-table');
            const viewPlanner = document.getElementById('view-planner');
            const viewLockedTask = document.getElementById('view-locked-task');
            const tableTitle = document.getElementById('table-title');

            viewTable.classList.add('hidden');
            viewPlanner.classList.add('hidden');
            viewLockedTask.classList.add('hidden');

            if (tabName === 'attendance') {
                viewTable.classList.remove('hidden');
                tableTitle.textContent = "FASA CHECK: REKOD KEHADIRAN SAYA";
                filteredResults = [...attendanceList];
                renderTableHeader(); renderTable();
            } else if (tabName === 'created') {
                viewTable.classList.remove('hidden');
                tableTitle.textContent = "FASA DO: PROGRAM DIBAWAH SELIAAN SAYA";
                filteredResults = [...createdList];
                renderTableHeader(); renderTable();
            } else if (tabName === 'tasks') {
                viewLockedTask.classList.remove('hidden');
            } else {
                viewPlanner.classList.remove('hidden');
                renderPlannerList();
            }
        };

        // --- MODAL & FORM UI (Kekal Fungsi Asal) ---
      // --- DATA LOADING (Fasa Check & Do) ---
        // Fungsi ini memproses semua data yang ditarik dari Firebase
        async function processDashboardData(ic) {
            try {
                // 1. Ambil maklumat Profil (Fasa Do)
                const usersRef = collection(db, `artifacts/${appId}/public/data/spark_participants`);
                const qUser = query(usersRef, where("ic", "==", ic));
                const userSnap = await getDocs(qUser);
                
                if (!userSnap.empty) {
                    const userData = userSnap.docs[0].data();
                    participantDocId = userSnap.docs[0].id;
                    
                    // Kemaskini UI Profil
                    document.getElementById('user-name').textContent = userData.name.toUpperCase();
                    document.getElementById('user-org').textContent = (userData.station || userData.org || "-").toUpperCase();
                    
                    if (userData.sector) {
                        currentUserSector = userData.sector;
                        currentUserUnit = userData.unit || "";
                        const sectorTextEl = document.getElementById('sector-text');
                        sectorTextEl.textContent = `${currentUserSector} | ${currentUserUnit.replace("UNIT ", "")}`;
                        document.getElementById('user-sector-unit').classList.remove('hidden');
                    }
                }

                // 2. Ambil Program (Fasa Check - Kehadiran)
                const programsRef = collection(db, `artifacts/${appId}/public/data/spark_programs`);
                const progSnap = await getDocs(programsRef);
                
                attendanceList = [];
                createdList = [];
                
                progSnap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    const cleanIc = ic.replace(/[^0-9]/g, '');
                    
                    // Semak Kehadiran Saya (Check)
                    if (p.attendance && p.attendance.some(att => att.ic.replace(/[^0-9]/g, '') === cleanIc)) {
                        attendanceList.push({ programData: p });
                    }
                    
                    // Semak Program Seliaan Saya (Do)
                    if (p.createdBy === cleanIc || p.penyelaras_ic === cleanIc) {
                        createdList.push({ programData: p });
                    }
                });

                // 3. Kemaskini Indikator Pencapaian
                const totalAction = attendanceList.length + createdList.length;
                updateInfographics(totalAction);
                
                // Set tab lalai kepada PLAN
                switchTab('planner');

            } catch (error) {
                console.error("PDCA Data Error:", error);
            }
        }

        // --- RENDER TABLE (Fasa Do & Check) ---
        // Fungsi ini menghasilkan baris jadual yang responsif
        function createTableRow(result, index) {
            const { programData } = result;
            const dateStr = programData.startDate ? new Date(programData.startDate).toLocaleDateString('ms-MY') : '-';
            
            if (currentTab === 'created') {
                // Paparan Fasa DO (Penyelaras)
                return `
                    <tr class="hover:bg-indigo-50/30 transition-colors">
                        <td class="px-6 py-4 text-sm text-gray-500">${index + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-900 uppercase">${programData.name}</div>
                            <div class="text-[10px] text-indigo-600 font-bold">FASA: DO (PELAKSANAAN)</div>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-600 font-medium uppercase">${dateStr}</td>
                        <td class="px-6 py-4 text-center">
                            <a href="program.html?kod=${programData.key}" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-indigo-700 shadow-sm">Urus</a>
                        </td>
                    </tr>`;
            } else {
                // Paparan Fasa CHECK (Peserta)
                return `
                    <tr class="hover:bg-amber-50/30 transition-colors">
                        <td class="px-6 py-4 text-sm text-gray-500">${index + 1}.</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-800 uppercase">${programData.name}</div>
                            <div class="text-[10px] text-amber-600 font-bold">FASA: CHECK (KEHADIRAN)</div>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-600 font-medium uppercase">${dateStr}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded-full text-[9px] font-black">HADIR</span>
                        </td>
                    </tr>`;
            }
        }

        // --- FINAL UTILS ---
        window.goToOPR = function() {
            if (currentUserIc) window.location.href = `opr.html?ic=${currentUserIc}`;
        };

        window.goToSijil = function() {
            if (currentUserIc) window.location.href = `sijil.html?ic=${currentUserIc}`;
        };

        // Mulakan proses apabila auth sedia
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const ic = localStorage.getItem('user_ic');
                if (ic) {
                    currentUserIc = ic;
                    processDashboardData(ic);
                }
            }
        });

    </script>
</body>
</html>
