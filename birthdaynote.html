<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK - Bacaan Ucapan Hari Jadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .wish-card {
            border-left-width: 4px;
            transition: all 0.3s ease;
        }
        .wish-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-tr from-indigo-50 via-blue-50 to-purple-100 min-h-screen flex flex-col items-center pt-10 pb-20 px-4">

    <div class="w-full max-w-6xl text-center mb-10 px-4">
        <h1 class="text-2xl font-bold text-indigo-600">
            Koleksi Kad Ucapan untuk
        </h1>
        <h2 id="recipient-name-display" class="uppercase text-5xl font-bold text-gray-800 mt-1">...</h2>
    </div>

    <div id="wishes-container" class="w-full max-w-6xl">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Daripada Rakan-rakan</h2>
        <div id="wishes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <p id="loading-wishes" class="text-center text-gray-500 col-span-3">Memuatkan ucapan...</p>
        </div>
    </div>

    <div class="mt-12 text-center">
        <a href="jadual.html" class="text-base text-indigo-600 hover:underline font-medium">&laquo; Kembali ke Kalendar</a>
    </div>

    <footer class="w-full text-center mt-16 mb-8 text-gray-500 text-xs">
        <p class="font-bold text-gray-600 text-sm">SPARK</p>
        <p class="text-xs">Percikan Inovasi Kehadiran Digital</p>
        <p class="mt-2 text-xs">Projek Inovasi oleh Pahan</p>
        <p class="text-xs">Versi 2.1 (2025)</p>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi Firebase ---
        // (Sama seperti fail asal)
        const firebaseConfig = { apiKey: "AIzaSyAEBe1XF7cqaxkTNBZBoo3DBJYIuchOEkM", authDomain: "myqrhadir.firebaseapp.com", projectId: "myqrhadir", storageBucket: "myqrhadir.appspot.com", messagingSenderId: "799691133747", appId: "1:799691133747:web:835a5e3e9413eace806446" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        let dbReady = false;
        let recipientNameFromUrl = null;
        let recipientDobFromUrl = null;
        
        const wishesRef = collection(db, `artifacts/${appId}/public/data/spark_wishes`);

        // --- Pengesahan Firebase (Anonymous) ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try { await signInAnonymously(auth); } catch (error) { console.error("Gagal daftar masuk:", error); }
            }
            dbReady = true; 
            if (recipientNameFromUrl && recipientDobFromUrl) {
                loadWishes(recipientNameFromUrl, recipientDobFromUrl);
            }
        });

        // --- Logik Dapatkan Nama & DOB dari URL ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name') || 'Penerima';
            const encodedDob = params.get('dob') || '';
            let dob = '';
            
            try {
                // Terjemah balik Base64 (e.g., "MTk5MC0xMS0xMA==") ke "YYYY-MM-DD"
                dob = encodedDob ? atob(encodedDob) : ''; 
            } catch (e) {
                console.error("Gagal nyahkod DOB:", e);
            }
            
            document.getElementById('recipient-name-display').textContent = name.toUpperCase();

            recipientNameFromUrl = name;
            recipientDobFromUrl = dob;

            if (dbReady) {
                loadWishes(recipientNameFromUrl, recipientDobFromUrl);
            }
        });

        // --- Fungsi Memuatkan Ucapan ---
        // (Sama seperti fail asal)
        function loadWishes(name, dob) {
            const q = query(wishesRef, 
                            where("recipientName", "==", name), 
                            where("recipientDob", "==", dob), 
                            orderBy("sentAt", "desc"));
            const grid = document.getElementById('wishes-grid');
            const loadingMsg = document.getElementById('loading-wishes');
            const cardStyles = ["bg-white border-l-blue-400", "bg-white border-l-pink-400", "bg-white border-l-green-400", "bg-white border-l-yellow-400", "bg-white border-l-indigo-400", "bg-white border-l-purple-400"];

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    loadingMsg.textContent = "Belum ada ucapan lagi untuk penerima ini.";
                } else {
                    grid.innerHTML = '';
                    let colorIndex = 0;
                    snapshot.docs.forEach(doc => {
                        const wish = doc.data();
                        const cardStyle = cardStyles[colorIndex % cardStyles.length];
                        
                        const card = document.createElement('div');
                        card.className = `wish-card rounded-lg shadow-lg p-5 ${cardStyle} flex flex-col`;
                        
                        // Bahagian Hadiah Visual
                        if (wish.gift) {
                            const giftEl = document.createElement('div');
                            giftEl.className = "text-center mb-4 pb-4 border-b border-gray-200";
                            
                            const giftEmojis = {
                                "iPhone": "üì±", "Apple Watch": "‚åöÔ∏è", "Samsung Watch": "‚åöÔ∏è",
                                "Percutian": "‚úàÔ∏è", "Kopi Setahun": "‚òïÔ∏è", "Makan Malam Mewah": "üçΩÔ∏è",
                                "Tiket Konsert": "üéüÔ∏è", "Baucar Beli-belah": "üõçÔ∏è"
                            };
                            
                            const emoji = giftEmojis[wish.gift] || 'üéÅ';
                            
                            giftEl.innerHTML = `
                                <span class="text-4xl">${emoji}</span>
                                <p class="text-xs font-semibold text-gray-600 mt-1">Hadih Visual: ${wish.gift}</p>
                            `;
                            card.appendChild(giftEl);
                        }

                        // Bahagian Mesej
                        const messageEl = document.createElement('p');
                        messageEl.className = "text-gray-700 text-base italic flex-grow";
                        messageEl.textContent = `"${wish.message}"`;
                        
                        // Bahagian Penghantar
                        const senderEl = document.createElement('p');
                        senderEl.className = "text-right font-semibold text-sm text-gray-800 mt-4";
                        senderEl.innerHTML = `- ${wish.senderName} ‚ù§Ô∏è`; 
                        
                        const detailsEl = document.createElement('p');
                        detailsEl.className = "text-right text-xs text-gray-500 mt-1";
                        let detailsText = [];
                        if (wish.senderPosition) detailsText.push(wish.senderPosition);
                        if (wish.senderStation) detailsText.push(wish.senderStation);
                        detailsEl.textContent = detailsText.join(', ');
                        
                        card.appendChild(messageEl);
                        card.appendChild(senderEl);
                        if (detailsText.length > 0) {
                            card.appendChild(detailsEl);
                        }
                        
                        grid.appendChild(card);
                        colorIndex++;
                    });
                }
            }, (error) => {
                console.error("Ralat memuatkan ucapan: ", error);
                loadingMsg.textContent = "Gagal memuatkan ucapan.";
            });
        }
        
    </script>
</body>
</html>
